
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ProbeView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2004-2018, Axel DÃ¶rfler, axeld@pinc-software.de.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> */</a>
<a name="ln5"> </a>
<a name="ln6"> </a>
<a name="ln7">#include &quot;ProbeView.h&quot;</a>
<a name="ln8"> </a>
<a name="ln9">#include &lt;stdio.h&gt;</a>
<a name="ln10">#include &lt;stdlib.h&gt;</a>
<a name="ln11">#include &lt;strings.h&gt;</a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;Alert.h&gt;</a>
<a name="ln14">#include &lt;Application.h&gt;</a>
<a name="ln15">#include &lt;Autolock.h&gt;</a>
<a name="ln16">#include &lt;Beep.h&gt;</a>
<a name="ln17">#include &lt;Bitmap.h&gt;</a>
<a name="ln18">#include &lt;Box.h&gt;</a>
<a name="ln19">#include &lt;Button.h&gt;</a>
<a name="ln20">#include &lt;Catalog.h&gt;</a>
<a name="ln21">#include &lt;Clipboard.h&gt;</a>
<a name="ln22">#include &lt;Directory.h&gt;</a>
<a name="ln23">#include &lt;Entry.h&gt;</a>
<a name="ln24">#include &lt;ExpressionParser.h&gt;</a>
<a name="ln25">#include &lt;fs_attr.h&gt;</a>
<a name="ln26">#include &lt;GridView.h&gt;</a>
<a name="ln27">#include &lt;GroupLayout.h&gt;</a>
<a name="ln28">#include &lt;GroupLayoutBuilder.h&gt;</a>
<a name="ln29">#include &lt;GroupView.h&gt;</a>
<a name="ln30">#include &lt;Locale.h&gt;</a>
<a name="ln31">#include &lt;MenuBar.h&gt;</a>
<a name="ln32">#include &lt;MenuItem.h&gt;</a>
<a name="ln33">#include &lt;MessageQueue.h&gt;</a>
<a name="ln34">#include &lt;NodeInfo.h&gt;</a>
<a name="ln35">#include &lt;Node.h&gt;</a>
<a name="ln36">#include &lt;NodeMonitor.h&gt;</a>
<a name="ln37">#include &lt;Path.h&gt;</a>
<a name="ln38">#include &lt;PrintJob.h&gt;</a>
<a name="ln39">#include &lt;ScrollView.h&gt;</a>
<a name="ln40">#include &lt;StringView.h&gt;</a>
<a name="ln41">#include &lt;Slider.h&gt;</a>
<a name="ln42">#include &lt;String.h&gt;</a>
<a name="ln43">#include &lt;TextControl.h&gt;</a>
<a name="ln44">#include &lt;Volume.h&gt;</a>
<a name="ln45">#include &lt;Window.h&gt;</a>
<a name="ln46"> </a>
<a name="ln47">#include &quot;DataView.h&quot;</a>
<a name="ln48">#include &quot;DiskProbe.h&quot;</a>
<a name="ln49">#include &quot;TypeEditors.h&quot;</a>
<a name="ln50"> </a>
<a name="ln51"> </a>
<a name="ln52">#ifndef __HAIKU__</a>
<a name="ln53">#	define DRAW_SLIDER_BAR</a>
<a name="ln54">	// if this is defined, the standard slider bar is replaced with</a>
<a name="ln55">	// one that looks exactly like the one in the original DiskProbe</a>
<a name="ln56">	// (even in Dano/Zeta)</a>
<a name="ln57">#endif</a>
<a name="ln58"> </a>
<a name="ln59">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln60">#define B_TRANSLATION_CONTEXT &quot;ProbeView&quot;</a>
<a name="ln61"> </a>
<a name="ln62">static const uint32 kMsgSliderUpdate = 'slup';</a>
<a name="ln63">static const uint32 kMsgPositionUpdate = 'poup';</a>
<a name="ln64">static const uint32 kMsgLastPosition = 'lpos';</a>
<a name="ln65">static const uint32 kMsgFontSize = 'fnts';</a>
<a name="ln66">static const uint32 kMsgBlockSize = 'blks';</a>
<a name="ln67">static const uint32 kMsgAddBookmark = 'bmrk';</a>
<a name="ln68">static const uint32 kMsgPrint = 'prnt';</a>
<a name="ln69">static const uint32 kMsgPageSetup = 'pgsp';</a>
<a name="ln70">static const uint32 kMsgViewAs = 'vwas';</a>
<a name="ln71"> </a>
<a name="ln72">static const uint32 kMsgStopFind = 'sfnd';</a>
<a name="ln73"> </a>
<a name="ln74"> </a>
<a name="ln75">class IconView : public BView {</a>
<a name="ln76">public:</a>
<a name="ln77">								IconView(const entry_ref* ref, bool isDevice);</a>
<a name="ln78">	virtual						~IconView();</a>
<a name="ln79"> </a>
<a name="ln80">	virtual	void				AttachedToWindow();</a>
<a name="ln81">	virtual	void				Draw(BRect updateRect);</a>
<a name="ln82"> </a>
<a name="ln83">			void				UpdateIcon();</a>
<a name="ln84"> </a>
<a name="ln85">private:</a>
<a name="ln86">			entry_ref			fRef;</a>
<a name="ln87">			bool				fIsDevice;</a>
<a name="ln88">			BBitmap*			fBitmap;</a>
<a name="ln89">};</a>
<a name="ln90"> </a>
<a name="ln91"> </a>
<a name="ln92">class PositionSlider : public BSlider {</a>
<a name="ln93">public:</a>
<a name="ln94">								PositionSlider(const char* name,</a>
<a name="ln95">									BMessage* message, off_t size,</a>
<a name="ln96">									uint32 blockSize);</a>
<a name="ln97">	virtual						~PositionSlider();</a>
<a name="ln98"> </a>
<a name="ln99">#ifdef DRAW_SLIDER_BAR</a>
<a name="ln100">	virtual	void				DrawBar();</a>
<a name="ln101">#endif</a>
<a name="ln102"> </a>
<a name="ln103">			off_t				Position() const;</a>
<a name="ln104">			off_t				Size() const { return fSize; }</a>
<a name="ln105">			uint32				BlockSize() const { return fBlockSize; }</a>
<a name="ln106"> </a>
<a name="ln107">	virtual	void				SetPosition(float position);</a>
<a name="ln108">			void				SetPosition(off_t position);</a>
<a name="ln109">			void				SetSize(off_t size);</a>
<a name="ln110">			void				SetBlockSize(uint32 blockSize);</a>
<a name="ln111"> </a>
<a name="ln112">private:</a>
<a name="ln113">			void				Reset();</a>
<a name="ln114"> </a>
<a name="ln115">private:</a>
<a name="ln116">	static	const int32			kMaxSliderLimit = 0x7fffff80;</a>
<a name="ln117">		// this is the maximum value that BSlider seem to work with fine</a>
<a name="ln118"> </a>
<a name="ln119">			off_t				fSize;</a>
<a name="ln120">			uint32				fBlockSize;</a>
<a name="ln121">};</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">class HeaderView : public BGridView, public BInvoker {</a>
<a name="ln125">public:</a>
<a name="ln126">								HeaderView(const entry_ref* ref,</a>
<a name="ln127">									DataEditor&amp; editor);</a>
<a name="ln128">	virtual						~HeaderView();</a>
<a name="ln129"> </a>
<a name="ln130">	virtual	void				AttachedToWindow();</a>
<a name="ln131">	virtual	void				DetachedFromWindow();</a>
<a name="ln132">	virtual	void				MessageReceived(BMessage* message);</a>
<a name="ln133"> </a>
<a name="ln134">			base_type			Base() const { return fBase; }</a>
<a name="ln135">			void				SetBase(base_type);</a>
<a name="ln136"> </a>
<a name="ln137">			off_t				CursorOffset() const</a>
<a name="ln138">									{ return fPosition % fBlockSize; }</a>
<a name="ln139">			off_t				Position() const { return fPosition; }</a>
<a name="ln140">			uint32				BlockSize() const { return fBlockSize; }</a>
<a name="ln141">			void				SetTo(off_t position, uint32 blockSize);</a>
<a name="ln142"> </a>
<a name="ln143">			void				UpdateIcon();</a>
<a name="ln144"> </a>
<a name="ln145">private:</a>
<a name="ln146">			void				FormatValue(char* buffer, size_t bufferSize,</a>
<a name="ln147">									off_t value);</a>
<a name="ln148">			void				UpdatePositionViews(bool all = true);</a>
<a name="ln149">			void				UpdateOffsetViews(bool all = true);</a>
<a name="ln150">			void				UpdateFileSizeView();</a>
<a name="ln151">			void				NotifyTarget();</a>
<a name="ln152"> </a>
<a name="ln153">private:</a>
<a name="ln154">			const char*			fAttribute;</a>
<a name="ln155">			off_t				fFileSize;</a>
<a name="ln156">			uint32				fBlockSize;</a>
<a name="ln157">			base_type			fBase;</a>
<a name="ln158">			off_t				fPosition;</a>
<a name="ln159">			off_t				fLastPosition;</a>
<a name="ln160"> </a>
<a name="ln161">			BTextControl*		fTypeControl;</a>
<a name="ln162">			BTextControl*		fPositionControl;</a>
<a name="ln163">			BStringView*		fPathView;</a>
<a name="ln164">			BStringView*		fSizeView;</a>
<a name="ln165">			BTextControl*		fOffsetControl;</a>
<a name="ln166">			BTextControl*		fFileOffsetControl;</a>
<a name="ln167">			PositionSlider*		fPositionSlider;</a>
<a name="ln168">			IconView*			fIconView;</a>
<a name="ln169">			BButton*			fStopButton;</a>
<a name="ln170">};</a>
<a name="ln171"> </a>
<a name="ln172"> </a>
<a name="ln173">class TypeMenuItem : public BMenuItem {</a>
<a name="ln174">public:</a>
<a name="ln175">								TypeMenuItem(const char* name, const char* type,</a>
<a name="ln176">									BMessage* message);</a>
<a name="ln177"> </a>
<a name="ln178">	virtual	void				GetContentSize(float* _width, float* _height);</a>
<a name="ln179">	virtual	void				DrawContent();</a>
<a name="ln180"> </a>
<a name="ln181">private:</a>
<a name="ln182">			BString				fType;</a>
<a name="ln183">};</a>
<a name="ln184"> </a>
<a name="ln185"> </a>
<a name="ln186">class EditorLooper : public BLooper {</a>
<a name="ln187">public:</a>
<a name="ln188">								EditorLooper(const char* name,</a>
<a name="ln189">									DataEditor&amp; editor, BMessenger messenger);</a>
<a name="ln190">	virtual						~EditorLooper();</a>
<a name="ln191"> </a>
<a name="ln192">	virtual	void				MessageReceived(BMessage* message);</a>
<a name="ln193"> </a>
<a name="ln194">			bool				FindIsRunning() const { return !fQuitFind; }</a>
<a name="ln195">			void				Find(off_t startAt, const uint8* data,</a>
<a name="ln196">									size_t dataSize, bool caseInsensitive,</a>
<a name="ln197">									BMessenger progressMonitor);</a>
<a name="ln198">			void				QuitFind();</a>
<a name="ln199"> </a>
<a name="ln200">private:</a>
<a name="ln201">			DataEditor&amp;			fEditor;</a>
<a name="ln202">			BMessenger			fMessenger;</a>
<a name="ln203">	volatile bool				fQuitFind;</a>
<a name="ln204">};</a>
<a name="ln205"> </a>
<a name="ln206"> </a>
<a name="ln207">class TypeView : public BView {</a>
<a name="ln208">public:</a>
<a name="ln209">								TypeView(BRect rect, const char* name,</a>
<a name="ln210">									int32 index, DataEditor&amp; editor,</a>
<a name="ln211">									int32 resizingMode);</a>
<a name="ln212">	virtual						~TypeView();</a>
<a name="ln213"> </a>
<a name="ln214">	virtual	void				FrameResized(float width, float height);</a>
<a name="ln215"> </a>
<a name="ln216">private:</a>
<a name="ln217">			BView*				fTypeEditorView;</a>
<a name="ln218">};</a>
<a name="ln219"> </a>
<a name="ln220"> </a>
<a name="ln221">//	#pragma mark - utility functions</a>
<a name="ln222"> </a>
<a name="ln223"> </a>
<a name="ln224">static void</a>
<a name="ln225">get_type_string(char* buffer, size_t bufferSize, type_code type)</a>
<a name="ln226">{</a>
<a name="ln227">	for (int32 i = 0; i &lt; 4; i++) {</a>
<a name="ln228">		buffer[i] = type &gt;&gt; (24 - 8 * i);</a>
<a name="ln229">		if (buffer[i] &lt; ' ' || buffer[i] == 0x7f) {</a>
<a name="ln230">			snprintf(buffer, bufferSize, &quot;0x%04&quot; B_PRIx32, type);</a>
<a name="ln231">			break;</a>
<a name="ln232">		} else if (i == 3)</a>
<a name="ln233">			buffer[4] = '\0';</a>
<a name="ln234">	}</a>
<a name="ln235">}</a>
<a name="ln236"> </a>
<a name="ln237"> </a>
<a name="ln238">//	#pragma mark - IconView</a>
<a name="ln239"> </a>
<a name="ln240"> </a>
<a name="ln241">IconView::IconView(const entry_ref* ref, bool isDevice)</a>
<a name="ln242">	: BView(NULL, B_WILL_DRAW),</a>
<a name="ln243">	fRef(*ref),</a>
<a name="ln244">	fIsDevice(isDevice),</a>
<a name="ln245">	fBitmap(NULL)</a>
<a name="ln246">{</a>
<a name="ln247">	UpdateIcon();</a>
<a name="ln248">	SetExplicitSize(BSize(32, 32));</a>
<a name="ln249">}</a>
<a name="ln250"> </a>
<a name="ln251"> </a>
<a name="ln252">IconView::~IconView()</a>
<a name="ln253">{</a>
<a name="ln254">	delete fBitmap;</a>
<a name="ln255">}</a>
<a name="ln256"> </a>
<a name="ln257"> </a>
<a name="ln258">void</a>
<a name="ln259">IconView::AttachedToWindow()</a>
<a name="ln260">{</a>
<a name="ln261">	if (Parent() != NULL)</a>
<a name="ln262">		SetViewColor(Parent()-&gt;ViewColor());</a>
<a name="ln263">	else</a>
<a name="ln264">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln265">}</a>
<a name="ln266"> </a>
<a name="ln267"> </a>
<a name="ln268">void</a>
<a name="ln269">IconView::Draw(BRect updateRect)</a>
<a name="ln270">{</a>
<a name="ln271">	if (fBitmap == NULL)</a>
<a name="ln272">		return;</a>
<a name="ln273"> </a>
<a name="ln274">	SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln275">	DrawBitmap(fBitmap, updateRect, updateRect);</a>
<a name="ln276">	SetDrawingMode(B_OP_COPY);</a>
<a name="ln277">}</a>
<a name="ln278"> </a>
<a name="ln279"> </a>
<a name="ln280">void</a>
<a name="ln281">IconView::UpdateIcon()</a>
<a name="ln282">{</a>
<a name="ln283">	if (fBitmap == NULL)</a>
<a name="ln284">#ifdef HAIKU_TARGET_PLATFORM_HAIKU</a>
<a name="ln285">		fBitmap = new BBitmap(BRect(0, 0, 31, 31), B_RGBA32);</a>
<a name="ln286">#else</a>
<a name="ln287">		fBitmap = new BBitmap(BRect(0, 0, 31, 31), B_CMAP8);</a>
<a name="ln288">#endif</a>
<a name="ln289"> </a>
<a name="ln290">	if (fBitmap != NULL) {</a>
<a name="ln291">		status_t status = B_ERROR;</a>
<a name="ln292"> </a>
<a name="ln293">		if (fIsDevice) {</a>
<a name="ln294">			BPath path(&amp;fRef);</a>
<a name="ln295">#ifdef __HAIKU__</a>
<a name="ln296">			status = get_device_icon(path.Path(), fBitmap, B_LARGE_ICON);</a>
<a name="ln297">#else</a>
<a name="ln298">			status = get_device_icon(path.Path(), fBitmap-&gt;Bits(), B_LARGE_ICON);</a>
<a name="ln299">#endif</a>
<a name="ln300">		} else</a>
<a name="ln301">			status = BNodeInfo::GetTrackerIcon(&amp;fRef, fBitmap);</a>
<a name="ln302"> </a>
<a name="ln303">		if (status != B_OK) {</a>
<a name="ln304">			// Try to get generic icon</a>
<a name="ln305">			BMimeType type(B_FILE_MIME_TYPE);</a>
<a name="ln306">			status = type.GetIcon(fBitmap, B_LARGE_ICON);</a>
<a name="ln307">		}</a>
<a name="ln308"> </a>
<a name="ln309">		if (status != B_OK) {</a>
<a name="ln310">			delete fBitmap;</a>
<a name="ln311">			fBitmap = NULL;</a>
<a name="ln312">		}</a>
<a name="ln313"> </a>
<a name="ln314">		Invalidate();</a>
<a name="ln315">	}</a>
<a name="ln316">}</a>
<a name="ln317"> </a>
<a name="ln318"> </a>
<a name="ln319">//	#pragma mark - PositionSlider</a>
<a name="ln320"> </a>
<a name="ln321"> </a>
<a name="ln322">PositionSlider::PositionSlider(const char* name, BMessage* message,</a>
<a name="ln323">	off_t size, uint32 blockSize)</a>
<a name="ln324">	:</a>
<a name="ln325">	BSlider(name, NULL, message, 0, kMaxSliderLimit, B_HORIZONTAL,</a>
<a name="ln326">		B_TRIANGLE_THUMB),</a>
<a name="ln327">	fSize(size),</a>
<a name="ln328">	fBlockSize(blockSize)</a>
<a name="ln329">{</a>
<a name="ln330">	Reset();</a>
<a name="ln331"> </a>
<a name="ln332">#ifndef DRAW_SLIDER_BAR</a>
<a name="ln333">	rgb_color color = ui_color(B_CONTROL_HIGHLIGHT_COLOR);</a>
<a name="ln334">	UseFillColor(true, &amp;color);</a>
<a name="ln335">#endif</a>
<a name="ln336">}</a>
<a name="ln337"> </a>
<a name="ln338"> </a>
<a name="ln339">PositionSlider::~PositionSlider()</a>
<a name="ln340">{</a>
<a name="ln341">}</a>
<a name="ln342"> </a>
<a name="ln343"> </a>
<a name="ln344">#ifdef DRAW_SLIDER_BAR</a>
<a name="ln345">void</a>
<a name="ln346">PositionSlider::DrawBar()</a>
<a name="ln347">{</a>
<a name="ln348">	BView* view = OffscreenView();</a>
<a name="ln349"> </a>
<a name="ln350">	BRect barFrame = BarFrame();</a>
<a name="ln351">	BRect frame = barFrame.InsetByCopy(1, 1);</a>
<a name="ln352">	frame.top++;</a>
<a name="ln353">	frame.left++;</a>
<a name="ln354">	frame.right = ThumbFrame().left + ThumbFrame().Width() / 2;</a>
<a name="ln355">#ifdef HAIKU_TARGET_PLATFORM_BEOS</a>
<a name="ln356">	if (IsEnabled())</a>
<a name="ln357">		view-&gt;SetHighColor(102, 152, 203);</a>
<a name="ln358">	else</a>
<a name="ln359">		view-&gt;SetHighColor(92, 102, 160);</a>
<a name="ln360">#else</a>
<a name="ln361">	view-&gt;SetHighColor(IsEnabled() ? ui_color(B_CONTROL_HIGHLIGHT_COLOR)</a>
<a name="ln362">		: tint_color(ui_color(B_CONTROL_HIGHLIGHT_COLOR), B_DARKEN_1_TINT));</a>
<a name="ln363">#endif</a>
<a name="ln364">	view-&gt;FillRect(frame);</a>
<a name="ln365"> </a>
<a name="ln366">	frame.left = frame.right + 1;</a>
<a name="ln367">	frame.right = barFrame.right - 1;</a>
<a name="ln368">	view-&gt;SetHighColor(tint_color(ViewColor(), IsEnabled() ? B_DARKEN_1_TINT : B_LIGHTEN_1_TINT));</a>
<a name="ln369">	view-&gt;FillRect(frame);</a>
<a name="ln370"> </a>
<a name="ln371">	rgb_color cornerColor = tint_color(ViewColor(), B_DARKEN_1_TINT);</a>
<a name="ln372">	rgb_color darkColor = tint_color(ViewColor(), B_DARKEN_3_TINT);</a>
<a name="ln373">#ifdef HAIKU_TARGET_PLATFORM_BEOS</a>
<a name="ln374">	rgb_color shineColor = {255, 255, 255};</a>
<a name="ln375">	rgb_color shadowColor = {0, 0, 0};</a>
<a name="ln376">#else</a>
<a name="ln377">	rgb_color shineColor = ui_color(B_SHINE_COLOR);</a>
<a name="ln378">	rgb_color shadowColor = ui_color(B_SHADOW_COLOR);</a>
<a name="ln379">#endif</a>
<a name="ln380">	if (!IsEnabled()) {</a>
<a name="ln381">		darkColor = tint_color(ViewColor(), B_DARKEN_1_TINT);</a>
<a name="ln382">		shineColor = tint_color(shineColor, B_DARKEN_2_TINT);</a>
<a name="ln383">		shadowColor = tint_color(shadowColor, B_LIGHTEN_2_TINT);</a>
<a name="ln384">	}</a>
<a name="ln385"> </a>
<a name="ln386">	view-&gt;BeginLineArray(9);</a>
<a name="ln387"> </a>
<a name="ln388">	// the corners</a>
<a name="ln389">	view-&gt;AddLine(barFrame.LeftTop(), barFrame.LeftTop(), cornerColor);</a>
<a name="ln390">	view-&gt;AddLine(barFrame.LeftBottom(), barFrame.LeftBottom(), cornerColor);</a>
<a name="ln391">	view-&gt;AddLine(barFrame.RightTop(), barFrame.RightTop(), cornerColor);</a>
<a name="ln392"> </a>
<a name="ln393">	// the edges</a>
<a name="ln394">	view-&gt;AddLine(BPoint(barFrame.left, barFrame.top + 1),</a>
<a name="ln395">		BPoint(barFrame.left, barFrame.bottom - 1), darkColor);</a>
<a name="ln396">	view-&gt;AddLine(BPoint(barFrame.right, barFrame.top + 1),</a>
<a name="ln397">		BPoint(barFrame.right, barFrame.bottom), shineColor);</a>
<a name="ln398"> </a>
<a name="ln399">	barFrame.left++;</a>
<a name="ln400">	barFrame.right--;</a>
<a name="ln401">	view-&gt;AddLine(barFrame.LeftTop(), barFrame.RightTop(), darkColor);</a>
<a name="ln402">	view-&gt;AddLine(barFrame.LeftBottom(), barFrame.RightBottom(), shineColor);</a>
<a name="ln403"> </a>
<a name="ln404">	// the inner edges</a>
<a name="ln405">	barFrame.top++;</a>
<a name="ln406">	view-&gt;AddLine(barFrame.LeftTop(), barFrame.RightTop(), shadowColor);</a>
<a name="ln407">	view-&gt;AddLine(BPoint(barFrame.left, barFrame.top + 1),</a>
<a name="ln408">		BPoint(barFrame.left, barFrame.bottom - 1), shadowColor);</a>
<a name="ln409"> </a>
<a name="ln410">	view-&gt;EndLineArray();</a>
<a name="ln411">}</a>
<a name="ln412">#endif	// DRAW_SLIDER_BAR</a>
<a name="ln413"> </a>
<a name="ln414"> </a>
<a name="ln415">void</a>
<a name="ln416">PositionSlider::Reset()</a>
<a name="ln417">{</a>
<a name="ln418">	SetKeyIncrementValue(int32(1.0 * kMaxSliderLimit / ((fSize - 1) / fBlockSize) + 0.5));</a>
<a name="ln419">	SetEnabled(fSize &gt; fBlockSize);</a>
<a name="ln420">}</a>
<a name="ln421"> </a>
<a name="ln422"> </a>
<a name="ln423">off_t</a>
<a name="ln424">PositionSlider::Position() const</a>
<a name="ln425">{</a>
<a name="ln426">	// ToDo:</a>
<a name="ln427">	// Note: this code is far from being perfect: depending on the file size, it has</a>
<a name="ln428">	//	a maxium granularity that might be less than the actual block size demands...</a>
<a name="ln429">	//	The only way to work around this that I can think of, is to replace the slider</a>
<a name="ln430">	//	class completely with one that understands off_t values.</a>
<a name="ln431">	//	For example, with a block size of 512 bytes, it should be good enough for about</a>
<a name="ln432">	//	1024 GB - and that's not really that far away these days.</a>
<a name="ln433"> </a>
<a name="ln434">	return (off_t(1.0 * (fSize - 1) * Value() / kMaxSliderLimit + 0.5) / fBlockSize) * fBlockSize;</a>
<a name="ln435">}</a>
<a name="ln436"> </a>
<a name="ln437"> </a>
<a name="ln438">void</a>
<a name="ln439">PositionSlider::SetPosition(float position)</a>
<a name="ln440">{</a>
<a name="ln441">	BSlider::SetPosition(position);</a>
<a name="ln442">}</a>
<a name="ln443"> </a>
<a name="ln444"> </a>
<a name="ln445">void</a>
<a name="ln446">PositionSlider::SetPosition(off_t position)</a>
<a name="ln447">{</a>
<a name="ln448">	position /= fBlockSize;</a>
<a name="ln449">	SetValue(int32(1.0 * kMaxSliderLimit * position / ((fSize - 1) / fBlockSize) + 0.5));</a>
<a name="ln450">}</a>
<a name="ln451"> </a>
<a name="ln452"> </a>
<a name="ln453">void</a>
<a name="ln454">PositionSlider::SetSize(off_t size)</a>
<a name="ln455">{</a>
<a name="ln456">	if (size == fSize)</a>
<a name="ln457">		return;</a>
<a name="ln458"> </a>
<a name="ln459">	off_t position = Position();</a>
<a name="ln460">	if (position &gt;= size)</a>
<a name="ln461">		position = size - 1;</a>
<a name="ln462"> </a>
<a name="ln463">	fSize = size;</a>
<a name="ln464">	Reset();</a>
<a name="ln465">	SetPosition(position);</a>
<a name="ln466">}</a>
<a name="ln467"> </a>
<a name="ln468"> </a>
<a name="ln469">void</a>
<a name="ln470">PositionSlider::SetBlockSize(uint32 blockSize)</a>
<a name="ln471">{</a>
<a name="ln472">	if (blockSize == fBlockSize)</a>
<a name="ln473">		return;</a>
<a name="ln474"> </a>
<a name="ln475">	off_t position = Position();</a>
<a name="ln476">	fBlockSize = blockSize;</a>
<a name="ln477">	Reset();</a>
<a name="ln478">	SetPosition(position);</a>
<a name="ln479">}</a>
<a name="ln480"> </a>
<a name="ln481"> </a>
<a name="ln482">//	#pragma mark - HeaderView</a>
<a name="ln483"> </a>
<a name="ln484"> </a>
<a name="ln485">HeaderView::HeaderView(const entry_ref* ref, DataEditor&amp; editor)</a>
<a name="ln486">	: BGridView(&quot;probeHeader&quot;, B_USE_SMALL_SPACING, B_USE_SMALL_SPACING),</a>
<a name="ln487">	fAttribute(editor.Attribute()),</a>
<a name="ln488">	fFileSize(editor.FileSize()),</a>
<a name="ln489">	fBlockSize(editor.BlockSize()),</a>
<a name="ln490">	fBase(kHexBase),</a>
<a name="ln491">	fPosition(0),</a>
<a name="ln492">	fLastPosition(0)</a>
<a name="ln493">{</a>
<a name="ln494">	SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln495">	GridLayout()-&gt;SetInsets(B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING,</a>
<a name="ln496">		B_USE_WINDOW_SPACING, B_USE_DEFAULT_SPACING);</a>
<a name="ln497"> </a>
<a name="ln498">	fIconView = new IconView(ref, editor.IsDevice());</a>
<a name="ln499">	GridLayout()-&gt;AddView(fIconView, 0, 0, 1, 2);</a>
<a name="ln500"> </a>
<a name="ln501">	BGroupView* line = new BGroupView(B_HORIZONTAL);</a>
<a name="ln502">	GridLayout()-&gt;AddView(line, 1, 0);</a>
<a name="ln503"> </a>
<a name="ln504">	BFont boldFont = *be_bold_font;</a>
<a name="ln505">	BFont plainFont = *be_plain_font;</a>
<a name="ln506">	boldFont.SetSize(plainFont.Size() * 0.83);</a>
<a name="ln507">	plainFont.SetSize(plainFont.Size() * 0.83);</a>
<a name="ln508"> </a>
<a name="ln509">	BStringView* stringView = new BStringView(</a>
<a name="ln510">		B_EMPTY_STRING, editor.IsAttribute()</a>
<a name="ln511">			? B_TRANSLATE(&quot;Attribute: &quot;) : editor.IsDevice()</a>
<a name="ln512">			? B_TRANSLATE(&quot;Device: &quot;) : B_TRANSLATE(&quot;File: &quot;));</a>
<a name="ln513">	stringView-&gt;SetFont(&amp;boldFont);</a>
<a name="ln514">	line-&gt;AddChild(stringView);</a>
<a name="ln515"> </a>
<a name="ln516">	BPath path(ref);</a>
<a name="ln517">	BString string = path.Path();</a>
<a name="ln518">	if (fAttribute != NULL) {</a>
<a name="ln519">		string.Prepend(&quot; (&quot;);</a>
<a name="ln520">		string.Prepend(fAttribute);</a>
<a name="ln521">		string.Append(&quot;)&quot;);</a>
<a name="ln522">	}</a>
<a name="ln523">	fPathView = new BStringView(B_EMPTY_STRING, string.String());</a>
<a name="ln524">	fPathView-&gt;SetFont(&amp;plainFont);</a>
<a name="ln525">	line-&gt;AddChild(fPathView);</a>
<a name="ln526"> </a>
<a name="ln527">	if (editor.IsAttribute()) {</a>
<a name="ln528">		stringView = new BStringView(B_EMPTY_STRING,</a>
<a name="ln529">			B_TRANSLATE(&quot;Attribute type: &quot;));</a>
<a name="ln530">		stringView-&gt;SetFont(&amp;boldFont);</a>
<a name="ln531">		line-&gt;AddChild(stringView);</a>
<a name="ln532"> </a>
<a name="ln533">		char buffer[16];</a>
<a name="ln534">		get_type_string(buffer, sizeof(buffer), editor.Type());</a>
<a name="ln535">		fTypeControl = new BTextControl(B_EMPTY_STRING, NULL, buffer,</a>
<a name="ln536">			new BMessage(kMsgPositionUpdate));</a>
<a name="ln537">		fTypeControl-&gt;SetFont(&amp;plainFont);</a>
<a name="ln538">		fTypeControl-&gt;TextView()-&gt;SetFontAndColor(&amp;plainFont);</a>
<a name="ln539">		fTypeControl-&gt;SetEnabled(false);</a>
<a name="ln540">			// ToDo: for now</a>
<a name="ln541">		line-&gt;AddChild(fTypeControl);</a>
<a name="ln542"> </a>
<a name="ln543">	} else</a>
<a name="ln544">		fTypeControl = NULL;</a>
<a name="ln545"> </a>
<a name="ln546">	fStopButton = new BButton(B_EMPTY_STRING,</a>
<a name="ln547">		B_TRANSLATE(&quot;Stop&quot;), new BMessage(kMsgStopFind));</a>
<a name="ln548">	fStopButton-&gt;SetFont(&amp;plainFont);</a>
<a name="ln549">	fStopButton-&gt;Hide();</a>
<a name="ln550">	line-&gt;AddChild(fStopButton);</a>
<a name="ln551"> </a>
<a name="ln552">	BGroupLayoutBuilder(line).AddGlue();</a>
<a name="ln553"> </a>
<a name="ln554">	line = new BGroupView(B_HORIZONTAL, B_USE_SMALL_SPACING);</a>
<a name="ln555">	GridLayout()-&gt;AddView(line, 1, 1);</a>
<a name="ln556"> </a>
<a name="ln557">	stringView = new BStringView(B_EMPTY_STRING, B_TRANSLATE(&quot;Block: &quot;));</a>
<a name="ln558">	stringView-&gt;SetFont(&amp;boldFont);</a>
<a name="ln559">	line-&gt;AddChild(stringView);</a>
<a name="ln560"> </a>
<a name="ln561">	BMessage* msg = new BMessage(kMsgPositionUpdate);</a>
<a name="ln562">	msg-&gt;AddBool(&quot;fPositionControl&quot;, true);</a>
<a name="ln563">		// BTextControl oddities</a>
<a name="ln564">	fPositionControl = new BTextControl(B_EMPTY_STRING, NULL, &quot;0x0&quot;, msg);</a>
<a name="ln565">	fPositionControl-&gt;SetDivider(0.0);</a>
<a name="ln566">	fPositionControl-&gt;SetFont(&amp;plainFont);</a>
<a name="ln567">	fPositionControl-&gt;TextView()-&gt;SetFontAndColor(&amp;plainFont);</a>
<a name="ln568">	fPositionControl-&gt;SetAlignment(B_ALIGN_LEFT, B_ALIGN_LEFT);</a>
<a name="ln569">	line-&gt;AddChild(fPositionControl);</a>
<a name="ln570"> </a>
<a name="ln571">	fSizeView = new BStringView(B_EMPTY_STRING, B_TRANSLATE_COMMENT(&quot;of &quot;</a>
<a name="ln572">		&quot;0x0&quot;, &quot;This is a part of 'Block 0xXXXX of 0x0026' message. In &quot;</a>
<a name="ln573">		&quot;languages without 'of' structure it can be replaced simply &quot;</a>
<a name="ln574">		&quot;with '/'.&quot;));</a>
<a name="ln575">	fSizeView-&gt;SetFont(&amp;plainFont);</a>
<a name="ln576">	line-&gt;AddChild(fSizeView);</a>
<a name="ln577">	UpdateFileSizeView();</a>
<a name="ln578"> </a>
<a name="ln579">	stringView = new BStringView(B_EMPTY_STRING, B_TRANSLATE(&quot;Offset: &quot;));</a>
<a name="ln580">	stringView-&gt;SetFont(&amp;boldFont);</a>
<a name="ln581">	line-&gt;AddChild(stringView);</a>
<a name="ln582"> </a>
<a name="ln583">	msg = new BMessage(kMsgPositionUpdate);</a>
<a name="ln584">	msg-&gt;AddBool(&quot;fOffsetControl&quot;, false);</a>
<a name="ln585">	fOffsetControl = new BTextControl(B_EMPTY_STRING, NULL, &quot;0x0&quot;, msg);</a>
<a name="ln586">	fOffsetControl-&gt;SetDivider(0.0);</a>
<a name="ln587">	fOffsetControl-&gt;SetFont(&amp;plainFont);</a>
<a name="ln588">	fOffsetControl-&gt;TextView()-&gt;SetFontAndColor(&amp;plainFont);</a>
<a name="ln589">	fOffsetControl-&gt;SetAlignment(B_ALIGN_LEFT, B_ALIGN_LEFT);</a>
<a name="ln590">	line-&gt;AddChild(fOffsetControl);</a>
<a name="ln591">	UpdateOffsetViews(false);</a>
<a name="ln592"> </a>
<a name="ln593">	stringView = new BStringView(B_EMPTY_STRING, editor.IsAttribute()</a>
<a name="ln594">		? B_TRANSLATE(&quot;Attribute offset: &quot;) : editor.IsDevice()</a>
<a name="ln595">			? B_TRANSLATE(&quot;Device offset: &quot;) : B_TRANSLATE(&quot;File offset: &quot;));</a>
<a name="ln596">	stringView-&gt;SetFont(&amp;boldFont);</a>
<a name="ln597">	line-&gt;AddChild(stringView);</a>
<a name="ln598"> </a>
<a name="ln599">	msg = new BMessage(kMsgPositionUpdate);</a>
<a name="ln600">	msg-&gt;AddBool(&quot;fFileOffsetControl&quot;, false);</a>
<a name="ln601">	fFileOffsetControl = new BTextControl(B_EMPTY_STRING, NULL, &quot;0x0&quot;, msg);</a>
<a name="ln602">	fFileOffsetControl-&gt;SetDivider(0.0);</a>
<a name="ln603">	fFileOffsetControl-&gt;SetFont(&amp;plainFont);</a>
<a name="ln604">	fFileOffsetControl-&gt;TextView()-&gt;SetFontAndColor(&amp;plainFont);</a>
<a name="ln605">	fFileOffsetControl-&gt;SetAlignment(B_ALIGN_LEFT, B_ALIGN_LEFT);</a>
<a name="ln606">	line-&gt;AddChild(fFileOffsetControl);</a>
<a name="ln607"> </a>
<a name="ln608">	BGroupLayoutBuilder(line).AddGlue();</a>
<a name="ln609"> </a>
<a name="ln610">	fPositionSlider = new PositionSlider(&quot;slider&quot;,</a>
<a name="ln611">		new BMessage(kMsgSliderUpdate), editor.FileSize(), editor.BlockSize());</a>
<a name="ln612">	fPositionSlider-&gt;SetModificationMessage(new BMessage(kMsgSliderUpdate));</a>
<a name="ln613">	fPositionSlider-&gt;SetBarThickness(8);</a>
<a name="ln614">	GridLayout()-&gt;AddView(fPositionSlider, 0, 2, 2, 1);</a>
<a name="ln615">}</a>
<a name="ln616"> </a>
<a name="ln617"> </a>
<a name="ln618">HeaderView::~HeaderView()</a>
<a name="ln619">{</a>
<a name="ln620">}</a>
<a name="ln621"> </a>
<a name="ln622"> </a>
<a name="ln623">void</a>
<a name="ln624">HeaderView::AttachedToWindow()</a>
<a name="ln625">{</a>
<a name="ln626">	SetTarget(Window());</a>
<a name="ln627"> </a>
<a name="ln628">	fStopButton-&gt;SetTarget(Parent());</a>
<a name="ln629">	fPositionControl-&gt;SetTarget(this);</a>
<a name="ln630">	fOffsetControl-&gt;SetTarget(this);</a>
<a name="ln631">	fFileOffsetControl-&gt;SetTarget(this);</a>
<a name="ln632">	fPositionSlider-&gt;SetTarget(this);</a>
<a name="ln633"> </a>
<a name="ln634">	BMessage* message;</a>
<a name="ln635">	Window()-&gt;AddShortcut(B_HOME, B_COMMAND_KEY,</a>
<a name="ln636">		message = new BMessage(kMsgPositionUpdate), this);</a>
<a name="ln637">	message-&gt;AddInt64(&quot;block&quot;, 0);</a>
<a name="ln638">	Window()-&gt;AddShortcut(B_END, B_COMMAND_KEY,</a>
<a name="ln639">		message = new BMessage(kMsgPositionUpdate), this);</a>
<a name="ln640">	message-&gt;AddInt64(&quot;block&quot;, -1);</a>
<a name="ln641">	Window()-&gt;AddShortcut(B_PAGE_UP, B_COMMAND_KEY,</a>
<a name="ln642">		message = new BMessage(kMsgPositionUpdate), this);</a>
<a name="ln643">	message-&gt;AddInt32(&quot;delta&quot;, -1);</a>
<a name="ln644">	Window()-&gt;AddShortcut(B_PAGE_DOWN, B_COMMAND_KEY,</a>
<a name="ln645">		message = new BMessage(kMsgPositionUpdate), this);</a>
<a name="ln646">	message-&gt;AddInt32(&quot;delta&quot;, 1);</a>
<a name="ln647">}</a>
<a name="ln648"> </a>
<a name="ln649"> </a>
<a name="ln650">void</a>
<a name="ln651">HeaderView::DetachedFromWindow()</a>
<a name="ln652">{</a>
<a name="ln653">	Window()-&gt;RemoveShortcut(B_HOME, B_COMMAND_KEY);</a>
<a name="ln654">	Window()-&gt;RemoveShortcut(B_END, B_COMMAND_KEY);</a>
<a name="ln655">	Window()-&gt;RemoveShortcut(B_PAGE_UP, B_COMMAND_KEY);</a>
<a name="ln656">	Window()-&gt;RemoveShortcut(B_PAGE_DOWN, B_COMMAND_KEY);</a>
<a name="ln657">}</a>
<a name="ln658"> </a>
<a name="ln659"> </a>
<a name="ln660">void</a>
<a name="ln661">HeaderView::UpdateIcon()</a>
<a name="ln662">{</a>
<a name="ln663">	fIconView-&gt;UpdateIcon();</a>
<a name="ln664">}</a>
<a name="ln665"> </a>
<a name="ln666"> </a>
<a name="ln667">void</a>
<a name="ln668">HeaderView::FormatValue(char* buffer, size_t bufferSize, off_t value)</a>
<a name="ln669">{</a>
<a name="ln670">	snprintf(buffer, bufferSize, fBase == kHexBase ? &quot;0x%&quot; B_PRIxOFF : &quot;%&quot;</a>
<a name="ln671">		B_PRIdOFF, value);</a>
<a name="ln672">}</a>
<a name="ln673"> </a>
<a name="ln674"> </a>
<a name="ln675">void</a>
<a name="ln676">HeaderView::UpdatePositionViews(bool all)</a>
<a name="ln677">{</a>
<a name="ln678">	char buffer[64];</a>
<a name="ln679">	FormatValue(buffer, sizeof(buffer), fPosition / fBlockSize);</a>
<a name="ln680">	fPositionControl-&gt;SetText(buffer);</a>
<a name="ln681"> </a>
<a name="ln682">	if (all) {</a>
<a name="ln683">		FormatValue(buffer, sizeof(buffer), fPosition);</a>
<a name="ln684">		fFileOffsetControl-&gt;SetText(buffer);</a>
<a name="ln685">	}</a>
<a name="ln686">}</a>
<a name="ln687"> </a>
<a name="ln688"> </a>
<a name="ln689">void</a>
<a name="ln690">HeaderView::UpdateOffsetViews(bool all)</a>
<a name="ln691">{</a>
<a name="ln692">	char buffer[64];</a>
<a name="ln693">	FormatValue(buffer, sizeof(buffer), fPosition % fBlockSize);</a>
<a name="ln694">	fOffsetControl-&gt;SetText(buffer);</a>
<a name="ln695"> </a>
<a name="ln696">	if (all) {</a>
<a name="ln697">		FormatValue(buffer, sizeof(buffer), fPosition);</a>
<a name="ln698">		fFileOffsetControl-&gt;SetText(buffer);</a>
<a name="ln699">	}</a>
<a name="ln700">}</a>
<a name="ln701"> </a>
<a name="ln702"> </a>
<a name="ln703">void</a>
<a name="ln704">HeaderView::UpdateFileSizeView()</a>
<a name="ln705">{</a>
<a name="ln706">	BString string(B_TRANSLATE(&quot;of &quot;));</a>
<a name="ln707">	char buffer[64];</a>
<a name="ln708">	FormatValue(buffer, sizeof(buffer),</a>
<a name="ln709">		(fFileSize + fBlockSize - 1) / fBlockSize);</a>
<a name="ln710">	string &lt;&lt; buffer;</a>
<a name="ln711"> </a>
<a name="ln712">	fSizeView-&gt;SetText(string.String());</a>
<a name="ln713">}</a>
<a name="ln714"> </a>
<a name="ln715"> </a>
<a name="ln716">void</a>
<a name="ln717">HeaderView::SetBase(base_type type)</a>
<a name="ln718">{</a>
<a name="ln719">	if (fBase == type)</a>
<a name="ln720">		return;</a>
<a name="ln721"> </a>
<a name="ln722">	fBase = type;</a>
<a name="ln723"> </a>
<a name="ln724">	UpdatePositionViews();</a>
<a name="ln725">	UpdateOffsetViews(false);</a>
<a name="ln726">	UpdateFileSizeView();</a>
<a name="ln727">}</a>
<a name="ln728"> </a>
<a name="ln729"> </a>
<a name="ln730">void</a>
<a name="ln731">HeaderView::SetTo(off_t position, uint32 blockSize)</a>
<a name="ln732">{</a>
<a name="ln733">	fPosition = position;</a>
<a name="ln734">	fLastPosition = (fLastPosition / fBlockSize) * blockSize;</a>
<a name="ln735">	fBlockSize = blockSize;</a>
<a name="ln736"> </a>
<a name="ln737">	fPositionSlider-&gt;SetBlockSize(blockSize);</a>
<a name="ln738">	UpdatePositionViews();</a>
<a name="ln739">	UpdateOffsetViews(false);</a>
<a name="ln740">	UpdateFileSizeView();</a>
<a name="ln741">}</a>
<a name="ln742"> </a>
<a name="ln743"> </a>
<a name="ln744">void</a>
<a name="ln745">HeaderView::NotifyTarget()</a>
<a name="ln746">{</a>
<a name="ln747">	BMessage update(kMsgPositionUpdate);</a>
<a name="ln748">	update.AddInt64(&quot;position&quot;, fPosition);</a>
<a name="ln749">	Messenger().SendMessage(&amp;update);</a>
<a name="ln750">}</a>
<a name="ln751"> </a>
<a name="ln752"> </a>
<a name="ln753">void</a>
<a name="ln754">HeaderView::MessageReceived(BMessage* message)</a>
<a name="ln755">{</a>
<a name="ln756">	switch (message-&gt;what) {</a>
<a name="ln757">		case B_OBSERVER_NOTICE_CHANGE: {</a>
<a name="ln758">			int32 what;</a>
<a name="ln759">			if (message-&gt;FindInt32(B_OBSERVE_WHAT_CHANGE, &amp;what) != B_OK)</a>
<a name="ln760">				break;</a>
<a name="ln761"> </a>
<a name="ln762">			switch (what) {</a>
<a name="ln763">				case kDataViewCursorPosition:</a>
<a name="ln764">					off_t offset;</a>
<a name="ln765">					if (message-&gt;FindInt64(&quot;position&quot;, &amp;offset) == B_OK) {</a>
<a name="ln766">						fPosition = (fPosition / fBlockSize) * fBlockSize</a>
<a name="ln767">							+ offset;</a>
<a name="ln768">						UpdateOffsetViews();</a>
<a name="ln769">					}</a>
<a name="ln770">					break;</a>
<a name="ln771">			}</a>
<a name="ln772">			break;</a>
<a name="ln773">		}</a>
<a name="ln774"> </a>
<a name="ln775">		case kMsgSliderUpdate:</a>
<a name="ln776">		{</a>
<a name="ln777">			// First, make sure we're only considering the most</a>
<a name="ln778">			// up-to-date message in the queue (which might not</a>
<a name="ln779">			// be this one).</a>
<a name="ln780">			// If there is another message of this type in the</a>
<a name="ln781">			// queue, we're just ignoring the current message.</a>
<a name="ln782"> </a>
<a name="ln783">			if (Looper()-&gt;MessageQueue()-&gt;FindMessage(kMsgSliderUpdate, 0)</a>
<a name="ln784">					!= NULL)</a>
<a name="ln785">				break;</a>
<a name="ln786"> </a>
<a name="ln787">			// if nothing has changed, we can ignore this message as well</a>
<a name="ln788">			if (fPosition == fPositionSlider-&gt;Position())</a>
<a name="ln789">				break;</a>
<a name="ln790"> </a>
<a name="ln791">			fLastPosition = fPosition;</a>
<a name="ln792">			fPosition = fPositionSlider-&gt;Position();</a>
<a name="ln793"> </a>
<a name="ln794">			// update position text control</a>
<a name="ln795">			UpdatePositionViews();</a>
<a name="ln796"> </a>
<a name="ln797">			// notify our target</a>
<a name="ln798">			NotifyTarget();</a>
<a name="ln799">			break;</a>
<a name="ln800">		}</a>
<a name="ln801"> </a>
<a name="ln802">		case kMsgDataEditorFindProgress:</a>
<a name="ln803">		{</a>
<a name="ln804">			bool state;</a>
<a name="ln805">			if (message-&gt;FindBool(&quot;running&quot;, &amp;state) == B_OK</a>
<a name="ln806">				&amp;&amp; fFileSize &gt; fBlockSize) {</a>
<a name="ln807">				fPositionSlider-&gt;SetEnabled(!state);</a>
<a name="ln808">				if (state) {</a>
<a name="ln809">					fStopButton-&gt;Show();</a>
<a name="ln810">				} else {</a>
<a name="ln811">					fStopButton-&gt;Hide();</a>
<a name="ln812">				}</a>
<a name="ln813">			}</a>
<a name="ln814"> </a>
<a name="ln815">			off_t position;</a>
<a name="ln816">			if (message-&gt;FindInt64(&quot;position&quot;, &amp;position) != B_OK)</a>
<a name="ln817">				break;</a>
<a name="ln818"> </a>
<a name="ln819">			fPosition = (position / fBlockSize) * fBlockSize;</a>
<a name="ln820">				// round to block size</a>
<a name="ln821"> </a>
<a name="ln822">			// update views</a>
<a name="ln823">			UpdatePositionViews(false);</a>
<a name="ln824">			fPositionSlider-&gt;SetPosition(fPosition);</a>
<a name="ln825">			break;</a>
<a name="ln826">		}</a>
<a name="ln827"> </a>
<a name="ln828">		case kMsgPositionUpdate:</a>
<a name="ln829">		{</a>
<a name="ln830">			off_t lastPosition = fPosition;</a>
<a name="ln831"> </a>
<a name="ln832">			off_t position;</a>
<a name="ln833">			int32 delta;</a>
<a name="ln834">			bool round = true;</a>
<a name="ln835">			if (message-&gt;FindInt64(&quot;position&quot;, &amp;position) == B_OK)</a>
<a name="ln836">				fPosition = position;</a>
<a name="ln837">			else if (message-&gt;FindInt64(&quot;block&quot;, &amp;position) == B_OK) {</a>
<a name="ln838">				if (position &lt; 0)</a>
<a name="ln839">					position += (fFileSize - 1) / fBlockSize + 1;</a>
<a name="ln840">				fPosition = position * fBlockSize;</a>
<a name="ln841">			} else if (message-&gt;FindInt32(&quot;delta&quot;, &amp;delta) == B_OK) {</a>
<a name="ln842">				fPosition += delta * off_t(fBlockSize);</a>
<a name="ln843">			} else {</a>
<a name="ln844">				try {</a>
<a name="ln845">					ExpressionParser parser;</a>
<a name="ln846">					parser.SetSupportHexInput(true);</a>
<a name="ln847">					if (message-&gt;FindBool(&quot;fPositionControl&quot;, &amp;round)</a>
<a name="ln848">						== B_OK) {</a>
<a name="ln849">						fPosition = parser.EvaluateToInt64(</a>
<a name="ln850">							fPositionControl-&gt;Text()) * fBlockSize;</a>
<a name="ln851">					} else if (message-&gt;FindBool(&quot;fOffsetControl&quot;, &amp;round)</a>
<a name="ln852">					== B_OK) {</a>
<a name="ln853">						fPosition = (fPosition / fBlockSize) * fBlockSize +</a>
<a name="ln854">							parser.EvaluateToInt64(fOffsetControl-&gt;Text());</a>
<a name="ln855">					} else if (message-&gt;FindBool(&quot;fFileOffsetControl&quot;, &amp;round)</a>
<a name="ln856">						== B_OK) {</a>
<a name="ln857">						fPosition = parser.EvaluateToInt64(</a>
<a name="ln858">							fFileOffsetControl-&gt;Text());</a>
<a name="ln859">					}</a>
<a name="ln860">				} catch (...) {</a>
<a name="ln861">					beep();</a>
<a name="ln862">					break;</a>
<a name="ln863">				}</a>
<a name="ln864">			}</a>
<a name="ln865"> </a>
<a name="ln866">			fLastPosition = lastPosition;</a>
<a name="ln867"> </a>
<a name="ln868">			if (round)</a>
<a name="ln869">				fPosition = (fPosition / fBlockSize) * fBlockSize;</a>
<a name="ln870">				// round to block size</a>
<a name="ln871"> </a>
<a name="ln872">			if (fPosition &lt; 0)</a>
<a name="ln873">				fPosition = 0;</a>
<a name="ln874">			else if (fPosition &gt; ((fFileSize - 1) / fBlockSize) * fBlockSize)</a>
<a name="ln875">				fPosition = ((fFileSize - 1) / fBlockSize) * fBlockSize;</a>
<a name="ln876"> </a>
<a name="ln877">			// update views</a>
<a name="ln878">			UpdatePositionViews();</a>
<a name="ln879">			fPositionSlider-&gt;SetPosition(fPosition);</a>
<a name="ln880"> </a>
<a name="ln881">			// notify our target</a>
<a name="ln882">			NotifyTarget();</a>
<a name="ln883">			break;</a>
<a name="ln884">		}</a>
<a name="ln885"> </a>
<a name="ln886">		case kMsgLastPosition:</a>
<a name="ln887">		{</a>
<a name="ln888">			fPosition = fLastPosition;</a>
<a name="ln889">			fLastPosition = fPositionSlider-&gt;Position();</a>
<a name="ln890"> </a>
<a name="ln891">			// update views</a>
<a name="ln892">			UpdatePositionViews();</a>
<a name="ln893">			fPositionSlider-&gt;SetPosition(fPosition);</a>
<a name="ln894"> </a>
<a name="ln895">			// notify our target</a>
<a name="ln896">			NotifyTarget();</a>
<a name="ln897">			break;</a>
<a name="ln898">		}</a>
<a name="ln899"> </a>
<a name="ln900">		case kMsgBaseType:</a>
<a name="ln901">		{</a>
<a name="ln902">			int32 type;</a>
<a name="ln903">			if (message-&gt;FindInt32(&quot;base&quot;, &amp;type) != B_OK)</a>
<a name="ln904">				break;</a>
<a name="ln905"> </a>
<a name="ln906">			SetBase((base_type)type);</a>
<a name="ln907">			break;</a>
<a name="ln908">		}</a>
<a name="ln909"> </a>
<a name="ln910">		default:</a>
<a name="ln911">			BView::MessageReceived(message);</a>
<a name="ln912">	}</a>
<a name="ln913">}</a>
<a name="ln914"> </a>
<a name="ln915"> </a>
<a name="ln916">//	#pragma mark - TypeMenuItem</a>
<a name="ln917"> </a>
<a name="ln918"> </a>
<a name="ln919">/*!	The TypeMenuItem is a BMenuItem that displays a type string at its</a>
<a name="ln920">	right border.</a>
<a name="ln921">	It is used to display the attribute and type in the attributes menu.</a>
<a name="ln922">	It does not mix nicely with short cuts.</a>
<a name="ln923">*/</a>
<a name="ln924">TypeMenuItem::TypeMenuItem(const char* name, const char* type,</a>
<a name="ln925">		BMessage* message)</a>
<a name="ln926">	:</a>
<a name="ln927">	BMenuItem(name, message),</a>
<a name="ln928">	fType(type)</a>
<a name="ln929">{</a>
<a name="ln930">}</a>
<a name="ln931"> </a>
<a name="ln932"> </a>
<a name="ln933">void</a>
<a name="ln934">TypeMenuItem::GetContentSize(float* _width, float* _height)</a>
<a name="ln935">{</a>
<a name="ln936">	BMenuItem::GetContentSize(_width, _height);</a>
<a name="ln937"> </a>
<a name="ln938">	if (_width)</a>
<a name="ln939">		*_width += Menu()-&gt;StringWidth(fType.String());</a>
<a name="ln940">}</a>
<a name="ln941"> </a>
<a name="ln942"> </a>
<a name="ln943">void</a>
<a name="ln944">TypeMenuItem::DrawContent()</a>
<a name="ln945">{</a>
<a name="ln946">	// draw the label</a>
<a name="ln947">	BMenuItem::DrawContent();</a>
<a name="ln948"> </a>
<a name="ln949">	font_height fontHeight;</a>
<a name="ln950">	Menu()-&gt;GetFontHeight(&amp;fontHeight);</a>
<a name="ln951"> </a>
<a name="ln952">	// draw the type</a>
<a name="ln953">	BPoint point = ContentLocation();</a>
<a name="ln954">	point.x = Frame().right - 4 - Menu()-&gt;StringWidth(fType.String());</a>
<a name="ln955">	point.y += fontHeight.ascent;</a>
<a name="ln956"> </a>
<a name="ln957">#ifdef HAIKU_TARGET_PLATFORM_BEOS</a>
<a name="ln958">	Menu()-&gt;SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln959">#endif</a>
<a name="ln960"> </a>
<a name="ln961">	Menu()-&gt;DrawString(fType.String(), point);</a>
<a name="ln962">}</a>
<a name="ln963"> </a>
<a name="ln964"> </a>
<a name="ln965">//	#pragma mark - EditorLooper</a>
<a name="ln966"> </a>
<a name="ln967"> </a>
<a name="ln968">/*!	The purpose of this looper is to off-load the editor data loading from</a>
<a name="ln969">	the main window looper.</a>
<a name="ln970"> </a>
<a name="ln971">	It will listen to the offset changes of the editor, let him update its</a>
<a name="ln972">	data, and will then synchronously notify the target.</a>
<a name="ln973">	That way, simple offset changes will not stop the main looper from</a>
<a name="ln974">	operating. Therefore, all offset updates for the editor will go through</a>
<a name="ln975">	this looper.</a>
<a name="ln976">	Also, it will run the find action in the editor.</a>
<a name="ln977">*/</a>
<a name="ln978">EditorLooper::EditorLooper(const char* name, DataEditor&amp; editor,</a>
<a name="ln979">		BMessenger target)</a>
<a name="ln980">	: BLooper(name),</a>
<a name="ln981">	fEditor(editor),</a>
<a name="ln982">	fMessenger(target),</a>
<a name="ln983">	fQuitFind(true)</a>
<a name="ln984">{</a>
<a name="ln985">	fEditor.StartWatching(this);</a>
<a name="ln986">}</a>
<a name="ln987"> </a>
<a name="ln988"> </a>
<a name="ln989">EditorLooper::~EditorLooper()</a>
<a name="ln990">{</a>
<a name="ln991">	fEditor.StopWatching(this);</a>
<a name="ln992">}</a>
<a name="ln993"> </a>
<a name="ln994"> </a>
<a name="ln995">void</a>
<a name="ln996">EditorLooper::MessageReceived(BMessage* message)</a>
<a name="ln997">{</a>
<a name="ln998">	switch (message-&gt;what) {</a>
<a name="ln999">		case kMsgPositionUpdate:</a>
<a name="ln1000">		{</a>
<a name="ln1001">			// First, make sure we're only considering the most</a>
<a name="ln1002">			// up-to-date message in the queue (which might not</a>
<a name="ln1003">			// be this one).</a>
<a name="ln1004">			// If there is another message of this type in the</a>
<a name="ln1005">			// queue, we're just ignoring the current message.</a>
<a name="ln1006"> </a>
<a name="ln1007">			if (Looper()-&gt;MessageQueue()-&gt;FindMessage(kMsgPositionUpdate, 0) != NULL)</a>
<a name="ln1008">				break;</a>
<a name="ln1009"> </a>
<a name="ln1010">			off_t position;</a>
<a name="ln1011">			if (message-&gt;FindInt64(&quot;position&quot;, &amp;position) == B_OK) {</a>
<a name="ln1012">				BAutolock locker(fEditor);</a>
<a name="ln1013">				fEditor.SetViewOffset(position);</a>
<a name="ln1014"> </a>
<a name="ln1015">				BMessage message(kMsgSetSelection);</a>
<a name="ln1016">				message.AddInt64(&quot;start&quot;, position - fEditor.ViewOffset());</a>
<a name="ln1017">				message.AddInt64(&quot;end&quot;, position - fEditor.ViewOffset());</a>
<a name="ln1018">				fMessenger.SendMessage(&amp;message);</a>
<a name="ln1019">			}</a>
<a name="ln1020">			break;</a>
<a name="ln1021">		}</a>
<a name="ln1022"> </a>
<a name="ln1023">		case kMsgDataEditorParameterChange:</a>
<a name="ln1024">		{</a>
<a name="ln1025">			bool updated = false;</a>
<a name="ln1026"> </a>
<a name="ln1027">			if (fEditor.Lock()) {</a>
<a name="ln1028">				fEditor.UpdateIfNeeded(&amp;updated);</a>
<a name="ln1029">				fEditor.Unlock();</a>
<a name="ln1030">			}</a>
<a name="ln1031"> </a>
<a name="ln1032">			if (updated) {</a>
<a name="ln1033">				BMessage reply;</a>
<a name="ln1034">				fMessenger.SendMessage(kMsgUpdateData, &amp;reply);</a>
<a name="ln1035">					// We are doing a synchronously transfer, to prevent</a>
<a name="ln1036">					// that we're already locking the editor again when</a>
<a name="ln1037">					// our target wants to get the editor data.</a>
<a name="ln1038">			}</a>
<a name="ln1039">			break;</a>
<a name="ln1040">		}</a>
<a name="ln1041"> </a>
<a name="ln1042">		case kMsgFind:</a>
<a name="ln1043">		{</a>
<a name="ln1044">			BMessenger progressMonitor;</a>
<a name="ln1045">			message-&gt;FindMessenger(&quot;progress_monitor&quot;, &amp;progressMonitor);</a>
<a name="ln1046"> </a>
<a name="ln1047">			off_t startAt = 0;</a>
<a name="ln1048">			message-&gt;FindInt64(&quot;start&quot;, &amp;startAt);</a>
<a name="ln1049"> </a>
<a name="ln1050">			bool caseInsensitive = !message-&gt;FindBool(&quot;case_sensitive&quot;);</a>
<a name="ln1051"> </a>
<a name="ln1052">			ssize_t dataSize;</a>
<a name="ln1053">			const uint8* data;</a>
<a name="ln1054">			if (message-&gt;FindData(&quot;data&quot;, B_RAW_TYPE, (const void**)&amp;data,</a>
<a name="ln1055">					&amp;dataSize) == B_OK)</a>
<a name="ln1056">				Find(startAt, data, dataSize, caseInsensitive, progressMonitor);</a>
<a name="ln1057">		}</a>
<a name="ln1058"> </a>
<a name="ln1059">		default:</a>
<a name="ln1060">			BLooper::MessageReceived(message);</a>
<a name="ln1061">			break;</a>
<a name="ln1062">	}</a>
<a name="ln1063">}</a>
<a name="ln1064"> </a>
<a name="ln1065"> </a>
<a name="ln1066">void</a>
<a name="ln1067">EditorLooper::Find(off_t startAt, const uint8* data, size_t dataSize,</a>
<a name="ln1068">	bool caseInsensitive, BMessenger progressMonitor)</a>
<a name="ln1069">{</a>
<a name="ln1070">	fQuitFind = false;</a>
<a name="ln1071"> </a>
<a name="ln1072">	BAutolock locker(fEditor);</a>
<a name="ln1073"> </a>
<a name="ln1074">	bigtime_t startTime = system_time();</a>
<a name="ln1075"> </a>
<a name="ln1076">	off_t foundAt = fEditor.Find(startAt, data, dataSize, caseInsensitive,</a>
<a name="ln1077">		true, progressMonitor, &amp;fQuitFind);</a>
<a name="ln1078">	if (foundAt &gt;= B_OK) {</a>
<a name="ln1079">		fEditor.SetViewOffset(foundAt);</a>
<a name="ln1080"> </a>
<a name="ln1081">		// select the part in our target</a>
<a name="ln1082">		BMessage message(kMsgSetSelection);</a>
<a name="ln1083">		message.AddInt64(&quot;start&quot;, foundAt - fEditor.ViewOffset());</a>
<a name="ln1084">		message.AddInt64(&quot;end&quot;, foundAt + dataSize - 1 - fEditor.ViewOffset());</a>
<a name="ln1085">		fMessenger.SendMessage(&amp;message);</a>
<a name="ln1086">	} else if (foundAt == B_ENTRY_NOT_FOUND) {</a>
<a name="ln1087">		if (system_time() &gt; startTime + 8000000LL) {</a>
<a name="ln1088">			// If the user had to wait more than 8 seconds for the result,</a>
<a name="ln1089">			// we are trying to please him with a requester...</a>
<a name="ln1090">			BAlert* alert = new BAlert(B_TRANSLATE(&quot;DiskProbe request&quot;),</a>
<a name="ln1091">				B_TRANSLATE(&quot;Could not find search string.&quot;),</a>
<a name="ln1092">				B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL,</a>
<a name="ln1093">				B_WARNING_ALERT);</a>
<a name="ln1094">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1095">			alert-&gt;Go(NULL);</a>
<a name="ln1096">		} else</a>
<a name="ln1097">			beep();</a>
<a name="ln1098">	}</a>
<a name="ln1099">}</a>
<a name="ln1100"> </a>
<a name="ln1101"> </a>
<a name="ln1102">void</a>
<a name="ln1103">EditorLooper::QuitFind()</a>
<a name="ln1104">{</a>
<a name="ln1105">	fQuitFind = true;</a>
<a name="ln1106">		// this will cleanly stop the find process</a>
<a name="ln1107">}</a>
<a name="ln1108"> </a>
<a name="ln1109"> </a>
<a name="ln1110">//	#pragma mark - TypeView</a>
<a name="ln1111"> </a>
<a name="ln1112"> </a>
<a name="ln1113">TypeView::TypeView(BRect rect, const char* name, int32 index,</a>
<a name="ln1114">		DataEditor&amp; editor, int32 resizingMode)</a>
<a name="ln1115">	: BView(rect, name, resizingMode, B_FRAME_EVENTS)</a>
<a name="ln1116">{</a>
<a name="ln1117">	SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln1118"> </a>
<a name="ln1119">	fTypeEditorView = GetTypeEditorAt(index, Frame(), editor);</a>
<a name="ln1120">	if (fTypeEditorView == NULL) {</a>
<a name="ln1121">		AddChild(new BStringView(Bounds(), B_TRANSLATE(&quot;Type editor&quot;),</a>
<a name="ln1122">			B_TRANSLATE(&quot;Type editor not supported&quot;), B_FOLLOW_NONE));</a>
<a name="ln1123">	} else</a>
<a name="ln1124">		AddChild(fTypeEditorView);</a>
<a name="ln1125"> </a>
<a name="ln1126">	if ((fTypeEditorView-&gt;ResizingMode() &amp; (B_FOLLOW_RIGHT | B_FOLLOW_BOTTOM))</a>
<a name="ln1127">			!= 0) {</a>
<a name="ln1128">		BRect rect = Bounds();</a>
<a name="ln1129"> </a>
<a name="ln1130">		BRect frame = fTypeEditorView-&gt;Frame();</a>
<a name="ln1131">		rect.left = frame.left;</a>
<a name="ln1132">		rect.top = frame.top;</a>
<a name="ln1133">		if ((fTypeEditorView-&gt;ResizingMode() &amp; B_FOLLOW_RIGHT) == 0)</a>
<a name="ln1134">			rect.right = frame.right;</a>
<a name="ln1135">		if ((fTypeEditorView-&gt;ResizingMode() &amp; B_FOLLOW_BOTTOM) == 0)</a>
<a name="ln1136">			rect.bottom = frame.bottom;</a>
<a name="ln1137"> </a>
<a name="ln1138">		fTypeEditorView-&gt;ResizeTo(rect.Width(), rect.Height());</a>
<a name="ln1139">	}</a>
<a name="ln1140">}</a>
<a name="ln1141"> </a>
<a name="ln1142"> </a>
<a name="ln1143">TypeView::~TypeView()</a>
<a name="ln1144">{</a>
<a name="ln1145">}</a>
<a name="ln1146"> </a>
<a name="ln1147"> </a>
<a name="ln1148">void</a>
<a name="ln1149">TypeView::FrameResized(float width, float height)</a>
<a name="ln1150">{</a>
<a name="ln1151">	BRect rect = Bounds();</a>
<a name="ln1152"> </a>
<a name="ln1153">	BPoint point = fTypeEditorView-&gt;Frame().LeftTop();</a>
<a name="ln1154">	if ((fTypeEditorView-&gt;ResizingMode() &amp; B_FOLLOW_RIGHT) == 0)</a>
<a name="ln1155">		point.x = (rect.Width() - fTypeEditorView-&gt;Bounds().Width()) / 2;</a>
<a name="ln1156">	if ((fTypeEditorView-&gt;ResizingMode() &amp; B_FOLLOW_BOTTOM) == 0)</a>
<a name="ln1157">		point.y = (rect.Height() - fTypeEditorView-&gt;Bounds().Height()) / 2;</a>
<a name="ln1158"> </a>
<a name="ln1159">	fTypeEditorView-&gt;MoveTo(point);</a>
<a name="ln1160">}</a>
<a name="ln1161"> </a>
<a name="ln1162"> </a>
<a name="ln1163">//	#pragma mark - ProbeView</a>
<a name="ln1164"> </a>
<a name="ln1165"> </a>
<a name="ln1166">ProbeView::ProbeView(entry_ref* ref, const char* attribute,</a>
<a name="ln1167">		const BMessage* settings)</a>
<a name="ln1168">	: BView(&quot;probeView&quot;, B_WILL_DRAW),</a>
<a name="ln1169">	fPrintSettings(NULL),</a>
<a name="ln1170">	fTypeView(NULL),</a>
<a name="ln1171">	fLastSearch(NULL)</a>
<a name="ln1172">{</a>
<a name="ln1173">	BGroupLayout* layout = new BGroupLayout(B_VERTICAL, 0);</a>
<a name="ln1174">	SetLayout(layout);</a>
<a name="ln1175">	layout-&gt;SetInsets(-1, -1, -1, -1);</a>
<a name="ln1176">	fEditor.SetTo(*ref, attribute);</a>
<a name="ln1177"> </a>
<a name="ln1178">	int32 baseType = kHexBase;</a>
<a name="ln1179">	float fontSize = 12.0f;</a>
<a name="ln1180">	if (settings != NULL) {</a>
<a name="ln1181">		settings-&gt;FindInt32(&quot;base_type&quot;, &amp;baseType);</a>
<a name="ln1182">		settings-&gt;FindFloat(&quot;font_size&quot;, &amp;fontSize);</a>
<a name="ln1183">	}</a>
<a name="ln1184"> </a>
<a name="ln1185">	fHeaderView = new HeaderView(&amp;fEditor.Ref(), fEditor);</a>
<a name="ln1186">	fHeaderView-&gt;SetBase((base_type)baseType);</a>
<a name="ln1187">	AddChild(fHeaderView);</a>
<a name="ln1188"> </a>
<a name="ln1189">	fDataView = new DataView(fEditor);</a>
<a name="ln1190">	fDataView-&gt;SetBase((base_type)baseType);</a>
<a name="ln1191">	fDataView-&gt;SetFontSize(fontSize);</a>
<a name="ln1192"> </a>
<a name="ln1193">	fScrollView = new BScrollView(&quot;scroller&quot;, fDataView, B_WILL_DRAW, true,</a>
<a name="ln1194">		true);</a>
<a name="ln1195">	AddChild(fScrollView);</a>
<a name="ln1196"> </a>
<a name="ln1197">	fDataView-&gt;UpdateScroller();</a>
<a name="ln1198">}</a>
<a name="ln1199"> </a>
<a name="ln1200"> </a>
<a name="ln1201">ProbeView::~ProbeView()</a>
<a name="ln1202">{</a>
<a name="ln1203">}</a>
<a name="ln1204"> </a>
<a name="ln1205"> </a>
<a name="ln1206">void</a>
<a name="ln1207">ProbeView::DetachedFromWindow()</a>
<a name="ln1208">{</a>
<a name="ln1209">	fEditorLooper-&gt;QuitFind();</a>
<a name="ln1210"> </a>
<a name="ln1211">	if (fEditorLooper-&gt;Lock())</a>
<a name="ln1212">		fEditorLooper-&gt;Quit();</a>
<a name="ln1213">	fEditorLooper = NULL;</a>
<a name="ln1214"> </a>
<a name="ln1215">	fEditor.StopWatching(this);</a>
<a name="ln1216">	fDataView-&gt;StopWatching(fHeaderView, kDataViewCursorPosition);</a>
<a name="ln1217">	fDataView-&gt;StopWatching(this, kDataViewSelection);</a>
<a name="ln1218">	fDataView-&gt;StopWatching(this, kDataViewPreferredSize);</a>
<a name="ln1219">	be_clipboard-&gt;StopWatching(this);</a>
<a name="ln1220">}</a>
<a name="ln1221"> </a>
<a name="ln1222"> </a>
<a name="ln1223">void</a>
<a name="ln1224">ProbeView::_UpdateAttributesMenu(BMenu* menu)</a>
<a name="ln1225">{</a>
<a name="ln1226">	// remove old contents</a>
<a name="ln1227"> </a>
<a name="ln1228">	for (int32 i = menu-&gt;CountItems(); i-- &gt; 0;) {</a>
<a name="ln1229">		delete menu-&gt;RemoveItem(i);</a>
<a name="ln1230">	}</a>
<a name="ln1231"> </a>
<a name="ln1232">	// add new items (sorted)</a>
<a name="ln1233"> </a>
<a name="ln1234">	BNode node(&amp;fEditor.AttributeRef());</a>
<a name="ln1235">	if (node.InitCheck() == B_OK) {</a>
<a name="ln1236">		char attribute[B_ATTR_NAME_LENGTH];</a>
<a name="ln1237">		node.RewindAttrs();</a>
<a name="ln1238"> </a>
<a name="ln1239">		while (node.GetNextAttrName(attribute) == B_OK) {</a>
<a name="ln1240">			attr_info info;</a>
<a name="ln1241">			if (node.GetAttrInfo(attribute, &amp;info) != B_OK)</a>
<a name="ln1242">				continue;</a>
<a name="ln1243"> </a>
<a name="ln1244">			char type[16];</a>
<a name="ln1245">			type[0] = '[';</a>
<a name="ln1246">			get_type_string(type + 1, sizeof(type) - 2, info.type);</a>
<a name="ln1247">			strcat(type, &quot;]&quot;);</a>
<a name="ln1248"> </a>
<a name="ln1249">			// find where to insert</a>
<a name="ln1250">			int32 i;</a>
<a name="ln1251">			for (i = 0; i &lt; menu-&gt;CountItems(); i++) {</a>
<a name="ln1252">				if (strcasecmp(menu-&gt;ItemAt(i)-&gt;Label(), attribute) &gt; 0)</a>
<a name="ln1253">					break;</a>
<a name="ln1254">			}</a>
<a name="ln1255"> </a>
<a name="ln1256">			BMessage* message = new BMessage(B_REFS_RECEIVED);</a>
<a name="ln1257">			message-&gt;AddRef(&quot;refs&quot;, &amp;fEditor.AttributeRef());</a>
<a name="ln1258">			message-&gt;AddString(&quot;attributes&quot;, attribute);</a>
<a name="ln1259"> </a>
<a name="ln1260">			menu-&gt;AddItem(new TypeMenuItem(attribute, type, message), i);</a>
<a name="ln1261">		}</a>
<a name="ln1262">	}</a>
<a name="ln1263"> </a>
<a name="ln1264">	if (menu-&gt;CountItems() == 0) {</a>
<a name="ln1265">		// if there are no attributes, add an item to the menu</a>
<a name="ln1266">		// that says so</a>
<a name="ln1267">		BMenuItem* item = new BMenuItem(B_TRANSLATE_COMMENT(&quot;none&quot;,</a>
<a name="ln1268">			&quot;No attributes&quot;), NULL);</a>
<a name="ln1269">		item-&gt;SetEnabled(false);</a>
<a name="ln1270">		menu-&gt;AddItem(item);</a>
<a name="ln1271">	}</a>
<a name="ln1272"> </a>
<a name="ln1273">	menu-&gt;SetTargetForItems(be_app);</a>
<a name="ln1274">}</a>
<a name="ln1275"> </a>
<a name="ln1276"> </a>
<a name="ln1277">void</a>
<a name="ln1278">ProbeView::AddSaveMenuItems(BMenu* menu, int32 index)</a>
<a name="ln1279">{</a>
<a name="ln1280">	menu-&gt;AddItem(fSaveMenuItem = new BMenuItem(B_TRANSLATE(&quot;Save&quot;),</a>
<a name="ln1281">		new BMessage(B_SAVE_REQUESTED), 'S'), index);</a>
<a name="ln1282">	fSaveMenuItem-&gt;SetTarget(this);</a>
<a name="ln1283">	fSaveMenuItem-&gt;SetEnabled(false);</a>
<a name="ln1284">	//menu-&gt;AddItem(new BMenuItem(&quot;Save As&quot; B_UTF8_ELLIPSIS, NULL), index);</a>
<a name="ln1285">}</a>
<a name="ln1286"> </a>
<a name="ln1287"> </a>
<a name="ln1288">void</a>
<a name="ln1289">ProbeView::AddPrintMenuItems(BMenu* menu, int32 index)</a>
<a name="ln1290">{</a>
<a name="ln1291">	BMenuItem* item;</a>
<a name="ln1292">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Page setup&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1293">		new BMessage(kMsgPageSetup)), index++);</a>
<a name="ln1294">	item-&gt;SetTarget(this);</a>
<a name="ln1295">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Print&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1296">		new BMessage(kMsgPrint), 'P'), index++);</a>
<a name="ln1297">	item-&gt;SetTarget(this);</a>
<a name="ln1298">}</a>
<a name="ln1299"> </a>
<a name="ln1300"> </a>
<a name="ln1301">void</a>
<a name="ln1302">ProbeView::AddViewAsMenuItems()</a>
<a name="ln1303">{</a>
<a name="ln1304">#if 0</a>
<a name="ln1305">	BMenuBar* bar = Window()-&gt;KeyMenuBar();</a>
<a name="ln1306">	if (bar == NULL)</a>
<a name="ln1307">		return;</a>
<a name="ln1308"> </a>
<a name="ln1309">	BMenuItem* item = bar-&gt;FindItem(B_TRANSLATE(&quot;View&quot;));</a>
<a name="ln1310">	BMenu* menu = NULL;</a>
<a name="ln1311">	if (item != NULL)</a>
<a name="ln1312">		menu = item-&gt;Submenu();</a>
<a name="ln1313">	else</a>
<a name="ln1314">		menu = bar-&gt;SubmenuAt(bar-&gt;CountItems() - 1);</a>
<a name="ln1315"> </a>
<a name="ln1316">	if (menu == NULL)</a>
<a name="ln1317">		return;</a>
<a name="ln1318"> </a>
<a name="ln1319">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1320"> </a>
<a name="ln1321">	BMenu* subMenu = new BMenu(B_TRANSLATE(&quot;View As&quot;));</a>
<a name="ln1322">	subMenu-&gt;SetRadioMode(true);</a>
<a name="ln1323"> </a>
<a name="ln1324">	BMessage* message = new BMessage(kMsgViewAs);</a>
<a name="ln1325">	subMenu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Raw&quot;), message));</a>
<a name="ln1326">	item-&gt;SetMarked(true);</a>
<a name="ln1327"> </a>
<a name="ln1328">	const char* name;</a>
<a name="ln1329">	for (int32 i = 0; GetNthTypeEditor(i, &amp;name) == B_OK; i++) {</a>
<a name="ln1330">		message = new BMessage(kMsgViewAs);</a>
<a name="ln1331">		message-&gt;AddInt32(&quot;editor index&quot;, i);</a>
<a name="ln1332">		subMenu-&gt;AddItem(new BMenuItem(name, message));</a>
<a name="ln1333">	}</a>
<a name="ln1334"> </a>
<a name="ln1335">	subMenu-&gt;SetTargetForItems(this);</a>
<a name="ln1336">	menu-&gt;AddItem(new BMenuItem(subMenu));</a>
<a name="ln1337">#endif</a>
<a name="ln1338">}</a>
<a name="ln1339"> </a>
<a name="ln1340"> </a>
<a name="ln1341">void</a>
<a name="ln1342">ProbeView::AttachedToWindow()</a>
<a name="ln1343">{</a>
<a name="ln1344">	BView::AttachedToWindow();</a>
<a name="ln1345"> </a>
<a name="ln1346">	fEditorLooper = new EditorLooper(fEditor.Ref().name, fEditor,</a>
<a name="ln1347">		BMessenger(fDataView));</a>
<a name="ln1348">	fEditorLooper-&gt;Run();</a>
<a name="ln1349"> </a>
<a name="ln1350">	fEditor.StartWatching(this);</a>
<a name="ln1351">	fDataView-&gt;StartWatching(fHeaderView, kDataViewCursorPosition);</a>
<a name="ln1352">	fDataView-&gt;StartWatching(this, kDataViewSelection);</a>
<a name="ln1353">	fDataView-&gt;StartWatching(this, kDataViewPreferredSize);</a>
<a name="ln1354">	be_clipboard-&gt;StartWatching(this);</a>
<a name="ln1355"> </a>
<a name="ln1356">	// Add menu to window</a>
<a name="ln1357"> </a>
<a name="ln1358">	BMenuBar* bar = Window()-&gt;KeyMenuBar();</a>
<a name="ln1359">	if (bar == NULL) {</a>
<a name="ln1360">		// there is none? Well, but we really want to have one</a>
<a name="ln1361">		bar = new BMenuBar(&quot;&quot;);</a>
<a name="ln1362">		Window()-&gt;AddChild(bar);</a>
<a name="ln1363"> </a>
<a name="ln1364">		BMenu* menu = new BMenu(fEditor.IsAttribute()</a>
<a name="ln1365">			? B_TRANSLATE(&quot;Attribute&quot;) : fEditor.IsDevice()</a>
<a name="ln1366">			? B_TRANSLATE(&quot;Device&quot;) : B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln1367">		AddSaveMenuItems(menu, 0);</a>
<a name="ln1368">		menu-&gt;AddSeparatorItem();</a>
<a name="ln1369">		AddPrintMenuItems(menu, menu-&gt;CountItems());</a>
<a name="ln1370">		menu-&gt;AddSeparatorItem();</a>
<a name="ln1371"> </a>
<a name="ln1372">		menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Close&quot;),</a>
<a name="ln1373">			new BMessage(B_CLOSE_REQUESTED), 'W'));</a>
<a name="ln1374">		bar-&gt;AddItem(menu);</a>
<a name="ln1375">	}</a>
<a name="ln1376"> </a>
<a name="ln1377">	// &quot;Edit&quot; menu</a>
<a name="ln1378"> </a>
<a name="ln1379">	BMenu* menu = new BMenu(B_TRANSLATE(&quot;Edit&quot;));</a>
<a name="ln1380">	BMenuItem* item;</a>
<a name="ln1381">	menu-&gt;AddItem(fUndoMenuItem = new BMenuItem(B_TRANSLATE(&quot;Undo&quot;),</a>
<a name="ln1382">		new BMessage(B_UNDO), 'Z'));</a>
<a name="ln1383">	fUndoMenuItem-&gt;SetEnabled(fEditor.CanUndo());</a>
<a name="ln1384">	fUndoMenuItem-&gt;SetTarget(fDataView);</a>
<a name="ln1385">	menu-&gt;AddItem(fRedoMenuItem = new BMenuItem(B_TRANSLATE(&quot;Redo&quot;),</a>
<a name="ln1386">		new BMessage(B_REDO), 'Z', B_SHIFT_KEY));</a>
<a name="ln1387">	fRedoMenuItem-&gt;SetEnabled(fEditor.CanRedo());</a>
<a name="ln1388">	fRedoMenuItem-&gt;SetTarget(fDataView);</a>
<a name="ln1389">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1390">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Copy&quot;),</a>
<a name="ln1391">		new BMessage(B_COPY), 'C'));</a>
<a name="ln1392">	item-&gt;SetTarget(NULL, Window());</a>
<a name="ln1393">	menu-&gt;AddItem(fPasteMenuItem = new BMenuItem(B_TRANSLATE(&quot;Paste&quot;),</a>
<a name="ln1394">		new BMessage(B_PASTE), 'V'));</a>
<a name="ln1395">	fPasteMenuItem-&gt;SetTarget(NULL, Window());</a>
<a name="ln1396">	_CheckClipboard();</a>
<a name="ln1397">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Select all&quot;),</a>
<a name="ln1398">		new BMessage(B_SELECT_ALL), 'A'));</a>
<a name="ln1399">	item-&gt;SetTarget(NULL, Window());</a>
<a name="ln1400">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1401">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Find&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1402">		new BMessage(kMsgOpenFindWindow), 'F'));</a>
<a name="ln1403">	item-&gt;SetTarget(this);</a>
<a name="ln1404">	menu-&gt;AddItem(fFindAgainMenuItem = new BMenuItem(B_TRANSLATE(&quot;Find again&quot;),</a>
<a name="ln1405">		new BMessage(kMsgFind), 'G'));</a>
<a name="ln1406">	fFindAgainMenuItem-&gt;SetEnabled(false);</a>
<a name="ln1407">	fFindAgainMenuItem-&gt;SetTarget(this);</a>
<a name="ln1408">	bar-&gt;AddItem(menu);</a>
<a name="ln1409"> </a>
<a name="ln1410">	// &quot;Block&quot; menu</a>
<a name="ln1411"> </a>
<a name="ln1412">	menu = new BMenu(B_TRANSLATE(&quot;Block&quot;));</a>
<a name="ln1413">	BMessage* message = new BMessage(kMsgPositionUpdate);</a>
<a name="ln1414">	message-&gt;AddInt32(&quot;delta&quot;, 1);</a>
<a name="ln1415">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Next&quot;), message,</a>
<a name="ln1416">		B_RIGHT_ARROW));</a>
<a name="ln1417">	item-&gt;SetTarget(fHeaderView);</a>
<a name="ln1418">	message = new BMessage(kMsgPositionUpdate);</a>
<a name="ln1419">	message-&gt;AddInt32(&quot;delta&quot;, -1);</a>
<a name="ln1420">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Previous&quot;), message,</a>
<a name="ln1421">		B_LEFT_ARROW));</a>
<a name="ln1422">	item-&gt;SetTarget(fHeaderView);</a>
<a name="ln1423">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Back&quot;),</a>
<a name="ln1424">		new BMessage(kMsgLastPosition), 'J'));</a>
<a name="ln1425">	item-&gt;SetTarget(fHeaderView);</a>
<a name="ln1426"> </a>
<a name="ln1427">	BMenu* subMenu = new BMenu(B_TRANSLATE(&quot;Selection&quot;));</a>
<a name="ln1428">	message = new BMessage(kMsgPositionUpdate);</a>
<a name="ln1429">	message-&gt;AddInt64(&quot;block&quot;, 0);</a>
<a name="ln1430">	subMenu-&gt;AddItem(fNativeMenuItem = new BMenuItem(&quot;&quot;, message, 'K'));</a>
<a name="ln1431">	fNativeMenuItem-&gt;SetTarget(fHeaderView);</a>
<a name="ln1432">	message = new BMessage(*message);</a>
<a name="ln1433">	subMenu-&gt;AddItem(fSwappedMenuItem = new BMenuItem(&quot;&quot;, message, 'L'));</a>
<a name="ln1434">	fSwappedMenuItem-&gt;SetTarget(fHeaderView);</a>
<a name="ln1435">	menu-&gt;AddItem(new BMenuItem(subMenu));</a>
<a name="ln1436">	_UpdateSelectionMenuItems(0, 0);</a>
<a name="ln1437">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1438"> </a>
<a name="ln1439">	fBookmarkMenu = new BMenu(B_TRANSLATE(&quot;Bookmarks&quot;));</a>
<a name="ln1440">	fBookmarkMenu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Add&quot;),</a>
<a name="ln1441">		new BMessage(kMsgAddBookmark), 'B'));</a>
<a name="ln1442">	item-&gt;SetTarget(this);</a>
<a name="ln1443">	menu-&gt;AddItem(new BMenuItem(fBookmarkMenu));</a>
<a name="ln1444">	bar-&gt;AddItem(menu);</a>
<a name="ln1445"> </a>
<a name="ln1446">	// &quot;Attributes&quot; menu (it's only visible if the underlying</a>
<a name="ln1447">	// file system actually supports attributes)</a>
<a name="ln1448"> </a>
<a name="ln1449">	BDirectory directory;</a>
<a name="ln1450">	BVolume volume;</a>
<a name="ln1451">	if (directory.SetTo(&amp;fEditor.AttributeRef()) == B_OK</a>
<a name="ln1452">		&amp;&amp; directory.IsRootDirectory())</a>
<a name="ln1453">		directory.GetVolume(&amp;volume);</a>
<a name="ln1454">	else</a>
<a name="ln1455">		fEditor.File().GetVolume(&amp;volume);</a>
<a name="ln1456"> </a>
<a name="ln1457">	if (!fEditor.IsAttribute() &amp;&amp; volume.InitCheck() == B_OK</a>
<a name="ln1458">		&amp;&amp; (volume.KnowsMime() || volume.KnowsAttr())) {</a>
<a name="ln1459">		bar-&gt;AddItem(menu = new BMenu(B_TRANSLATE(&quot;Attributes&quot;)));</a>
<a name="ln1460">		_UpdateAttributesMenu(menu);</a>
<a name="ln1461">	}</a>
<a name="ln1462"> </a>
<a name="ln1463">	// &quot;View&quot; menu</a>
<a name="ln1464"> </a>
<a name="ln1465">	menu = new BMenu(B_TRANSLATE_COMMENT(&quot;View&quot;,</a>
<a name="ln1466">		&quot;This is the last menubar item 'File Edit Block View'&quot;));</a>
<a name="ln1467"> </a>
<a name="ln1468">	// Number Base (hex/decimal)</a>
<a name="ln1469"> </a>
<a name="ln1470">	subMenu = new BMenu(B_TRANSLATE_COMMENT(&quot;Base&quot;, &quot;A menu item, the number &quot;</a>
<a name="ln1471">		&quot;that is basis for a system of calculation. The base 10 system is a &quot;</a>
<a name="ln1472">		&quot;decimal system. This is in the same menu window than 'Font size' &quot;</a>
<a name="ln1473">		&quot;and 'BlockSize'&quot;));</a>
<a name="ln1474">	message = new BMessage(kMsgBaseType);</a>
<a name="ln1475">	message-&gt;AddInt32(&quot;base_type&quot;, kDecimalBase);</a>
<a name="ln1476">	subMenu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE_COMMENT(&quot;Decimal&quot;,</a>
<a name="ln1477">		&quot;A menu item, as short as possible, noun is recommended if it is &quot;</a>
<a name="ln1478">		&quot;shorter than adjective.&quot;), message, 'D'));</a>
<a name="ln1479">	item-&gt;SetTarget(this);</a>
<a name="ln1480">	if (fHeaderView-&gt;Base() == kDecimalBase)</a>
<a name="ln1481">		item-&gt;SetMarked(true);</a>
<a name="ln1482"> </a>
<a name="ln1483">	message = new BMessage(kMsgBaseType);</a>
<a name="ln1484">	message-&gt;AddInt32(&quot;base_type&quot;, kHexBase);</a>
<a name="ln1485">	subMenu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE_COMMENT(&quot;Hex&quot;,</a>
<a name="ln1486">		&quot;A menu item, as short as possible, noun is recommended if it is &quot;</a>
<a name="ln1487">		&quot;shorter than adjective.&quot;), message, 'H'));</a>
<a name="ln1488">	item-&gt;SetTarget(this);</a>
<a name="ln1489">	if (fHeaderView-&gt;Base() == kHexBase)</a>
<a name="ln1490">		item-&gt;SetMarked(true);</a>
<a name="ln1491"> </a>
<a name="ln1492">	subMenu-&gt;SetRadioMode(true);</a>
<a name="ln1493">	menu-&gt;AddItem(new BMenuItem(subMenu));</a>
<a name="ln1494"> </a>
<a name="ln1495">	// Block Size</a>
<a name="ln1496"> </a>
<a name="ln1497">	subMenu = new BMenu(B_TRANSLATE_COMMENT(&quot;Block size&quot;, &quot;Menu item. &quot;</a>
<a name="ln1498">		&quot;This is in the same menu window than 'Base' and 'Font size'&quot;));</a>
<a name="ln1499">	subMenu-&gt;SetRadioMode(true);</a>
<a name="ln1500">	const uint32 blockSizes[] = {512, 1024, 2048};</a>
<a name="ln1501">	for (uint32 i = 0; i &lt; sizeof(blockSizes) / sizeof(blockSizes[0]); i++) {</a>
<a name="ln1502">		char buffer[32];</a>
<a name="ln1503">		snprintf(buffer, sizeof(buffer), &quot;%&quot; B_PRId32 &quot;%s&quot;, blockSizes[i],</a>
<a name="ln1504">			fEditor.IsDevice() &amp;&amp; fEditor.BlockSize() == blockSizes[i]</a>
<a name="ln1505">			? B_TRANSLATE(&quot; (native)&quot;) : &quot;&quot;);</a>
<a name="ln1506">		subMenu-&gt;AddItem(item = new BMenuItem(buffer,</a>
<a name="ln1507">			message = new BMessage(kMsgBlockSize)));</a>
<a name="ln1508">		message-&gt;AddInt32(&quot;block_size&quot;, blockSizes[i]);</a>
<a name="ln1509">		if (fEditor.BlockSize() == blockSizes[i])</a>
<a name="ln1510">			item-&gt;SetMarked(true);</a>
<a name="ln1511">	}</a>
<a name="ln1512">	if (subMenu-&gt;FindMarked() == NULL) {</a>
<a name="ln1513">		// if the device has some weird block size, we'll add it here, too</a>
<a name="ln1514">		char buffer[32];</a>
<a name="ln1515">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;%ld (native)&quot;),</a>
<a name="ln1516">			fEditor.BlockSize());</a>
<a name="ln1517">		subMenu-&gt;AddItem(item = new BMenuItem(buffer,</a>
<a name="ln1518">			message = new BMessage(kMsgBlockSize)));</a>
<a name="ln1519">		message-&gt;AddInt32(&quot;block_size&quot;, fEditor.BlockSize());</a>
<a name="ln1520">		item-&gt;SetMarked(true);</a>
<a name="ln1521">	}</a>
<a name="ln1522">	subMenu-&gt;SetTargetForItems(this);</a>
<a name="ln1523">	menu-&gt;AddItem(new BMenuItem(subMenu));</a>
<a name="ln1524">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1525"> </a>
<a name="ln1526">	// Font Size</a>
<a name="ln1527"> </a>
<a name="ln1528">	subMenu = new BMenu(B_TRANSLATE(&quot;Font size&quot;));</a>
<a name="ln1529">	subMenu-&gt;SetRadioMode(true);</a>
<a name="ln1530">	const int32 fontSizes[] = {9, 10, 11, 12, 13, 14, 18, 24, 36, 48};</a>
<a name="ln1531">	int32 fontSize = int32(fDataView-&gt;FontSize() + 0.5);</a>
<a name="ln1532">	if (fDataView-&gt;FontSizeFitsBounds())</a>
<a name="ln1533">		fontSize = 0;</a>
<a name="ln1534">	for (uint32 i = 0; i &lt; sizeof(fontSizes) / sizeof(fontSizes[0]); i++) {</a>
<a name="ln1535">		char buffer[16];</a>
<a name="ln1536">		snprintf(buffer, sizeof(buffer), &quot;%&quot; B_PRId32, fontSizes[i]);</a>
<a name="ln1537">		subMenu-&gt;AddItem(item = new BMenuItem(buffer,</a>
<a name="ln1538">			message = new BMessage(kMsgFontSize)));</a>
<a name="ln1539">		message-&gt;AddFloat(&quot;font_size&quot;, fontSizes[i]);</a>
<a name="ln1540">		if (fontSizes[i] == fontSize)</a>
<a name="ln1541">			item-&gt;SetMarked(true);</a>
<a name="ln1542">	}</a>
<a name="ln1543">	subMenu-&gt;AddSeparatorItem();</a>
<a name="ln1544">	subMenu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE_COMMENT(&quot;Fit&quot;,</a>
<a name="ln1545">		&quot;Size of fonts, fits to available room&quot;),</a>
<a name="ln1546">		message = new BMessage(kMsgFontSize)));</a>
<a name="ln1547">	message-&gt;AddFloat(&quot;font_size&quot;, 0.0f);</a>
<a name="ln1548">	if (fontSize == 0)</a>
<a name="ln1549">		item-&gt;SetMarked(true);</a>
<a name="ln1550"> </a>
<a name="ln1551">	subMenu-&gt;SetTargetForItems(this);</a>
<a name="ln1552">	menu-&gt;AddItem(new BMenuItem(subMenu));</a>
<a name="ln1553"> </a>
<a name="ln1554">	bar-&gt;AddItem(menu);</a>
<a name="ln1555">}</a>
<a name="ln1556"> </a>
<a name="ln1557"> </a>
<a name="ln1558">void</a>
<a name="ln1559">ProbeView::AllAttached()</a>
<a name="ln1560">{</a>
<a name="ln1561">	fHeaderView-&gt;SetTarget(fEditorLooper);</a>
<a name="ln1562">}</a>
<a name="ln1563"> </a>
<a name="ln1564"> </a>
<a name="ln1565">void</a>
<a name="ln1566">ProbeView::WindowActivated(bool active)</a>
<a name="ln1567">{</a>
<a name="ln1568">	if (!active)</a>
<a name="ln1569">		return;</a>
<a name="ln1570"> </a>
<a name="ln1571">	fDataView-&gt;MakeFocus(true);</a>
<a name="ln1572"> </a>
<a name="ln1573">	// set this view as the current find panel's target</a>
<a name="ln1574">	BMessage target(kMsgFindTarget);</a>
<a name="ln1575">	target.AddMessenger(&quot;target&quot;, this);</a>
<a name="ln1576">	be_app_messenger.SendMessage(&amp;target);</a>
<a name="ln1577">}</a>
<a name="ln1578"> </a>
<a name="ln1579"> </a>
<a name="ln1580">void</a>
<a name="ln1581">ProbeView::_UpdateSelectionMenuItems(int64 start, int64 end)</a>
<a name="ln1582">{</a>
<a name="ln1583">	int64 position = 0;</a>
<a name="ln1584">	const uint8* data = fDataView-&gt;DataAt(start);</a>
<a name="ln1585">	if (data == NULL) {</a>
<a name="ln1586">		fNativeMenuItem-&gt;SetEnabled(false);</a>
<a name="ln1587">		fSwappedMenuItem-&gt;SetEnabled(false);</a>
<a name="ln1588">		return;</a>
<a name="ln1589">	}</a>
<a name="ln1590"> </a>
<a name="ln1591">	// retrieve native endian position</a>
<a name="ln1592"> </a>
<a name="ln1593">	int size;</a>
<a name="ln1594">	if (end &lt; start + 8)</a>
<a name="ln1595">		size = end + 1 - start;</a>
<a name="ln1596">	else</a>
<a name="ln1597">		size = 8;</a>
<a name="ln1598"> </a>
<a name="ln1599">	int64 bigEndianPosition = 0;</a>
<a name="ln1600">	memcpy(&amp;bigEndianPosition, data, size);</a>
<a name="ln1601"> </a>
<a name="ln1602">	position = B_BENDIAN_TO_HOST_INT64(bigEndianPosition) &gt;&gt; (8 * (8 - size));</a>
<a name="ln1603"> </a>
<a name="ln1604">	// update menu items</a>
<a name="ln1605"> </a>
<a name="ln1606">	char buffer[128];</a>
<a name="ln1607">	if (fDataView-&gt;Base() == kHexBase) {</a>
<a name="ln1608">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Native: 0x%0*Lx&quot;),</a>
<a name="ln1609">			size * 2, position);</a>
<a name="ln1610">	} else {</a>
<a name="ln1611">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Native: %Ld (0x%0*Lx)&quot;),</a>
<a name="ln1612">			position, size * 2, position);</a>
<a name="ln1613">	}</a>
<a name="ln1614"> </a>
<a name="ln1615">	fNativeMenuItem-&gt;SetLabel(buffer);</a>
<a name="ln1616">	fNativeMenuItem-&gt;SetEnabled(position &gt;= 0</a>
<a name="ln1617">		&amp;&amp; (off_t)(position * fEditor.BlockSize()) &lt; fEditor.FileSize());</a>
<a name="ln1618">	fNativeMenuItem-&gt;Message()-&gt;ReplaceInt64(&quot;block&quot;, position);</a>
<a name="ln1619"> </a>
<a name="ln1620">	position = B_SWAP_INT64(position) &gt;&gt; (8 * (8 - size));</a>
<a name="ln1621">	if (fDataView-&gt;Base() == kHexBase) {</a>
<a name="ln1622">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Swapped: 0x%0*Lx&quot;),</a>
<a name="ln1623">			size * 2, position);</a>
<a name="ln1624">	} else {</a>
<a name="ln1625">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Swapped: %Ld (0x%0*Lx)&quot;),</a>
<a name="ln1626">			position, size * 2, position);</a>
<a name="ln1627">	}</a>
<a name="ln1628"> </a>
<a name="ln1629">	fSwappedMenuItem-&gt;SetLabel(buffer);</a>
<a name="ln1630">	fSwappedMenuItem-&gt;SetEnabled(position &gt;= 0 &amp;&amp; (off_t)(position * fEditor.BlockSize()) &lt; fEditor.FileSize());</a>
<a name="ln1631">	fSwappedMenuItem-&gt;Message()-&gt;ReplaceInt64(&quot;block&quot;, position);</a>
<a name="ln1632">}</a>
<a name="ln1633"> </a>
<a name="ln1634"> </a>
<a name="ln1635">void</a>
<a name="ln1636">ProbeView::_UpdateBookmarkMenuItems()</a>
<a name="ln1637">{</a>
<a name="ln1638">	for (int32 i = 2; i &lt; fBookmarkMenu-&gt;CountItems(); i++) {</a>
<a name="ln1639">		BMenuItem* item = fBookmarkMenu-&gt;ItemAt(i);</a>
<a name="ln1640">		if (item == NULL)</a>
<a name="ln1641">			break;</a>
<a name="ln1642"> </a>
<a name="ln1643">		BMessage* message = item-&gt;Message();</a>
<a name="ln1644">		if (message == NULL)</a>
<a name="ln1645">			break;</a>
<a name="ln1646"> </a>
<a name="ln1647">		off_t block = message-&gt;FindInt64(&quot;block&quot;);</a>
<a name="ln1648"> </a>
<a name="ln1649">		char buffer[128];</a>
<a name="ln1650">		if (fDataView-&gt;Base() == kHexBase)</a>
<a name="ln1651">			snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Block 0x%Lx&quot;), block);</a>
<a name="ln1652">		else</a>
<a name="ln1653">			snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Block %Ld (0x%Lx)&quot;), block, block);</a>
<a name="ln1654"> </a>
<a name="ln1655">		item-&gt;SetLabel(buffer);</a>
<a name="ln1656">	}</a>
<a name="ln1657">}</a>
<a name="ln1658"> </a>
<a name="ln1659"> </a>
<a name="ln1660">void</a>
<a name="ln1661">ProbeView::_AddBookmark(off_t position)</a>
<a name="ln1662">{</a>
<a name="ln1663">	int32 count = fBookmarkMenu-&gt;CountItems();</a>
<a name="ln1664"> </a>
<a name="ln1665">	if (count == 1) {</a>
<a name="ln1666">		fBookmarkMenu-&gt;AddSeparatorItem();</a>
<a name="ln1667">		count++;</a>
<a name="ln1668">	}</a>
<a name="ln1669"> </a>
<a name="ln1670">	// insert current position as bookmark</a>
<a name="ln1671"> </a>
<a name="ln1672">	off_t block = position / fEditor.BlockSize();</a>
<a name="ln1673"> </a>
<a name="ln1674">	off_t bookmark = -1;</a>
<a name="ln1675">	BMenuItem* item;</a>
<a name="ln1676">	int32 i;</a>
<a name="ln1677">	for (i = 2; (item = fBookmarkMenu-&gt;ItemAt(i)) != NULL; i++) {</a>
<a name="ln1678">		BMessage* message = item-&gt;Message();</a>
<a name="ln1679">		if (message != NULL &amp;&amp; message-&gt;FindInt64(&quot;block&quot;, &amp;bookmark) == B_OK) {</a>
<a name="ln1680">			if (block &lt;= bookmark)</a>
<a name="ln1681">				break;</a>
<a name="ln1682">		}</a>
<a name="ln1683">	}</a>
<a name="ln1684"> </a>
<a name="ln1685">	// the bookmark already exists</a>
<a name="ln1686">	if (block == bookmark)</a>
<a name="ln1687">		return;</a>
<a name="ln1688"> </a>
<a name="ln1689">	char buffer[128];</a>
<a name="ln1690">	if (fDataView-&gt;Base() == kHexBase)</a>
<a name="ln1691">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Block 0x%Lx&quot;), block);</a>
<a name="ln1692">	else</a>
<a name="ln1693">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Block %Ld (0x%Lx)&quot;), block, block);</a>
<a name="ln1694"> </a>
<a name="ln1695">	BMessage* message;</a>
<a name="ln1696">	item = new BMenuItem(buffer, message = new BMessage(kMsgPositionUpdate));</a>
<a name="ln1697">	item-&gt;SetTarget(fHeaderView);</a>
<a name="ln1698">	if (count &lt; 12)</a>
<a name="ln1699">		item-&gt;SetShortcut('0' + count - 2, B_COMMAND_KEY);</a>
<a name="ln1700">	message-&gt;AddInt64(&quot;block&quot;, block);</a>
<a name="ln1701"> </a>
<a name="ln1702">	fBookmarkMenu-&gt;AddItem(item, i);</a>
<a name="ln1703">}</a>
<a name="ln1704"> </a>
<a name="ln1705"> </a>
<a name="ln1706">void</a>
<a name="ln1707">ProbeView::_RemoveTypeEditor()</a>
<a name="ln1708">{</a>
<a name="ln1709">	if (fTypeView == NULL)</a>
<a name="ln1710">		return;</a>
<a name="ln1711"> </a>
<a name="ln1712">	if (Parent() != NULL)</a>
<a name="ln1713">		Parent()-&gt;RemoveChild(fTypeView);</a>
<a name="ln1714">	else</a>
<a name="ln1715">		Window()-&gt;RemoveChild(fTypeView);</a>
<a name="ln1716"> </a>
<a name="ln1717">	delete fTypeView;</a>
<a name="ln1718">	fTypeView = NULL;</a>
<a name="ln1719">}</a>
<a name="ln1720"> </a>
<a name="ln1721"> </a>
<a name="ln1722">void</a>
<a name="ln1723">ProbeView::_SetTypeEditor(int32 index)</a>
<a name="ln1724">{</a>
<a name="ln1725">	if (index == -1) {</a>
<a name="ln1726">		// remove type editor, show raw editor</a>
<a name="ln1727">		if (IsHidden())</a>
<a name="ln1728">			Show();</a>
<a name="ln1729"> </a>
<a name="ln1730">		_RemoveTypeEditor();</a>
<a name="ln1731">	} else {</a>
<a name="ln1732">		// hide raw editor, create and show type editor</a>
<a name="ln1733">		if (!IsHidden())</a>
<a name="ln1734">			Hide();</a>
<a name="ln1735"> </a>
<a name="ln1736">		_RemoveTypeEditor();</a>
<a name="ln1737"> </a>
<a name="ln1738">		fTypeView = new TypeView(Frame(), &quot;type shell&quot;, index, fEditor,</a>
<a name="ln1739">			B_FOLLOW_ALL);</a>
<a name="ln1740"> </a>
<a name="ln1741">		if (Parent() != NULL)</a>
<a name="ln1742">			Parent()-&gt;AddChild(fTypeView);</a>
<a name="ln1743">		else</a>
<a name="ln1744">			Window()-&gt;AddChild(fTypeView);</a>
<a name="ln1745">	}</a>
<a name="ln1746">}</a>
<a name="ln1747"> </a>
<a name="ln1748"> </a>
<a name="ln1749">void</a>
<a name="ln1750">ProbeView::_CheckClipboard()</a>
<a name="ln1751">{</a>
<a name="ln1752">	if (!be_clipboard-&gt;Lock())</a>
<a name="ln1753">		return;</a>
<a name="ln1754"> </a>
<a name="ln1755">	bool hasData = false;</a>
<a name="ln1756">	BMessage* clip;</a>
<a name="ln1757">	if ((clip = be_clipboard-&gt;Data()) != NULL) {</a>
<a name="ln1758">		const void* data;</a>
<a name="ln1759">		ssize_t size;</a>
<a name="ln1760">		if (clip-&gt;FindData(B_FILE_MIME_TYPE, B_MIME_TYPE, &amp;data, &amp;size) == B_OK</a>
<a name="ln1761">			|| clip-&gt;FindData(&quot;text/plain&quot;, B_MIME_TYPE, &amp;data, &amp;size) == B_OK)</a>
<a name="ln1762">			hasData = true;</a>
<a name="ln1763">	}</a>
<a name="ln1764"> </a>
<a name="ln1765">	be_clipboard-&gt;Unlock();</a>
<a name="ln1766"> </a>
<a name="ln1767">	fPasteMenuItem-&gt;SetEnabled(hasData);</a>
<a name="ln1768">}</a>
<a name="ln1769"> </a>
<a name="ln1770"> </a>
<a name="ln1771">status_t</a>
<a name="ln1772">ProbeView::_PageSetup()</a>
<a name="ln1773">{</a>
<a name="ln1774">	BPrintJob printJob(Window()-&gt;Title());</a>
<a name="ln1775">	if (fPrintSettings != NULL)</a>
<a name="ln1776">		printJob.SetSettings(new BMessage(*fPrintSettings));</a>
<a name="ln1777"> </a>
<a name="ln1778">	status_t status = printJob.ConfigPage();</a>
<a name="ln1779">	if (status == B_OK) {</a>
<a name="ln1780">		// replace the print settings on success</a>
<a name="ln1781">		delete fPrintSettings;</a>
<a name="ln1782">		fPrintSettings = printJob.Settings();</a>
<a name="ln1783">	}</a>
<a name="ln1784"> </a>
<a name="ln1785">	return status;</a>
<a name="ln1786">}</a>
<a name="ln1787"> </a>
<a name="ln1788"> </a>
<a name="ln1789">void</a>
<a name="ln1790">ProbeView::_Print()</a>
<a name="ln1791">{</a>
<a name="ln1792">	if (fPrintSettings == NULL &amp;&amp; _PageSetup() != B_OK)</a>
<a name="ln1793">		return;</a>
<a name="ln1794"> </a>
<a name="ln1795">	BPrintJob printJob(Window()-&gt;Title());</a>
<a name="ln1796">	printJob.SetSettings(new BMessage(*fPrintSettings));</a>
<a name="ln1797"> </a>
<a name="ln1798">	if (printJob.ConfigJob() == B_OK) {</a>
<a name="ln1799">		BRect rect = printJob.PrintableRect();</a>
<a name="ln1800"> </a>
<a name="ln1801">		float width, height;</a>
<a name="ln1802">		fDataView-&gt;GetPreferredSize(&amp;width, &amp;height);</a>
<a name="ln1803"> </a>
<a name="ln1804">		printJob.BeginJob();</a>
<a name="ln1805"> </a>
<a name="ln1806">		fDataView-&gt;SetScale(rect.Width() / width);</a>
<a name="ln1807">		printJob.DrawView(fDataView, rect, rect.LeftTop());</a>
<a name="ln1808">		fDataView-&gt;SetScale(1.0);</a>
<a name="ln1809">		printJob.SpoolPage();</a>
<a name="ln1810"> </a>
<a name="ln1811">		printJob.CommitJob();</a>
<a name="ln1812">	}</a>
<a name="ln1813">}</a>
<a name="ln1814"> </a>
<a name="ln1815"> </a>
<a name="ln1816">status_t</a>
<a name="ln1817">ProbeView::_Save()</a>
<a name="ln1818">{</a>
<a name="ln1819">	status_t status = fEditor.Save();</a>
<a name="ln1820">	if (status == B_OK)</a>
<a name="ln1821">		return B_OK;</a>
<a name="ln1822"> </a>
<a name="ln1823">	char buffer[1024];</a>
<a name="ln1824">	snprintf(buffer, sizeof(buffer),</a>
<a name="ln1825">		B_TRANSLATE(&quot;Writing to the file failed:\n&quot;</a>
<a name="ln1826">		&quot;%s\n\n&quot;</a>
<a name="ln1827">		&quot;All changes will be lost when you quit.&quot;),</a>
<a name="ln1828">		strerror(status));</a>
<a name="ln1829"> </a>
<a name="ln1830">	BAlert* alert = new BAlert(B_TRANSLATE(&quot;DiskProbe request&quot;),</a>
<a name="ln1831">		buffer, B_TRANSLATE(&quot;OK&quot;), NULL, NULL,</a>
<a name="ln1832">		B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln1833">	alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1834">	alert-&gt;Go(NULL);</a>
<a name="ln1835"> </a>
<a name="ln1836">	return status;</a>
<a name="ln1837">}</a>
<a name="ln1838"> </a>
<a name="ln1839"> </a>
<a name="ln1840">bool</a>
<a name="ln1841">ProbeView::QuitRequested()</a>
<a name="ln1842">{</a>
<a name="ln1843">	fEditorLooper-&gt;QuitFind();</a>
<a name="ln1844"> </a>
<a name="ln1845">	if (!fEditor.IsModified())</a>
<a name="ln1846">		return true;</a>
<a name="ln1847"> </a>
<a name="ln1848">	BAlert* alert = new BAlert(B_TRANSLATE(&quot;DiskProbe request&quot;),</a>
<a name="ln1849">		B_TRANSLATE(&quot;Save changes before closing?&quot;), B_TRANSLATE(&quot;Cancel&quot;),</a>
<a name="ln1850">		B_TRANSLATE(&quot;Don't save&quot;), B_TRANSLATE(&quot;Save&quot;), B_WIDTH_AS_USUAL,</a>
<a name="ln1851">		B_OFFSET_SPACING, B_WARNING_ALERT);</a>
<a name="ln1852">	alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln1853">	alert-&gt;SetShortcut(1, 'd');</a>
<a name="ln1854">	alert-&gt;SetShortcut(2, 's');</a>
<a name="ln1855">	int32 chosen = alert-&gt;Go();</a>
<a name="ln1856"> </a>
<a name="ln1857">	if (chosen == 0)</a>
<a name="ln1858">		return false;</a>
<a name="ln1859">	if (chosen == 1)</a>
<a name="ln1860">		return true;</a>
<a name="ln1861"> </a>
<a name="ln1862">	return _Save() == B_OK;</a>
<a name="ln1863">}</a>
<a name="ln1864"> </a>
<a name="ln1865"> </a>
<a name="ln1866">void</a>
<a name="ln1867">ProbeView::MessageReceived(BMessage* message)</a>
<a name="ln1868">{</a>
<a name="ln1869">	switch (message-&gt;what) {</a>
<a name="ln1870">		case B_SAVE_REQUESTED:</a>
<a name="ln1871">			_Save();</a>
<a name="ln1872">			break;</a>
<a name="ln1873"> </a>
<a name="ln1874">		case B_OBSERVER_NOTICE_CHANGE: {</a>
<a name="ln1875">			int32 what;</a>
<a name="ln1876">			if (message-&gt;FindInt32(B_OBSERVE_WHAT_CHANGE, &amp;what) != B_OK)</a>
<a name="ln1877">				break;</a>
<a name="ln1878"> </a>
<a name="ln1879">			switch (what) {</a>
<a name="ln1880">				case kDataViewSelection:</a>
<a name="ln1881">				{</a>
<a name="ln1882">					int64 start, end;</a>
<a name="ln1883">					if (message-&gt;FindInt64(&quot;start&quot;, &amp;start) == B_OK</a>
<a name="ln1884">						&amp;&amp; message-&gt;FindInt64(&quot;end&quot;, &amp;end) == B_OK)</a>
<a name="ln1885">						_UpdateSelectionMenuItems(start, end);</a>
<a name="ln1886">					break;</a>
<a name="ln1887">				}</a>
<a name="ln1888">			}</a>
<a name="ln1889">			break;</a>
<a name="ln1890">		}</a>
<a name="ln1891"> </a>
<a name="ln1892">		case kMsgBaseType:</a>
<a name="ln1893">		{</a>
<a name="ln1894">			int32 type;</a>
<a name="ln1895">			if (message-&gt;FindInt32(&quot;base_type&quot;, &amp;type) != B_OK)</a>
<a name="ln1896">				break;</a>
<a name="ln1897"> </a>
<a name="ln1898">			fHeaderView-&gt;SetBase((base_type)type);</a>
<a name="ln1899">			fDataView-&gt;SetBase((base_type)type);</a>
<a name="ln1900"> </a>
<a name="ln1901">			// The selection menu items depend on the base type as well</a>
<a name="ln1902">			int32 start, end;</a>
<a name="ln1903">			fDataView-&gt;GetSelection(start, end);</a>
<a name="ln1904">			_UpdateSelectionMenuItems(start, end);</a>
<a name="ln1905"> </a>
<a name="ln1906">			_UpdateBookmarkMenuItems();</a>
<a name="ln1907"> </a>
<a name="ln1908">			// update the application's settings</a>
<a name="ln1909">			BMessage update(*message);</a>
<a name="ln1910">			update.what = kMsgSettingsChanged;</a>
<a name="ln1911">			be_app_messenger.SendMessage(&amp;update);</a>
<a name="ln1912">			break;</a>
<a name="ln1913">		}</a>
<a name="ln1914"> </a>
<a name="ln1915">		case kMsgFontSize:</a>
<a name="ln1916">		{</a>
<a name="ln1917">			float size;</a>
<a name="ln1918">			if (message-&gt;FindFloat(&quot;font_size&quot;, &amp;size) != B_OK)</a>
<a name="ln1919">				break;</a>
<a name="ln1920"> </a>
<a name="ln1921">			fDataView-&gt;SetFontSize(size);</a>
<a name="ln1922"> </a>
<a name="ln1923">			// update the application's settings</a>
<a name="ln1924">			BMessage update(*message);</a>
<a name="ln1925">			update.what = kMsgSettingsChanged;</a>
<a name="ln1926">			be_app_messenger.SendMessage(&amp;update);</a>
<a name="ln1927">			break;</a>
<a name="ln1928">		}</a>
<a name="ln1929"> </a>
<a name="ln1930">		case kMsgBlockSize:</a>
<a name="ln1931">		{</a>
<a name="ln1932">			int32 blockSize;</a>
<a name="ln1933">			if (message-&gt;FindInt32(&quot;block_size&quot;, &amp;blockSize) != B_OK)</a>
<a name="ln1934">				break;</a>
<a name="ln1935"> </a>
<a name="ln1936">			BAutolock locker(fEditor);</a>
<a name="ln1937"> </a>
<a name="ln1938">			if (fEditor.SetViewSize(blockSize) == B_OK</a>
<a name="ln1939">				&amp;&amp; fEditor.SetBlockSize(blockSize) == B_OK)</a>
<a name="ln1940">				fHeaderView-&gt;SetTo(fEditor.ViewOffset(), blockSize);</a>
<a name="ln1941">			break;</a>
<a name="ln1942">		}</a>
<a name="ln1943"> </a>
<a name="ln1944">		case kMsgViewAs:</a>
<a name="ln1945">		{</a>
<a name="ln1946">			int32 index;</a>
<a name="ln1947">			if (message-&gt;FindInt32(&quot;editor index&quot;, &amp;index) != B_OK)</a>
<a name="ln1948">				index = -1;</a>
<a name="ln1949"> </a>
<a name="ln1950">			_SetTypeEditor(index);</a>
<a name="ln1951">			break;</a>
<a name="ln1952">		}</a>
<a name="ln1953"> </a>
<a name="ln1954">		case kMsgAddBookmark:</a>
<a name="ln1955">			_AddBookmark(fHeaderView-&gt;Position());</a>
<a name="ln1956">			break;</a>
<a name="ln1957"> </a>
<a name="ln1958">		case kMsgPrint:</a>
<a name="ln1959">			_Print();</a>
<a name="ln1960">			break;</a>
<a name="ln1961"> </a>
<a name="ln1962">		case kMsgPageSetup:</a>
<a name="ln1963">			_PageSetup();</a>
<a name="ln1964">			break;</a>
<a name="ln1965"> </a>
<a name="ln1966">		case kMsgOpenFindWindow:</a>
<a name="ln1967">		{</a>
<a name="ln1968">			fEditorLooper-&gt;QuitFind();</a>
<a name="ln1969"> </a>
<a name="ln1970">			// set this view as the current find panel's target</a>
<a name="ln1971">			BMessage find(*fFindAgainMenuItem-&gt;Message());</a>
<a name="ln1972">			find.what = kMsgOpenFindWindow;</a>
<a name="ln1973">			find.AddMessenger(&quot;target&quot;, this);</a>
<a name="ln1974">			be_app_messenger.SendMessage(&amp;find);</a>
<a name="ln1975">			break;</a>
<a name="ln1976">		}</a>
<a name="ln1977"> </a>
<a name="ln1978">		case kMsgFind:</a>
<a name="ln1979">		{</a>
<a name="ln1980">			const uint8* data;</a>
<a name="ln1981">			ssize_t size;</a>
<a name="ln1982">			if (message-&gt;FindData(&quot;data&quot;, B_RAW_TYPE, (const void**)&amp;data,</a>
<a name="ln1983">					&amp;size) != B_OK) {</a>
<a name="ln1984">				// search again for last pattern</a>
<a name="ln1985">				BMessage* itemMessage = fFindAgainMenuItem-&gt;Message();</a>
<a name="ln1986">				if (itemMessage == NULL || itemMessage-&gt;FindData(&quot;data&quot;,</a>
<a name="ln1987">						B_RAW_TYPE, (const void**)&amp;data, &amp;size) != B_OK) {</a>
<a name="ln1988">					// this shouldn't ever happen, but well...</a>
<a name="ln1989">					beep();</a>
<a name="ln1990">					break;</a>
<a name="ln1991">				}</a>
<a name="ln1992">			} else {</a>
<a name="ln1993">				// remember the search pattern</a>
<a name="ln1994">				fFindAgainMenuItem-&gt;SetMessage(new BMessage(*message));</a>
<a name="ln1995">				fFindAgainMenuItem-&gt;SetEnabled(true);</a>
<a name="ln1996">			}</a>
<a name="ln1997"> </a>
<a name="ln1998">			int32 start, end;</a>
<a name="ln1999">			fDataView-&gt;GetSelection(start, end);</a>
<a name="ln2000"> </a>
<a name="ln2001">			BMessage find(*message);</a>
<a name="ln2002">			find.AddInt64(&quot;start&quot;, fHeaderView-&gt;Position() + start + 1);</a>
<a name="ln2003">			find.AddMessenger(&quot;progress_monitor&quot;, BMessenger(fHeaderView));</a>
<a name="ln2004">			fEditorLooper-&gt;PostMessage(&amp;find);</a>
<a name="ln2005">			break;</a>
<a name="ln2006">		}</a>
<a name="ln2007"> </a>
<a name="ln2008">		case kMsgStopFind:</a>
<a name="ln2009">			fEditorLooper-&gt;QuitFind();</a>
<a name="ln2010">			break;</a>
<a name="ln2011"> </a>
<a name="ln2012">		case B_NODE_MONITOR:</a>
<a name="ln2013">		{</a>
<a name="ln2014">			switch (message-&gt;FindInt32(&quot;opcode&quot;)) {</a>
<a name="ln2015">				case B_STAT_CHANGED:</a>
<a name="ln2016">					fEditor.ForceUpdate();</a>
<a name="ln2017">					break;</a>
<a name="ln2018">				case B_ATTR_CHANGED:</a>
<a name="ln2019">				{</a>
<a name="ln2020">					const char* name;</a>
<a name="ln2021">					if (message-&gt;FindString(&quot;attr&quot;, &amp;name) != B_OK)</a>
<a name="ln2022">						break;</a>
<a name="ln2023"> </a>
<a name="ln2024">					if (fEditor.IsAttribute()) {</a>
<a name="ln2025">						if (!strcmp(name, fEditor.Attribute()))</a>
<a name="ln2026">							fEditor.ForceUpdate();</a>
<a name="ln2027">					} else {</a>
<a name="ln2028">						BMenuBar* bar = Window()-&gt;KeyMenuBar();</a>
<a name="ln2029">						if (bar != NULL) {</a>
<a name="ln2030">							BMenuItem* item = bar-&gt;FindItem(&quot;Attributes&quot;);</a>
<a name="ln2031">							if (item != NULL &amp;&amp; item-&gt;Submenu() != NULL)</a>
<a name="ln2032">								_UpdateAttributesMenu(item-&gt;Submenu());</a>
<a name="ln2033">						}</a>
<a name="ln2034">					}</a>
<a name="ln2035"> </a>
<a name="ln2036">					// There might be a new icon</a>
<a name="ln2037">					if (!strcmp(name, &quot;BEOS:TYPE&quot;)</a>
<a name="ln2038">						|| !strcmp(name, &quot;BEOS:M:STD_ICON&quot;)</a>
<a name="ln2039">						|| !strcmp(name, &quot;BEOS:L:STD_ICON&quot;)</a>
<a name="ln2040">						|| !strcmp(name, &quot;BEOS:ICON&quot;))</a>
<a name="ln2041">						fHeaderView-&gt;UpdateIcon();</a>
<a name="ln2042">					break;</a>
<a name="ln2043">				}</a>
<a name="ln2044">			}</a>
<a name="ln2045">			break;</a>
<a name="ln2046">		}</a>
<a name="ln2047"> </a>
<a name="ln2048">		case B_CLIPBOARD_CHANGED:</a>
<a name="ln2049">			_CheckClipboard();</a>
<a name="ln2050">			break;</a>
<a name="ln2051"> </a>
<a name="ln2052">		case kMsgDataEditorStateChange:</a>
<a name="ln2053">		{</a>
<a name="ln2054">			bool enabled;</a>
<a name="ln2055">			if (message-&gt;FindBool(&quot;can_undo&quot;, &amp;enabled) == B_OK)</a>
<a name="ln2056">				fUndoMenuItem-&gt;SetEnabled(enabled);</a>
<a name="ln2057"> </a>
<a name="ln2058">			if (message-&gt;FindBool(&quot;can_redo&quot;, &amp;enabled) == B_OK)</a>
<a name="ln2059">				fRedoMenuItem-&gt;SetEnabled(enabled);</a>
<a name="ln2060"> </a>
<a name="ln2061">			if (message-&gt;FindBool(&quot;modified&quot;, &amp;enabled) == B_OK)</a>
<a name="ln2062">				fSaveMenuItem-&gt;SetEnabled(enabled);</a>
<a name="ln2063">			break;</a>
<a name="ln2064">		}</a>
<a name="ln2065"> </a>
<a name="ln2066">		default:</a>
<a name="ln2067">			BView::MessageReceived(message);</a>
<a name="ln2068">	}</a>
<a name="ln2069">}</a>
<a name="ln2070"> </a>

</code></pre>
<div class="balloon" rel="1096"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="1858"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="1836"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
