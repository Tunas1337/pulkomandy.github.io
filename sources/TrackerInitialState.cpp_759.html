
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>TrackerInitialState.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">Open Tracker License</a>
<a name="ln3"> </a>
<a name="ln4">Terms and Conditions</a>
<a name="ln5"> </a>
<a name="ln6">Copyright (c) 1991-2000, Be Incorporated. All rights reserved.</a>
<a name="ln7"> </a>
<a name="ln8">Permission is hereby granted, free of charge, to any person obtaining a copy of</a>
<a name="ln9">this software and associated documentation files (the &quot;Software&quot;), to deal in</a>
<a name="ln10">the Software without restriction, including without limitation the rights to</a>
<a name="ln11">use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</a>
<a name="ln12">of the Software, and to permit persons to whom the Software is furnished to do</a>
<a name="ln13">so, subject to the following conditions:</a>
<a name="ln14"> </a>
<a name="ln15">The above copyright notice and this permission notice applies to all licensees</a>
<a name="ln16">and shall be included in all copies or substantial portions of the Software.</a>
<a name="ln17"> </a>
<a name="ln18">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</a>
<a name="ln19">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF TITLE, MERCHANTABILITY,</a>
<a name="ln20">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL</a>
<a name="ln21">BE INCORPORATED BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN</a>
<a name="ln22">AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION</a>
<a name="ln23">WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</a>
<a name="ln24"> </a>
<a name="ln25">Except as contained in this notice, the name of Be Incorporated shall not be</a>
<a name="ln26">used in advertising or otherwise to promote the sale, use or other dealings in</a>
<a name="ln27">this Software without prior written authorization from Be Incorporated.</a>
<a name="ln28"> </a>
<a name="ln29">Tracker(TM), Be(R), BeOS(R), and BeIA(TM) are trademarks or registered trademarks</a>
<a name="ln30">of Be Incorporated in the United States and other countries. Other brand product</a>
<a name="ln31">names are registered trademarks or trademarks of their respective holders.</a>
<a name="ln32">All rights reserved.</a>
<a name="ln33">*/</a>
<a name="ln34"> </a>
<a name="ln35">// ToDo:</a>
<a name="ln36">// add code to initialize a subset of the mime database, including</a>
<a name="ln37">// important sniffer rules</a>
<a name="ln38"> </a>
<a name="ln39"> </a>
<a name="ln40">#include &lt;Alert.h&gt;</a>
<a name="ln41">#include &lt;Catalog.h&gt;</a>
<a name="ln42">#include &lt;Directory.h&gt;</a>
<a name="ln43">#include &lt;InterfaceDefs.h&gt;</a>
<a name="ln44">#include &lt;Locale.h&gt;</a>
<a name="ln45">#include &lt;Message.h&gt;</a>
<a name="ln46">#include &lt;Node.h&gt;</a>
<a name="ln47">#include &lt;Path.h&gt;</a>
<a name="ln48">#include &lt;Screen.h&gt;</a>
<a name="ln49">#include &lt;VolumeRoster.h&gt;</a>
<a name="ln50"> </a>
<a name="ln51">#include &lt;fs_attr.h&gt;</a>
<a name="ln52">#include &lt;fs_index.h&gt;</a>
<a name="ln53"> </a>
<a name="ln54">#include &quot;pr_server.h&quot;</a>
<a name="ln55"> </a>
<a name="ln56">#include &quot;Attributes.h&quot;</a>
<a name="ln57">#include &quot;AttributeStream.h&quot;</a>
<a name="ln58">#include &quot;BackgroundImage.h&quot;</a>
<a name="ln59">#include &quot;Bitmaps.h&quot;</a>
<a name="ln60">#include &quot;ContainerWindow.h&quot;</a>
<a name="ln61">#include &quot;MimeTypes.h&quot;</a>
<a name="ln62">#include &quot;FSUtils.h&quot;</a>
<a name="ln63">#include &quot;QueryContainerWindow.h&quot;</a>
<a name="ln64">#include &quot;Tracker.h&quot;</a>
<a name="ln65">#include &quot;ViewState.h&quot;</a>
<a name="ln66"> </a>
<a name="ln67"> </a>
<a name="ln68">enum {</a>
<a name="ln69">	kForceLargeIcon = 0x1,</a>
<a name="ln70">	kForceMiniIcon = 0x2,</a>
<a name="ln71">	kForceShortDescription = 0x4,</a>
<a name="ln72">	kForceLongDescription = 0x8,</a>
<a name="ln73">	kForcePreferredApp = 0x10</a>
<a name="ln74">};</a>
<a name="ln75"> </a>
<a name="ln76"> </a>
<a name="ln77">static const char* kAttrName = &quot;META:name&quot;;</a>
<a name="ln78">static const char* kAttrCompany = &quot;META:company&quot;;</a>
<a name="ln79">static const char* kAttrAddress = &quot;META:address&quot;;</a>
<a name="ln80">static const char* kAttrCity = &quot;META:city&quot;;</a>
<a name="ln81">static const char* kAttrState = &quot;META:state&quot;;</a>
<a name="ln82">static const char* kAttrZip = &quot;META:zip&quot;;</a>
<a name="ln83">static const char* kAttrCountry = &quot;META:country&quot;;</a>
<a name="ln84">static const char* kAttrHomePhone = &quot;META:hphone&quot;;</a>
<a name="ln85">static const char* kAttrWorkPhone = &quot;META:wphone&quot;;</a>
<a name="ln86">static const char* kAttrFax = &quot;META:fax&quot;;</a>
<a name="ln87">static const char* kAttrEmail = &quot;META:email&quot;;</a>
<a name="ln88">static const char* kAttrURL = &quot;META:url&quot;;</a>
<a name="ln89">static const char* kAttrGroup = &quot;META:group&quot;;</a>
<a name="ln90">static const char* kAttrNickname = &quot;META:nickname&quot;;</a>
<a name="ln91"> </a>
<a name="ln92">static const char* kNetPositiveSignature = &quot;application/x-vnd.Be-NPOS&quot;;</a>
<a name="ln93">static const char* kPeopleSignature = &quot;application/x-vnd.Be-PEPL&quot;;</a>
<a name="ln94"> </a>
<a name="ln95">static const BRect kDefaultFrame(40, 40, 695, 350);</a>
<a name="ln96"> </a>
<a name="ln97"> </a>
<a name="ln98">struct ColumnData</a>
<a name="ln99">{</a>
<a name="ln100">	const char*	title;</a>
<a name="ln101">	float		offset;</a>
<a name="ln102">	float		width;</a>
<a name="ln103">	alignment	align;</a>
<a name="ln104">	const char*	attributeName;</a>
<a name="ln105">	uint32		attrType;</a>
<a name="ln106">	bool		statField;</a>
<a name="ln107">	bool		editable;</a>
<a name="ln108">};</a>
<a name="ln109"> </a>
<a name="ln110"> </a>
<a name="ln111">namespace BPrivate {</a>
<a name="ln112"> </a>
<a name="ln113">class ExtraAttributeLazyInstaller {</a>
<a name="ln114">public:</a>
<a name="ln115">	ExtraAttributeLazyInstaller(const char* type);</a>
<a name="ln116">	~ExtraAttributeLazyInstaller();</a>
<a name="ln117"> </a>
<a name="ln118">	bool AddExtraAttribute(const char* publicName, const char* name,</a>
<a name="ln119">		uint32 type, bool viewable, bool editable, float width,</a>
<a name="ln120">		int32 alignment, bool extra);</a>
<a name="ln121"> </a>
<a name="ln122">	status_t InitCheck() const;</a>
<a name="ln123"> </a>
<a name="ln124">public:</a>
<a name="ln125">	BMimeType fMimeType;</a>
<a name="ln126">	BMessage fExtraAttrs;</a>
<a name="ln127">	bool fDirty;</a>
<a name="ln128">};</a>
<a name="ln129"> </a>
<a name="ln130">}	// namespace BPrivate</a>
<a name="ln131"> </a>
<a name="ln132"> </a>
<a name="ln133">//	#pragma mark - ExtraAttributeLazyInstaller</a>
<a name="ln134"> </a>
<a name="ln135"> </a>
<a name="ln136">ExtraAttributeLazyInstaller::ExtraAttributeLazyInstaller(const char* type)</a>
<a name="ln137">	:</a>
<a name="ln138">	fMimeType(type),</a>
<a name="ln139">	fDirty(false)</a>
<a name="ln140">{</a>
<a name="ln141">	if (fMimeType.InitCheck() != B_OK</a>
<a name="ln142">		|| fMimeType.GetAttrInfo(&amp;fExtraAttrs) != B_OK) {</a>
<a name="ln143">		fExtraAttrs = BMessage();</a>
<a name="ln144">	}</a>
<a name="ln145">}</a>
<a name="ln146"> </a>
<a name="ln147"> </a>
<a name="ln148">ExtraAttributeLazyInstaller::~ExtraAttributeLazyInstaller()</a>
<a name="ln149">{</a>
<a name="ln150">	if (fMimeType.InitCheck() == B_OK &amp;&amp; fDirty</a>
<a name="ln151">		&amp;&amp; fMimeType.SetAttrInfo(&amp;fExtraAttrs) != B_OK) {</a>
<a name="ln152">		fExtraAttrs = BMessage();</a>
<a name="ln153">	}</a>
<a name="ln154">}</a>
<a name="ln155"> </a>
<a name="ln156"> </a>
<a name="ln157">bool</a>
<a name="ln158">ExtraAttributeLazyInstaller::AddExtraAttribute(const char* publicName,</a>
<a name="ln159">	const char* name, uint32 type, bool viewable, bool editable, float width,</a>
<a name="ln160">	int32 alignment, bool extra)</a>
<a name="ln161">{</a>
<a name="ln162">	for (int32 index = 0; ; index++) {</a>
<a name="ln163">		const char* oldPublicName;</a>
<a name="ln164">		if (fExtraAttrs.FindString(&quot;attr:public_name&quot;, index, &amp;oldPublicName)</a>
<a name="ln165">				!= B_OK) {</a>
<a name="ln166">			break;</a>
<a name="ln167">		}</a>
<a name="ln168"> </a>
<a name="ln169">		if (strcmp(oldPublicName, publicName) == 0)</a>
<a name="ln170">			// already got this extra atribute, no work left</a>
<a name="ln171">			return false;</a>
<a name="ln172">	}</a>
<a name="ln173"> </a>
<a name="ln174">	fExtraAttrs.AddString(&quot;attr:public_name&quot;, publicName);</a>
<a name="ln175">	fExtraAttrs.AddString(&quot;attr:name&quot;, name);</a>
<a name="ln176">	fExtraAttrs.AddInt32(&quot;attr:type&quot;, (int32)type);</a>
<a name="ln177">	fExtraAttrs.AddBool(&quot;attr:viewable&quot;, viewable);</a>
<a name="ln178">	fExtraAttrs.AddBool(&quot;attr:editable&quot;, editable);</a>
<a name="ln179">	fExtraAttrs.AddInt32(&quot;attr:width&quot;, (int32)width);</a>
<a name="ln180">	fExtraAttrs.AddInt32(&quot;attr:alignment&quot;, alignment);</a>
<a name="ln181">	fExtraAttrs.AddBool(&quot;attr:extra&quot;, extra);</a>
<a name="ln182"> </a>
<a name="ln183">	fDirty = true;</a>
<a name="ln184">	return true;</a>
<a name="ln185">}</a>
<a name="ln186"> </a>
<a name="ln187"> </a>
<a name="ln188">// #pragma mark - static functions</a>
<a name="ln189"> </a>
<a name="ln190"> </a>
<a name="ln191">static void</a>
<a name="ln192">InstallTemporaryBackgroundImages(BNode* node, BMessage* message)</a>
<a name="ln193">{</a>
<a name="ln194">	ssize_t size = message-&gt;FlattenedSize();</a>
<a name="ln195">	try {</a>
<a name="ln196">		ThrowIfNotSize(size);</a>
<a name="ln197">		char* buffer = new char[(size_t)size];</a>
<a name="ln198">		message-&gt;Flatten(buffer, size);</a>
<a name="ln199">		node-&gt;WriteAttr(kBackgroundImageInfo, B_MESSAGE_TYPE, 0, buffer,</a>
<a name="ln200">			(size_t)size);</a>
<a name="ln201">		delete[] buffer;</a>
<a name="ln202">	} catch (...) {</a>
<a name="ln203">		;</a>
<a name="ln204">	}</a>
<a name="ln205">}</a>
<a name="ln206"> </a>
<a name="ln207"> </a>
<a name="ln208">static void</a>
<a name="ln209">AddTemporaryBackgroundImages(BMessage* message, const char* imagePath,</a>
<a name="ln210">	BackgroundImage::Mode mode, BPoint offset, uint32 workspaces,</a>
<a name="ln211">	bool textWidgetOutlines)</a>
<a name="ln212">{</a>
<a name="ln213">	message-&gt;AddString(kBackgroundImageInfoPath, imagePath);</a>
<a name="ln214">	message-&gt;AddInt32(kBackgroundImageInfoWorkspaces, (int32)workspaces);</a>
<a name="ln215">	message-&gt;AddInt32(kBackgroundImageInfoMode, mode);</a>
<a name="ln216">	message-&gt;AddBool(kBackgroundImageInfoTextOutline, textWidgetOutlines);</a>
<a name="ln217">	message-&gt;AddPoint(kBackgroundImageInfoOffset, offset);</a>
<a name="ln218">}</a>
<a name="ln219"> </a>
<a name="ln220"> </a>
<a name="ln221">static size_t</a>
<a name="ln222">mkColumnsBits(BMallocIO&amp; stream, const ColumnData* src, int32 nelm,</a>
<a name="ln223">	const char* context)</a>
<a name="ln224">{</a>
<a name="ln225">	for (int32 i = 0; i &lt; nelm; i++) {</a>
<a name="ln226">		BColumn c(</a>
<a name="ln227">			B_TRANSLATE_CONTEXT(src[i].title, context),</a>
<a name="ln228">			src[i].offset, src[i].width, src[i].align, src[i].attributeName,</a>
<a name="ln229">			src[i].attrType, src[i].statField, src[i].editable);</a>
<a name="ln230">		c.ArchiveToStream(&amp;stream);</a>
<a name="ln231">	}</a>
<a name="ln232"> </a>
<a name="ln233">	return stream.Position();</a>
<a name="ln234">}</a>
<a name="ln235"> </a>
<a name="ln236"> </a>
<a name="ln237">// #pragma mark - TrackerInitialState</a>
<a name="ln238"> </a>
<a name="ln239"> </a>
<a name="ln240">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln241">#define B_TRANSLATION_CONTEXT &quot;TrackerInitialState&quot;</a>
<a name="ln242"> </a>
<a name="ln243"> </a>
<a name="ln244">bool</a>
<a name="ln245">TTracker::InstallMimeIfNeeded(const char* type, int32 bitsID,</a>
<a name="ln246">	const char* shortDescription, const char* longDescription,</a>
<a name="ln247">	const char* preferredAppSignature, uint32 forceMask)</a>
<a name="ln248">{</a>
<a name="ln249">	// used by InitMimeTypes - checks if a metamime of a given &lt;type&gt; is</a>
<a name="ln250">	// installed and if it has all the specified attributes; if not, the</a>
<a name="ln251">	// whole mime type is installed and all attributes are set; nulls can</a>
<a name="ln252">	// be passed for attributes that don't matter; returns true if anything</a>
<a name="ln253">	// had to be changed</a>
<a name="ln254"> </a>
<a name="ln255">	BBitmap vectorIcon(BRect(0, 0, 31, 31), B_BITMAP_NO_SERVER_LINK,</a>
<a name="ln256">		B_RGBA32);</a>
<a name="ln257">	BBitmap largeIcon(BRect(0, 0, 31, 31), B_BITMAP_NO_SERVER_LINK, B_CMAP8);</a>
<a name="ln258">	BBitmap miniIcon(BRect(0, 0, 15, 15), B_BITMAP_NO_SERVER_LINK, B_CMAP8);</a>
<a name="ln259">	char tmp[B_MIME_TYPE_LENGTH];</a>
<a name="ln260"> </a>
<a name="ln261">	BMimeType mime(type);</a>
<a name="ln262">	bool installed = mime.IsInstalled();</a>
<a name="ln263"> </a>
<a name="ln264">	if (!installed</a>
<a name="ln265">		|| (bitsID &gt;= 0 &amp;&amp; ((forceMask &amp; kForceLargeIcon)</a>
<a name="ln266">			|| mime.GetIcon(&amp;vectorIcon, B_LARGE_ICON) != B_OK))</a>
<a name="ln267">		|| (bitsID &gt;= 0 &amp;&amp; ((forceMask &amp; kForceLargeIcon)</a>
<a name="ln268">			|| mime.GetIcon(&amp;largeIcon, B_LARGE_ICON) != B_OK))</a>
<a name="ln269">		|| (bitsID &gt;= 0 &amp;&amp; ((forceMask &amp; kForceMiniIcon)</a>
<a name="ln270">			|| mime.GetIcon(&amp;miniIcon, B_MINI_ICON) != B_OK))</a>
<a name="ln271">		|| (shortDescription &amp;&amp; ((forceMask &amp; kForceShortDescription)</a>
<a name="ln272">			|| mime.GetShortDescription(tmp) != B_OK))</a>
<a name="ln273">		|| (longDescription &amp;&amp; ((forceMask &amp; kForceLongDescription)</a>
<a name="ln274">			|| mime.GetLongDescription(tmp) != B_OK))</a>
<a name="ln275">		|| (preferredAppSignature &amp;&amp; ((forceMask &amp; kForcePreferredApp)</a>
<a name="ln276">			|| mime.GetPreferredApp(tmp) != B_OK))) {</a>
<a name="ln277"> </a>
<a name="ln278">		if (!installed)</a>
<a name="ln279">			mime.Install();</a>
<a name="ln280"> </a>
<a name="ln281">		if (bitsID &gt;= 0) {</a>
<a name="ln282">			const uint8* iconData;</a>
<a name="ln283">			size_t iconSize;</a>
<a name="ln284">			if (GetTrackerResources()-&gt;</a>
<a name="ln285">					GetIconResource(bitsID, &amp;iconData, &amp;iconSize) == B_OK)</a>
<a name="ln286">				mime.SetIcon(iconData, iconSize);</a>
<a name="ln287"> </a>
<a name="ln288">			if (GetTrackerResources()-&gt;</a>
<a name="ln289">					GetIconResource(bitsID, B_LARGE_ICON, &amp;largeIcon) == B_OK)</a>
<a name="ln290">				mime.SetIcon(&amp;largeIcon, B_LARGE_ICON);</a>
<a name="ln291"> </a>
<a name="ln292">			if (GetTrackerResources()-&gt;</a>
<a name="ln293">					GetIconResource(bitsID, B_MINI_ICON, &amp;miniIcon) == B_OK)</a>
<a name="ln294">				mime.SetIcon(&amp;miniIcon, B_MINI_ICON);</a>
<a name="ln295">		}</a>
<a name="ln296"> </a>
<a name="ln297">		if (shortDescription)</a>
<a name="ln298">			mime.SetShortDescription(shortDescription);</a>
<a name="ln299"> </a>
<a name="ln300">		if (longDescription)</a>
<a name="ln301">			mime.SetLongDescription(longDescription);</a>
<a name="ln302"> </a>
<a name="ln303">		if (preferredAppSignature)</a>
<a name="ln304">			mime.SetPreferredApp(preferredAppSignature);</a>
<a name="ln305"> </a>
<a name="ln306">		return true;</a>
<a name="ln307">	}</a>
<a name="ln308">	return false;</a>
<a name="ln309">}</a>
<a name="ln310"> </a>
<a name="ln311"> </a>
<a name="ln312">void</a>
<a name="ln313">TTracker::InitMimeTypes()</a>
<a name="ln314">{</a>
<a name="ln315">	InstallMimeIfNeeded(B_APP_MIME_TYPE, R_AppIcon, &quot;Be Application&quot;,</a>
<a name="ln316">		&quot;Generic Be application executable.&quot;, kTrackerSignature);</a>
<a name="ln317"> </a>
<a name="ln318">	InstallMimeIfNeeded(B_FILE_MIMETYPE, R_FileIcon,</a>
<a name="ln319">		&quot;Generic file&quot;, &quot;Generic document file.&quot;, kTrackerSignature);</a>
<a name="ln320"> </a>
<a name="ln321">	InstallMimeIfNeeded(B_VOLUME_MIMETYPE, R_HardDiskIcon,</a>
<a name="ln322">		&quot;Be Volume&quot;, &quot;Disk volume.&quot;, kTrackerSignature);</a>
<a name="ln323"> </a>
<a name="ln324">	InstallMimeIfNeeded(B_QUERY_MIMETYPE, R_QueryDirIcon,</a>
<a name="ln325">		&quot;Be Query&quot;, &quot;Query to locate items on disks.&quot;, kTrackerSignature);</a>
<a name="ln326"> </a>
<a name="ln327">	InstallMimeIfNeeded(B_QUERY_TEMPLATE_MIMETYPE, R_QueryTemplateIcon,</a>
<a name="ln328">		&quot;Be Query template&quot;, &quot;&quot;, kTrackerSignature);</a>
<a name="ln329"> </a>
<a name="ln330">	InstallMimeIfNeeded(B_LINK_MIMETYPE, R_BrokenLinkIcon, &quot;Symbolic link&quot;,</a>
<a name="ln331">		&quot;Link to another item in the file system.&quot;, kTrackerSignature);</a>
<a name="ln332"> </a>
<a name="ln333">	InstallMimeIfNeeded(B_ROOT_MIMETYPE, R_RootIcon,</a>
<a name="ln334">		&quot;Be Root&quot;, &quot;File system root.&quot;, kTrackerSignature);</a>
<a name="ln335"> </a>
<a name="ln336">	InstallMimeIfNeeded(B_BOOKMARK_MIMETYPE, R_BookmarkIcon,</a>
<a name="ln337">		&quot;Bookmark&quot;, &quot;Bookmark for a web page.&quot;, kNetPositiveSignature);</a>
<a name="ln338"> </a>
<a name="ln339">	{</a>
<a name="ln340">		// install a couple of extra fields for bookmark</a>
<a name="ln341"> </a>
<a name="ln342">		ExtraAttributeLazyInstaller installer(B_BOOKMARK_MIMETYPE);</a>
<a name="ln343">		installer.AddExtraAttribute(&quot;URL&quot;, &quot;META:url&quot;, B_STRING_TYPE,</a>
<a name="ln344">			true, true, 170, B_ALIGN_LEFT, false);</a>
<a name="ln345">		installer.AddExtraAttribute(&quot;Keywords&quot;, &quot;META:keyw&quot;, B_STRING_TYPE,</a>
<a name="ln346">			true, true, 130, B_ALIGN_LEFT, false);</a>
<a name="ln347">		installer.AddExtraAttribute(&quot;Title&quot;, &quot;META:title&quot;, B_STRING_TYPE,</a>
<a name="ln348">			true, true, 130, B_ALIGN_LEFT, false);</a>
<a name="ln349">	}</a>
<a name="ln350"> </a>
<a name="ln351">	InstallMimeIfNeeded(B_PERSON_MIMETYPE, R_PersonIcon,</a>
<a name="ln352">		&quot;Person&quot;, &quot;Contact information for a person.&quot;, kPeopleSignature);</a>
<a name="ln353"> </a>
<a name="ln354">	{</a>
<a name="ln355">		ExtraAttributeLazyInstaller installer(B_PERSON_MIMETYPE);</a>
<a name="ln356">		installer.AddExtraAttribute(&quot;Contact name&quot;, kAttrName, B_STRING_TYPE,</a>
<a name="ln357">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln358">		installer.AddExtraAttribute(&quot;Company&quot;, kAttrCompany, B_STRING_TYPE,</a>
<a name="ln359">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln360">		installer.AddExtraAttribute(&quot;Address&quot;, kAttrAddress, B_STRING_TYPE,</a>
<a name="ln361">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln362">		installer.AddExtraAttribute(&quot;City&quot;, kAttrCity, B_STRING_TYPE,</a>
<a name="ln363">			true, true, 90, B_ALIGN_LEFT, false);</a>
<a name="ln364">		installer.AddExtraAttribute(&quot;State&quot;, kAttrState, B_STRING_TYPE,</a>
<a name="ln365">			true, true, 50, B_ALIGN_LEFT, false);</a>
<a name="ln366">		installer.AddExtraAttribute(&quot;Zip&quot;, kAttrZip, B_STRING_TYPE,</a>
<a name="ln367">			true, true, 50, B_ALIGN_LEFT, false);</a>
<a name="ln368">		installer.AddExtraAttribute(&quot;Country&quot;, kAttrCountry, B_STRING_TYPE,</a>
<a name="ln369">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln370">		installer.AddExtraAttribute(&quot;E-mail&quot;, kAttrEmail, B_STRING_TYPE,</a>
<a name="ln371">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln372">		installer.AddExtraAttribute(&quot;Home phone&quot;, kAttrHomePhone,</a>
<a name="ln373">			B_STRING_TYPE, true, true, 90, B_ALIGN_LEFT, false);</a>
<a name="ln374">		installer.AddExtraAttribute(&quot;Work phone&quot;, kAttrWorkPhone,</a>
<a name="ln375">			B_STRING_TYPE, true, true, 90, B_ALIGN_LEFT, false);</a>
<a name="ln376">		installer.AddExtraAttribute(&quot;Fax&quot;, kAttrFax, B_STRING_TYPE,</a>
<a name="ln377">			true, true, 90, B_ALIGN_LEFT, false);</a>
<a name="ln378">		installer.AddExtraAttribute(&quot;URL&quot;, kAttrURL, B_STRING_TYPE,</a>
<a name="ln379">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln380">		installer.AddExtraAttribute(&quot;Group&quot;, kAttrGroup, B_STRING_TYPE,</a>
<a name="ln381">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln382">		installer.AddExtraAttribute(&quot;Nickname&quot;, kAttrNickname, B_STRING_TYPE,</a>
<a name="ln383">			true, true, 120, B_ALIGN_LEFT, false);</a>
<a name="ln384">	}</a>
<a name="ln385"> </a>
<a name="ln386">	InstallMimeIfNeeded(B_PRINTER_SPOOL_MIMETYPE, R_SpoolFileIcon,</a>
<a name="ln387">		&quot;Printer spool&quot;, &quot;Printer spool file.&quot;, &quot;application/x-vnd.Be-PRNT&quot;);</a>
<a name="ln388"> </a>
<a name="ln389">	{</a>
<a name="ln390">#if B_BEOS_VERSION_DANO</a>
<a name="ln391">		ExtraAttributeLazyInstaller installer(B_PRINTER_SPOOL_MIMETYPE);</a>
<a name="ln392">		installer.AddExtraAttribute(&quot;Status&quot;, PSRV_SPOOL_ATTR_STATUS,</a>
<a name="ln393">			B_STRING_TYPE, true, false, 60, B_ALIGN_LEFT, false);</a>
<a name="ln394">		installer.AddExtraAttribute(&quot;Page count&quot;, PSRV_SPOOL_ATTR_PAGECOUNT,</a>
<a name="ln395">			B_INT32_TYPE, true, false, 40, B_ALIGN_RIGHT, false);</a>
<a name="ln396">		installer.AddExtraAttribute(&quot;Description&quot;,</a>
<a name="ln397">			PSRV_SPOOL_ATTR_DESCRIPTION, B_STRING_TYPE, true, true, 100,</a>
<a name="ln398">			B_ALIGN_LEFT, false);</a>
<a name="ln399">		installer.AddExtraAttribute(&quot;Printer name&quot;, PSRV_SPOOL_ATTR_PRINTER,</a>
<a name="ln400">			B_STRING_TYPE, true, false, 80, B_ALIGN_LEFT, false);</a>
<a name="ln401">		installer.AddExtraAttribute(&quot;Job creator type&quot;,</a>
<a name="ln402">			PSRV_SPOOL_ATTR_MIMETYPE, B_ASCII_TYPE, true, false, 60,</a>
<a name="ln403">			B_ALIGN_LEFT, false);</a>
<a name="ln404">#else</a>
<a name="ln405">		ExtraAttributeLazyInstaller installer(B_PRINTER_SPOOL_MIMETYPE);</a>
<a name="ln406">		installer.AddExtraAttribute(&quot;Page count&quot;, &quot;_spool/Page Count&quot;,</a>
<a name="ln407">			B_INT32_TYPE, true, false, 40, B_ALIGN_RIGHT, false);</a>
<a name="ln408">		installer.AddExtraAttribute(&quot;Description&quot;, &quot;_spool/Description&quot;,</a>
<a name="ln409">			B_ASCII_TYPE, true, true, 100, B_ALIGN_LEFT, false);</a>
<a name="ln410">		installer.AddExtraAttribute(&quot;Printer name&quot;, &quot;_spool/Printer&quot;,</a>
<a name="ln411">			B_ASCII_TYPE, true, false, 80, B_ALIGN_LEFT, false);</a>
<a name="ln412">		installer.AddExtraAttribute(&quot;Job creator type&quot;, &quot;_spool/MimeType&quot;,</a>
<a name="ln413">			B_ASCII_TYPE, true, false, 60, B_ALIGN_LEFT, false);</a>
<a name="ln414">#endif</a>
<a name="ln415">	}</a>
<a name="ln416"> </a>
<a name="ln417">	InstallMimeIfNeeded(B_PRINTER_MIMETYPE, R_GenericPrinterIcon,</a>
<a name="ln418">		&quot;Printer&quot;, &quot;Printer queue.&quot;, kTrackerSignature);</a>
<a name="ln419">		// application/x-vnd.Be-PRNT</a>
<a name="ln420">		// for now set tracker as a default handler for the printer because we</a>
<a name="ln421">		// just want to open it as a folder</a>
<a name="ln422">#if B_BEOS_VERSION_DANO</a>
<a name="ln423">	{</a>
<a name="ln424">		ExtraAttributeLazyInstaller installer(B_PRINTER_MIMETYPE);</a>
<a name="ln425">		installer.AddExtraAttribute(&quot;Driver&quot;, PSRV_PRINTER_ATTR_DRV_NAME,</a>
<a name="ln426">			B_STRING_TYPE, true, false, 120, B_ALIGN_LEFT, false);</a>
<a name="ln427">		installer.AddExtraAttribute(&quot;Transport&quot;,</a>
<a name="ln428">			PSRV_PRINTER_ATTR_TRANSPORT, B_STRING_TYPE, true, false,</a>
<a name="ln429">			60, B_ALIGN_RIGHT, false);</a>
<a name="ln430">		installer.AddExtraAttribute(&quot;Connection&quot;,</a>
<a name="ln431">			PSRV_PRINTER_ATTR_CNX, B_STRING_TYPE, true, false,</a>
<a name="ln432">			40, B_ALIGN_LEFT, false);</a>
<a name="ln433">		installer.AddExtraAttribute(&quot;Description&quot;,</a>
<a name="ln434">			PSRV_PRINTER_ATTR_COMMENTS, B_STRING_TYPE, true, true,</a>
<a name="ln435">			140, B_ALIGN_LEFT, false);</a>
<a name="ln436">	}</a>
<a name="ln437">#endif</a>
<a name="ln438">}</a>
<a name="ln439"> </a>
<a name="ln440"> </a>
<a name="ln441">void</a>
<a name="ln442">TTracker::InstallIndices()</a>
<a name="ln443">{</a>
<a name="ln444">	BVolumeRoster roster;</a>
<a name="ln445">	BVolume volume;</a>
<a name="ln446"> </a>
<a name="ln447">	roster.Rewind();</a>
<a name="ln448">	while (roster.GetNextVolume(&amp;volume) == B_OK) {</a>
<a name="ln449">		if (volume.IsReadOnly() || !volume.IsPersistent()</a>
<a name="ln450">			|| !volume.KnowsAttr() || !volume.KnowsQuery())</a>
<a name="ln451">			continue;</a>
<a name="ln452">		InstallIndices(volume.Device());</a>
<a name="ln453">	}</a>
<a name="ln454">}</a>
<a name="ln455"> </a>
<a name="ln456"> </a>
<a name="ln457">void</a>
<a name="ln458">TTracker::InstallIndices(dev_t device)</a>
<a name="ln459">{</a>
<a name="ln460">	fs_create_index(device, kAttrQueryLastChange, B_INT32_TYPE, 0);</a>
<a name="ln461">	fs_create_index(device, &quot;_trk/recentQuery&quot;, B_INT32_TYPE, 0);</a>
<a name="ln462">}</a>
<a name="ln463"> </a>
<a name="ln464"> </a>
<a name="ln465">void</a>
<a name="ln466">TTracker::InstallDefaultTemplates()</a>
<a name="ln467">{</a>
<a name="ln468">	// the following templates are in big endian and we rely on the Tracker</a>
<a name="ln469">	// translation support to swap them on little endian machines</a>
<a name="ln470">	//</a>
<a name="ln471">	// in case there is an attribute (B_RECT_TYPE) that gets swapped by the media</a>
<a name="ln472">	// (unzip, file system endianness swapping, etc., the correct endianness for</a>
<a name="ln473">	// the correct machine has to be used here</a>
<a name="ln474"> </a>
<a name="ln475">	static AttributeTemplate sDefaultQueryTemplate[] =</a>
<a name="ln476">		/* /boot/home/config/settings/Tracker/DefaultQueryTemplates/</a>
<a name="ln477">		   application_octet-stream */</a>
<a name="ln478">	{</a>
<a name="ln479">		{</a>
<a name="ln480">			// default frame</a>
<a name="ln481">			kAttrWindowFrame,</a>
<a name="ln482">			B_RECT_TYPE,</a>
<a name="ln483">			16,</a>
<a name="ln484">			(const char*)&amp;kDefaultFrame</a>
<a name="ln485">		},</a>
<a name="ln486">		{</a>
<a name="ln487">			// attr: _trk/viewstate</a>
<a name="ln488">			kAttrViewState_be,</a>
<a name="ln489">			B_RAW_TYPE,</a>
<a name="ln490">			49,</a>
<a name="ln491">			&quot;o^\365R\000\000\000\012Tlst\000\000\000\000\000\000\000\000\000\000&quot;</a>
<a name="ln492">				&quot;\000\000\000\000\000\000\000\000\000\000\357\323\335RCSTR\000\000&quot;</a>
<a name="ln493">				&quot;\000\000\000\000\000\000\000&quot;</a>
<a name="ln494">		},</a>
<a name="ln495">		{</a>
<a name="ln496">			// attr: _trk/columns</a>
<a name="ln497">			kAttrColumns_be,</a>
<a name="ln498">			B_RAW_TYPE,</a>
<a name="ln499">			0,</a>
<a name="ln500">			NULL</a>
<a name="ln501">		}</a>
<a name="ln502">	};</a>
<a name="ln503"> </a>
<a name="ln504">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln505">#define B_TRANSLATION_CONTEXT &quot;Default Query Columns&quot;</a>
<a name="ln506"> </a>
<a name="ln507">	static const ColumnData defaultQueryColumns[] =</a>
<a name="ln508">	{</a>
<a name="ln509">		{ B_TRANSLATE_MARK(&quot;Name&quot;), 40, 145, B_ALIGN_LEFT, &quot;_stat/name&quot;,</a>
<a name="ln510">			B_STRING_TYPE, true, true },</a>
<a name="ln511">		{ B_TRANSLATE_MARK(&quot;Path&quot;), 200, 225, B_ALIGN_LEFT, &quot;_trk/path&quot;,</a>
<a name="ln512">			B_STRING_TYPE, false, false },</a>
<a name="ln513">		{ B_TRANSLATE_MARK(&quot;Size&quot;), 440, 41, B_ALIGN_LEFT, &quot;_stat/size&quot;,</a>
<a name="ln514">			B_OFF_T_TYPE, true, false },</a>
<a name="ln515">		{ B_TRANSLATE_MARK(&quot;Modified&quot;), 496, 138, B_ALIGN_LEFT, &quot;_stat/modified&quot;,</a>
<a name="ln516">			B_TIME_TYPE, true, false }</a>
<a name="ln517">	};</a>
<a name="ln518"> </a>
<a name="ln519"> </a>
<a name="ln520">	static AttributeTemplate sBookmarkQueryTemplate[] =</a>
<a name="ln521">		/* /boot/home/config/settings/Tracker/DefaultQueryTemplates/</a>
<a name="ln522">		   application_x-vnd.Be-bookmark */</a>
<a name="ln523">	{</a>
<a name="ln524">		{</a>
<a name="ln525">			// default frame</a>
<a name="ln526">			kAttrWindowFrame,</a>
<a name="ln527">			B_RECT_TYPE,</a>
<a name="ln528">			16,</a>
<a name="ln529">			(const char*)&amp;kDefaultFrame</a>
<a name="ln530">		},</a>
<a name="ln531">		{</a>
<a name="ln532">			// attr: _trk/viewstate</a>
<a name="ln533">			kAttrViewState_be,</a>
<a name="ln534">			B_RAW_TYPE,</a>
<a name="ln535">			49,</a>
<a name="ln536">			&quot;o^\365R\000\000\000\012Tlst\000\000\000\000\000\000\000\000\000\000&quot;</a>
<a name="ln537">				&quot;\000\000\000\000\000\000\000\000\000\000w\373\175RCSTR\000\000\000&quot;</a>
<a name="ln538">				&quot;\000\000\000\000\000\000&quot;</a>
<a name="ln539">		},</a>
<a name="ln540">		{</a>
<a name="ln541">			// attr: _trk/columns</a>
<a name="ln542">			kAttrColumns_be,</a>
<a name="ln543">			B_RAW_TYPE,</a>
<a name="ln544">			0,</a>
<a name="ln545">			NULL</a>
<a name="ln546">		}</a>
<a name="ln547">	};</a>
<a name="ln548"> </a>
<a name="ln549"> </a>
<a name="ln550">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln551">#define B_TRANSLATION_CONTEXT &quot;Bookmark Query Columns&quot;</a>
<a name="ln552"> </a>
<a name="ln553"> </a>
<a name="ln554">	static const ColumnData bookmarkQueryColumns[] =</a>
<a name="ln555">	{</a>
<a name="ln556">		{ B_TRANSLATE_MARK(&quot;Title&quot;), 40, 171, B_ALIGN_LEFT, &quot;META:title&quot;,</a>
<a name="ln557">			B_STRING_TYPE, false, true },</a>
<a name="ln558">		{ B_TRANSLATE_MARK(&quot;URL&quot;), 226, 287, B_ALIGN_LEFT, kAttrURL,</a>
<a name="ln559">			B_STRING_TYPE, false, true },</a>
<a name="ln560">		{ B_TRANSLATE_MARK(&quot;Keywords&quot;), 528, 130, B_ALIGN_LEFT, &quot;META:keyw&quot;,</a>
<a name="ln561">			B_STRING_TYPE, false, true }</a>
<a name="ln562">	};</a>
<a name="ln563"> </a>
<a name="ln564"> </a>
<a name="ln565">	static AttributeTemplate sPersonQueryTemplate[] =</a>
<a name="ln566">		/* /boot/home/config/settings/Tracker/DefaultQueryTemplates/</a>
<a name="ln567">		   application_x-vnd.Be-bookmark */</a>
<a name="ln568">	{</a>
<a name="ln569">		{</a>
<a name="ln570">			// default frame</a>
<a name="ln571">			kAttrWindowFrame,</a>
<a name="ln572">			B_RECT_TYPE,</a>
<a name="ln573">			16,</a>
<a name="ln574">			(const char*)&amp;kDefaultFrame</a>
<a name="ln575">		},</a>
<a name="ln576">		{</a>
<a name="ln577">			// attr: _trk/viewstate</a>
<a name="ln578">			kAttrViewState_be,</a>
<a name="ln579">			B_RAW_TYPE,</a>
<a name="ln580">			49,</a>
<a name="ln581">			&quot;o^\365R\000\000\000\012Tlst\000\000\000\000\000\000\000\000\000\000&quot;</a>
<a name="ln582">				&quot;\000\000\000\000\000\000\000\000\000\000\357\323\335RCSTR\000\000&quot;</a>
<a name="ln583">				&quot;\000\000\000\000\000\000\000&quot;</a>
<a name="ln584">		},</a>
<a name="ln585">		{</a>
<a name="ln586">			// attr: _trk/columns</a>
<a name="ln587">			kAttrColumns_be,</a>
<a name="ln588">			B_RAW_TYPE,</a>
<a name="ln589">			0,</a>
<a name="ln590">			NULL</a>
<a name="ln591">		},</a>
<a name="ln592">	};</a>
<a name="ln593"> </a>
<a name="ln594"> </a>
<a name="ln595">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln596">#define B_TRANSLATION_CONTEXT &quot;Person Query Columns&quot;</a>
<a name="ln597"> </a>
<a name="ln598"> </a>
<a name="ln599">	static const ColumnData personQueryColumns[] =</a>
<a name="ln600">	{</a>
<a name="ln601">		{ B_TRANSLATE_MARK(&quot;Name&quot;), 40, 115, B_ALIGN_LEFT, &quot;_stat/name&quot;,</a>
<a name="ln602">			B_STRING_TYPE, true, true },</a>
<a name="ln603">		{ B_TRANSLATE_MARK(&quot;Work Phone&quot;), 170, 90, B_ALIGN_LEFT, kAttrWorkPhone,</a>
<a name="ln604">			B_STRING_TYPE, false, true },</a>
<a name="ln605">		{ B_TRANSLATE_MARK(&quot;E-mail&quot;), 275, 93, B_ALIGN_LEFT, kAttrEmail,</a>
<a name="ln606">			B_STRING_TYPE, false, true },</a>
<a name="ln607">		{ B_TRANSLATE_MARK(&quot;Company&quot;), 383, 120, B_ALIGN_LEFT, kAttrCompany,</a>
<a name="ln608">			B_STRING_TYPE, false, true }</a>
<a name="ln609">	};</a>
<a name="ln610"> </a>
<a name="ln611"> </a>
<a name="ln612">	static AttributeTemplate sEmailQueryTemplate[] =</a>
<a name="ln613">		/* /boot/home/config/settings/Tracker/DefaultQueryTemplates/</a>
<a name="ln614">		   text_x-email */</a>
<a name="ln615">	{</a>
<a name="ln616">		{</a>
<a name="ln617">			// default frame</a>
<a name="ln618">			kAttrWindowFrame,</a>
<a name="ln619">			B_RECT_TYPE,</a>
<a name="ln620">			16,</a>
<a name="ln621">			(const char*)&amp;kDefaultFrame</a>
<a name="ln622">		},</a>
<a name="ln623">		{</a>
<a name="ln624">			// attr: _trk/viewstate</a>
<a name="ln625">			kAttrViewState_be,</a>
<a name="ln626">			B_RAW_TYPE,</a>
<a name="ln627">			49,</a>
<a name="ln628">			&quot;o^\365R\000\000\000\012Tlst\000\000\000\000\000\000\000\000\000\000&quot;</a>
<a name="ln629">				&quot;\000\000\000\000\000\000\000\000\000\000\366_\377ETIME\000\000\000&quot;</a>
<a name="ln630">				&quot;\000\000\000\000\000\000&quot;</a>
<a name="ln631">		},</a>
<a name="ln632">		{</a>
<a name="ln633">			// attr: _trk/columns</a>
<a name="ln634">			kAttrColumns_be,</a>
<a name="ln635">			B_RAW_TYPE,</a>
<a name="ln636">			0,</a>
<a name="ln637">			NULL</a>
<a name="ln638">		},</a>
<a name="ln639">	};</a>
<a name="ln640"> </a>
<a name="ln641"> </a>
<a name="ln642">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln643">#define B_TRANSLATION_CONTEXT &quot;Email Query Columns&quot;</a>
<a name="ln644"> </a>
<a name="ln645"> </a>
<a name="ln646">	static const ColumnData emailQueryColumns[] =</a>
<a name="ln647">	{</a>
<a name="ln648">		{ B_TRANSLATE_MARK(&quot;Subject&quot;), 40, 110, B_ALIGN_LEFT, &quot;MAIL:subject&quot;,</a>
<a name="ln649">			B_STRING_TYPE, false, false },</a>
<a name="ln650">		{ B_TRANSLATE_MARK(&quot;From&quot;), 165, 153, B_ALIGN_LEFT, &quot;MAIL:from&quot;,</a>
<a name="ln651">			B_STRING_TYPE, false, false },</a>
<a name="ln652">		{ B_TRANSLATE_MARK(&quot;When&quot;), 333, 120, B_ALIGN_LEFT, &quot;MAIL:when&quot;,</a>
<a name="ln653">			B_STRING_TYPE, false, false },</a>
<a name="ln654">		{ B_TRANSLATE_MARK(&quot;Status&quot;), 468, 50, B_ALIGN_RIGHT, &quot;MAIL:status&quot;,</a>
<a name="ln655">			B_STRING_TYPE, false, true }</a>
<a name="ln656">	};</a>
<a name="ln657"> </a>
<a name="ln658"> </a>
<a name="ln659">	BNode node;</a>
<a name="ln660">	BString query(kQueryTemplates);</a>
<a name="ln661">	query += &quot;/application_octet-stream&quot;;</a>
<a name="ln662"> </a>
<a name="ln663">	if (!BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln664">			&amp;node, false)) {</a>
<a name="ln665">		if (BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln666">				&amp;node, true)) {</a>
<a name="ln667">			BMallocIO stream;</a>
<a name="ln668">			size_t n = mkColumnsBits(stream,</a>
<a name="ln669">					defaultQueryColumns, 4, &quot;Default Query Columns&quot;);</a>
<a name="ln670">			sDefaultQueryTemplate[2].fSize = n;</a>
<a name="ln671">			sDefaultQueryTemplate[2].fBits = (const char*)stream.Buffer();</a>
<a name="ln672"> </a>
<a name="ln673">			AttributeStreamFileNode fileNode(&amp;node);</a>
<a name="ln674">			AttributeStreamTemplateNode tmp(sDefaultQueryTemplate, 3);</a>
<a name="ln675">			fileNode &lt;&lt; tmp;</a>
<a name="ln676">		}</a>
<a name="ln677">	}</a>
<a name="ln678"> </a>
<a name="ln679">	(query = kQueryTemplates) += &quot;/application_x-vnd.Be-bookmark&quot;;</a>
<a name="ln680">	if (!BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln681">			&amp;node, false)) {</a>
<a name="ln682">		if (BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln683">				&amp;node, true)) {</a>
<a name="ln684">			BMallocIO stream;</a>
<a name="ln685">			size_t n = mkColumnsBits(stream,</a>
<a name="ln686">				bookmarkQueryColumns, 3, &quot;Bookmark Query Columns&quot;);</a>
<a name="ln687">			sBookmarkQueryTemplate[2].fSize = n;</a>
<a name="ln688">			sBookmarkQueryTemplate[2].fBits = (const char*)stream.Buffer();</a>
<a name="ln689"> </a>
<a name="ln690">			AttributeStreamFileNode fileNode(&amp;node);</a>
<a name="ln691">			AttributeStreamTemplateNode tmp(sBookmarkQueryTemplate, 3);</a>
<a name="ln692">			fileNode &lt;&lt; tmp;</a>
<a name="ln693">		}</a>
<a name="ln694">	}</a>
<a name="ln695"> </a>
<a name="ln696">	(query = kQueryTemplates) += &quot;/application_x-person&quot;;</a>
<a name="ln697">	if (!BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln698">			&amp;node, false)) {</a>
<a name="ln699">		if (BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln700">				&amp;node, true)) {</a>
<a name="ln701">			BMallocIO stream;</a>
<a name="ln702">			size_t n = mkColumnsBits(stream,</a>
<a name="ln703">				personQueryColumns, 4, &quot;Person Query Columns&quot;);</a>
<a name="ln704">			sPersonQueryTemplate[2].fSize = n;</a>
<a name="ln705">			sPersonQueryTemplate[2].fBits = (const char*)stream.Buffer();</a>
<a name="ln706"> </a>
<a name="ln707">			AttributeStreamFileNode fileNode(&amp;node);</a>
<a name="ln708">			AttributeStreamTemplateNode tmp(sPersonQueryTemplate, 3);</a>
<a name="ln709">			fileNode &lt;&lt; tmp;</a>
<a name="ln710">		}</a>
<a name="ln711">	}</a>
<a name="ln712"> </a>
<a name="ln713">	(query = kQueryTemplates) += &quot;/text_x-email&quot;;</a>
<a name="ln714">	if (!BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln715">			&amp;node, false)) {</a>
<a name="ln716">		if (BContainerWindow::DefaultStateSourceNode(query.String(),</a>
<a name="ln717">				&amp;node, true)) {</a>
<a name="ln718">			BMallocIO stream;</a>
<a name="ln719">			size_t n = mkColumnsBits(stream,</a>
<a name="ln720">				emailQueryColumns, 4, &quot;Email Query Columns&quot;);</a>
<a name="ln721">			sEmailQueryTemplate[2].fSize = n;</a>
<a name="ln722">			sEmailQueryTemplate[2].fBits = (const char*)stream.Buffer();</a>
<a name="ln723"> </a>
<a name="ln724">			AttributeStreamFileNode fileNode(&amp;node);</a>
<a name="ln725">			AttributeStreamTemplateNode tmp(sEmailQueryTemplate, 3);</a>
<a name="ln726">			fileNode &lt;&lt; tmp;</a>
<a name="ln727">		}</a>
<a name="ln728">	}</a>
<a name="ln729">}</a>
<a name="ln730"> </a>
<a name="ln731"> </a>
<a name="ln732">void</a>
<a name="ln733">TTracker::InstallTemporaryBackgroundImages()</a>
<a name="ln734">{</a>
<a name="ln735">	// make the large Haiku Logo the default background</a>
<a name="ln736"> </a>
<a name="ln737">	BPath path;</a>
<a name="ln738">	status_t status = find_directory(B_SYSTEM_DATA_DIRECTORY, &amp;path);</a>
<a name="ln739">	if (status &lt; B_OK) {</a>
<a name="ln740">		// TODO: this error shouldn't be shown to the regular user</a>
<a name="ln741">		BString errorMessage(B_TRANSLATE(&quot;At %func \nfind_directory() &quot;</a>
<a name="ln742">			&quot;failed. \nReason: %error&quot;));</a>
<a name="ln743">		errorMessage.ReplaceFirst(&quot;%func&quot;, __PRETTY_FUNCTION__);</a>
<a name="ln744">		errorMessage.ReplaceFirst(&quot;%error&quot;, strerror(status));</a>
<a name="ln745">		BAlert* alert = new BAlert(&quot;AlertError&quot;, errorMessage.String(),</a>
<a name="ln746">			B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln747">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln748">		alert-&gt;Go();</a>
<a name="ln749">		return;</a>
<a name="ln750">	}</a>
<a name="ln751">	path.Append(&quot;artwork&quot;);</a>
<a name="ln752"> </a>
<a name="ln753">	BString defaultBackgroundImage(&quot;/HAIKU logo - white on blue - big.png&quot;);</a>
<a name="ln754"> </a>
<a name="ln755">	BDirectory dir;</a>
<a name="ln756">	if (FSGetBootDeskDir(&amp;dir) == B_OK) {</a>
<a name="ln757">		// install a default background if there is no background defined yet</a>
<a name="ln758">		attr_info info;</a>
<a name="ln759">		if (dir.GetAttrInfo(kBackgroundImageInfo, &amp;info) != B_OK) {</a>
<a name="ln760">			BScreen screen(B_MAIN_SCREEN_ID);</a>
<a name="ln761">			BPoint logoPos;</a>
<a name="ln762">			logoPos.x</a>
<a name="ln763">				= floorf((screen.Frame().Width() - 605) * (sqrtf(5) - 1) / 2);</a>
<a name="ln764">			logoPos.y = floorf((screen.Frame().Height() - 190) * 0.9);</a>
<a name="ln765">			BMessage message;</a>
<a name="ln766">			AddTemporaryBackgroundImages(&amp;message,</a>
<a name="ln767">				(BString(path.Path()) &lt;&lt; defaultBackgroundImage).String(),</a>
<a name="ln768">				BackgroundImage::kAtOffset, logoPos, 0xffffffff, false);</a>
<a name="ln769">			::InstallTemporaryBackgroundImages(&amp;dir, &amp;message);</a>
<a name="ln770">		}</a>
<a name="ln771">	}</a>
<a name="ln772">}</a>

</code></pre>
<div class="balloon" rel="749"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
