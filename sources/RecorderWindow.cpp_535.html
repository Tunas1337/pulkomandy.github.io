
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>RecorderWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2014, Dario Casalinuovo. All rights reserved.</a>
<a name="ln3"> * Copyright 2005, Jérôme Duval. All rights reserved.</a>
<a name="ln4"> * Distributed under the terms of the MIT License.</a>
<a name="ln5"> *</a>
<a name="ln6"> * Inspired by SoundCapture from Be newsletter (Media Kit Basics:</a>
<a name="ln7"> *	Consumers and Producers)</a>
<a name="ln8"> */</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;Application.h&gt;</a>
<a name="ln11">#include &lt;Alert.h&gt;</a>
<a name="ln12">#include &lt;Debug.h&gt;</a>
<a name="ln13">#include &lt;Screen.h&gt;</a>
<a name="ln14">#include &lt;Button.h&gt;</a>
<a name="ln15">#include &lt;CheckBox.h&gt;</a>
<a name="ln16">#include &lt;TextControl.h&gt;</a>
<a name="ln17">#include &lt;MenuField.h&gt;</a>
<a name="ln18">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln19">#include &lt;MenuItem.h&gt;</a>
<a name="ln20">#include &lt;Box.h&gt;</a>
<a name="ln21">#include &lt;ScrollView.h&gt;</a>
<a name="ln22">#include &lt;Beep.h&gt;</a>
<a name="ln23">#include &lt;StringView.h&gt;</a>
<a name="ln24">#include &lt;String.h&gt;</a>
<a name="ln25">#include &lt;Slider.h&gt;</a>
<a name="ln26">#include &lt;Message.h&gt;</a>
<a name="ln27"> </a>
<a name="ln28">#include &lt;Path.h&gt;</a>
<a name="ln29">#include &lt;FindDirectory.h&gt;</a>
<a name="ln30">#include &lt;MediaAddOn.h&gt;</a>
<a name="ln31"> </a>
<a name="ln32">#include &lt;SoundPlayer.h&gt;</a>
<a name="ln33"> </a>
<a name="ln34">#include &lt;assert.h&gt;</a>
<a name="ln35">#include &lt;stdio.h&gt;</a>
<a name="ln36">#include &lt;strings.h&gt;</a>
<a name="ln37">#include &lt;stdlib.h&gt;</a>
<a name="ln38">#include &lt;ctype.h&gt;</a>
<a name="ln39">#include &lt;unistd.h&gt;</a>
<a name="ln40">#include &lt;fcntl.h&gt;</a>
<a name="ln41"> </a>
<a name="ln42">#include &lt;MediaRoster.h&gt;</a>
<a name="ln43">#include &lt;TimeSource.h&gt;</a>
<a name="ln44">#include &lt;NodeInfo.h&gt;</a>
<a name="ln45"> </a>
<a name="ln46">#include &quot;RecorderWindow.h&quot;</a>
<a name="ln47">#include &quot;FileUtils.h&quot;</a>
<a name="ln48"> </a>
<a name="ln49">#if ! NDEBUG</a>
<a name="ln50">#define FPRINTF(args) fprintf args</a>
<a name="ln51">#else</a>
<a name="ln52">#define FPRINTF(args)</a>
<a name="ln53">#endif</a>
<a name="ln54"> </a>
<a name="ln55">#define DEATH FPRINTF</a>
<a name="ln56">#define CONNECT FPRINTF</a>
<a name="ln57">#define WINDOW FPRINTF</a>
<a name="ln58"> </a>
<a name="ln59">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln60">#define B_TRANSLATION_CONTEXT &quot;RecorderWindow&quot;</a>
<a name="ln61"> </a>
<a name="ln62"> </a>
<a name="ln63">// default window positioning</a>
<a name="ln64">static const float MIN_WIDTH = 400.0f;</a>
<a name="ln65">static const float MIN_HEIGHT = 175.0f;</a>
<a name="ln66">static const float XPOS = 100.0f;</a>
<a name="ln67">static const float YPOS = 200.0f;</a>
<a name="ln68"> </a>
<a name="ln69">#define FOURCC(a,b,c,d)	((((uint32)(d)) &lt;&lt; 24) | (((uint32)(c)) &lt;&lt; 16) \</a>
<a name="ln70">	| (((uint32)(b)) &lt;&lt; 8) | ((uint32)(a)))</a>
<a name="ln71"> </a>
<a name="ln72">struct riff_struct</a>
<a name="ln73">{</a>
<a name="ln74">	uint32 riff_id; // 'RIFF'</a>
<a name="ln75">	uint32 len;</a>
<a name="ln76">	uint32 wave_id;	// 'WAVE'</a>
<a name="ln77">};</a>
<a name="ln78"> </a>
<a name="ln79">struct chunk_struct</a>
<a name="ln80">{</a>
<a name="ln81">	uint32 fourcc;</a>
<a name="ln82">	uint32 len;</a>
<a name="ln83">};</a>
<a name="ln84"> </a>
<a name="ln85">struct format_struct</a>
<a name="ln86">{</a>
<a name="ln87">	uint16 format_tag;</a>
<a name="ln88">	uint16 channels;</a>
<a name="ln89">	uint32 samples_per_sec;</a>
<a name="ln90">	uint32 avg_bytes_per_sec;</a>
<a name="ln91">	uint16 block_align;</a>
<a name="ln92">	uint16 bits_per_sample;</a>
<a name="ln93">};</a>
<a name="ln94"> </a>
<a name="ln95"> </a>
<a name="ln96">struct wave_struct</a>
<a name="ln97">{</a>
<a name="ln98">	struct riff_struct riff;</a>
<a name="ln99">	struct chunk_struct format_chunk;</a>
<a name="ln100">	struct format_struct format;</a>
<a name="ln101">	struct chunk_struct data_chunk;</a>
<a name="ln102">};</a>
<a name="ln103"> </a>
<a name="ln104"> </a>
<a name="ln105">RecorderWindow::RecorderWindow()</a>
<a name="ln106">	:</a>
<a name="ln107">	BWindow(BRect(XPOS, YPOS, XPOS + MIN_WIDTH, YPOS + MIN_HEIGHT),</a>
<a name="ln108">		B_TRANSLATE_SYSTEM_NAME(&quot;SoundRecorder&quot;), B_TITLED_WINDOW,</a>
<a name="ln109">		B_ASYNCHRONOUS_CONTROLS | B_NOT_V_RESIZABLE | B_NOT_ZOOMABLE),</a>
<a name="ln110">	fPlayer(NULL),</a>
<a name="ln111">	fSoundList(NULL),</a>
<a name="ln112">	fPlayFile(NULL),</a>
<a name="ln113">	fPlayTrack(NULL),</a>
<a name="ln114">	fPlayFrames(0),</a>
<a name="ln115">	fLooping(false),</a>
<a name="ln116">	fSavePanel(NULL),</a>
<a name="ln117">	fInitCheck(B_OK)</a>
<a name="ln118">{</a>
<a name="ln119">	fRoster = NULL;</a>
<a name="ln120">	fRecordButton = NULL;</a>
<a name="ln121">	fPlayButton = NULL;</a>
<a name="ln122">	fStopButton = NULL;</a>
<a name="ln123">	fSaveButton = NULL;</a>
<a name="ln124">	fLoopButton = NULL;</a>
<a name="ln125">	fInputField = NULL;</a>
<a name="ln126">	fRecorder = NULL;</a>
<a name="ln127">	fRecording = false;</a>
<a name="ln128">	fExternalConnection = false;</a>
<a name="ln129">	fTempCount = -1;</a>
<a name="ln130">	fButtonState = btnPaused;</a>
<a name="ln131"> </a>
<a name="ln132">	CalcSizes(MIN_WIDTH, MIN_HEIGHT);</a>
<a name="ln133"> </a>
<a name="ln134">	fInitCheck = InitWindow();</a>
<a name="ln135">	if (fInitCheck != B_OK) {</a>
<a name="ln136">		if (fInitCheck == B_NAME_NOT_FOUND)</a>
<a name="ln137">			ErrorAlert(B_TRANSLATE(&quot;Cannot find default audio hardware&quot;),</a>
<a name="ln138">				fInitCheck);</a>
<a name="ln139">		else</a>
<a name="ln140">			ErrorAlert(B_TRANSLATE(&quot;Cannot connect to media server&quot;),</a>
<a name="ln141">				fInitCheck);</a>
<a name="ln142">		PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln143">	} else</a>
<a name="ln144">		Show();</a>
<a name="ln145">}</a>
<a name="ln146"> </a>
<a name="ln147"> </a>
<a name="ln148">RecorderWindow::~RecorderWindow()</a>
<a name="ln149">{</a>
<a name="ln150">	//  The MediaRecorder have to be deleted, the dtor</a>
<a name="ln151">	//  disconnect it from the media_kit.</a>
<a name="ln152">	delete fRecorder;</a>
<a name="ln153"> </a>
<a name="ln154">	delete fPlayer;</a>
<a name="ln155"> </a>
<a name="ln156">	if (fPlayTrack &amp;&amp; fPlayFile)</a>
<a name="ln157">		fPlayFile-&gt;ReleaseTrack(fPlayTrack);</a>
<a name="ln158"> </a>
<a name="ln159">	if (fPlayFile)</a>
<a name="ln160">		delete fPlayFile;</a>
<a name="ln161">	fPlayTrack = NULL;</a>
<a name="ln162">	fPlayFile = NULL;</a>
<a name="ln163"> </a>
<a name="ln164">	//	Clean up items in list view.</a>
<a name="ln165">	if (fSoundList) {</a>
<a name="ln166">		fSoundList-&gt;DeselectAll();</a>
<a name="ln167">		for (int i = 0; i &lt; fSoundList-&gt;CountItems(); i++) {</a>
<a name="ln168">			WINDOW((stderr, &quot;clean up item %d\n&quot;, i+1));</a>
<a name="ln169">			SoundListItem* item = dynamic_cast&lt;SoundListItem *&gt;(fSoundList-&gt;ItemAt(i));</a>
<a name="ln170">			if (item) {</a>
<a name="ln171">				if (item-&gt;IsTemp())</a>
<a name="ln172">					item-&gt;Entry().Remove();	//	delete temp file</a>
<a name="ln173">				delete item;</a>
<a name="ln174">			}</a>
<a name="ln175">		}</a>
<a name="ln176">		fSoundList-&gt;MakeEmpty();</a>
<a name="ln177">	}</a>
<a name="ln178">	//	Clean up currently recording file, if any.</a>
<a name="ln179">	fRecEntry.Remove();</a>
<a name="ln180">	fRecEntry.Unset();</a>
<a name="ln181"> </a>
<a name="ln182">	delete fSavePanel;</a>
<a name="ln183">}</a>
<a name="ln184"> </a>
<a name="ln185"> </a>
<a name="ln186">status_t</a>
<a name="ln187">RecorderWindow::InitCheck()</a>
<a name="ln188">{</a>
<a name="ln189">	return fInitCheck;</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192"> </a>
<a name="ln193">void</a>
<a name="ln194">RecorderWindow::CalcSizes(float min_width, float min_height)</a>
<a name="ln195">{</a>
<a name="ln196">	//	Set up size limits based on new screen size</a>
<a name="ln197">	BScreen screen(this);</a>
<a name="ln198">	BRect rect = screen.Frame();</a>
<a name="ln199">	float width = rect.Width() - 12;</a>
<a name="ln200">	SetSizeLimits(min_width, width, min_height, rect.Height() - 24);</a>
<a name="ln201"> </a>
<a name="ln202">	//	Don't zoom to cover all of screen; user can resize last bit if necessary.</a>
<a name="ln203">	//	This leaves other windows visible.</a>
<a name="ln204">	if (width &gt; 640)</a>
<a name="ln205">		width = 640 + (width - 640) / 2;</a>
<a name="ln206">	SetZoomLimits(width, rect.Height() - 24);</a>
<a name="ln207">}</a>
<a name="ln208"> </a>
<a name="ln209"> </a>
<a name="ln210">status_t</a>
<a name="ln211">RecorderWindow::InitWindow()</a>
<a name="ln212">{</a>
<a name="ln213">	BPopUpMenu * popup = 0;</a>
<a name="ln214">	status_t error;</a>
<a name="ln215"> </a>
<a name="ln216">	try {</a>
<a name="ln217">		//	Find temp directory for recorded sounds.</a>
<a name="ln218">		BPath path;</a>
<a name="ln219">		if (!(error = find_directory(B_SYSTEM_TEMP_DIRECTORY, &amp;path)))</a>
<a name="ln220">			error = fTempDir.SetTo(path.Path());</a>
<a name="ln221">		if (error &lt; 0)</a>
<a name="ln222">			goto bad_mojo;</a>
<a name="ln223"> </a>
<a name="ln224">		//	Make sure the media roster is there (which means the server is there).</a>
<a name="ln225">		fRoster = BMediaRoster::Roster(&amp;error);</a>
<a name="ln226">		if (!fRoster)</a>
<a name="ln227">			goto bad_mojo;</a>
<a name="ln228"> </a>
<a name="ln229">		error = fRoster-&gt;GetAudioInput(&amp;fAudioInputNode);</a>
<a name="ln230">		if (error &lt; B_OK) //	there's no input?</a>
<a name="ln231">			goto bad_mojo;</a>
<a name="ln232"> </a>
<a name="ln233">		error = fRoster-&gt;GetAudioMixer(&amp;fAudioMixerNode);</a>
<a name="ln234">		if (error &lt; B_OK) //	there's no mixer?</a>
<a name="ln235">			goto bad_mojo;</a>
<a name="ln236"> </a>
<a name="ln237">		fRecorder = new BMediaRecorder(&quot;Sound Recorder&quot;,</a>
<a name="ln238">			B_MEDIA_RAW_AUDIO);</a>
<a name="ln239"> </a>
<a name="ln240">		if (fRecorder-&gt;InitCheck() &lt; B_OK)</a>
<a name="ln241">			goto bad_mojo;</a>
<a name="ln242"> </a>
<a name="ln243">		// Set the node to accept only audio data</a>
<a name="ln244">		media_format output_format;</a>
<a name="ln245">		output_format.type = B_MEDIA_RAW_AUDIO;</a>
<a name="ln246">		output_format.u.raw_audio = media_raw_audio_format::wildcard;</a>
<a name="ln247">		fRecorder-&gt;SetAcceptedFormat(output_format);</a>
<a name="ln248"> </a>
<a name="ln249">		//	Create the window header with controls</a>
<a name="ln250">		BRect r(Bounds());</a>
<a name="ln251">		r.bottom = r.top + 175;</a>
<a name="ln252">		BBox *background = new BBox(r, &quot;_background&quot;,</a>
<a name="ln253">			B_FOLLOW_LEFT_RIGHT	| B_FOLLOW_TOP, B_WILL_DRAW</a>
<a name="ln254">			| B_FRAME_EVENTS | B_NAVIGABLE_JUMP, B_NO_BORDER);</a>
<a name="ln255"> </a>
<a name="ln256">		AddChild(background);</a>
<a name="ln257"> </a>
<a name="ln258">		r = background-&gt;Bounds();</a>
<a name="ln259">		r.left = 0;</a>
<a name="ln260">		r.right = r.left + 38;</a>
<a name="ln261">		r.bottom = r.top + 104;</a>
<a name="ln262">		fVUView = new VUView(r, B_FOLLOW_LEFT|B_FOLLOW_TOP);</a>
<a name="ln263">		background-&gt;AddChild(fVUView);</a>
<a name="ln264"> </a>
<a name="ln265">		r = background-&gt;Bounds();</a>
<a name="ln266">		r.left = r.left + 40;</a>
<a name="ln267">		r.bottom = r.top + 104;</a>
<a name="ln268">		fScopeView = new ScopeView(r, B_FOLLOW_LEFT_RIGHT|B_FOLLOW_TOP);</a>
<a name="ln269">		background-&gt;AddChild(fScopeView);</a>
<a name="ln270"> </a>
<a name="ln271">		r = background-&gt;Bounds();</a>
<a name="ln272">		r.left = 2;</a>
<a name="ln273">		r.right -= 26;</a>
<a name="ln274">		r.top = 115;</a>
<a name="ln275">		r.bottom = r.top + 30;</a>
<a name="ln276">		fTrackSlider = new TrackSlider(r, &quot;trackSlider&quot;, new BMessage(POSITION_CHANGED),</a>
<a name="ln277">			B_FOLLOW_LEFT_RIGHT | B_FOLLOW_TOP);</a>
<a name="ln278">		background-&gt;AddChild(fTrackSlider);</a>
<a name="ln279"> </a>
<a name="ln280">		BRect buttonRect;</a>
<a name="ln281"> </a>
<a name="ln282">		//	Button for rewinding</a>
<a name="ln283">		buttonRect = BRect(BPoint(0,0), kSkipButtonSize);</a>
<a name="ln284">		buttonRect.OffsetTo(background-&gt;Bounds().LeftBottom() - BPoint(-7, 25));</a>
<a name="ln285">		fRewindButton = new TransportButton(buttonRect, B_TRANSLATE(&quot;Rewind&quot;),</a>
<a name="ln286">			kSkipBackBitmapBits, kPressedSkipBackBitmapBits,</a>
<a name="ln287">			kDisabledSkipBackBitmapBits, new BMessage(REWIND));</a>
<a name="ln288">		background-&gt;AddChild(fRewindButton);</a>
<a name="ln289"> </a>
<a name="ln290">		//	Button for stopping recording or playback</a>
<a name="ln291">		buttonRect = BRect(BPoint(0,0), kStopButtonSize);</a>
<a name="ln292">		buttonRect.OffsetTo(background-&gt;Bounds().LeftBottom() - BPoint(-48, 25));</a>
<a name="ln293">		fStopButton = new TransportButton(buttonRect, B_TRANSLATE(&quot;Stop&quot;),</a>
<a name="ln294">			kStopButtonBitmapBits, kPressedStopButtonBitmapBits,</a>
<a name="ln295">			kDisabledStopButtonBitmapBits, new BMessage(STOP));</a>
<a name="ln296">		background-&gt;AddChild(fStopButton);</a>
<a name="ln297"> </a>
<a name="ln298">		//	Button for starting playback of selected sound</a>
<a name="ln299">		BRect playRect(BPoint(0,0), kPlayButtonSize);</a>
<a name="ln300">		playRect.OffsetTo(background-&gt;Bounds().LeftBottom() - BPoint(-82, 25));</a>
<a name="ln301">		fPlayButton = new PlayPauseButton(playRect, B_TRANSLATE(&quot;Play&quot;),</a>
<a name="ln302">			new BMessage(PLAY), new BMessage(PLAY_PERIOD), ' ', 0);</a>
<a name="ln303">		background-&gt;AddChild(fPlayButton);</a>
<a name="ln304"> </a>
<a name="ln305">		//	Button for forwarding</a>
<a name="ln306">		buttonRect = BRect(BPoint(0,0), kSkipButtonSize);</a>
<a name="ln307">		buttonRect.OffsetTo(background-&gt;Bounds().LeftBottom() - BPoint(-133, 25));</a>
<a name="ln308">		fForwardButton = new TransportButton(buttonRect, B_TRANSLATE(&quot;Forward&quot;),</a>
<a name="ln309">			kSkipForwardBitmapBits, kPressedSkipForwardBitmapBits,</a>
<a name="ln310">			kDisabledSkipForwardBitmapBits, new BMessage(FORWARD));</a>
<a name="ln311">		background-&gt;AddChild(fForwardButton);</a>
<a name="ln312"> </a>
<a name="ln313">		//	Button to start recording (or waiting for sound)</a>
<a name="ln314">		buttonRect = BRect(BPoint(0,0), kRecordButtonSize);</a>
<a name="ln315">		buttonRect.OffsetTo(background-&gt;Bounds().LeftBottom() - BPoint(-174, 25));</a>
<a name="ln316">		fRecordButton = new RecordButton(buttonRect, B_TRANSLATE(&quot;Record&quot;),</a>
<a name="ln317">			new BMessage(RECORD), new BMessage(RECORD_PERIOD));</a>
<a name="ln318">		background-&gt;AddChild(fRecordButton);</a>
<a name="ln319"> </a>
<a name="ln320">		//	Button for saving selected sound</a>
<a name="ln321">		buttonRect = BRect(BPoint(0,0), kDiskButtonSize);</a>
<a name="ln322">		buttonRect.OffsetTo(background-&gt;Bounds().LeftBottom() - BPoint(-250, 21));</a>
<a name="ln323">		fSaveButton = new TransportButton(buttonRect, B_TRANSLATE(&quot;Save&quot;),</a>
<a name="ln324">			kDiskButtonBitmapsBits, kPressedDiskButtonBitmapsBits,</a>
<a name="ln325">			kDisabledDiskButtonBitmapsBits, new BMessage(SAVE));</a>
<a name="ln326">		fSaveButton-&gt;SetResizingMode(B_FOLLOW_RIGHT | B_FOLLOW_TOP);</a>
<a name="ln327">		background-&gt;AddChild(fSaveButton);</a>
<a name="ln328"> </a>
<a name="ln329">		//	Button Loop</a>
<a name="ln330">		buttonRect = BRect(BPoint(0,0), kArrowSize);</a>
<a name="ln331">		buttonRect.OffsetTo(background-&gt;Bounds().RightBottom() - BPoint(23, 48));</a>
<a name="ln332">		fLoopButton = new DrawButton(buttonRect, B_TRANSLATE(&quot;Loop&quot;),</a>
<a name="ln333">			kLoopArrowBits, kArrowBits, new BMessage(LOOP));</a>
<a name="ln334">		fLoopButton-&gt;SetResizingMode(B_FOLLOW_RIGHT | B_FOLLOW_TOP);</a>
<a name="ln335">		fLoopButton-&gt;SetTarget(this);</a>
<a name="ln336">		background-&gt;AddChild(fLoopButton);</a>
<a name="ln337"> </a>
<a name="ln338">		buttonRect = BRect(BPoint(0,0), kSpeakerIconBitmapSize);</a>
<a name="ln339">		buttonRect.OffsetTo(background-&gt;Bounds().RightBottom() - BPoint(121, 17));</a>
<a name="ln340">		SpeakerView *speakerView = new SpeakerView(buttonRect,</a>
<a name="ln341">			B_FOLLOW_LEFT | B_FOLLOW_TOP);</a>
<a name="ln342">		speakerView-&gt;SetResizingMode(B_FOLLOW_RIGHT | B_FOLLOW_TOP);</a>
<a name="ln343">		background-&gt;AddChild(speakerView);</a>
<a name="ln344"> </a>
<a name="ln345">		buttonRect = BRect(BPoint(0,0), BPoint(84, 19));</a>
<a name="ln346">		buttonRect.OffsetTo(background-&gt;Bounds().RightBottom() - BPoint(107, 20));</a>
<a name="ln347">		fVolumeSlider = new VolumeSlider(buttonRect, &quot;volumeSlider&quot;,</a>
<a name="ln348">			B_FOLLOW_LEFT | B_FOLLOW_TOP);</a>
<a name="ln349">		fVolumeSlider-&gt;SetResizingMode(B_FOLLOW_RIGHT | B_FOLLOW_TOP);</a>
<a name="ln350">		background-&gt;AddChild(fVolumeSlider);</a>
<a name="ln351"> </a>
<a name="ln352">		// Button to mask/see sounds list</a>
<a name="ln353">		buttonRect = BRect(BPoint(0,0), kUpDownButtonSize);</a>
<a name="ln354">		buttonRect.OffsetTo(background-&gt;Bounds().RightBottom() - BPoint(21, 25));</a>
<a name="ln355">		fUpDownButton = new UpDownButton(buttonRect, new BMessage(VIEW_LIST));</a>
<a name="ln356">		fUpDownButton-&gt;SetResizingMode(B_FOLLOW_RIGHT | B_FOLLOW_TOP);</a>
<a name="ln357">		background-&gt;AddChild(fUpDownButton);</a>
<a name="ln358"> </a>
<a name="ln359">		r = Bounds();</a>
<a name="ln360">		r.top = background-&gt;Bounds().bottom + 1;</a>
<a name="ln361">		fBottomBox = new BBox(r, &quot;bottomBox&quot;, B_FOLLOW_ALL);</a>
<a name="ln362">		fBottomBox-&gt;SetBorder(B_NO_BORDER);</a>
<a name="ln363">		AddChild(fBottomBox);</a>
<a name="ln364"> </a>
<a name="ln365">		//	The actual list of recorded sounds (initially empty) sits</a>
<a name="ln366">		//	below the header with the controls.</a>
<a name="ln367">		r = fBottomBox-&gt;Bounds();</a>
<a name="ln368">		r.left += 190;</a>
<a name="ln369">		r.InsetBy(10, 10);</a>
<a name="ln370">		r.left -= 10;</a>
<a name="ln371">		r.top += 4;</a>
<a name="ln372">		r.right -= B_V_SCROLL_BAR_WIDTH;</a>
<a name="ln373">		r.bottom -= 25;</a>
<a name="ln374">		fSoundList = new SoundListView(r, B_TRANSLATE(&quot;Sound List&quot;),</a>
<a name="ln375">			B_FOLLOW_ALL);</a>
<a name="ln376">		fSoundList-&gt;SetSelectionMessage(new BMessage(SOUND_SELECTED));</a>
<a name="ln377">		fSoundList-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln378">		BScrollView *scroller = new BScrollView(&quot;scroller&quot;, fSoundList,</a>
<a name="ln379">			B_FOLLOW_ALL, 0, false, true, B_FANCY_BORDER);</a>
<a name="ln380">		fBottomBox-&gt;AddChild(scroller);</a>
<a name="ln381"> </a>
<a name="ln382">		r = fBottomBox-&gt;Bounds();</a>
<a name="ln383">		r.right = r.left + 190;</a>
<a name="ln384">		r.bottom -= 25;</a>
<a name="ln385">		r.InsetBy(10, 8);</a>
<a name="ln386">		r.top -= 1;</a>
<a name="ln387">		fFileInfoBox = new BBox(r, &quot;fileinfo&quot;, B_FOLLOW_LEFT);</a>
<a name="ln388">		fFileInfoBox-&gt;SetLabel(B_TRANSLATE(&quot;File info&quot;));</a>
<a name="ln389"> </a>
<a name="ln390">		fFileInfoBox-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln391"> </a>
<a name="ln392">		BFont font = be_plain_font;</a>
<a name="ln393">		font.SetSize(font.Size() * 0.92f);</a>
<a name="ln394">		font_height height;</a>
<a name="ln395">		font.GetHeight(&amp;height);</a>
<a name="ln396">		float fontHeight = height.ascent + height.leading + height.descent;</a>
<a name="ln397"> </a>
<a name="ln398">		r = fFileInfoBox-&gt;Bounds();</a>
<a name="ln399">		r.left = 8;</a>
<a name="ln400">		r.top = fontHeight + 6;</a>
<a name="ln401">		r.bottom = r.top + fontHeight + 3;</a>
<a name="ln402">		r.right -= 10;</a>
<a name="ln403">		fFilename = new BStringView(r, &quot;filename&quot;, B_TRANSLATE(&quot;File name:&quot;));</a>
<a name="ln404">		fFileInfoBox-&gt;AddChild(fFilename);</a>
<a name="ln405">		fFilename-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln406">		fFilename-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln407"> </a>
<a name="ln408">		r.top += fontHeight;</a>
<a name="ln409">		r.bottom = r.top + fontHeight + 3;</a>
<a name="ln410">		fFormat = new BStringView(r, &quot;format&quot;, B_TRANSLATE(&quot;Format:&quot;));</a>
<a name="ln411">		fFileInfoBox-&gt;AddChild(fFormat);</a>
<a name="ln412">		fFormat-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln413">		fFormat-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln414"> </a>
<a name="ln415">		r.top += fontHeight;</a>
<a name="ln416">		r.bottom = r.top + fontHeight + 3;</a>
<a name="ln417">		fCompression = new BStringView(r, &quot;compression&quot;,</a>
<a name="ln418">			B_TRANSLATE(&quot;Compression:&quot;));</a>
<a name="ln419">		fFileInfoBox-&gt;AddChild(fCompression);</a>
<a name="ln420">		fCompression-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln421">		fCompression-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln422"> </a>
<a name="ln423">		r.top += fontHeight;</a>
<a name="ln424">		r.bottom = r.top + fontHeight + 3;</a>
<a name="ln425">		fChannels = new BStringView(r, &quot;channels&quot;, B_TRANSLATE(&quot;Channels:&quot;));</a>
<a name="ln426">		fFileInfoBox-&gt;AddChild(fChannels);</a>
<a name="ln427">		fChannels-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln428">		fChannels-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln429"> </a>
<a name="ln430">		r.top += fontHeight;</a>
<a name="ln431">		r.bottom = r.top + fontHeight + 3;</a>
<a name="ln432">		fSampleSize = new BStringView(r, &quot;samplesize&quot;,</a>
<a name="ln433">			B_TRANSLATE(&quot;Sample size:&quot;));</a>
<a name="ln434">		fFileInfoBox-&gt;AddChild(fSampleSize);</a>
<a name="ln435">		fSampleSize-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln436">		fSampleSize-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln437"> </a>
<a name="ln438">		r.top += fontHeight;</a>
<a name="ln439">		r.bottom = r.top + fontHeight + 3;</a>
<a name="ln440">		fSampleRate = new BStringView(r, &quot;samplerate&quot;,</a>
<a name="ln441">			B_TRANSLATE(&quot;Sample rate:&quot;));</a>
<a name="ln442">		fFileInfoBox-&gt;AddChild(fSampleRate);</a>
<a name="ln443">		fSampleRate-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln444">		fSampleRate-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln445"> </a>
<a name="ln446">		r.top += fontHeight;</a>
<a name="ln447">		r.bottom = r.top + fontHeight + 3;</a>
<a name="ln448">		fDuration = new BStringView(r, &quot;duration&quot;, B_TRANSLATE(&quot;Duration:&quot;));</a>
<a name="ln449">		fFileInfoBox-&gt;AddChild(fDuration);</a>
<a name="ln450">		fDuration-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln451">		fDuration-&gt;SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln452"> </a>
<a name="ln453">		fFileInfoBox-&gt;ResizeTo(fFileInfoBox-&gt;Frame().Width(),</a>
<a name="ln454">			r.bottom + fontHeight / 2.0f);</a>
<a name="ln455">		fDeployedHeight = MIN_HEIGHT + fFileInfoBox-&gt;Bounds().Height() + 40.0f;</a>
<a name="ln456"> </a>
<a name="ln457">		//	Input selection lists all available physical inputs that produce</a>
<a name="ln458">		//	buffers with B_MEDIA_RAW_AUDIO format data.</a>
<a name="ln459">		popup = new BPopUpMenu(B_TRANSLATE(&quot;Input&quot;));</a>
<a name="ln460">		const int maxInputCount = 64;</a>
<a name="ln461">		dormant_node_info dni[maxInputCount];</a>
<a name="ln462"> </a>
<a name="ln463">		int32 real_count = maxInputCount;</a>
<a name="ln464"> </a>
<a name="ln465">		error = fRoster-&gt;GetDormantNodes(dni, &amp;real_count, 0, &amp;output_format,</a>
<a name="ln466">			0, B_BUFFER_PRODUCER | B_PHYSICAL_INPUT);</a>
<a name="ln467">		if (real_count &gt; maxInputCount) {</a>
<a name="ln468">			WINDOW((stderr, &quot;dropped %&quot; B_PRId32 &quot; inputs\n&quot;, real_count - maxInputCount));</a>
<a name="ln469">			real_count = maxInputCount;</a>
<a name="ln470">		}</a>
<a name="ln471">		char selected_name[B_MEDIA_NAME_LENGTH] = &quot;Default input&quot;;</a>
<a name="ln472">		BMessage * msg;</a>
<a name="ln473">		BMenuItem * item;</a>
<a name="ln474">		for (int i = 0; i &lt; real_count; i++) {</a>
<a name="ln475">			msg = new BMessage(INPUT_SELECTED);</a>
<a name="ln476">			msg-&gt;AddData(&quot;node&quot;, B_RAW_TYPE, &amp;dni[i], sizeof(dni[i]));</a>
<a name="ln477">			item = new BMenuItem(dni[i].name, msg);</a>
<a name="ln478">			popup-&gt;AddItem(item);</a>
<a name="ln479">			media_node_id ni[12];</a>
<a name="ln480">			int32 ni_count = 12;</a>
<a name="ln481">			error = fRoster-&gt;GetInstancesFor(dni[i].addon, dni[i].flavor_id,</a>
<a name="ln482">				ni, &amp;ni_count);</a>
<a name="ln483">			if (error == B_OK) {</a>
<a name="ln484">				for (int j = 0; j &lt; ni_count; j++) {</a>
<a name="ln485">					if (ni[j] == fAudioInputNode.node) {</a>
<a name="ln486">						strcpy(selected_name, dni[i].name);</a>
<a name="ln487">						break;</a>
<a name="ln488">					}</a>
<a name="ln489">				}</a>
<a name="ln490">			}</a>
<a name="ln491">		}</a>
<a name="ln492"> </a>
<a name="ln493">		//	Create the actual widget</a>
<a name="ln494">		r = fFileInfoBox-&gt;Bounds();</a>
<a name="ln495">		r.top = r.bottom + 2;</a>
<a name="ln496">		r.bottom = r.top + 18;</a>
<a name="ln497">		r.InsetBy(10, 10);</a>
<a name="ln498">		fInputField = new BMenuField(r, &quot;Input&quot;, B_TRANSLATE(&quot;Input:&quot;), popup);</a>
<a name="ln499">		fInputField-&gt;SetDivider(fInputField-&gt;StringWidth(B_TRANSLATE(&quot;Input:&quot;))</a>
<a name="ln500">			+ 4.0f);</a>
<a name="ln501">		fBottomBox-&gt;AddChild(fInputField);</a>
<a name="ln502"> </a>
<a name="ln503">		fBottomBox-&gt;AddChild(fFileInfoBox);</a>
<a name="ln504"> </a>
<a name="ln505">		fBottomBox-&gt;Hide();</a>
<a name="ln506">		CalcSizes(MIN_WIDTH, MIN_HEIGHT);</a>
<a name="ln507">		ResizeTo(Frame().Width(), MIN_HEIGHT);</a>
<a name="ln508"> </a>
<a name="ln509">		popup-&gt;Superitem()-&gt;SetLabel(selected_name);</a>
<a name="ln510"> </a>
<a name="ln511">		// Make sure the save panel is happy.</a>
<a name="ln512">		fSavePanel = new BFilePanel(B_SAVE_PANEL);</a>
<a name="ln513">		fSavePanel-&gt;SetTarget(this);</a>
<a name="ln514">	}</a>
<a name="ln515">	catch (...) {</a>
<a name="ln516">		goto bad_mojo;</a>
<a name="ln517">	}</a>
<a name="ln518">	UpdateButtons();</a>
<a name="ln519">	return B_OK;</a>
<a name="ln520"> </a>
<a name="ln521">	//	Error handling.</a>
<a name="ln522">bad_mojo:</a>
<a name="ln523">	if (error &gt;= 0)</a>
<a name="ln524">		error = B_ERROR;</a>
<a name="ln525">	if (fRecorder)</a>
<a name="ln526">		delete fRecorder;</a>
<a name="ln527"> </a>
<a name="ln528">	delete fPlayer;</a>
<a name="ln529">	if (!fInputField)</a>
<a name="ln530">		delete popup;</a>
<a name="ln531">	return error;</a>
<a name="ln532">}</a>
<a name="ln533"> </a>
<a name="ln534"> </a>
<a name="ln535">bool</a>
<a name="ln536">RecorderWindow::QuitRequested()	//	this means Close pressed</a>
<a name="ln537">{</a>
<a name="ln538">	StopRecording();</a>
<a name="ln539">	StopPlaying();</a>
<a name="ln540">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln541">	return true;</a>
<a name="ln542">}</a>
<a name="ln543"> </a>
<a name="ln544"> </a>
<a name="ln545">void</a>
<a name="ln546">RecorderWindow::MessageReceived(BMessage * message)</a>
<a name="ln547">{</a>
<a name="ln548">	//	Your average generic message dispatching switch() statement.</a>
<a name="ln549">	switch (message-&gt;what) {</a>
<a name="ln550">	case INPUT_SELECTED:</a>
<a name="ln551">		Input(message);</a>
<a name="ln552">		break;</a>
<a name="ln553">	case SOUND_SELECTED:</a>
<a name="ln554">		Selected(message);</a>
<a name="ln555">		break;</a>
<a name="ln556">	case STOP_PLAYING:</a>
<a name="ln557">		StopPlaying();</a>
<a name="ln558">		break;</a>
<a name="ln559">	case STOP_RECORDING:</a>
<a name="ln560">		StopRecording();</a>
<a name="ln561">		break;</a>
<a name="ln562">	case PLAY_PERIOD:</a>
<a name="ln563">		if (fPlayer) {</a>
<a name="ln564">			if (fPlayer-&gt;HasData())</a>
<a name="ln565">				fPlayButton-&gt;SetPlaying();</a>
<a name="ln566">			else</a>
<a name="ln567">				fPlayButton-&gt;SetPaused();</a>
<a name="ln568">		}</a>
<a name="ln569">		break;</a>
<a name="ln570">	case RECORD_PERIOD:</a>
<a name="ln571">		fRecordButton-&gt;SetRecording();</a>
<a name="ln572">		break;</a>
<a name="ln573">	case RECORD:</a>
<a name="ln574">		Record(message);</a>
<a name="ln575">		break;</a>
<a name="ln576">	case STOP:</a>
<a name="ln577">		Stop(message);</a>
<a name="ln578">		break;</a>
<a name="ln579">	case PLAY:</a>
<a name="ln580">		Play(message);</a>
<a name="ln581">		break;</a>
<a name="ln582">	case SAVE:</a>
<a name="ln583">		Save(message);</a>
<a name="ln584">		break;</a>
<a name="ln585">	case B_SAVE_REQUESTED:</a>
<a name="ln586">		DoSave(message);</a>
<a name="ln587">		break;</a>
<a name="ln588">	case VIEW_LIST:</a>
<a name="ln589">		if (fUpDownButton-&gt;Value() == B_CONTROL_ON) {</a>
<a name="ln590">			fBottomBox-&gt;Show();</a>
<a name="ln591">			CalcSizes(MIN_WIDTH, fDeployedHeight);</a>
<a name="ln592">			ResizeTo(Frame().Width(), fDeployedHeight);</a>
<a name="ln593">		} else {</a>
<a name="ln594">			fBottomBox-&gt;Hide();</a>
<a name="ln595">			CalcSizes(MIN_WIDTH, MIN_HEIGHT);</a>
<a name="ln596">			ResizeTo(Frame().Width(), MIN_HEIGHT);</a>
<a name="ln597"> </a>
<a name="ln598">		}</a>
<a name="ln599">		break;</a>
<a name="ln600">	case UPDATE_TRACKSLIDER:</a>
<a name="ln601">		{</a>
<a name="ln602">			bigtime_t timestamp = fPlayTrack-&gt;CurrentTime();</a>
<a name="ln603">			fTrackSlider-&gt;SetMainTime(timestamp, false);</a>
<a name="ln604">			fScopeView-&gt;SetMainTime(timestamp);</a>
<a name="ln605">		}</a>
<a name="ln606">		break;</a>
<a name="ln607">	case POSITION_CHANGED:</a>
<a name="ln608">		{</a>
<a name="ln609">			bigtime_t right, left, main;</a>
<a name="ln610">			if (message-&gt;FindInt64(&quot;main&quot;, &amp;main) == B_OK) {</a>
<a name="ln611">				if (fPlayTrack) {</a>
<a name="ln612">					fPlayTrack-&gt;SeekToTime(fTrackSlider-&gt;MainTime());</a>
<a name="ln613">					fPlayFrame = fPlayTrack-&gt;CurrentFrame();</a>
<a name="ln614">				}</a>
<a name="ln615">				fScopeView-&gt;SetMainTime(main);</a>
<a name="ln616">			}</a>
<a name="ln617">			if (message-&gt;FindInt64(&quot;right&quot;, &amp;right) == B_OK) {</a>
<a name="ln618">				if (fPlayTrack) {</a>
<a name="ln619">					fPlayLimit = MIN(fPlayFrames,</a>
<a name="ln620">						(off_t)(right * fPlayFormat.u.raw_audio.frame_rate</a>
<a name="ln621">							/ 1000000LL));</a>
<a name="ln622">				}</a>
<a name="ln623">				fScopeView-&gt;SetRightTime(right);</a>
<a name="ln624">			}</a>
<a name="ln625">			if (message-&gt;FindInt64(&quot;left&quot;, &amp;left) == B_OK)</a>
<a name="ln626">				fScopeView-&gt;SetLeftTime(left);</a>
<a name="ln627">			break;</a>
<a name="ln628">		}</a>
<a name="ln629">	case LOOP:</a>
<a name="ln630">		fLooping = fLoopButton-&gt;ButtonState();</a>
<a name="ln631">		break;</a>
<a name="ln632">	case B_SIMPLE_DATA:</a>
<a name="ln633">	case B_REFS_RECEIVED:</a>
<a name="ln634">		{</a>
<a name="ln635">			RefsReceived(message);</a>
<a name="ln636">			break;</a>
<a name="ln637">		}</a>
<a name="ln638">	case B_COPY_TARGET:</a>
<a name="ln639">		CopyTarget(message);</a>
<a name="ln640">		break;</a>
<a name="ln641">	default:</a>
<a name="ln642">		BWindow::MessageReceived(message);</a>
<a name="ln643">		break;</a>
<a name="ln644">	}</a>
<a name="ln645">}</a>
<a name="ln646"> </a>
<a name="ln647"> </a>
<a name="ln648">void</a>
<a name="ln649">RecorderWindow::Record(BMessage * message)</a>
<a name="ln650">{</a>
<a name="ln651">	//	User pressed Record button</a>
<a name="ln652">	fRecording = true;</a>
<a name="ln653">	if (fButtonState != btnPaused) {</a>
<a name="ln654">		StopRecording();</a>
<a name="ln655">		return;			//	user is too fast on the mouse</a>
<a name="ln656">	}</a>
<a name="ln657">	SetButtonState(btnRecording);</a>
<a name="ln658">	fRecordButton-&gt;SetRecording();</a>
<a name="ln659"> </a>
<a name="ln660">	char name[256];</a>
<a name="ln661">	//	Create a file with a temporary name</a>
<a name="ln662">	status_t err = NewTempName(name);</a>
<a name="ln663">	if (err &lt; B_OK) {</a>
<a name="ln664">		ErrorAlert(B_TRANSLATE(&quot;Cannot find an unused name to use for the &quot;</a>
<a name="ln665">			&quot;new recording&quot;), err);</a>
<a name="ln666">		return;</a>
<a name="ln667">	}</a>
<a name="ln668">	//	Find the file so we can refer to it later</a>
<a name="ln669">	err = fTempDir.FindEntry(name, &amp;fRecEntry);</a>
<a name="ln670">	if (err &lt; B_OK) {</a>
<a name="ln671">		ErrorAlert(B_TRANSLATE(&quot;Cannot find the temporary file created to &quot;</a>
<a name="ln672">			&quot;hold the new recording&quot;), err);</a>
<a name="ln673">		return;</a>
<a name="ln674">	}</a>
<a name="ln675">	err = fRecFile.SetTo(&amp;fTempDir, name, O_RDWR);</a>
<a name="ln676">	if (err &lt; B_OK) {</a>
<a name="ln677">		ErrorAlert(B_TRANSLATE(&quot;Cannot open the temporary file created to &quot;</a>
<a name="ln678">			&quot;hold the new recording&quot;), err);</a>
<a name="ln679">		fRecEntry.Unset();</a>
<a name="ln680">		return;</a>
<a name="ln681">	}</a>
<a name="ln682">	//	Reserve space on disk (creates fewer fragments)</a>
<a name="ln683">	err = fRecFile.SetSize(4 * fRecordFormat.u.raw_audio.channel_count</a>
<a name="ln684">		* fRecordFormat.u.raw_audio.frame_rate</a>
<a name="ln685">		* (fRecordFormat.u.raw_audio.format</a>
<a name="ln686">			&amp; media_raw_audio_format::B_AUDIO_SIZE_MASK));</a>
<a name="ln687">	if (err &lt; B_OK) {</a>
<a name="ln688">		ErrorAlert(B_TRANSLATE(&quot;Cannot record a sound that long&quot;), err);</a>
<a name="ln689">		fRecEntry.Remove();</a>
<a name="ln690">		fRecEntry.Unset();</a>
<a name="ln691">		return;</a>
<a name="ln692">	}</a>
<a name="ln693">	fRecSize = 0;</a>
<a name="ln694"> </a>
<a name="ln695">	fRecFile.Seek(sizeof(struct wave_struct), SEEK_SET);</a>
<a name="ln696"> </a>
<a name="ln697">	// Hook up input</a>
<a name="ln698">	err = MakeRecordConnection(fAudioInputNode);</a>
<a name="ln699">	if (err &lt; B_OK) {</a>
<a name="ln700">		ErrorAlert(B_TRANSLATE(&quot;Cannot connect to the selected sound input&quot;),</a>
<a name="ln701">			err);</a>
<a name="ln702">		fRecEntry.Remove();</a>
<a name="ln703">		fRecEntry.Unset();</a>
<a name="ln704">		return;</a>
<a name="ln705">	}</a>
<a name="ln706">	fRecorder-&gt;Start();</a>
<a name="ln707">}</a>
<a name="ln708"> </a>
<a name="ln709"> </a>
<a name="ln710">void</a>
<a name="ln711">RecorderWindow::Play(BMessage * message)</a>
<a name="ln712">{</a>
<a name="ln713">	if (fPlayer) {</a>
<a name="ln714">		//	User pressed Play button and playing</a>
<a name="ln715">		if (fPlayer-&gt;HasData())</a>
<a name="ln716">			fPlayButton-&gt;SetPaused();</a>
<a name="ln717">		else</a>
<a name="ln718">			fPlayButton-&gt;SetPlaying();</a>
<a name="ln719">		fPlayer-&gt;SetHasData(!fPlayer-&gt;HasData());</a>
<a name="ln720">		return;</a>
<a name="ln721">	}</a>
<a name="ln722"> </a>
<a name="ln723">	SetButtonState(btnPlaying);</a>
<a name="ln724">	fPlayButton-&gt;SetPlaying();</a>
<a name="ln725"> </a>
<a name="ln726">	if (!fPlayTrack) {</a>
<a name="ln727">		ErrorAlert(B_TRANSLATE(&quot;Cannot get the file to play&quot;), B_ERROR);</a>
<a name="ln728">		return;</a>
<a name="ln729">	}</a>
<a name="ln730"> </a>
<a name="ln731">	fPlayLimit = MIN(fPlayFrames, (off_t)(fTrackSlider-&gt;RightTime()</a>
<a name="ln732">		* fPlayFormat.u.raw_audio.frame_rate / 1000000LL));</a>
<a name="ln733">	fPlayTrack-&gt;SeekToTime(fTrackSlider-&gt;MainTime());</a>
<a name="ln734">	fPlayFrame = fPlayTrack-&gt;CurrentFrame();</a>
<a name="ln735"> </a>
<a name="ln736">	// Create our internal Node which plays sound, and register it.</a>
<a name="ln737">	fPlayer = new BSoundPlayer(fAudioMixerNode, &amp;fPlayFormat.u.raw_audio,</a>
<a name="ln738">		&quot;Sound Player&quot;);</a>
<a name="ln739">	status_t err = fPlayer-&gt;InitCheck();</a>
<a name="ln740">	if (err &lt; B_OK)</a>
<a name="ln741">		return;</a>
<a name="ln742"> </a>
<a name="ln743">	fVolumeSlider-&gt;SetSoundPlayer(fPlayer);</a>
<a name="ln744">	fPlayer-&gt;SetCallbacks(PlayFile, NotifyPlayFile, this);</a>
<a name="ln745"> </a>
<a name="ln746">	//	And get it going...</a>
<a name="ln747">	fPlayer-&gt;Start();</a>
<a name="ln748">	fPlayer-&gt;SetHasData(true);</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751"> </a>
<a name="ln752">void</a>
<a name="ln753">RecorderWindow::Stop(BMessage * message)</a>
<a name="ln754">{</a>
<a name="ln755">	//	User pressed Stop button.</a>
<a name="ln756">	//	Stop recorder.</a>
<a name="ln757">	StopRecording();</a>
<a name="ln758">	//	Stop player.</a>
<a name="ln759">	StopPlaying();</a>
<a name="ln760">}</a>
<a name="ln761"> </a>
<a name="ln762"> </a>
<a name="ln763">void</a>
<a name="ln764">RecorderWindow::Save(BMessage * message)</a>
<a name="ln765">{</a>
<a name="ln766">	//	User pressed Save button.</a>
<a name="ln767">	//	Find the item to save.</a>
<a name="ln768">	int32 index = fSoundList-&gt;CurrentSelection();</a>
<a name="ln769">	SoundListItem* pItem = dynamic_cast&lt;SoundListItem*&gt;(fSoundList-&gt;ItemAt(index));</a>
<a name="ln770">	if ((! pItem) || (pItem-&gt;Entry().InitCheck() != B_OK))</a>
<a name="ln771">		return;</a>
<a name="ln772"> </a>
<a name="ln773">	// Update the save panel and show it.</a>
<a name="ln774">	char filename[B_FILE_NAME_LENGTH];</a>
<a name="ln775">	pItem-&gt;Entry().GetName(filename);</a>
<a name="ln776">	BMessage saveMsg(B_SAVE_REQUESTED);</a>
<a name="ln777">	entry_ref ref;</a>
<a name="ln778">	pItem-&gt;Entry().GetRef(&amp;ref);</a>
<a name="ln779"> </a>
<a name="ln780">	if (saveMsg.AddPointer(&quot;sound list item&quot;, pItem) != B_OK)</a>
<a name="ln781">		fprintf(stderr, &quot;failed to add pItem\n&quot;);</a>
<a name="ln782">	fSavePanel-&gt;SetSaveText(filename);</a>
<a name="ln783">	fSavePanel-&gt;SetMessage(&amp;saveMsg);</a>
<a name="ln784">	fSavePanel-&gt;Show();</a>
<a name="ln785">}</a>
<a name="ln786"> </a>
<a name="ln787"> </a>
<a name="ln788">void</a>
<a name="ln789">RecorderWindow::DoSave(BMessage * message)</a>
<a name="ln790">{</a>
<a name="ln791">	// User picked a place to put the file.</a>
<a name="ln792">	// Find the location of the old (e.g.</a>
<a name="ln793">	// temporary file), and the name of the</a>
<a name="ln794">	// new file to save.</a>
<a name="ln795">	entry_ref old_ref, new_dir_ref;</a>
<a name="ln796">	const char* new_name;</a>
<a name="ln797">	SoundListItem* pItem;</a>
<a name="ln798"> </a>
<a name="ln799">	if ((message-&gt;FindPointer(&quot;sound list item&quot;, (void**) &amp;pItem) == B_OK)</a>
<a name="ln800">		&amp;&amp; (message-&gt;FindRef(&quot;directory&quot;, &amp;new_dir_ref) == B_OK)</a>
<a name="ln801">		&amp;&amp; (message-&gt;FindString(&quot;name&quot;, &amp;new_name) == B_OK)) {</a>
<a name="ln802">		BEntry&amp; oldEntry = pItem-&gt;Entry();</a>
<a name="ln803">		BFile oldFile(&amp;oldEntry, B_READ_WRITE);</a>
<a name="ln804">		if (oldFile.InitCheck() != B_OK)</a>
<a name="ln805">			return;</a>
<a name="ln806"> </a>
<a name="ln807">		BDirectory newDir(&amp;new_dir_ref);</a>
<a name="ln808">		if (newDir.InitCheck() != B_OK)</a>
<a name="ln809">			return;</a>
<a name="ln810"> </a>
<a name="ln811">		BFile newFile;</a>
<a name="ln812">		newDir.CreateFile(new_name, &amp;newFile);</a>
<a name="ln813"> </a>
<a name="ln814">		if (newFile.InitCheck() != B_OK)</a>
<a name="ln815">			return;</a>
<a name="ln816"> </a>
<a name="ln817">		status_t err = CopyFile(newFile, oldFile);</a>
<a name="ln818"> </a>
<a name="ln819">		if (err == B_OK) {</a>
<a name="ln820">			// clean up the sound list and item</a>
<a name="ln821">			if (pItem-&gt;IsTemp())</a>
<a name="ln822">				oldEntry.Remove(); // blows away temp file!</a>
<a name="ln823">			oldEntry.SetTo(&amp;newDir, new_name);</a>
<a name="ln824">			pItem-&gt;SetTemp(false);	// don't blow the new entry away when we exit!</a>
<a name="ln825">			fSoundList-&gt;Invalidate();</a>
<a name="ln826">		}</a>
<a name="ln827">	} else {</a>
<a name="ln828">		WINDOW((stderr, &quot;Couldn't save file.\n&quot;));</a>
<a name="ln829">	}</a>
<a name="ln830">}</a>
<a name="ln831"> </a>
<a name="ln832"> </a>
<a name="ln833">void</a>
<a name="ln834">RecorderWindow::Input(BMessage * message)</a>
<a name="ln835">{</a>
<a name="ln836">	//	User selected input from pop-up</a>
<a name="ln837">	const dormant_node_info * dni = 0;</a>
<a name="ln838">	ssize_t size = 0;</a>
<a name="ln839">	if (message-&gt;FindData(&quot;node&quot;, B_RAW_TYPE, (const void **)&amp;dni, &amp;size))</a>
<a name="ln840">		return;		//	bad input selection message</a>
<a name="ln841"> </a>
<a name="ln842">	media_node_id node_id;</a>
<a name="ln843">	status_t error = fRoster-&gt;GetInstancesFor(dni-&gt;addon, dni-&gt;flavor_id, &amp;node_id);</a>
<a name="ln844">	if (error != B_OK)</a>
<a name="ln845">		fRoster-&gt;InstantiateDormantNode(*dni, &amp;fAudioInputNode);</a>
<a name="ln846">	else</a>
<a name="ln847">		fRoster-&gt;GetNodeFor(node_id, &amp;fAudioInputNode);</a>
<a name="ln848">}</a>
<a name="ln849"> </a>
<a name="ln850"> </a>
<a name="ln851">void</a>
<a name="ln852">RecorderWindow::Selected(BMessage * message)</a>
<a name="ln853">{</a>
<a name="ln854">	//	User selected a sound in list view</a>
<a name="ln855">	int32 selIdx = fSoundList-&gt;CurrentSelection();</a>
<a name="ln856">	SoundListItem* pItem = dynamic_cast&lt;SoundListItem*&gt;(fSoundList-&gt;ItemAt(selIdx));</a>
<a name="ln857">	if (!pItem)</a>
<a name="ln858">		return;</a>
<a name="ln859">	status_t err = UpdatePlayFile(pItem, true);</a>
<a name="ln860">	if (err != B_OK) {</a>
<a name="ln861">		ErrorAlert(B_TRANSLATE(&quot;Cannot recognize this file as a media file&quot;),</a>
<a name="ln862">			err == B_MEDIA_NO_HANDLER ? B_OK : err);</a>
<a name="ln863">		RemoveCurrentSoundItem();</a>
<a name="ln864">	}</a>
<a name="ln865">	UpdateButtons();</a>
<a name="ln866">}</a>
<a name="ln867"> </a>
<a name="ln868"> </a>
<a name="ln869">status_t</a>
<a name="ln870">RecorderWindow::MakeRecordConnection(const media_node &amp; input)</a>
<a name="ln871">{</a>
<a name="ln872">	CONNECT((stderr, &quot;RecorderWindow::MakeRecordConnection()\n&quot;));</a>
<a name="ln873"> </a>
<a name="ln874">	status_t err = B_OK;</a>
<a name="ln875">	media_output audioOutput;</a>
<a name="ln876"> </a>
<a name="ln877">	if (!fRecorder-&gt;IsConnected()) {</a>
<a name="ln878">		//	Find an available output for the given input node.</a>
<a name="ln879">		int32 count = 0;</a>
<a name="ln880">		err = fRoster-&gt;GetFreeOutputsFor(input, &amp;audioOutput, 1,</a>
<a name="ln881">			&amp;count, B_MEDIA_RAW_AUDIO);</a>
<a name="ln882"> </a>
<a name="ln883">		if (err &lt; B_OK) {</a>
<a name="ln884">			CONNECT((stderr, &quot;RecorderWindow::MakeRecordConnection():&quot;</a>
<a name="ln885">				&quot; couldn't get free outputs from audio input node\n&quot;));</a>
<a name="ln886">			return err;</a>
<a name="ln887">		}</a>
<a name="ln888"> </a>
<a name="ln889">		if (count &lt; 1) {</a>
<a name="ln890">			CONNECT((stderr, &quot;RecorderWindow::MakeRecordConnection():&quot;</a>
<a name="ln891">				&quot; no free outputs from audio input node\n&quot;));</a>
<a name="ln892">			return B_BUSY;</a>
<a name="ln893">		}</a>
<a name="ln894"> </a>
<a name="ln895">		// Get a format, any format.</a>
<a name="ln896">		fRecordFormat.u.raw_audio = audioOutput.format.u.raw_audio;</a>
<a name="ln897">		fExternalConnection = false;</a>
<a name="ln898">	} else {</a>
<a name="ln899">		fRecordFormat.u.raw_audio = fRecorder-&gt;AcceptedFormat().u.raw_audio;</a>
<a name="ln900">		fExternalConnection = true;</a>
<a name="ln901">	}</a>
<a name="ln902"> </a>
<a name="ln903">	fRecordFormat.type = B_MEDIA_RAW_AUDIO;</a>
<a name="ln904"> </a>
<a name="ln905">	//	Tell the consumer where we want data to go.</a>
<a name="ln906">	err = fRecorder-&gt;SetHooks(RecordFile, NotifyRecordFile, this);</a>
<a name="ln907"> </a>
<a name="ln908">	if (err &lt; B_OK) {</a>
<a name="ln909">		CONNECT((stderr, &quot;RecorderWindow::MakeRecordConnection():&quot;</a>
<a name="ln910">			&quot; couldn't set the sound recorder's hook functions\n&quot;));</a>
<a name="ln911">		return err;</a>
<a name="ln912">	}</a>
<a name="ln913"> </a>
<a name="ln914">	if (!fRecorder-&gt;IsConnected()) {</a>
<a name="ln915"> </a>
<a name="ln916">		err = fRecorder-&gt;Connect(input, &amp;audioOutput, &amp;fRecordFormat);</a>
<a name="ln917"> </a>
<a name="ln918">		if (err &lt; B_OK) {</a>
<a name="ln919">			CONNECT((stderr, &quot;RecorderWindow::MakeRecordConnection():&quot;</a>
<a name="ln920">				&quot; failed to connect sound recorder to audio input node.\n&quot;));</a>
<a name="ln921"> </a>
<a name="ln922">			fRecorder-&gt;SetHooks(NULL, NULL, NULL);</a>
<a name="ln923">			return err;</a>
<a name="ln924">		}</a>
<a name="ln925">	}</a>
<a name="ln926"> </a>
<a name="ln927">	return B_OK;</a>
<a name="ln928">}</a>
<a name="ln929"> </a>
<a name="ln930"> </a>
<a name="ln931">status_t</a>
<a name="ln932">RecorderWindow::BreakRecordConnection()</a>
<a name="ln933">{</a>
<a name="ln934">	return fRecorder-&gt;Disconnect();</a>
<a name="ln935">}</a>
<a name="ln936"> </a>
<a name="ln937"> </a>
<a name="ln938">status_t</a>
<a name="ln939">RecorderWindow::StopRecording()</a>
<a name="ln940">{</a>
<a name="ln941">	if (!fRecording)</a>
<a name="ln942">		return B_OK;</a>
<a name="ln943">	fRecording = false;</a>
<a name="ln944"> </a>
<a name="ln945">	status_t err = B_OK;</a>
<a name="ln946">	err = fRecorder-&gt;Stop(true);</a>
<a name="ln947">	if (err &lt; B_OK)</a>
<a name="ln948">		return err;</a>
<a name="ln949"> </a>
<a name="ln950">	// We maintain the connection active</a>
<a name="ln951">	// if the user connected us from Cortex.</a>
<a name="ln952">	if (!fExternalConnection) {</a>
<a name="ln953">		BreakRecordConnection();</a>
<a name="ln954">	}</a>
<a name="ln955"> </a>
<a name="ln956">	fRecorder-&gt;SetHooks(NULL, NULL, NULL);</a>
<a name="ln957"> </a>
<a name="ln958">	if (fRecSize &gt; 0) {</a>
<a name="ln959"> </a>
<a name="ln960">		wave_struct header;</a>
<a name="ln961">		header.riff.riff_id = FOURCC('R','I','F','F');</a>
<a name="ln962">		header.riff.len = fRecSize + sizeof(header) - 8;</a>
<a name="ln963">		header.riff.wave_id = FOURCC('W','A','V','E');</a>
<a name="ln964">		header.format_chunk.fourcc = FOURCC('f','m','t',' ');</a>
<a name="ln965">		header.format_chunk.len = sizeof(header.format);</a>
<a name="ln966">		header.format.format_tag = 1;</a>
<a name="ln967">		header.format.channels = fRecordFormat.u.raw_audio.channel_count;</a>
<a name="ln968">		header.format.samples_per_sec = (uint32)fRecordFormat.u.raw_audio.frame_rate;</a>
<a name="ln969">		header.format.avg_bytes_per_sec = (uint32)(fRecordFormat.u.raw_audio.frame_rate</a>
<a name="ln970">			* fRecordFormat.u.raw_audio.channel_count</a>
<a name="ln971">			* (fRecordFormat.u.raw_audio.format &amp; 0xf));</a>
<a name="ln972">		header.format.bits_per_sample = (fRecordFormat.u.raw_audio.format &amp; 0xf) * 8;</a>
<a name="ln973">		header.format.block_align = (fRecordFormat.u.raw_audio.format &amp; 0xf)</a>
<a name="ln974">			* fRecordFormat.u.raw_audio.channel_count;</a>
<a name="ln975">		header.data_chunk.fourcc = FOURCC('d','a','t','a');</a>
<a name="ln976">		header.data_chunk.len = fRecSize;</a>
<a name="ln977">		fRecFile.Seek(0, SEEK_SET);</a>
<a name="ln978">		fRecFile.Write(&amp;header, sizeof(header));</a>
<a name="ln979"> </a>
<a name="ln980">		fRecFile.SetSize(fRecSize + sizeof(header));</a>
<a name="ln981">		//	We reserve space; make sure we cut off any excess at the end.</a>
<a name="ln982">		AddSoundItem(fRecEntry, true);</a>
<a name="ln983">	} else</a>
<a name="ln984">		fRecEntry.Remove();</a>
<a name="ln985"> </a>
<a name="ln986">	//	We're done for this time.</a>
<a name="ln987">	fRecEntry.Unset();</a>
<a name="ln988">	//	Close the file.</a>
<a name="ln989">	fRecFile.Unset();</a>
<a name="ln990">	//	No more recording going on.</a>
<a name="ln991">	fRecSize = 0;</a>
<a name="ln992">	SetButtonState(btnPaused);</a>
<a name="ln993">	fRecordButton-&gt;SetStopped();</a>
<a name="ln994"> </a>
<a name="ln995">	return B_OK;</a>
<a name="ln996">}</a>
<a name="ln997"> </a>
<a name="ln998"> </a>
<a name="ln999">status_t</a>
<a name="ln1000">RecorderWindow::StopPlaying()</a>
<a name="ln1001">{</a>
<a name="ln1002">	if (fPlayer) {</a>
<a name="ln1003">		fPlayer-&gt;Stop();</a>
<a name="ln1004">		fPlayer-&gt;SetCallbacks(0, 0, 0);</a>
<a name="ln1005">		fVolumeSlider-&gt;SetSoundPlayer(NULL);</a>
<a name="ln1006">		delete fPlayer;</a>
<a name="ln1007">		fPlayer = NULL;</a>
<a name="ln1008">	}</a>
<a name="ln1009">	SetButtonState(btnPaused);</a>
<a name="ln1010">	fPlayButton-&gt;SetStopped();</a>
<a name="ln1011">	fTrackSlider-&gt;ResetMainTime();</a>
<a name="ln1012">	fScopeView-&gt;SetMainTime(*fTrackSlider-&gt;MainTime());</a>
<a name="ln1013">	return B_OK;</a>
<a name="ln1014">}</a>
<a name="ln1015"> </a>
<a name="ln1016"> </a>
<a name="ln1017">void</a>
<a name="ln1018">RecorderWindow::SetButtonState(BtnState state)</a>
<a name="ln1019">{</a>
<a name="ln1020">	fButtonState = state;</a>
<a name="ln1021">	UpdateButtons();</a>
<a name="ln1022">}</a>
<a name="ln1023"> </a>
<a name="ln1024"> </a>
<a name="ln1025">void</a>
<a name="ln1026">RecorderWindow::UpdateButtons()</a>
<a name="ln1027">{</a>
<a name="ln1028">	bool hasSelection = (fSoundList-&gt;CurrentSelection() &gt;= 0);</a>
<a name="ln1029">	fRecordButton-&gt;SetEnabled(fButtonState != btnPlaying);</a>
<a name="ln1030">	fPlayButton-&gt;SetEnabled((fButtonState != btnRecording) &amp;&amp; hasSelection);</a>
<a name="ln1031">	fRewindButton-&gt;SetEnabled((fButtonState != btnRecording) &amp;&amp; hasSelection);</a>
<a name="ln1032">	fForwardButton-&gt;SetEnabled((fButtonState != btnRecording) &amp;&amp; hasSelection);</a>
<a name="ln1033">	fStopButton-&gt;SetEnabled(fButtonState != btnPaused);</a>
<a name="ln1034">	fSaveButton-&gt;SetEnabled(hasSelection &amp;&amp; (fButtonState != btnRecording));</a>
<a name="ln1035">	fInputField-&gt;SetEnabled(fButtonState != btnRecording);</a>
<a name="ln1036">}</a>
<a name="ln1037"> </a>
<a name="ln1038">#ifndef __HAIKU__</a>
<a name="ln1039">extern &quot;C&quot; status_t DecodedFormat__11BMediaTrackP12media_format(</a>
<a name="ln1040">	BMediaTrack *self, media_format *inout_format);</a>
<a name="ln1041">#endif</a>
<a name="ln1042"> </a>
<a name="ln1043"> </a>
<a name="ln1044">status_t</a>
<a name="ln1045">RecorderWindow::UpdatePlayFile(SoundListItem* item, bool updateDisplay)</a>
<a name="ln1046">{</a>
<a name="ln1047">	fScopeView-&gt;CancelRendering();</a>
<a name="ln1048">	StopPlaying();</a>
<a name="ln1049">	StopRecording();</a>
<a name="ln1050"> </a>
<a name="ln1051">	if (fPlayTrack &amp;&amp; fPlayFile) {</a>
<a name="ln1052">		fPlayFile-&gt;ReleaseTrack(fPlayTrack);</a>
<a name="ln1053">		fPlayTrack = NULL;</a>
<a name="ln1054">	}</a>
<a name="ln1055">	if (fPlayFile) {</a>
<a name="ln1056">		delete fPlayFile;</a>
<a name="ln1057">		fPlayFile = NULL;</a>
<a name="ln1058">	}</a>
<a name="ln1059"> </a>
<a name="ln1060">	status_t err;</a>
<a name="ln1061">	BEntry&amp; entry = item-&gt;Entry();</a>
<a name="ln1062">	entry_ref ref;</a>
<a name="ln1063">	entry.GetRef(&amp;ref);</a>
<a name="ln1064">	fPlayFile = new BMediaFile(&amp;ref); //, B_MEDIA_FILE_UNBUFFERED);</a>
<a name="ln1065">	if ((err = fPlayFile-&gt;InitCheck()) &lt; B_OK) {</a>
<a name="ln1066">		delete fPlayFile;</a>
<a name="ln1067">		fPlayFile = NULL;</a>
<a name="ln1068">		return err;</a>
<a name="ln1069">	}</a>
<a name="ln1070"> </a>
<a name="ln1071">	for (int ix=0; ix &lt; fPlayFile-&gt;CountTracks(); ix++) {</a>
<a name="ln1072">		BMediaTrack * track = fPlayFile-&gt;TrackAt(ix);</a>
<a name="ln1073">		fPlayFormat.type = B_MEDIA_RAW_AUDIO;</a>
<a name="ln1074">#ifdef __HAIKU__</a>
<a name="ln1075">		if ((track-&gt;DecodedFormat(&amp;fPlayFormat) == B_OK)</a>
<a name="ln1076">#else</a>
<a name="ln1077">		if ((DecodedFormat__11BMediaTrackP12media_format(track, &amp;fPlayFormat) == B_OK)</a>
<a name="ln1078">#endif</a>
<a name="ln1079">			&amp;&amp; (fPlayFormat.type == B_MEDIA_RAW_AUDIO)) {</a>
<a name="ln1080">			fPlayTrack = track;</a>
<a name="ln1081">			break;</a>
<a name="ln1082">		}</a>
<a name="ln1083">		if (track)</a>
<a name="ln1084">			fPlayFile-&gt;ReleaseTrack(track);</a>
<a name="ln1085">	}</a>
<a name="ln1086"> </a>
<a name="ln1087">	if (!fPlayTrack) {</a>
<a name="ln1088">		delete fPlayFile;</a>
<a name="ln1089">		fPlayFile = NULL;</a>
<a name="ln1090">		return B_STREAM_NOT_FOUND;</a>
<a name="ln1091">	}</a>
<a name="ln1092"> </a>
<a name="ln1093">	if (!updateDisplay)</a>
<a name="ln1094">		return B_OK;</a>
<a name="ln1095"> </a>
<a name="ln1096">	BString filename = B_TRANSLATE(&quot;File name: &quot;);</a>
<a name="ln1097">	filename &lt;&lt; ref.name;</a>
<a name="ln1098">	fFilename-&gt;SetText(filename.String());</a>
<a name="ln1099"> </a>
<a name="ln1100">	BString format = B_TRANSLATE(&quot;Format: &quot;);</a>
<a name="ln1101">	media_file_format file_format;</a>
<a name="ln1102">	if (fPlayFile-&gt;GetFileFormatInfo(&amp;file_format) == B_OK)</a>
<a name="ln1103">		format &lt;&lt; file_format.short_name;</a>
<a name="ln1104">	BString compression = B_TRANSLATE(&quot;Compression: &quot;);</a>
<a name="ln1105">	media_codec_info codec_info;</a>
<a name="ln1106">	if (fPlayTrack-&gt;GetCodecInfo(&amp;codec_info) == B_OK) {</a>
<a name="ln1107">		if (strcmp(codec_info.short_name, &quot;raw&quot;)==0)</a>
<a name="ln1108">			compression &lt;&lt; B_TRANSLATE(&quot;None&quot;);</a>
<a name="ln1109">		else</a>
<a name="ln1110">			compression &lt;&lt; codec_info.short_name;</a>
<a name="ln1111">	}</a>
<a name="ln1112">	BString channels = B_TRANSLATE(&quot;Channels: &quot;);</a>
<a name="ln1113">	channels &lt;&lt; fPlayFormat.u.raw_audio.channel_count;</a>
<a name="ln1114">	BString samplesize = B_TRANSLATE(&quot;Sample size: &quot;);</a>
<a name="ln1115">	samplesize &lt;&lt; 8 * (fPlayFormat.u.raw_audio.format &amp; 0xf)</a>
<a name="ln1116">		&lt;&lt; B_TRANSLATE(&quot; bits&quot;);</a>
<a name="ln1117">	BString samplerate = B_TRANSLATE(&quot;Sample rate: &quot;);</a>
<a name="ln1118">	samplerate &lt;&lt; (int)fPlayFormat.u.raw_audio.frame_rate;</a>
<a name="ln1119">	BString durationString = B_TRANSLATE(&quot;Duration: &quot;);</a>
<a name="ln1120">	bigtime_t duration = fPlayTrack-&gt;Duration();</a>
<a name="ln1121">	durationString &lt;&lt; (float)(duration / 1000000.0) &lt;&lt; B_TRANSLATE(&quot; seconds&quot;);</a>
<a name="ln1122"> </a>
<a name="ln1123">	fFormat-&gt;SetText(format.String());</a>
<a name="ln1124">	fCompression-&gt;SetText(compression.String());</a>
<a name="ln1125">	fChannels-&gt;SetText(channels.String());</a>
<a name="ln1126">	fSampleSize-&gt;SetText(samplesize.String());</a>
<a name="ln1127">	fSampleRate-&gt;SetText(samplerate.String());</a>
<a name="ln1128">	fDuration-&gt;SetText(durationString.String());</a>
<a name="ln1129"> </a>
<a name="ln1130">	fTrackSlider-&gt;SetTotalTime(duration, true);</a>
<a name="ln1131">	fScopeView-&gt;SetTotalTime(duration, true);</a>
<a name="ln1132">	fScopeView-&gt;RenderTrack(fPlayTrack, fPlayFormat);</a>
<a name="ln1133"> </a>
<a name="ln1134">	fPlayFrames = fPlayTrack-&gt;CountFrames();</a>
<a name="ln1135">	return B_OK;</a>
<a name="ln1136">}</a>
<a name="ln1137"> </a>
<a name="ln1138"> </a>
<a name="ln1139">void</a>
<a name="ln1140">RecorderWindow::ErrorAlert(const char * action, status_t err)</a>
<a name="ln1141">{</a>
<a name="ln1142">	char msg[300];</a>
<a name="ln1143">	if (err != B_OK)</a>
<a name="ln1144">		sprintf(msg, &quot;%s: %s. [%&quot; B_PRIx32 &quot;]&quot;, action, strerror(err), (int32) err);</a>
<a name="ln1145">	else</a>
<a name="ln1146">		sprintf(msg, &quot;%s.&quot;, action);</a>
<a name="ln1147">	BAlert* alert = new BAlert(&quot;&quot;, msg, B_TRANSLATE(&quot;Stop&quot;));</a>
<a name="ln1148">	alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1149">	alert-&gt;Go();</a>
<a name="ln1150">}</a>
<a name="ln1151"> </a>
<a name="ln1152"> </a>
<a name="ln1153">status_t</a>
<a name="ln1154">RecorderWindow::NewTempName(char * name)</a>
<a name="ln1155">{</a>
<a name="ln1156">	int init_count = fTempCount;</a>
<a name="ln1157">again:</a>
<a name="ln1158">	if (fTempCount-init_count &gt; 25) {</a>
<a name="ln1159">		return B_ERROR;</a>
<a name="ln1160">	}</a>
<a name="ln1161">	else {</a>
<a name="ln1162">		fTempCount++;</a>
<a name="ln1163">		if (fTempCount==0)</a>
<a name="ln1164">			sprintf(name, &quot;Audio Clip&quot;);</a>
<a name="ln1165">		else</a>
<a name="ln1166">			sprintf(name, &quot;Audio Clip %d&quot;, fTempCount);</a>
<a name="ln1167">		BPath path;</a>
<a name="ln1168">		status_t err;</a>
<a name="ln1169">		BEntry tempEnt;</a>
<a name="ln1170">		if ((err = fTempDir.GetEntry(&amp;tempEnt)) &lt; B_OK) {</a>
<a name="ln1171">			return err;</a>
<a name="ln1172">		}</a>
<a name="ln1173">		if ((err = tempEnt.GetPath(&amp;path)) &lt; B_OK) {</a>
<a name="ln1174">			return err;</a>
<a name="ln1175">		}</a>
<a name="ln1176">		path.Append(name);</a>
<a name="ln1177">		int fd;</a>
<a name="ln1178">		//	Use O_EXCL so we know we created the file (sync with other instances)</a>
<a name="ln1179">		if ((fd = open(path.Path(), O_RDWR | O_CREAT | O_EXCL, 0666)) &lt; 0) {</a>
<a name="ln1180">			goto again;</a>
<a name="ln1181">		}</a>
<a name="ln1182">		close(fd);</a>
<a name="ln1183">	}</a>
<a name="ln1184">	return B_OK;</a>
<a name="ln1185">}</a>
<a name="ln1186"> </a>
<a name="ln1187"> </a>
<a name="ln1188">void</a>
<a name="ln1189">RecorderWindow::AddSoundItem(const BEntry&amp; entry, bool temp)</a>
<a name="ln1190">{</a>
<a name="ln1191">	//	Create list item to display.</a>
<a name="ln1192">	SoundListItem * listItem = new SoundListItem(entry, temp);</a>
<a name="ln1193">	fSoundList-&gt;AddItem(listItem);</a>
<a name="ln1194">	fSoundList-&gt;Invalidate();</a>
<a name="ln1195">	fSoundList-&gt;Select(fSoundList-&gt;IndexOf(listItem));</a>
<a name="ln1196">}</a>
<a name="ln1197"> </a>
<a name="ln1198"> </a>
<a name="ln1199">void</a>
<a name="ln1200">RecorderWindow::RemoveCurrentSoundItem() {</a>
<a name="ln1201">	int32 index = fSoundList-&gt;CurrentSelection();</a>
<a name="ln1202">	BListItem *item = fSoundList-&gt;RemoveItem(index);</a>
<a name="ln1203">	delete item;</a>
<a name="ln1204">	if (index &gt;= fSoundList-&gt;CountItems())</a>
<a name="ln1205">		index = fSoundList-&gt;CountItems() - 1;</a>
<a name="ln1206">	fSoundList-&gt;Select(index);</a>
<a name="ln1207">}</a>
<a name="ln1208"> </a>
<a name="ln1209"> </a>
<a name="ln1210">void</a>
<a name="ln1211">RecorderWindow::RecordFile(void* cookie, bigtime_t timestamp,</a>
<a name="ln1212">	void* data, size_t size, const media_format &amp;format)</a>
<a name="ln1213">{</a>
<a name="ln1214">	//	Callback called from the SoundConsumer when receiving buffers.</a>
<a name="ln1215">	RecorderWindow * window = (RecorderWindow *)cookie;</a>
<a name="ln1216"> </a>
<a name="ln1217">	if (window-&gt;fRecording) {</a>
<a name="ln1218">		//	Write the data to file (we don't buffer or guard file access</a>
<a name="ln1219">		//	or anything)</a>
<a name="ln1220">		window-&gt;fRecFile.WriteAt(window-&gt;fRecSize, data, size);</a>
<a name="ln1221">		window-&gt;fVUView-&gt;ComputeLevels(data, size, format.u.raw_audio.format);</a>
<a name="ln1222">		window-&gt;fRecSize += size;</a>
<a name="ln1223">	}</a>
<a name="ln1224">}</a>
<a name="ln1225"> </a>
<a name="ln1226"> </a>
<a name="ln1227">void</a>
<a name="ln1228">RecorderWindow::NotifyRecordFile(void * cookie,</a>
<a name="ln1229">	BMediaRecorder::notification code, ...)</a>
<a name="ln1230">{</a>
<a name="ln1231">	if (code == BMediaRecorder::B_WILL_STOP) {</a>
<a name="ln1232">		RecorderWindow * window = (RecorderWindow *)cookie;</a>
<a name="ln1233">		// Tell the window we've stopped, if it doesn't</a>
<a name="ln1234">		// already know.</a>
<a name="ln1235">		window-&gt;PostMessage(STOP_RECORDING);</a>
<a name="ln1236">	}</a>
<a name="ln1237">}</a>
<a name="ln1238"> </a>
<a name="ln1239"> </a>
<a name="ln1240">void</a>
<a name="ln1241">RecorderWindow::PlayFile(void * cookie, void * data, size_t size,</a>
<a name="ln1242">	const media_raw_audio_format &amp; format)</a>
<a name="ln1243">{</a>
<a name="ln1244">	//	Callback called from the SoundProducer when producing buffers.</a>
<a name="ln1245">	RecorderWindow * window = (RecorderWindow *)cookie;</a>
<a name="ln1246">	int32 frame_size = (window-&gt;fPlayFormat.u.raw_audio.format &amp; 0xf) *</a>
<a name="ln1247">		window-&gt;fPlayFormat.u.raw_audio.channel_count;</a>
<a name="ln1248"> </a>
<a name="ln1249">	if ((window-&gt;fPlayFrame &lt; window-&gt;fPlayLimit) || window-&gt;fLooping) {</a>
<a name="ln1250">		if (window-&gt;fPlayFrame &gt;= window-&gt;fPlayLimit) {</a>
<a name="ln1251">			bigtime_t left = window-&gt;fTrackSlider-&gt;LeftTime();</a>
<a name="ln1252">			window-&gt;fPlayTrack-&gt;SeekToTime(&amp;left);</a>
<a name="ln1253">			window-&gt;fPlayFrame = window-&gt;fPlayTrack-&gt;CurrentFrame();</a>
<a name="ln1254">		}</a>
<a name="ln1255">		int64 frames = 0;</a>
<a name="ln1256">		window-&gt;fPlayTrack-&gt;ReadFrames(data, &amp;frames);</a>
<a name="ln1257">		window-&gt;fVUView-&gt;ComputeLevels(data, size / frame_size, format.format);</a>
<a name="ln1258">		window-&gt;fPlayFrame += size/frame_size;</a>
<a name="ln1259">		window-&gt;PostMessage(UPDATE_TRACKSLIDER);</a>
<a name="ln1260">	} else {</a>
<a name="ln1261">		//	we're done!</a>
<a name="ln1262">		window-&gt;PostMessage(STOP_PLAYING);</a>
<a name="ln1263">	}</a>
<a name="ln1264">}</a>
<a name="ln1265"> </a>
<a name="ln1266"> </a>
<a name="ln1267">void</a>
<a name="ln1268">RecorderWindow::NotifyPlayFile(void * cookie,</a>
<a name="ln1269">	BSoundPlayer::sound_player_notification code, ...)</a>
<a name="ln1270">{</a>
<a name="ln1271">	if ((code == BSoundPlayer::B_STOPPED) || (code == BSoundPlayer::B_SOUND_DONE)) {</a>
<a name="ln1272">		RecorderWindow * window = (RecorderWindow *)cookie;</a>
<a name="ln1273">		// tell the window we've stopped, if it doesn't</a>
<a name="ln1274">		// already know.</a>
<a name="ln1275">		window-&gt;PostMessage(STOP_PLAYING);</a>
<a name="ln1276">	}</a>
<a name="ln1277">}</a>
<a name="ln1278"> </a>
<a name="ln1279"> </a>
<a name="ln1280">void</a>
<a name="ln1281">RecorderWindow::RefsReceived(BMessage *msg)</a>
<a name="ln1282">{</a>
<a name="ln1283">	entry_ref ref;</a>
<a name="ln1284">	int32 i = 0;</a>
<a name="ln1285">	int32 countGood = 0;</a>
<a name="ln1286">	int32 countBad = 0;</a>
<a name="ln1287"> </a>
<a name="ln1288">	while (msg-&gt;FindRef(&quot;refs&quot;, i++, &amp;ref) == B_OK) {</a>
<a name="ln1289"> </a>
<a name="ln1290">		BEntry entry(&amp;ref, true);</a>
<a name="ln1291">		BPath path(&amp;entry);</a>
<a name="ln1292">		BNode node(&amp;entry);</a>
<a name="ln1293"> </a>
<a name="ln1294">		if (node.IsFile()) {</a>
<a name="ln1295">			SoundListItem * listItem = new SoundListItem(entry, false);</a>
<a name="ln1296">			if (UpdatePlayFile(listItem) == B_OK) {</a>
<a name="ln1297">				fSoundList-&gt;AddItem(listItem);</a>
<a name="ln1298">				countGood++;</a>
<a name="ln1299">				continue;</a>
<a name="ln1300">			}</a>
<a name="ln1301">			delete listItem;</a>
<a name="ln1302">		} else if(node.IsDirectory()) {</a>
<a name="ln1303"> </a>
<a name="ln1304">		}</a>
<a name="ln1305">		countBad++;</a>
<a name="ln1306">	}</a>
<a name="ln1307"> </a>
<a name="ln1308">	if (countBad == 1 &amp;&amp; countGood == 0) {</a>
<a name="ln1309">		BAlert* alert = new BAlert(B_TRANSLATE(&quot;Nothing to play&quot;),</a>
<a name="ln1310">			B_TRANSLATE(&quot;The file doesn't appear to be an audio file.&quot;),</a>
<a name="ln1311">			B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln1312">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1313">		alert-&gt;Go();</a>
<a name="ln1314">	} else if (countBad &gt; 0 &amp;&amp; countGood == 0) {</a>
<a name="ln1315">		BAlert* alert = new BAlert(B_TRANSLATE(&quot;Nothing to play&quot;),</a>
<a name="ln1316">			B_TRANSLATE(&quot;None of the files appear to be audio files.&quot;),</a>
<a name="ln1317">			B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln1318">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1319">		alert-&gt;Go();</a>
<a name="ln1320">	} else if (countGood &gt; 0) {</a>
<a name="ln1321">		if (countBad &gt; 0) {</a>
<a name="ln1322">			BAlert* alert = new BAlert(B_TRANSLATE(&quot;Invalid audio files&quot;),</a>
<a name="ln1323">			B_TRANSLATE(&quot;Some of the files don't appear to be audio files.&quot;),</a>
<a name="ln1324">				B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL,</a>
<a name="ln1325">				B_WARNING_ALERT);</a>
<a name="ln1326">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1327">			alert-&gt;Go();</a>
<a name="ln1328">		}</a>
<a name="ln1329">		fSoundList-&gt;Select(fSoundList-&gt;CountItems() - 1);</a>
<a name="ln1330">	}</a>
<a name="ln1331">}</a>
<a name="ln1332"> </a>
<a name="ln1333"> </a>
<a name="ln1334">void</a>
<a name="ln1335">RecorderWindow::CopyTarget(BMessage *msg)</a>
<a name="ln1336">{</a>
<a name="ln1337">	const char *type = NULL;</a>
<a name="ln1338">	if (msg-&gt;FindString(&quot;be:types&quot;, &amp;type) == B_OK) {</a>
<a name="ln1339">		if (!strcasecmp(type, B_FILE_MIME_TYPE)) {</a>
<a name="ln1340">			const char *name;</a>
<a name="ln1341">			entry_ref dir;</a>
<a name="ln1342">			if (msg-&gt;FindString(&quot;be:filetypes&quot;) != NULL</a>
<a name="ln1343">				&amp;&amp; msg-&gt;FindString(&quot;name&quot;, &amp;name) == B_OK</a>
<a name="ln1344">				&amp;&amp; msg-&gt;FindRef(&quot;directory&quot;, &amp;dir) == B_OK) {</a>
<a name="ln1345">				BDirectory directory(&amp;dir);</a>
<a name="ln1346">				BFile file(&amp;directory, name, O_RDWR | O_TRUNC);</a>
<a name="ln1347"> </a>
<a name="ln1348">				// seek time</a>
<a name="ln1349">				bigtime_t start = fTrackSlider-&gt;LeftTime();</a>
<a name="ln1350"> </a>
<a name="ln1351">				// write data</a>
<a name="ln1352">				bigtime_t diffTime = fTrackSlider-&gt;RightTime()</a>
<a name="ln1353">					- fTrackSlider-&gt;LeftTime();</a>
<a name="ln1354">				int64 framesToWrite = (int64) (diffTime</a>
<a name="ln1355">					* fPlayFormat.u.raw_audio.frame_rate / 1000000LL);</a>
<a name="ln1356">				int32 frameSize = (fPlayFormat.u.raw_audio.format &amp; 0xf)</a>
<a name="ln1357">					* fPlayFormat.u.raw_audio.channel_count;</a>
<a name="ln1358"> </a>
<a name="ln1359">				wave_struct header;</a>
<a name="ln1360">				header.riff.riff_id = FOURCC('R','I','F','F');</a>
<a name="ln1361">				header.riff.len</a>
<a name="ln1362">					= (frameSize * framesToWrite) + sizeof(header) - 8;</a>
<a name="ln1363">				header.riff.wave_id = FOURCC('W','A','V','E');</a>
<a name="ln1364">				header.format_chunk.fourcc = FOURCC('f','m','t',' ');</a>
<a name="ln1365">				header.format_chunk.len = sizeof(header.format);</a>
<a name="ln1366">				header.format.format_tag = 1;</a>
<a name="ln1367">				header.format.channels = fPlayFormat.u.raw_audio.channel_count;</a>
<a name="ln1368">				header.format.samples_per_sec</a>
<a name="ln1369">					= (uint32)fPlayFormat.u.raw_audio.frame_rate;</a>
<a name="ln1370">				header.format.avg_bytes_per_sec</a>
<a name="ln1371">					= (uint32)(fPlayFormat.u.raw_audio.frame_rate</a>
<a name="ln1372">					* fPlayFormat.u.raw_audio.channel_count</a>
<a name="ln1373">					* (fPlayFormat.u.raw_audio.format &amp; 0xf));</a>
<a name="ln1374">				header.format.bits_per_sample</a>
<a name="ln1375">					= (fPlayFormat.u.raw_audio.format &amp; 0xf) * 8;</a>
<a name="ln1376">				header.format.block_align = frameSize;</a>
<a name="ln1377">				header.data_chunk.fourcc = FOURCC('d','a','t','a');</a>
<a name="ln1378">				header.data_chunk.len = frameSize * framesToWrite;</a>
<a name="ln1379">				file.Seek(0, SEEK_SET);</a>
<a name="ln1380">				file.Write(&amp;header, sizeof(header));</a>
<a name="ln1381"> </a>
<a name="ln1382">				char *data = (char *)malloc(fPlayFormat.u.raw_audio.buffer_size);</a>
<a name="ln1383"> </a>
<a name="ln1384">				fPlayTrack-&gt;SeekToTime(&amp;start);</a>
<a name="ln1385">				fPlayFrame = fPlayTrack-&gt;CurrentFrame();</a>
<a name="ln1386">				while (framesToWrite &gt; 0) {</a>
<a name="ln1387">					int64 frames = 0;</a>
<a name="ln1388">					status_t err = fPlayTrack-&gt;ReadFrames(data, &amp;frames);</a>
<a name="ln1389">					if (frames &lt;= 0 || err != B_OK) {</a>
<a name="ln1390">						if (err != B_OK)</a>
<a name="ln1391">							fprintf(stderr, &quot;CopyTarget: ReadFrames failed\n&quot;);</a>
<a name="ln1392">						break;</a>
<a name="ln1393">					}</a>
<a name="ln1394">					file.Write(data, frames * frameSize);</a>
<a name="ln1395">					framesToWrite -= frames;</a>
<a name="ln1396">				}</a>
<a name="ln1397"> </a>
<a name="ln1398">				file.Sync();</a>
<a name="ln1399">				free(data);</a>
<a name="ln1400">				BNodeInfo nodeInfo(&amp;file);</a>
<a name="ln1401">				// set type</a>
<a name="ln1402">			}</a>
<a name="ln1403">		} else {</a>
<a name="ln1404"> </a>
<a name="ln1405">		}</a>
<a name="ln1406">	}</a>
<a name="ln1407">}</a>

</code></pre>
<div class="balloon" rel="1320"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="1314"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="1150"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="1075"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'track' pointer was utilized before it was verified against nullptr. Check lines: 1075, 1083.</p></div>
<div class="balloon" rel="1328"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
