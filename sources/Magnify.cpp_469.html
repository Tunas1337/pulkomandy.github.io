
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>Magnify.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2002-2009, Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Updated by Sikosis (beos@gravity24hr.com)</a>
<a name="ln6"> *</a>
<a name="ln7"> * Copyright 1999, Be Incorporated.   All Rights Reserved.</a>
<a name="ln8"> * This file may be used under the terms of the Be Sample Code License.</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11">#include &quot;Magnify.h&quot;</a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;Alert.h&gt;</a>
<a name="ln14">#include &lt;Bitmap.h&gt;</a>
<a name="ln15">#include &lt;BitmapStream.h&gt;</a>
<a name="ln16">#include &lt;Catalog.h&gt;</a>
<a name="ln17">#include &lt;Clipboard.h&gt;</a>
<a name="ln18">#include &lt;Debug.h&gt;</a>
<a name="ln19">#include &lt;Directory.h&gt;</a>
<a name="ln20">#include &lt;File.h&gt;</a>
<a name="ln21">#include &lt;FindDirectory.h&gt;</a>
<a name="ln22">#include &lt;Locale.h&gt;</a>
<a name="ln23">#include &lt;MenuItem.h&gt;</a>
<a name="ln24">#include &lt;MenuField.h&gt;</a>
<a name="ln25">#include &lt;NodeInfo.h&gt;</a>
<a name="ln26">#include &lt;Path.h&gt;</a>
<a name="ln27">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln28">#include &lt;PropertyInfo.h&gt;</a>
<a name="ln29">#include &lt;Screen.h&gt;</a>
<a name="ln30">#include &lt;ScrollView.h&gt;</a>
<a name="ln31">#include &lt;StringFormat.h&gt;</a>
<a name="ln32">#include &lt;TextView.h&gt;</a>
<a name="ln33">#include &lt;TranslationUtils.h&gt;</a>
<a name="ln34">#include &lt;TranslatorRoster.h&gt;</a>
<a name="ln35">#include &lt;WindowScreen.h&gt;</a>
<a name="ln36"> </a>
<a name="ln37">#include &lt;stdio.h&gt;</a>
<a name="ln38">#include &lt;stdlib.h&gt;</a>
<a name="ln39">#include &lt;string.h&gt;</a>
<a name="ln40">#include &lt;fcntl.h&gt;</a>
<a name="ln41">#include &lt;unistd.h&gt;</a>
<a name="ln42">#include &lt;sys/stat.h&gt;</a>
<a name="ln43"> </a>
<a name="ln44"> </a>
<a name="ln45">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln46">#define B_TRANSLATION_CONTEXT &quot;Magnify-Main&quot;</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">const int32 msg_update_info = 'info';</a>
<a name="ln50">const int32 msg_show_info = 'show';</a>
<a name="ln51">const int32 msg_toggle_grid = 'grid';</a>
<a name="ln52">const int32 msg_shrink = 'shnk';</a>
<a name="ln53">const int32 msg_grow = 'grow';</a>
<a name="ln54">const int32 msg_make_square = 'sqar';</a>
<a name="ln55">const int32 msg_shrink_pixel = 'pshk';</a>
<a name="ln56">const int32 msg_grow_pixel = 'pgrw';</a>
<a name="ln57"> </a>
<a name="ln58">const int32 msg_mouse_left = 'mslf';</a>
<a name="ln59">const int32 msg_mouse_right = 'msrt';</a>
<a name="ln60">const int32 msg_mouse_up = 'msup';</a>
<a name="ln61">const int32 msg_mouse_down = 'msdn';</a>
<a name="ln62"> </a>
<a name="ln63">const int32 msg_new_color = 'colr';</a>
<a name="ln64">const int32 msg_toggle_ruler = 'rulr';</a>
<a name="ln65">const int32 msg_copy_image = 'copy';</a>
<a name="ln66">const int32 msg_track_color = 'trak';</a>
<a name="ln67">const int32 msg_freeze = 'frez';</a>
<a name="ln68">const int32 msg_stick = 'stic';</a>
<a name="ln69">const int32 msg_dump = 'dump';</a>
<a name="ln70">const int32 msg_add_cross_hair = 'acrs';</a>
<a name="ln71">const int32 msg_remove_cross_hair = 'rcrs';</a>
<a name="ln72">const int32 msg_save = 'save';</a>
<a name="ln73"> </a>
<a name="ln74">const rgb_color kViewGray = { 216, 216, 216, 255};</a>
<a name="ln75">const rgb_color kGridGray = {130, 130, 130, 255 };</a>
<a name="ln76">const rgb_color kWhite = { 255, 255, 255, 255};</a>
<a name="ln77">const rgb_color kBlack = { 0, 0, 0, 255};</a>
<a name="ln78">const rgb_color kDarkGray = { 96, 96, 96, 255};</a>
<a name="ln79">const rgb_color kRedColor = { 255, 10, 50, 255 };</a>
<a name="ln80">const rgb_color kGreenColor = { 10, 255, 50, 255 };</a>
<a name="ln81">const rgb_color kBlueColor = { 10, 50, 255, 255 };</a>
<a name="ln82"> </a>
<a name="ln83">const char* const kBitmapMimeType = &quot;image/x-vnd.Be-bitmap&quot;;</a>
<a name="ln84"> </a>
<a name="ln85">const float kCurrentVersion = 1.2;</a>
<a name="ln86">const char *kPrefsFileName = &quot;Magnify_prefs&quot;;</a>
<a name="ln87"> </a>
<a name="ln88">// prefs are:</a>
<a name="ln89">//		name = Magnify</a>
<a name="ln90">//		version</a>
<a name="ln91">//		show grid</a>
<a name="ln92">//		show info	(rgb, location)</a>
<a name="ln93">//		pixel count</a>
<a name="ln94">//		pixel size</a>
<a name="ln95">const char* const kAppName = &quot;Magnify&quot;;</a>
<a name="ln96">const bool kDefaultShowGrid = true;</a>
<a name="ln97">const bool kDefaultShowInfo = true;</a>
<a name="ln98">const int32 kDefaultPixelCount = 32;</a>
<a name="ln99">const int32 kDefaultPixelSize = 8;</a>
<a name="ln100"> </a>
<a name="ln101">// each info region will be:</a>
<a name="ln102">// top-bottom: 5 fontheight 5 fontheight 5</a>
<a name="ln103">// left-right: 10 minwindowwidth 10</a>
<a name="ln104">const int32 kBorderSize = 10;</a>
<a name="ln105"> </a>
<a name="ln106"> </a>
<a name="ln107">static property_info sProperties[] = {</a>
<a name="ln108">	{ &quot;Info&quot;, { B_GET_PROPERTY, B_SET_PROPERTY, 0 },</a>
<a name="ln109">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln110">		&quot;Show/hide info.&quot;, 0,</a>
<a name="ln111">		{ B_BOOL_TYPE }</a>
<a name="ln112">	},</a>
<a name="ln113">	{ &quot;Grid&quot;, { B_GET_PROPERTY, B_SET_PROPERTY, 0 },</a>
<a name="ln114">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln115">		&quot;Show/hide grid.&quot;, 0,</a>
<a name="ln116">		{ B_BOOL_TYPE }</a>
<a name="ln117">	},</a>
<a name="ln118">	{ &quot;MakeSquare&quot;, { B_EXECUTE_PROPERTY, 0 },</a>
<a name="ln119">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln120">		&quot;Make the view square.&quot;, 0,</a>
<a name="ln121">	},</a>
<a name="ln122">	{ &quot;Zoom&quot;, { B_GET_PROPERTY, B_SET_PROPERTY, 0 },</a>
<a name="ln123">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln124">		&quot;Gets/sets the zoom factor (1-16).&quot;, 0,</a>
<a name="ln125">		{ B_INT32_TYPE }</a>
<a name="ln126">	},</a>
<a name="ln127">	{ &quot;Stick&quot;, { B_GET_PROPERTY, B_SET_PROPERTY, 0 },</a>
<a name="ln128">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln129">		&quot;Stick/unstick coordinates.&quot;, 0,</a>
<a name="ln130">		{ B_BOOL_TYPE }</a>
<a name="ln131">	},</a>
<a name="ln132">	{ &quot;CopyImage&quot;, { B_EXECUTE_PROPERTY, 0 },</a>
<a name="ln133">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln134">		&quot;Copy image to clipboard.&quot;, 0,</a>
<a name="ln135">	},</a>
<a name="ln136"> </a>
<a name="ln137">	{ 0 }</a>
<a name="ln138">};</a>
<a name="ln139"> </a>
<a name="ln140"> </a>
<a name="ln141">static float</a>
<a name="ln142">FontHeight(BView* target, bool full)</a>
<a name="ln143">{</a>
<a name="ln144">	font_height finfo;</a>
<a name="ln145">	target-&gt;GetFontHeight(&amp;finfo);</a>
<a name="ln146">	float h = ceil(finfo.ascent) + ceil(finfo.descent);</a>
<a name="ln147"> </a>
<a name="ln148">	if (full)</a>
<a name="ln149">		h += ceil(finfo.leading);</a>
<a name="ln150"> </a>
<a name="ln151">	return h;</a>
<a name="ln152">}</a>
<a name="ln153"> </a>
<a name="ln154"> </a>
<a name="ln155">static void</a>
<a name="ln156">BoundsSelection(int32 incX, int32 incY, float* x, float* y,</a>
<a name="ln157">	int32 xCount, int32 yCount)</a>
<a name="ln158">{</a>
<a name="ln159">	*x += incX;</a>
<a name="ln160">	*y += incY;</a>
<a name="ln161"> </a>
<a name="ln162">	if (*x &lt; 0)</a>
<a name="ln163">		*x = xCount-1;</a>
<a name="ln164">	if (*x &gt;= xCount)</a>
<a name="ln165">		*x = 0;</a>
<a name="ln166"> </a>
<a name="ln167">	if (*y &lt; 0)</a>
<a name="ln168">		*y = yCount-1;</a>
<a name="ln169">	if (*y &gt;= yCount)</a>
<a name="ln170">		*y = 0;</a>
<a name="ln171">}</a>
<a name="ln172"> </a>
<a name="ln173"> </a>
<a name="ln174">static void</a>
<a name="ln175">BuildInfoMenu(BMenu *menu)</a>
<a name="ln176">{</a>
<a name="ln177">	BMenuItem* menuItem;</a>
<a name="ln178">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Save image&quot;),</a>
<a name="ln179">		new BMessage(msg_save), 'S');</a>
<a name="ln180">	menu-&gt;AddItem(menuItem);</a>
<a name="ln181">//	menuItem = new BMenuItem(B_TRANSLATE(&quot;Save selection&quot;),</a>
<a name="ln182">//		new BMessage(msg_save), 'S');</a>
<a name="ln183">//	menu-&gt;AddItem(menuItem);</a>
<a name="ln184">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Copy image&quot;),</a>
<a name="ln185">		new BMessage(msg_copy_image), 'C');</a>
<a name="ln186">	menu-&gt;AddItem(menuItem);</a>
<a name="ln187">	menu-&gt;AddSeparatorItem();</a>
<a name="ln188"> </a>
<a name="ln189">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Show info&quot;),</a>
<a name="ln190">		new BMessage(msg_show_info), 'T');</a>
<a name="ln191">	menu-&gt;AddItem(menuItem);</a>
<a name="ln192">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Add a crosshair&quot;),</a>
<a name="ln193">		new BMessage(msg_add_cross_hair), 'H');</a>
<a name="ln194">	menu-&gt;AddItem(menuItem);</a>
<a name="ln195">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Remove a crosshair&quot;),</a>
<a name="ln196">		new BMessage(msg_remove_cross_hair), 'H', B_SHIFT_KEY);</a>
<a name="ln197">	menu-&gt;AddItem(menuItem);</a>
<a name="ln198">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Show grid&quot;),</a>
<a name="ln199">		new BMessage(msg_toggle_grid), 'G');</a>
<a name="ln200">	menu-&gt;AddItem(menuItem);</a>
<a name="ln201">	menu-&gt;AddSeparatorItem();</a>
<a name="ln202"> </a>
<a name="ln203">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Freeze image&quot;),</a>
<a name="ln204">		new BMessage(msg_freeze), 'F');</a>
<a name="ln205">	menu-&gt;AddItem(menuItem);</a>
<a name="ln206">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Stick coordinates&quot;),</a>
<a name="ln207">		new BMessage(msg_stick), 'I');</a>
<a name="ln208">	menu-&gt;AddItem(menuItem);</a>
<a name="ln209">	menu-&gt;AddSeparatorItem();</a>
<a name="ln210"> </a>
<a name="ln211">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Make square&quot;),</a>
<a name="ln212">		new BMessage(msg_make_square), '/');</a>
<a name="ln213">	menu-&gt;AddItem(menuItem);</a>
<a name="ln214">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Decrease window size&quot;),</a>
<a name="ln215">		new BMessage(msg_shrink), '-');</a>
<a name="ln216">	menu-&gt;AddItem(menuItem);</a>
<a name="ln217">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Increase window size&quot;),</a>
<a name="ln218">		new BMessage(msg_grow), '+');</a>
<a name="ln219">	menu-&gt;AddItem(menuItem);</a>
<a name="ln220">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Decrease pixel size&quot;),</a>
<a name="ln221">		new BMessage(msg_shrink_pixel), ',');</a>
<a name="ln222">	menu-&gt;AddItem(menuItem);</a>
<a name="ln223">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Increase pixel size&quot;),</a>
<a name="ln224">		new BMessage(msg_grow_pixel), '.');</a>
<a name="ln225">	menu-&gt;AddItem(menuItem);</a>
<a name="ln226">}</a>
<a name="ln227"> </a>
<a name="ln228">static void</a>
<a name="ln229">UpdateInfoMenu(BMenu *menu, TWindow *window)</a>
<a name="ln230">{</a>
<a name="ln231">	bool state = true;</a>
<a name="ln232">	bool showGrid = true;</a>
<a name="ln233">	bool infoBarIsVisible = true;</a>
<a name="ln234">	bool stickCordinates = true;</a>
<a name="ln235">	if (window) {</a>
<a name="ln236">		state = window-&gt;IsActive();</a>
<a name="ln237">		showGrid = window-&gt;ShowGrid();</a>
<a name="ln238">		infoBarIsVisible = window-&gt;InfoBarIsVisible();</a>
<a name="ln239">		stickCordinates = window-&gt;IsSticked();</a>
<a name="ln240">	}</a>
<a name="ln241">	BMenuItem* menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Show info&quot;));</a>
<a name="ln242">	if (menuItem) {</a>
<a name="ln243">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln244">		menuItem-&gt;SetMarked(infoBarIsVisible);</a>
<a name="ln245">	}</a>
<a name="ln246">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Add a crosshair&quot;));</a>
<a name="ln247">	if (menuItem)</a>
<a name="ln248">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln249">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Remove a crosshair&quot;));</a>
<a name="ln250">	if (menuItem)</a>
<a name="ln251">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln252">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Show grid&quot;));</a>
<a name="ln253">	if (menuItem) {</a>
<a name="ln254">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln255">		menuItem-&gt;SetMarked(showGrid);</a>
<a name="ln256">	}</a>
<a name="ln257">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Freeze image&quot;));</a>
<a name="ln258">	if (menuItem) {</a>
<a name="ln259">		menuItem-&gt;SetMarked(!state);</a>
<a name="ln260">	}</a>
<a name="ln261">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Stick coordinates&quot;));</a>
<a name="ln262">	if (menuItem) {</a>
<a name="ln263">		menuItem-&gt;SetMarked(stickCordinates);</a>
<a name="ln264">	}</a>
<a name="ln265">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Make square&quot;));</a>
<a name="ln266">	if (menuItem)</a>
<a name="ln267">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln268">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Decrease window size&quot;));</a>
<a name="ln269">	if (menuItem)</a>
<a name="ln270">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln271">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Increase window size&quot;));</a>
<a name="ln272">	if (menuItem)</a>
<a name="ln273">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln274">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Decrease pixel size&quot;));</a>
<a name="ln275">	if (menuItem)</a>
<a name="ln276">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln277">	menuItem = menu-&gt;FindItem(B_TRANSLATE(&quot;Increase pixel size&quot;));</a>
<a name="ln278">	if (menuItem)</a>
<a name="ln279">		menuItem-&gt;SetEnabled(state);</a>
<a name="ln280">}</a>
<a name="ln281"> </a>
<a name="ln282">//	#pragma mark -</a>
<a name="ln283"> </a>
<a name="ln284"> </a>
<a name="ln285">// pass in pixelCount to maintain backward compatibility of setting</a>
<a name="ln286">// the pixelcount from the command line</a>
<a name="ln287">TApp::TApp(int32 pixelCount)</a>
<a name="ln288">	: BApplication(&quot;application/x-vnd.Haiku-Magnify&quot;)</a>
<a name="ln289">{</a>
<a name="ln290">	TWindow* magWindow = new TWindow(pixelCount);</a>
<a name="ln291">	magWindow-&gt;Show();</a>
<a name="ln292">}</a>
<a name="ln293"> </a>
<a name="ln294"> </a>
<a name="ln295">//	#pragma mark -</a>
<a name="ln296"> </a>
<a name="ln297"> </a>
<a name="ln298">TWindow::TWindow(int32 pixelCount)</a>
<a name="ln299">	:</a>
<a name="ln300">	BWindow(BRect(0, 0, 0, 0), B_TRANSLATE_SYSTEM_NAME(&quot;Magnify&quot;),</a>
<a name="ln301">		B_TITLED_WINDOW, B_OUTLINE_RESIZE)</a>
<a name="ln302">{</a>
<a name="ln303">	GetPrefs(pixelCount);</a>
<a name="ln304"> </a>
<a name="ln305">	// add info view</a>
<a name="ln306">	BRect infoRect(Bounds());</a>
<a name="ln307">	infoRect.InsetBy(-1, -1);</a>
<a name="ln308">	fInfo = new TInfoView(infoRect);</a>
<a name="ln309">	AddChild(fInfo);</a>
<a name="ln310"> </a>
<a name="ln311">	fFontHeight = FontHeight(fInfo, true);</a>
<a name="ln312">	fInfoHeight = (fFontHeight * 2) + (3 * 5);</a>
<a name="ln313"> </a>
<a name="ln314">	BRect fbRect(0, 0, (fHPixelCount*fPixelSize), (fHPixelCount*fPixelSize));</a>
<a name="ln315">	if (InfoIsShowing())</a>
<a name="ln316">		fbRect.OffsetBy(10, fInfoHeight);</a>
<a name="ln317">	fFatBits = new TMagnify(fbRect, this);</a>
<a name="ln318">	fInfo-&gt;AddChild(fFatBits);</a>
<a name="ln319"> </a>
<a name="ln320">	fFatBits-&gt;SetSelection(fShowInfo);</a>
<a name="ln321">	fInfo-&gt;SetMagView(fFatBits);</a>
<a name="ln322"> </a>
<a name="ln323">	ResizeWindow(fHPixelCount, fVPixelCount);</a>
<a name="ln324">	UpdateInfoBarOnResize();</a>
<a name="ln325"> </a>
<a name="ln326">	AddShortcut('S', B_COMMAND_KEY, new BMessage(msg_save));</a>
<a name="ln327">	AddShortcut('C', B_COMMAND_KEY, new BMessage(msg_copy_image));</a>
<a name="ln328">	AddShortcut('T', B_COMMAND_KEY, new BMessage(msg_show_info));</a>
<a name="ln329">	AddShortcut('H', B_COMMAND_KEY, new BMessage(msg_add_cross_hair));</a>
<a name="ln330">	AddShortcut('H', B_SHIFT_KEY, 	new BMessage(msg_remove_cross_hair));</a>
<a name="ln331">	AddShortcut('G', B_COMMAND_KEY, new BMessage(msg_toggle_grid));</a>
<a name="ln332">	AddShortcut('F', B_COMMAND_KEY, new BMessage(msg_freeze));</a>
<a name="ln333">	AddShortcut('I', B_COMMAND_KEY, new BMessage(msg_stick));</a>
<a name="ln334">	AddShortcut('-', B_COMMAND_KEY, new BMessage(msg_shrink));</a>
<a name="ln335">	AddShortcut('=', B_COMMAND_KEY, new BMessage(msg_grow));</a>
<a name="ln336">	AddShortcut('/', B_COMMAND_KEY, new BMessage(msg_make_square));</a>
<a name="ln337">	AddShortcut(',', B_COMMAND_KEY, new BMessage(msg_shrink_pixel));</a>
<a name="ln338">	AddShortcut('.', B_COMMAND_KEY, new BMessage(msg_grow_pixel));</a>
<a name="ln339">	AddShortcut(B_LEFT_ARROW, B_COMMAND_KEY, new BMessage(msg_mouse_left));</a>
<a name="ln340">	AddShortcut(B_RIGHT_ARROW, B_COMMAND_KEY, new BMessage(msg_mouse_right));</a>
<a name="ln341">	AddShortcut(B_UP_ARROW, B_COMMAND_KEY, new BMessage(msg_mouse_up));</a>
<a name="ln342">	AddShortcut(B_DOWN_ARROW, B_COMMAND_KEY, new BMessage(msg_mouse_down));</a>
<a name="ln343">}</a>
<a name="ln344"> </a>
<a name="ln345"> </a>
<a name="ln346">TWindow::~TWindow()</a>
<a name="ln347">{</a>
<a name="ln348">}</a>
<a name="ln349"> </a>
<a name="ln350"> </a>
<a name="ln351">status_t</a>
<a name="ln352">TWindow::GetSupportedSuites(BMessage* msg)</a>
<a name="ln353">{</a>
<a name="ln354">	msg-&gt;AddString(&quot;suites&quot;, &quot;suite/x-vnd.Haiku-Magnify&quot;);</a>
<a name="ln355"> </a>
<a name="ln356">	BPropertyInfo propertyInfo(sProperties);</a>
<a name="ln357">	msg-&gt;AddFlat(&quot;messages&quot;, &amp;propertyInfo);</a>
<a name="ln358"> </a>
<a name="ln359">	return BHandler::GetSupportedSuites(msg);</a>
<a name="ln360">}</a>
<a name="ln361"> </a>
<a name="ln362"> </a>
<a name="ln363">BHandler*</a>
<a name="ln364">TWindow::ResolveSpecifier(BMessage* msg, int32 index, BMessage* specifier,</a>
<a name="ln365">	int32 what, const char* property)</a>
<a name="ln366">{</a>
<a name="ln367">	BPropertyInfo propertyInfo(sProperties);</a>
<a name="ln368">	if (propertyInfo.FindMatch(msg, index, specifier, what, property) &gt;= 0)</a>
<a name="ln369">		return this;</a>
<a name="ln370"> </a>
<a name="ln371">	return BHandler::ResolveSpecifier(msg, index, specifier, what, property);</a>
<a name="ln372">}</a>
<a name="ln373"> </a>
<a name="ln374"> </a>
<a name="ln375">void</a>
<a name="ln376">TWindow::MessageReceived(BMessage* m)</a>
<a name="ln377">{</a>
<a name="ln378">	bool active = fFatBits-&gt;Active();</a>
<a name="ln379"> </a>
<a name="ln380">	switch (m-&gt;what) {</a>
<a name="ln381">		case B_EXECUTE_PROPERTY:</a>
<a name="ln382">		case B_GET_PROPERTY:</a>
<a name="ln383">		case B_SET_PROPERTY:</a>
<a name="ln384">		{</a>
<a name="ln385">			int32 index;</a>
<a name="ln386">			BMessage specifier;</a>
<a name="ln387">			int32 what;</a>
<a name="ln388">			const char* property;</a>
<a name="ln389">			if (m-&gt;GetCurrentSpecifier(&amp;index, &amp;specifier, &amp;what, &amp;property)</a>
<a name="ln390">				!= B_OK)</a>
<a name="ln391">				return BWindow::MessageReceived(m);</a>
<a name="ln392"> </a>
<a name="ln393">			status_t result = B_OK;</a>
<a name="ln394">			BMessage reply(B_REPLY);</a>
<a name="ln395"> </a>
<a name="ln396">			BPropertyInfo propertyInfo(sProperties);</a>
<a name="ln397">			switch (propertyInfo.FindMatch(m, index, &amp;specifier, what,</a>
<a name="ln398">						property)) {</a>
<a name="ln399">				case 0:</a>
<a name="ln400">					if (m-&gt;what == B_GET_PROPERTY)</a>
<a name="ln401">						result = reply.AddBool(&quot;result&quot;, fInfoBarState);</a>
<a name="ln402">					else if (m-&gt;what == B_SET_PROPERTY) {</a>
<a name="ln403">						bool showInfo;</a>
<a name="ln404">						result = m-&gt;FindBool(&quot;data&quot;, &amp;showInfo);</a>
<a name="ln405">						if (result == B_OK) {</a>
<a name="ln406">							fInfoBarState = showInfo;</a>
<a name="ln407">							ShowInfo(fInfoBarState);</a>
<a name="ln408">						}</a>
<a name="ln409">					}</a>
<a name="ln410">					break;</a>
<a name="ln411"> </a>
<a name="ln412">				case 1:</a>
<a name="ln413">					if (m-&gt;what == B_GET_PROPERTY)</a>
<a name="ln414">						result = reply.AddBool(&quot;result&quot;, fShowGrid);</a>
<a name="ln415">					else if (m-&gt;what == B_SET_PROPERTY) {</a>
<a name="ln416">						bool showGrid;</a>
<a name="ln417">						result = m-&gt;FindBool(&quot;data&quot;, &amp;showGrid);</a>
<a name="ln418">						if (result == B_OK)</a>
<a name="ln419">							SetGrid(showGrid);</a>
<a name="ln420">					}</a>
<a name="ln421">					break;</a>
<a name="ln422"> </a>
<a name="ln423">				case 2:</a>
<a name="ln424">					if (fHPixelCount != fVPixelCount) {</a>
<a name="ln425">						int32 big = fHPixelCount &gt; fVPixelCount ? fHPixelCount</a>
<a name="ln426">										: fVPixelCount;</a>
<a name="ln427">						ResizeWindow(big, big);</a>
<a name="ln428">					}</a>
<a name="ln429">					break;</a>
<a name="ln430"> </a>
<a name="ln431">				case 3:</a>
<a name="ln432">					if (m-&gt;what == B_GET_PROPERTY)</a>
<a name="ln433">						result = reply.AddInt32(&quot;result&quot;, fPixelSize);</a>
<a name="ln434">					else if (m-&gt;what == B_SET_PROPERTY) {</a>
<a name="ln435">						int32 zoom;</a>
<a name="ln436">						result = m-&gt;FindInt32(&quot;data&quot;, &amp;zoom);</a>
<a name="ln437">						if (result == B_OK)</a>
<a name="ln438">							SetPixelSize(zoom);</a>
<a name="ln439">					}</a>
<a name="ln440">					break;</a>
<a name="ln441"> </a>
<a name="ln442">				case 4:</a>
<a name="ln443">					if (m-&gt;what == B_GET_PROPERTY)</a>
<a name="ln444">						result = reply.AddBool(&quot;result&quot;, fFatBits-&gt;Sticked());</a>
<a name="ln445">					else if (m-&gt;what == B_SET_PROPERTY) {</a>
<a name="ln446">						bool stick;</a>
<a name="ln447">						result = m-&gt;FindBool(&quot;data&quot;, &amp;stick);</a>
<a name="ln448">						if (result == B_OK)</a>
<a name="ln449">							fFatBits-&gt;MakeSticked(stick);</a>
<a name="ln450">					}</a>
<a name="ln451">					break;</a>
<a name="ln452"> </a>
<a name="ln453">				case 5:</a>
<a name="ln454">					fFatBits-&gt;CopyImage();</a>
<a name="ln455">					break;</a>
<a name="ln456"> </a>
<a name="ln457">				default:</a>
<a name="ln458">					return BWindow::MessageReceived(m);</a>
<a name="ln459">			}</a>
<a name="ln460"> </a>
<a name="ln461">			if (result != B_OK) {</a>
<a name="ln462">				reply.what = B_MESSAGE_NOT_UNDERSTOOD;</a>
<a name="ln463">				reply.AddString(&quot;message&quot;, strerror(result));</a>
<a name="ln464">				reply.AddInt32(&quot;error&quot;, result);</a>
<a name="ln465">			}</a>
<a name="ln466"> </a>
<a name="ln467">			m-&gt;SendReply(&amp;reply);</a>
<a name="ln468">			break;</a>
<a name="ln469">		}</a>
<a name="ln470"> </a>
<a name="ln471">		case msg_show_info:</a>
<a name="ln472">			if (active) {</a>
<a name="ln473">				fInfoBarState = !fInfoBarState;</a>
<a name="ln474">				ShowInfo(!fShowInfo);</a>
<a name="ln475">			}</a>
<a name="ln476">			break;</a>
<a name="ln477"> </a>
<a name="ln478">		case msg_toggle_grid:</a>
<a name="ln479">			if (active)</a>
<a name="ln480">				SetGrid(!fShowGrid);</a>
<a name="ln481">			break;</a>
<a name="ln482"> </a>
<a name="ln483">		case msg_grow:</a>
<a name="ln484">			if (active)</a>
<a name="ln485">				ResizeWindow(true);</a>
<a name="ln486">			break;</a>
<a name="ln487">		case msg_shrink:</a>
<a name="ln488">			if (active)</a>
<a name="ln489">				ResizeWindow(false);</a>
<a name="ln490">			break;</a>
<a name="ln491">		case msg_make_square:</a>
<a name="ln492">			if (active) {</a>
<a name="ln493">				if (fHPixelCount == fVPixelCount)</a>
<a name="ln494">					break;</a>
<a name="ln495">				int32 big = (fHPixelCount &gt; fVPixelCount) ? fHPixelCount : fVPixelCount;</a>
<a name="ln496">				ResizeWindow(big, big);</a>
<a name="ln497">			}</a>
<a name="ln498">			break;</a>
<a name="ln499"> </a>
<a name="ln500">		case msg_shrink_pixel:</a>
<a name="ln501">			if (active)</a>
<a name="ln502">				SetPixelSize(false);</a>
<a name="ln503">			break;</a>
<a name="ln504">		case msg_grow_pixel:</a>
<a name="ln505">			if (active)</a>
<a name="ln506">				SetPixelSize(true);</a>
<a name="ln507">			break;</a>
<a name="ln508"> </a>
<a name="ln509">		case msg_mouse_left:</a>
<a name="ln510">			if (active)</a>
<a name="ln511">				fFatBits-&gt;NudgeMouse(-1, 0);</a>
<a name="ln512">			break;</a>
<a name="ln513">		case msg_mouse_right:</a>
<a name="ln514">			if (active)</a>
<a name="ln515">				fFatBits-&gt;NudgeMouse(1, 0);</a>
<a name="ln516">			break;</a>
<a name="ln517">		case msg_mouse_up:</a>
<a name="ln518">			if (active)</a>
<a name="ln519">				fFatBits-&gt;NudgeMouse(0, -1);</a>
<a name="ln520">			break;</a>
<a name="ln521">		case msg_mouse_down:</a>
<a name="ln522">			if (active)</a>
<a name="ln523">				fFatBits-&gt;NudgeMouse(0, 1);</a>
<a name="ln524">			break;</a>
<a name="ln525"> </a>
<a name="ln526">		case msg_add_cross_hair:</a>
<a name="ln527">			if (active &amp;&amp; fShowInfo)</a>
<a name="ln528">				AddCrossHair();</a>
<a name="ln529">			break;</a>
<a name="ln530">		case msg_remove_cross_hair:</a>
<a name="ln531">			if (active &amp;&amp; fShowInfo)</a>
<a name="ln532">				RemoveCrossHair();</a>
<a name="ln533">			break;</a>
<a name="ln534"> </a>
<a name="ln535">		case msg_freeze:</a>
<a name="ln536">			if (active)</a>
<a name="ln537">				SetFlags(B_OUTLINE_RESIZE | B_NOT_ZOOMABLE | B_NOT_RESIZABLE);</a>
<a name="ln538">			else</a>
<a name="ln539">				SetFlags(B_OUTLINE_RESIZE | B_NOT_ZOOMABLE);</a>
<a name="ln540"> </a>
<a name="ln541">			fFatBits-&gt;MakeActive(!fFatBits-&gt;Active());</a>
<a name="ln542">			break;</a>
<a name="ln543"> </a>
<a name="ln544">		case msg_stick:</a>
<a name="ln545">			fFatBits-&gt;MakeSticked(!fFatBits-&gt;Sticked());</a>
<a name="ln546">			break;</a>
<a name="ln547"> </a>
<a name="ln548">		case msg_save: {</a>
<a name="ln549">			// freeze the image here, unfreeze after dump or cancel</a>
<a name="ln550">			fFatBits-&gt;StartSave();</a>
<a name="ln551"> </a>
<a name="ln552">			BMessenger messenger(this);</a>
<a name="ln553">			BMessage message(msg_dump);</a>
<a name="ln554">			fSavePanel = new BFilePanel(B_SAVE_PANEL, &amp;messenger, 0, 0, false,</a>
<a name="ln555">				&amp;message);</a>
<a name="ln556">			fSavePanel-&gt;SetSaveText(&quot;Bitmaps.png&quot;);</a>
<a name="ln557">			fSavePanel-&gt;Show();</a>
<a name="ln558">		}	break;</a>
<a name="ln559">		case msg_dump:</a>
<a name="ln560">			{</a>
<a name="ln561">				delete fSavePanel;</a>
<a name="ln562"> </a>
<a name="ln563">				entry_ref dirRef;</a>
<a name="ln564">				char* name;</a>
<a name="ln565">				m-&gt;FindRef(&quot;directory&quot;, &amp;dirRef);</a>
<a name="ln566">				m-&gt;FindString((const char*)&quot;name&quot;,(const char**) &amp;name);</a>
<a name="ln567"> </a>
<a name="ln568">				fFatBits-&gt;SaveImage(&amp;dirRef, name);</a>
<a name="ln569">			}</a>
<a name="ln570">			break;</a>
<a name="ln571">		case B_CANCEL:</a>
<a name="ln572">			//	image is frozen before the FilePanel is shown</a>
<a name="ln573">			fFatBits-&gt;EndSave();</a>
<a name="ln574">			break;</a>
<a name="ln575"> </a>
<a name="ln576">		case msg_copy_image:</a>
<a name="ln577">			fFatBits-&gt;CopyImage();</a>
<a name="ln578">			break;</a>
<a name="ln579">		default:</a>
<a name="ln580">			BWindow::MessageReceived(m);</a>
<a name="ln581">			break;</a>
<a name="ln582">	}</a>
<a name="ln583">}</a>
<a name="ln584"> </a>
<a name="ln585"> </a>
<a name="ln586">bool</a>
<a name="ln587">TWindow::QuitRequested()</a>
<a name="ln588">{</a>
<a name="ln589">	SetPrefs();</a>
<a name="ln590">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln591">	return true;</a>
<a name="ln592">}</a>
<a name="ln593"> </a>
<a name="ln594"> </a>
<a name="ln595">void</a>
<a name="ln596">TWindow::GetPrefs(int32 overridePixelCount)</a>
<a name="ln597">{</a>
<a name="ln598">	BPath path;</a>
<a name="ln599">	char name[8];</a>
<a name="ln600">	float version;</a>
<a name="ln601">	bool haveLoc=false;</a>
<a name="ln602">	BPoint loc;</a>
<a name="ln603">	bool showGrid = kDefaultShowGrid;</a>
<a name="ln604">	bool showInfo = kDefaultShowInfo;</a>
<a name="ln605">	bool ch1Showing=false;</a>
<a name="ln606">	bool ch2Showing=false;</a>
<a name="ln607">	int32 hPixelCount = kDefaultPixelCount;</a>
<a name="ln608">	int32 vPixelCount = kDefaultPixelCount;</a>
<a name="ln609">	int32 pixelSize = kDefaultPixelSize;</a>
<a name="ln610"> </a>
<a name="ln611">	if (find_directory (B_USER_SETTINGS_DIRECTORY, &amp;path) == B_OK) {</a>
<a name="ln612">		int ref = -1;</a>
<a name="ln613">		path.Append(kPrefsFileName);</a>
<a name="ln614">		if ((ref = open(path.Path(), 0)) &gt;= 0) {</a>
<a name="ln615">			if (read(ref, name, 7) != 7)</a>
<a name="ln616">				goto ALMOST_DONE;</a>
<a name="ln617"> </a>
<a name="ln618">			name[7] = 0;</a>
<a name="ln619">			if (strcmp(name, kAppName) != 0)</a>
<a name="ln620">				goto ALMOST_DONE;</a>
<a name="ln621"> </a>
<a name="ln622">			read(ref, &amp;version, sizeof(float));</a>
<a name="ln623"> </a>
<a name="ln624">			if (read(ref, &amp;loc, sizeof(BPoint)) != sizeof(BPoint))</a>
<a name="ln625">				goto ALMOST_DONE;</a>
<a name="ln626">			else</a>
<a name="ln627">				haveLoc = true;</a>
<a name="ln628"> </a>
<a name="ln629">			if (read(ref, &amp;showGrid, sizeof(bool)) != sizeof(bool)) {</a>
<a name="ln630">				showGrid = kDefaultShowGrid;</a>
<a name="ln631">				goto ALMOST_DONE;</a>
<a name="ln632">			}</a>
<a name="ln633"> </a>
<a name="ln634">			if (read(ref, &amp;showInfo, sizeof(bool)) != sizeof(bool)) {</a>
<a name="ln635">				showInfo = kDefaultShowInfo;</a>
<a name="ln636">				goto ALMOST_DONE;</a>
<a name="ln637">			}</a>
<a name="ln638"> </a>
<a name="ln639">			if (read(ref, &amp;ch1Showing, sizeof(bool)) != sizeof(bool)) {</a>
<a name="ln640">				ch1Showing = false;</a>
<a name="ln641">				goto ALMOST_DONE;</a>
<a name="ln642">			}</a>
<a name="ln643"> </a>
<a name="ln644">			if (read(ref, &amp;ch2Showing, sizeof(bool)) != sizeof(bool)) {</a>
<a name="ln645">				ch2Showing = false;</a>
<a name="ln646">				goto ALMOST_DONE;</a>
<a name="ln647">			}</a>
<a name="ln648"> </a>
<a name="ln649">			if (read(ref, &amp;hPixelCount, sizeof(int32)) != sizeof(int32)) {</a>
<a name="ln650">				hPixelCount = kDefaultPixelCount;</a>
<a name="ln651">				goto ALMOST_DONE;</a>
<a name="ln652">			}</a>
<a name="ln653">			if (read(ref, &amp;vPixelCount, sizeof(int32)) != sizeof(int32)) {</a>
<a name="ln654">				vPixelCount = kDefaultPixelCount;</a>
<a name="ln655">				goto ALMOST_DONE;</a>
<a name="ln656">			}</a>
<a name="ln657"> </a>
<a name="ln658">			if (read(ref, &amp;pixelSize, sizeof(int32)) != sizeof(int32)) {</a>
<a name="ln659">				pixelSize = kDefaultPixelSize;</a>
<a name="ln660">				goto ALMOST_DONE;</a>
<a name="ln661">			}</a>
<a name="ln662"> </a>
<a name="ln663">ALMOST_DONE:	//	clean up and try to position the window</a>
<a name="ln664">			close(ref);</a>
<a name="ln665"> </a>
<a name="ln666">			if (haveLoc &amp;&amp; BScreen(B_MAIN_SCREEN_ID).Frame().Contains(loc)) {</a>
<a name="ln667">				MoveTo(loc);</a>
<a name="ln668">				goto DONE;</a>
<a name="ln669">			}</a>
<a name="ln670">		}</a>
<a name="ln671">	}</a>
<a name="ln672"> </a>
<a name="ln673">	// 	if prefs dont yet exist or the window is not onscreen, center the window</a>
<a name="ln674">	CenterOnScreen();</a>
<a name="ln675"> </a>
<a name="ln676">	//	set all the settings to defaults if we get here</a>
<a name="ln677">DONE:</a>
<a name="ln678">	fShowGrid = showGrid;</a>
<a name="ln679">	fShowInfo = showInfo;</a>
<a name="ln680">	fInfoBarState = showInfo;</a>
<a name="ln681">	fHPixelCount = (overridePixelCount == -1) ? hPixelCount : overridePixelCount;</a>
<a name="ln682">	fVPixelCount = (overridePixelCount == -1) ? vPixelCount : overridePixelCount;</a>
<a name="ln683">	fPixelSize = pixelSize;</a>
<a name="ln684">}</a>
<a name="ln685"> </a>
<a name="ln686"> </a>
<a name="ln687">void</a>
<a name="ln688">TWindow::SetPrefs()</a>
<a name="ln689">{</a>
<a name="ln690">	BPath path;</a>
<a name="ln691"> </a>
<a name="ln692">	if (find_directory (B_USER_SETTINGS_DIRECTORY, &amp;path, true) == B_OK) {</a>
<a name="ln693">		long ref;</a>
<a name="ln694"> </a>
<a name="ln695">		path.Append (kPrefsFileName);</a>
<a name="ln696">		if ((ref = creat(path.Path(), S_IRUSR | S_IWUSR)) &gt;= 0) {</a>
<a name="ln697">			float version = kCurrentVersion;</a>
<a name="ln698"> </a>
<a name="ln699">			lseek (ref, 0, SEEK_SET);</a>
<a name="ln700">			write(ref, kAppName, 7);</a>
<a name="ln701">			write(ref, &amp;version, sizeof(float));</a>
<a name="ln702"> </a>
<a name="ln703">			BPoint loc = Frame().LeftTop();</a>
<a name="ln704">			write(ref, &amp;loc, sizeof(BPoint));</a>
<a name="ln705"> </a>
<a name="ln706">			write(ref, &amp;fShowGrid, sizeof(bool));</a>
<a name="ln707">			write(ref, &amp;fShowInfo, sizeof(bool));</a>
<a name="ln708">			bool ch1, ch2;</a>
<a name="ln709">			CrossHairsShowing(&amp;ch1, &amp;ch2);</a>
<a name="ln710">			write(ref, &amp;ch1, sizeof(bool));</a>
<a name="ln711">			write(ref, &amp;ch2, sizeof(bool));</a>
<a name="ln712"> </a>
<a name="ln713">			write(ref, &amp;fHPixelCount, sizeof(int32));</a>
<a name="ln714">			write(ref, &amp;fVPixelCount, sizeof(int32));</a>
<a name="ln715">			write(ref, &amp;fPixelSize, sizeof(int32));</a>
<a name="ln716"> </a>
<a name="ln717">			close(ref);</a>
<a name="ln718">		}</a>
<a name="ln719">	}</a>
<a name="ln720">}</a>
<a name="ln721"> </a>
<a name="ln722"> </a>
<a name="ln723">void</a>
<a name="ln724">TWindow::FrameResized(float w, float h)</a>
<a name="ln725">{</a>
<a name="ln726">	CalcViewablePixels();</a>
<a name="ln727">	fFatBits-&gt;InitBuffers(fHPixelCount, fVPixelCount, fPixelSize, ShowGrid());</a>
<a name="ln728">	UpdateInfoBarOnResize();</a>
<a name="ln729">}</a>
<a name="ln730"> </a>
<a name="ln731"> </a>
<a name="ln732">void</a>
<a name="ln733">TWindow::ScreenChanged(BRect screenSize, color_space depth)</a>
<a name="ln734">{</a>
<a name="ln735">	BWindow::ScreenChanged(screenSize, depth);</a>
<a name="ln736">	// reset all bitmaps</a>
<a name="ln737">	fFatBits-&gt;ScreenChanged(screenSize,depth);</a>
<a name="ln738">}</a>
<a name="ln739"> </a>
<a name="ln740"> </a>
<a name="ln741">void</a>
<a name="ln742">TWindow::Minimize(bool m)</a>
<a name="ln743">{</a>
<a name="ln744">	BWindow::Minimize(m);</a>
<a name="ln745">}</a>
<a name="ln746"> </a>
<a name="ln747"> </a>
<a name="ln748">void</a>
<a name="ln749">TWindow::Zoom(BPoint /*position*/, float /*width*/, float /*height*/)</a>
<a name="ln750">{</a>
<a name="ln751">	if (fFatBits-&gt;Active())</a>
<a name="ln752">		ShowInfo(!fShowInfo);</a>
<a name="ln753">}</a>
<a name="ln754"> </a>
<a name="ln755"> </a>
<a name="ln756">void</a>
<a name="ln757">TWindow::CalcViewablePixels()</a>
<a name="ln758">{</a>
<a name="ln759">	float w = Bounds().Width();</a>
<a name="ln760">	float h = Bounds().Height();</a>
<a name="ln761"> </a>
<a name="ln762">	if (InfoIsShowing()) {</a>
<a name="ln763">		w -= 20;							// remove the gutter</a>
<a name="ln764">		h = h-fInfoHeight-10;				// remove info and gutter</a>
<a name="ln765">	}</a>
<a name="ln766"> </a>
<a name="ln767">	bool ch1, ch2;</a>
<a name="ln768">	fFatBits-&gt;CrossHairsShowing(&amp;ch1, &amp;ch2);</a>
<a name="ln769">	if (ch1)</a>
<a name="ln770">		h -= fFontHeight;</a>
<a name="ln771">	if (ch2)</a>
<a name="ln772">		h -= fFontHeight + 5;</a>
<a name="ln773"> </a>
<a name="ln774">	fHPixelCount = (int32)w / fPixelSize;			// calc h pixels</a>
<a name="ln775">	if (fHPixelCount &lt; 16)</a>
<a name="ln776">		fHPixelCount = 16;</a>
<a name="ln777"> </a>
<a name="ln778">	fVPixelCount = (int32)h / fPixelSize;			// calc v pixels</a>
<a name="ln779">	if (fVPixelCount &lt; 4)</a>
<a name="ln780">		fVPixelCount = 4;</a>
<a name="ln781">}</a>
<a name="ln782"> </a>
<a name="ln783"> </a>
<a name="ln784">void</a>
<a name="ln785">TWindow::GetPreferredSize(float* width, float* height)</a>
<a name="ln786">{</a>
<a name="ln787">	*width = fHPixelCount * fPixelSize;			// calc window width</a>
<a name="ln788">	*height = fVPixelCount * fPixelSize;		// calc window height</a>
<a name="ln789">	if (InfoIsShowing()) {</a>
<a name="ln790">		*width += 20;</a>
<a name="ln791">		*height += fInfoHeight + 10;</a>
<a name="ln792">	}</a>
<a name="ln793"> </a>
<a name="ln794">	bool ch1, ch2;</a>
<a name="ln795">	fFatBits-&gt;CrossHairsShowing(&amp;ch1, &amp;ch2);</a>
<a name="ln796">	if (ch1)</a>
<a name="ln797">		*height += fFontHeight;</a>
<a name="ln798">	if (ch2)</a>
<a name="ln799">		*height += fFontHeight + 5;</a>
<a name="ln800">}</a>
<a name="ln801"> </a>
<a name="ln802"> </a>
<a name="ln803">void</a>
<a name="ln804">TWindow::ResizeWindow(int32 hPixelCount, int32 vPixelCount)</a>
<a name="ln805">{</a>
<a name="ln806">	fHPixelCount = hPixelCount;</a>
<a name="ln807">	fVPixelCount = vPixelCount;</a>
<a name="ln808"> </a>
<a name="ln809">	float width, height;</a>
<a name="ln810">	GetPreferredSize(&amp;width, &amp;height);</a>
<a name="ln811"> </a>
<a name="ln812">	ResizeTo(width, height);</a>
<a name="ln813">}</a>
<a name="ln814"> </a>
<a name="ln815"> </a>
<a name="ln816">void</a>
<a name="ln817">TWindow::ResizeWindow(bool direction)</a>
<a name="ln818">{</a>
<a name="ln819">	int32 x = fHPixelCount;</a>
<a name="ln820">	int32 y = fVPixelCount;</a>
<a name="ln821"> </a>
<a name="ln822">	if (direction) {</a>
<a name="ln823">		x += 4;</a>
<a name="ln824">		y += 4;</a>
<a name="ln825">	} else {</a>
<a name="ln826">		x -= 4;</a>
<a name="ln827">		y -= 4;</a>
<a name="ln828">	}</a>
<a name="ln829"> </a>
<a name="ln830">	if (x &lt; 4)</a>
<a name="ln831">		x = 4;</a>
<a name="ln832"> </a>
<a name="ln833">	if (y &lt; 4)</a>
<a name="ln834">		y = 4;</a>
<a name="ln835"> </a>
<a name="ln836">	ResizeWindow(x, y);</a>
<a name="ln837">}</a>
<a name="ln838"> </a>
<a name="ln839"> </a>
<a name="ln840">void</a>
<a name="ln841">TWindow::SetGrid(bool s)</a>
<a name="ln842">{</a>
<a name="ln843">	if (s == fShowGrid)</a>
<a name="ln844">		return;</a>
<a name="ln845"> </a>
<a name="ln846">	fShowGrid = s;</a>
<a name="ln847">	fFatBits-&gt;SetUpdate(true);</a>
<a name="ln848">}</a>
<a name="ln849"> </a>
<a name="ln850"> </a>
<a name="ln851">bool</a>
<a name="ln852">TWindow::ShowGrid()</a>
<a name="ln853">{</a>
<a name="ln854">	return fShowGrid;</a>
<a name="ln855">}</a>
<a name="ln856"> </a>
<a name="ln857"> </a>
<a name="ln858">void</a>
<a name="ln859">TWindow::ShowInfo(bool i)</a>
<a name="ln860">{</a>
<a name="ln861">	if (i == fShowInfo)</a>
<a name="ln862">		return;</a>
<a name="ln863"> </a>
<a name="ln864">	fShowInfo = i;</a>
<a name="ln865"> </a>
<a name="ln866">	if (fShowInfo)</a>
<a name="ln867">		fFatBits-&gt;MoveTo(10, fInfoHeight);</a>
<a name="ln868">	else {</a>
<a name="ln869">		fFatBits-&gt;MoveTo(1,1);</a>
<a name="ln870">		fFatBits-&gt;SetCrossHairsShowing(false, false);</a>
<a name="ln871">	}</a>
<a name="ln872"> </a>
<a name="ln873">	fFatBits-&gt;SetSelection(fShowInfo);</a>
<a name="ln874">	ResizeWindow(fHPixelCount, fVPixelCount);</a>
<a name="ln875">	fInfo-&gt;SetInfoTextVisible(i);</a>
<a name="ln876">}</a>
<a name="ln877"> </a>
<a name="ln878"> </a>
<a name="ln879">bool</a>
<a name="ln880">TWindow::InfoIsShowing()</a>
<a name="ln881">{</a>
<a name="ln882">	return fShowInfo;</a>
<a name="ln883">}</a>
<a name="ln884"> </a>
<a name="ln885"> </a>
<a name="ln886">bool</a>
<a name="ln887">TWindow::InfoBarIsVisible()</a>
<a name="ln888">{</a>
<a name="ln889">	return fInfoBarState;</a>
<a name="ln890">}</a>
<a name="ln891"> </a>
<a name="ln892"> </a>
<a name="ln893">void</a>
<a name="ln894">TWindow::UpdateInfo()</a>
<a name="ln895">{</a>
<a name="ln896">	fInfo-&gt;Invalidate();</a>
<a name="ln897">}</a>
<a name="ln898"> </a>
<a name="ln899"> </a>
<a name="ln900">void</a>
<a name="ln901">TWindow::UpdateInfoBarOnResize()</a>
<a name="ln902">{</a>
<a name="ln903">	float infoWidth, infoHeight;</a>
<a name="ln904">	fInfo-&gt;GetPreferredSize(&amp;infoWidth, &amp;infoHeight);</a>
<a name="ln905"> </a>
<a name="ln906">	if (infoWidth &gt; Bounds().Width()</a>
<a name="ln907">		|| infoHeight &gt; Bounds().Height()) {</a>
<a name="ln908">		ShowInfo(false);</a>
<a name="ln909">	} else {</a>
<a name="ln910">		ShowInfo(fInfoBarState);</a>
<a name="ln911">	}</a>
<a name="ln912">}</a>
<a name="ln913"> </a>
<a name="ln914"> </a>
<a name="ln915">void</a>
<a name="ln916">TWindow::AddCrossHair()</a>
<a name="ln917">{</a>
<a name="ln918">	fFatBits-&gt;AddCrossHair();</a>
<a name="ln919"> </a>
<a name="ln920">	// crosshair info needs to be added</a>
<a name="ln921">	// window resizes accordingly</a>
<a name="ln922">	float width;</a>
<a name="ln923">	float height;</a>
<a name="ln924">	GetPreferredSize(&amp;width, &amp;height);</a>
<a name="ln925">	ResizeTo(width, height);</a>
<a name="ln926">}</a>
<a name="ln927"> </a>
<a name="ln928"> </a>
<a name="ln929">void</a>
<a name="ln930">TWindow::RemoveCrossHair()</a>
<a name="ln931">{</a>
<a name="ln932">	fFatBits-&gt;RemoveCrossHair();</a>
<a name="ln933"> </a>
<a name="ln934">	//	crosshair info needs to be removed</a>
<a name="ln935">	//	window resizes accordingly</a>
<a name="ln936">	float width;</a>
<a name="ln937">	float height;</a>
<a name="ln938">	GetPreferredSize(&amp;width, &amp;height);</a>
<a name="ln939">	ResizeTo(width, height);</a>
<a name="ln940">}</a>
<a name="ln941"> </a>
<a name="ln942"> </a>
<a name="ln943">void</a>
<a name="ln944">TWindow::CrossHairsShowing(bool* ch1, bool* ch2)</a>
<a name="ln945">{</a>
<a name="ln946">	fFatBits-&gt;CrossHairsShowing(ch1, ch2);</a>
<a name="ln947">}</a>
<a name="ln948"> </a>
<a name="ln949"> </a>
<a name="ln950">void</a>
<a name="ln951">TWindow::PixelCount(int32* h, int32 *v)</a>
<a name="ln952">{</a>
<a name="ln953">	*h = fHPixelCount;</a>
<a name="ln954">	*v = fVPixelCount;</a>
<a name="ln955">}</a>
<a name="ln956"> </a>
<a name="ln957"> </a>
<a name="ln958">void</a>
<a name="ln959">TWindow::SetPixelSize(int32 s)</a>
<a name="ln960">{</a>
<a name="ln961">	if (s &gt; 100)</a>
<a name="ln962">		s = 100;</a>
<a name="ln963">	else if (s &lt; 1)</a>
<a name="ln964">		s = 1;</a>
<a name="ln965"> </a>
<a name="ln966">	if (s == fPixelSize)</a>
<a name="ln967">		return;</a>
<a name="ln968"> </a>
<a name="ln969">	fPixelSize = s;</a>
<a name="ln970">	// resize window</a>
<a name="ln971">	// tell info that size has changed</a>
<a name="ln972">	// tell mag that size has changed</a>
<a name="ln973"> </a>
<a name="ln974">	float w = Bounds().Width();</a>
<a name="ln975">	float h = Bounds().Height();</a>
<a name="ln976">	CalcViewablePixels();</a>
<a name="ln977">	ResizeWindow(fHPixelCount, fVPixelCount);</a>
<a name="ln978"> </a>
<a name="ln979">	//	the window might not actually change in size</a>
<a name="ln980">	//	in that case force the buffers to the new dimension</a>
<a name="ln981">	if (w == Bounds().Width() &amp;&amp; h == Bounds().Height())</a>
<a name="ln982">		fFatBits-&gt;InitBuffers(fHPixelCount, fVPixelCount, fPixelSize, ShowGrid());</a>
<a name="ln983">}</a>
<a name="ln984"> </a>
<a name="ln985"> </a>
<a name="ln986">void</a>
<a name="ln987">TWindow::SetPixelSize(bool plus)</a>
<a name="ln988">{</a>
<a name="ln989">	int32 pixelSize;</a>
<a name="ln990"> </a>
<a name="ln991">	if (plus) {</a>
<a name="ln992">		if (fPixelSize &gt;= 16)</a>
<a name="ln993">			return;</a>
<a name="ln994"> </a>
<a name="ln995">		pixelSize = fPixelSize + 1;</a>
<a name="ln996">	} else {</a>
<a name="ln997">		pixelSize = fPixelSize / 2;</a>
<a name="ln998"> </a>
<a name="ln999">		if (pixelSize &lt; 16) {</a>
<a name="ln1000">			if (fPixelSize &gt; 16)</a>
<a name="ln1001">				pixelSize = (fPixelSize + 16) / 2;</a>
<a name="ln1002">			else</a>
<a name="ln1003">				pixelSize = fPixelSize - 1;</a>
<a name="ln1004">		}</a>
<a name="ln1005">	}</a>
<a name="ln1006"> </a>
<a name="ln1007">	SetPixelSize(pixelSize);</a>
<a name="ln1008">}</a>
<a name="ln1009"> </a>
<a name="ln1010"> </a>
<a name="ln1011">int32</a>
<a name="ln1012">TWindow::PixelSize()</a>
<a name="ln1013">{</a>
<a name="ln1014">	return fPixelSize;</a>
<a name="ln1015">}</a>
<a name="ln1016"> </a>
<a name="ln1017"> </a>
<a name="ln1018">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln1019">#define B_TRANSLATION_CONTEXT &quot;Magnify-Main&quot;</a>
<a name="ln1020"> </a>
<a name="ln1021"> </a>
<a name="ln1022">bool</a>
<a name="ln1023">TWindow::IsActive()</a>
<a name="ln1024">{</a>
<a name="ln1025">	return fFatBits-&gt;Active();</a>
<a name="ln1026">}</a>
<a name="ln1027"> </a>
<a name="ln1028"> </a>
<a name="ln1029">bool</a>
<a name="ln1030">TWindow::IsSticked()</a>
<a name="ln1031">{</a>
<a name="ln1032">	return fFatBits-&gt;Sticked();</a>
<a name="ln1033">}</a>
<a name="ln1034"> </a>
<a name="ln1035"> </a>
<a name="ln1036">//	#pragma mark -</a>
<a name="ln1037"> </a>
<a name="ln1038"> </a>
<a name="ln1039">TInfoView::TInfoView(BRect frame)</a>
<a name="ln1040">	: BBox(frame, &quot;rgb&quot;, B_FOLLOW_ALL,</a>
<a name="ln1041">		B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE | B_FRAME_EVENTS,</a>
<a name="ln1042">		B_NO_BORDER)</a>
<a name="ln1043">{</a>
<a name="ln1044">	SetFont(be_plain_font);</a>
<a name="ln1045">	fFontHeight = FontHeight(this, true);</a>
<a name="ln1046">	fMagView = NULL;</a>
<a name="ln1047"> </a>
<a name="ln1048">	fSelectionColor = kBlack;</a>
<a name="ln1049">	fCH1Loc.x = fCH1Loc.y = fCH2Loc.x = fCH2Loc.y = 0;</a>
<a name="ln1050"> </a>
<a name="ln1051">	fInfoStr[0] = 0;</a>
<a name="ln1052">	fRGBStr[0] = 0;</a>
<a name="ln1053">	fCH1Str[0] = 0;</a>
<a name="ln1054">	fCH2Str[0] = 0;</a>
<a name="ln1055"> </a>
<a name="ln1056">	fInfoTextVisible = true;</a>
<a name="ln1057">}</a>
<a name="ln1058"> </a>
<a name="ln1059"> </a>
<a name="ln1060">TInfoView::~TInfoView()</a>
<a name="ln1061">{</a>
<a name="ln1062">}</a>
<a name="ln1063"> </a>
<a name="ln1064"> </a>
<a name="ln1065">void</a>
<a name="ln1066">TInfoView::AttachedToWindow()</a>
<a name="ln1067">{</a>
<a name="ln1068">	BBox::AttachedToWindow();</a>
<a name="ln1069">	SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln1070">	dynamic_cast&lt;TWindow*&gt;(Window())-&gt;PixelCount(&amp;fHPixelCount, &amp;fVPixelCount);</a>
<a name="ln1071">	fPixelSize = dynamic_cast&lt;TWindow*&gt;(Window())-&gt;PixelSize();</a>
<a name="ln1072"> </a>
<a name="ln1073">	AddMenu();</a>
<a name="ln1074">}</a>
<a name="ln1075"> </a>
<a name="ln1076"> </a>
<a name="ln1077">void</a>
<a name="ln1078">TInfoView::Draw(BRect updateRect)</a>
<a name="ln1079">{</a>
<a name="ln1080">	PushState();</a>
<a name="ln1081">	SetLowColor(ViewColor());</a>
<a name="ln1082"> </a>
<a name="ln1083">	BRect invalRect;</a>
<a name="ln1084"> </a>
<a name="ln1085">	int32 hPixelCount, vPixelCount;</a>
<a name="ln1086">	dynamic_cast&lt;TWindow*&gt;(Window())-&gt;PixelCount(&amp;hPixelCount, &amp;vPixelCount);</a>
<a name="ln1087">	int32 pixelSize = dynamic_cast&lt;TWindow*&gt;(Window())-&gt;PixelSize();</a>
<a name="ln1088"> </a>
<a name="ln1089">	MovePenTo(15 + fPopUp-&gt;Bounds().Width(), fFontHeight + 5);</a>
<a name="ln1090"> </a>
<a name="ln1091">	static BStringFormat format(B_TRANSLATE(&quot;%width x %height  @ {0, plural, &quot;</a>
<a name="ln1092">		&quot;one{# pixel/pixel} other{# pixels/pixel}}&quot;));</a>
<a name="ln1093"> </a>
<a name="ln1094">	BString dimensionsInfo;</a>
<a name="ln1095">	format.Format(dimensionsInfo, pixelSize);</a>
<a name="ln1096"> </a>
<a name="ln1097">	BString rep;</a>
<a name="ln1098">	rep &lt;&lt; hPixelCount;</a>
<a name="ln1099">	dimensionsInfo.ReplaceAll(&quot;%width&quot;, rep);</a>
<a name="ln1100">	rep = &quot;&quot;;</a>
<a name="ln1101">	rep &lt;&lt; vPixelCount;</a>
<a name="ln1102">	dimensionsInfo.ReplaceAll(&quot;%height&quot;, rep);</a>
<a name="ln1103"> </a>
<a name="ln1104">	invalRect.Set(10, 5, 10 + StringWidth(fInfoStr), fFontHeight+7);</a>
<a name="ln1105">	SetHighColor(ViewColor());</a>
<a name="ln1106">	FillRect(invalRect);</a>
<a name="ln1107">	SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln1108">	strcpy(fInfoStr, dimensionsInfo);</a>
<a name="ln1109">	if (fInfoTextVisible)</a>
<a name="ln1110">		DrawString(fInfoStr);</a>
<a name="ln1111"> </a>
<a name="ln1112">	rgb_color color = { 0, 0, 0, 255 };</a>
<a name="ln1113">	if (fMagView)</a>
<a name="ln1114">		color = fMagView-&gt;SelectionColor();</a>
<a name="ln1115">	char str[64];</a>
<a name="ln1116">	snprintf(str, sizeof(str), &quot;R: %i G: %i B: %i (#%02x%02x%02x)&quot;,</a>
<a name="ln1117">		color.red, color.green, color.blue, color.red, color.green, color.blue);</a>
<a name="ln1118"> </a>
<a name="ln1119">	MovePenTo(15 + fPopUp-&gt;Bounds().Width(), fFontHeight*2+5);</a>
<a name="ln1120">	invalRect.Set(10, fFontHeight+7, 10 + StringWidth(fRGBStr), fFontHeight*2+7);</a>
<a name="ln1121">	SetHighColor(ViewColor());</a>
<a name="ln1122">	FillRect(invalRect);</a>
<a name="ln1123">	SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln1124">	strcpy(fRGBStr,str);</a>
<a name="ln1125">	if (fInfoTextVisible)</a>
<a name="ln1126">		DrawString(fRGBStr);</a>
<a name="ln1127"> </a>
<a name="ln1128">	bool ch1Showing, ch2Showing;</a>
<a name="ln1129">	dynamic_cast&lt;TWindow*&gt;(Window())-&gt;CrossHairsShowing(&amp;ch1Showing, &amp;ch2Showing);</a>
<a name="ln1130"> </a>
<a name="ln1131">	if (fMagView) {</a>
<a name="ln1132">		BPoint pt1(fMagView-&gt;CrossHair1Loc());</a>
<a name="ln1133">		BPoint pt2(fMagView-&gt;CrossHair2Loc());</a>
<a name="ln1134"> </a>
<a name="ln1135">		float h = Bounds().Height();</a>
<a name="ln1136">		if (ch2Showing) {</a>
<a name="ln1137">			MovePenTo(10, h-12);</a>
<a name="ln1138">			sprintf(str, &quot;2) x: %&quot; B_PRIi32 &quot; y: %&quot; B_PRIi32 &quot;   y: %d&quot;,</a>
<a name="ln1139">				(int32)pt2.x, (int32)pt2.y, abs((int)(pt1.y - pt2.y)));</a>
<a name="ln1140">			invalRect.Set(10, h-12-fFontHeight, 10 + StringWidth(fCH2Str), h-10);</a>
<a name="ln1141">			SetHighColor(ViewColor());</a>
<a name="ln1142">			FillRect(invalRect);</a>
<a name="ln1143">			SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln1144">			strcpy(fCH2Str,str);</a>
<a name="ln1145">			if (fInfoTextVisible)</a>
<a name="ln1146">				DrawString(fCH2Str);</a>
<a name="ln1147">		}</a>
<a name="ln1148"> </a>
<a name="ln1149">		if (ch1Showing &amp;&amp; ch2Showing) {</a>
<a name="ln1150">			MovePenTo(10, h-10-fFontHeight-2);</a>
<a name="ln1151">			sprintf(str, &quot;1) x: %&quot; B_PRIi32 &quot;  y: %&quot; B_PRIi32 &quot;   x: %d&quot;,</a>
<a name="ln1152">				(int32)pt1.x, (int32)pt1.y, abs((int)(pt1.x - pt2.x)));</a>
<a name="ln1153">			invalRect.Set(10, h-10-2*fFontHeight-2, 10 + StringWidth(fCH1Str), h-10-fFontHeight);</a>
<a name="ln1154">			SetHighColor(ViewColor());</a>
<a name="ln1155">			FillRect(invalRect);</a>
<a name="ln1156">			SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln1157">			strcpy(fCH1Str,str);</a>
<a name="ln1158">			if (fInfoTextVisible)</a>
<a name="ln1159">				DrawString(fCH1Str);</a>
<a name="ln1160">		} else if (ch1Showing) {</a>
<a name="ln1161">			MovePenTo(10, h-10);</a>
<a name="ln1162">			sprintf(str, &quot;x: %&quot; B_PRIi32 &quot;  y: %&quot; B_PRIi32, (int32)pt1.x, (int32)pt1.y);</a>
<a name="ln1163">			invalRect.Set(10, h-10-fFontHeight, 10 + StringWidth(fCH1Str), h-8);</a>
<a name="ln1164">			SetHighColor(ViewColor());</a>
<a name="ln1165">			FillRect(invalRect);</a>
<a name="ln1166">			SetHighColor(ui_color(B_PANEL_TEXT_COLOR));</a>
<a name="ln1167">			strcpy(fCH1Str,str);</a>
<a name="ln1168">			if (fInfoTextVisible)</a>
<a name="ln1169">				DrawString(fCH1Str);</a>
<a name="ln1170">		}</a>
<a name="ln1171">	}</a>
<a name="ln1172"> </a>
<a name="ln1173">	PopState();</a>
<a name="ln1174">}</a>
<a name="ln1175"> </a>
<a name="ln1176"> </a>
<a name="ln1177">void</a>
<a name="ln1178">TInfoView::FrameResized(float width, float height)</a>
<a name="ln1179">{</a>
<a name="ln1180">	BBox::FrameResized(width, height);</a>
<a name="ln1181">}</a>
<a name="ln1182"> </a>
<a name="ln1183"> </a>
<a name="ln1184">void</a>
<a name="ln1185">TInfoView::AddMenu()</a>
<a name="ln1186">{</a>
<a name="ln1187">	fMenu = new TMenu(dynamic_cast&lt;TWindow*&gt;(Window()), &quot;&quot;);</a>
<a name="ln1188">	BuildInfoMenu(fMenu);</a>
<a name="ln1189"> </a>
<a name="ln1190">	BRect r(9, 11, 22, 27);</a>
<a name="ln1191">	fPopUp = new BMenuField( r, &quot;region menu&quot;, NULL, fMenu, true,</a>
<a name="ln1192">		B_FOLLOW_LEFT | B_FOLLOW_TOP);</a>
<a name="ln1193">	AddChild(fPopUp);</a>
<a name="ln1194">}</a>
<a name="ln1195"> </a>
<a name="ln1196"> </a>
<a name="ln1197">void</a>
<a name="ln1198">TInfoView::SetMagView(TMagnify* magView)</a>
<a name="ln1199">{</a>
<a name="ln1200">	fMagView = magView;</a>
<a name="ln1201">}</a>
<a name="ln1202"> </a>
<a name="ln1203"> </a>
<a name="ln1204">//	#pragma mark -</a>
<a name="ln1205"> </a>
<a name="ln1206"> </a>
<a name="ln1207">TMenu::TMenu(TWindow *mainWindow, const char *title, menu_layout layout)</a>
<a name="ln1208">	: BMenu(title, layout),</a>
<a name="ln1209">	fMainWindow(mainWindow)</a>
<a name="ln1210">{</a>
<a name="ln1211">}</a>
<a name="ln1212"> </a>
<a name="ln1213"> </a>
<a name="ln1214">TMenu::~TMenu()</a>
<a name="ln1215">{</a>
<a name="ln1216">}</a>
<a name="ln1217"> </a>
<a name="ln1218"> </a>
<a name="ln1219">void</a>
<a name="ln1220">TMenu::AttachedToWindow()</a>
<a name="ln1221">{</a>
<a name="ln1222">	UpdateInfoMenu(this, fMainWindow);</a>
<a name="ln1223"> </a>
<a name="ln1224">	BMenu::AttachedToWindow();</a>
<a name="ln1225">}</a>
<a name="ln1226"> </a>
<a name="ln1227"> </a>
<a name="ln1228">void</a>
<a name="ln1229">TInfoView::GetPreferredSize(float* _width, float* _height)</a>
<a name="ln1230">{</a>
<a name="ln1231">	if (_width) {</a>
<a name="ln1232">		float str1Width = StringWidth(fCH1Str)</a>
<a name="ln1233">			+ StringWidth(fCH2Str)</a>
<a name="ln1234">			+ StringWidth(fRGBStr)</a>
<a name="ln1235">			+ 30;</a>
<a name="ln1236">		float str2Width = StringWidth(fInfoStr) + 30;</a>
<a name="ln1237">		*_width = str1Width &gt; str2Width ? str1Width : str2Width;</a>
<a name="ln1238">	}</a>
<a name="ln1239"> </a>
<a name="ln1240">	if (_height)</a>
<a name="ln1241">		*_height = fFontHeight * 2 + 10;</a>
<a name="ln1242">}</a>
<a name="ln1243"> </a>
<a name="ln1244"> </a>
<a name="ln1245">bool</a>
<a name="ln1246">TInfoView::IsInfoTextVisible()</a>
<a name="ln1247">{</a>
<a name="ln1248">	return fInfoTextVisible;</a>
<a name="ln1249">}</a>
<a name="ln1250"> </a>
<a name="ln1251"> </a>
<a name="ln1252">void</a>
<a name="ln1253">TInfoView::SetInfoTextVisible(bool visible)</a>
<a name="ln1254">{</a>
<a name="ln1255">	fInfoTextVisible = visible;</a>
<a name="ln1256">	Draw(Bounds());</a>
<a name="ln1257">}</a>
<a name="ln1258"> </a>
<a name="ln1259"> </a>
<a name="ln1260">//	#pragma mark -</a>
<a name="ln1261"> </a>
<a name="ln1262"> </a>
<a name="ln1263">TMagnify::TMagnify(BRect r, TWindow* parent)</a>
<a name="ln1264">	: BView(r, &quot;MagView&quot;, B_FOLLOW_NONE, B_WILL_DRAW | B_FRAME_EVENTS),</a>
<a name="ln1265">	fNeedToUpdate(true),</a>
<a name="ln1266">	fThread(-1),</a>
<a name="ln1267">	fActive(true),</a>
<a name="ln1268">	fImageBuf(NULL),</a>
<a name="ln1269">	fImageView(NULL),</a>
<a name="ln1270">	fLastLoc(-1, -1),</a>
<a name="ln1271">	fSelection(-1),</a>
<a name="ln1272">	fShowSelection(false),</a>
<a name="ln1273">	fSelectionLoc(0, 0),</a>
<a name="ln1274">	fShowCrossHair1(false),</a>
<a name="ln1275">	fCrossHair1(-1, -1),</a>
<a name="ln1276">	fShowCrossHair2(false),</a>
<a name="ln1277">	fCrossHair2(-1, -1),</a>
<a name="ln1278">	fParent(parent),</a>
<a name="ln1279">	fStickCoordinates(false)</a>
<a name="ln1280">{</a>
<a name="ln1281">}</a>
<a name="ln1282"> </a>
<a name="ln1283"> </a>
<a name="ln1284">TMagnify::~TMagnify()</a>
<a name="ln1285">{</a>
<a name="ln1286">	kill_thread(fThread);</a>
<a name="ln1287">	delete fImageBuf;</a>
<a name="ln1288">}</a>
<a name="ln1289"> </a>
<a name="ln1290"> </a>
<a name="ln1291">void</a>
<a name="ln1292">TMagnify::AttachedToWindow()</a>
<a name="ln1293">{</a>
<a name="ln1294">	int32 width, height;</a>
<a name="ln1295">	fParent-&gt;PixelCount(&amp;width, &amp;height);</a>
<a name="ln1296">	InitBuffers(width, height, fParent-&gt;PixelSize(), fParent-&gt;ShowGrid());</a>
<a name="ln1297"> </a>
<a name="ln1298">	fThread = spawn_thread(TMagnify::MagnifyTask, &quot;MagnifyTask&quot;,</a>
<a name="ln1299">		B_NORMAL_PRIORITY, this);</a>
<a name="ln1300"> </a>
<a name="ln1301">	resume_thread(fThread);</a>
<a name="ln1302"> </a>
<a name="ln1303">	SetViewColor(B_TRANSPARENT_32_BIT);</a>
<a name="ln1304">	MakeFocus();</a>
<a name="ln1305">}</a>
<a name="ln1306"> </a>
<a name="ln1307"> </a>
<a name="ln1308">void</a>
<a name="ln1309">TMagnify::InitBuffers(int32 hPixelCount, int32 vPixelCount,</a>
<a name="ln1310">	int32 pixelSize, bool showGrid)</a>
<a name="ln1311">{</a>
<a name="ln1312">	color_space colorSpace = BScreen(Window()).ColorSpace();</a>
<a name="ln1313"> </a>
<a name="ln1314">	BRect r(0, 0, (pixelSize * hPixelCount)-1, (pixelSize * vPixelCount)-1);</a>
<a name="ln1315">	if (Bounds().Width() != r.Width() || Bounds().Height() != r.Height())</a>
<a name="ln1316">		ResizeTo(r.Width(), r.Height());</a>
<a name="ln1317"> </a>
<a name="ln1318">	if (fImageView) {</a>
<a name="ln1319">		fImageBuf-&gt;Lock();</a>
<a name="ln1320">		fImageView-&gt;RemoveSelf();</a>
<a name="ln1321">		fImageBuf-&gt;Unlock();</a>
<a name="ln1322"> </a>
<a name="ln1323">		fImageView-&gt;Resize((int32)r.Width(), (int32)r.Height());</a>
<a name="ln1324">		fImageView-&gt;SetSpace(colorSpace);</a>
<a name="ln1325">	} else</a>
<a name="ln1326">		fImageView = new TOSMagnify(r, this, colorSpace);</a>
<a name="ln1327"> </a>
<a name="ln1328">	delete fImageBuf;</a>
<a name="ln1329">	fImageBuf = new BBitmap(r, colorSpace, true);</a>
<a name="ln1330">	fImageBuf-&gt;Lock();</a>
<a name="ln1331">	fImageBuf-&gt;AddChild(fImageView);</a>
<a name="ln1332">	fImageBuf-&gt;Unlock();</a>
<a name="ln1333">}</a>
<a name="ln1334"> </a>
<a name="ln1335"> </a>
<a name="ln1336">void</a>
<a name="ln1337">TMagnify::Draw(BRect)</a>
<a name="ln1338">{</a>
<a name="ln1339">	BRect bounds(Bounds());</a>
<a name="ln1340">	DrawBitmap(fImageBuf, bounds, bounds);</a>
<a name="ln1341">	static_cast&lt;TWindow*&gt;(Window())-&gt;UpdateInfo();</a>
<a name="ln1342">}</a>
<a name="ln1343"> </a>
<a name="ln1344"> </a>
<a name="ln1345">void</a>
<a name="ln1346">TMagnify::KeyDown(const char *key, int32 numBytes)</a>
<a name="ln1347">{</a>
<a name="ln1348">	if (!fShowSelection)</a>
<a name="ln1349">		BView::KeyDown(key, numBytes);</a>
<a name="ln1350"> </a>
<a name="ln1351">	switch (key[0]) {</a>
<a name="ln1352">		case B_TAB:</a>
<a name="ln1353">			if (fShowCrossHair1) {</a>
<a name="ln1354">				fSelection++;</a>
<a name="ln1355"> </a>
<a name="ln1356">				if (fShowCrossHair2) {</a>
<a name="ln1357">					if (fSelection &gt; 2)</a>
<a name="ln1358">						fSelection = 0;</a>
<a name="ln1359">				} else if (fShowCrossHair1) {</a>
<a name="ln1360">					if (fSelection &gt; 1)</a>
<a name="ln1361">						fSelection = 0;</a>
<a name="ln1362">				}</a>
<a name="ln1363">				fNeedToUpdate = true;</a>
<a name="ln1364">				Invalidate();</a>
<a name="ln1365">			}</a>
<a name="ln1366">			break;</a>
<a name="ln1367"> </a>
<a name="ln1368">		case B_LEFT_ARROW:</a>
<a name="ln1369">			MoveSelection(-1,0);</a>
<a name="ln1370">			break;</a>
<a name="ln1371">		case B_RIGHT_ARROW:</a>
<a name="ln1372">			MoveSelection(1,0);</a>
<a name="ln1373">			break;</a>
<a name="ln1374">		case B_UP_ARROW:</a>
<a name="ln1375">			MoveSelection(0,-1);</a>
<a name="ln1376">			break;</a>
<a name="ln1377">		case B_DOWN_ARROW:</a>
<a name="ln1378">			MoveSelection(0,1);</a>
<a name="ln1379">			break;</a>
<a name="ln1380"> </a>
<a name="ln1381">		default:</a>
<a name="ln1382">			BView::KeyDown(key,numBytes);</a>
<a name="ln1383">			break;</a>
<a name="ln1384">	}</a>
<a name="ln1385">}</a>
<a name="ln1386"> </a>
<a name="ln1387"> </a>
<a name="ln1388">void</a>
<a name="ln1389">TMagnify::FrameResized(float newW, float newH)</a>
<a name="ln1390">{</a>
<a name="ln1391">	int32 w, h;</a>
<a name="ln1392">	PixelCount(&amp;w, &amp;h);</a>
<a name="ln1393"> </a>
<a name="ln1394">	if (fSelectionLoc.x &gt;= w)</a>
<a name="ln1395">		fSelectionLoc.x = 0;</a>
<a name="ln1396">	if (fSelectionLoc.y &gt;= h)</a>
<a name="ln1397">		fSelectionLoc.y = 0;</a>
<a name="ln1398"> </a>
<a name="ln1399">	if (fShowCrossHair1) {</a>
<a name="ln1400">		if (fCrossHair1.x &gt;= w) {</a>
<a name="ln1401">			fCrossHair1.x = fSelectionLoc.x + 2;</a>
<a name="ln1402">			if (fCrossHair1.x &gt;= w)</a>
<a name="ln1403">				fCrossHair1.x = 0;</a>
<a name="ln1404">		}</a>
<a name="ln1405">		if (fCrossHair1.y &gt;= h) {</a>
<a name="ln1406">			fCrossHair1.y = fSelectionLoc.y + 2;</a>
<a name="ln1407">			if (fCrossHair1.y &gt;= h)</a>
<a name="ln1408">				fCrossHair1.y = 0;</a>
<a name="ln1409">		}</a>
<a name="ln1410"> </a>
<a name="ln1411">		if (fShowCrossHair2) {</a>
<a name="ln1412">			if (fCrossHair2.x &gt;= w) {</a>
<a name="ln1413">				fCrossHair2.x = fCrossHair1.x + 2;</a>
<a name="ln1414">				if (fCrossHair2.x &gt;= w)</a>
<a name="ln1415">					fCrossHair2.x = 0;</a>
<a name="ln1416">			}</a>
<a name="ln1417">			if (fCrossHair2.y &gt;= h) {</a>
<a name="ln1418">				fCrossHair2.y = fCrossHair1.y + 2;</a>
<a name="ln1419">				if (fCrossHair2.y &gt;= h)</a>
<a name="ln1420">					fCrossHair2.y = 0;</a>
<a name="ln1421">			}</a>
<a name="ln1422">		}</a>
<a name="ln1423">	}</a>
<a name="ln1424">}</a>
<a name="ln1425"> </a>
<a name="ln1426"> </a>
<a name="ln1427">void</a>
<a name="ln1428">TMagnify::MouseDown(BPoint where)</a>
<a name="ln1429">{</a>
<a name="ln1430">	BMessage *currentMsg = Window()-&gt;CurrentMessage();</a>
<a name="ln1431">	if (currentMsg-&gt;what == B_MOUSE_DOWN) {</a>
<a name="ln1432">		uint32 buttons = 0;</a>
<a name="ln1433">		currentMsg-&gt;FindInt32(&quot;buttons&quot;, (int32 *)&amp;buttons);</a>
<a name="ln1434"> </a>
<a name="ln1435">		uint32 modifiers = 0;</a>
<a name="ln1436">		currentMsg-&gt;FindInt32(&quot;modifiers&quot;, (int32 *)&amp;modifiers);</a>
<a name="ln1437"> </a>
<a name="ln1438">		if ((buttons &amp; B_SECONDARY_MOUSE_BUTTON) || (modifiers &amp; B_CONTROL_KEY)) {</a>
<a name="ln1439">			// secondary button was clicked or control key was down, show menu and return</a>
<a name="ln1440"> </a>
<a name="ln1441">			BPopUpMenu *menu = new BPopUpMenu(B_TRANSLATE(&quot;Info&quot;), false, false);</a>
<a name="ln1442">			menu-&gt;SetFont(be_plain_font);</a>
<a name="ln1443">			BuildInfoMenu(menu);</a>
<a name="ln1444">			UpdateInfoMenu(menu, dynamic_cast&lt;TWindow*&gt;(Window()));</a>
<a name="ln1445">			BMenuItem *selected = menu-&gt;Go(ConvertToScreen(where));</a>
<a name="ln1446">			if (selected)</a>
<a name="ln1447">				Window()-&gt;PostMessage(selected-&gt;Message()-&gt;what);</a>
<a name="ln1448">			delete menu;</a>
<a name="ln1449">			return;</a>
<a name="ln1450">		}</a>
<a name="ln1451"> </a>
<a name="ln1452">		// add a mousedown looper here</a>
<a name="ln1453"> </a>
<a name="ln1454">		int32 pixelSize = PixelSize();</a>
<a name="ln1455">		float x = where.x / pixelSize;</a>
<a name="ln1456">		float y = where.y / pixelSize;</a>
<a name="ln1457"> </a>
<a name="ln1458">		MoveSelectionTo(x, y);</a>
<a name="ln1459"> </a>
<a name="ln1460">		// draw the frozen image</a>
<a name="ln1461">		// update the info region</a>
<a name="ln1462"> </a>
<a name="ln1463">		fNeedToUpdate = true;</a>
<a name="ln1464">		Invalidate();</a>
<a name="ln1465">	}</a>
<a name="ln1466">}</a>
<a name="ln1467"> </a>
<a name="ln1468"> </a>
<a name="ln1469">void</a>
<a name="ln1470">TMagnify::ScreenChanged(BRect, color_space)</a>
<a name="ln1471">{</a>
<a name="ln1472">	int32 width, height;</a>
<a name="ln1473">	fParent-&gt;PixelCount(&amp;width, &amp;height);</a>
<a name="ln1474">	InitBuffers(width, height, fParent-&gt;PixelSize(), fParent-&gt;ShowGrid());</a>
<a name="ln1475">}</a>
<a name="ln1476"> </a>
<a name="ln1477"> </a>
<a name="ln1478">void</a>
<a name="ln1479">TMagnify::SetSelection(bool state)</a>
<a name="ln1480">{</a>
<a name="ln1481">	if (fShowSelection == state)</a>
<a name="ln1482">		return;</a>
<a name="ln1483"> </a>
<a name="ln1484">	fShowSelection = state;</a>
<a name="ln1485">	fSelection = 0;</a>
<a name="ln1486">	Invalidate();</a>
<a name="ln1487">}</a>
<a name="ln1488"> </a>
<a name="ln1489"> </a>
<a name="ln1490">void</a>
<a name="ln1491">TMagnify::MoveSelection(int32 x, int32 y)</a>
<a name="ln1492">{</a>
<a name="ln1493">	if (!fShowSelection)</a>
<a name="ln1494">		return;</a>
<a name="ln1495"> </a>
<a name="ln1496">	int32 xCount, yCount;</a>
<a name="ln1497">	PixelCount(&amp;xCount, &amp;yCount);</a>
<a name="ln1498"> </a>
<a name="ln1499">	float xloc, yloc;</a>
<a name="ln1500">	if (fSelection == 0) {</a>
<a name="ln1501">		xloc = fSelectionLoc.x;</a>
<a name="ln1502">		yloc = fSelectionLoc.y;</a>
<a name="ln1503">		BoundsSelection(x, y, &amp;xloc, &amp;yloc, xCount, yCount);</a>
<a name="ln1504">		fSelectionLoc.x = xloc;</a>
<a name="ln1505">		fSelectionLoc.y = yloc;</a>
<a name="ln1506">	} else if (fSelection == 1) {</a>
<a name="ln1507">		xloc = fCrossHair1.x;</a>
<a name="ln1508">		yloc = fCrossHair1.y;</a>
<a name="ln1509">		BoundsSelection(x, y, &amp;xloc, &amp;yloc, xCount, yCount);</a>
<a name="ln1510">		fCrossHair1.x = xloc;</a>
<a name="ln1511">		fCrossHair1.y = yloc;</a>
<a name="ln1512">	} else if (fSelection == 2) {</a>
<a name="ln1513">		xloc = fCrossHair2.x;</a>
<a name="ln1514">		yloc = fCrossHair2.y;</a>
<a name="ln1515">		BoundsSelection(x, y, &amp;xloc, &amp;yloc, xCount, yCount);</a>
<a name="ln1516">		fCrossHair2.x = xloc;</a>
<a name="ln1517">		fCrossHair2.y = yloc;</a>
<a name="ln1518">	}</a>
<a name="ln1519"> </a>
<a name="ln1520">	fNeedToUpdate = true;</a>
<a name="ln1521">	Invalidate();</a>
<a name="ln1522">}</a>
<a name="ln1523"> </a>
<a name="ln1524"> </a>
<a name="ln1525">void</a>
<a name="ln1526">TMagnify::MoveSelectionTo(int32 x, int32 y)</a>
<a name="ln1527">{</a>
<a name="ln1528">	if (!fShowSelection)</a>
<a name="ln1529">		return;</a>
<a name="ln1530"> </a>
<a name="ln1531">	int32 xCount, yCount;</a>
<a name="ln1532">	PixelCount(&amp;xCount, &amp;yCount);</a>
<a name="ln1533">	if (x &gt;= xCount)</a>
<a name="ln1534">		x = 0;</a>
<a name="ln1535">	if (y &gt;= yCount)</a>
<a name="ln1536">		y = 0;</a>
<a name="ln1537"> </a>
<a name="ln1538">	if (fSelection == 0) {</a>
<a name="ln1539">		fSelectionLoc.x = x;</a>
<a name="ln1540">		fSelectionLoc.y = y;</a>
<a name="ln1541">	} else if (fSelection == 1) {</a>
<a name="ln1542">		fCrossHair1.x = x;</a>
<a name="ln1543">		fCrossHair1.y = y;</a>
<a name="ln1544">	} else if (fSelection == 2) {</a>
<a name="ln1545">		fCrossHair2.x = x;</a>
<a name="ln1546">		fCrossHair2.y = y;</a>
<a name="ln1547">	}</a>
<a name="ln1548"> </a>
<a name="ln1549">	fNeedToUpdate = true;</a>
<a name="ln1550">	Invalidate(); //Draw(Bounds());</a>
<a name="ln1551">}</a>
<a name="ln1552"> </a>
<a name="ln1553"> </a>
<a name="ln1554">void</a>
<a name="ln1555">TMagnify::ShowSelection()</a>
<a name="ln1556">{</a>
<a name="ln1557">}</a>
<a name="ln1558"> </a>
<a name="ln1559"> </a>
<a name="ln1560">short</a>
<a name="ln1561">TMagnify::Selection()</a>
<a name="ln1562">{</a>
<a name="ln1563">	return fSelection;</a>
<a name="ln1564">}</a>
<a name="ln1565"> </a>
<a name="ln1566"> </a>
<a name="ln1567">bool</a>
<a name="ln1568">TMagnify::SelectionIsShowing()</a>
<a name="ln1569">{</a>
<a name="ln1570">	return fShowSelection;</a>
<a name="ln1571">}</a>
<a name="ln1572"> </a>
<a name="ln1573"> </a>
<a name="ln1574">void</a>
<a name="ln1575">TMagnify::SelectionLoc(float* x, float* y)</a>
<a name="ln1576">{</a>
<a name="ln1577">	*x = fSelectionLoc.x;</a>
<a name="ln1578">	*y = fSelectionLoc.y;</a>
<a name="ln1579">}</a>
<a name="ln1580"> </a>
<a name="ln1581"> </a>
<a name="ln1582">void</a>
<a name="ln1583">TMagnify::SetSelectionLoc(float x, float y)</a>
<a name="ln1584">{</a>
<a name="ln1585">	fSelectionLoc.x = x;</a>
<a name="ln1586">	fSelectionLoc.y = y;</a>
<a name="ln1587">}</a>
<a name="ln1588"> </a>
<a name="ln1589"> </a>
<a name="ln1590">rgb_color</a>
<a name="ln1591">TMagnify::SelectionColor()</a>
<a name="ln1592">{</a>
<a name="ln1593">	return fImageView-&gt;ColorAtSelection();</a>
<a name="ln1594">}</a>
<a name="ln1595"> </a>
<a name="ln1596"> </a>
<a name="ln1597">void</a>
<a name="ln1598">TMagnify::CrossHair1Loc(float* x, float* y)</a>
<a name="ln1599">{</a>
<a name="ln1600">	*x = fCrossHair1.x;</a>
<a name="ln1601">	*y = fCrossHair1.y;</a>
<a name="ln1602">}</a>
<a name="ln1603"> </a>
<a name="ln1604"> </a>
<a name="ln1605">void</a>
<a name="ln1606">TMagnify::CrossHair2Loc(float* x, float* y)</a>
<a name="ln1607">{</a>
<a name="ln1608">	*x = fCrossHair2.x;</a>
<a name="ln1609">	*y = fCrossHair2.y;</a>
<a name="ln1610">}</a>
<a name="ln1611"> </a>
<a name="ln1612"> </a>
<a name="ln1613">BPoint</a>
<a name="ln1614">TMagnify::CrossHair1Loc()</a>
<a name="ln1615">{</a>
<a name="ln1616">	return fCrossHair1;</a>
<a name="ln1617">}</a>
<a name="ln1618"> </a>
<a name="ln1619"> </a>
<a name="ln1620">BPoint</a>
<a name="ln1621">TMagnify::CrossHair2Loc()</a>
<a name="ln1622">{</a>
<a name="ln1623">	return fCrossHair2;</a>
<a name="ln1624">}</a>
<a name="ln1625"> </a>
<a name="ln1626"> </a>
<a name="ln1627">void</a>
<a name="ln1628">TMagnify::NudgeMouse(float x, float y)</a>
<a name="ln1629">{</a>
<a name="ln1630">	BPoint loc;</a>
<a name="ln1631">	uint32 button;</a>
<a name="ln1632"> </a>
<a name="ln1633">	GetMouse(&amp;loc, &amp;button);</a>
<a name="ln1634">	ConvertToScreen(&amp;loc);</a>
<a name="ln1635">	loc.x += x;</a>
<a name="ln1636">	loc.y += y;</a>
<a name="ln1637"> </a>
<a name="ln1638">	set_mouse_position((int32)loc.x, (int32)loc.y);</a>
<a name="ln1639">}</a>
<a name="ln1640"> </a>
<a name="ln1641"> </a>
<a name="ln1642">void</a>
<a name="ln1643">TMagnify::WindowActivated(bool active)</a>
<a name="ln1644">{</a>
<a name="ln1645">	if (active)</a>
<a name="ln1646">		MakeFocus();</a>
<a name="ln1647">}</a>
<a name="ln1648"> </a>
<a name="ln1649"> </a>
<a name="ln1650">status_t</a>
<a name="ln1651">TMagnify::MagnifyTask(void *arg)</a>
<a name="ln1652">{</a>
<a name="ln1653">	TMagnify* view = (TMagnify*)arg;</a>
<a name="ln1654"> </a>
<a name="ln1655">	// static data members can't access members, methods without</a>
<a name="ln1656">	// a pointer to an instance of the class</a>
<a name="ln1657">	TWindow* window = (TWindow*)view-&gt;Window();</a>
<a name="ln1658"> </a>
<a name="ln1659">	while (true) {</a>
<a name="ln1660">		if (window-&gt;Lock()) {</a>
<a name="ln1661">			if (view-&gt;NeedToUpdate() || view-&gt;Active())</a>
<a name="ln1662">				view-&gt;Update(view-&gt;NeedToUpdate());</a>
<a name="ln1663"> </a>
<a name="ln1664">			window-&gt;Unlock();</a>
<a name="ln1665">		}</a>
<a name="ln1666">		snooze(35000);</a>
<a name="ln1667">	}</a>
<a name="ln1668"> </a>
<a name="ln1669">	return B_NO_ERROR;</a>
<a name="ln1670">}</a>
<a name="ln1671"> </a>
<a name="ln1672"> </a>
<a name="ln1673">void</a>
<a name="ln1674">TMagnify::Update(bool force)</a>
<a name="ln1675">{</a>
<a name="ln1676">	BPoint loc;</a>
<a name="ln1677">	uint32 button;</a>
<a name="ln1678">	static long counter = 0;</a>
<a name="ln1679"> </a>
<a name="ln1680">	if (!fStickCoordinates) {</a>
<a name="ln1681">		GetMouse(&amp;loc, &amp;button);</a>
<a name="ln1682">		ConvertToScreen(&amp;loc);</a>
<a name="ln1683">	} else</a>
<a name="ln1684">		loc = fLastLoc;</a>
<a name="ln1685"> </a>
<a name="ln1686">	if (force || fLastLoc != loc || counter++ % 35 == 0) {</a>
<a name="ln1687">		if (fImageView-&gt;CreateImage(loc, force))</a>
<a name="ln1688">			Invalidate();</a>
<a name="ln1689"> </a>
<a name="ln1690">		counter = 0;</a>
<a name="ln1691">		if (force)</a>
<a name="ln1692">			SetUpdate(false);</a>
<a name="ln1693">	}</a>
<a name="ln1694">	fLastLoc = loc;</a>
<a name="ln1695">}</a>
<a name="ln1696"> </a>
<a name="ln1697"> </a>
<a name="ln1698">bool</a>
<a name="ln1699">TMagnify::NeedToUpdate()</a>
<a name="ln1700">{</a>
<a name="ln1701">	return fNeedToUpdate;</a>
<a name="ln1702">}</a>
<a name="ln1703"> </a>
<a name="ln1704"> </a>
<a name="ln1705">void</a>
<a name="ln1706">TMagnify::SetUpdate(bool s)</a>
<a name="ln1707">{</a>
<a name="ln1708">	fNeedToUpdate = s;</a>
<a name="ln1709">}</a>
<a name="ln1710"> </a>
<a name="ln1711"> </a>
<a name="ln1712">void</a>
<a name="ln1713">TMagnify::CopyImage()</a>
<a name="ln1714">{</a>
<a name="ln1715">	StartSave();</a>
<a name="ln1716">	be_clipboard-&gt;Lock();</a>
<a name="ln1717">	be_clipboard-&gt;Clear();</a>
<a name="ln1718"> </a>
<a name="ln1719">	BMessage *message = be_clipboard-&gt;Data();</a>
<a name="ln1720">	if (!message) {</a>
<a name="ln1721">		puts(B_TRANSLATE_CONTEXT(&quot;no clip msg&quot;,</a>
<a name="ln1722">			&quot;In console, when clipboard is empty after clicking Copy image&quot;));</a>
<a name="ln1723">		return;</a>
<a name="ln1724">	}</a>
<a name="ln1725"> </a>
<a name="ln1726">	BMessage *embeddedBitmap = new BMessage();</a>
<a name="ln1727">	(fImageView-&gt;Bitmap())-&gt;Archive(embeddedBitmap,false);</a>
<a name="ln1728">	status_t err = message-&gt;AddMessage(kBitmapMimeType, embeddedBitmap);</a>
<a name="ln1729">	if (err == B_OK)</a>
<a name="ln1730">		err = message-&gt;AddRect(&quot;rect&quot;, fImageView-&gt;Bitmap()-&gt;Bounds());</a>
<a name="ln1731">	if (err == B_OK)</a>
<a name="ln1732">		be_clipboard-&gt;Commit();</a>
<a name="ln1733"> </a>
<a name="ln1734">	be_clipboard-&gt;Unlock();</a>
<a name="ln1735">	EndSave();</a>
<a name="ln1736">}</a>
<a name="ln1737"> </a>
<a name="ln1738"> </a>
<a name="ln1739">void</a>
<a name="ln1740">TMagnify::AddCrossHair()</a>
<a name="ln1741">{</a>
<a name="ln1742">	if (fShowCrossHair1 &amp;&amp; fShowCrossHair2)</a>
<a name="ln1743">		return;</a>
<a name="ln1744"> </a>
<a name="ln1745">	int32 w, h;</a>
<a name="ln1746">	PixelCount(&amp;w, &amp;h);</a>
<a name="ln1747"> </a>
<a name="ln1748">	if (fShowCrossHair1) {</a>
<a name="ln1749">		fSelection = 2;</a>
<a name="ln1750">		fShowCrossHair2 = true;</a>
<a name="ln1751">		fCrossHair2.x = fCrossHair1.x + 2;</a>
<a name="ln1752">		if (fCrossHair2.x &gt;= w)</a>
<a name="ln1753">			fCrossHair2.x = 0;</a>
<a name="ln1754">		fCrossHair2.y = fCrossHair1.y + 2;</a>
<a name="ln1755">		if (fCrossHair2.y &gt;= h)</a>
<a name="ln1756">			fCrossHair2.y = 0;</a>
<a name="ln1757">	} else {</a>
<a name="ln1758">		fSelection = 1;</a>
<a name="ln1759">		fShowCrossHair1 = true;</a>
<a name="ln1760">		fCrossHair1.x = fSelectionLoc.x + 2;</a>
<a name="ln1761">		if (fCrossHair1.x &gt;= w)</a>
<a name="ln1762">			fCrossHair1.x = 0;</a>
<a name="ln1763">		fCrossHair1.y = fSelectionLoc.y + 2;</a>
<a name="ln1764">		if (fCrossHair1.y &gt;= h)</a>
<a name="ln1765">			fCrossHair1.y = 0;</a>
<a name="ln1766">	}</a>
<a name="ln1767">	Invalidate();</a>
<a name="ln1768">}</a>
<a name="ln1769"> </a>
<a name="ln1770"> </a>
<a name="ln1771">void</a>
<a name="ln1772">TMagnify::RemoveCrossHair()</a>
<a name="ln1773">{</a>
<a name="ln1774">	if (!fShowCrossHair1 &amp;&amp; !fShowCrossHair2)</a>
<a name="ln1775">		return;</a>
<a name="ln1776"> </a>
<a name="ln1777">	if (fShowCrossHair2) {</a>
<a name="ln1778">		fSelection = 1;</a>
<a name="ln1779">		fShowCrossHair2 = false;</a>
<a name="ln1780">	} else if (fShowCrossHair1) {</a>
<a name="ln1781">		fSelection = 0;</a>
<a name="ln1782">		fShowCrossHair1 = false;</a>
<a name="ln1783">	}</a>
<a name="ln1784">	Invalidate();</a>
<a name="ln1785">}</a>
<a name="ln1786"> </a>
<a name="ln1787"> </a>
<a name="ln1788">void</a>
<a name="ln1789">TMagnify::SetCrossHairsShowing(bool ch1, bool ch2)</a>
<a name="ln1790">{</a>
<a name="ln1791">	fShowCrossHair1 = ch1;</a>
<a name="ln1792">	fShowCrossHair2 = ch2;</a>
<a name="ln1793">}</a>
<a name="ln1794"> </a>
<a name="ln1795"> </a>
<a name="ln1796">void</a>
<a name="ln1797">TMagnify::CrossHairsShowing(bool* ch1, bool* ch2)</a>
<a name="ln1798">{</a>
<a name="ln1799">	*ch1 = fShowCrossHair1;</a>
<a name="ln1800">	*ch2 = fShowCrossHair2;</a>
<a name="ln1801">}</a>
<a name="ln1802"> </a>
<a name="ln1803"> </a>
<a name="ln1804">void</a>
<a name="ln1805">TMagnify::MakeActive(bool s)</a>
<a name="ln1806">{</a>
<a name="ln1807">	fActive = s;</a>
<a name="ln1808">}</a>
<a name="ln1809"> </a>
<a name="ln1810"> </a>
<a name="ln1811">void</a>
<a name="ln1812">TMagnify::MakeSticked(bool s)</a>
<a name="ln1813">{</a>
<a name="ln1814">	fStickCoordinates = s;</a>
<a name="ln1815">}</a>
<a name="ln1816"> </a>
<a name="ln1817"> </a>
<a name="ln1818">void</a>
<a name="ln1819">TMagnify::PixelCount(int32* width, int32* height)</a>
<a name="ln1820">{</a>
<a name="ln1821">	fParent-&gt;PixelCount(width, height);</a>
<a name="ln1822">}</a>
<a name="ln1823"> </a>
<a name="ln1824"> </a>
<a name="ln1825">int32</a>
<a name="ln1826">TMagnify::PixelSize()</a>
<a name="ln1827">{</a>
<a name="ln1828">	return fParent-&gt;PixelSize();</a>
<a name="ln1829">}</a>
<a name="ln1830"> </a>
<a name="ln1831"> </a>
<a name="ln1832">bool</a>
<a name="ln1833">TMagnify::ShowGrid()</a>
<a name="ln1834">{</a>
<a name="ln1835">	return fParent-&gt;ShowGrid();</a>
<a name="ln1836">}</a>
<a name="ln1837"> </a>
<a name="ln1838"> </a>
<a name="ln1839">void</a>
<a name="ln1840">TMagnify::StartSave()</a>
<a name="ln1841">{</a>
<a name="ln1842">	fImageFrozenOnSave = Active();</a>
<a name="ln1843">	if (fImageFrozenOnSave)</a>
<a name="ln1844">		MakeActive(false);</a>
<a name="ln1845">}</a>
<a name="ln1846"> </a>
<a name="ln1847"> </a>
<a name="ln1848">void</a>
<a name="ln1849">TMagnify::EndSave()</a>
<a name="ln1850">{</a>
<a name="ln1851">	if (fImageFrozenOnSave)</a>
<a name="ln1852">		MakeActive(true);</a>
<a name="ln1853">}</a>
<a name="ln1854"> </a>
<a name="ln1855"> </a>
<a name="ln1856">void</a>
<a name="ln1857">TMagnify::SaveImage(entry_ref* ref, char* name)</a>
<a name="ln1858">{</a>
<a name="ln1859">	// create a new file</a>
<a name="ln1860">	BFile file;</a>
<a name="ln1861">	BDirectory parentDir(ref);</a>
<a name="ln1862">	parentDir.CreateFile(name, &amp;file);</a>
<a name="ln1863"> </a>
<a name="ln1864">	// Write the screenshot bitmap to the file</a>
<a name="ln1865">	BBitmapStream stream(fImageView-&gt;Bitmap());</a>
<a name="ln1866">	BTranslatorRoster* roster = BTranslatorRoster::Default();</a>
<a name="ln1867">	roster-&gt;Translate(&amp;stream, NULL, NULL, &amp;file, B_PNG_FORMAT,</a>
<a name="ln1868">		B_TRANSLATOR_BITMAP);</a>
<a name="ln1869"> </a>
<a name="ln1870">	BBitmap* bitmap;</a>
<a name="ln1871">	stream.DetachBitmap(&amp;bitmap);</a>
<a name="ln1872">		// The stream takes over ownership of the bitmap</a>
<a name="ln1873"> </a>
<a name="ln1874">	// unfreeze the image, image was frozen before invoke of FilePanel</a>
<a name="ln1875">	EndSave();</a>
<a name="ln1876">}</a>
<a name="ln1877"> </a>
<a name="ln1878">//	#pragma mark -</a>
<a name="ln1879"> </a>
<a name="ln1880"> </a>
<a name="ln1881">TOSMagnify::TOSMagnify(BRect r, TMagnify* parent, color_space space)</a>
<a name="ln1882">	: BView(r, &quot;ImageView&quot;, B_FOLLOW_NONE, B_WILL_DRAW | B_FRAME_EVENTS),</a>
<a name="ln1883">		fColorSpace(space), fParent(parent)</a>
<a name="ln1884">{</a>
<a name="ln1885">	switch (space) {</a>
<a name="ln1886">		case B_CMAP8:</a>
<a name="ln1887">			fBytesPerPixel = 1;</a>
<a name="ln1888">			break;</a>
<a name="ln1889">		case B_RGB15:</a>
<a name="ln1890">		case B_RGBA15:</a>
<a name="ln1891">		case B_RGB15_BIG:</a>
<a name="ln1892">		case B_RGBA15_BIG:</a>
<a name="ln1893">		case B_RGB16:</a>
<a name="ln1894">		case B_RGB16_BIG:</a>
<a name="ln1895">			fBytesPerPixel = 2;</a>
<a name="ln1896">			break;</a>
<a name="ln1897">		case B_RGB24:</a>
<a name="ln1898">			fBytesPerPixel = 3;</a>
<a name="ln1899">			break;</a>
<a name="ln1900">		case B_RGB32:</a>
<a name="ln1901">		case B_RGBA32:</a>
<a name="ln1902">		case B_RGB32_BIG:</a>
<a name="ln1903">		case B_RGBA32_BIG:</a>
<a name="ln1904">			fBytesPerPixel = 4;</a>
<a name="ln1905">			break;</a>
<a name="ln1906">		default:</a>
<a name="ln1907">			// uh, oh -- a color space we don't support</a>
<a name="ln1908">			fprintf(stderr, &quot;Tried to run in an unsupported color space; exiting\n&quot;);</a>
<a name="ln1909">			exit(1);</a>
<a name="ln1910">			break;</a>
<a name="ln1911">	}</a>
<a name="ln1912"> </a>
<a name="ln1913">	fPixel = NULL;</a>
<a name="ln1914">	fBitmap = NULL;</a>
<a name="ln1915">	fOldBits = NULL;</a>
<a name="ln1916">	InitObject();</a>
<a name="ln1917">}</a>
<a name="ln1918"> </a>
<a name="ln1919"> </a>
<a name="ln1920">TOSMagnify::~TOSMagnify()</a>
<a name="ln1921">{</a>
<a name="ln1922">	delete fPixel;</a>
<a name="ln1923">	delete fBitmap;</a>
<a name="ln1924">	free(fOldBits);</a>
<a name="ln1925">}</a>
<a name="ln1926"> </a>
<a name="ln1927"> </a>
<a name="ln1928">void</a>
<a name="ln1929">TOSMagnify::SetSpace(color_space space)</a>
<a name="ln1930">{</a>
<a name="ln1931">	fColorSpace = space;</a>
<a name="ln1932">	InitObject();</a>
<a name="ln1933">};</a>
<a name="ln1934"> </a>
<a name="ln1935"> </a>
<a name="ln1936">void</a>
<a name="ln1937">TOSMagnify::InitObject()</a>
<a name="ln1938">{</a>
<a name="ln1939">	int32 w, h;</a>
<a name="ln1940">	fParent-&gt;PixelCount(&amp;w, &amp;h);</a>
<a name="ln1941"> </a>
<a name="ln1942">	delete fBitmap;</a>
<a name="ln1943">	BRect bitsRect(0, 0, w-1, h-1);</a>
<a name="ln1944">	fBitmap = new BBitmap(bitsRect, fColorSpace);</a>
<a name="ln1945"> </a>
<a name="ln1946">	free(fOldBits);</a>
<a name="ln1947">	fOldBits = (char*)malloc(fBitmap-&gt;BitsLength());</a>
<a name="ln1948"> </a>
<a name="ln1949">	if (!fPixel) {</a>
<a name="ln1950">#if B_HOST_IS_BENDIAN</a>
<a name="ln1951">		fPixel = new BBitmap(BRect(0,0,0,0), B_RGBA32_BIG, true);</a>
<a name="ln1952">#else</a>
<a name="ln1953">		fPixel = new BBitmap(BRect(0,0,0,0), B_RGBA32, true);</a>
<a name="ln1954">#endif</a>
<a name="ln1955">		fPixelView = new BView(BRect(0,0,0,0), NULL, 0, 0);</a>
<a name="ln1956">		fPixel-&gt;Lock();</a>
<a name="ln1957">		fPixel-&gt;AddChild(fPixelView);</a>
<a name="ln1958">		fPixel-&gt;Unlock();</a>
<a name="ln1959">	}</a>
<a name="ln1960">}</a>
<a name="ln1961"> </a>
<a name="ln1962"> </a>
<a name="ln1963">void</a>
<a name="ln1964">TOSMagnify::FrameResized(float width, float height)</a>
<a name="ln1965">{</a>
<a name="ln1966">	BView::FrameResized(width, height);</a>
<a name="ln1967">	InitObject();</a>
<a name="ln1968">}</a>
<a name="ln1969"> </a>
<a name="ln1970"> </a>
<a name="ln1971">void</a>
<a name="ln1972">TOSMagnify::Resize(int32 width, int32 height)</a>
<a name="ln1973">{</a>
<a name="ln1974">	ResizeTo(width, height);</a>
<a name="ln1975">	InitObject();</a>
<a name="ln1976">}</a>
<a name="ln1977"> </a>
<a name="ln1978"> </a>
<a name="ln1979">bool</a>
<a name="ln1980">TOSMagnify::CreateImage(BPoint mouseLoc, bool force)</a>
<a name="ln1981">{</a>
<a name="ln1982">	bool created = false;</a>
<a name="ln1983">	if (Window() &amp;&amp; Window()-&gt;Lock()) {</a>
<a name="ln1984">		int32 width, height;</a>
<a name="ln1985">		fParent-&gt;PixelCount(&amp;width, &amp;height);</a>
<a name="ln1986">		int32 pixelSize = fParent-&gt;PixelSize();</a>
<a name="ln1987"> </a>
<a name="ln1988">		BRect srcRect(0, 0, width - 1, height - 1);</a>
<a name="ln1989">		srcRect.OffsetBy(mouseLoc.x - (width / 2),</a>
<a name="ln1990">			mouseLoc.y - (height / 2));</a>
<a name="ln1991"> </a>
<a name="ln1992">		if (force || CopyScreenRect(srcRect)) {</a>
<a name="ln1993">			srcRect.OffsetTo(BPoint(0, 0));</a>
<a name="ln1994">			BRect destRect(Bounds());</a>
<a name="ln1995"> </a>
<a name="ln1996">			DrawBitmap(fBitmap, srcRect, destRect);</a>
<a name="ln1997"> </a>
<a name="ln1998">			DrawGrid(width, height, destRect, pixelSize);</a>
<a name="ln1999">			DrawSelection();</a>
<a name="ln2000"> </a>
<a name="ln2001">			Sync();</a>
<a name="ln2002">			created = true;</a>
<a name="ln2003">		}</a>
<a name="ln2004">		Window()-&gt;Unlock();</a>
<a name="ln2005">	} else</a>
<a name="ln2006">		puts(&quot;window problem&quot;);</a>
<a name="ln2007"> </a>
<a name="ln2008">	return created;</a>
<a name="ln2009">}</a>
<a name="ln2010"> </a>
<a name="ln2011"> </a>
<a name="ln2012">bool</a>
<a name="ln2013">TOSMagnify::CopyScreenRect(BRect srcRect)</a>
<a name="ln2014">{</a>
<a name="ln2015">	// constrain src rect to legal screen rect</a>
<a name="ln2016">	BScreen screen(Window());</a>
<a name="ln2017">	BRect scrnframe = screen.Frame();</a>
<a name="ln2018"> </a>
<a name="ln2019">	if (srcRect.right &gt; scrnframe.right)</a>
<a name="ln2020">		srcRect.OffsetTo(scrnframe.right - srcRect.Width(), srcRect.top);</a>
<a name="ln2021">	if (srcRect.top &lt; 0)</a>
<a name="ln2022">		srcRect.OffsetTo(srcRect.left, 0);</a>
<a name="ln2023"> </a>
<a name="ln2024">	if (srcRect.bottom &gt; scrnframe.bottom)</a>
<a name="ln2025">		srcRect.OffsetTo(srcRect.left, scrnframe.bottom - srcRect.Height());</a>
<a name="ln2026">	if (srcRect.left &lt; 0)</a>
<a name="ln2027">		srcRect.OffsetTo(0, srcRect.top);</a>
<a name="ln2028"> </a>
<a name="ln2029">	// save a copy of the bits for comparison later</a>
<a name="ln2030">	memcpy(fOldBits, fBitmap-&gt;Bits(), fBitmap-&gt;BitsLength());</a>
<a name="ln2031"> </a>
<a name="ln2032">	screen.ReadBitmap(fBitmap, false, &amp;srcRect);</a>
<a name="ln2033"> </a>
<a name="ln2034">	// let caller know whether bits have actually changed</a>
<a name="ln2035">	return memcmp(fBitmap-&gt;Bits(), fOldBits, fBitmap-&gt;BitsLength()) != 0;</a>
<a name="ln2036">}</a>
<a name="ln2037"> </a>
<a name="ln2038"> </a>
<a name="ln2039">void</a>
<a name="ln2040">TOSMagnify::DrawGrid(int32 width, int32 height, BRect destRect, int32 pixelSize)</a>
<a name="ln2041">{</a>
<a name="ln2042">	// draw grid</a>
<a name="ln2043">	if (fParent-&gt;ShowGrid() &amp;&amp; fParent-&gt;PixelSize() &gt; 2) {</a>
<a name="ln2044">		BeginLineArray(width * height);</a>
<a name="ln2045"> </a>
<a name="ln2046">		// horizontal lines</a>
<a name="ln2047">		for (int32 i = pixelSize; i &lt; (height * pixelSize); i += pixelSize)</a>
<a name="ln2048">			AddLine(BPoint(0, i), BPoint(destRect.right, i), kGridGray);</a>
<a name="ln2049"> </a>
<a name="ln2050">		// vertical lines</a>
<a name="ln2051">		for (int32 i = pixelSize; i &lt; (width * pixelSize); i += pixelSize)</a>
<a name="ln2052">			AddLine(BPoint(i, 0), BPoint(i, destRect.bottom), kGridGray);</a>
<a name="ln2053"> </a>
<a name="ln2054">		EndLineArray();</a>
<a name="ln2055">	}</a>
<a name="ln2056"> </a>
<a name="ln2057">	SetHighColor(kGridGray);</a>
<a name="ln2058">	StrokeRect(destRect);</a>
<a name="ln2059">}</a>
<a name="ln2060"> </a>
<a name="ln2061"> </a>
<a name="ln2062">void</a>
<a name="ln2063">TOSMagnify::DrawSelection()</a>
<a name="ln2064">{</a>
<a name="ln2065">	if (!fParent-&gt;SelectionIsShowing())</a>
<a name="ln2066">		return;</a>
<a name="ln2067"> </a>
<a name="ln2068">	float x, y;</a>
<a name="ln2069">	int32 pixelSize = fParent-&gt;PixelSize();</a>
<a name="ln2070">	int32 squareSize = pixelSize - 2;</a>
<a name="ln2071"> </a>
<a name="ln2072">	fParent-&gt;SelectionLoc(&amp;x, &amp;y);</a>
<a name="ln2073">	x *= pixelSize; x++;</a>
<a name="ln2074">	y *= pixelSize; y++;</a>
<a name="ln2075">	BRect selRect(x, y, x+squareSize, y+squareSize);</a>
<a name="ln2076"> </a>
<a name="ln2077">	short selection = fParent-&gt;Selection();</a>
<a name="ln2078"> </a>
<a name="ln2079">	PushState();</a>
<a name="ln2080">	SetLowColor(ViewColor());</a>
<a name="ln2081">	SetHighColor(kRedColor);</a>
<a name="ln2082">	StrokeRect(selRect);</a>
<a name="ln2083">	if (selection == 0) {</a>
<a name="ln2084">		StrokeLine(BPoint(x,y), BPoint(x+squareSize,y+squareSize));</a>
<a name="ln2085">		StrokeLine(BPoint(x,y+squareSize), BPoint(x+squareSize,y));</a>
<a name="ln2086">	}</a>
<a name="ln2087"> </a>
<a name="ln2088">	bool ch1Showing, ch2Showing;</a>
<a name="ln2089">	fParent-&gt;CrossHairsShowing(&amp;ch1Showing, &amp;ch2Showing);</a>
<a name="ln2090">	if (ch1Showing) {</a>
<a name="ln2091">		SetHighColor(kBlueColor);</a>
<a name="ln2092">		fParent-&gt;CrossHair1Loc(&amp;x, &amp;y);</a>
<a name="ln2093">		x *= pixelSize; x++;</a>
<a name="ln2094">		y *= pixelSize; y++;</a>
<a name="ln2095">		selRect.Set(x, y,x+squareSize, y+squareSize);</a>
<a name="ln2096">		StrokeRect(selRect);</a>
<a name="ln2097">		BeginLineArray(4);</a>
<a name="ln2098">		AddLine(BPoint(0, y+(squareSize/2)),</a>
<a name="ln2099">			BPoint(x, y+(squareSize/2)), kBlueColor);					//	left</a>
<a name="ln2100">		AddLine(BPoint(x+squareSize,y+(squareSize/2)),</a>
<a name="ln2101">			BPoint(Bounds().Width(), y+(squareSize/2)), kBlueColor);	// right</a>
<a name="ln2102">		AddLine(BPoint(x+(squareSize/2), 0),</a>
<a name="ln2103">			BPoint(x+(squareSize/2), y), kBlueColor);					// top</a>
<a name="ln2104">		AddLine(BPoint(x+(squareSize/2), y+squareSize),</a>
<a name="ln2105">			BPoint(x+(squareSize/2), Bounds().Height()), kBlueColor);	// bottom</a>
<a name="ln2106">		EndLineArray();</a>
<a name="ln2107">		if (selection == 1) {</a>
<a name="ln2108">			StrokeLine(BPoint(x,y), BPoint(x+squareSize,y+squareSize));</a>
<a name="ln2109">			StrokeLine(BPoint(x,y+squareSize), BPoint(x+squareSize,y));</a>
<a name="ln2110">		}</a>
<a name="ln2111">	}</a>
<a name="ln2112">	if (ch2Showing) {</a>
<a name="ln2113">		SetHighColor(kBlueColor);</a>
<a name="ln2114">		fParent-&gt;CrossHair2Loc(&amp;x, &amp;y);</a>
<a name="ln2115">		x *= pixelSize; x++;</a>
<a name="ln2116">		y *= pixelSize; y++;</a>
<a name="ln2117">		selRect.Set(x, y,x+squareSize, y+squareSize);</a>
<a name="ln2118">		StrokeRect(selRect);</a>
<a name="ln2119">		BeginLineArray(4);</a>
<a name="ln2120">		AddLine(BPoint(0, y+(squareSize/2)),</a>
<a name="ln2121">			BPoint(x, y+(squareSize/2)), kBlueColor);					//	left</a>
<a name="ln2122">		AddLine(BPoint(x+squareSize,y+(squareSize/2)),</a>
<a name="ln2123">			BPoint(Bounds().Width(), y+(squareSize/2)), kBlueColor);	// right</a>
<a name="ln2124">		AddLine(BPoint(x+(squareSize/2), 0),</a>
<a name="ln2125">			BPoint(x+(squareSize/2), y), kBlueColor);					// top</a>
<a name="ln2126">		AddLine(BPoint(x+(squareSize/2), y+squareSize),</a>
<a name="ln2127">			BPoint(x+(squareSize/2), Bounds().Height()), kBlueColor);	// bottom</a>
<a name="ln2128">		EndLineArray();</a>
<a name="ln2129">		if (selection == 2) {</a>
<a name="ln2130">			StrokeLine(BPoint(x,y), BPoint(x+squareSize,y+squareSize));</a>
<a name="ln2131">			StrokeLine(BPoint(x,y+squareSize), BPoint(x+squareSize,y));</a>
<a name="ln2132">		}</a>
<a name="ln2133">	}</a>
<a name="ln2134"> </a>
<a name="ln2135">	PopState();</a>
<a name="ln2136">}</a>
<a name="ln2137"> </a>
<a name="ln2138"> </a>
<a name="ln2139">rgb_color</a>
<a name="ln2140">TOSMagnify::ColorAtSelection()</a>
<a name="ln2141">{</a>
<a name="ln2142">	float x, y;</a>
<a name="ln2143">	fParent-&gt;SelectionLoc(&amp;x, &amp;y);</a>
<a name="ln2144">	BRect srcRect(x, y, x, y);</a>
<a name="ln2145">	BRect dstRect(0, 0, 0, 0);</a>
<a name="ln2146">	fPixel-&gt;Lock();</a>
<a name="ln2147">	fPixelView-&gt;DrawBitmap(fBitmap, srcRect, dstRect);</a>
<a name="ln2148">	fPixelView-&gt;Sync();</a>
<a name="ln2149">	fPixel-&gt;Unlock();</a>
<a name="ln2150"> </a>
<a name="ln2151">	uint32 pixel = *((uint32*)fPixel-&gt;Bits());</a>
<a name="ln2152">	rgb_color c;</a>
<a name="ln2153">	c.alpha = pixel &gt;&gt; 24;</a>
<a name="ln2154">	c.red = (pixel &gt;&gt; 16) &amp; 0xFF;</a>
<a name="ln2155">	c.green = (pixel &gt;&gt; 8) &amp; 0xFF;</a>
<a name="ln2156">	c.blue = pixel &amp; 0xFF;</a>
<a name="ln2157"> </a>
<a name="ln2158">	return c;</a>
<a name="ln2159">}</a>
<a name="ln2160"> </a>
<a name="ln2161"> </a>
<a name="ln2162">//	#pragma mark -</a>
<a name="ln2163"> </a>
<a name="ln2164"> </a>
<a name="ln2165">int</a>
<a name="ln2166">main(int argc, char* argv[])</a>
<a name="ln2167">{</a>
<a name="ln2168">	int32 pixelCount = -1;</a>
<a name="ln2169"> </a>
<a name="ln2170">	if (argc &gt; 2) {</a>
<a name="ln2171">		puts(B_TRANSLATE_CONTEXT(</a>
<a name="ln2172">			&quot;usage: magnify [size] (magnify size * size pixels)&quot;,</a>
<a name="ln2173">			&quot;Console&quot;));</a>
<a name="ln2174">		exit(1);</a>
<a name="ln2175">	} else {</a>
<a name="ln2176">		if (argc == 2) {</a>
<a name="ln2177">			pixelCount = abs(atoi(argv[1]));</a>
<a name="ln2178"> </a>
<a name="ln2179">			if ((pixelCount &gt; 100) || (pixelCount &lt; 4)) {</a>
<a name="ln2180">				puts(B_TRANSLATE_CONTEXT(</a>
<a name="ln2181">					&quot;usage: magnify [size] (magnify size * size pixels)&quot;,</a>
<a name="ln2182">					&quot;Console&quot;));</a>
<a name="ln2183">				puts(B_TRANSLATE_CONTEXT(</a>
<a name="ln2184">					&quot;  size must be &gt; 4 and a multiple of 4&quot;,</a>
<a name="ln2185">					&quot;Console&quot;));</a>
<a name="ln2186">				exit(1);</a>
<a name="ln2187">			}</a>
<a name="ln2188"> </a>
<a name="ln2189">			if (pixelCount % 4) {</a>
<a name="ln2190">				puts(B_TRANSLATE_CONTEXT(</a>
<a name="ln2191">					&quot;magnify: size must be a multiple of 4&quot;,</a>
<a name="ln2192">					&quot;Console&quot;));</a>
<a name="ln2193">				exit(1);</a>
<a name="ln2194">			}</a>
<a name="ln2195">		}</a>
<a name="ln2196">	}</a>
<a name="ln2197"> </a>
<a name="ln2198">	TApp app(pixelCount);</a>
<a name="ln2199">	app.Run();</a>
<a name="ln2200">	return 0;</a>
<a name="ln2201">}</a>

</code></pre>
<div class="balloon" rel="1263"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: fImageFrozenOnSave.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
