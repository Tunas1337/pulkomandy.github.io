
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>multi.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Auich BeOS Driver for Intel Southbridge audio</a>
<a name="ln3"> *</a>
<a name="ln4"> * Copyright (c) 2003, Jerome Duval (jerome.duval@free.fr)</a>
<a name="ln5"> *</a>
<a name="ln6"> * Original code : BeOS Driver for Intel ICH AC'97 Link interface</a>
<a name="ln7"> * Copyright (c) 2002, Marcus Overhagen &lt;marcus@overhagen.de&gt;</a>
<a name="ln8"> *</a>
<a name="ln9"> * All rights reserved.</a>
<a name="ln10"> * Redistribution and use in source and binary forms, with or without modification,</a>
<a name="ln11"> * are permitted provided that the following conditions are met:</a>
<a name="ln12"> *</a>
<a name="ln13"> * - Redistributions of source code must retain the above copyright notice,</a>
<a name="ln14"> *   this list of conditions and the following disclaimer.</a>
<a name="ln15"> * - Redistributions in binary form must reproduce the above copyright notice,</a>
<a name="ln16"> *   this list of conditions and the following disclaimer in the documentation</a>
<a name="ln17"> *   and/or other materials provided with the distribution.</a>
<a name="ln18"> *</a>
<a name="ln19"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</a>
<a name="ln20"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</a>
<a name="ln21"> * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</a>
<a name="ln22"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR</a>
<a name="ln23"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</a>
<a name="ln24"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</a>
<a name="ln25"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</a>
<a name="ln26"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</a>
<a name="ln27"> * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,</a>
<a name="ln28"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</a>
<a name="ln29"> *</a>
<a name="ln30"> */</a>
<a name="ln31"> </a>
<a name="ln32">#include &lt;driver_settings.h&gt;</a>
<a name="ln33">#include &lt;OS.h&gt;</a>
<a name="ln34">#include &lt;MediaDefs.h&gt;</a>
<a name="ln35">#include &lt;string.h&gt;</a>
<a name="ln36">#include &lt;strings.h&gt;</a>
<a name="ln37"> </a>
<a name="ln38">#include &lt;kernel.h&gt;</a>
<a name="ln39"> </a>
<a name="ln40">#include &quot;hmulti_audio.h&quot;</a>
<a name="ln41">#include &quot;multi.h&quot;</a>
<a name="ln42">#include &quot;ac97.h&quot;</a>
<a name="ln43"> </a>
<a name="ln44">//#define DEBUG 1</a>
<a name="ln45"> </a>
<a name="ln46">#include &quot;debug.h&quot;</a>
<a name="ln47">#include &quot;auich.h&quot;</a>
<a name="ln48">#include &quot;util.h&quot;</a>
<a name="ln49">#include &quot;io.h&quot;</a>
<a name="ln50"> </a>
<a name="ln51"> </a>
<a name="ln52">static void</a>
<a name="ln53">auich_ac97_get_mix(void *card, const void *cookie, int32 type, float *values) {</a>
<a name="ln54">	auich_dev *dev = (auich_dev*)card;</a>
<a name="ln55">	ac97_source_info *info = (ac97_source_info *)cookie;</a>
<a name="ln56">	uint16 value, mask;</a>
<a name="ln57">	float gain;</a>
<a name="ln58"> </a>
<a name="ln59">	switch(type) {</a>
<a name="ln60">		case B_MIX_GAIN:</a>
<a name="ln61">			value = auich_codec_read(&amp;dev-&gt;config, info-&gt;reg);</a>
<a name="ln62">			//PRINT((&quot;B_MIX_GAIN value : %u\n&quot;, value));</a>
<a name="ln63">			if (info-&gt;type &amp; B_MIX_STEREO) {</a>
<a name="ln64">				mask = ((1 &lt;&lt; (info-&gt;bits + 1)) - 1) &lt;&lt; 8;</a>
<a name="ln65">				gain = ((value &amp; mask) &gt;&gt; 8) * info-&gt;granularity;</a>
<a name="ln66">				if (info-&gt;polarity == 1)</a>
<a name="ln67">					values[0] = info-&gt;max_gain - gain;</a>
<a name="ln68">				else</a>
<a name="ln69">					values[0] = gain - info-&gt;min_gain;</a>
<a name="ln70"> </a>
<a name="ln71">				mask = ((1 &lt;&lt; (info-&gt;bits + 1)) - 1);</a>
<a name="ln72">				gain = (value &amp; mask) * info-&gt;granularity;</a>
<a name="ln73">				if (info-&gt;polarity == 1)</a>
<a name="ln74">					values[1] = info-&gt;max_gain - gain;</a>
<a name="ln75">				else</a>
<a name="ln76">					values[1] = gain - info-&gt;min_gain;</a>
<a name="ln77">			} else {</a>
<a name="ln78">				mask = ((1 &lt;&lt; (info-&gt;bits + 1)) - 1);</a>
<a name="ln79">				gain = (value &amp; mask) * info-&gt;granularity;</a>
<a name="ln80">				if (info-&gt;polarity == 1)</a>
<a name="ln81">					values[0] = info-&gt;max_gain - gain;</a>
<a name="ln82">				else</a>
<a name="ln83">					values[0] = gain - info-&gt;min_gain;</a>
<a name="ln84">			}</a>
<a name="ln85">			break;</a>
<a name="ln86">		case B_MIX_MUTE:</a>
<a name="ln87">			mask = ((1 &lt;&lt; 1) - 1) &lt;&lt; 15;</a>
<a name="ln88">			value = auich_codec_read(&amp;dev-&gt;config, info-&gt;reg);</a>
<a name="ln89">			//PRINT((&quot;B_MIX_MUTE value : %u\n&quot;, value));</a>
<a name="ln90">			value &amp;= mask;</a>
<a name="ln91">			values[0] = ((value &gt;&gt; 15) == 1) ? 1.0 : 0.0;</a>
<a name="ln92">			break;</a>
<a name="ln93">		case B_MIX_MICBOOST:</a>
<a name="ln94">			mask = ((1 &lt;&lt; 1) - 1) &lt;&lt; 6;</a>
<a name="ln95">			value = auich_codec_read(&amp;dev-&gt;config, info-&gt;reg);</a>
<a name="ln96">			//PRINT((&quot;B_MIX_MICBOOST value : %u\n&quot;, value));</a>
<a name="ln97">			value &amp;= mask;</a>
<a name="ln98">			values[0] = ((value &gt;&gt; 6) == 1) ? 1.0 : 0.0;</a>
<a name="ln99">			break;</a>
<a name="ln100">		case B_MIX_MUX:</a>
<a name="ln101">			mask = ((1 &lt;&lt; 3) - 1);</a>
<a name="ln102">			value = auich_codec_read(&amp;dev-&gt;config, AC97_RECORD_SELECT);</a>
<a name="ln103">			value &amp;= mask;</a>
<a name="ln104">			//PRINT((&quot;B_MIX_MUX value : %u\n&quot;, value));</a>
<a name="ln105">			values[0] = (float)value;</a>
<a name="ln106">			break;</a>
<a name="ln107">	}</a>
<a name="ln108">}</a>
<a name="ln109"> </a>
<a name="ln110"> </a>
<a name="ln111">static void</a>
<a name="ln112">auich_ac97_set_mix(void *card, const void *cookie, int32 type, float *values) {</a>
<a name="ln113">	auich_dev *dev = (auich_dev*)card;</a>
<a name="ln114">	ac97_source_info *info = (ac97_source_info *)cookie;</a>
<a name="ln115">	uint16 value, mask;</a>
<a name="ln116">	float gain;</a>
<a name="ln117"> </a>
<a name="ln118">	switch(type) {</a>
<a name="ln119">		case B_MIX_GAIN:</a>
<a name="ln120">			value = auich_codec_read(&amp;dev-&gt;config, info-&gt;reg);</a>
<a name="ln121">			if (info-&gt;type &amp; B_MIX_STEREO) {</a>
<a name="ln122">				mask = ((1 &lt;&lt; (info-&gt;bits + 1)) - 1) &lt;&lt; 8;</a>
<a name="ln123">				value &amp;= ~mask;</a>
<a name="ln124"> </a>
<a name="ln125">				if (info-&gt;polarity == 1)</a>
<a name="ln126">					gain = info-&gt;max_gain - values[0];</a>
<a name="ln127">				else</a>
<a name="ln128">					gain =  values[0] - info-&gt;min_gain;</a>
<a name="ln129">				value |= ((uint16)(gain	/ info-&gt;granularity) &lt;&lt; 8) &amp; mask;</a>
<a name="ln130"> </a>
<a name="ln131">				mask = ((1 &lt;&lt; (info-&gt;bits + 1)) - 1);</a>
<a name="ln132">				value &amp;= ~mask;</a>
<a name="ln133">				if (info-&gt;polarity == 1)</a>
<a name="ln134">					gain = info-&gt;max_gain - values[1];</a>
<a name="ln135">				else</a>
<a name="ln136">					gain =  values[1] - info-&gt;min_gain;</a>
<a name="ln137">				value |= ((uint16)(gain / info-&gt;granularity)) &amp; mask;</a>
<a name="ln138">			} else {</a>
<a name="ln139">				mask = ((1 &lt;&lt; (info-&gt;bits + 1)) - 1);</a>
<a name="ln140">				value &amp;= ~mask;</a>
<a name="ln141">				if (info-&gt;polarity == 1)</a>
<a name="ln142">					gain = info-&gt;max_gain - values[0];</a>
<a name="ln143">				else</a>
<a name="ln144">					gain =  values[0] - info-&gt;min_gain;</a>
<a name="ln145">				value |= ((uint16)(gain / info-&gt;granularity)) &amp; mask;</a>
<a name="ln146">			}</a>
<a name="ln147">			//PRINT((&quot;B_MIX_GAIN value : %u\n&quot;, value));</a>
<a name="ln148">			auich_codec_write(&amp;dev-&gt;config, info-&gt;reg, value);</a>
<a name="ln149">			break;</a>
<a name="ln150">		case B_MIX_MUTE:</a>
<a name="ln151">			mask = ((1 &lt;&lt; 1) - 1) &lt;&lt; 15;</a>
<a name="ln152">			value = auich_codec_read(&amp;dev-&gt;config, info-&gt;reg);</a>
<a name="ln153">			value &amp;= ~mask;</a>
<a name="ln154">			value |= ((values[0] == 1.0 ? 1 : 0 ) &lt;&lt; 15 &amp; mask);</a>
<a name="ln155">			if (info-&gt;reg == AC97_SURR_VOLUME) {</a>
<a name="ln156">				// there is a independent mute for each channel</a>
<a name="ln157">				mask = ((1 &lt;&lt; 1) - 1) &lt;&lt; 7;</a>
<a name="ln158">				value &amp;= ~mask;</a>
<a name="ln159">				value |= ((values[0] == 1.0 ? 1 : 0 ) &lt;&lt; 7 &amp; mask);</a>
<a name="ln160">			}</a>
<a name="ln161">			//PRINT((&quot;B_MIX_MUTE value : %u\n&quot;, value));</a>
<a name="ln162">			auich_codec_write(&amp;dev-&gt;config, info-&gt;reg, value);</a>
<a name="ln163">			break;</a>
<a name="ln164">		case B_MIX_MICBOOST:</a>
<a name="ln165">			mask = ((1 &lt;&lt; 1) - 1) &lt;&lt; 6;</a>
<a name="ln166">			value = auich_codec_read(&amp;dev-&gt;config, info-&gt;reg);</a>
<a name="ln167">			value &amp;= ~mask;</a>
<a name="ln168">			value |= ((values[0] == 1.0 ? 1 : 0 ) &lt;&lt; 6 &amp; mask);</a>
<a name="ln169">			//PRINT((&quot;B_MIX_MICBOOST value : %u\n&quot;, value));</a>
<a name="ln170">			auich_codec_write(&amp;dev-&gt;config, info-&gt;reg, value);</a>
<a name="ln171">			break;</a>
<a name="ln172">		case B_MIX_MUX:</a>
<a name="ln173">			mask = ((1 &lt;&lt; 3) - 1);</a>
<a name="ln174">			value = ((int32)values[0]) &amp; mask;</a>
<a name="ln175">			value = value | (value &lt;&lt; 8);</a>
<a name="ln176">			//PRINT((&quot;B_MIX_MUX value : %u\n&quot;, value));</a>
<a name="ln177">			auich_codec_write(&amp;dev-&gt;config, AC97_RECORD_SELECT, value);</a>
<a name="ln178">			break;</a>
<a name="ln179">	}</a>
<a name="ln180"> </a>
<a name="ln181">}</a>
<a name="ln182"> </a>
<a name="ln183"> </a>
<a name="ln184">static int32</a>
<a name="ln185">auich_create_group_control(multi_dev *multi, int32 *index, int32 parent,</a>
<a name="ln186">	int32 string, const char* name) {</a>
<a name="ln187">	int32 i = *index;</a>
<a name="ln188">	(*index)++;</a>
<a name="ln189">	multi-&gt;controls[i].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + i;</a>
<a name="ln190">	multi-&gt;controls[i].mix_control.parent = parent;</a>
<a name="ln191">	multi-&gt;controls[i].mix_control.flags = B_MULTI_MIX_GROUP;</a>
<a name="ln192">	multi-&gt;controls[i].mix_control.master = EMU_MULTI_CONTROL_MASTERID;</a>
<a name="ln193">	multi-&gt;controls[i].mix_control.string = string;</a>
<a name="ln194">	if (name)</a>
<a name="ln195">		strcpy(multi-&gt;controls[i].mix_control.name, name);</a>
<a name="ln196"> </a>
<a name="ln197">	return multi-&gt;controls[i].mix_control.id;</a>
<a name="ln198">}</a>
<a name="ln199"> </a>
<a name="ln200"> </a>
<a name="ln201">static status_t</a>
<a name="ln202">auich_create_controls_list(multi_dev *multi)</a>
<a name="ln203">{</a>
<a name="ln204">	uint32 	i = 0, index = 0, count, id, parent, parent2, parent3;</a>
<a name="ln205">	const ac97_source_info *info;</a>
<a name="ln206"> </a>
<a name="ln207">	/* AC97 Mixer */</a>
<a name="ln208">	parent = auich_create_group_control(multi, &amp;index, 0, 0, &quot;AC97 mixer&quot;);</a>
<a name="ln209"> </a>
<a name="ln210">	count = source_info_size;</a>
<a name="ln211">	//Note that we ignore first item in source_info</a>
<a name="ln212">	//It's for recording, but do match this with ac97.c's source_info</a>
<a name="ln213">	for (i = 1; i &lt; count ; i++) {</a>
<a name="ln214">		info = &amp;source_info[i];</a>
<a name="ln215">		PRINT((&quot;name : %s\n&quot;, info-&gt;name));</a>
<a name="ln216"> </a>
<a name="ln217">		parent2 = auich_create_group_control(multi, &amp;index, parent, 0, info-&gt;name);</a>
<a name="ln218"> </a>
<a name="ln219">		if (info-&gt;type &amp; B_MIX_GAIN) {</a>
<a name="ln220">			if (info-&gt;type &amp; B_MIX_MUTE) {</a>
<a name="ln221">				multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln222">				multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_ENABLE;</a>
<a name="ln223">				multi-&gt;controls[index].mix_control.master = EMU_MULTI_CONTROL_MASTERID;</a>
<a name="ln224">				multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln225">				multi-&gt;controls[index].mix_control.string = S_MUTE;</a>
<a name="ln226">				multi-&gt;controls[index].cookie = info;</a>
<a name="ln227">				multi-&gt;controls[index].type = B_MIX_MUTE;</a>
<a name="ln228">				multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln229">				multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln230">				index++;</a>
<a name="ln231">			}</a>
<a name="ln232"> </a>
<a name="ln233">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln234">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_GAIN;</a>
<a name="ln235">			multi-&gt;controls[index].mix_control.master = EMU_MULTI_CONTROL_MASTERID;</a>
<a name="ln236">			multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln237">			strcpy(multi-&gt;controls[index].mix_control.name, info-&gt;name);</a>
<a name="ln238">			multi-&gt;controls[index].mix_control.u.gain.min_gain = info-&gt;min_gain;</a>
<a name="ln239">			multi-&gt;controls[index].mix_control.u.gain.max_gain = info-&gt;max_gain;</a>
<a name="ln240">			multi-&gt;controls[index].mix_control.u.gain.granularity = info-&gt;granularity;</a>
<a name="ln241">			multi-&gt;controls[index].cookie = info;</a>
<a name="ln242">			multi-&gt;controls[index].type = B_MIX_GAIN;</a>
<a name="ln243">			multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln244">			multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln245">			id = multi-&gt;controls[index].mix_control.id;</a>
<a name="ln246">			index++;</a>
<a name="ln247"> </a>
<a name="ln248">			if (info-&gt;type &amp; B_MIX_STEREO) {</a>
<a name="ln249">				multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln250">				multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_GAIN;</a>
<a name="ln251">				multi-&gt;controls[index].mix_control.master = id;</a>
<a name="ln252">				multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln253">				strcpy(multi-&gt;controls[index].mix_control.name, info-&gt;name);</a>
<a name="ln254">				multi-&gt;controls[index].mix_control.u.gain.min_gain = info-&gt;min_gain;</a>
<a name="ln255">				multi-&gt;controls[index].mix_control.u.gain.max_gain = info-&gt;max_gain;</a>
<a name="ln256">				multi-&gt;controls[index].mix_control.u.gain.granularity = info-&gt;granularity;</a>
<a name="ln257">				multi-&gt;controls[index].cookie = info;</a>
<a name="ln258">				multi-&gt;controls[index].type = B_MIX_GAIN;</a>
<a name="ln259">				multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln260">				multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln261">				index++;</a>
<a name="ln262">			}</a>
<a name="ln263"> </a>
<a name="ln264">			if (info-&gt;type &amp; B_MIX_MICBOOST) {</a>
<a name="ln265">				multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln266">				multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_ENABLE;</a>
<a name="ln267">				multi-&gt;controls[index].mix_control.master = EMU_MULTI_CONTROL_MASTERID;</a>
<a name="ln268">				multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln269">				strcpy(multi-&gt;controls[index].mix_control.name, &quot;+20 dB&quot;);</a>
<a name="ln270">				multi-&gt;controls[index].cookie = info;</a>
<a name="ln271">				multi-&gt;controls[index].type = B_MIX_MICBOOST;</a>
<a name="ln272">				multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln273">				multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln274">				index++;</a>
<a name="ln275">			}</a>
<a name="ln276">		}</a>
<a name="ln277">	}</a>
<a name="ln278"> </a>
<a name="ln279">	/* AC97 Record */</a>
<a name="ln280">	parent = auich_create_group_control(multi, &amp;index, 0, 0, &quot;Recording&quot;);</a>
<a name="ln281"> </a>
<a name="ln282">	info = &amp;source_info[0];</a>
<a name="ln283">	PRINT((&quot;name : %s\n&quot;, info-&gt;name));</a>
<a name="ln284"> </a>
<a name="ln285">	parent2 = auich_create_group_control(multi, &amp;index, parent, 0, info-&gt;name);</a>
<a name="ln286"> </a>
<a name="ln287">	if (info-&gt;type &amp; B_MIX_GAIN) {</a>
<a name="ln288">		if (info-&gt;type &amp; B_MIX_MUTE) {</a>
<a name="ln289">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln290">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_ENABLE;</a>
<a name="ln291">			multi-&gt;controls[index].mix_control.master = EMU_MULTI_CONTROL_MASTERID;</a>
<a name="ln292">			multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln293">			multi-&gt;controls[index].mix_control.string = S_MUTE;</a>
<a name="ln294">			multi-&gt;controls[index].cookie = info;</a>
<a name="ln295">			multi-&gt;controls[index].type = B_MIX_MUTE;</a>
<a name="ln296">			multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln297">			multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln298">			index++;</a>
<a name="ln299">		}</a>
<a name="ln300"> </a>
<a name="ln301">		multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln302">		multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_GAIN;</a>
<a name="ln303">		multi-&gt;controls[index].mix_control.master = EMU_MULTI_CONTROL_MASTERID;</a>
<a name="ln304">		multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln305">		strcpy(multi-&gt;controls[index].mix_control.name, info-&gt;name);</a>
<a name="ln306">		multi-&gt;controls[index].mix_control.u.gain.min_gain = info-&gt;min_gain;</a>
<a name="ln307">		multi-&gt;controls[index].mix_control.u.gain.max_gain = info-&gt;max_gain;</a>
<a name="ln308">		multi-&gt;controls[index].mix_control.u.gain.granularity = info-&gt;granularity;</a>
<a name="ln309">		multi-&gt;controls[index].cookie = info;</a>
<a name="ln310">		multi-&gt;controls[index].type = B_MIX_GAIN;</a>
<a name="ln311">		multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln312">		multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln313">		id = multi-&gt;controls[index].mix_control.id;</a>
<a name="ln314">		index++;</a>
<a name="ln315"> </a>
<a name="ln316">		if (info-&gt;type &amp; B_MIX_STEREO) {</a>
<a name="ln317">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln318">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_GAIN;</a>
<a name="ln319">			multi-&gt;controls[index].mix_control.master = id;</a>
<a name="ln320">			multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln321">			strcpy(multi-&gt;controls[index].mix_control.name, info-&gt;name);</a>
<a name="ln322">			multi-&gt;controls[index].mix_control.u.gain.min_gain = info-&gt;min_gain;</a>
<a name="ln323">			multi-&gt;controls[index].mix_control.u.gain.max_gain = info-&gt;max_gain;</a>
<a name="ln324">			multi-&gt;controls[index].mix_control.u.gain.granularity = info-&gt;granularity;</a>
<a name="ln325">			multi-&gt;controls[index].cookie = info;</a>
<a name="ln326">			multi-&gt;controls[index].type = B_MIX_GAIN;</a>
<a name="ln327">			multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln328">			multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln329">			index++;</a>
<a name="ln330">		}</a>
<a name="ln331"> </a>
<a name="ln332">		if (info-&gt;type &amp; B_MIX_RECORDMUX) {</a>
<a name="ln333">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln334">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX;</a>
<a name="ln335">			multi-&gt;controls[index].mix_control.parent = parent2;</a>
<a name="ln336">			strcpy(multi-&gt;controls[index].mix_control.name, &quot;Record mux&quot;);</a>
<a name="ln337">			multi-&gt;controls[index].cookie = info;</a>
<a name="ln338">			multi-&gt;controls[index].type = B_MIX_MUX;</a>
<a name="ln339">			multi-&gt;controls[index].get = &amp;auich_ac97_get_mix;</a>
<a name="ln340">			multi-&gt;controls[index].set = &amp;auich_ac97_set_mix;</a>
<a name="ln341">			parent3 = multi-&gt;controls[index].mix_control.id;</a>
<a name="ln342">			index++;</a>
<a name="ln343"> </a>
<a name="ln344">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln345">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln346">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln347">			multi-&gt;controls[index].mix_control.string = S_MIC;</a>
<a name="ln348">			index++;</a>
<a name="ln349">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln350">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln351">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln352">			strcpy(multi-&gt;controls[index].mix_control.name, &quot;CD in&quot;);</a>
<a name="ln353">			index++;</a>
<a name="ln354">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln355">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln356">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln357">			strcpy(multi-&gt;controls[index].mix_control.name, &quot;Video in&quot;);</a>
<a name="ln358">			index++;</a>
<a name="ln359">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln360">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln361">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln362">			strcpy(multi-&gt;controls[index].mix_control.name, &quot;Aux in&quot;);</a>
<a name="ln363">			index++;</a>
<a name="ln364">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln365">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln366">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln367">			strcpy(multi-&gt;controls[index].mix_control.name, &quot;Line in&quot;);</a>
<a name="ln368">			index++;</a>
<a name="ln369">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln370">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln371">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln372">			multi-&gt;controls[index].mix_control.string = S_STEREO_MIX;</a>
<a name="ln373">			index++;</a>
<a name="ln374">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln375">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln376">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln377">			multi-&gt;controls[index].mix_control.string = S_MONO_MIX;</a>
<a name="ln378">			index++;</a>
<a name="ln379">			multi-&gt;controls[index].mix_control.id = EMU_MULTI_CONTROL_FIRSTID + index;</a>
<a name="ln380">			multi-&gt;controls[index].mix_control.flags = B_MULTI_MIX_MUX_VALUE;</a>
<a name="ln381">			multi-&gt;controls[index].mix_control.parent = parent3;</a>
<a name="ln382">			strcpy(multi-&gt;controls[index].mix_control.name, &quot;TAD&quot;);</a>
<a name="ln383">			index++;</a>
<a name="ln384">		}</a>
<a name="ln385">	}</a>
<a name="ln386"> </a>
<a name="ln387">	multi-&gt;control_count = index;</a>
<a name="ln388">	PRINT((&quot;multi-&gt;control_count %lu\n&quot;, multi-&gt;control_count));</a>
<a name="ln389">	return B_OK;</a>
<a name="ln390">}</a>
<a name="ln391"> </a>
<a name="ln392"> </a>
<a name="ln393">static status_t</a>
<a name="ln394">auich_get_mix(auich_dev *card, multi_mix_value_info * mmvi)</a>
<a name="ln395">{</a>
<a name="ln396">	int32 i, id;</a>
<a name="ln397">	multi_mixer_control *control = NULL;</a>
<a name="ln398">	for (i = 0; i &lt; mmvi-&gt;item_count; i++) {</a>
<a name="ln399">		id = mmvi-&gt;values[i].id - EMU_MULTI_CONTROL_FIRSTID;</a>
<a name="ln400">		if (id &lt; 0 || id &gt;= card-&gt;multi.control_count) {</a>
<a name="ln401">			PRINT((&quot;auich_get_mix : invalid control id requested : %li\n&quot;, id));</a>
<a name="ln402">			continue;</a>
<a name="ln403">		}</a>
<a name="ln404">		control = &amp;card-&gt;multi.controls[id];</a>
<a name="ln405"> </a>
<a name="ln406">		if (control-&gt;mix_control.flags &amp; B_MULTI_MIX_GAIN) {</a>
<a name="ln407">			if (control-&gt;get) {</a>
<a name="ln408">				float values[2];</a>
<a name="ln409">				control-&gt;get(card, control-&gt;cookie, control-&gt;type, values);</a>
<a name="ln410">				if (control-&gt;mix_control.master == EMU_MULTI_CONTROL_MASTERID)</a>
<a name="ln411">					mmvi-&gt;values[i].u.gain = values[0];</a>
<a name="ln412">				else</a>
<a name="ln413">					mmvi-&gt;values[i].u.gain = values[1];</a>
<a name="ln414">			}</a>
<a name="ln415">		}</a>
<a name="ln416"> </a>
<a name="ln417">		if (control-&gt;mix_control.flags &amp; B_MULTI_MIX_ENABLE &amp;&amp; control-&gt;get) {</a>
<a name="ln418">			float values[1];</a>
<a name="ln419">			control-&gt;get(card, control-&gt;cookie, control-&gt;type, values);</a>
<a name="ln420">			mmvi-&gt;values[i].u.enable = (values[0] == 1.0);</a>
<a name="ln421">		}</a>
<a name="ln422"> </a>
<a name="ln423">		if (control-&gt;mix_control.flags &amp; B_MULTI_MIX_MUX &amp;&amp; control-&gt;get) {</a>
<a name="ln424">			float values[1];</a>
<a name="ln425">			control-&gt;get(card, control-&gt;cookie, control-&gt;type, values);</a>
<a name="ln426">			mmvi-&gt;values[i].u.mux = (int32)values[0];</a>
<a name="ln427">		}</a>
<a name="ln428">	}</a>
<a name="ln429">	return B_OK;</a>
<a name="ln430">}</a>
<a name="ln431"> </a>
<a name="ln432"> </a>
<a name="ln433">static status_t</a>
<a name="ln434">auich_set_mix(auich_dev *card, multi_mix_value_info * mmvi)</a>
<a name="ln435">{</a>
<a name="ln436">	int32 i, id;</a>
<a name="ln437">	multi_mixer_control *control = NULL;</a>
<a name="ln438">	for (i = 0; i &lt; mmvi-&gt;item_count; i++) {</a>
<a name="ln439">		id = mmvi-&gt;values[i].id - EMU_MULTI_CONTROL_FIRSTID;</a>
<a name="ln440">		if (id &lt; 0 || id &gt;= card-&gt;multi.control_count) {</a>
<a name="ln441">			PRINT((&quot;auich_set_mix : invalid control id requested : %li\n&quot;, id));</a>
<a name="ln442">			continue;</a>
<a name="ln443">		}</a>
<a name="ln444">		control = &amp;card-&gt;multi.controls[id];</a>
<a name="ln445"> </a>
<a name="ln446">		if (control-&gt;mix_control.flags &amp; B_MULTI_MIX_GAIN) {</a>
<a name="ln447">			multi_mixer_control *control2 = NULL;</a>
<a name="ln448">			if (i+1&lt;mmvi-&gt;item_count) {</a>
<a name="ln449">				id = mmvi-&gt;values[i + 1].id - EMU_MULTI_CONTROL_FIRSTID;</a>
<a name="ln450">				if (id &lt; 0 || id &gt;= card-&gt;multi.control_count) {</a>
<a name="ln451">					PRINT((&quot;auich_set_mix : invalid control id requested : %li\n&quot;, id));</a>
<a name="ln452">				} else {</a>
<a name="ln453">					control2 = &amp;card-&gt;multi.controls[id];</a>
<a name="ln454">					if (control2-&gt;mix_control.master != control-&gt;mix_control.id)</a>
<a name="ln455">						control2 = NULL;</a>
<a name="ln456">				}</a>
<a name="ln457">			}</a>
<a name="ln458"> </a>
<a name="ln459">			if (control-&gt;set) {</a>
<a name="ln460">				float values[2];</a>
<a name="ln461">				values[0] = 0.0;</a>
<a name="ln462">				values[1] = 0.0;</a>
<a name="ln463"> </a>
<a name="ln464">				if (control-&gt;mix_control.master == EMU_MULTI_CONTROL_MASTERID)</a>
<a name="ln465">					values[0] = mmvi-&gt;values[i].u.gain;</a>
<a name="ln466">				else</a>
<a name="ln467">					values[1] = mmvi-&gt;values[i].u.gain;</a>
<a name="ln468"> </a>
<a name="ln469">				if (control2 &amp;&amp; control2-&gt;mix_control.master != EMU_MULTI_CONTROL_MASTERID)</a>
<a name="ln470">					values[1] = mmvi-&gt;values[i+1].u.gain;</a>
<a name="ln471"> </a>
<a name="ln472">				control-&gt;set(card, control-&gt;cookie, control-&gt;type, values);</a>
<a name="ln473">			}</a>
<a name="ln474"> </a>
<a name="ln475">			if (control2)</a>
<a name="ln476">				i++;</a>
<a name="ln477">		}</a>
<a name="ln478"> </a>
<a name="ln479">		if (control-&gt;mix_control.flags &amp; B_MULTI_MIX_ENABLE &amp;&amp; control-&gt;set) {</a>
<a name="ln480">			float values[1];</a>
<a name="ln481"> </a>
<a name="ln482">			values[0] = mmvi-&gt;values[i].u.enable ? 1.0 : 0.0;</a>
<a name="ln483">			control-&gt;set(card, control-&gt;cookie, control-&gt;type, values);</a>
<a name="ln484">		}</a>
<a name="ln485"> </a>
<a name="ln486">		if (control-&gt;mix_control.flags &amp; B_MULTI_MIX_MUX &amp;&amp; control-&gt;set) {</a>
<a name="ln487">			float values[1];</a>
<a name="ln488"> </a>
<a name="ln489">			values[0] = (float)mmvi-&gt;values[i].u.mux;</a>
<a name="ln490">			control-&gt;set(card, control-&gt;cookie, control-&gt;type, values);</a>
<a name="ln491">		}</a>
<a name="ln492">	}</a>
<a name="ln493">	return B_OK;</a>
<a name="ln494">}</a>
<a name="ln495"> </a>
<a name="ln496"> </a>
<a name="ln497">static status_t</a>
<a name="ln498">auich_list_mix_controls(auich_dev *card, multi_mix_control_info * mmci)</a>
<a name="ln499">{</a>
<a name="ln500">	multi_mix_control	*mmc;</a>
<a name="ln501">	int32 i;</a>
<a name="ln502"> </a>
<a name="ln503">	mmc = mmci-&gt;controls;</a>
<a name="ln504">	if (mmci-&gt;control_count &lt; 24)</a>
<a name="ln505">		return B_ERROR;</a>
<a name="ln506"> </a>
<a name="ln507">	if (auich_create_controls_list(&amp;card-&gt;multi) &lt; B_OK)</a>
<a name="ln508">		return B_ERROR;</a>
<a name="ln509">	for (i = 0; i &lt; card-&gt;multi.control_count; i++) {</a>
<a name="ln510">		mmc[i] = card-&gt;multi.controls[i].mix_control;</a>
<a name="ln511">	}</a>
<a name="ln512"> </a>
<a name="ln513">	mmci-&gt;control_count = card-&gt;multi.control_count;</a>
<a name="ln514">	return B_OK;</a>
<a name="ln515">}</a>
<a name="ln516"> </a>
<a name="ln517"> </a>
<a name="ln518">static status_t</a>
<a name="ln519">auich_list_mix_connections(auich_dev *card, multi_mix_connection_info * data)</a>
<a name="ln520">{</a>
<a name="ln521">	return B_ERROR;</a>
<a name="ln522">}</a>
<a name="ln523"> </a>
<a name="ln524"> </a>
<a name="ln525">static status_t</a>
<a name="ln526">auich_list_mix_channels(auich_dev *card, multi_mix_channel_info *data)</a>
<a name="ln527">{</a>
<a name="ln528">	return B_ERROR;</a>
<a name="ln529">}</a>
<a name="ln530"> </a>
<a name="ln531">/*multi_channel_info chans[] = {</a>
<a name="ln532">{  0, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln533">{  1, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln534">{  2, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln535">{  3, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln536">{  4, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln537">{  5, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln538">{  6, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln539">{  7, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln540">{  8, B_MULTI_OUTPUT_BUS, 		B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 	B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln541">{  9, B_MULTI_OUTPUT_BUS, 		B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln542">{  10, B_MULTI_INPUT_BUS, 		B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 	B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln543">{  11, B_MULTI_INPUT_BUS, 		B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln544">};*/</a>
<a name="ln545"> </a>
<a name="ln546">/*multi_channel_info chans[] = {</a>
<a name="ln547">{  0, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln548">{  1, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln549">{  2, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_SURROUND_BUS, 0 },</a>
<a name="ln550">{  3, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_SURROUND_BUS, 0 },</a>
<a name="ln551">{  4, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_REARLEFT | B_CHANNEL_SURROUND_BUS, 0 },</a>
<a name="ln552">{  5, B_MULTI_OUTPUT_CHANNEL, 	B_CHANNEL_REARRIGHT | B_CHANNEL_SURROUND_BUS, 0 },</a>
<a name="ln553">{  6, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln554">{  7, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln555">{  8, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln556">{  9, B_MULTI_INPUT_CHANNEL, 	B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, 0 },</a>
<a name="ln557">{  10, B_MULTI_OUTPUT_BUS, 		B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 	B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln558">{  11, B_MULTI_OUTPUT_BUS, 		B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln559">{  12, B_MULTI_INPUT_BUS, 		B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS, 	B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln560">{  13, B_MULTI_INPUT_BUS, 		B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS, B_CHANNEL_MINI_JACK_STEREO },</a>
<a name="ln561">};*/</a>
<a name="ln562"> </a>
<a name="ln563"> </a>
<a name="ln564">static void</a>
<a name="ln565">auich_create_channels_list(multi_dev *multi)</a>
<a name="ln566">{</a>
<a name="ln567">	auich_stream *stream;</a>
<a name="ln568">	uint32 index, i, mode, designations;</a>
<a name="ln569">	multi_channel_info *chans;</a>
<a name="ln570">	uint32 chan_designations[] = {</a>
<a name="ln571">		B_CHANNEL_LEFT,</a>
<a name="ln572">		B_CHANNEL_RIGHT,</a>
<a name="ln573">		B_CHANNEL_REARLEFT,</a>
<a name="ln574">		B_CHANNEL_REARRIGHT,</a>
<a name="ln575">		B_CHANNEL_CENTER,</a>
<a name="ln576">		B_CHANNEL_SUB</a>
<a name="ln577">	};</a>
<a name="ln578"> </a>
<a name="ln579">	chans = multi-&gt;chans;</a>
<a name="ln580">	index = 0;</a>
<a name="ln581"> </a>
<a name="ln582">	for (mode=AUICH_USE_PLAY; mode!=-1;</a>
<a name="ln583">		mode = (mode == AUICH_USE_PLAY) ? AUICH_USE_RECORD : -1) {</a>
<a name="ln584">		LIST_FOREACH(stream, &amp;((auich_dev*)multi-&gt;card)-&gt;streams, next) {</a>
<a name="ln585">			if ((stream-&gt;use &amp; mode) == 0)</a>
<a name="ln586">				continue;</a>
<a name="ln587"> </a>
<a name="ln588">			if (stream-&gt;channels == 2)</a>
<a name="ln589">				designations = B_CHANNEL_STEREO_BUS;</a>
<a name="ln590">			else</a>
<a name="ln591">				designations = B_CHANNEL_SURROUND_BUS;</a>
<a name="ln592"> </a>
<a name="ln593">			for (i = 0; i &lt; stream-&gt;channels; i++) {</a>
<a name="ln594">				chans[index].channel_id = index;</a>
<a name="ln595">				chans[index].kind = (mode == AUICH_USE_PLAY) ? B_MULTI_OUTPUT_CHANNEL : B_MULTI_INPUT_CHANNEL;</a>
<a name="ln596">				chans[index].designations = designations | chan_designations[i];</a>
<a name="ln597">				chans[index].connectors = 0;</a>
<a name="ln598">				index++;</a>
<a name="ln599">			}</a>
<a name="ln600">		}</a>
<a name="ln601"> </a>
<a name="ln602">		if (mode==AUICH_USE_PLAY) {</a>
<a name="ln603">			multi-&gt;output_channel_count = index;</a>
<a name="ln604">		} else {</a>
<a name="ln605">			multi-&gt;input_channel_count = index - multi-&gt;output_channel_count;</a>
<a name="ln606">		}</a>
<a name="ln607">	}</a>
<a name="ln608"> </a>
<a name="ln609">	chans[index].channel_id = index;</a>
<a name="ln610">	chans[index].kind = B_MULTI_OUTPUT_BUS;</a>
<a name="ln611">	chans[index].designations = B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS;</a>
<a name="ln612">	chans[index].connectors = B_CHANNEL_MINI_JACK_STEREO;</a>
<a name="ln613">	index++;</a>
<a name="ln614"> </a>
<a name="ln615">	chans[index].channel_id = index;</a>
<a name="ln616">	chans[index].kind = B_MULTI_OUTPUT_BUS;</a>
<a name="ln617">	chans[index].designations = B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS;</a>
<a name="ln618">	chans[index].connectors = B_CHANNEL_MINI_JACK_STEREO;</a>
<a name="ln619">	index++;</a>
<a name="ln620"> </a>
<a name="ln621">	multi-&gt;output_bus_channel_count = index - multi-&gt;output_channel_count</a>
<a name="ln622">		- multi-&gt;input_channel_count;</a>
<a name="ln623"> </a>
<a name="ln624">	chans[index].channel_id = index;</a>
<a name="ln625">	chans[index].kind = B_MULTI_INPUT_BUS;</a>
<a name="ln626">	chans[index].designations = B_CHANNEL_LEFT | B_CHANNEL_STEREO_BUS;</a>
<a name="ln627">	chans[index].connectors = B_CHANNEL_MINI_JACK_STEREO;</a>
<a name="ln628">	index++;</a>
<a name="ln629"> </a>
<a name="ln630">	chans[index].channel_id = index;</a>
<a name="ln631">	chans[index].kind = B_MULTI_INPUT_BUS;</a>
<a name="ln632">	chans[index].designations = B_CHANNEL_RIGHT | B_CHANNEL_STEREO_BUS;</a>
<a name="ln633">	chans[index].connectors = B_CHANNEL_MINI_JACK_STEREO;</a>
<a name="ln634">	index++;</a>
<a name="ln635"> </a>
<a name="ln636">	multi-&gt;input_bus_channel_count = index - multi-&gt;output_channel_count</a>
<a name="ln637">		- multi-&gt;input_channel_count - multi-&gt;output_bus_channel_count;</a>
<a name="ln638"> </a>
<a name="ln639">	multi-&gt;aux_bus_channel_count = 0;</a>
<a name="ln640">}</a>
<a name="ln641"> </a>
<a name="ln642"> </a>
<a name="ln643">static status_t</a>
<a name="ln644">auich_get_description(auich_dev *card, multi_description *data)</a>
<a name="ln645">{</a>
<a name="ln646">	uint32 size;</a>
<a name="ln647"> </a>
<a name="ln648">	data-&gt;interface_version = B_CURRENT_INTERFACE_VERSION;</a>
<a name="ln649">	data-&gt;interface_minimum = B_CURRENT_INTERFACE_VERSION;</a>
<a name="ln650"> </a>
<a name="ln651">	switch(card-&gt;info.vendor_id) {</a>
<a name="ln652">		case INTEL_VENDOR_ID:</a>
<a name="ln653">			strncpy(data-&gt;friendly_name, FRIENDLY_NAME_ICH, 32);</a>
<a name="ln654">		break;</a>
<a name="ln655">		case SIS_VENDOR_ID:</a>
<a name="ln656">			strncpy(data-&gt;friendly_name, FRIENDLY_NAME_SIS, 32);</a>
<a name="ln657">		break;</a>
<a name="ln658">		case NVIDIA_VENDOR_ID:</a>
<a name="ln659">			strncpy(data-&gt;friendly_name, FRIENDLY_NAME_NVIDIA, 32);</a>
<a name="ln660">		break;</a>
<a name="ln661">		case AMD_VENDOR_ID:</a>
<a name="ln662">			strncpy(data-&gt;friendly_name, FRIENDLY_NAME_AMD, 32);</a>
<a name="ln663">		break;</a>
<a name="ln664">	}</a>
<a name="ln665"> </a>
<a name="ln666">	strcpy(data-&gt;vendor_info, AUTHOR);</a>
<a name="ln667"> </a>
<a name="ln668">	/*data-&gt;output_channel_count = 6;</a>
<a name="ln669">	data-&gt;input_channel_count = 4;</a>
<a name="ln670">	data-&gt;output_bus_channel_count = 2;</a>
<a name="ln671">	data-&gt;input_bus_channel_count = 2;</a>
<a name="ln672">	data-&gt;aux_bus_channel_count = 0;*/</a>
<a name="ln673"> </a>
<a name="ln674">	data-&gt;output_channel_count = card-&gt;multi.output_channel_count;</a>
<a name="ln675">	data-&gt;input_channel_count = card-&gt;multi.input_channel_count;</a>
<a name="ln676">	data-&gt;output_bus_channel_count = card-&gt;multi.output_bus_channel_count;</a>
<a name="ln677">	data-&gt;input_bus_channel_count = card-&gt;multi.input_bus_channel_count;</a>
<a name="ln678">	data-&gt;aux_bus_channel_count = card-&gt;multi.aux_bus_channel_count;</a>
<a name="ln679"> </a>
<a name="ln680">	size = card-&gt;multi.output_channel_count + card-&gt;multi.input_channel_count</a>
<a name="ln681">			+ card-&gt;multi.output_bus_channel_count + card-&gt;multi.input_bus_channel_count</a>
<a name="ln682">			+ card-&gt;multi.aux_bus_channel_count;</a>
<a name="ln683"> </a>
<a name="ln684">	// for each channel, starting with the first output channel,</a>
<a name="ln685">	// then the second, third..., followed by the first input</a>
<a name="ln686">	// channel, second, third, ..., followed by output bus</a>
<a name="ln687">	// channels and input bus channels and finally auxillary channels,</a>
<a name="ln688"> </a>
<a name="ln689">	LOG((&quot;request_channel_count = %d\n&quot;,data-&gt;request_channel_count));</a>
<a name="ln690">	if (data-&gt;request_channel_count &gt;= size) {</a>
<a name="ln691">		LOG((&quot;copying data\n&quot;));</a>
<a name="ln692">		memcpy(data-&gt;channels, card-&gt;multi.chans, size * sizeof(card-&gt;multi.chans[0]));</a>
<a name="ln693">	}</a>
<a name="ln694"> </a>
<a name="ln695">	switch (current_settings.sample_rate) {</a>
<a name="ln696">		case 48000: data-&gt;output_rates = data-&gt;input_rates = B_SR_48000; break;</a>
<a name="ln697">		case 44100: data-&gt;output_rates = data-&gt;input_rates = B_SR_44100; break;</a>
<a name="ln698">	}</a>
<a name="ln699">	data-&gt;min_cvsr_rate = 0;</a>
<a name="ln700">	data-&gt;max_cvsr_rate = 48000;</a>
<a name="ln701"> </a>
<a name="ln702">	data-&gt;output_formats = B_FMT_16BIT;</a>
<a name="ln703">	data-&gt;input_formats = B_FMT_16BIT;</a>
<a name="ln704">	data-&gt;lock_sources = B_MULTI_LOCK_INTERNAL;</a>
<a name="ln705">	data-&gt;timecode_sources = 0;</a>
<a name="ln706">	data-&gt;interface_flags = B_MULTI_INTERFACE_PLAYBACK | B_MULTI_INTERFACE_RECORD;</a>
<a name="ln707">	data-&gt;start_latency = 3000;</a>
<a name="ln708"> </a>
<a name="ln709">	strcpy(data-&gt;control_panel,&quot;&quot;);</a>
<a name="ln710"> </a>
<a name="ln711">	return B_OK;</a>
<a name="ln712">}</a>
<a name="ln713"> </a>
<a name="ln714"> </a>
<a name="ln715">static status_t</a>
<a name="ln716">auich_get_enabled_channels(auich_dev *card, multi_channel_enable *data)</a>
<a name="ln717">{</a>
<a name="ln718">	B_SET_CHANNEL(data-&gt;enable_bits, 0, true);</a>
<a name="ln719">	B_SET_CHANNEL(data-&gt;enable_bits, 1, true);</a>
<a name="ln720">	B_SET_CHANNEL(data-&gt;enable_bits, 2, true);</a>
<a name="ln721">	B_SET_CHANNEL(data-&gt;enable_bits, 3, true);</a>
<a name="ln722">	data-&gt;lock_source = B_MULTI_LOCK_INTERNAL;</a>
<a name="ln723">/*</a>
<a name="ln724">	uint32			lock_source;</a>
<a name="ln725">	int32			lock_data;</a>
<a name="ln726">	uint32			timecode_source;</a>
<a name="ln727">	uint32 *		connectors;</a>
<a name="ln728">*/</a>
<a name="ln729">	return B_OK;</a>
<a name="ln730">}</a>
<a name="ln731"> </a>
<a name="ln732"> </a>
<a name="ln733">static status_t</a>
<a name="ln734">auich_get_global_format(auich_dev *card, multi_format_info *data)</a>
<a name="ln735">{</a>
<a name="ln736">	data-&gt;output_latency = 0;</a>
<a name="ln737">	data-&gt;input_latency = 0;</a>
<a name="ln738">	data-&gt;timecode_kind = 0;</a>
<a name="ln739">	switch (current_settings.sample_rate) {</a>
<a name="ln740">		case 48000:</a>
<a name="ln741">			data-&gt;input.rate = data-&gt;output.rate = B_SR_48000;</a>
<a name="ln742">			data-&gt;input.cvsr = data-&gt;output.cvsr = 48000;</a>
<a name="ln743">			break;</a>
<a name="ln744">		case 44100:</a>
<a name="ln745">			data-&gt;input.rate = data-&gt;output.rate = B_SR_44100;</a>
<a name="ln746">			data-&gt;input.cvsr = data-&gt;output.cvsr = 44100;</a>
<a name="ln747">			break;</a>
<a name="ln748">	}</a>
<a name="ln749">	data-&gt;input.format = data-&gt;output.format = B_FMT_16BIT;</a>
<a name="ln750">	return B_OK;</a>
<a name="ln751">}</a>
<a name="ln752"> </a>
<a name="ln753"> </a>
<a name="ln754">static status_t</a>
<a name="ln755">auich_set_global_format(auich_dev *card, multi_format_info* data)</a>
<a name="ln756">{</a>
<a name="ln757">	// TODO: it looks like we're not supposed to fail; fix this!</a>
<a name="ln758">	return B_OK;</a>
<a name="ln759">}</a>
<a name="ln760"> </a>
<a name="ln761"> </a>
<a name="ln762">static status_t</a>
<a name="ln763">auich_get_buffers(auich_dev *card, multi_buffer_list *data)</a>
<a name="ln764">{</a>
<a name="ln765">	uint8 i, j, pchannels, rchannels, bufcount;</a>
<a name="ln766"> </a>
<a name="ln767">	LOG((&quot;flags = %#x\n&quot;,data-&gt;flags));</a>
<a name="ln768">	LOG((&quot;request_playback_buffers = %#x\n&quot;,data-&gt;request_playback_buffers));</a>
<a name="ln769">	LOG((&quot;request_playback_channels = %#x\n&quot;,data-&gt;request_playback_channels));</a>
<a name="ln770">	LOG((&quot;request_playback_buffer_size = %#x\n&quot;,data-&gt;request_playback_buffer_size));</a>
<a name="ln771">	LOG((&quot;request_record_buffers = %#x\n&quot;,data-&gt;request_record_buffers));</a>
<a name="ln772">	LOG((&quot;request_record_channels = %#x\n&quot;,data-&gt;request_record_channels));</a>
<a name="ln773">	LOG((&quot;request_record_buffer_size = %#x\n&quot;,data-&gt;request_record_buffer_size));</a>
<a name="ln774"> </a>
<a name="ln775">	pchannels = card-&gt;pstream-&gt;channels;</a>
<a name="ln776">	rchannels = card-&gt;rstream-&gt;channels;</a>
<a name="ln777"> </a>
<a name="ln778">	if (data-&gt;request_playback_buffers &lt; current_settings.buffer_count ||</a>
<a name="ln779">		data-&gt;request_playback_channels &lt; (pchannels) ||</a>
<a name="ln780">		data-&gt;request_record_buffers &lt; current_settings.buffer_count ||</a>
<a name="ln781">		data-&gt;request_record_channels &lt; (rchannels)) {</a>
<a name="ln782">		LOG((&quot;not enough channels/buffers\n&quot;));</a>
<a name="ln783">	}</a>
<a name="ln784"> </a>
<a name="ln785">	ASSERT(current_settings.buffer_count == 2);</a>
<a name="ln786"> </a>
<a name="ln787">	data-&gt;flags = B_MULTI_BUFFER_PLAYBACK | B_MULTI_BUFFER_RECORD; // XXX ???</a>
<a name="ln788">//	data-&gt;flags = 0;</a>
<a name="ln789"> </a>
<a name="ln790">	data-&gt;return_playback_buffers = current_settings.buffer_count;	/* playback_buffers[b][] */</a>
<a name="ln791">	data-&gt;return_playback_channels = pchannels;		/* playback_buffers[][c] */</a>
<a name="ln792">	data-&gt;return_playback_buffer_size = current_settings.buffer_frames;		/* frames */</a>
<a name="ln793"> </a>
<a name="ln794">	bufcount = current_settings.buffer_count;</a>
<a name="ln795">	if (bufcount &gt; data-&gt;request_playback_buffers)</a>
<a name="ln796">		bufcount = data-&gt;request_playback_buffers;</a>
<a name="ln797"> </a>
<a name="ln798">	for (i = 0; i &lt; bufcount; i++) {</a>
<a name="ln799">		struct buffer_desc descs[data-&gt;return_playback_channels];</a>
<a name="ln800">		for (j=0; j&lt;pchannels; j++)</a>
<a name="ln801">			auich_stream_get_nth_buffer(card-&gt;pstream, j, i,</a>
<a name="ln802">				&amp;descs[j].base,</a>
<a name="ln803">				&amp;descs[j].stride);</a>
<a name="ln804">		if (!IS_USER_ADDRESS(data-&gt;playback_buffers[i])</a>
<a name="ln805">			|| user_memcpy(data-&gt;playback_buffers[i], descs, sizeof(descs))</a>
<a name="ln806">			&lt; B_OK) {</a>
<a name="ln807">			return B_BAD_ADDRESS;</a>
<a name="ln808">		}</a>
<a name="ln809">	}</a>
<a name="ln810">	data-&gt;return_record_buffers = current_settings.buffer_count;</a>
<a name="ln811">	data-&gt;return_record_channels = rchannels;</a>
<a name="ln812">	data-&gt;return_record_buffer_size = current_settings.buffer_frames;	/* frames */</a>
<a name="ln813"> </a>
<a name="ln814">	bufcount = current_settings.buffer_count;</a>
<a name="ln815">	if (bufcount &gt; data-&gt;request_record_buffers)</a>
<a name="ln816">		bufcount = data-&gt;request_record_buffers;</a>
<a name="ln817"> </a>
<a name="ln818">	for (i = 0; i &lt; bufcount; i++) {</a>
<a name="ln819">		struct buffer_desc descs[data-&gt;return_record_channels];</a>
<a name="ln820">		for (j=0; j&lt;rchannels; j++)</a>
<a name="ln821">			auich_stream_get_nth_buffer(card-&gt;rstream, j, i,</a>
<a name="ln822">				&amp;descs[j].base,</a>
<a name="ln823">				&amp;descs[j].stride);</a>
<a name="ln824">		if (!IS_USER_ADDRESS(data-&gt;record_buffers[i])</a>
<a name="ln825">			|| user_memcpy(data-&gt;record_buffers[i], descs, sizeof(descs))</a>
<a name="ln826">			&lt; B_OK) {</a>
<a name="ln827">			return B_BAD_ADDRESS;</a>
<a name="ln828">		}</a>
<a name="ln829">	}</a>
<a name="ln830">	return B_OK;</a>
<a name="ln831">}</a>
<a name="ln832"> </a>
<a name="ln833"> </a>
<a name="ln834">static void</a>
<a name="ln835">auich_play_inth(void* inthparams)</a>
<a name="ln836">{</a>
<a name="ln837">	auich_stream *stream = (auich_stream *)inthparams;</a>
<a name="ln838">	//int32 count;</a>
<a name="ln839"> </a>
<a name="ln840">	acquire_spinlock(&amp;slock);</a>
<a name="ln841">	stream-&gt;real_time = system_time();</a>
<a name="ln842">	stream-&gt;frames_count += current_settings.buffer_frames;</a>
<a name="ln843">	stream-&gt;buffer_cycle = (stream-&gt;trigblk</a>
<a name="ln844">		+ stream-&gt;blkmod - 1) % stream-&gt;blkmod;</a>
<a name="ln845">	stream-&gt;update_needed = true;</a>
<a name="ln846">	release_spinlock(&amp;slock);</a>
<a name="ln847"> </a>
<a name="ln848">	TRACE((&quot;auich_play_inth : cycle : %d\n&quot;, stream-&gt;buffer_cycle));</a>
<a name="ln849"> </a>
<a name="ln850">	//get_sem_count(stream-&gt;card-&gt;buffer_ready_sem, &amp;count);</a>
<a name="ln851">	//if (count &lt;= 0)</a>
<a name="ln852">		release_sem_etc(stream-&gt;card-&gt;buffer_ready_sem, 1, B_DO_NOT_RESCHEDULE);</a>
<a name="ln853">}</a>
<a name="ln854"> </a>
<a name="ln855"> </a>
<a name="ln856">static void</a>
<a name="ln857">auich_record_inth(void* inthparams)</a>
<a name="ln858">{</a>
<a name="ln859">	auich_stream *stream = (auich_stream *)inthparams;</a>
<a name="ln860">	//int32 count;</a>
<a name="ln861"> </a>
<a name="ln862">	acquire_spinlock(&amp;slock);</a>
<a name="ln863">	stream-&gt;real_time = system_time();</a>
<a name="ln864">	stream-&gt;frames_count += current_settings.buffer_frames;</a>
<a name="ln865">	stream-&gt;buffer_cycle = (stream-&gt;trigblk</a>
<a name="ln866">		+ stream-&gt;blkmod - 1) % stream-&gt;blkmod;</a>
<a name="ln867">	stream-&gt;update_needed = true;</a>
<a name="ln868">	release_spinlock(&amp;slock);</a>
<a name="ln869"> </a>
<a name="ln870">	TRACE((&quot;auich_record_inth : cycle : %d\n&quot;, stream-&gt;buffer_cycle));</a>
<a name="ln871"> </a>
<a name="ln872">	//get_sem_count(stream-&gt;card-&gt;buffer_ready_sem, &amp;count);</a>
<a name="ln873">	//if (count &lt;= 0)</a>
<a name="ln874">		release_sem_etc(stream-&gt;card-&gt;buffer_ready_sem, 1, B_DO_NOT_RESCHEDULE);</a>
<a name="ln875">}</a>
<a name="ln876"> </a>
<a name="ln877"> </a>
<a name="ln878">static status_t</a>
<a name="ln879">auich_buffer_exchange(auich_dev *card, multi_buffer_info *data)</a>
<a name="ln880">{</a>
<a name="ln881">	cpu_status status;</a>
<a name="ln882">	auich_stream *pstream, *rstream;</a>
<a name="ln883">	multi_buffer_info buffer_info;</a>
<a name="ln884"> </a>
<a name="ln885">#ifdef __HAIKU__</a>
<a name="ln886">	if (user_memcpy(&amp;buffer_info, data, sizeof(buffer_info)) &lt; B_OK)</a>
<a name="ln887">		return B_BAD_ADDRESS;</a>
<a name="ln888">#else</a>
<a name="ln889">	memcpy(&amp;buffer_info, data, sizeof(buffer_info));</a>
<a name="ln890">#endif</a>
<a name="ln891"> </a>
<a name="ln892">	buffer_info.flags = B_MULTI_BUFFER_PLAYBACK | B_MULTI_BUFFER_RECORD;</a>
<a name="ln893"> </a>
<a name="ln894">	if (!(card-&gt;pstream-&gt;state &amp; AUICH_STATE_STARTED))</a>
<a name="ln895">		auich_stream_start(card-&gt;pstream, auich_play_inth, card-&gt;pstream);</a>
<a name="ln896"> </a>
<a name="ln897">	if (!(card-&gt;rstream-&gt;state &amp; AUICH_STATE_STARTED))</a>
<a name="ln898">		auich_stream_start(card-&gt;rstream, auich_record_inth, card-&gt;rstream);</a>
<a name="ln899"> </a>
<a name="ln900">	if (acquire_sem_etc(card-&gt;buffer_ready_sem, 1, B_RELATIVE_TIMEOUT | B_CAN_INTERRUPT, 50000)</a>
<a name="ln901">		== B_TIMED_OUT) {</a>
<a name="ln902">		LOG((&quot;buffer_exchange timeout ff\n&quot;));</a>
<a name="ln903">	}</a>
<a name="ln904"> </a>
<a name="ln905">	status = lock();</a>
<a name="ln906"> </a>
<a name="ln907">	LIST_FOREACH(pstream, &amp;card-&gt;streams, next) {</a>
<a name="ln908">		if ((pstream-&gt;use &amp; AUICH_USE_PLAY) == 0 ||</a>
<a name="ln909">			(pstream-&gt;state &amp; AUICH_STATE_STARTED) == 0)</a>
<a name="ln910">			continue;</a>
<a name="ln911">		if (pstream-&gt;update_needed)</a>
<a name="ln912">			break;</a>
<a name="ln913">	}</a>
<a name="ln914"> </a>
<a name="ln915">	LIST_FOREACH(rstream, &amp;card-&gt;streams, next) {</a>
<a name="ln916">		if ((rstream-&gt;use &amp; AUICH_USE_RECORD) == 0 ||</a>
<a name="ln917">			(rstream-&gt;state &amp; AUICH_STATE_STARTED) == 0)</a>
<a name="ln918">			continue;</a>
<a name="ln919">		if (rstream-&gt;update_needed)</a>
<a name="ln920">			break;</a>
<a name="ln921">	}</a>
<a name="ln922"> </a>
<a name="ln923">	if (!pstream)</a>
<a name="ln924">		pstream = card-&gt;pstream;</a>
<a name="ln925">	if (!rstream)</a>
<a name="ln926">		rstream = card-&gt;rstream;</a>
<a name="ln927"> </a>
<a name="ln928">	/* do playback */</a>
<a name="ln929">	buffer_info.playback_buffer_cycle = pstream-&gt;buffer_cycle;</a>
<a name="ln930">	buffer_info.played_real_time = pstream-&gt;real_time;</a>
<a name="ln931">	buffer_info.played_frames_count = pstream-&gt;frames_count;</a>
<a name="ln932">	buffer_info._reserved_0 = pstream-&gt;first_channel;</a>
<a name="ln933">	pstream-&gt;update_needed = false;</a>
<a name="ln934"> </a>
<a name="ln935">	/* do record */</a>
<a name="ln936">	buffer_info.record_buffer_cycle = rstream-&gt;buffer_cycle;</a>
<a name="ln937">	buffer_info.recorded_frames_count = rstream-&gt;frames_count;</a>
<a name="ln938">	buffer_info.recorded_real_time = rstream-&gt;real_time;</a>
<a name="ln939">	buffer_info._reserved_1 = rstream-&gt;first_channel;</a>
<a name="ln940">	rstream-&gt;update_needed = false;</a>
<a name="ln941">	unlock(status);</a>
<a name="ln942"> </a>
<a name="ln943">#ifdef __HAIKU__</a>
<a name="ln944">	if (user_memcpy(data, &amp;buffer_info, sizeof(buffer_info)) &lt; B_OK)</a>
<a name="ln945">		return B_BAD_ADDRESS;</a>
<a name="ln946">#else</a>
<a name="ln947">	memcpy(data, &amp;buffer_info, sizeof(buffer_info));</a>
<a name="ln948">#endif</a>
<a name="ln949"> </a>
<a name="ln950">	//TRACE((&quot;buffer_exchange ended\n&quot;));</a>
<a name="ln951">	return B_OK;</a>
<a name="ln952">}</a>
<a name="ln953"> </a>
<a name="ln954"> </a>
<a name="ln955">static status_t</a>
<a name="ln956">auich_buffer_force_stop(auich_dev *card)</a>
<a name="ln957">{</a>
<a name="ln958">	//auich_voice_halt(card-&gt;pvoice);</a>
<a name="ln959">	return B_OK;</a>
<a name="ln960">}</a>
<a name="ln961"> </a>
<a name="ln962"> </a>
<a name="ln963">#define cookie_type auich_dev</a>
<a name="ln964">#define get_description auich_get_description</a>
<a name="ln965">#define get_enabled_channels auich_get_enabled_channels</a>
<a name="ln966">#define get_global_format auich_get_global_format</a>
<a name="ln967">#define set_global_format auich_set_global_format</a>
<a name="ln968">#define list_mix_channels auich_list_mix_channels</a>
<a name="ln969">#define list_mix_controls auich_list_mix_controls</a>
<a name="ln970">#define list_mix_connections auich_list_mix_connections</a>
<a name="ln971">#define get_mix auich_get_mix</a>
<a name="ln972">#define set_mix auich_set_mix</a>
<a name="ln973">#define get_buffers auich_get_buffers</a>
<a name="ln974">#define buffer_exchange auich_buffer_exchange</a>
<a name="ln975">#define buffer_force_stop auich_buffer_force_stop</a>
<a name="ln976">#include &quot;../generic/multi.c&quot;</a>
<a name="ln977"> </a>
<a name="ln978"> </a>
<a name="ln979">static status_t</a>
<a name="ln980">auich_multi_control(void *cookie, uint32 op, void *arg, size_t length)</a>
<a name="ln981">{</a>
<a name="ln982">	auich_dev *card = (auich_dev *)cookie;</a>
<a name="ln983"> </a>
<a name="ln984">	return multi_audio_control_generic(card, op, arg, length);</a>
<a name="ln985">}</a>
<a name="ln986"> </a>
<a name="ln987">static status_t auich_open(const char *name, uint32 flags, void** cookie);</a>
<a name="ln988">static status_t auich_close(void* cookie);</a>
<a name="ln989">static status_t auich_free(void* cookie);</a>
<a name="ln990">static status_t auich_control(void* cookie, uint32 op, void* arg, size_t len);</a>
<a name="ln991">static status_t auich_read(void* cookie, off_t position, void *buf, size_t* num_bytes);</a>
<a name="ln992">static status_t auich_write(void* cookie, off_t position, const void* buffer, size_t* num_bytes);</a>
<a name="ln993"> </a>
<a name="ln994">device_hooks multi_hooks = {</a>
<a name="ln995">	auich_open, 			/* -&gt; open entry point */</a>
<a name="ln996">	auich_close, 			/* -&gt; close entry point */</a>
<a name="ln997">	auich_free,			/* -&gt; free cookie */</a>
<a name="ln998">	auich_control, 		/* -&gt; control entry point */</a>
<a name="ln999">	auich_read,			/* -&gt; read entry point */</a>
<a name="ln1000">	auich_write,			/* -&gt; write entry point */</a>
<a name="ln1001">	NULL,					/* start select */</a>
<a name="ln1002">	NULL,					/* stop select */</a>
<a name="ln1003">	NULL,					/* scatter-gather read from the device */</a>
<a name="ln1004">	NULL					/* scatter-gather write to the device */</a>
<a name="ln1005">};</a>
<a name="ln1006"> </a>
<a name="ln1007"> </a>
<a name="ln1008">static status_t</a>
<a name="ln1009">auich_open(const char *name, uint32 flags, void** cookie)</a>
<a name="ln1010">{</a>
<a name="ln1011">	auich_dev *card = NULL;</a>
<a name="ln1012">	void *settings_handle;</a>
<a name="ln1013">	int ix;</a>
<a name="ln1014"> </a>
<a name="ln1015">	LOG((&quot;open()\n&quot;));</a>
<a name="ln1016"> </a>
<a name="ln1017">	for (ix=0; ix&lt;num_cards; ix++) {</a>
<a name="ln1018">		if (!strcmp(cards[ix].name, name)) {</a>
<a name="ln1019">			card = &amp;cards[ix];</a>
<a name="ln1020">		}</a>
<a name="ln1021">	}</a>
<a name="ln1022"> </a>
<a name="ln1023">	if (card == NULL) {</a>
<a name="ln1024">		LOG((&quot;open() card not found %s\n&quot;, name));</a>
<a name="ln1025">		for (ix=0; ix&lt;num_cards; ix++) {</a>
<a name="ln1026">			LOG((&quot;open() card available %s\n&quot;, cards[ix].name));</a>
<a name="ln1027">		}</a>
<a name="ln1028">		return B_ERROR;</a>
<a name="ln1029">	}</a>
<a name="ln1030"> </a>
<a name="ln1031">	LOG((&quot;open() got card\n&quot;));</a>
<a name="ln1032"> </a>
<a name="ln1033">	if (card-&gt;pstream !=NULL)</a>
<a name="ln1034">		return B_ERROR;</a>
<a name="ln1035">	if (card-&gt;rstream !=NULL)</a>
<a name="ln1036">		return B_ERROR;</a>
<a name="ln1037"> </a>
<a name="ln1038">	*cookie = card;</a>
<a name="ln1039">	card-&gt;multi.card = card;</a>
<a name="ln1040"> </a>
<a name="ln1041">	// get driver settings</a>
<a name="ln1042">	settings_handle = load_driver_settings(AUICH_SETTINGS);</a>
<a name="ln1043">	if (settings_handle != NULL) {</a>
<a name="ln1044">		const char *item;</a>
<a name="ln1045">		char       *end;</a>
<a name="ln1046">		uint32      value;</a>
<a name="ln1047"> </a>
<a name="ln1048">		item = get_driver_parameter (settings_handle, &quot;sample_rate&quot;, &quot;48000&quot;, &quot;48000&quot;);</a>
<a name="ln1049">		value = strtoul (item, &amp;end, 0);</a>
<a name="ln1050">		if (*end == '\0')</a>
<a name="ln1051">			current_settings.sample_rate = value;</a>
<a name="ln1052"> </a>
<a name="ln1053">		item = get_driver_parameter (settings_handle, &quot;buffer_frames&quot;, &quot;256&quot;, &quot;256&quot;);</a>
<a name="ln1054">		value = strtoul (item, &amp;end, 0);</a>
<a name="ln1055">		if (*end == '\0')</a>
<a name="ln1056">			current_settings.buffer_frames = value;</a>
<a name="ln1057"> </a>
<a name="ln1058">		item = get_driver_parameter (settings_handle, &quot;buffer_count&quot;, &quot;4&quot;, &quot;4&quot;);</a>
<a name="ln1059">		value = strtoul (item, &amp;end, 0);</a>
<a name="ln1060">		if (*end == '\0')</a>
<a name="ln1061">			current_settings.buffer_count = value;</a>
<a name="ln1062"> </a>
<a name="ln1063">		unload_driver_settings(settings_handle);</a>
<a name="ln1064">	}</a>
<a name="ln1065"> </a>
<a name="ln1066">	LOG((&quot;stream_new\n&quot;));</a>
<a name="ln1067"> </a>
<a name="ln1068">	card-&gt;rstream = auich_stream_new(card, AUICH_USE_RECORD, current_settings.buffer_frames, current_settings.buffer_count);</a>
<a name="ln1069">	card-&gt;pstream = auich_stream_new(card, AUICH_USE_PLAY, current_settings.buffer_frames, current_settings.buffer_count);</a>
<a name="ln1070"> </a>
<a name="ln1071">	card-&gt;buffer_ready_sem = create_sem(0, &quot;pbuffer ready&quot;);</a>
<a name="ln1072"> </a>
<a name="ln1073">	LOG((&quot;stream_setaudio\n&quot;));</a>
<a name="ln1074"> </a>
<a name="ln1075">	auich_stream_set_audioparms(card-&gt;pstream, 2, true, current_settings.sample_rate);</a>
<a name="ln1076">	auich_stream_set_audioparms(card-&gt;rstream, 2, true, current_settings.sample_rate);</a>
<a name="ln1077"> </a>
<a name="ln1078">	card-&gt;pstream-&gt;first_channel = 0;</a>
<a name="ln1079">	card-&gt;rstream-&gt;first_channel = 2;</a>
<a name="ln1080"> </a>
<a name="ln1081">	auich_stream_commit_parms(card-&gt;pstream);</a>
<a name="ln1082">	auich_stream_commit_parms(card-&gt;rstream);</a>
<a name="ln1083"> </a>
<a name="ln1084">	auich_create_channels_list(&amp;card-&gt;multi);</a>
<a name="ln1085"> </a>
<a name="ln1086">	return B_OK;</a>
<a name="ln1087">}</a>
<a name="ln1088"> </a>
<a name="ln1089"> </a>
<a name="ln1090">static status_t</a>
<a name="ln1091">auich_close(void* cookie)</a>
<a name="ln1092">{</a>
<a name="ln1093">	//auich_dev *card = cookie;</a>
<a name="ln1094">	LOG((&quot;close()\n&quot;));</a>
<a name="ln1095"> </a>
<a name="ln1096">	return B_OK;</a>
<a name="ln1097">}</a>
<a name="ln1098"> </a>
<a name="ln1099"> </a>
<a name="ln1100">static status_t</a>
<a name="ln1101">auich_free(void* cookie)</a>
<a name="ln1102">{</a>
<a name="ln1103">	auich_dev *card = cookie;</a>
<a name="ln1104">	auich_stream *stream;</a>
<a name="ln1105">	LOG((&quot;free()\n&quot;));</a>
<a name="ln1106"> </a>
<a name="ln1107">	if (card-&gt;buffer_ready_sem &gt; B_OK)</a>
<a name="ln1108">			delete_sem(card-&gt;buffer_ready_sem);</a>
<a name="ln1109"> </a>
<a name="ln1110">	LIST_FOREACH(stream, &amp;card-&gt;streams, next) {</a>
<a name="ln1111">		auich_stream_halt(stream);</a>
<a name="ln1112">	}</a>
<a name="ln1113"> </a>
<a name="ln1114">	while (!LIST_EMPTY(&amp;card-&gt;streams)) {</a>
<a name="ln1115">		auich_stream_delete(LIST_FIRST(&amp;card-&gt;streams));</a>
<a name="ln1116">	}</a>
<a name="ln1117"> </a>
<a name="ln1118">	card-&gt;pstream = NULL;</a>
<a name="ln1119">	card-&gt;rstream = NULL;</a>
<a name="ln1120"> </a>
<a name="ln1121">	return B_OK;</a>
<a name="ln1122">}</a>
<a name="ln1123"> </a>
<a name="ln1124"> </a>
<a name="ln1125">static status_t</a>
<a name="ln1126">auich_control(void* cookie, uint32 op, void* arg, size_t len)</a>
<a name="ln1127">{</a>
<a name="ln1128">	return auich_multi_control(cookie, op, arg, len);</a>
<a name="ln1129">}</a>
<a name="ln1130"> </a>
<a name="ln1131"> </a>
<a name="ln1132">static status_t</a>
<a name="ln1133">auich_read(void* cookie, off_t position, void *buf, size_t* num_bytes)</a>
<a name="ln1134">{</a>
<a name="ln1135">	*num_bytes = 0;				/* tell caller nothing was read */</a>
<a name="ln1136">	return B_IO_ERROR;</a>
<a name="ln1137">}</a>
<a name="ln1138"> </a>
<a name="ln1139"> </a>
<a name="ln1140">static status_t</a>
<a name="ln1141">auich_write(void* cookie, off_t position, const void* buffer, size_t* num_bytes)</a>
<a name="ln1142">{</a>
<a name="ln1143">	*num_bytes = 0;				/* tell caller nothing was written */</a>
<a name="ln1144">	return B_IO_ERROR;</a>
<a name="ln1145">}</a>

</code></pre>
<div class="balloon" rel="388"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="451"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="441"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="401"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
