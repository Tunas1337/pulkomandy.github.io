
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>echo.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//------------------------------------------------------------------------------</a>
<a name="ln2">//</a>
<a name="ln3">//  EchoGals/Echo24 BeOS Driver for Echo audio cards</a>
<a name="ln4">//</a>
<a name="ln5">//	Copyright (c) 2003, Jérôme Duval</a>
<a name="ln6">//</a>
<a name="ln7">//	Permission is hereby granted, free of charge, to any person obtaining a</a>
<a name="ln8">//	copy of this software and associated documentation files (the &quot;Software&quot;),</a>
<a name="ln9">//	to deal in the Software without restriction, including without limitation</a>
<a name="ln10">//	the rights to use, copy, modify, merge, publish, distribute, sublicense,</a>
<a name="ln11">//	and/or sell copies of the Software, and to permit persons to whom the</a>
<a name="ln12">//	Software is furnished to do so, subject to the following conditions:</a>
<a name="ln13">//</a>
<a name="ln14">//	The above copyright notice and this permission notice shall be included in</a>
<a name="ln15">//	all copies or substantial portions of the Software.</a>
<a name="ln16">//</a>
<a name="ln17">//	THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</a>
<a name="ln18">//	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</a>
<a name="ln19">//	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</a>
<a name="ln20">//	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</a>
<a name="ln21">//	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</a>
<a name="ln22">//	FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</a>
<a name="ln23">//	DEALINGS IN THE SOFTWARE.</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;KernelExport.h&gt;</a>
<a name="ln26">#include &lt;Drivers.h&gt;</a>
<a name="ln27">#include &lt;unistd.h&gt;</a>
<a name="ln28">#include &quot;OsSupportBeOS.h&quot;</a>
<a name="ln29">#include &quot;EchoGalsXface.h&quot;</a>
<a name="ln30">#include &quot;C3g.h&quot;</a>
<a name="ln31">#include &quot;CDarla24.h&quot;</a>
<a name="ln32">#include &quot;CDarla.h&quot;</a>
<a name="ln33">#include &quot;CGina.h&quot;</a>
<a name="ln34">#include &quot;CGina24.h&quot;</a>
<a name="ln35">#include &quot;CIndigo.h&quot;</a>
<a name="ln36">#include &quot;CIndigoDJ.h&quot;</a>
<a name="ln37">#include &quot;CIndigoIO.h&quot;</a>
<a name="ln38">#include &quot;CLayla.h&quot;</a>
<a name="ln39">#include &quot;CLayla24.h&quot;</a>
<a name="ln40">#include &quot;CMia.h&quot;</a>
<a name="ln41">#include &quot;CMona.h&quot;</a>
<a name="ln42">#include &quot;echo.h&quot;</a>
<a name="ln43">#include &quot;debug.h&quot;</a>
<a name="ln44">#include &quot;util.h&quot;</a>
<a name="ln45"> </a>
<a name="ln46">#ifdef CARDBUS</a>
<a name="ln47">static cb_enabler_module_info	*cbemi;</a>
<a name="ln48">struct _echodevs				devices;</a>
<a name="ln49">static char						*names[NUM_CARDS];</a>
<a name="ln50">int32 							num_names = 0;</a>
<a name="ln51">static uint32					device_index = 0;</a>
<a name="ln52">static sem_id					device_lock = 0;</a>
<a name="ln53"> </a>
<a name="ln54">static const cb_device_descriptor	descriptors[] = {</a>
<a name="ln55">	{VENDOR_ID, DEVICE_ID_56301, 0xff, 0xff, 0xff}</a>
<a name="ln56">};</a>
<a name="ln57"> </a>
<a name="ln58">#define COUNT_DESCRIPTOR			1</a>
<a name="ln59"> </a>
<a name="ln60">status_t cardbus_device_added(pci_info *info, void **cookie);</a>
<a name="ln61">void cardbus_device_removed(void *cookie);</a>
<a name="ln62"> </a>
<a name="ln63">static cb_notify_hooks	cardbus_hooks = {</a>
<a name="ln64">	cardbus_device_added, 		// Add entry point</a>
<a name="ln65">	cardbus_device_removed 		// Remove entry point</a>
<a name="ln66">};</a>
<a name="ln67"> </a>
<a name="ln68">#else // CARDBUS</a>
<a name="ln69">static pci_module_info	*pci;</a>
<a name="ln70">int32 num_cards;</a>
<a name="ln71">echo_dev cards[NUM_CARDS];</a>
<a name="ln72">int32 num_names;</a>
<a name="ln73">char * names[NUM_CARDS*20+1];</a>
<a name="ln74">#endif // CARDBUS</a>
<a name="ln75"> </a>
<a name="ln76">extern device_hooks multi_hooks;</a>
<a name="ln77">#ifdef MIDI_SUPPORT</a>
<a name="ln78">extern device_hooks midi_hooks;</a>
<a name="ln79">#endif</a>
<a name="ln80"> </a>
<a name="ln81">int32 echo_int(void *arg);</a>
<a name="ln82">status_t init_hardware(void);</a>
<a name="ln83">status_t init_driver(void);</a>
<a name="ln84">static void make_device_names(echo_dev * card);</a>
<a name="ln85"> </a>
<a name="ln86">static status_t echo_setup(echo_dev * card);</a>
<a name="ln87">static void echo_shutdown(echo_dev *card);</a>
<a name="ln88"> </a>
<a name="ln89">void uninit_driver(void);</a>
<a name="ln90">const char ** publish_devices(void);</a>
<a name="ln91">device_hooks * find_device(const char * name);</a>
<a name="ln92"> </a>
<a name="ln93"> </a>
<a name="ln94">/* Echo Memory management */</a>
<a name="ln95"> </a>
<a name="ln96">echo_mem *</a>
<a name="ln97">echo_mem_new(echo_dev *card, size_t size)</a>
<a name="ln98">{</a>
<a name="ln99">	echo_mem *mem;</a>
<a name="ln100"> </a>
<a name="ln101">	if ((mem = (echo_mem *) malloc(sizeof(*mem))) == NULL)</a>
<a name="ln102">		return (NULL);</a>
<a name="ln103"> </a>
<a name="ln104">	mem-&gt;area = alloc_mem(&amp;mem-&gt;phy_base, &amp;mem-&gt;log_base, size, &quot;echo buffer&quot;);</a>
<a name="ln105">	mem-&gt;size = size;</a>
<a name="ln106">	if (mem-&gt;area &lt; B_OK) {</a>
<a name="ln107">		free(mem);</a>
<a name="ln108">		return NULL;</a>
<a name="ln109">	}</a>
<a name="ln110">	return mem;</a>
<a name="ln111">}</a>
<a name="ln112"> </a>
<a name="ln113"> </a>
<a name="ln114">void</a>
<a name="ln115">echo_mem_delete(echo_mem *mem)</a>
<a name="ln116">{</a>
<a name="ln117">	if (mem-&gt;area &gt; B_OK)</a>
<a name="ln118">		delete_area(mem-&gt;area);</a>
<a name="ln119">	free(mem);</a>
<a name="ln120">}</a>
<a name="ln121"> </a>
<a name="ln122"> </a>
<a name="ln123">echo_mem *</a>
<a name="ln124">echo_mem_alloc(echo_dev *card, size_t size)</a>
<a name="ln125">{</a>
<a name="ln126">	echo_mem *mem;</a>
<a name="ln127"> </a>
<a name="ln128">	mem = echo_mem_new(card, size);</a>
<a name="ln129">	if (mem == NULL)</a>
<a name="ln130">		return (NULL);</a>
<a name="ln131"> </a>
<a name="ln132">	LIST_INSERT_HEAD(&amp;(card-&gt;mems), mem, next);</a>
<a name="ln133"> </a>
<a name="ln134">	return mem;</a>
<a name="ln135">}</a>
<a name="ln136"> </a>
<a name="ln137"> </a>
<a name="ln138">void</a>
<a name="ln139">echo_mem_free(echo_dev *card, void *ptr)</a>
<a name="ln140">{</a>
<a name="ln141">	echo_mem 		*mem;</a>
<a name="ln142"> </a>
<a name="ln143">	LIST_FOREACH(mem, &amp;card-&gt;mems, next) {</a>
<a name="ln144">		if (mem-&gt;log_base != ptr)</a>
<a name="ln145">			continue;</a>
<a name="ln146">		LIST_REMOVE(mem, next);</a>
<a name="ln147"> </a>
<a name="ln148">		echo_mem_delete(mem);</a>
<a name="ln149">		break;</a>
<a name="ln150">	}</a>
<a name="ln151">}</a>
<a name="ln152"> </a>
<a name="ln153">/*	Echo stream functions */</a>
<a name="ln154"> </a>
<a name="ln155">extern char *pStatusStrs[ECHOSTATUS_LAST];</a>
<a name="ln156"> </a>
<a name="ln157">status_t</a>
<a name="ln158">echo_stream_set_audioparms(echo_stream *stream, uint8 channels,</a>
<a name="ln159">	uint8 bitsPerSample, uint32 sample_rate, uint8 index)</a>
<a name="ln160">{</a>
<a name="ln161">	int32 			i;</a>
<a name="ln162">	uint8 			sample_size, frame_size;</a>
<a name="ln163">	ECHOGALS_OPENAUDIOPARAMETERS	open_params;</a>
<a name="ln164">	ECHOGALS_CLOSEAUDIOPARAMETERS  close_params;</a>
<a name="ln165">	ECHOGALS_AUDIOFORMAT			format_params;</a>
<a name="ln166">	ECHOSTATUS status;</a>
<a name="ln167"> </a>
<a name="ln168">	LOG((&quot;echo_stream_set_audioparms\n&quot;));</a>
<a name="ln169"> </a>
<a name="ln170">	if (stream-&gt;pipe &gt;= 0) {</a>
<a name="ln171">		close_params.wPipeIndex = stream-&gt;pipe;</a>
<a name="ln172">		status = stream-&gt;card-&gt;pEG-&gt;CloseAudio(&amp;close_params);</a>
<a name="ln173">		if (status != ECHOSTATUS_OK &amp;&amp; status != ECHOSTATUS_CHANNEL_NOT_OPEN) {</a>
<a name="ln174">			PRINT((&quot;echo_stream_set_audioparms : CloseAudio failed\n&quot;));</a>
<a name="ln175">			PRINT((&quot; status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln176">			return B_ERROR;</a>
<a name="ln177">		}</a>
<a name="ln178">	}</a>
<a name="ln179"> </a>
<a name="ln180">	open_params.bIsCyclic = TRUE;</a>
<a name="ln181">	open_params.Pipe.nPipe = index;</a>
<a name="ln182">	open_params.Pipe.bIsInput = stream-&gt;use == ECHO_USE_RECORD ? TRUE : FALSE;</a>
<a name="ln183">	open_params.Pipe.wInterleave = channels;</a>
<a name="ln184">	open_params.ProcessId = NULL;</a>
<a name="ln185"> </a>
<a name="ln186">	status = stream-&gt;card-&gt;pEG-&gt;OpenAudio(&amp;open_params, &amp;stream-&gt;pipe);</a>
<a name="ln187">	if (status != ECHOSTATUS_OK) {</a>
<a name="ln188">		PRINT((&quot;echo_stream_set_audioparms : OpenAudio failed\n&quot;));</a>
<a name="ln189">		PRINT((&quot; status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln190">		return B_ERROR;</a>
<a name="ln191">	}</a>
<a name="ln192"> </a>
<a name="ln193">	//PRINT((&quot;VerifyAudioOpen\n&quot;));</a>
<a name="ln194">	status = stream-&gt;card-&gt;pEG-&gt;VerifyAudioOpen(stream-&gt;pipe);</a>
<a name="ln195">	if (status != ECHOSTATUS_OK) {</a>
<a name="ln196">		PRINT((&quot;echo_stream_set_audioparms : VerifyAudioOpen failed\n&quot;));</a>
<a name="ln197">		PRINT((&quot;  status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln198">		return B_ERROR;</a>
<a name="ln199">	}</a>
<a name="ln200"> </a>
<a name="ln201">	if (bitsPerSample == 24)</a>
<a name="ln202">		bitsPerSample = 32;</a>
<a name="ln203"> </a>
<a name="ln204">	if ((stream-&gt;channels == channels)</a>
<a name="ln205">		&amp;&amp; (stream-&gt;bitsPerSample == bitsPerSample)</a>
<a name="ln206">		&amp;&amp; (stream-&gt;sample_rate == sample_rate))</a>
<a name="ln207">		return B_OK;</a>
<a name="ln208"> </a>
<a name="ln209">	format_params.wBitsPerSample = bitsPerSample;</a>
<a name="ln210">	format_params.byDataAreBigEndian = 0;</a>
<a name="ln211">	format_params.byMonoToStereo = 0;</a>
<a name="ln212">	format_params.wDataInterleave = channels == 1 ? 1 : 2;</a>
<a name="ln213"> </a>
<a name="ln214">	status = stream-&gt;card-&gt;pEG-&gt;QueryAudioFormat(stream-&gt;pipe, &amp;format_params);</a>
<a name="ln215">	if (status != ECHOSTATUS_OK) {</a>
<a name="ln216">		PRINT((&quot;echo_stream_set_audioparms : bad format when querying\n&quot;));</a>
<a name="ln217">		PRINT((&quot;  status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln218">		return B_ERROR;</a>
<a name="ln219">	}</a>
<a name="ln220"> </a>
<a name="ln221">	status = stream-&gt;card-&gt;pEG-&gt;SetAudioFormat(stream-&gt;pipe, &amp;format_params);</a>
<a name="ln222">	if (status != ECHOSTATUS_OK) {</a>
<a name="ln223">		PRINT((&quot;echo_stream_set_audioparms : bad format when setting\n&quot;));</a>
<a name="ln224">		PRINT((&quot;  status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln225">		return B_ERROR;</a>
<a name="ln226">	}</a>
<a name="ln227"> </a>
<a name="ln228">	/* XXXX : setting sample rate is global in this driver */</a>
<a name="ln229">	status = stream-&gt;card-&gt;pEG-&gt;QueryAudioSampleRate(sample_rate);</a>
<a name="ln230">	if (status != ECHOSTATUS_OK) {</a>
<a name="ln231">		PRINT((&quot;echo_stream_set_audioparms : bad sample rate when querying\n&quot;));</a>
<a name="ln232">		PRINT((&quot;  status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln233">		return B_ERROR;</a>
<a name="ln234">	}</a>
<a name="ln235"> </a>
<a name="ln236">	/* XXXX : setting sample rate is global in this driver */</a>
<a name="ln237">	status = stream-&gt;card-&gt;pEG-&gt;SetAudioSampleRate(sample_rate);</a>
<a name="ln238">	if (status != ECHOSTATUS_OK) {</a>
<a name="ln239">		PRINT((&quot;echo_stream_set_audioparms : bad sample rate when setting\n&quot;));</a>
<a name="ln240">		PRINT((&quot;  status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln241">		return B_ERROR;</a>
<a name="ln242">	}</a>
<a name="ln243"> </a>
<a name="ln244">	if (stream-&gt;buffer)</a>
<a name="ln245">		echo_mem_free(stream-&gt;card, stream-&gt;buffer-&gt;log_base);</a>
<a name="ln246"> </a>
<a name="ln247">	stream-&gt;bitsPerSample = bitsPerSample;</a>
<a name="ln248">	stream-&gt;sample_rate = sample_rate;</a>
<a name="ln249">	stream-&gt;channels = channels;</a>
<a name="ln250"> </a>
<a name="ln251">	sample_size = stream-&gt;bitsPerSample / 8;</a>
<a name="ln252">	frame_size = sample_size * stream-&gt;channels;</a>
<a name="ln253"> </a>
<a name="ln254">	stream-&gt;buffer = echo_mem_alloc(stream-&gt;card,</a>
<a name="ln255">		stream-&gt;bufframes * frame_size * stream-&gt;bufcount);</a>
<a name="ln256"> </a>
<a name="ln257">	stream-&gt;trigblk = 1;</a>
<a name="ln258">	stream-&gt;blkmod = stream-&gt;bufcount;</a>
<a name="ln259">	stream-&gt;blksize = stream-&gt;bufframes * frame_size;</a>
<a name="ln260"> </a>
<a name="ln261">	CDaffyDuck *duck = stream-&gt;card-&gt;pEG-&gt;GetDaffyDuck(stream-&gt;pipe);</a>
<a name="ln262">	if (duck == NULL) {</a>
<a name="ln263">		PRINT((&quot;echo_stream_set_audioparms : Could not get daffy duck pointer\n&quot;));</a>
<a name="ln264">		return B_ERROR;</a>
<a name="ln265">	}</a>
<a name="ln266"> </a>
<a name="ln267">	uint32 dwNumFreeEntries = 0;</a>
<a name="ln268"> </a>
<a name="ln269">	for (i = 0; i &lt; stream-&gt;bufcount; i++) {</a>
<a name="ln270">		duck-&gt;AddMapping(((uint32)stream-&gt;buffer-&gt;phy_base) +</a>
<a name="ln271">			i * stream-&gt;blksize, stream-&gt;blksize, 0, TRUE, dwNumFreeEntries);</a>
<a name="ln272">	}</a>
<a name="ln273"> </a>
<a name="ln274">	duck-&gt;Wrap();</a>
<a name="ln275"> </a>
<a name="ln276">	if (stream-&gt;card-&gt;pEG-&gt;GetAudioPositionPtr(stream-&gt;pipe, stream-&gt;position)!=ECHOSTATUS_OK) {</a>
<a name="ln277">		PRINT((&quot;echo_stream_set_audioparms : Could not get audio position ptr\n&quot;));</a>
<a name="ln278">		return B_ERROR;</a>
<a name="ln279">	}</a>
<a name="ln280"> </a>
<a name="ln281">	return B_OK;</a>
<a name="ln282">}</a>
<a name="ln283"> </a>
<a name="ln284"> </a>
<a name="ln285">status_t</a>
<a name="ln286">echo_stream_get_nth_buffer(echo_stream *stream, uint8 chan, uint8 buf,</a>
<a name="ln287">	char** buffer, size_t *stride)</a>
<a name="ln288">{</a>
<a name="ln289">	uint8 			sample_size, frame_size;</a>
<a name="ln290">	LOG((&quot;echo_stream_get_nth_buffer\n&quot;));</a>
<a name="ln291"> </a>
<a name="ln292">	sample_size = stream-&gt;bitsPerSample / 8;</a>
<a name="ln293">	frame_size = sample_size * stream-&gt;channels;</a>
<a name="ln294"> </a>
<a name="ln295">	*buffer = (char*)stream-&gt;buffer-&gt;log_base + (buf * stream-&gt;bufframes * frame_size)</a>
<a name="ln296">		+ chan * sample_size;</a>
<a name="ln297">	*stride = frame_size;</a>
<a name="ln298"> </a>
<a name="ln299">	return B_OK;</a>
<a name="ln300">}</a>
<a name="ln301"> </a>
<a name="ln302"> </a>
<a name="ln303">static uint32</a>
<a name="ln304">echo_stream_curaddr(echo_stream *stream)</a>
<a name="ln305">{</a>
<a name="ln306">	uint32 addr = B_LENDIAN_TO_HOST_INT32(*stream-&gt;position);</a>
<a name="ln307">//	TRACE((&quot;stream_curaddr %p, phy_base %p\n&quot;, addr));</a>
<a name="ln308">	return (addr / stream-&gt;blksize) % stream-&gt;blkmod;</a>
<a name="ln309">}</a>
<a name="ln310"> </a>
<a name="ln311"> </a>
<a name="ln312">void</a>
<a name="ln313">echo_stream_start(echo_stream *stream, void (*inth) (void *), void *inthparam)</a>
<a name="ln314">{</a>
<a name="ln315">	LOG((&quot;echo_stream_start\n&quot;));</a>
<a name="ln316">	ECHOSTATUS status;</a>
<a name="ln317"> </a>
<a name="ln318">	stream-&gt;inth = inth;</a>
<a name="ln319">	stream-&gt;inthparam = inthparam;</a>
<a name="ln320"> </a>
<a name="ln321">	stream-&gt;state |= ECHO_STATE_STARTED;</a>
<a name="ln322"> </a>
<a name="ln323">	status = stream-&gt;card-&gt;pEG-&gt;Start(stream-&gt;pipe);</a>
<a name="ln324">	if (status!=ECHOSTATUS_OK) {</a>
<a name="ln325">		PRINT((&quot;echo_stream_start : Could not start the pipe %s\n&quot;, pStatusStrs[status]));</a>
<a name="ln326">	}</a>
<a name="ln327">}</a>
<a name="ln328"> </a>
<a name="ln329"> </a>
<a name="ln330">void</a>
<a name="ln331">echo_stream_halt(echo_stream *stream)</a>
<a name="ln332">{</a>
<a name="ln333">	LOG((&quot;echo_stream_halt\n&quot;));</a>
<a name="ln334">	ECHOSTATUS status;</a>
<a name="ln335"> </a>
<a name="ln336">	stream-&gt;state &amp;= ~ECHO_STATE_STARTED;</a>
<a name="ln337"> </a>
<a name="ln338">	status = stream-&gt;card-&gt;pEG-&gt;Stop(stream-&gt;pipe);</a>
<a name="ln339">	if (status!=ECHOSTATUS_OK) {</a>
<a name="ln340">		PRINT((&quot;echo_stream_halt : Could not stop the pipe %s\n&quot;, pStatusStrs[status]));</a>
<a name="ln341">	}</a>
<a name="ln342">}</a>
<a name="ln343"> </a>
<a name="ln344"> </a>
<a name="ln345">echo_stream *</a>
<a name="ln346">echo_stream_new(echo_dev *card, uint8 use, uint32 bufframes, uint8 bufcount)</a>
<a name="ln347">{</a>
<a name="ln348">	echo_stream *stream;</a>
<a name="ln349">	cpu_status status;</a>
<a name="ln350">	LOG((&quot;echo_stream_new\n&quot;));</a>
<a name="ln351"> </a>
<a name="ln352">	stream = (echo_stream *) malloc(sizeof(echo_stream));</a>
<a name="ln353">	if (stream == NULL)</a>
<a name="ln354">		return (NULL);</a>
<a name="ln355">	stream-&gt;card = card;</a>
<a name="ln356">	stream-&gt;use = use;</a>
<a name="ln357">	stream-&gt;state = !ECHO_STATE_STARTED;</a>
<a name="ln358">	stream-&gt;bitsPerSample = 0;</a>
<a name="ln359">	stream-&gt;sample_rate = 0;</a>
<a name="ln360">	stream-&gt;channels = 0;</a>
<a name="ln361">	stream-&gt;bufframes = bufframes;</a>
<a name="ln362">	stream-&gt;bufcount = bufcount;</a>
<a name="ln363">	stream-&gt;inth = NULL;</a>
<a name="ln364">	stream-&gt;inthparam = NULL;</a>
<a name="ln365">	stream-&gt;buffer = NULL;</a>
<a name="ln366">	stream-&gt;blksize = 0;</a>
<a name="ln367">	stream-&gt;trigblk = 0;</a>
<a name="ln368">	stream-&gt;blkmod = 0;</a>
<a name="ln369"> </a>
<a name="ln370">	stream-&gt;pipe = -1;</a>
<a name="ln371"> </a>
<a name="ln372">	stream-&gt;frames_count = 0;</a>
<a name="ln373">	stream-&gt;real_time = 0;</a>
<a name="ln374">	stream-&gt;buffer_cycle = 0;</a>
<a name="ln375">	stream-&gt;update_needed = false;</a>
<a name="ln376"> </a>
<a name="ln377">	status = lock();</a>
<a name="ln378">	LIST_INSERT_HEAD((&amp;card-&gt;streams), stream, next);</a>
<a name="ln379">	unlock(status);</a>
<a name="ln380"> </a>
<a name="ln381">	return stream;</a>
<a name="ln382">}</a>
<a name="ln383"> </a>
<a name="ln384"> </a>
<a name="ln385">void</a>
<a name="ln386">echo_stream_delete(echo_stream *stream)</a>
<a name="ln387">{</a>
<a name="ln388">	cpu_status status;</a>
<a name="ln389">	ECHOGALS_CLOSEAUDIOPARAMETERS close_params;</a>
<a name="ln390">	LOG((&quot;echo_stream_delete\n&quot;));</a>
<a name="ln391"> </a>
<a name="ln392">	echo_stream_halt(stream);</a>
<a name="ln393"> </a>
<a name="ln394">	if (stream-&gt;pipe &gt;= 0) {</a>
<a name="ln395">		close_params.wPipeIndex = stream-&gt;pipe;</a>
<a name="ln396">		status = stream-&gt;card-&gt;pEG-&gt;CloseAudio(&amp;close_params);</a>
<a name="ln397">		if (status != ECHOSTATUS_OK &amp;&amp; status != ECHOSTATUS_CHANNEL_NOT_OPEN) {</a>
<a name="ln398">			PRINT((&quot;echo_stream_set_audioparms : CloseAudio failed\n&quot;));</a>
<a name="ln399">			PRINT((&quot; status: %s \n&quot;, pStatusStrs[status]));</a>
<a name="ln400">		}</a>
<a name="ln401">	}</a>
<a name="ln402"> </a>
<a name="ln403">	if (stream-&gt;buffer)</a>
<a name="ln404">		echo_mem_free(stream-&gt;card, stream-&gt;buffer-&gt;log_base);</a>
<a name="ln405"> </a>
<a name="ln406">	status = lock();</a>
<a name="ln407">	LIST_REMOVE(stream, next);</a>
<a name="ln408">	unlock(status);</a>
<a name="ln409"> </a>
<a name="ln410">	free(stream);</a>
<a name="ln411">}</a>
<a name="ln412"> </a>
<a name="ln413"> </a>
<a name="ln414">/* Echo interrupt */</a>
<a name="ln415"> </a>
<a name="ln416">int32 echo_int(void *arg)</a>
<a name="ln417">{</a>
<a name="ln418">	echo_dev* card = (echo_dev*)arg;</a>
<a name="ln419">	BOOL midiReceived;</a>
<a name="ln420">	ECHOSTATUS err;</a>
<a name="ln421">	echo_stream* stream;</a>
<a name="ln422">	uint32 curblk;</a>
<a name="ln423"> </a>
<a name="ln424">	err = card-&gt;pEG-&gt;ServiceIrq(midiReceived);</a>
<a name="ln425"> </a>
<a name="ln426">	if (err != ECHOSTATUS_OK) {</a>
<a name="ln427">		return B_UNHANDLED_INTERRUPT;</a>
<a name="ln428">	}</a>
<a name="ln429"> </a>
<a name="ln430">#ifdef MIDI_SUPPORT</a>
<a name="ln431">	if (midiReceived)</a>
<a name="ln432">		release_sem_etc(card-&gt;midi.midi_ready_sem, 1, B_DO_NOT_RESCHEDULE);</a>
<a name="ln433">#endif</a>
<a name="ln434"> </a>
<a name="ln435">	LIST_FOREACH(stream, &amp;card-&gt;streams, next) {</a>
<a name="ln436">		if ((stream-&gt;state &amp; ECHO_STATE_STARTED) == 0 ||</a>
<a name="ln437">			(stream-&gt;inth == NULL))</a>
<a name="ln438">				continue;</a>
<a name="ln439"> </a>
<a name="ln440">		curblk = echo_stream_curaddr(stream);</a>
<a name="ln441">		//TRACE((&quot;echo_int stream %p at trigblk %lu at stream-&gt;trigblk %lu\n&quot;,</a>
<a name="ln442">		//	   stream, curblk, stream-&gt;trigblk));</a>
<a name="ln443">		if (curblk == stream-&gt;trigblk) {</a>
<a name="ln444">			if (stream-&gt;inth)</a>
<a name="ln445">				stream-&gt;inth(stream-&gt;inthparam);</a>
<a name="ln446"> </a>
<a name="ln447">			stream-&gt;trigblk++;</a>
<a name="ln448">			stream-&gt;trigblk %= stream-&gt;blkmod;</a>
<a name="ln449">		}</a>
<a name="ln450">	}</a>
<a name="ln451"> </a>
<a name="ln452">	return B_INVOKE_SCHEDULER;</a>
<a name="ln453">}</a>
<a name="ln454"> </a>
<a name="ln455">/* dumps card capabilities */</a>
<a name="ln456">void</a>
<a name="ln457">echo_dump_caps(echo_dev *card)</a>
<a name="ln458">{</a>
<a name="ln459">	PECHOGALS_CAPS caps = &amp;card-&gt;caps;</a>
<a name="ln460">	PRINT((&quot;name: %s\n&quot;, caps-&gt;szName));</a>
<a name="ln461">	PRINT((&quot;out pipes: %d, in pipes: %d, out busses: %d, in busses: %d, out midi: %d, in midi: %d\n&quot;,</a>
<a name="ln462">		caps-&gt;wNumPipesOut, caps-&gt;wNumPipesIn, caps-&gt;wNumBussesOut, caps-&gt;wNumBussesIn, caps-&gt;wNumMidiOut, caps-&gt;wNumMidiIn));</a>
<a name="ln463"> </a>
<a name="ln464">}</a>
<a name="ln465"> </a>
<a name="ln466"> </a>
<a name="ln467">/* detect presence of our hardware */</a>
<a name="ln468">status_t</a>
<a name="ln469">init_hardware(void)</a>
<a name="ln470">{</a>
<a name="ln471">#ifdef CARDBUS</a>
<a name="ln472">	return B_OK;</a>
<a name="ln473">#else</a>
<a name="ln474">	int ix = 0;</a>
<a name="ln475">	pci_info info;</a>
<a name="ln476">	status_t err = ENODEV;</a>
<a name="ln477"> </a>
<a name="ln478">	LOG_CREATE();</a>
<a name="ln479"> </a>
<a name="ln480">	PRINT((&quot;init_hardware()\n&quot;));</a>
<a name="ln481"> </a>
<a name="ln482">	if (get_module(B_PCI_MODULE_NAME, (module_info **)&amp;pci))</a>
<a name="ln483">		return ENOSYS;</a>
<a name="ln484"> </a>
<a name="ln485">	while ((*pci-&gt;get_nth_pci_info)(ix, &amp;info) == B_OK) {</a>
<a name="ln486"> </a>
<a name="ln487">		ushort card_type = info.u.h0.subsystem_id &amp; 0xfff0;</a>
<a name="ln488"> </a>
<a name="ln489">		if (info.vendor_id == VENDOR_ID</a>
<a name="ln490">			&amp;&amp; ((info.device_id == DEVICE_ID_56301)</a>
<a name="ln491">			|| (info.device_id == DEVICE_ID_56361))</a>
<a name="ln492">			&amp;&amp; (info.u.h0.subsystem_vendor_id == SUBVENDOR_ID)</a>
<a name="ln493">			&amp;&amp; (</a>
<a name="ln494">#ifdef ECHOGALS_FAMILY</a>
<a name="ln495">			(card_type == DARLA)</a>
<a name="ln496">			|| (card_type == GINA)</a>
<a name="ln497">			|| (card_type == LAYLA)</a>
<a name="ln498">			|| (card_type == DARLA24)</a>
<a name="ln499">#endif</a>
<a name="ln500">#ifdef ECHO24_FAMILY</a>
<a name="ln501">			(card_type == GINA24)</a>
<a name="ln502">			|| (card_type == LAYLA24)</a>
<a name="ln503">			|| (card_type == MONA)</a>
<a name="ln504">			|| (card_type == MIA)</a>
<a name="ln505">#endif</a>
<a name="ln506">#ifdef INDIGO_FAMILY</a>
<a name="ln507">			(card_type == INDIGO)</a>
<a name="ln508">			|| (card_type == INDIGO_IO)</a>
<a name="ln509">			|| (card_type == INDIGO_DJ)</a>
<a name="ln510">#endif</a>
<a name="ln511">#ifdef ECHO3G_FAMILY</a>
<a name="ln512">			(card_type == ECHO3G)</a>
<a name="ln513">#endif</a>
<a name="ln514">			 )) {</a>
<a name="ln515">			err = B_OK;</a>
<a name="ln516">		}</a>
<a name="ln517">		ix++;</a>
<a name="ln518">	}</a>
<a name="ln519"> </a>
<a name="ln520">	put_module(B_PCI_MODULE_NAME);</a>
<a name="ln521"> </a>
<a name="ln522">	if (err != B_OK) {</a>
<a name="ln523">		PRINT((&quot;no card found\n&quot;));</a>
<a name="ln524">	}</a>
<a name="ln525"> </a>
<a name="ln526">	return err;</a>
<a name="ln527">#endif</a>
<a name="ln528">}</a>
<a name="ln529"> </a>
<a name="ln530"> </a>
<a name="ln531">status_t</a>
<a name="ln532">init_driver(void)</a>
<a name="ln533">{</a>
<a name="ln534">	PRINT((&quot;init_driver()\n&quot;));</a>
<a name="ln535"> </a>
<a name="ln536">#ifdef CARDBUS</a>
<a name="ln537">	// Get card services client module</a>
<a name="ln538">	if (get_module(CB_ENABLER_MODULE_NAME, (module_info **)&amp;cbemi) != B_OK) {</a>
<a name="ln539">		dprintf(DRIVER_NAME &quot;: cardbus enabler module error\n&quot;);</a>
<a name="ln540">		return B_ERROR;</a>
<a name="ln541">	}</a>
<a name="ln542">	// Create the devices lock</a>
<a name="ln543">	device_lock = create_sem(1, DRIVER_NAME &quot; device&quot;);</a>
<a name="ln544">	if (device_lock &lt; B_OK) {</a>
<a name="ln545">		dprintf(DRIVER_NAME &quot;: create device semaphore error 0x%.8x\n&quot;, device_lock);</a>
<a name="ln546">		put_module(CB_ENABLER_MODULE_NAME);</a>
<a name="ln547">		return B_ERROR;</a>
<a name="ln548">	}</a>
<a name="ln549">	// Register driver</a>
<a name="ln550">	cbemi-&gt;register_driver(DRIVER_NAME, descriptors, COUNT_DESCRIPTOR);</a>
<a name="ln551">	cbemi-&gt;install_notify(DRIVER_NAME, &amp;cardbus_hooks);</a>
<a name="ln552">	LIST_INIT(&amp;(devices));</a>
<a name="ln553">	return B_OK;</a>
<a name="ln554">#else</a>
<a name="ln555">	int ix = 0;</a>
<a name="ln556"> </a>
<a name="ln557">	pci_info info;</a>
<a name="ln558">	status_t err;</a>
<a name="ln559">	num_cards = 0;</a>
<a name="ln560"> </a>
<a name="ln561">	if (get_module(B_PCI_MODULE_NAME, (module_info **) &amp;pci))</a>
<a name="ln562">		return ENOSYS;</a>
<a name="ln563"> </a>
<a name="ln564">	while ((*pci-&gt;get_nth_pci_info)(ix++, &amp;info) == B_OK) {</a>
<a name="ln565">		ushort card_type = info.u.h0.subsystem_id &amp; 0xfff0;</a>
<a name="ln566"> </a>
<a name="ln567">		if (info.vendor_id == VENDOR_ID</a>
<a name="ln568">			&amp;&amp; ((info.device_id == DEVICE_ID_56301)</a>
<a name="ln569">			|| (info.device_id == DEVICE_ID_56361))</a>
<a name="ln570">			&amp;&amp; (info.u.h0.subsystem_vendor_id == SUBVENDOR_ID)</a>
<a name="ln571">			&amp;&amp; (</a>
<a name="ln572">#ifdef ECHOGALS_FAMILY</a>
<a name="ln573">			(card_type == DARLA)</a>
<a name="ln574">			|| (card_type == GINA)</a>
<a name="ln575">			|| (card_type == LAYLA)</a>
<a name="ln576">			|| (card_type == DARLA24)</a>
<a name="ln577">#endif</a>
<a name="ln578">#ifdef ECHO24_FAMILY</a>
<a name="ln579">			(card_type == GINA24)</a>
<a name="ln580">			|| (card_type == LAYLA24)</a>
<a name="ln581">			|| (card_type == MONA)</a>
<a name="ln582">			|| (card_type == MIA)</a>
<a name="ln583">#endif</a>
<a name="ln584">#ifdef INDIGO_FAMILY</a>
<a name="ln585">			(card_type == INDIGO)</a>
<a name="ln586">			|| (card_type == INDIGO_IO)</a>
<a name="ln587">			|| (card_type == INDIGO_DJ)</a>
<a name="ln588">#endif</a>
<a name="ln589">#ifdef ECHO3G_FAMILY</a>
<a name="ln590">			(card_type == ECHO3G)</a>
<a name="ln591">#endif</a>
<a name="ln592">			)) {</a>
<a name="ln593"> </a>
<a name="ln594">			if (num_cards == NUM_CARDS) {</a>
<a name="ln595">				PRINT((&quot;Too many &quot; DRIVER_NAME &quot; cards installed!\n&quot;));</a>
<a name="ln596">				break;</a>
<a name="ln597">			}</a>
<a name="ln598">			memset(&amp;cards[num_cards], 0, sizeof(echo_dev));</a>
<a name="ln599">			cards[num_cards].info = info;</a>
<a name="ln600">			cards[num_cards].type = card_type;</a>
<a name="ln601">#ifdef __HAIKU__</a>
<a name="ln602">			if ((err = (*pci-&gt;reserve_device)(info.bus, info.device, info.function,</a>
<a name="ln603">				DRIVER_NAME, &amp;cards[num_cards])) &lt; B_OK) {</a>
<a name="ln604">				dprintf(&quot;%s: failed to reserve_device(%d, %d, %d,): %s\n&quot;,</a>
<a name="ln605">					DRIVER_NAME, info.bus, info.device, info.function,</a>
<a name="ln606">					strerror(err));</a>
<a name="ln607">				continue;</a>
<a name="ln608">			}</a>
<a name="ln609">#endif</a>
<a name="ln610">			if (echo_setup(&amp;cards[num_cards])) {</a>
<a name="ln611">				PRINT((&quot;Setup of &quot; DRIVER_NAME &quot; %ld failed\n&quot;, num_cards + 1));</a>
<a name="ln612">#ifdef __HAIKU__</a>
<a name="ln613">				(*pci-&gt;unreserve_device)(info.bus, info.device, info.function,</a>
<a name="ln614">					DRIVER_NAME, &amp;cards[num_cards]);</a>
<a name="ln615">#endif</a>
<a name="ln616">			}</a>
<a name="ln617">			else {</a>
<a name="ln618">				num_cards++;</a>
<a name="ln619">			}</a>
<a name="ln620">		}</a>
<a name="ln621">	}</a>
<a name="ln622">	if (!num_cards) {</a>
<a name="ln623">		PRINT((&quot;no cards\n&quot;));</a>
<a name="ln624">		put_module(B_PCI_MODULE_NAME);</a>
<a name="ln625">		PRINT((&quot;no suitable cards found\n&quot;));</a>
<a name="ln626">		return ENODEV;</a>
<a name="ln627">	}</a>
<a name="ln628"> </a>
<a name="ln629">	return B_OK;</a>
<a name="ln630">#endif</a>
<a name="ln631">}</a>
<a name="ln632"> </a>
<a name="ln633"> </a>
<a name="ln634">#ifndef CARDBUS</a>
<a name="ln635">static void</a>
<a name="ln636">make_device_names(echo_dev * card)</a>
<a name="ln637">{</a>
<a name="ln638">#ifdef MIDI_SUPPORT</a>
<a name="ln639">	sprintf(card-&gt;midi.name, &quot;midi/&quot; DRIVER_NAME &quot;/%ld&quot;, card-cards + 1);</a>
<a name="ln640">	names[num_names++] = card-&gt;midi.name;</a>
<a name="ln641">#endif</a>
<a name="ln642">	sprintf(card-&gt;name, &quot;audio/hmulti/&quot; DRIVER_NAME &quot;/%ld&quot;, card-cards + 1);</a>
<a name="ln643">	names[num_names++] = card-&gt;name;</a>
<a name="ln644"> </a>
<a name="ln645">	names[num_names] = NULL;</a>
<a name="ln646">}</a>
<a name="ln647">#else</a>
<a name="ln648"> </a>
<a name="ln649">status_t</a>
<a name="ln650">cardbus_device_added(pci_info *info, void **cookie) {</a>
<a name="ln651">	echo_dev 			* card, *dev;</a>
<a name="ln652">	uint32				index;</a>
<a name="ln653">	char				buffer[32];</a>
<a name="ln654"> </a>
<a name="ln655">	LOG((&quot;cardbus_device_added at %.2d:%.2d:%.2d\n&quot;, info-&gt;bus, info-&gt;device, info-&gt;function));</a>
<a name="ln656">	// Allocate cookie</a>
<a name="ln657">	if (!(*cookie = card = (echo_dev *)malloc(sizeof(echo_dev)))) {</a>
<a name="ln658">		return B_NO_MEMORY;</a>
<a name="ln659">	}</a>
<a name="ln660">	// Clear cookie</a>
<a name="ln661">	memset(card, 0, sizeof(echo_dev));</a>
<a name="ln662">	// Initialize cookie</a>
<a name="ln663">	card-&gt;info = *info;</a>
<a name="ln664">	card-&gt;plugged = true;</a>
<a name="ln665">	card-&gt;index = 0;</a>
<a name="ln666"> </a>
<a name="ln667">	LIST_FOREACH(dev, &amp;devices, next) {</a>
<a name="ln668">		if (dev-&gt;index == card-&gt;index) {</a>
<a name="ln669">			card-&gt;index++;</a>
<a name="ln670">			dev = LIST_FIRST(&amp;devices);</a>
<a name="ln671">		}</a>
<a name="ln672">	}</a>
<a name="ln673"> </a>
<a name="ln674">	// Format device name</a>
<a name="ln675">	sprintf(card-&gt;name, &quot;audio/hmulti/&quot; DRIVER_NAME &quot;/%ld&quot;, card-&gt;index);</a>
<a name="ln676">	// Lock the devices</a>
<a name="ln677">	acquire_sem(device_lock);</a>
<a name="ln678">	LIST_INSERT_HEAD((&amp;devices), card, next);</a>
<a name="ln679">	// Unlock the devices</a>
<a name="ln680">	release_sem(device_lock);</a>
<a name="ln681"> </a>
<a name="ln682">	echo_setup(card);</a>
<a name="ln683">	return B_OK;</a>
<a name="ln684">}</a>
<a name="ln685"> </a>
<a name="ln686"> </a>
<a name="ln687">// cardbus_device_removed - handle cardbus device removal.</a>
<a name="ln688">// status : OK</a>
<a name="ln689">void</a>
<a name="ln690">cardbus_device_removed(void *cookie)</a>
<a name="ln691">{</a>
<a name="ln692">	echo_dev		*card = (echo_dev *) cookie;</a>
<a name="ln693"> </a>
<a name="ln694">	LOG((&quot;: cardbus_device_removed\n&quot;));</a>
<a name="ln695">	// Check</a>
<a name="ln696">	if (card == NULL) {</a>
<a name="ln697">		LOG((&quot;: null device 0x%.8x\n&quot;, card));</a>
<a name="ln698">		return;</a>
<a name="ln699">	}</a>
<a name="ln700"> </a>
<a name="ln701">	echo_shutdown(card);</a>
<a name="ln702"> </a>
<a name="ln703">	// Lock the devices</a>
<a name="ln704">	acquire_sem(device_lock);</a>
<a name="ln705">	// Finalize</a>
<a name="ln706">	card-&gt;plugged = false;</a>
<a name="ln707">	// Check if the device is opened</a>
<a name="ln708">	if (card-&gt;opened) {</a>
<a name="ln709">		LOG((&quot;device 0x%.8x %s still in use\n&quot;, card, card-&gt;name));</a>
<a name="ln710">	} else {</a>
<a name="ln711">		LOG((&quot;free device 0x%.8x %s\n&quot;, card, card-&gt;name));</a>
<a name="ln712">		LIST_REMOVE(card, next);</a>
<a name="ln713">		free(card);</a>
<a name="ln714">	}</a>
<a name="ln715">	// Unlock the devices</a>
<a name="ln716">	release_sem(device_lock);</a>
<a name="ln717">}</a>
<a name="ln718"> </a>
<a name="ln719">#endif</a>
<a name="ln720"> </a>
<a name="ln721"> </a>
<a name="ln722">static status_t</a>
<a name="ln723">echo_setup(echo_dev * card)</a>
<a name="ln724">{</a>
<a name="ln725">	unsigned char cmd;</a>
<a name="ln726">	char *name;</a>
<a name="ln727"> </a>
<a name="ln728">	PRINT((&quot;echo_setup(%p)\n&quot;, card));</a>
<a name="ln729"> </a>
<a name="ln730">#ifndef CARDBUS</a>
<a name="ln731">	(*pci-&gt;write_pci_config)(card-&gt;info.bus, card-&gt;info.device,</a>
<a name="ln732">		card-&gt;info.function, PCI_latency, 1, 0xc0 );</a>
<a name="ln733"> </a>
<a name="ln734">	make_device_names(card);</a>
<a name="ln735">#endif</a>
<a name="ln736">	card-&gt;bmbar = card-&gt;info.u.h0.base_registers[0];</a>
<a name="ln737">	card-&gt;irq = card-&gt;info.u.h0.interrupt_line;</a>
<a name="ln738"> </a>
<a name="ln739">	card-&gt;area_bmbar = map_mem(&amp;card-&gt;log_bmbar, card-&gt;bmbar,</a>
<a name="ln740">		card-&gt;info.u.h0.base_register_sizes[0], DRIVER_NAME&quot; bmbar io&quot;);</a>
<a name="ln741">	if (card-&gt;area_bmbar &lt;= B_OK) {</a>
<a name="ln742">		LOG((&quot;mapping of bmbar io failed, error = %#x\n&quot;,card-&gt;area_bmbar));</a>
<a name="ln743">		goto err5;</a>
<a name="ln744">	}</a>
<a name="ln745">	LOG((&quot;mapping of bmbar: area %#x, phys %#x, log %#x\n&quot;, card-&gt;area_bmbar,</a>
<a name="ln746">		card-&gt;bmbar, card-&gt;log_bmbar));</a>
<a name="ln747"> </a>
<a name="ln748">	card-&gt;pOSS = new COsSupport(card-&gt;info.device_id, card-&gt;info.revision);</a>
<a name="ln749">	if (card-&gt;pOSS == NULL)</a>
<a name="ln750">		goto err4;</a>
<a name="ln751"> </a>
<a name="ln752">	switch (card-&gt;type) {</a>
<a name="ln753">#ifdef ECHOGALS_FAMILY</a>
<a name="ln754">		case DARLA:</a>
<a name="ln755">			card-&gt;pEG = new CDarla(card-&gt;pOSS);</a>
<a name="ln756">			name = &quot;Echo Darla&quot;;</a>
<a name="ln757">			break;</a>
<a name="ln758">		case GINA:</a>
<a name="ln759">			card-&gt;pEG = new CGina(card-&gt;pOSS);</a>
<a name="ln760">			name = &quot;Echo Gina&quot;;</a>
<a name="ln761">			break;</a>
<a name="ln762">		case LAYLA:</a>
<a name="ln763">			card-&gt;pEG = new CLayla(card-&gt;pOSS);</a>
<a name="ln764">			name = &quot;Echo Layla&quot;;</a>
<a name="ln765">			break;</a>
<a name="ln766">		case DARLA24:</a>
<a name="ln767">			card-&gt;pEG = new CDarla24(card-&gt;pOSS);</a>
<a name="ln768">			name = &quot;Echo Darla24&quot;;</a>
<a name="ln769">			break;</a>
<a name="ln770">#endif</a>
<a name="ln771">#ifdef ECHO24_FAMILY</a>
<a name="ln772">		case GINA24:</a>
<a name="ln773">			card-&gt;pEG = new CGina24(card-&gt;pOSS);</a>
<a name="ln774">			name = &quot;Echo Gina24&quot;;</a>
<a name="ln775">			break;</a>
<a name="ln776">		case LAYLA24:</a>
<a name="ln777">			card-&gt;pEG = new CLayla24(card-&gt;pOSS);</a>
<a name="ln778">			name = &quot;Echo Layla24&quot;;</a>
<a name="ln779">			break;</a>
<a name="ln780">		case MONA:</a>
<a name="ln781">			card-&gt;pEG = new CMona(card-&gt;pOSS);</a>
<a name="ln782">			name = &quot;Echo Mona&quot;;</a>
<a name="ln783">			break;</a>
<a name="ln784">		case MIA:</a>
<a name="ln785">			card-&gt;pEG = new CMia(card-&gt;pOSS);</a>
<a name="ln786">			name = &quot;Echo Mia&quot;;</a>
<a name="ln787">			break;</a>
<a name="ln788">#endif</a>
<a name="ln789">#ifdef INDIGO_FAMILY</a>
<a name="ln790">		case INDIGO:</a>
<a name="ln791">			card-&gt;pEG = new CIndigo(card-&gt;pOSS);</a>
<a name="ln792">			name = &quot;Echo Indigo&quot;;</a>
<a name="ln793">			break;</a>
<a name="ln794">		case INDIGO_IO:</a>
<a name="ln795">			card-&gt;pEG = new CIndigoIO(card-&gt;pOSS);</a>
<a name="ln796">			name = &quot;Echo IndigoIO&quot;;</a>
<a name="ln797">			break;</a>
<a name="ln798">		case INDIGO_DJ:</a>
<a name="ln799">			card-&gt;pEG = new CIndigoDJ(card-&gt;pOSS);</a>
<a name="ln800">			name = &quot;Echo IndigoDJ&quot;;</a>
<a name="ln801">			break;</a>
<a name="ln802">#endif</a>
<a name="ln803">#ifdef ECHO3G_FAMILY</a>
<a name="ln804">		case ECHO3G:</a>
<a name="ln805">			card-&gt;pEG = new C3g(card-&gt;pOSS);</a>
<a name="ln806">			name = &quot;Echo 3g&quot;;</a>
<a name="ln807">			break;</a>
<a name="ln808">#endif</a>
<a name="ln809">		default:</a>
<a name="ln810">			PRINT((&quot;card type 0x%x not supported by &quot; DRIVER_NAME &quot;\n&quot;,</a>
<a name="ln811">				card-&gt;type));</a>
<a name="ln812">	}</a>
<a name="ln813"> </a>
<a name="ln814">	if (card-&gt;pEG == NULL)</a>
<a name="ln815">		goto err2;</a>
<a name="ln816"> </a>
<a name="ln817">#ifndef CARDBUS</a>
<a name="ln818">	cmd = (*pci-&gt;read_pci_config)(card-&gt;info.bus, card-&gt;info.device,</a>
<a name="ln819">		card-&gt;info.function, PCI_command, 2);</a>
<a name="ln820">	PRINT((&quot;PCI command before: %x\n&quot;, cmd));</a>
<a name="ln821">	(*pci-&gt;write_pci_config)(card-&gt;info.bus, card-&gt;info.device,</a>
<a name="ln822">		card-&gt;info.function, PCI_command, 2, cmd | PCI_command_io);</a>
<a name="ln823">	cmd = (*pci-&gt;read_pci_config)(card-&gt;info.bus, card-&gt;info.device,</a>
<a name="ln824">		card-&gt;info.function, PCI_command, 2);</a>
<a name="ln825">	PRINT((&quot;PCI command after: %x\n&quot;, cmd));</a>
<a name="ln826">#endif</a>
<a name="ln827"> </a>
<a name="ln828">	card-&gt;pEG-&gt;AssignResources(card-&gt;log_bmbar, name);</a>
<a name="ln829"> </a>
<a name="ln830">	ECHOSTATUS status;</a>
<a name="ln831">	status = card-&gt;pEG-&gt;InitHw();</a>
<a name="ln832">	if (status != ECHOSTATUS_OK)</a>
<a name="ln833">		goto err3;</a>
<a name="ln834"> </a>
<a name="ln835">	card-&gt;pEG-&gt;GetCapabilities(&amp;card-&gt;caps);</a>
<a name="ln836"> </a>
<a name="ln837">	/* Init streams list */</a>
<a name="ln838">	LIST_INIT(&amp;(card-&gt;streams));</a>
<a name="ln839"> </a>
<a name="ln840">	/* Init mems list */</a>
<a name="ln841">	LIST_INIT(&amp;(card-&gt;mems));</a>
<a name="ln842"> </a>
<a name="ln843">#ifdef MIDI_SUPPORT</a>
<a name="ln844">	card-&gt;midi.midi_ready_sem = create_sem(0, &quot;midi sem&quot;);</a>
<a name="ln845">#endif</a>
<a name="ln846"> </a>
<a name="ln847">	PRINT((&quot;installing interrupt : %x\n&quot;, card-&gt;irq));</a>
<a name="ln848">	status = install_io_interrupt_handler(card-&gt;irq, echo_int, card, 0);</a>
<a name="ln849">	if (status != B_OK) {</a>
<a name="ln850">		PRINT((&quot;failed to install interrupt\n&quot;));</a>
<a name="ln851">		goto err2;</a>
<a name="ln852">	}</a>
<a name="ln853"> </a>
<a name="ln854">	PRINT((&quot;echo_setup done\n&quot;));</a>
<a name="ln855"> </a>
<a name="ln856">	echo_dump_caps(card);</a>
<a name="ln857"> </a>
<a name="ln858">#ifdef ECHO3G_FAMILY</a>
<a name="ln859">	if (card-&gt;type == ECHO3G) {</a>
<a name="ln860">		strlcpy(card-&gt;caps.szName, ((C3g*)card-&gt;pEG)-&gt;Get3gBoxName(),</a>
<a name="ln861">			ECHO_MAXNAMELEN);</a>
<a name="ln862">	}</a>
<a name="ln863">#endif</a>
<a name="ln864"> </a>
<a name="ln865">	status = card-&gt;pEG-&gt;OpenMixer(card-&gt;mixer);</a>
<a name="ln866">	if (status != ECHOSTATUS_OK) {</a>
<a name="ln867">		PRINT((&quot;failed to open mixer\n&quot;));</a>
<a name="ln868">		goto err1;</a>
<a name="ln869">	}</a>
<a name="ln870"> </a>
<a name="ln871">	return B_OK;</a>
<a name="ln872"> </a>
<a name="ln873">err1:</a>
<a name="ln874">	remove_io_interrupt_handler(card-&gt;irq, echo_int, card);</a>
<a name="ln875">err2:</a>
<a name="ln876">#ifdef MIDI_SUPPORT</a>
<a name="ln877">	delete_sem(card-&gt;midi.midi_ready_sem);</a>
<a name="ln878">#endif</a>
<a name="ln879">err3:</a>
<a name="ln880">	delete card-&gt;pEG;</a>
<a name="ln881">err4:</a>
<a name="ln882">	delete card-&gt;pOSS;</a>
<a name="ln883">err5:</a>
<a name="ln884">	delete_area(card-&gt;area_bmbar);</a>
<a name="ln885">	return B_ERROR;</a>
<a name="ln886">}</a>
<a name="ln887"> </a>
<a name="ln888">static void</a>
<a name="ln889">echo_shutdown(echo_dev *card)</a>
<a name="ln890">{</a>
<a name="ln891">	ECHOSTATUS status;</a>
<a name="ln892"> </a>
<a name="ln893">	PRINT((&quot;shutdown(%p)\n&quot;, card));</a>
<a name="ln894">	status = card-&gt;pEG-&gt;CloseMixer(card-&gt;mixer);</a>
<a name="ln895">	if (status != ECHOSTATUS_OK)</a>
<a name="ln896">		PRINT((&quot;echo_shutdown: error when CloseMixer\n&quot;));</a>
<a name="ln897"> </a>
<a name="ln898">	remove_io_interrupt_handler(card-&gt;irq, echo_int, card);</a>
<a name="ln899"> </a>
<a name="ln900">#ifdef MIDI_SUPPORT</a>
<a name="ln901">	delete_sem(card-&gt;midi.midi_ready_sem);</a>
<a name="ln902">#endif</a>
<a name="ln903"> </a>
<a name="ln904">	delete card-&gt;pEG;</a>
<a name="ln905">	delete card-&gt;pOSS;</a>
<a name="ln906"> </a>
<a name="ln907">	delete_area(card-&gt;area_bmbar);</a>
<a name="ln908">}</a>
<a name="ln909"> </a>
<a name="ln910"> </a>
<a name="ln911"> </a>
<a name="ln912">void</a>
<a name="ln913">uninit_driver(void)</a>
<a name="ln914">{</a>
<a name="ln915">	PRINT((&quot;uninit_driver()\n&quot;));</a>
<a name="ln916"> </a>
<a name="ln917">#ifdef CARDBUS</a>
<a name="ln918">	echo_dev			*dev;</a>
<a name="ln919"> </a>
<a name="ln920">	LIST_FOREACH(dev, &amp;devices, next) {</a>
<a name="ln921">		echo_shutdown(dev);</a>
<a name="ln922">	}</a>
<a name="ln923">	put_module(CB_ENABLER_MODULE_NAME);</a>
<a name="ln924">#else</a>
<a name="ln925">	int ix, cnt = num_cards;</a>
<a name="ln926">	num_cards = 0;</a>
<a name="ln927">	for (ix=0; ix&lt;cnt; ix++) {</a>
<a name="ln928">		echo_shutdown(&amp;cards[ix]);</a>
<a name="ln929">#ifdef __HAIKU__</a>
<a name="ln930">		(*pci-&gt;unreserve_device)(cards[ix].info.bus,</a>
<a name="ln931">			cards[ix].info.device, cards[ix].info.function,</a>
<a name="ln932">			DRIVER_NAME, &amp;cards[ix]);</a>
<a name="ln933">#endif</a>
<a name="ln934">	}</a>
<a name="ln935"> </a>
<a name="ln936">	memset(&amp;cards, 0, sizeof(cards));</a>
<a name="ln937">	put_module(B_PCI_MODULE_NAME);</a>
<a name="ln938">#endif</a>
<a name="ln939">}</a>
<a name="ln940"> </a>
<a name="ln941"> </a>
<a name="ln942">const char **</a>
<a name="ln943">publish_devices(void)</a>
<a name="ln944">{</a>
<a name="ln945">#ifdef CARDBUS</a>
<a name="ln946">	echo_dev			*dev;</a>
<a name="ln947">	int			ix = 0;</a>
<a name="ln948"> </a>
<a name="ln949">	// Lock the devices</a>
<a name="ln950">	acquire_sem(device_lock);</a>
<a name="ln951">	// Loop</a>
<a name="ln952">	LIST_FOREACH(dev, &amp;devices, next) {</a>
<a name="ln953">		if (dev-&gt;plugged == true) {</a>
<a name="ln954">			names[ix] = dev-&gt;name;</a>
<a name="ln955">			ix++;</a>
<a name="ln956">		}</a>
<a name="ln957">	}</a>
<a name="ln958">	names[ix] = NULL;</a>
<a name="ln959">	release_sem(device_lock);</a>
<a name="ln960">#else</a>
<a name="ln961">	int ix = 0;</a>
<a name="ln962">	PRINT((&quot;publish_devices()\n&quot;));</a>
<a name="ln963"> </a>
<a name="ln964">	for (ix=0; names[ix]; ix++) {</a>
<a name="ln965">		PRINT((&quot;publish %s\n&quot;, names[ix]));</a>
<a name="ln966">	}</a>
<a name="ln967">#endif</a>
<a name="ln968">	return (const char **)names;</a>
<a name="ln969">}</a>
<a name="ln970"> </a>
<a name="ln971"> </a>
<a name="ln972">device_hooks *</a>
<a name="ln973">find_device(const char * name)</a>
<a name="ln974">{</a>
<a name="ln975">	echo_dev *dev;</a>
<a name="ln976">#ifdef CARDBUS</a>
<a name="ln977">	LIST_FOREACH(dev, &amp;devices, next) {</a>
<a name="ln978">		if (!strcmp(dev-&gt;name, name)) {</a>
<a name="ln979">			return &amp;multi_hooks;</a>
<a name="ln980">		}</a>
<a name="ln981">	}</a>
<a name="ln982"> </a>
<a name="ln983">#else</a>
<a name="ln984">	int ix;</a>
<a name="ln985"> </a>
<a name="ln986">	PRINT((&quot;find_device(%s)\n&quot;, name));</a>
<a name="ln987"> </a>
<a name="ln988">	for (ix=0; ix&lt;num_cards; ix++) {</a>
<a name="ln989">#ifdef MIDI_SUPPORT</a>
<a name="ln990">		if (!strcmp(cards[ix].midi.name, name)) {</a>
<a name="ln991">			return &amp;midi_hooks;</a>
<a name="ln992">		}</a>
<a name="ln993">#endif</a>
<a name="ln994">		if (!strcmp(cards[ix].name, name)) {</a>
<a name="ln995">			return &amp;multi_hooks;</a>
<a name="ln996">		}</a>
<a name="ln997">	}</a>
<a name="ln998">#endif</a>
<a name="ln999">	PRINT((&quot;find_device(%s) failed\n&quot;, name));</a>
<a name="ln1000">	return NULL;</a>
<a name="ln1001">}</a>
<a name="ln1002"> </a>
<a name="ln1003">int32	api_version = B_CUR_DRIVER_API_VERSION;</a>

</code></pre>
<div class="balloon" rel="611"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="394"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'stream->pipe >= 0' is always true. Unsigned type value is always >= 0.</p></div>
<div class="balloon" rel="170"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'stream->pipe >= 0' is always true. Unsigned type value is always >= 0.</p></div>
<div class="balloon" rel="828"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v614/" target="_blank">V614</a> Potentially uninitialized pointer 'name' used. Consider checking the second actual argument of the 'AssignResources' function.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
