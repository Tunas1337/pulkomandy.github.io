
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ExpanderWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2004-2006, Jérôme DUVAL. All rights reserved.</a>
<a name="ln3"> * Copyright 2010, Karsten Heimrich. All rights reserved.</a>
<a name="ln4"> * Copyright 2013, Rene Gollent, rene@gollent.com.</a>
<a name="ln5"> * Distributed under the terms of the MIT License.</a>
<a name="ln6"> */</a>
<a name="ln7"> </a>
<a name="ln8"> </a>
<a name="ln9">#include &quot;ExpanderWindow.h&quot;</a>
<a name="ln10"> </a>
<a name="ln11">#include &lt;algorithm&gt;</a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;Alert.h&gt;</a>
<a name="ln14">#include &lt;Box.h&gt;</a>
<a name="ln15">#include &lt;Button.h&gt;</a>
<a name="ln16">#include &lt;Catalog.h&gt;</a>
<a name="ln17">#include &lt;CheckBox.h&gt;</a>
<a name="ln18">#include &lt;ControlLook.h&gt;</a>
<a name="ln19">#include &lt;Entry.h&gt;</a>
<a name="ln20">#include &lt;File.h&gt;</a>
<a name="ln21">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln22">#include &lt;Locale.h&gt;</a>
<a name="ln23">#include &lt;Menu.h&gt;</a>
<a name="ln24">#include &lt;MenuBar.h&gt;</a>
<a name="ln25">#include &lt;MenuItem.h&gt;</a>
<a name="ln26">#include &lt;Path.h&gt;</a>
<a name="ln27">#include &lt;Screen.h&gt;</a>
<a name="ln28">#include &lt;ScrollView.h&gt;</a>
<a name="ln29">#include &lt;StringView.h&gt;</a>
<a name="ln30">#include &lt;TextView.h&gt;</a>
<a name="ln31"> </a>
<a name="ln32">#include &quot;ExpanderApp.h&quot;</a>
<a name="ln33">#include &quot;ExpanderThread.h&quot;</a>
<a name="ln34">#include &quot;ExpanderPreferences.h&quot;</a>
<a name="ln35">#include &quot;PasswordAlert.h&quot;</a>
<a name="ln36"> </a>
<a name="ln37"> </a>
<a name="ln38">const uint32 MSG_SOURCE			= 'mSOU';</a>
<a name="ln39">const uint32 MSG_DEST			= 'mDES';</a>
<a name="ln40">const uint32 MSG_EXPAND			= 'mEXP';</a>
<a name="ln41">const uint32 MSG_SHOW			= 'mSHO';</a>
<a name="ln42">const uint32 MSG_STOP			= 'mSTO';</a>
<a name="ln43">const uint32 MSG_PREFERENCES	= 'mPRE';</a>
<a name="ln44">const uint32 MSG_SOURCETEXT		= 'mSTX';</a>
<a name="ln45">const uint32 MSG_DESTTEXT		= 'mDTX';</a>
<a name="ln46">const uint32 MSG_SHOWCONTENTS	= 'mSCT';</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">class StatusView : public BStringView {</a>
<a name="ln50">public:</a>
<a name="ln51">	StatusView()</a>
<a name="ln52">		:</a>
<a name="ln53">		BStringView(NULL, &quot;&quot;)</a>
<a name="ln54">	{</a>
<a name="ln55">	}</a>
<a name="ln56"> </a>
<a name="ln57">	virtual ~StatusView()</a>
<a name="ln58">	{</a>
<a name="ln59">	}</a>
<a name="ln60"> </a>
<a name="ln61">	void SetStatus(const BString &amp;text)</a>
<a name="ln62">	{</a>
<a name="ln63">		fStatus = text;</a>
<a name="ln64">		Invalidate();</a>
<a name="ln65">	}</a>
<a name="ln66"> </a>
<a name="ln67">	void Draw(BRect updateRect)</a>
<a name="ln68">	{</a>
<a name="ln69">		BString truncated = fStatus;</a>
<a name="ln70">		if(fStatus.IsEmpty() == false) {</a>
<a name="ln71">			be_plain_font-&gt;TruncateString(&amp;truncated, B_TRUNCATE_END,</a>
<a name="ln72">				Bounds().Width());</a>
<a name="ln73">		}</a>
<a name="ln74"> </a>
<a name="ln75">		SetText(truncated);</a>
<a name="ln76">		BStringView::Draw(updateRect);</a>
<a name="ln77">	}</a>
<a name="ln78"> </a>
<a name="ln79">private:</a>
<a name="ln80">	BString fStatus;</a>
<a name="ln81">};</a>
<a name="ln82"> </a>
<a name="ln83"> </a>
<a name="ln84">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln85">#define B_TRANSLATION_CONTEXT &quot;ExpanderWindow&quot;</a>
<a name="ln86"> </a>
<a name="ln87"> </a>
<a name="ln88">ExpanderWindow::ExpanderWindow(BRect frame, const entry_ref* ref,</a>
<a name="ln89">	BMessage* settings)</a>
<a name="ln90">	:</a>
<a name="ln91">	BWindow(frame, B_TRANSLATE_SYSTEM_NAME(&quot;Expander&quot;), B_TITLED_WINDOW,</a>
<a name="ln92">		B_NORMAL_WINDOW_FEEL),</a>
<a name="ln93">	fSourcePanel(NULL),</a>
<a name="ln94">	fDestPanel(NULL),</a>
<a name="ln95">	fSourceChanged(true),</a>
<a name="ln96">	fListingThread(NULL),</a>
<a name="ln97">	fListingStarted(false),</a>
<a name="ln98">	fExpandingThread(NULL),</a>
<a name="ln99">	fExpandingStarted(false),</a>
<a name="ln100">	fSettings(*settings),</a>
<a name="ln101">	fPreferences(NULL)</a>
<a name="ln102">{</a>
<a name="ln103">	_CreateMenuBar();</a>
<a name="ln104"> </a>
<a name="ln105">	fDestButton = new BButton(B_TRANSLATE(&quot;Destination&quot;),</a>
<a name="ln106">		new BMessage(MSG_DEST));</a>
<a name="ln107">	fSourceButton = new BButton(B_TRANSLATE(&quot;Source&quot;),</a>
<a name="ln108">		new BMessage(MSG_SOURCE));</a>
<a name="ln109">	fExpandButton = new BButton(B_TRANSLATE(&quot;Expand&quot;),</a>
<a name="ln110">		new BMessage(MSG_EXPAND));</a>
<a name="ln111"> </a>
<a name="ln112">	BSize size = fDestButton-&gt;PreferredSize();</a>
<a name="ln113">	size.width = std::max(size.width, fSourceButton-&gt;PreferredSize().width);</a>
<a name="ln114">	size.width = std::max(size.width, fExpandButton-&gt;PreferredSize().width);</a>
<a name="ln115"> </a>
<a name="ln116">	fDestButton-&gt;SetExplicitSize(size);</a>
<a name="ln117">	fSourceButton-&gt;SetExplicitSize(size);</a>
<a name="ln118">	fExpandButton-&gt;SetExplicitSize(size);</a>
<a name="ln119"> </a>
<a name="ln120">	fListingText = new BTextView(&quot;listingText&quot;);</a>
<a name="ln121">	fListingText-&gt;SetText(&quot;&quot;);</a>
<a name="ln122">	fListingText-&gt;MakeEditable(false);</a>
<a name="ln123">	fListingText-&gt;SetStylable(false);</a>
<a name="ln124">	fListingText-&gt;SetWordWrap(false);</a>
<a name="ln125">	BFont font = be_fixed_font;</a>
<a name="ln126">	fListingText-&gt;SetFontAndColor(&amp;font);</a>
<a name="ln127">	fScrollView = new BScrollView(&quot;&quot;, fListingText,	B_INVALIDATE_AFTER_LAYOUT,</a>
<a name="ln128">		true, true);</a>
<a name="ln129"> </a>
<a name="ln130">	const float spacing = be_control_look-&gt;DefaultItemSpacing();</a>
<a name="ln131">	BGroupLayout* pathLayout;</a>
<a name="ln132">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln133">		.Add(fBar)</a>
<a name="ln134">		.AddGroup(B_VERTICAL, B_USE_ITEM_SPACING)</a>
<a name="ln135">			.AddGroup(B_HORIZONTAL, B_USE_ITEM_SPACING)</a>
<a name="ln136">				.Add(fSourceButton)</a>
<a name="ln137">				.Add(fSourceText = new BTextControl(NULL, NULL,</a>
<a name="ln138">					new BMessage(MSG_SOURCETEXT)))</a>
<a name="ln139">				.End()</a>
<a name="ln140">			.AddGroup(B_HORIZONTAL, B_USE_ITEM_SPACING)</a>
<a name="ln141">				.Add(fDestButton)</a>
<a name="ln142">				.Add(fDestText = new BTextControl(NULL, NULL,</a>
<a name="ln143">					new BMessage(MSG_DESTTEXT)))</a>
<a name="ln144">				.End()</a>
<a name="ln145">			.AddGroup(B_HORIZONTAL, B_USE_ITEM_SPACING)</a>
<a name="ln146">				.Add(fExpandButton)</a>
<a name="ln147">				.AddGroup(B_HORIZONTAL, B_USE_ITEM_SPACING)</a>
<a name="ln148">					.GetLayout(&amp;pathLayout)</a>
<a name="ln149">					.Add(fShowContents = new BCheckBox(</a>
<a name="ln150">						B_TRANSLATE(&quot;Show contents&quot;),</a>
<a name="ln151">						new BMessage(MSG_SHOWCONTENTS)))</a>
<a name="ln152">					.Add(fStatusView = new StatusView())</a>
<a name="ln153">					.End()</a>
<a name="ln154">				.End()</a>
<a name="ln155">			.Add(fScrollView)</a>
<a name="ln156">			.SetInsets(B_USE_WINDOW_SPACING)</a>
<a name="ln157">			.End();</a>
<a name="ln158"> </a>
<a name="ln159">	pathLayout-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln160">	size = GetLayout()-&gt;View()-&gt;PreferredSize();</a>
<a name="ln161">	fSizeLimit = size.Height() - fScrollView-&gt;PreferredSize().height - spacing;</a>
<a name="ln162"> </a>
<a name="ln163">	fStatusView-&gt;SetExplicitMinSize(BSize(50.0f, B_SIZE_UNSET));</a>
<a name="ln164">	fStatusView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln165"> </a>
<a name="ln166">	ResizeTo(Bounds().Width(), fSizeLimit);</a>
<a name="ln167">	SetSizeLimits(size.Width(), 32767.0f, fSizeLimit, fSizeLimit);</a>
<a name="ln168">	SetZoomLimits(Bounds().Width(), fSizeLimit);</a>
<a name="ln169">	fPreviousHeight = -1;</a>
<a name="ln170"> </a>
<a name="ln171">	fScrollView-&gt;Hide();</a>
<a name="ln172"> </a>
<a name="ln173">	Show();</a>
<a name="ln174">}</a>
<a name="ln175"> </a>
<a name="ln176"> </a>
<a name="ln177">ExpanderWindow::~ExpanderWindow()</a>
<a name="ln178">{</a>
<a name="ln179">	if (fDestPanel &amp;&amp; fDestPanel-&gt;RefFilter())</a>
<a name="ln180">		delete fDestPanel-&gt;RefFilter();</a>
<a name="ln181"> </a>
<a name="ln182">	if (fSourcePanel &amp;&amp; fSourcePanel-&gt;RefFilter())</a>
<a name="ln183">		delete fSourcePanel-&gt;RefFilter();</a>
<a name="ln184"> </a>
<a name="ln185">	delete fDestPanel;</a>
<a name="ln186">	delete fSourcePanel;</a>
<a name="ln187">}</a>
<a name="ln188"> </a>
<a name="ln189"> </a>
<a name="ln190">bool</a>
<a name="ln191">ExpanderWindow::ValidateDest()</a>
<a name="ln192">{</a>
<a name="ln193">	BEntry entry(fDestText-&gt;Text(), true);</a>
<a name="ln194">	BVolume volume;</a>
<a name="ln195">	if (!entry.Exists()) {</a>
<a name="ln196">		BAlert* alert = new BAlert(&quot;destAlert&quot;,</a>
<a name="ln197">			B_TRANSLATE(&quot;Destination folder doesn't exist. &quot;</a>
<a name="ln198">				&quot;Would you like to create it?&quot;),</a>
<a name="ln199">			B_TRANSLATE(&quot;Create&quot;), B_TRANSLATE(&quot;Cancel&quot;), NULL,</a>
<a name="ln200">			B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln201">		alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln202"> </a>
<a name="ln203">		if (alert-&gt;Go() != 0)</a>
<a name="ln204">			return false;</a>
<a name="ln205"> </a>
<a name="ln206">		if (create_directory(fDestText-&gt;Text(), 0755) != B_OK) {</a>
<a name="ln207">			BAlert* alert = new BAlert(&quot;stopAlert&quot;,</a>
<a name="ln208">				B_TRANSLATE(&quot;Failed to create the destination folder.&quot;),</a>
<a name="ln209">				B_TRANSLATE(&quot;Cancel&quot;), NULL, NULL,</a>
<a name="ln210">				B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln211">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln212">			alert-&gt;Go();</a>
<a name="ln213">			return false;</a>
<a name="ln214">		}</a>
<a name="ln215"> </a>
<a name="ln216">		BEntry newEntry(fDestText-&gt;Text(), true);</a>
<a name="ln217">		newEntry.GetRef(&amp;fDestRef);</a>
<a name="ln218">		return true;</a>
<a name="ln219"> </a>
<a name="ln220">	}</a>
<a name="ln221"> </a>
<a name="ln222">	if (!entry.IsDirectory()) {</a>
<a name="ln223">		BAlert* alert = new BAlert(&quot;destAlert&quot;,</a>
<a name="ln224">			B_TRANSLATE(&quot;The destination is not a folder.&quot;),</a>
<a name="ln225">			B_TRANSLATE(&quot;Cancel&quot;), NULL, NULL,</a>
<a name="ln226">			B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln227">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln228">		alert-&gt;Go();</a>
<a name="ln229">		return false;</a>
<a name="ln230">	}</a>
<a name="ln231"> </a>
<a name="ln232">	if (entry.GetVolume(&amp;volume) != B_OK || volume.IsReadOnly()) {</a>
<a name="ln233">		BAlert* alert = new BAlert(&quot;destAlert&quot;,</a>
<a name="ln234">			B_TRANSLATE(&quot;The destination is read only.&quot;),</a>
<a name="ln235">			B_TRANSLATE(&quot;Cancel&quot;), NULL, NULL, B_WIDTH_AS_USUAL,</a>
<a name="ln236">			B_EVEN_SPACING,	B_WARNING_ALERT);</a>
<a name="ln237">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln238">		alert-&gt;Go();</a>
<a name="ln239">		return false;</a>
<a name="ln240">	}</a>
<a name="ln241"> </a>
<a name="ln242">	entry.GetRef(&amp;fDestRef);</a>
<a name="ln243">	return true;</a>
<a name="ln244">}</a>
<a name="ln245"> </a>
<a name="ln246"> </a>
<a name="ln247">void</a>
<a name="ln248">ExpanderWindow::MessageReceived(BMessage* message)</a>
<a name="ln249">{</a>
<a name="ln250">	switch (message-&gt;what) {</a>
<a name="ln251">		case MSG_SOURCE:</a>
<a name="ln252">		{</a>
<a name="ln253">			BEntry entry(fSourceText-&gt;Text(), true);</a>
<a name="ln254">			entry_ref srcRef;</a>
<a name="ln255">			if (entry.Exists() &amp;&amp; entry.IsDirectory())</a>
<a name="ln256">				entry.GetRef(&amp;srcRef);</a>
<a name="ln257">			if (!fSourcePanel) {</a>
<a name="ln258">				BMessenger messenger(this);</a>
<a name="ln259">				fSourcePanel = new BFilePanel(B_OPEN_PANEL, &amp;messenger, &amp;srcRef,</a>
<a name="ln260">					B_FILE_NODE, false, NULL, new RuleRefFilter(fRules), true);</a>
<a name="ln261">				(fSourcePanel-&gt;Window())-&gt;SetTitle(</a>
<a name="ln262">					B_TRANSLATE(&quot;Expander: Open&quot;));</a>
<a name="ln263">			} else</a>
<a name="ln264">				fSourcePanel-&gt;SetPanelDirectory(&amp;srcRef);</a>
<a name="ln265">			fSourcePanel-&gt;Show();</a>
<a name="ln266">			break;</a>
<a name="ln267">		}</a>
<a name="ln268"> </a>
<a name="ln269">		case MSG_DEST:</a>
<a name="ln270">		{</a>
<a name="ln271">			BEntry entry(fDestText-&gt;Text(), true);</a>
<a name="ln272">			entry_ref destRef;</a>
<a name="ln273">			if (entry.Exists() &amp;&amp; entry.IsDirectory())</a>
<a name="ln274">				entry.GetRef(&amp;destRef);</a>
<a name="ln275">			if (!fDestPanel) {</a>
<a name="ln276">				BMessenger messenger(this);</a>
<a name="ln277">				fDestPanel = new DirectoryFilePanel(B_OPEN_PANEL, &amp;messenger,</a>
<a name="ln278">					&amp;destRef, B_DIRECTORY_NODE, false, NULL,</a>
<a name="ln279">					new DirectoryRefFilter(), true);</a>
<a name="ln280">			} else</a>
<a name="ln281">				fDestPanel-&gt;SetPanelDirectory(&amp;destRef);</a>
<a name="ln282">			fDestPanel-&gt;Show();</a>
<a name="ln283">			break;</a>
<a name="ln284">		}</a>
<a name="ln285"> </a>
<a name="ln286">		case MSG_DIRECTORY:</a>
<a name="ln287">		{</a>
<a name="ln288">			entry_ref ref;</a>
<a name="ln289">			fDestPanel-&gt;GetPanelDirectory(&amp;ref);</a>
<a name="ln290">			fDestRef = ref;</a>
<a name="ln291">			BEntry entry(&amp;ref);</a>
<a name="ln292">			BPath path(&amp;entry);</a>
<a name="ln293">			fDestText-&gt;SetText(path.Path());</a>
<a name="ln294">			fDestPanel-&gt;Hide();</a>
<a name="ln295">			break;</a>
<a name="ln296">		}</a>
<a name="ln297"> </a>
<a name="ln298">		case B_SIMPLE_DATA:</a>
<a name="ln299">		case B_REFS_RECEIVED:</a>
<a name="ln300">			RefsReceived(message);</a>
<a name="ln301">			break;</a>
<a name="ln302"> </a>
<a name="ln303">		case MSG_EXPAND:</a>
<a name="ln304">			if (!ValidateDest())</a>
<a name="ln305">				break;</a>
<a name="ln306">			if (!fExpandingStarted) {</a>
<a name="ln307">				StartExpanding();</a>
<a name="ln308">				break;</a>
<a name="ln309">			}</a>
<a name="ln310">			// supposed to fall through</a>
<a name="ln311">		case MSG_STOP:</a>
<a name="ln312">			if (fExpandingStarted) {</a>
<a name="ln313">				fExpandingThread-&gt;SuspendExternalExpander();</a>
<a name="ln314">				BAlert* alert = new BAlert(&quot;stopAlert&quot;,</a>
<a name="ln315">					B_TRANSLATE(&quot;Are you sure you want to stop expanding this &quot;</a>
<a name="ln316">						&quot;archive? The expanded items may not be complete.&quot;),</a>
<a name="ln317">					B_TRANSLATE(&quot;Stop&quot;), B_TRANSLATE(&quot;Continue&quot;), NULL,</a>
<a name="ln318">					B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln319">				alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln320">				if (alert-&gt;Go() == 0) {</a>
<a name="ln321">					fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln322">					StopExpanding();</a>
<a name="ln323">				} else</a>
<a name="ln324">					fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln325">			}</a>
<a name="ln326">			break;</a>
<a name="ln327"> </a>
<a name="ln328">		case MSG_SHOW:</a>
<a name="ln329">			fShowContents-&gt;SetValue(fShowContents-&gt;Value() == B_CONTROL_OFF</a>
<a name="ln330">				? B_CONTROL_ON : B_CONTROL_OFF);</a>
<a name="ln331">			// supposed to fall through</a>
<a name="ln332">		case MSG_SHOWCONTENTS:</a>
<a name="ln333">			// change menu item label</a>
<a name="ln334">			fShowItem-&gt;SetLabel(fShowContents-&gt;Value() == B_CONTROL_OFF</a>
<a name="ln335">				? B_TRANSLATE(&quot;Show contents&quot;) : B_TRANSLATE(&quot;Hide contents&quot;));</a>
<a name="ln336"> </a>
<a name="ln337">			if (fShowContents-&gt;Value() == B_CONTROL_OFF) {</a>
<a name="ln338">				if (fListingStarted)</a>
<a name="ln339">					StopListing();</a>
<a name="ln340"> </a>
<a name="ln341">				fScrollView-&gt;Hide();</a>
<a name="ln342">				_UpdateWindowSize(false);</a>
<a name="ln343">			} else {</a>
<a name="ln344">				fScrollView-&gt;Show();</a>
<a name="ln345">				StartListing();</a>
<a name="ln346">			}</a>
<a name="ln347">			break;</a>
<a name="ln348"> </a>
<a name="ln349">		case MSG_SOURCETEXT:</a>
<a name="ln350">		{</a>
<a name="ln351">			BEntry entry(fSourceText-&gt;Text(), true);</a>
<a name="ln352">			if (!entry.Exists()) {</a>
<a name="ln353">				BAlert* alert = new BAlert(&quot;srcAlert&quot;,</a>
<a name="ln354">					B_TRANSLATE(&quot;The file doesn't exist&quot;),</a>
<a name="ln355">					B_TRANSLATE(&quot;Cancel&quot;), NULL, NULL,</a>
<a name="ln356">					B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln357">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln358">				alert-&gt;Go();</a>
<a name="ln359">				break;</a>
<a name="ln360">			}</a>
<a name="ln361"> </a>
<a name="ln362">			entry_ref ref;</a>
<a name="ln363">			entry.GetRef(&amp;ref);</a>
<a name="ln364">			ExpanderRule* rule = fRules.MatchingRule(&amp;ref);</a>
<a name="ln365">			if (rule) {</a>
<a name="ln366">				fSourceChanged = true;</a>
<a name="ln367">				fSourceRef = ref;</a>
<a name="ln368">				fShowContents-&gt;SetEnabled(true);</a>
<a name="ln369">				fExpandButton-&gt;SetEnabled(true);</a>
<a name="ln370">				fExpandItem-&gt;SetEnabled(true);</a>
<a name="ln371">				fShowItem-&gt;SetEnabled(true);</a>
<a name="ln372">				break;</a>
<a name="ln373">			}</a>
<a name="ln374"> </a>
<a name="ln375">			BString string = &quot;The file : &quot;;</a>
<a name="ln376">			string += fSourceText-&gt;Text();</a>
<a name="ln377">			string += B_TRANSLATE_MARK(&quot; is not supported&quot;);</a>
<a name="ln378">			BAlert* alert = new BAlert(&quot;srcAlert&quot;, string.String(),</a>
<a name="ln379">				B_TRANSLATE(&quot;Cancel&quot;),</a>
<a name="ln380">				NULL, NULL, B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_INFO_ALERT);</a>
<a name="ln381">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln382">			alert-&gt;Go();</a>
<a name="ln383"> </a>
<a name="ln384">			fShowContents-&gt;SetEnabled(false);</a>
<a name="ln385">			fExpandButton-&gt;SetEnabled(false);</a>
<a name="ln386">			fExpandItem-&gt;SetEnabled(false);</a>
<a name="ln387">			fShowItem-&gt;SetEnabled(false);</a>
<a name="ln388">			break;</a>
<a name="ln389">		}</a>
<a name="ln390"> </a>
<a name="ln391">		case MSG_DESTTEXT:</a>
<a name="ln392">			ValidateDest();</a>
<a name="ln393">			break;</a>
<a name="ln394"> </a>
<a name="ln395">		case MSG_PREFERENCES:</a>
<a name="ln396">			if (fPreferences == NULL)</a>
<a name="ln397">				fPreferences = new ExpanderPreferences(&amp;fSettings);</a>
<a name="ln398"> </a>
<a name="ln399">			fPreferences-&gt;Show();</a>
<a name="ln400">			break;</a>
<a name="ln401"> </a>
<a name="ln402">		case 'outp':</a>
<a name="ln403">			if (!fExpandingStarted &amp;&amp; fListingStarted) {</a>
<a name="ln404">				// Check if the vertical scroll bar is at the end</a>
<a name="ln405">				float max, pos;</a>
<a name="ln406">				fScrollView-&gt;ScrollBar(B_VERTICAL)-&gt;GetRange(NULL, &amp;max);</a>
<a name="ln407">				pos = fScrollView-&gt;ScrollBar(B_VERTICAL)-&gt;Value();</a>
<a name="ln408">				bool atEnd = (pos == max);</a>
<a name="ln409"> </a>
<a name="ln410">				BString string;</a>
<a name="ln411">				int32 i = 0;</a>
<a name="ln412">				while (message-&gt;FindString(&quot;output&quot;, i++, &amp;string) == B_OK) {</a>
<a name="ln413">					float length = fListingText-&gt;StringWidth(string.String());</a>
<a name="ln414"> </a>
<a name="ln415">					if (length &gt; fLongestLine)</a>
<a name="ln416">						fLongestLine = length;</a>
<a name="ln417"> </a>
<a name="ln418">					fListingText-&gt;Insert(string.String());</a>
<a name="ln419">				}</a>
<a name="ln420"> </a>
<a name="ln421">				if (atEnd &amp;&amp; fScrollView-&gt;ScrollBar(B_VERTICAL)-&gt;Value() == pos) {</a>
<a name="ln422">					fScrollView-&gt;ScrollBar(B_VERTICAL)-&gt;GetRange(NULL, &amp;max);</a>
<a name="ln423">					fScrollView-&gt;ScrollBar(B_VERTICAL)-&gt;SetValue(max);</a>
<a name="ln424">				}</a>
<a name="ln425">			} else if (fExpandingStarted) {</a>
<a name="ln426">				BString string;</a>
<a name="ln427">				int32 i = 0;</a>
<a name="ln428">				while (message-&gt;FindString(&quot;output&quot;, i++, &amp;string) == B_OK) {</a>
<a name="ln429">					if (strstr(string.String(), &quot;Enter password&quot;) != NULL) {</a>
<a name="ln430">						fExpandingThread-&gt;SuspendExternalExpander();</a>
<a name="ln431">						BString password;</a>
<a name="ln432">						PasswordAlert* alert =</a>
<a name="ln433">							new PasswordAlert(&quot;passwordAlert&quot;, string);</a>
<a name="ln434">						alert-&gt;Go(password);</a>
<a name="ln435">						fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln436">						fExpandingThread-&gt;PushInput(password);</a>
<a name="ln437">					}</a>
<a name="ln438">				}</a>
<a name="ln439">			}</a>
<a name="ln440">			break;</a>
<a name="ln441"> </a>
<a name="ln442">		case 'errp':</a>
<a name="ln443">		{</a>
<a name="ln444">			BString string;</a>
<a name="ln445">			if (message-&gt;FindString(&quot;error&quot;, &amp;string) == B_OK</a>
<a name="ln446">				&amp;&amp; fExpandingStarted) {</a>
<a name="ln447">				fExpandingThread-&gt;SuspendExternalExpander();</a>
<a name="ln448">				if (strstr(string.String(), &quot;password&quot;) != NULL) {</a>
<a name="ln449">					BString password;</a>
<a name="ln450">					PasswordAlert* alert = new PasswordAlert(&quot;passwordAlert&quot;,</a>
<a name="ln451">						string);</a>
<a name="ln452">					alert-&gt;Go(password);</a>
<a name="ln453">					fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln454">					fExpandingThread-&gt;PushInput(password);</a>
<a name="ln455">				} else {</a>
<a name="ln456">					BAlert* alert = new BAlert(&quot;stopAlert&quot;, string,</a>
<a name="ln457">						B_TRANSLATE(&quot;Stop&quot;), B_TRANSLATE(&quot;Continue&quot;), NULL,</a>
<a name="ln458">						B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln459">					alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln460">					if (alert-&gt;Go() == 0) {</a>
<a name="ln461">						fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln462">						StopExpanding();</a>
<a name="ln463">					} else</a>
<a name="ln464">						fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln465">				}</a>
<a name="ln466">			}</a>
<a name="ln467">			break;</a>
<a name="ln468">		}</a>
<a name="ln469"> </a>
<a name="ln470">		case 'exit':</a>
<a name="ln471">			// thread has finished</a>
<a name="ln472">			// (finished, quit, killed, we don't know)</a>
<a name="ln473">			// reset window state</a>
<a name="ln474">			if (fExpandingStarted) {</a>
<a name="ln475">				fStatusView-&gt;SetStatus(B_TRANSLATE(&quot;File expanded&quot;));</a>
<a name="ln476">				StopExpanding();</a>
<a name="ln477">				OpenDestFolder();</a>
<a name="ln478">				CloseWindowOrKeepOpen();</a>
<a name="ln479">			} else if (fListingStarted) {</a>
<a name="ln480">				fSourceChanged = false;</a>
<a name="ln481">				StopListing();</a>
<a name="ln482">				_ExpandListingText();</a>
<a name="ln483">			} else</a>
<a name="ln484">				fStatusView-&gt;SetStatus(&quot;&quot;);</a>
<a name="ln485">			break;</a>
<a name="ln486"> </a>
<a name="ln487">		case 'exrr':</a>
<a name="ln488">			// thread has finished</a>
<a name="ln489">			// reset window state</a>
<a name="ln490"> </a>
<a name="ln491">			fStatusView-&gt;SetStatus(B_TRANSLATE(&quot;Error when expanding archive&quot;));</a>
<a name="ln492">			CloseWindowOrKeepOpen();</a>
<a name="ln493">			break;</a>
<a name="ln494"> </a>
<a name="ln495">		default:</a>
<a name="ln496">			BWindow::MessageReceived(message);</a>
<a name="ln497">	}</a>
<a name="ln498">}</a>
<a name="ln499"> </a>
<a name="ln500"> </a>
<a name="ln501">bool</a>
<a name="ln502">ExpanderWindow::CanQuit()</a>
<a name="ln503">{</a>
<a name="ln504">	if ((fSourcePanel &amp;&amp; fSourcePanel-&gt;IsShowing())</a>
<a name="ln505">		|| (fDestPanel &amp;&amp; fDestPanel-&gt;IsShowing())) {</a>
<a name="ln506">		return false;</a>
<a name="ln507">	}</a>
<a name="ln508"> </a>
<a name="ln509">	if (fExpandingStarted) {</a>
<a name="ln510">		fExpandingThread-&gt;SuspendExternalExpander();</a>
<a name="ln511">		BAlert* alert = new BAlert(&quot;stopAlert&quot;,</a>
<a name="ln512">			B_TRANSLATE(&quot;Are you sure you want to stop expanding this &quot;</a>
<a name="ln513">				&quot;archive? The expanded items may not be complete.&quot;),</a>
<a name="ln514">			B_TRANSLATE(&quot;Stop&quot;), B_TRANSLATE(&quot;Continue&quot;), NULL,</a>
<a name="ln515">			B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln516">			alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln517"> </a>
<a name="ln518">		if (alert-&gt;Go() == 0) {</a>
<a name="ln519">			fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln520">			StopExpanding();</a>
<a name="ln521">		} else {</a>
<a name="ln522">			fExpandingThread-&gt;ResumeExternalExpander();</a>
<a name="ln523">			return false;</a>
<a name="ln524">		}</a>
<a name="ln525">	}</a>
<a name="ln526"> </a>
<a name="ln527">	return true;</a>
<a name="ln528">}</a>
<a name="ln529"> </a>
<a name="ln530"> </a>
<a name="ln531">bool</a>
<a name="ln532">ExpanderWindow::QuitRequested()</a>
<a name="ln533">{</a>
<a name="ln534">	if (!CanQuit())</a>
<a name="ln535">		return false;</a>
<a name="ln536"> </a>
<a name="ln537">	if (fListingStarted)</a>
<a name="ln538">		StopListing();</a>
<a name="ln539"> </a>
<a name="ln540">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln541">	fSettings.ReplacePoint(&quot;window_position&quot;, Frame().LeftTop());</a>
<a name="ln542">	((ExpanderApp*)(be_app))-&gt;UpdateSettingsFrom(&amp;fSettings);</a>
<a name="ln543"> </a>
<a name="ln544">	return true;</a>
<a name="ln545">}</a>
<a name="ln546"> </a>
<a name="ln547"> </a>
<a name="ln548">void</a>
<a name="ln549">ExpanderWindow::RefsReceived(BMessage* message)</a>
<a name="ln550">{</a>
<a name="ln551">	entry_ref ref;</a>
<a name="ln552">	int32 i = 0;</a>
<a name="ln553">	int8 destinationFolder = 0x63;</a>
<a name="ln554">	fSettings.FindInt8(&quot;destination_folder&quot;, &amp;destinationFolder);</a>
<a name="ln555"> </a>
<a name="ln556">	while (message-&gt;FindRef(&quot;refs&quot;, i++, &amp;ref) == B_OK) {</a>
<a name="ln557">		BEntry entry(&amp;ref, true);</a>
<a name="ln558">		BPath path(&amp;entry);</a>
<a name="ln559">		BNode node(&amp;entry);</a>
<a name="ln560"> </a>
<a name="ln561">		if (node.IsFile()) {</a>
<a name="ln562">			fSourceChanged = true;</a>
<a name="ln563">			fSourceRef = ref;</a>
<a name="ln564">			fSourceText-&gt;SetText(path.Path());</a>
<a name="ln565">			if (destinationFolder == 0x63) {</a>
<a name="ln566">				BPath parent;</a>
<a name="ln567">				path.GetParent(&amp;parent);</a>
<a name="ln568">				fDestText-&gt;SetText(parent.Path());</a>
<a name="ln569">				get_ref_for_path(parent.Path(), &amp;fDestRef);</a>
<a name="ln570">			} else if (destinationFolder == 0x65) {</a>
<a name="ln571">				fSettings.FindRef(&quot;destination_folder_use&quot;, &amp;fDestRef);</a>
<a name="ln572">				BEntry dEntry(&amp;fDestRef, true);</a>
<a name="ln573">				BPath dPath(&amp;dEntry);</a>
<a name="ln574">				fDestText-&gt;SetText(dPath.Path());</a>
<a name="ln575">			}</a>
<a name="ln576"> </a>
<a name="ln577">			BEntry dEntry(&amp;fDestRef, true);</a>
<a name="ln578">			if (dEntry.Exists()) {</a>
<a name="ln579">				fExpandButton-&gt;SetEnabled(true);</a>
<a name="ln580">				fExpandItem-&gt;SetEnabled(true);</a>
<a name="ln581">			}</a>
<a name="ln582"> </a>
<a name="ln583">			if (fShowContents-&gt;Value() == B_CONTROL_ON) {</a>
<a name="ln584">				StopListing();</a>
<a name="ln585">				StartListing();</a>
<a name="ln586">			} else {</a>
<a name="ln587">				fShowContents-&gt;SetEnabled(true);</a>
<a name="ln588">				fShowItem-&gt;SetEnabled(true);</a>
<a name="ln589">			}</a>
<a name="ln590"> </a>
<a name="ln591">			bool fromApp;</a>
<a name="ln592">			if (message-&gt;FindBool(&quot;fromApp&quot;, &amp;fromApp) == B_OK) {</a>
<a name="ln593">				AutoExpand();</a>
<a name="ln594">			} else</a>
<a name="ln595">				AutoListing();</a>
<a name="ln596">		} else if (node.IsDirectory()) {</a>
<a name="ln597">			fDestRef = ref;</a>
<a name="ln598">			fDestText-&gt;SetText(path.Path());</a>
<a name="ln599">		}</a>
<a name="ln600">	}</a>
<a name="ln601">}</a>
<a name="ln602"> </a>
<a name="ln603"> </a>
<a name="ln604">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln605">#define B_TRANSLATION_CONTEXT &quot;ExpanderMenu&quot;</a>
<a name="ln606"> </a>
<a name="ln607">void</a>
<a name="ln608">ExpanderWindow::_CreateMenuBar()</a>
<a name="ln609">{</a>
<a name="ln610">	fBar = new BMenuBar(&quot;menu_bar&quot;, B_ITEMS_IN_ROW, B_INVALIDATE_AFTER_LAYOUT);</a>
<a name="ln611">	BMenu* menu = new BMenu(B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln612">	menu-&gt;AddItem(fSourceItem</a>
<a name="ln613">		= new BMenuItem(B_TRANSLATE(&quot;Set source&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln614">			new BMessage(MSG_SOURCE), 'O'));</a>
<a name="ln615">	menu-&gt;AddItem(fDestItem</a>
<a name="ln616">		= new BMenuItem(B_TRANSLATE(&quot;Set destination&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln617">			new BMessage(MSG_DEST), 'D'));</a>
<a name="ln618">	menu-&gt;AddSeparatorItem();</a>
<a name="ln619">	menu-&gt;AddItem(fExpandItem = new BMenuItem(B_TRANSLATE(&quot;Expand&quot;),</a>
<a name="ln620">		new BMessage(MSG_EXPAND), 'E'));</a>
<a name="ln621">	fExpandItem-&gt;SetEnabled(false);</a>
<a name="ln622">	menu-&gt;AddItem(fShowItem = new BMenuItem(B_TRANSLATE(&quot;Show contents&quot;),</a>
<a name="ln623">		new BMessage(MSG_SHOW), 'L'));</a>
<a name="ln624">	fShowItem-&gt;SetEnabled(false);</a>
<a name="ln625">	menu-&gt;AddSeparatorItem();</a>
<a name="ln626">	menu-&gt;AddItem(fStopItem = new BMenuItem(B_TRANSLATE(&quot;Stop&quot;),</a>
<a name="ln627">		new BMessage(MSG_STOP), 'K'));</a>
<a name="ln628">	fStopItem-&gt;SetEnabled(false);</a>
<a name="ln629">	menu-&gt;AddSeparatorItem();</a>
<a name="ln630">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Close&quot;),</a>
<a name="ln631">		new BMessage(B_QUIT_REQUESTED), 'W'));</a>
<a name="ln632">	fBar-&gt;AddItem(menu);</a>
<a name="ln633"> </a>
<a name="ln634">	menu = new BMenu(B_TRANSLATE(&quot;Settings&quot;));</a>
<a name="ln635">	menu-&gt;AddItem(fPreferencesItem</a>
<a name="ln636">		= new BMenuItem(B_TRANSLATE(&quot;Settings&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln637">			new BMessage(MSG_PREFERENCES), 'S'));</a>
<a name="ln638">	fBar-&gt;AddItem(menu);</a>
<a name="ln639">}</a>
<a name="ln640"> </a>
<a name="ln641"> </a>
<a name="ln642">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln643">#define B_TRANSLATION_CONTEXT &quot;ExpanderWindow&quot;</a>
<a name="ln644"> </a>
<a name="ln645">void</a>
<a name="ln646">ExpanderWindow::StartExpanding()</a>
<a name="ln647">{</a>
<a name="ln648">	ExpanderRule* rule = fRules.MatchingRule(&amp;fSourceRef);</a>
<a name="ln649">	if (!rule)</a>
<a name="ln650">		return;</a>
<a name="ln651"> </a>
<a name="ln652">	BEntry destEntry(fDestText-&gt;Text(), true);</a>
<a name="ln653">	if (!destEntry.Exists()) {</a>
<a name="ln654">		BAlert* alert = new BAlert(&quot;destAlert&quot;,</a>
<a name="ln655">		B_TRANSLATE(&quot;The folder was either moved, renamed or not supported.&quot;),</a>
<a name="ln656">		B_TRANSLATE(&quot;Cancel&quot;), NULL, NULL,</a>
<a name="ln657">			B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln658">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln659">		alert-&gt;Go();</a>
<a name="ln660">		return;</a>
<a name="ln661">	}</a>
<a name="ln662"> </a>
<a name="ln663">	BMessage message;</a>
<a name="ln664">	message.AddString(&quot;cmd&quot;, rule-&gt;ExpandCmd());</a>
<a name="ln665">	message.AddRef(&quot;srcRef&quot;, &amp;fSourceRef);</a>
<a name="ln666">	message.AddRef(&quot;destRef&quot;, &amp;fDestRef);</a>
<a name="ln667"> </a>
<a name="ln668">	fExpandButton-&gt;SetLabel(B_TRANSLATE(&quot;Stop&quot;));</a>
<a name="ln669">	fSourceButton-&gt;SetEnabled(false);</a>
<a name="ln670">	fDestButton-&gt;SetEnabled(false);</a>
<a name="ln671">	fShowContents-&gt;SetEnabled(false);</a>
<a name="ln672">	fSourceItem-&gt;SetEnabled(false);</a>
<a name="ln673">	fDestItem-&gt;SetEnabled(false);</a>
<a name="ln674">	fExpandItem-&gt;SetEnabled(false);</a>
<a name="ln675">	fShowItem-&gt;SetEnabled(false);</a>
<a name="ln676">	fStopItem-&gt;SetEnabled(true);</a>
<a name="ln677">	fPreferencesItem-&gt;SetEnabled(false);</a>
<a name="ln678"> </a>
<a name="ln679">	BEntry entry(&amp;fSourceRef);</a>
<a name="ln680">	BPath path(&amp;entry);</a>
<a name="ln681">	BString text(B_TRANSLATE(&quot;Expanding '%s'&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln682">	text.ReplaceFirst(&quot;%s&quot;, path.Leaf());</a>
<a name="ln683">	fStatusView-&gt;SetStatus(text.String());</a>
<a name="ln684"> </a>
<a name="ln685">	fExpandingThread = new ExpanderThread(&amp;message, new BMessenger(this));</a>
<a name="ln686">	fExpandingThread-&gt;Start();</a>
<a name="ln687"> </a>
<a name="ln688">	fExpandingStarted = true;</a>
<a name="ln689">}</a>
<a name="ln690"> </a>
<a name="ln691"> </a>
<a name="ln692">void</a>
<a name="ln693">ExpanderWindow::StopExpanding(void)</a>
<a name="ln694">{</a>
<a name="ln695">	if (fExpandingThread) {</a>
<a name="ln696">		fExpandingThread-&gt;InterruptExternalExpander();</a>
<a name="ln697">		fExpandingThread = NULL;</a>
<a name="ln698">	}</a>
<a name="ln699"> </a>
<a name="ln700">	fExpandingStarted = false;</a>
<a name="ln701"> </a>
<a name="ln702">	fExpandButton-&gt;SetLabel(B_TRANSLATE(&quot;Expand&quot;));</a>
<a name="ln703">	fSourceButton-&gt;SetEnabled(true);</a>
<a name="ln704">	fDestButton-&gt;SetEnabled(true);</a>
<a name="ln705">	fShowContents-&gt;SetEnabled(true);</a>
<a name="ln706">	fSourceItem-&gt;SetEnabled(true);</a>
<a name="ln707">	fDestItem-&gt;SetEnabled(true);</a>
<a name="ln708">	fExpandItem-&gt;SetEnabled(true);</a>
<a name="ln709">	fShowItem-&gt;SetEnabled(true);</a>
<a name="ln710">	fStopItem-&gt;SetEnabled(false);</a>
<a name="ln711">	fPreferencesItem-&gt;SetEnabled(true);</a>
<a name="ln712">}</a>
<a name="ln713"> </a>
<a name="ln714"> </a>
<a name="ln715">void</a>
<a name="ln716">ExpanderWindow::_ExpandListingText()</a>
<a name="ln717">{</a>
<a name="ln718">	float delta = fLongestLine - fListingText-&gt;Frame().Width();</a>
<a name="ln719"> </a>
<a name="ln720">	if (delta &gt; 0) {</a>
<a name="ln721">		BScreen screen;</a>
<a name="ln722">		BRect screenFrame = screen.Frame();</a>
<a name="ln723"> </a>
<a name="ln724">		if (Frame().right + delta &gt; screenFrame.right)</a>
<a name="ln725">			delta = screenFrame.right - Frame().right - 4.0f;</a>
<a name="ln726"> </a>
<a name="ln727">		ResizeBy(delta, 0.0f);</a>
<a name="ln728">	}</a>
<a name="ln729"> </a>
<a name="ln730">	float minWidth, maxWidth, minHeight, maxHeight;</a>
<a name="ln731">	GetSizeLimits(&amp;minWidth, &amp;maxWidth, &amp;minHeight, &amp;maxHeight);</a>
<a name="ln732"> </a>
<a name="ln733">	if (minWidth &lt; Frame().Width() + delta) {</a>
<a name="ln734">		// set the Zoom limit as the minimal required size</a>
<a name="ln735">		SetZoomLimits(Frame().Width() + delta,</a>
<a name="ln736">			std::min(fSizeLimit + fListingText-&gt;TextRect().Height()</a>
<a name="ln737">				+ fLineHeight + B_H_SCROLL_BAR_HEIGHT + 1.0f,</a>
<a name="ln738">				maxHeight));</a>
<a name="ln739">	} else {</a>
<a name="ln740">		// set the zoom limit based on minimal window size allowed</a>
<a name="ln741">		SetZoomLimits(minWidth,</a>
<a name="ln742">			std::min(fSizeLimit + fListingText-&gt;TextRect().Height()</a>
<a name="ln743">				+ fLineHeight + B_H_SCROLL_BAR_HEIGHT + 1.0f,</a>
<a name="ln744">				maxHeight));</a>
<a name="ln745">	}</a>
<a name="ln746">}</a>
<a name="ln747"> </a>
<a name="ln748"> </a>
<a name="ln749">void</a>
<a name="ln750">ExpanderWindow::_UpdateWindowSize(bool showContents)</a>
<a name="ln751">{</a>
<a name="ln752">	float minWidth, maxWidth, minHeight, maxHeight;</a>
<a name="ln753">	GetSizeLimits(&amp;minWidth, &amp;maxWidth, &amp;minHeight, &amp;maxHeight);</a>
<a name="ln754"> </a>
<a name="ln755">	float bottom = fSizeLimit;</a>
<a name="ln756"> </a>
<a name="ln757">	if (showContents) {</a>
<a name="ln758">		if (fPreviousHeight &lt; 0.0) {</a>
<a name="ln759">			BFont font;</a>
<a name="ln760">			font_height fontHeight;</a>
<a name="ln761">			fListingText-&gt;GetFont(&amp;font);</a>
<a name="ln762">			font.GetHeight(&amp;fontHeight);</a>
<a name="ln763">			fLineHeight = ceilf(fontHeight.ascent + fontHeight.descent</a>
<a name="ln764">				+ fontHeight.leading);</a>
<a name="ln765">			fPreviousHeight = bottom + 10.0 * fLineHeight;</a>
<a name="ln766">		}</a>
<a name="ln767">		minHeight = bottom + 5.0 * fLineHeight;</a>
<a name="ln768">		maxHeight = 32767.0;</a>
<a name="ln769"> </a>
<a name="ln770">		bottom = std::max(fPreviousHeight, minHeight);</a>
<a name="ln771">	} else {</a>
<a name="ln772">		minHeight = fSizeLimit;</a>
<a name="ln773">		maxHeight = fSizeLimit;</a>
<a name="ln774">		fPreviousHeight = Frame().Height();</a>
<a name="ln775">	}</a>
<a name="ln776"> </a>
<a name="ln777">	SetSizeLimits(minWidth, maxWidth, minHeight, maxHeight);</a>
<a name="ln778">	ResizeTo(Frame().Width(), bottom);</a>
<a name="ln779">}</a>
<a name="ln780"> </a>
<a name="ln781"> </a>
<a name="ln782">void</a>
<a name="ln783">ExpanderWindow::StartListing()</a>
<a name="ln784">{</a>
<a name="ln785">	_UpdateWindowSize(true);</a>
<a name="ln786"> </a>
<a name="ln787">	if (!fSourceChanged)</a>
<a name="ln788">		return;</a>
<a name="ln789"> </a>
<a name="ln790">	fPreviousHeight = -1.0;</a>
<a name="ln791"> </a>
<a name="ln792">	fLongestLine = 0.0f;</a>
<a name="ln793"> </a>
<a name="ln794">	ExpanderRule* rule = fRules.MatchingRule(&amp;fSourceRef);</a>
<a name="ln795">	if (!rule)</a>
<a name="ln796">		return;</a>
<a name="ln797"> </a>
<a name="ln798">	BMessage message;</a>
<a name="ln799">	message.AddString(&quot;cmd&quot;, rule-&gt;ListingCmd());</a>
<a name="ln800">	message.AddRef(&quot;srcRef&quot;, &amp;fSourceRef);</a>
<a name="ln801"> </a>
<a name="ln802">	fShowContents-&gt;SetEnabled(true);</a>
<a name="ln803">	fSourceItem-&gt;SetEnabled(false);</a>
<a name="ln804">	fDestItem-&gt;SetEnabled(false);</a>
<a name="ln805">	fExpandItem-&gt;SetEnabled(false);</a>
<a name="ln806">	fShowItem-&gt;SetEnabled(true);</a>
<a name="ln807">	fShowItem-&gt;SetLabel(B_TRANSLATE(&quot;Hide contents&quot;));</a>
<a name="ln808">	fStopItem-&gt;SetEnabled(false);</a>
<a name="ln809">	fPreferencesItem-&gt;SetEnabled(false);</a>
<a name="ln810"> </a>
<a name="ln811">	fSourceButton-&gt;SetEnabled(false);</a>
<a name="ln812">	fDestButton-&gt;SetEnabled(false);</a>
<a name="ln813">	fExpandButton-&gt;SetEnabled(false);</a>
<a name="ln814"> </a>
<a name="ln815">	BEntry entry(&amp;fSourceRef);</a>
<a name="ln816">	BPath path(&amp;entry);</a>
<a name="ln817">	BString text(B_TRANSLATE(&quot;Creating listing for '%s'&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln818">	text.ReplaceFirst(&quot;%s&quot;, path.Leaf());</a>
<a name="ln819">	fStatusView-&gt;SetStatus(text.String());</a>
<a name="ln820">	fListingText-&gt;SetText(&quot;&quot;);</a>
<a name="ln821"> </a>
<a name="ln822">	fListingThread = new ExpanderThread(&amp;message, new BMessenger(this));</a>
<a name="ln823">	fListingThread-&gt;Start();</a>
<a name="ln824"> </a>
<a name="ln825">	fListingStarted = true;</a>
<a name="ln826">}</a>
<a name="ln827"> </a>
<a name="ln828"> </a>
<a name="ln829">void</a>
<a name="ln830">ExpanderWindow::StopListing(void)</a>
<a name="ln831">{</a>
<a name="ln832">	if (fListingThread) {</a>
<a name="ln833">		fListingThread-&gt;InterruptExternalExpander();</a>
<a name="ln834">		fListingThread = NULL;</a>
<a name="ln835">	}</a>
<a name="ln836"> </a>
<a name="ln837">	fListingStarted = false;</a>
<a name="ln838"> </a>
<a name="ln839">	fShowContents-&gt;SetEnabled(true);</a>
<a name="ln840">	fSourceItem-&gt;SetEnabled(true);</a>
<a name="ln841">	fDestItem-&gt;SetEnabled(true);</a>
<a name="ln842">	fExpandItem-&gt;SetEnabled(true);</a>
<a name="ln843">	fShowItem-&gt;SetEnabled(true);</a>
<a name="ln844">	fStopItem-&gt;SetEnabled(false);</a>
<a name="ln845">	fPreferencesItem-&gt;SetEnabled(true);</a>
<a name="ln846"> </a>
<a name="ln847">	fSourceButton-&gt;SetEnabled(true);</a>
<a name="ln848">	fDestButton-&gt;SetEnabled(true);</a>
<a name="ln849">	fExpandButton-&gt;SetEnabled(true);</a>
<a name="ln850">	fStatusView-&gt;SetStatus(&quot;&quot;);</a>
<a name="ln851">}</a>
<a name="ln852"> </a>
<a name="ln853"> </a>
<a name="ln854">void</a>
<a name="ln855">ExpanderWindow::CloseWindowOrKeepOpen()</a>
<a name="ln856">{</a>
<a name="ln857">	bool expandFiles = false;</a>
<a name="ln858">	fSettings.FindBool(&quot;automatically_expand_files&quot;, &amp;expandFiles);</a>
<a name="ln859"> </a>
<a name="ln860">	bool closeWhenDone = false;</a>
<a name="ln861">	fSettings.FindBool(&quot;close_when_done&quot;, &amp;closeWhenDone);</a>
<a name="ln862"> </a>
<a name="ln863">	if (expandFiles || closeWhenDone)</a>
<a name="ln864">		PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln865">}</a>
<a name="ln866"> </a>
<a name="ln867"> </a>
<a name="ln868">void</a>
<a name="ln869">ExpanderWindow::OpenDestFolder()</a>
<a name="ln870">{</a>
<a name="ln871">	bool openFolder = true;</a>
<a name="ln872">	fSettings.FindBool(&quot;open_destination_folder&quot;, &amp;openFolder);</a>
<a name="ln873"> </a>
<a name="ln874">	if (!openFolder)</a>
<a name="ln875">		return;</a>
<a name="ln876"> </a>
<a name="ln877">	BMessage* message = new BMessage(B_REFS_RECEIVED);</a>
<a name="ln878">	message-&gt;AddRef(&quot;refs&quot;, &amp;fDestRef);</a>
<a name="ln879">	BPath path(&amp;fDestRef);</a>
<a name="ln880">	BMessenger tracker(&quot;application/x-vnd.Be-TRAK&quot;);</a>
<a name="ln881">	tracker.SendMessage(message);</a>
<a name="ln882">}</a>
<a name="ln883"> </a>
<a name="ln884"> </a>
<a name="ln885">void</a>
<a name="ln886">ExpanderWindow::AutoListing()</a>
<a name="ln887">{</a>
<a name="ln888">	bool showContents = false;</a>
<a name="ln889">	fSettings.FindBool(&quot;show_contents_listing&quot;, &amp;showContents);</a>
<a name="ln890"> </a>
<a name="ln891">	if (!showContents)</a>
<a name="ln892">		return;</a>
<a name="ln893"> </a>
<a name="ln894">	fShowContents-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln895">	fShowContents-&gt;Invoke();</a>
<a name="ln896">}</a>
<a name="ln897"> </a>
<a name="ln898"> </a>
<a name="ln899">void</a>
<a name="ln900">ExpanderWindow::AutoExpand()</a>
<a name="ln901">{</a>
<a name="ln902">	bool expandFiles = false;</a>
<a name="ln903">	fSettings.FindBool(&quot;automatically_expand_files&quot;, &amp;expandFiles);</a>
<a name="ln904"> </a>
<a name="ln905">	if (!expandFiles) {</a>
<a name="ln906">		AutoListing();</a>
<a name="ln907">		return;</a>
<a name="ln908">	}</a>
<a name="ln909"> </a>
<a name="ln910">	fExpandButton-&gt;Invoke();</a>
<a name="ln911">}</a>

</code></pre>
<div class="balloon" rel="325"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="437"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="239"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="455"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="465"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="229"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="213"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="660"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="523"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="204"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
