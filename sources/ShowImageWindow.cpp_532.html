
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ShowImageWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2003-2014, Haiku, Inc. All Rights Reserved.</a>
<a name="ln3"> * Copyright 2004-2005 yellowTAB GmbH. All Rights Reserverd.</a>
<a name="ln4"> * Copyright 2006 Bernd Korz. All Rights Reserved</a>
<a name="ln5"> * Distributed under the terms of the MIT License.</a>
<a name="ln6"> *</a>
<a name="ln7"> * Authors:</a>
<a name="ln8"> *		Fernando Francisco de Oliveira</a>
<a name="ln9"> *		Michael Wilber</a>
<a name="ln10"> *		Michael Pfeiffer</a>
<a name="ln11"> *		yellowTAB GmbH</a>
<a name="ln12"> *		Bernd Korz</a>
<a name="ln13"> *		Axel Dörfler, axeld@pinc-software.de</a>
<a name="ln14"> *		Stephan Aßmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln15"> */</a>
<a name="ln16"> </a>
<a name="ln17"> </a>
<a name="ln18">#include &quot;ShowImageWindow.h&quot;</a>
<a name="ln19"> </a>
<a name="ln20">#include &lt;new&gt;</a>
<a name="ln21">#include &lt;stdio.h&gt;</a>
<a name="ln22">#include &lt;stdlib.h&gt;</a>
<a name="ln23"> </a>
<a name="ln24">#include &lt;Alert.h&gt;</a>
<a name="ln25">#include &lt;Application.h&gt;</a>
<a name="ln26">#include &lt;Bitmap.h&gt;</a>
<a name="ln27">#include &lt;BitmapStream.h&gt;</a>
<a name="ln28">#include &lt;Button.h&gt;</a>
<a name="ln29">#include &lt;Catalog.h&gt;</a>
<a name="ln30">#include &lt;Clipboard.h&gt;</a>
<a name="ln31">#include &lt;ControlLook.h&gt;</a>
<a name="ln32">#include &lt;DurationFormat.h&gt;</a>
<a name="ln33">#include &lt;Entry.h&gt;</a>
<a name="ln34">#include &lt;File.h&gt;</a>
<a name="ln35">#include &lt;FilePanel.h&gt;</a>
<a name="ln36">#include &lt;Locale.h&gt;</a>
<a name="ln37">#include &lt;Menu.h&gt;</a>
<a name="ln38">#include &lt;MenuBar.h&gt;</a>
<a name="ln39">#include &lt;MenuItem.h&gt;</a>
<a name="ln40">#include &lt;MessageRunner.h&gt;</a>
<a name="ln41">#include &lt;Path.h&gt;</a>
<a name="ln42">#include &lt;PrintJob.h&gt;</a>
<a name="ln43">#include &lt;RecentItems.h&gt;</a>
<a name="ln44">#include &lt;Roster.h&gt;</a>
<a name="ln45">#include &lt;Screen.h&gt;</a>
<a name="ln46">#include &lt;ScrollView.h&gt;</a>
<a name="ln47">#include &lt;String.h&gt;</a>
<a name="ln48">#include &lt;SupportDefs.h&gt;</a>
<a name="ln49">#include &lt;TranslationDefs.h&gt;</a>
<a name="ln50">#include &lt;TranslationUtils.h&gt;</a>
<a name="ln51">#include &lt;TranslatorRoster.h&gt;</a>
<a name="ln52"> </a>
<a name="ln53">#include &quot;ImageCache.h&quot;</a>
<a name="ln54">#include &quot;ProgressWindow.h&quot;</a>
<a name="ln55">#include &quot;ShowImageApp.h&quot;</a>
<a name="ln56">#include &quot;ShowImageConstants.h&quot;</a>
<a name="ln57">#include &quot;ShowImageStatusView.h&quot;</a>
<a name="ln58">#include &quot;ShowImageView.h&quot;</a>
<a name="ln59">#include &quot;ToolBarIcons.h&quot;</a>
<a name="ln60"> </a>
<a name="ln61"> </a>
<a name="ln62">// BMessage field names used in Save messages</a>
<a name="ln63">const char* kTypeField = &quot;be:type&quot;;</a>
<a name="ln64">const char* kTranslatorField = &quot;be:translator&quot;;</a>
<a name="ln65"> </a>
<a name="ln66">const bigtime_t kDefaultSlideShowDelay = 3000000;</a>
<a name="ln67">	// 3 seconds</a>
<a name="ln68"> </a>
<a name="ln69"> </a>
<a name="ln70">// message constants</a>
<a name="ln71">enum {</a>
<a name="ln72">	MSG_CAPTURE_MOUSE			= 'mCPM',</a>
<a name="ln73">	MSG_CHANGE_FOCUS			= 'mCFS',</a>
<a name="ln74">	MSG_WINDOW_QUIT				= 'mWQT',</a>
<a name="ln75">	MSG_OUTPUT_TYPE				= 'BTMN',</a>
<a name="ln76">	MSG_SAVE_PANEL				= 'mFSP',</a>
<a name="ln77">	MSG_CLEAR_SELECT			= 'mCSL',</a>
<a name="ln78">	MSG_SELECT_ALL				= 'mSAL',</a>
<a name="ln79">	MSG_SELECTION_MODE			= 'mSLM',</a>
<a name="ln80">	MSG_PAGE_FIRST				= 'mPGF',</a>
<a name="ln81">	MSG_PAGE_LAST				= 'mPGL',</a>
<a name="ln82">	MSG_PAGE_NEXT				= 'mPGN',</a>
<a name="ln83">	MSG_PAGE_PREV				= 'mPGP',</a>
<a name="ln84">	MSG_GOTO_PAGE				= 'mGTP',</a>
<a name="ln85">	MSG_ZOOM_IN					= 'mZIN',</a>
<a name="ln86">	MSG_ZOOM_OUT				= 'mZOU',</a>
<a name="ln87">	MSG_SCALE_BILINEAR			= 'mSBL',</a>
<a name="ln88">	MSG_DESKTOP_BACKGROUND		= 'mDBG',</a>
<a name="ln89">	MSG_ROTATE_90				= 'mR90',</a>
<a name="ln90">	MSG_ROTATE_270				= 'mR27',</a>
<a name="ln91">	MSG_FLIP_LEFT_TO_RIGHT		= 'mFLR',</a>
<a name="ln92">	MSG_FLIP_TOP_TO_BOTTOM		= 'mFTB',</a>
<a name="ln93">	MSG_SLIDE_SHOW_DELAY		= 'mSSD',</a>
<a name="ln94">	MSG_SHOW_CAPTION			= 'mSCP',</a>
<a name="ln95">	MSG_PAGE_SETUP				= 'mPSU',</a>
<a name="ln96">	MSG_PREPARE_PRINT			= 'mPPT',</a>
<a name="ln97">	MSG_GET_INFO				= 'mGFI',</a>
<a name="ln98">	MSG_SET_RATING				= 'mSRT',</a>
<a name="ln99">	kMsgFitToWindow				= 'mFtW',</a>
<a name="ln100">	kMsgOriginalSize			= 'mOSZ',</a>
<a name="ln101">	kMsgStretchToWindow			= 'mStW',</a>
<a name="ln102">	kMsgNextSlide				= 'mNxS',</a>
<a name="ln103">	kMsgToggleToolBar			= 'mTTB',</a>
<a name="ln104">	kMsgSlideToolBar			= 'mSTB',</a>
<a name="ln105">	kMsgFinishSlidingToolBar	= 'mFST'</a>
<a name="ln106">};</a>
<a name="ln107"> </a>
<a name="ln108"> </a>
<a name="ln109">// This is temporary solution for building BString with printf like format.</a>
<a name="ln110">// will be removed in the future.</a>
<a name="ln111">static void</a>
<a name="ln112">bs_printf(BString* string, const char* format, ...)</a>
<a name="ln113">{</a>
<a name="ln114">	va_list ap;</a>
<a name="ln115">	char* buf;</a>
<a name="ln116"> </a>
<a name="ln117">	va_start(ap, format);</a>
<a name="ln118">	vasprintf(&amp;buf, format, ap);</a>
<a name="ln119">	string-&gt;SetTo(buf);</a>
<a name="ln120">	free(buf);</a>
<a name="ln121">	va_end(ap);</a>
<a name="ln122">}</a>
<a name="ln123"> </a>
<a name="ln124"> </a>
<a name="ln125">//	#pragma mark -- ShowImageWindow</a>
<a name="ln126"> </a>
<a name="ln127"> </a>
<a name="ln128">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln129">#define B_TRANSLATION_CONTEXT &quot;Menus&quot;</a>
<a name="ln130"> </a>
<a name="ln131"> </a>
<a name="ln132">ShowImageWindow::ShowImageWindow(BRect frame, const entry_ref&amp; ref,</a>
<a name="ln133">	const BMessenger&amp; trackerMessenger)</a>
<a name="ln134">	:</a>
<a name="ln135">	BWindow(frame, &quot;&quot;, B_DOCUMENT_WINDOW, B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln136">	fNavigator(ref, trackerMessenger),</a>
<a name="ln137">	fSavePanel(NULL),</a>
<a name="ln138">	fBar(NULL),</a>
<a name="ln139">	fBrowseMenu(NULL),</a>
<a name="ln140">	fGoToPageMenu(NULL),</a>
<a name="ln141">	fSlideShowDelayMenu(NULL),</a>
<a name="ln142">	fToolBar(NULL),</a>
<a name="ln143">	fImageView(NULL),</a>
<a name="ln144">	fStatusView(NULL),</a>
<a name="ln145">	fProgressWindow(new ProgressWindow()),</a>
<a name="ln146">	fModified(false),</a>
<a name="ln147">	fFullScreen(false),</a>
<a name="ln148">	fShowCaption(true),</a>
<a name="ln149">	fShowToolBar(true),</a>
<a name="ln150">	fPrintSettings(NULL),</a>
<a name="ln151">	fSlideShowRunner(NULL),</a>
<a name="ln152">	fSlideShowDelay(kDefaultSlideShowDelay)</a>
<a name="ln153">{</a>
<a name="ln154">	_ApplySettings();</a>
<a name="ln155"> </a>
<a name="ln156">	SetLayout(new BGroupLayout(B_VERTICAL, 0));</a>
<a name="ln157"> </a>
<a name="ln158">	// create menu bar</a>
<a name="ln159">	fBar = new BMenuBar(&quot;menu_bar&quot;);</a>
<a name="ln160">	_AddMenus(fBar);</a>
<a name="ln161">	float menuBarMinWidth = fBar-&gt;MinSize().width;</a>
<a name="ln162">	AddChild(fBar);</a>
<a name="ln163"> </a>
<a name="ln164">	// Add a content view so the tool bar can be moved outside of the</a>
<a name="ln165">	// visible portion without colliding with the menu bar.</a>
<a name="ln166"> </a>
<a name="ln167">	BView* contentView = new BView(BRect(), &quot;content&quot;, B_FOLLOW_NONE, 0);</a>
<a name="ln168">	contentView-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln169">	contentView-&gt;SetExplicitMinSize(BSize(250, 100));</a>
<a name="ln170">	AddChild(contentView);</a>
<a name="ln171"> </a>
<a name="ln172">	// Create the tool bar</a>
<a name="ln173">	BRect viewFrame = contentView-&gt;Bounds();</a>
<a name="ln174">	viewFrame.right -= B_V_SCROLL_BAR_WIDTH;</a>
<a name="ln175">	fToolBar = new BToolBar(viewFrame);</a>
<a name="ln176"> </a>
<a name="ln177">	// Add the tool icons.</a>
<a name="ln178"> </a>
<a name="ln179">//	fToolBar-&gt;AddAction(MSG_FILE_OPEN, be_app,</a>
<a name="ln180">//		tool_bar_icon(kIconDocumentOpen), B_TRANSLATE(&quot;Open&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln181">	fToolBar-&gt;AddAction(MSG_FILE_PREV, this,</a>
<a name="ln182">		tool_bar_icon(kIconGoPrevious), B_TRANSLATE(&quot;Previous file&quot;));</a>
<a name="ln183">	fToolBar-&gt;AddAction(MSG_FILE_NEXT, this, tool_bar_icon(kIconGoNext),</a>
<a name="ln184">		B_TRANSLATE(&quot;Next file&quot;));</a>
<a name="ln185">	BMessage* fullScreenSlideShow = new BMessage(MSG_SLIDE_SHOW);</a>
<a name="ln186">	fullScreenSlideShow-&gt;AddBool(&quot;full screen&quot;, true);</a>
<a name="ln187">	fToolBar-&gt;AddAction(fullScreenSlideShow, this,</a>
<a name="ln188">		tool_bar_icon(kIconMediaMovieLibrary), B_TRANSLATE(&quot;Slide show&quot;));</a>
<a name="ln189">	fToolBar-&gt;AddSeparator();</a>
<a name="ln190">	fToolBar-&gt;AddAction(MSG_SELECTION_MODE, this,</a>
<a name="ln191">		tool_bar_icon(kIconDrawRectangularSelection),</a>
<a name="ln192">		B_TRANSLATE(&quot;Selection mode&quot;));</a>
<a name="ln193">	fToolBar-&gt;AddSeparator();</a>
<a name="ln194">	fToolBar-&gt;AddAction(kMsgOriginalSize, this,</a>
<a name="ln195">		tool_bar_icon(kIconZoomOriginal), B_TRANSLATE(&quot;Original size&quot;), NULL,</a>
<a name="ln196">		true);</a>
<a name="ln197">	fToolBar-&gt;AddAction(kMsgFitToWindow, this,</a>
<a name="ln198">		tool_bar_icon(kIconZoomFitBest), B_TRANSLATE(&quot;Fit to window&quot;));</a>
<a name="ln199">	fToolBar-&gt;AddAction(MSG_ZOOM_IN, this, tool_bar_icon(kIconZoomIn),</a>
<a name="ln200">		B_TRANSLATE(&quot;Zoom in&quot;));</a>
<a name="ln201">	fToolBar-&gt;AddAction(MSG_ZOOM_OUT, this, tool_bar_icon(kIconZoomOut),</a>
<a name="ln202">		B_TRANSLATE(&quot;Zoom out&quot;));</a>
<a name="ln203">	fToolBar-&gt;AddSeparator();</a>
<a name="ln204">	fToolBar-&gt;AddAction(MSG_PAGE_PREV, this, tool_bar_icon(kIconPagePrevious),</a>
<a name="ln205">		B_TRANSLATE(&quot;Previous page&quot;));</a>
<a name="ln206">	fToolBar-&gt;AddAction(MSG_PAGE_NEXT, this, tool_bar_icon(kIconPageNext),</a>
<a name="ln207">		B_TRANSLATE(&quot;Next page&quot;));</a>
<a name="ln208">	fToolBar-&gt;AddGlue();</a>
<a name="ln209">	fToolBar-&gt;AddAction(MSG_FULL_SCREEN, this,</a>
<a name="ln210">		tool_bar_icon(kIconViewWindowed), B_TRANSLATE(&quot;Leave full screen&quot;));</a>
<a name="ln211">	fToolBar-&gt;SetActionVisible(MSG_FULL_SCREEN, false);</a>
<a name="ln212"> </a>
<a name="ln213">	fToolBar-&gt;ResizeTo(viewFrame.Width(), fToolBar-&gt;MinSize().height);</a>
<a name="ln214"> </a>
<a name="ln215">	contentView-&gt;AddChild(fToolBar);</a>
<a name="ln216"> </a>
<a name="ln217">	if (fShowToolBar)</a>
<a name="ln218">		viewFrame.top = fToolBar-&gt;Frame().bottom + 1;</a>
<a name="ln219">	else</a>
<a name="ln220">		fToolBar-&gt;Hide();</a>
<a name="ln221"> </a>
<a name="ln222">	fToolBarVisible = fShowToolBar;</a>
<a name="ln223"> </a>
<a name="ln224">	viewFrame.bottom = contentView-&gt;Bounds().bottom;</a>
<a name="ln225">	viewFrame.bottom -= B_H_SCROLL_BAR_HEIGHT;</a>
<a name="ln226"> </a>
<a name="ln227">	// create the image view</a>
<a name="ln228">	fImageView = new ShowImageView(viewFrame, &quot;image_view&quot;, B_FOLLOW_ALL,</a>
<a name="ln229">		B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE | B_PULSE_NEEDED</a>
<a name="ln230">			| B_FRAME_EVENTS);</a>
<a name="ln231">	// wrap a scroll view around the view</a>
<a name="ln232">	fScrollView = new BScrollView(&quot;image_scroller&quot;, fImageView,</a>
<a name="ln233">		B_FOLLOW_ALL, 0, true, true, B_PLAIN_BORDER);</a>
<a name="ln234">	contentView-&gt;AddChild(fScrollView);</a>
<a name="ln235"> </a>
<a name="ln236">	fStatusView = new ShowImageStatusView(fScrollView);</a>
<a name="ln237">	fScrollView-&gt;AddChild(fStatusView);</a>
<a name="ln238"> </a>
<a name="ln239">	// Update minimum window size</a>
<a name="ln240">	float toolBarMinWidth = fToolBar-&gt;MinSize().width;</a>
<a name="ln241">	SetSizeLimits(std::max(menuBarMinWidth, toolBarMinWidth), 100000, 100,</a>
<a name="ln242">		100000);</a>
<a name="ln243"> </a>
<a name="ln244">	// finish creating the window</a>
<a name="ln245">	if (_LoadImage() != B_OK) {</a>
<a name="ln246">		_LoadError(ref);</a>
<a name="ln247">		Quit();</a>
<a name="ln248">		return;</a>
<a name="ln249">	}</a>
<a name="ln250"> </a>
<a name="ln251">	// add View menu here so it can access ShowImageView methods</a>
<a name="ln252">	BMenu* menu = new BMenu(B_TRANSLATE_CONTEXT(&quot;View&quot;, &quot;Menus&quot;));</a>
<a name="ln253">	_BuildViewMenu(menu, false);</a>
<a name="ln254">	fBar-&gt;AddItem(menu);</a>
<a name="ln255"> </a>
<a name="ln256">	fBar-&gt;AddItem(_BuildRatingMenu());</a>
<a name="ln257"> </a>
<a name="ln258">	SetPulseRate(100000);</a>
<a name="ln259">		// every 1/10 second; ShowImageView needs it for marching ants</a>
<a name="ln260"> </a>
<a name="ln261">	_MarkMenuItem(menu, MSG_SELECTION_MODE,</a>
<a name="ln262">		fImageView-&gt;IsSelectionModeEnabled());</a>
<a name="ln263"> </a>
<a name="ln264">	// Tell application object to query the clipboard</a>
<a name="ln265">	// and tell this window if it contains interesting data or not</a>
<a name="ln266">	be_app_messenger.SendMessage(B_CLIPBOARD_CHANGED);</a>
<a name="ln267"> </a>
<a name="ln268">	// The window will be shown on screen automatically</a>
<a name="ln269">	Run();</a>
<a name="ln270">}</a>
<a name="ln271"> </a>
<a name="ln272"> </a>
<a name="ln273">ShowImageWindow::~ShowImageWindow()</a>
<a name="ln274">{</a>
<a name="ln275">	fProgressWindow-&gt;Lock();</a>
<a name="ln276">	fProgressWindow-&gt;Quit();</a>
<a name="ln277"> </a>
<a name="ln278">	_StopSlideShow();</a>
<a name="ln279">}</a>
<a name="ln280"> </a>
<a name="ln281"> </a>
<a name="ln282">void</a>
<a name="ln283">ShowImageWindow::BuildContextMenu(BMenu* menu)</a>
<a name="ln284">{</a>
<a name="ln285">	_BuildViewMenu(menu, true);</a>
<a name="ln286">}</a>
<a name="ln287"> </a>
<a name="ln288"> </a>
<a name="ln289">void</a>
<a name="ln290">ShowImageWindow::_BuildViewMenu(BMenu* menu, bool popupMenu)</a>
<a name="ln291">{</a>
<a name="ln292">	_AddItemMenu(menu, B_TRANSLATE(&quot;Slide show&quot;), MSG_SLIDE_SHOW, 0, 0, this);</a>
<a name="ln293">	_MarkMenuItem(menu, MSG_SLIDE_SHOW, fSlideShowRunner != NULL);</a>
<a name="ln294">	BMenu* delayMenu = new BMenu(B_TRANSLATE(&quot;Slide delay&quot;));</a>
<a name="ln295">	if (fSlideShowDelayMenu == NULL)</a>
<a name="ln296">		fSlideShowDelayMenu = delayMenu;</a>
<a name="ln297"> </a>
<a name="ln298">	delayMenu-&gt;SetRadioMode(true);</a>
<a name="ln299"> </a>
<a name="ln300">	int32 kDelays[] = {2, 3, 4, 5, 6, 7, 8, 9, 10, 20};</a>
<a name="ln301">	for (uint32 i = 0; i &lt; sizeof(kDelays) / sizeof(kDelays[0]); i++) {</a>
<a name="ln302">		BString text;</a>
<a name="ln303">		BDurationFormat format;</a>
<a name="ln304">		text.Truncate(0);</a>
<a name="ln305">		format.Format(text, 0, kDelays[i] * 1000000LL);</a>
<a name="ln306"> </a>
<a name="ln307">		_AddDelayItem(delayMenu, text.String(), kDelays[i] * 1000000LL);</a>
<a name="ln308">	}</a>
<a name="ln309">	menu-&gt;AddItem(delayMenu);</a>
<a name="ln310"> </a>
<a name="ln311">	menu-&gt;AddSeparatorItem();</a>
<a name="ln312"> </a>
<a name="ln313">	_AddItemMenu(menu, B_TRANSLATE(&quot;Original size&quot;),</a>
<a name="ln314">		kMsgOriginalSize, '1', 0, this);</a>
<a name="ln315">	_AddItemMenu(menu, B_TRANSLATE(&quot;Fit to window&quot;),</a>
<a name="ln316">		kMsgFitToWindow, '0', 0, this);</a>
<a name="ln317">	_AddItemMenu(menu, B_TRANSLATE(&quot;Zoom in&quot;), MSG_ZOOM_IN, '+', 0, this);</a>
<a name="ln318">	_AddItemMenu(menu, B_TRANSLATE(&quot;Zoom out&quot;), MSG_ZOOM_OUT, '-', 0, this);</a>
<a name="ln319"> </a>
<a name="ln320">	menu-&gt;AddSeparatorItem();</a>
<a name="ln321"> </a>
<a name="ln322">	if (!popupMenu || fFullScreen) {</a>
<a name="ln323">		_AddItemMenu(menu, B_TRANSLATE(&quot;High-quality zooming&quot;),</a>
<a name="ln324">			MSG_SCALE_BILINEAR, 0, 0, this);</a>
<a name="ln325">		_AddItemMenu(menu, B_TRANSLATE(&quot;Stretch to window&quot;),</a>
<a name="ln326">			kMsgStretchToWindow, 0, 0, this);</a>
<a name="ln327"> </a>
<a name="ln328">		menu-&gt;AddSeparatorItem();</a>
<a name="ln329">	}</a>
<a name="ln330"> </a>
<a name="ln331">	_AddItemMenu(menu, B_TRANSLATE(&quot;Full screen&quot;),</a>
<a name="ln332">		MSG_FULL_SCREEN, B_ENTER, 0, this);</a>
<a name="ln333">	_MarkMenuItem(menu, MSG_FULL_SCREEN, fFullScreen);</a>
<a name="ln334"> </a>
<a name="ln335">	_AddItemMenu(menu, B_TRANSLATE(&quot;Show caption in full screen mode&quot;),</a>
<a name="ln336">		MSG_SHOW_CAPTION, 0, 0, this);</a>
<a name="ln337">	_MarkMenuItem(menu, MSG_SHOW_CAPTION, fShowCaption);</a>
<a name="ln338"> </a>
<a name="ln339">	_MarkMenuItem(menu, MSG_SCALE_BILINEAR, fImageView-&gt;ScaleBilinear());</a>
<a name="ln340">	_MarkMenuItem(menu, kMsgStretchToWindow, fImageView-&gt;StretchesToBounds());</a>
<a name="ln341"> </a>
<a name="ln342">	if (!popupMenu) {</a>
<a name="ln343">		_AddItemMenu(menu, B_TRANSLATE(&quot;Show tool bar&quot;), kMsgToggleToolBar,</a>
<a name="ln344">			'B', 0, this);</a>
<a name="ln345">		_MarkMenuItem(menu, kMsgToggleToolBar,</a>
<a name="ln346">			!fToolBar-&gt;IsHidden(fToolBar));</a>
<a name="ln347">	}</a>
<a name="ln348"> </a>
<a name="ln349">	if (popupMenu) {</a>
<a name="ln350">		menu-&gt;AddSeparatorItem();</a>
<a name="ln351">		_AddItemMenu(menu, B_TRANSLATE(&quot;Use as background&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln352">			MSG_DESKTOP_BACKGROUND, 0, 0, this);</a>
<a name="ln353">	}</a>
<a name="ln354">}</a>
<a name="ln355"> </a>
<a name="ln356"> </a>
<a name="ln357">BMenu*</a>
<a name="ln358">ShowImageWindow::_BuildRatingMenu()</a>
<a name="ln359">{</a>
<a name="ln360">	fRatingMenu = new BMenu(B_TRANSLATE(&quot;Rating&quot;));</a>
<a name="ln361">	for (int32 i = 1; i &lt;= 10; i++) {</a>
<a name="ln362">		BString label;</a>
<a name="ln363">		label &lt;&lt; i;</a>
<a name="ln364">		BMessage* message = new BMessage(MSG_SET_RATING);</a>
<a name="ln365">		message-&gt;AddInt32(&quot;rating&quot;, i);</a>
<a name="ln366">		fRatingMenu-&gt;AddItem(new BMenuItem(label.String(), message));</a>
<a name="ln367">	}</a>
<a name="ln368">	// NOTE: We may want to encapsulate the Rating menu within a more</a>
<a name="ln369">	// general &quot;Attributes&quot; menu.</a>
<a name="ln370">	return fRatingMenu;</a>
<a name="ln371">}</a>
<a name="ln372"> </a>
<a name="ln373"> </a>
<a name="ln374">void</a>
<a name="ln375">ShowImageWindow::_AddMenus(BMenuBar* bar)</a>
<a name="ln376">{</a>
<a name="ln377">	BMenu* menu = new BMenu(B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln378"> </a>
<a name="ln379">	// Add recent files to &quot;Open File&quot; entry as sub-menu.</a>
<a name="ln380">	BMenuItem* item = new BMenuItem(BRecentFilesList::NewFileListMenu(</a>
<a name="ln381">		B_TRANSLATE(&quot;Open&quot; B_UTF8_ELLIPSIS), NULL, NULL, be_app, 10, true,</a>
<a name="ln382">		NULL, kApplicationSignature), new BMessage(MSG_FILE_OPEN));</a>
<a name="ln383">	item-&gt;SetShortcut('O', 0);</a>
<a name="ln384">	item-&gt;SetTarget(be_app);</a>
<a name="ln385">	menu-&gt;AddItem(item);</a>
<a name="ln386">	menu-&gt;AddSeparatorItem();</a>
<a name="ln387"> </a>
<a name="ln388">	BMenu* menuSaveAs = new BMenu(B_TRANSLATE(&quot;Save as&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln389">		B_ITEMS_IN_COLUMN);</a>
<a name="ln390">	BTranslationUtils::AddTranslationItems(menuSaveAs, B_TRANSLATOR_BITMAP);</a>
<a name="ln391">		// Fill Save As submenu with all types that can be converted</a>
<a name="ln392">		// to from the Be bitmap image format</a>
<a name="ln393">	menu-&gt;AddItem(menuSaveAs);</a>
<a name="ln394">	_AddItemMenu(menu, B_TRANSLATE(&quot;Close&quot;), B_QUIT_REQUESTED, 'W', 0, this);</a>
<a name="ln395">	_AddItemMenu(menu, B_TRANSLATE(&quot;Move to Trash&quot;), kMsgDeleteCurrentFile, 'T', 0, this);</a>
<a name="ln396">	_AddItemMenu(menu, B_TRANSLATE(&quot;Get info&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln397">		MSG_GET_INFO, 'I', 0, this);</a>
<a name="ln398">	menu-&gt;AddSeparatorItem();</a>
<a name="ln399">	_AddItemMenu(menu, B_TRANSLATE(&quot;Page setup&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln400">		MSG_PAGE_SETUP, 0, 0, this);</a>
<a name="ln401">	_AddItemMenu(menu, B_TRANSLATE(&quot;Print&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln402">		MSG_PREPARE_PRINT, 'P', 0, this);</a>
<a name="ln403">	menu-&gt;AddSeparatorItem();</a>
<a name="ln404">	_AddItemMenu(menu, B_TRANSLATE(&quot;Quit&quot;), B_QUIT_REQUESTED, 'Q', 0, be_app);</a>
<a name="ln405">	bar-&gt;AddItem(menu);</a>
<a name="ln406"> </a>
<a name="ln407">	menu = new BMenu(B_TRANSLATE(&quot;Edit&quot;));</a>
<a name="ln408">	_AddItemMenu(menu, B_TRANSLATE(&quot;Copy&quot;), B_COPY, 'C', 0, this, false);</a>
<a name="ln409">	menu-&gt;AddSeparatorItem();</a>
<a name="ln410">	_AddItemMenu(menu, B_TRANSLATE(&quot;Selection mode&quot;), MSG_SELECTION_MODE, 0, 0,</a>
<a name="ln411">		this);</a>
<a name="ln412">	_AddItemMenu(menu, B_TRANSLATE(&quot;Clear selection&quot;),</a>
<a name="ln413">		MSG_CLEAR_SELECT, 0, 0, this, false);</a>
<a name="ln414">	_AddItemMenu(menu, B_TRANSLATE(&quot;Select all&quot;),</a>
<a name="ln415">		MSG_SELECT_ALL, 'A', 0, this);</a>
<a name="ln416">	bar-&gt;AddItem(menu);</a>
<a name="ln417"> </a>
<a name="ln418">	menu = fBrowseMenu = new BMenu(B_TRANSLATE(&quot;Browse&quot;));</a>
<a name="ln419">	_AddItemMenu(menu, B_TRANSLATE(&quot;First page&quot;),</a>
<a name="ln420">		MSG_PAGE_FIRST, B_LEFT_ARROW, B_SHIFT_KEY, this);</a>
<a name="ln421">	_AddItemMenu(menu, B_TRANSLATE(&quot;Last page&quot;),</a>
<a name="ln422">		MSG_PAGE_LAST, B_RIGHT_ARROW, B_SHIFT_KEY, this);</a>
<a name="ln423">	_AddItemMenu(menu, B_TRANSLATE(&quot;Previous page&quot;),</a>
<a name="ln424">		MSG_PAGE_PREV, B_LEFT_ARROW, 0, this);</a>
<a name="ln425">	_AddItemMenu(menu, B_TRANSLATE(&quot;Next page&quot;),</a>
<a name="ln426">		MSG_PAGE_NEXT, B_RIGHT_ARROW, 0, this);</a>
<a name="ln427">	fGoToPageMenu = new BMenu(B_TRANSLATE(&quot;Go to page&quot;));</a>
<a name="ln428">	fGoToPageMenu-&gt;SetRadioMode(true);</a>
<a name="ln429">	menu-&gt;AddItem(fGoToPageMenu);</a>
<a name="ln430">	menu-&gt;AddSeparatorItem();</a>
<a name="ln431">	_AddItemMenu(menu, B_TRANSLATE(&quot;Previous file&quot;),</a>
<a name="ln432">		MSG_FILE_PREV, B_UP_ARROW, 0, this);</a>
<a name="ln433">	_AddItemMenu(menu, B_TRANSLATE(&quot;Next file&quot;),</a>
<a name="ln434">		MSG_FILE_NEXT, B_DOWN_ARROW, 0, this);</a>
<a name="ln435">	bar-&gt;AddItem(menu);</a>
<a name="ln436"> </a>
<a name="ln437">	menu = new BMenu(B_TRANSLATE(&quot;Image&quot;));</a>
<a name="ln438">	_AddItemMenu(menu, B_TRANSLATE(&quot;Rotate clockwise&quot;),</a>
<a name="ln439">		MSG_ROTATE_90, 'R', 0, this);</a>
<a name="ln440">	_AddItemMenu(menu, B_TRANSLATE(&quot;Rotate counterclockwise&quot;),</a>
<a name="ln441">		MSG_ROTATE_270, 'R', B_SHIFT_KEY, this);</a>
<a name="ln442">	menu-&gt;AddSeparatorItem();</a>
<a name="ln443">	_AddItemMenu(menu, B_TRANSLATE(&quot;Flip left to right&quot;),</a>
<a name="ln444">		MSG_FLIP_LEFT_TO_RIGHT, 0, 0, this);</a>
<a name="ln445">	_AddItemMenu(menu, B_TRANSLATE(&quot;Flip top to bottom&quot;),</a>
<a name="ln446">		MSG_FLIP_TOP_TO_BOTTOM, 0, 0, this);</a>
<a name="ln447">	menu-&gt;AddSeparatorItem();</a>
<a name="ln448">	_AddItemMenu(menu, B_TRANSLATE(&quot;Use as background&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln449">		MSG_DESKTOP_BACKGROUND, 0, 0, this);</a>
<a name="ln450"> </a>
<a name="ln451">	bar-&gt;AddItem(menu);</a>
<a name="ln452">}</a>
<a name="ln453"> </a>
<a name="ln454"> </a>
<a name="ln455">BMenuItem*</a>
<a name="ln456">ShowImageWindow::_AddItemMenu(BMenu* menu, const char* label, uint32 what,</a>
<a name="ln457">	char shortcut, uint32 modifier, const BHandler* target, bool enabled)</a>
<a name="ln458">{</a>
<a name="ln459">	BMenuItem* item = new BMenuItem(label, new BMessage(what), shortcut,</a>
<a name="ln460">		modifier);</a>
<a name="ln461">	menu-&gt;AddItem(item);</a>
<a name="ln462"> </a>
<a name="ln463">	item-&gt;SetTarget(target);</a>
<a name="ln464">	item-&gt;SetEnabled(enabled);</a>
<a name="ln465"> </a>
<a name="ln466">	return item;</a>
<a name="ln467">}</a>
<a name="ln468"> </a>
<a name="ln469"> </a>
<a name="ln470">BMenuItem*</a>
<a name="ln471">ShowImageWindow::_AddDelayItem(BMenu* menu, const char* label, bigtime_t delay)</a>
<a name="ln472">{</a>
<a name="ln473">	BMessage* message = new BMessage(MSG_SLIDE_SHOW_DELAY);</a>
<a name="ln474">	message-&gt;AddInt64(&quot;delay&quot;, delay);</a>
<a name="ln475"> </a>
<a name="ln476">	BMenuItem* item = new BMenuItem(label, message, 0);</a>
<a name="ln477">	item-&gt;SetTarget(this);</a>
<a name="ln478"> </a>
<a name="ln479">	if (delay == fSlideShowDelay)</a>
<a name="ln480">		item-&gt;SetMarked(true);</a>
<a name="ln481"> </a>
<a name="ln482">	menu-&gt;AddItem(item);</a>
<a name="ln483">	return item;</a>
<a name="ln484">}</a>
<a name="ln485"> </a>
<a name="ln486"> </a>
<a name="ln487">void</a>
<a name="ln488">ShowImageWindow::_ResizeWindowToImage()</a>
<a name="ln489">{</a>
<a name="ln490">	BBitmap* bitmap = fImageView-&gt;Bitmap();</a>
<a name="ln491">	BScreen screen;</a>
<a name="ln492">	if (bitmap == NULL || !screen.IsValid())</a>
<a name="ln493">		return;</a>
<a name="ln494"> </a>
<a name="ln495">	// TODO: use View::GetPreferredSize() instead?</a>
<a name="ln496">	BRect r(bitmap-&gt;Bounds());</a>
<a name="ln497">	float width = r.Width() + B_V_SCROLL_BAR_WIDTH;</a>
<a name="ln498">	float height = r.Height() + 1 + fBar-&gt;Frame().Height()</a>
<a name="ln499">		+ B_H_SCROLL_BAR_HEIGHT;</a>
<a name="ln500"> </a>
<a name="ln501">	BRect frame = screen.Frame();</a>
<a name="ln502">	const float windowBorder = 5;</a>
<a name="ln503">	// dimensions so that window does not reach outside of screen</a>
<a name="ln504">	float maxWidth = frame.Width() + 1 - windowBorder - Frame().left;</a>
<a name="ln505">	float maxHeight = frame.Height() + 1 - windowBorder - Frame().top;</a>
<a name="ln506"> </a>
<a name="ln507">	// We have to check size limits manually, otherwise</a>
<a name="ln508">	// menu bar will be too short for small images.</a>
<a name="ln509"> </a>
<a name="ln510">	float minW, maxW, minH, maxH;</a>
<a name="ln511">	GetSizeLimits(&amp;minW, &amp;maxW, &amp;minH, &amp;maxH);</a>
<a name="ln512">	if (maxWidth &gt; maxW)</a>
<a name="ln513">		maxWidth = maxW;</a>
<a name="ln514">	if (maxHeight &gt; maxH)</a>
<a name="ln515">		maxHeight = maxH;</a>
<a name="ln516">	if (width &lt; minW)</a>
<a name="ln517">		width = minW;</a>
<a name="ln518">	if (height &lt; minH)</a>
<a name="ln519">		height = minH;</a>
<a name="ln520"> </a>
<a name="ln521">	if (width &gt; maxWidth)</a>
<a name="ln522">		width = maxWidth;</a>
<a name="ln523">	if (height &gt; maxHeight)</a>
<a name="ln524">		height = maxHeight;</a>
<a name="ln525"> </a>
<a name="ln526">	ResizeTo(width, height);</a>
<a name="ln527">}</a>
<a name="ln528"> </a>
<a name="ln529"> </a>
<a name="ln530">bool</a>
<a name="ln531">ShowImageWindow::_ToggleMenuItem(uint32 what)</a>
<a name="ln532">{</a>
<a name="ln533">	bool marked = false;</a>
<a name="ln534">	BMenuItem* item = fBar-&gt;FindItem(what);</a>
<a name="ln535">	if (item != NULL) {</a>
<a name="ln536">		marked = !item-&gt;IsMarked();</a>
<a name="ln537">		item-&gt;SetMarked(marked);</a>
<a name="ln538">	}</a>
<a name="ln539">	fToolBar-&gt;SetActionPressed(what, marked);</a>
<a name="ln540">	return marked;</a>
<a name="ln541">}</a>
<a name="ln542"> </a>
<a name="ln543"> </a>
<a name="ln544">void</a>
<a name="ln545">ShowImageWindow::_EnableMenuItem(BMenu* menu, uint32 what, bool enable)</a>
<a name="ln546">{</a>
<a name="ln547">	BMenuItem* item = menu-&gt;FindItem(what);</a>
<a name="ln548">	if (item &amp;&amp; item-&gt;IsEnabled() != enable)</a>
<a name="ln549">		item-&gt;SetEnabled(enable);</a>
<a name="ln550">	fToolBar-&gt;SetActionEnabled(what, enable);</a>
<a name="ln551">}</a>
<a name="ln552"> </a>
<a name="ln553"> </a>
<a name="ln554">void</a>
<a name="ln555">ShowImageWindow::_MarkMenuItem(BMenu* menu, uint32 what, bool marked)</a>
<a name="ln556">{</a>
<a name="ln557">	BMenuItem* item = menu-&gt;FindItem(what);</a>
<a name="ln558">	if (item &amp;&amp; item-&gt;IsMarked() != marked)</a>
<a name="ln559">		item-&gt;SetMarked(marked);</a>
<a name="ln560">	fToolBar-&gt;SetActionPressed(what, marked);</a>
<a name="ln561">}</a>
<a name="ln562"> </a>
<a name="ln563"> </a>
<a name="ln564">void</a>
<a name="ln565">ShowImageWindow::_MarkSlideShowDelay(bigtime_t delay)</a>
<a name="ln566">{</a>
<a name="ln567">	const int32 count = fSlideShowDelayMenu-&gt;CountItems();</a>
<a name="ln568">	for (int32 i = 0; i &lt; count; i ++) {</a>
<a name="ln569">		BMenuItem* item = fSlideShowDelayMenu-&gt;ItemAt(i);</a>
<a name="ln570">		if (item != NULL) {</a>
<a name="ln571">			bigtime_t itemDelay;</a>
<a name="ln572">			if (item-&gt;Message()-&gt;FindInt64(&quot;delay&quot;, &amp;itemDelay) == B_OK</a>
<a name="ln573">				&amp;&amp; itemDelay == delay) {</a>
<a name="ln574">				item-&gt;SetMarked(true);</a>
<a name="ln575">				return;</a>
<a name="ln576">			}</a>
<a name="ln577">		}</a>
<a name="ln578">	}</a>
<a name="ln579">}</a>
<a name="ln580"> </a>
<a name="ln581"> </a>
<a name="ln582">void</a>
<a name="ln583">ShowImageWindow::Zoom(BPoint origin, float width, float height)</a>
<a name="ln584">{</a>
<a name="ln585">	_ToggleFullScreen();</a>
<a name="ln586">}</a>
<a name="ln587"> </a>
<a name="ln588"> </a>
<a name="ln589">void</a>
<a name="ln590">ShowImageWindow::MessageReceived(BMessage* message)</a>
<a name="ln591">{</a>
<a name="ln592">	if (message-&gt;WasDropped()) {</a>
<a name="ln593">		uint32 type;</a>
<a name="ln594">		int32 count;</a>
<a name="ln595">		status_t status = message-&gt;GetInfo(&quot;refs&quot;, &amp;type, &amp;count);</a>
<a name="ln596">		if (status == B_OK &amp;&amp; type == B_REF_TYPE) {</a>
<a name="ln597">			message-&gt;what = B_REFS_RECEIVED;</a>
<a name="ln598">			be_app-&gt;PostMessage(message);</a>
<a name="ln599">		}</a>
<a name="ln600">	}</a>
<a name="ln601"> </a>
<a name="ln602">	switch (message-&gt;what) {</a>
<a name="ln603">		case kMsgImageCacheImageLoaded:</a>
<a name="ln604">		{</a>
<a name="ln605">			fProgressWindow-&gt;Stop();</a>
<a name="ln606"> </a>
<a name="ln607">			BitmapOwner* bitmapOwner = NULL;</a>
<a name="ln608">			message-&gt;FindPointer(&quot;bitmapOwner&quot;, (void**)&amp;bitmapOwner);</a>
<a name="ln609"> </a>
<a name="ln610">			bool first = fImageView-&gt;Bitmap() == NULL;</a>
<a name="ln611">			entry_ref ref;</a>
<a name="ln612">			message-&gt;FindRef(&quot;ref&quot;, &amp;ref);</a>
<a name="ln613">			if (!first &amp;&amp; ref != fNavigator.CurrentRef()) {</a>
<a name="ln614">				// ignore older images</a>
<a name="ln615">				if (bitmapOwner != NULL)</a>
<a name="ln616">					bitmapOwner-&gt;ReleaseReference();</a>
<a name="ln617">				break;</a>
<a name="ln618">			}</a>
<a name="ln619"> </a>
<a name="ln620">			int32 page = message-&gt;FindInt32(&quot;page&quot;);</a>
<a name="ln621">			int32 pageCount = message-&gt;FindInt32(&quot;pageCount&quot;);</a>
<a name="ln622">			if (!first &amp;&amp; page != fNavigator.CurrentPage()) {</a>
<a name="ln623">				// ignore older pages</a>
<a name="ln624">				if (bitmapOwner != NULL)</a>
<a name="ln625">					bitmapOwner-&gt;ReleaseReference();</a>
<a name="ln626">				break;</a>
<a name="ln627">			}</a>
<a name="ln628"> </a>
<a name="ln629">			status_t status = fImageView-&gt;SetImage(message);</a>
<a name="ln630">			if (status != B_OK) {</a>
<a name="ln631">				if (bitmapOwner != NULL)</a>
<a name="ln632">					bitmapOwner-&gt;ReleaseReference();</a>
<a name="ln633"> </a>
<a name="ln634">				_LoadError(ref);</a>
<a name="ln635"> </a>
<a name="ln636">				// quit if file could not be opened</a>
<a name="ln637">				if (first)</a>
<a name="ln638">					Quit();</a>
<a name="ln639">				break;</a>
<a name="ln640">			}</a>
<a name="ln641"> </a>
<a name="ln642">			fImageType = message-&gt;FindString(&quot;type&quot;);</a>
<a name="ln643">			fNavigator.SetTo(ref, page, pageCount);</a>
<a name="ln644"> </a>
<a name="ln645">			fImageView-&gt;FitToBounds();</a>
<a name="ln646">			if (first) {</a>
<a name="ln647">				fImageView-&gt;MakeFocus(true);</a>
<a name="ln648">					// to receive key messages</a>
<a name="ln649">				Show();</a>
<a name="ln650">			}</a>
<a name="ln651">			_UpdateRatingMenu();</a>
<a name="ln652">			// Set width and height attributes of the currently showed file.</a>
<a name="ln653">			// This should only be a temporary solution.</a>
<a name="ln654">			_SaveWidthAndHeight();</a>
<a name="ln655">			break;</a>
<a name="ln656">		}</a>
<a name="ln657"> </a>
<a name="ln658">		case kMsgImageCacheProgressUpdate:</a>
<a name="ln659">		{</a>
<a name="ln660">			entry_ref ref;</a>
<a name="ln661">			if (message-&gt;FindRef(&quot;ref&quot;, &amp;ref) == B_OK</a>
<a name="ln662">				&amp;&amp; ref == fNavigator.CurrentRef()) {</a>
<a name="ln663">				message-&gt;what = kMsgProgressUpdate;</a>
<a name="ln664">				fProgressWindow-&gt;PostMessage(message);</a>
<a name="ln665">			}</a>
<a name="ln666">			break;</a>
<a name="ln667">		}</a>
<a name="ln668"> </a>
<a name="ln669">		case MSG_MODIFIED:</a>
<a name="ln670">			// If image has been modified due to a Cut or Paste</a>
<a name="ln671">			fModified = true;</a>
<a name="ln672">			break;</a>
<a name="ln673"> </a>
<a name="ln674">		case MSG_OUTPUT_TYPE:</a>
<a name="ln675">			// User clicked Save As then choose an output format</a>
<a name="ln676">			if (!fSavePanel)</a>
<a name="ln677">				// If user doesn't already have a save panel open</a>
<a name="ln678">				_SaveAs(message);</a>
<a name="ln679">			break;</a>
<a name="ln680"> </a>
<a name="ln681">		case MSG_SAVE_PANEL:</a>
<a name="ln682">			// User specified where to save the output image</a>
<a name="ln683">			_SaveToFile(message);</a>
<a name="ln684">			break;</a>
<a name="ln685"> </a>
<a name="ln686">		case B_CANCEL:</a>
<a name="ln687">			delete fSavePanel;</a>
<a name="ln688">			fSavePanel = NULL;</a>
<a name="ln689">			break;</a>
<a name="ln690"> </a>
<a name="ln691">		case MSG_UPDATE_STATUS:</a>
<a name="ln692">		{</a>
<a name="ln693">			int32 pages = fNavigator.PageCount();</a>
<a name="ln694">			int32 currentPage = fNavigator.CurrentPage();</a>
<a name="ln695"> </a>
<a name="ln696">			_EnableMenuItem(fBar, MSG_PAGE_FIRST,</a>
<a name="ln697">				fNavigator.HasPreviousPage());</a>
<a name="ln698">			_EnableMenuItem(fBar, MSG_PAGE_LAST, fNavigator.HasNextPage());</a>
<a name="ln699">			_EnableMenuItem(fBar, MSG_PAGE_NEXT, fNavigator.HasNextPage());</a>
<a name="ln700">			_EnableMenuItem(fBar, MSG_PAGE_PREV, fNavigator.HasPreviousPage());</a>
<a name="ln701">			fGoToPageMenu-&gt;SetEnabled(pages &gt; 1);</a>
<a name="ln702"> </a>
<a name="ln703">			_EnableMenuItem(fBar, MSG_FILE_NEXT, fNavigator.HasNextFile());</a>
<a name="ln704">			_EnableMenuItem(fBar, MSG_FILE_PREV, fNavigator.HasPreviousFile());</a>
<a name="ln705"> </a>
<a name="ln706">			if (fGoToPageMenu-&gt;CountItems() != pages) {</a>
<a name="ln707">				// Only rebuild the submenu if the number of</a>
<a name="ln708">				// pages is different</a>
<a name="ln709"> </a>
<a name="ln710">				while (fGoToPageMenu-&gt;CountItems() &gt; 0) {</a>
<a name="ln711">					// Remove all page numbers</a>
<a name="ln712">					delete fGoToPageMenu-&gt;RemoveItem((int32)0);</a>
<a name="ln713">				}</a>
<a name="ln714"> </a>
<a name="ln715">				for (int32 i = 1; i &lt;= pages; i++) {</a>
<a name="ln716">					// Fill Go To page submenu with an entry for each page</a>
<a name="ln717">					BMessage* goTo = new BMessage(MSG_GOTO_PAGE);</a>
<a name="ln718">					goTo-&gt;AddInt32(&quot;page&quot;, i);</a>
<a name="ln719"> </a>
<a name="ln720">					char shortcut = 0;</a>
<a name="ln721">					if (i &lt; 10)</a>
<a name="ln722">						shortcut = '0' + i;</a>
<a name="ln723"> </a>
<a name="ln724">					BString strCaption;</a>
<a name="ln725">					strCaption &lt;&lt; i;</a>
<a name="ln726"> </a>
<a name="ln727">					BMenuItem* item = new BMenuItem(strCaption.String(), goTo,</a>
<a name="ln728">						shortcut, B_SHIFT_KEY);</a>
<a name="ln729">					if (currentPage == i)</a>
<a name="ln730">						item-&gt;SetMarked(true);</a>
<a name="ln731">					fGoToPageMenu-&gt;AddItem(item);</a>
<a name="ln732">				}</a>
<a name="ln733">			} else {</a>
<a name="ln734">				// Make sure the correct page is marked</a>
<a name="ln735">				BMenuItem* currentItem = fGoToPageMenu-&gt;ItemAt(currentPage - 1);</a>
<a name="ln736">				if (currentItem != NULL &amp;&amp; !currentItem-&gt;IsMarked())</a>
<a name="ln737">					currentItem-&gt;SetMarked(true);</a>
<a name="ln738">			}</a>
<a name="ln739"> </a>
<a name="ln740">			_UpdateStatusText(message);</a>
<a name="ln741"> </a>
<a name="ln742">			BPath path(fImageView-&gt;Image());</a>
<a name="ln743">			SetTitle(path.Path());</a>
<a name="ln744">			break;</a>
<a name="ln745">		}</a>
<a name="ln746"> </a>
<a name="ln747">		case MSG_UPDATE_STATUS_TEXT:</a>
<a name="ln748">		{</a>
<a name="ln749">			_UpdateStatusText(message);</a>
<a name="ln750">			break;</a>
<a name="ln751">		}</a>
<a name="ln752"> </a>
<a name="ln753">		case MSG_SELECTION:</a>
<a name="ln754">		{</a>
<a name="ln755">			// The view sends this message when a selection is</a>
<a name="ln756">			// made or the selection is cleared so that the window</a>
<a name="ln757">			// can update the state of the appropriate menu items</a>
<a name="ln758">			bool enable;</a>
<a name="ln759">			if (message-&gt;FindBool(&quot;has_selection&quot;, &amp;enable) == B_OK) {</a>
<a name="ln760">				_EnableMenuItem(fBar, B_COPY, enable);</a>
<a name="ln761">				_EnableMenuItem(fBar, MSG_CLEAR_SELECT, enable);</a>
<a name="ln762">			}</a>
<a name="ln763">			break;</a>
<a name="ln764">		}</a>
<a name="ln765"> </a>
<a name="ln766">		case B_COPY:</a>
<a name="ln767">			fImageView-&gt;CopySelectionToClipboard();</a>
<a name="ln768">			break;</a>
<a name="ln769"> </a>
<a name="ln770">		case MSG_SELECTION_MODE:</a>
<a name="ln771">		{</a>
<a name="ln772">			bool selectionMode = _ToggleMenuItem(MSG_SELECTION_MODE);</a>
<a name="ln773">			fImageView-&gt;SetSelectionMode(selectionMode);</a>
<a name="ln774">			if (!selectionMode)</a>
<a name="ln775">				fImageView-&gt;ClearSelection();</a>
<a name="ln776">			break;</a>
<a name="ln777">		}</a>
<a name="ln778"> </a>
<a name="ln779">		case MSG_CLEAR_SELECT:</a>
<a name="ln780">			fImageView-&gt;ClearSelection();</a>
<a name="ln781">			break;</a>
<a name="ln782"> </a>
<a name="ln783">		case MSG_SELECT_ALL:</a>
<a name="ln784">			fImageView-&gt;SelectAll();</a>
<a name="ln785">			break;</a>
<a name="ln786"> </a>
<a name="ln787">		case MSG_PAGE_FIRST:</a>
<a name="ln788">			if (_ClosePrompt() &amp;&amp; fNavigator.FirstPage())</a>
<a name="ln789">				_LoadImage();</a>
<a name="ln790">			break;</a>
<a name="ln791"> </a>
<a name="ln792">		case MSG_PAGE_LAST:</a>
<a name="ln793">			if (_ClosePrompt() &amp;&amp; fNavigator.LastPage())</a>
<a name="ln794">				_LoadImage();</a>
<a name="ln795">			break;</a>
<a name="ln796"> </a>
<a name="ln797">		case MSG_PAGE_NEXT:</a>
<a name="ln798">			if (_ClosePrompt() &amp;&amp; fNavigator.NextPage())</a>
<a name="ln799">				_LoadImage();</a>
<a name="ln800">			break;</a>
<a name="ln801"> </a>
<a name="ln802">		case MSG_PAGE_PREV:</a>
<a name="ln803">			if (_ClosePrompt() &amp;&amp; fNavigator.PreviousPage())</a>
<a name="ln804">				_LoadImage();</a>
<a name="ln805">			break;</a>
<a name="ln806"> </a>
<a name="ln807">		case MSG_GOTO_PAGE:</a>
<a name="ln808">		{</a>
<a name="ln809">			if (!_ClosePrompt())</a>
<a name="ln810">				break;</a>
<a name="ln811"> </a>
<a name="ln812">			int32 newPage;</a>
<a name="ln813">			if (message-&gt;FindInt32(&quot;page&quot;, &amp;newPage) != B_OK)</a>
<a name="ln814">				break;</a>
<a name="ln815"> </a>
<a name="ln816">			int32 currentPage = fNavigator.CurrentPage();</a>
<a name="ln817">			int32 pages = fNavigator.PageCount();</a>
<a name="ln818"> </a>
<a name="ln819">			// TODO: use radio mode instead!</a>
<a name="ln820">			if (newPage &gt; 0 &amp;&amp; newPage &lt;= pages) {</a>
<a name="ln821">				BMenuItem* currentItem = fGoToPageMenu-&gt;ItemAt(currentPage - 1);</a>
<a name="ln822">				BMenuItem* newItem = fGoToPageMenu-&gt;ItemAt(newPage - 1);</a>
<a name="ln823">				if (currentItem != NULL &amp;&amp; newItem != NULL) {</a>
<a name="ln824">					currentItem-&gt;SetMarked(false);</a>
<a name="ln825">					newItem-&gt;SetMarked(true);</a>
<a name="ln826">					if (fNavigator.GoToPage(newPage))</a>
<a name="ln827">						_LoadImage();</a>
<a name="ln828">				}</a>
<a name="ln829">			}</a>
<a name="ln830">			break;</a>
<a name="ln831">		}</a>
<a name="ln832"> </a>
<a name="ln833">		case kMsgFitToWindow:</a>
<a name="ln834">			fImageView-&gt;FitToBounds();</a>
<a name="ln835">			break;</a>
<a name="ln836"> </a>
<a name="ln837">		case kMsgStretchToWindow:</a>
<a name="ln838">			fImageView-&gt;SetStretchToBounds(</a>
<a name="ln839">				_ToggleMenuItem(kMsgStretchToWindow));</a>
<a name="ln840">			break;</a>
<a name="ln841"> </a>
<a name="ln842">		case MSG_FILE_PREV:</a>
<a name="ln843">			if (_ClosePrompt() &amp;&amp; fNavigator.PreviousFile())</a>
<a name="ln844">				_LoadImage(false);</a>
<a name="ln845">			break;</a>
<a name="ln846"> </a>
<a name="ln847">		case MSG_FILE_NEXT:</a>
<a name="ln848">		case kMsgNextSlide:</a>
<a name="ln849">			if (_ClosePrompt() &amp;&amp; fNavigator.NextFile())</a>
<a name="ln850">				_LoadImage();</a>
<a name="ln851">			break;</a>
<a name="ln852"> </a>
<a name="ln853">		case kMsgDeleteCurrentFile:</a>
<a name="ln854">		{</a>
<a name="ln855">			if (fNavigator.MoveFileToTrash())</a>
<a name="ln856">				_LoadImage();</a>
<a name="ln857">			else</a>
<a name="ln858">				PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln859">			break;</a>
<a name="ln860">		}</a>
<a name="ln861"> </a>
<a name="ln862">		case MSG_ROTATE_90:</a>
<a name="ln863">			fImageView-&gt;Rotate(90);</a>
<a name="ln864">			break;</a>
<a name="ln865"> </a>
<a name="ln866">		case MSG_ROTATE_270:</a>
<a name="ln867">			fImageView-&gt;Rotate(270);</a>
<a name="ln868">			break;</a>
<a name="ln869"> </a>
<a name="ln870">		case MSG_FLIP_LEFT_TO_RIGHT:</a>
<a name="ln871">			fImageView-&gt;Flip(true);</a>
<a name="ln872">			break;</a>
<a name="ln873"> </a>
<a name="ln874">		case MSG_FLIP_TOP_TO_BOTTOM:</a>
<a name="ln875">			fImageView-&gt;Flip(false);</a>
<a name="ln876">			break;</a>
<a name="ln877"> </a>
<a name="ln878">		case MSG_GET_INFO:</a>
<a name="ln879">			_GetFileInfo(fNavigator.CurrentRef());</a>
<a name="ln880">			break;</a>
<a name="ln881"> </a>
<a name="ln882">		case MSG_SLIDE_SHOW:</a>
<a name="ln883">		{</a>
<a name="ln884">			bool fullScreen = false;</a>
<a name="ln885">			message-&gt;FindBool(&quot;full screen&quot;, &amp;fullScreen);</a>
<a name="ln886"> </a>
<a name="ln887">			BMenuItem* item = fBar-&gt;FindItem(message-&gt;what);</a>
<a name="ln888">			if (item == NULL)</a>
<a name="ln889">				break;</a>
<a name="ln890"> </a>
<a name="ln891">			if (item-&gt;IsMarked()) {</a>
<a name="ln892">				item-&gt;SetMarked(false);</a>
<a name="ln893">				_StopSlideShow();</a>
<a name="ln894">				fToolBar-&gt;SetActionPressed(MSG_SLIDE_SHOW, false);</a>
<a name="ln895">			} else if (_ClosePrompt()) {</a>
<a name="ln896">				item-&gt;SetMarked(true);</a>
<a name="ln897">				if (!fFullScreen &amp;&amp; fullScreen)</a>
<a name="ln898">					_ToggleFullScreen();</a>
<a name="ln899">				_StartSlideShow();</a>
<a name="ln900">				fToolBar-&gt;SetActionPressed(MSG_SLIDE_SHOW, true);</a>
<a name="ln901">			}</a>
<a name="ln902">			break;</a>
<a name="ln903">		}</a>
<a name="ln904"> </a>
<a name="ln905">		case kMsgStopSlideShow:</a>
<a name="ln906">		{</a>
<a name="ln907">			BMenuItem* item = fBar-&gt;FindItem(MSG_SLIDE_SHOW);</a>
<a name="ln908">			if (item != NULL)</a>
<a name="ln909">				item-&gt;SetMarked(false);</a>
<a name="ln910"> </a>
<a name="ln911">			_StopSlideShow();</a>
<a name="ln912">			fToolBar-&gt;SetActionPressed(MSG_SLIDE_SHOW, false);</a>
<a name="ln913">			break;</a>
<a name="ln914">		}</a>
<a name="ln915"> </a>
<a name="ln916">		case MSG_SLIDE_SHOW_DELAY:</a>
<a name="ln917">		{</a>
<a name="ln918">			bigtime_t delay;</a>
<a name="ln919">			if (message-&gt;FindInt64(&quot;delay&quot;, &amp;delay) == B_OK) {</a>
<a name="ln920">				_SetSlideShowDelay(delay);</a>
<a name="ln921">				// in case message is sent from popup menu</a>
<a name="ln922">				_MarkSlideShowDelay(delay);</a>
<a name="ln923">			}</a>
<a name="ln924">			break;</a>
<a name="ln925">		}</a>
<a name="ln926"> </a>
<a name="ln927">		case MSG_FULL_SCREEN:</a>
<a name="ln928">			_ToggleFullScreen();</a>
<a name="ln929">			break;</a>
<a name="ln930"> </a>
<a name="ln931">		case MSG_EXIT_FULL_SCREEN:</a>
<a name="ln932">			if (fFullScreen)</a>
<a name="ln933">				_ToggleFullScreen();</a>
<a name="ln934">			break;</a>
<a name="ln935"> </a>
<a name="ln936">		case MSG_SHOW_CAPTION:</a>
<a name="ln937">		{</a>
<a name="ln938">			fShowCaption = _ToggleMenuItem(message-&gt;what);</a>
<a name="ln939">			ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln940"> </a>
<a name="ln941">			if (settings-&gt;Lock()) {</a>
<a name="ln942">				settings-&gt;SetBool(&quot;ShowCaption&quot;, fShowCaption);</a>
<a name="ln943">				settings-&gt;Unlock();</a>
<a name="ln944">			}</a>
<a name="ln945">			if (fFullScreen)</a>
<a name="ln946">				fImageView-&gt;SetShowCaption(fShowCaption);</a>
<a name="ln947">		}	break;</a>
<a name="ln948"> </a>
<a name="ln949">		case MSG_PAGE_SETUP:</a>
<a name="ln950">			_PageSetup();</a>
<a name="ln951">			break;</a>
<a name="ln952"> </a>
<a name="ln953">		case MSG_PREPARE_PRINT:</a>
<a name="ln954">			_PrepareForPrint();</a>
<a name="ln955">			break;</a>
<a name="ln956"> </a>
<a name="ln957">		case MSG_PRINT:</a>
<a name="ln958">			_Print(message);</a>
<a name="ln959">			break;</a>
<a name="ln960"> </a>
<a name="ln961">		case MSG_ZOOM_IN:</a>
<a name="ln962">			fImageView-&gt;ZoomIn();</a>
<a name="ln963">			break;</a>
<a name="ln964"> </a>
<a name="ln965">		case MSG_ZOOM_OUT:</a>
<a name="ln966">			fImageView-&gt;ZoomOut();</a>
<a name="ln967">			break;</a>
<a name="ln968"> </a>
<a name="ln969">		case MSG_UPDATE_STATUS_ZOOM:</a>
<a name="ln970">			fStatusView-&gt;SetZoom(fImageView-&gt;Zoom());</a>
<a name="ln971">			break;</a>
<a name="ln972"> </a>
<a name="ln973">		case kMsgOriginalSize:</a>
<a name="ln974">			if (message-&gt;FindInt32(&quot;behavior&quot;) == BButton::B_TOGGLE_BEHAVIOR) {</a>
<a name="ln975">				bool force = (message-&gt;FindInt32(&quot;be:value&quot;) == B_CONTROL_ON);</a>
<a name="ln976">				fImageView-&gt;ForceOriginalSize(force);</a>
<a name="ln977">				if (!force)</a>
<a name="ln978">					break;</a>
<a name="ln979">			}</a>
<a name="ln980">			fImageView-&gt;SetZoom(1.0);</a>
<a name="ln981">			break;</a>
<a name="ln982"> </a>
<a name="ln983">		case MSG_SCALE_BILINEAR:</a>
<a name="ln984">			fImageView-&gt;SetScaleBilinear(_ToggleMenuItem(message-&gt;what));</a>
<a name="ln985">			break;</a>
<a name="ln986"> </a>
<a name="ln987">		case MSG_DESKTOP_BACKGROUND:</a>
<a name="ln988">		{</a>
<a name="ln989">			BMessage backgroundsMessage(B_REFS_RECEIVED);</a>
<a name="ln990">			backgroundsMessage.AddRef(&quot;refs&quot;, fImageView-&gt;Image());</a>
<a name="ln991">			// This is used in the Backgrounds code for scaled placement</a>
<a name="ln992">			backgroundsMessage.AddInt32(&quot;placement&quot;, 'scpl');</a>
<a name="ln993">			be_roster-&gt;Launch(&quot;application/x-vnd.haiku-backgrounds&quot;,</a>
<a name="ln994">				&amp;backgroundsMessage);</a>
<a name="ln995">			break;</a>
<a name="ln996">		}</a>
<a name="ln997"> </a>
<a name="ln998">		case MSG_SET_RATING:</a>
<a name="ln999">		{</a>
<a name="ln1000">			int32 rating;</a>
<a name="ln1001">			if (message-&gt;FindInt32(&quot;rating&quot;, &amp;rating) != B_OK)</a>
<a name="ln1002">				break;</a>
<a name="ln1003">			BFile file(&amp;fNavigator.CurrentRef(), B_WRITE_ONLY);</a>
<a name="ln1004">			if (file.InitCheck() != B_OK)</a>
<a name="ln1005">				break;</a>
<a name="ln1006">			file.WriteAttr(&quot;Media:Rating&quot;, B_INT32_TYPE, 0, &amp;rating,</a>
<a name="ln1007">				sizeof(rating));</a>
<a name="ln1008">			_UpdateRatingMenu();</a>
<a name="ln1009">			break;</a>
<a name="ln1010">		}</a>
<a name="ln1011"> </a>
<a name="ln1012">		case kMsgToggleToolBar:</a>
<a name="ln1013">		{</a>
<a name="ln1014">			fShowToolBar = _ToggleMenuItem(message-&gt;what);</a>
<a name="ln1015">			_SetToolBarVisible(fShowToolBar, true);</a>
<a name="ln1016"> </a>
<a name="ln1017">			ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln1018"> </a>
<a name="ln1019">			if (settings-&gt;Lock()) {</a>
<a name="ln1020">				settings-&gt;SetBool(&quot;ShowToolBar&quot;, fShowToolBar);</a>
<a name="ln1021">				settings-&gt;Unlock();</a>
<a name="ln1022">			}</a>
<a name="ln1023">			break;</a>
<a name="ln1024">		}</a>
<a name="ln1025">		case kShowToolBarIfEnabled:</a>
<a name="ln1026">		{</a>
<a name="ln1027">			bool show;</a>
<a name="ln1028">			if (message-&gt;FindBool(&quot;show&quot;, &amp;show) != B_OK)</a>
<a name="ln1029">				break;</a>
<a name="ln1030">			_SetToolBarVisible(fShowToolBar &amp;&amp; show, true);</a>
<a name="ln1031">			break;</a>
<a name="ln1032">		}</a>
<a name="ln1033">		case kMsgSlideToolBar:</a>
<a name="ln1034">		{</a>
<a name="ln1035">			float offset;</a>
<a name="ln1036">			if (message-&gt;FindFloat(&quot;offset&quot;, &amp;offset) == B_OK) {</a>
<a name="ln1037">				fToolBar-&gt;MoveBy(0, offset);</a>
<a name="ln1038">				fScrollView-&gt;ResizeBy(0, -offset);</a>
<a name="ln1039">				fScrollView-&gt;MoveBy(0, offset);</a>
<a name="ln1040">				UpdateIfNeeded();</a>
<a name="ln1041">				snooze(15000);</a>
<a name="ln1042">			}</a>
<a name="ln1043">			break;</a>
<a name="ln1044">		}</a>
<a name="ln1045">		case kMsgFinishSlidingToolBar:</a>
<a name="ln1046">		{</a>
<a name="ln1047">			float offset;</a>
<a name="ln1048">			bool show;</a>
<a name="ln1049">			if (message-&gt;FindFloat(&quot;offset&quot;, &amp;offset) == B_OK</a>
<a name="ln1050">				&amp;&amp; message-&gt;FindBool(&quot;show&quot;, &amp;show) == B_OK) {</a>
<a name="ln1051">				// Compensate rounding errors with the final placement</a>
<a name="ln1052">				fToolBar-&gt;MoveTo(fToolBar-&gt;Frame().left, offset);</a>
<a name="ln1053">				if (!show)</a>
<a name="ln1054">					fToolBar-&gt;Hide();</a>
<a name="ln1055">				BRect frame = fToolBar-&gt;Parent()-&gt;Bounds();</a>
<a name="ln1056">				frame.top = fToolBar-&gt;Frame().bottom + 1;</a>
<a name="ln1057">				fScrollView-&gt;MoveTo(fScrollView-&gt;Frame().left, frame.top);</a>
<a name="ln1058">				fScrollView-&gt;ResizeTo(fScrollView-&gt;Bounds().Width(),</a>
<a name="ln1059">					frame.Height() + 1);</a>
<a name="ln1060">			}</a>
<a name="ln1061">			break;</a>
<a name="ln1062">		}</a>
<a name="ln1063"> </a>
<a name="ln1064">		default:</a>
<a name="ln1065">			BWindow::MessageReceived(message);</a>
<a name="ln1066">			break;</a>
<a name="ln1067">	}</a>
<a name="ln1068">}</a>
<a name="ln1069"> </a>
<a name="ln1070"> </a>
<a name="ln1071">void</a>
<a name="ln1072">ShowImageWindow::_GetFileInfo(const entry_ref&amp; ref)</a>
<a name="ln1073">{</a>
<a name="ln1074">	BMessage message('Tinf');</a>
<a name="ln1075">	BMessenger tracker(&quot;application/x-vnd.Be-TRAK&quot;);</a>
<a name="ln1076">	message.AddRef(&quot;refs&quot;, &amp;ref);</a>
<a name="ln1077">	tracker.SendMessage(&amp;message);</a>
<a name="ln1078">}</a>
<a name="ln1079"> </a>
<a name="ln1080"> </a>
<a name="ln1081">void</a>
<a name="ln1082">ShowImageWindow::_UpdateStatusText(const BMessage* message)</a>
<a name="ln1083">{</a>
<a name="ln1084">	BString frameText;</a>
<a name="ln1085">	if (fImageView-&gt;Bitmap() != NULL) {</a>
<a name="ln1086">		BRect bounds = fImageView-&gt;Bitmap()-&gt;Bounds();</a>
<a name="ln1087">		frameText &lt;&lt; bounds.IntegerWidth() + 1</a>
<a name="ln1088">			&lt;&lt; &quot;x&quot; &lt;&lt; bounds.IntegerHeight() + 1;</a>
<a name="ln1089">	}</a>
<a name="ln1090">	BString pages;</a>
<a name="ln1091">	if (fNavigator.PageCount() &gt; 1)</a>
<a name="ln1092">		pages &lt;&lt; fNavigator.CurrentPage() &lt;&lt; &quot;/&quot; &lt;&lt; fNavigator.PageCount();</a>
<a name="ln1093">	fStatusView-&gt;Update(fNavigator.CurrentRef(), frameText, pages, fImageType,</a>
<a name="ln1094">		fImageView-&gt;Zoom());</a>
<a name="ln1095">}</a>
<a name="ln1096"> </a>
<a name="ln1097"> </a>
<a name="ln1098">void</a>
<a name="ln1099">ShowImageWindow::_LoadError(const entry_ref&amp; ref)</a>
<a name="ln1100">{</a>
<a name="ln1101">	// TODO: give a better error message!</a>
<a name="ln1102">	BAlert* alert = new BAlert(B_TRANSLATE_SYSTEM_NAME(&quot;ShowImage&quot;),</a>
<a name="ln1103">		B_TRANSLATE_CONTEXT(&quot;Could not load image! Either the &quot;</a>
<a name="ln1104">			&quot;file or an image translator for it does not exist.&quot;,</a>
<a name="ln1105">			&quot;LoadAlerts&quot;),</a>
<a name="ln1106">		B_TRANSLATE_CONTEXT(&quot;OK&quot;, &quot;Alerts&quot;), NULL, NULL,</a>
<a name="ln1107">		B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln1108">	alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1109">	alert-&gt;Go();</a>
<a name="ln1110">}</a>
<a name="ln1111"> </a>
<a name="ln1112"> </a>
<a name="ln1113">void</a>
<a name="ln1114">ShowImageWindow::_SaveAs(BMessage* message)</a>
<a name="ln1115">{</a>
<a name="ln1116">	// Read the translator and output type the user chose</a>
<a name="ln1117">	translator_id outTranslator;</a>
<a name="ln1118">	uint32 outType;</a>
<a name="ln1119">	if (message-&gt;FindInt32(kTranslatorField,</a>
<a name="ln1120">			reinterpret_cast&lt;int32 *&gt;(&amp;outTranslator)) != B_OK</a>
<a name="ln1121">		|| message-&gt;FindInt32(kTypeField,</a>
<a name="ln1122">			reinterpret_cast&lt;int32 *&gt;(&amp;outType)) != B_OK)</a>
<a name="ln1123">		return;</a>
<a name="ln1124"> </a>
<a name="ln1125">	// Add the chosen translator and output type to the</a>
<a name="ln1126">	// message that the save panel will send back</a>
<a name="ln1127">	BMessage panelMsg(MSG_SAVE_PANEL);</a>
<a name="ln1128">	panelMsg.AddInt32(kTranslatorField, outTranslator);</a>
<a name="ln1129">	panelMsg.AddInt32(kTypeField, outType);</a>
<a name="ln1130"> </a>
<a name="ln1131">	// Create save panel and show it</a>
<a name="ln1132">	BMessenger target(this);</a>
<a name="ln1133">	fSavePanel = new (std::nothrow) BFilePanel(B_SAVE_PANEL,</a>
<a name="ln1134">		&amp;target, NULL, 0, false, &amp;panelMsg);</a>
<a name="ln1135">	if (!fSavePanel)</a>
<a name="ln1136">		return;</a>
<a name="ln1137"> </a>
<a name="ln1138">	// Retrieve save directory from settings;</a>
<a name="ln1139">	ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln1140">	if (settings-&gt;Lock()) {</a>
<a name="ln1141">		fSavePanel-&gt;SetPanelDirectory(</a>
<a name="ln1142">			settings-&gt;GetString(&quot;SaveDirectory&quot;, NULL));</a>
<a name="ln1143">		settings-&gt;Unlock();</a>
<a name="ln1144">	}</a>
<a name="ln1145"> </a>
<a name="ln1146">	fSavePanel-&gt;Window()-&gt;SetWorkspaces(B_CURRENT_WORKSPACE);</a>
<a name="ln1147">	fSavePanel-&gt;Show();</a>
<a name="ln1148">}</a>
<a name="ln1149"> </a>
<a name="ln1150"> </a>
<a name="ln1151">void</a>
<a name="ln1152">ShowImageWindow::_SaveToFile(BMessage* message)</a>
<a name="ln1153">{</a>
<a name="ln1154">	// Read in where the file should be saved</a>
<a name="ln1155">	entry_ref dirRef;</a>
<a name="ln1156">	if (message-&gt;FindRef(&quot;directory&quot;, &amp;dirRef) != B_OK)</a>
<a name="ln1157">		return;</a>
<a name="ln1158"> </a>
<a name="ln1159">	const char* filename;</a>
<a name="ln1160">	if (message-&gt;FindString(&quot;name&quot;, &amp;filename) != B_OK)</a>
<a name="ln1161">		return;</a>
<a name="ln1162"> </a>
<a name="ln1163">	// Read in the translator and type to be used</a>
<a name="ln1164">	// to save the output image</a>
<a name="ln1165">	translator_id outTranslator;</a>
<a name="ln1166">	uint32 outType;</a>
<a name="ln1167">	if (message-&gt;FindInt32(kTranslatorField,</a>
<a name="ln1168">			reinterpret_cast&lt;int32 *&gt;(&amp;outTranslator)) != B_OK</a>
<a name="ln1169">		|| message-&gt;FindInt32(kTypeField,</a>
<a name="ln1170">			reinterpret_cast&lt;int32 *&gt;(&amp;outType)) != B_OK)</a>
<a name="ln1171">		return;</a>
<a name="ln1172"> </a>
<a name="ln1173">	// Find the translator_format information needed to</a>
<a name="ln1174">	// write a MIME attribute for the image file</a>
<a name="ln1175">	BTranslatorRoster* roster = BTranslatorRoster::Default();</a>
<a name="ln1176">	const translation_format* outFormat = NULL;</a>
<a name="ln1177">	int32 outCount = 0;</a>
<a name="ln1178">	if (roster-&gt;GetOutputFormats(outTranslator, &amp;outFormat, &amp;outCount) != B_OK</a>
<a name="ln1179">		|| outCount &lt; 1)</a>
<a name="ln1180">		return;</a>
<a name="ln1181"> </a>
<a name="ln1182">	int32 i;</a>
<a name="ln1183">	for (i = 0; i &lt; outCount; i++) {</a>
<a name="ln1184">		if (outFormat[i].group == B_TRANSLATOR_BITMAP &amp;&amp; outFormat[i].type</a>
<a name="ln1185">				== outType)</a>
<a name="ln1186">			break;</a>
<a name="ln1187">	}</a>
<a name="ln1188">	if (i == outCount)</a>
<a name="ln1189">		return;</a>
<a name="ln1190"> </a>
<a name="ln1191">	// Write out the image file</a>
<a name="ln1192">	BDirectory dir(&amp;dirRef);</a>
<a name="ln1193">	fImageView-&gt;SaveToFile(&amp;dir, filename, NULL, &amp;outFormat[i]);</a>
<a name="ln1194"> </a>
<a name="ln1195">	// Store Save directory in settings;</a>
<a name="ln1196">	ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln1197">	if (settings-&gt;Lock()) {</a>
<a name="ln1198">		BPath path(&amp;dirRef);</a>
<a name="ln1199">		settings-&gt;SetString(&quot;SaveDirectory&quot;, path.Path());</a>
<a name="ln1200">		settings-&gt;Unlock();</a>
<a name="ln1201">	}</a>
<a name="ln1202">}</a>
<a name="ln1203"> </a>
<a name="ln1204"> </a>
<a name="ln1205">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln1206">#define B_TRANSLATION_CONTEXT &quot;ClosePrompt&quot;</a>
<a name="ln1207"> </a>
<a name="ln1208"> </a>
<a name="ln1209">bool</a>
<a name="ln1210">ShowImageWindow::_ClosePrompt()</a>
<a name="ln1211">{</a>
<a name="ln1212">	if (!fModified)</a>
<a name="ln1213">		return true;</a>
<a name="ln1214"> </a>
<a name="ln1215">	int32 count = fNavigator.PageCount();</a>
<a name="ln1216">	int32 page = fNavigator.CurrentPage();</a>
<a name="ln1217">	BString prompt;</a>
<a name="ln1218"> </a>
<a name="ln1219">	if (count &gt; 1) {</a>
<a name="ln1220">		bs_printf(&amp;prompt,</a>
<a name="ln1221">			B_TRANSLATE(&quot;The document '%s' (page %d) has been changed. Do you &quot;</a>
<a name="ln1222">				&quot;want to close the document?&quot;),</a>
<a name="ln1223">			fImageView-&gt;Image()-&gt;name, page);</a>
<a name="ln1224">	} else {</a>
<a name="ln1225">		bs_printf(&amp;prompt,</a>
<a name="ln1226">			B_TRANSLATE(&quot;The document '%s' has been changed. Do you want to &quot;</a>
<a name="ln1227">				&quot;close the document?&quot;),</a>
<a name="ln1228">			fImageView-&gt;Image()-&gt;name);</a>
<a name="ln1229">	}</a>
<a name="ln1230"> </a>
<a name="ln1231">	BAlert* alert = new BAlert(B_TRANSLATE(&quot;Close document&quot;), prompt.String(),</a>
<a name="ln1232">		B_TRANSLATE(&quot;Cancel&quot;), B_TRANSLATE(&quot;Close&quot;));</a>
<a name="ln1233">	alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln1234"> </a>
<a name="ln1235">	if (alert-&gt;Go() == 0) {</a>
<a name="ln1236">		// Cancel</a>
<a name="ln1237">		return false;</a>
<a name="ln1238">	}</a>
<a name="ln1239"> </a>
<a name="ln1240">	// Close</a>
<a name="ln1241">	fModified = false;</a>
<a name="ln1242">	return true;</a>
<a name="ln1243">}</a>
<a name="ln1244"> </a>
<a name="ln1245"> </a>
<a name="ln1246">status_t</a>
<a name="ln1247">ShowImageWindow::_LoadImage(bool forward)</a>
<a name="ln1248">{</a>
<a name="ln1249">	BMessenger us(this);</a>
<a name="ln1250">	status_t status = my_app-&gt;DefaultCache().RetrieveImage(</a>
<a name="ln1251">		fNavigator.CurrentRef(), fNavigator.CurrentPage(), &amp;us);</a>
<a name="ln1252">	if (status != B_OK)</a>
<a name="ln1253">		return status;</a>
<a name="ln1254"> </a>
<a name="ln1255">	fProgressWindow-&gt;Start(this);</a>
<a name="ln1256"> </a>
<a name="ln1257">	// Preload previous/next images - two in the navigation direction, one</a>
<a name="ln1258">	// in the opposite direction.</a>
<a name="ln1259"> </a>
<a name="ln1260">	entry_ref nextRef = fNavigator.CurrentRef();</a>
<a name="ln1261">	if (_PreloadImage(forward, nextRef))</a>
<a name="ln1262">		_PreloadImage(forward, nextRef);</a>
<a name="ln1263"> </a>
<a name="ln1264">	entry_ref previousRef = fNavigator.CurrentRef();</a>
<a name="ln1265">	_PreloadImage(!forward, previousRef);</a>
<a name="ln1266"> </a>
<a name="ln1267">	return B_OK;</a>
<a name="ln1268">}</a>
<a name="ln1269"> </a>
<a name="ln1270"> </a>
<a name="ln1271">bool</a>
<a name="ln1272">ShowImageWindow::_PreloadImage(bool forward, entry_ref&amp; ref)</a>
<a name="ln1273">{</a>
<a name="ln1274">	entry_ref currentRef = ref;</a>
<a name="ln1275">	if ((forward &amp;&amp; !fNavigator.GetNextFile(currentRef, ref))</a>
<a name="ln1276">		|| (!forward &amp;&amp; !fNavigator.GetPreviousFile(currentRef, ref)))</a>
<a name="ln1277">		return false;</a>
<a name="ln1278"> </a>
<a name="ln1279">	return my_app-&gt;DefaultCache().RetrieveImage(ref) == B_OK;</a>
<a name="ln1280">}</a>
<a name="ln1281"> </a>
<a name="ln1282"> </a>
<a name="ln1283">void</a>
<a name="ln1284">ShowImageWindow::_ToggleFullScreen()</a>
<a name="ln1285">{</a>
<a name="ln1286">	BRect frame;</a>
<a name="ln1287">	fFullScreen = !fFullScreen;</a>
<a name="ln1288">	if (fFullScreen) {</a>
<a name="ln1289">		BScreen screen;</a>
<a name="ln1290">		fWindowFrame = Frame();</a>
<a name="ln1291">		frame = screen.Frame();</a>
<a name="ln1292">		frame.top -= fBar-&gt;Bounds().Height() + 1;</a>
<a name="ln1293">		frame.right += B_V_SCROLL_BAR_WIDTH;</a>
<a name="ln1294">		frame.bottom += B_H_SCROLL_BAR_HEIGHT;</a>
<a name="ln1295"> </a>
<a name="ln1296">		SetFlags(Flags() | B_NOT_RESIZABLE | B_NOT_MOVABLE);</a>
<a name="ln1297"> </a>
<a name="ln1298">		Activate();</a>
<a name="ln1299">			// make the window frontmost</a>
<a name="ln1300">	} else {</a>
<a name="ln1301">		frame = fWindowFrame;</a>
<a name="ln1302"> </a>
<a name="ln1303">		SetFlags(Flags() &amp; ~(B_NOT_RESIZABLE | B_NOT_MOVABLE));</a>
<a name="ln1304">	}</a>
<a name="ln1305"> </a>
<a name="ln1306">	fToolBar-&gt;SetActionVisible(MSG_FULL_SCREEN, fFullScreen);</a>
<a name="ln1307">	_SetToolBarVisible(!fFullScreen &amp;&amp; fShowToolBar);</a>
<a name="ln1308">	_SetToolBarBorder(!fFullScreen);</a>
<a name="ln1309"> </a>
<a name="ln1310">	MoveTo(frame.left, frame.top);</a>
<a name="ln1311">	ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln1312"> </a>
<a name="ln1313">	fImageView-&gt;SetHideIdlingCursor(fFullScreen);</a>
<a name="ln1314">	fImageView-&gt;SetShowCaption(fFullScreen &amp;&amp; fShowCaption);</a>
<a name="ln1315"> </a>
<a name="ln1316">	Layout(false);</a>
<a name="ln1317">		// We need to manually relayout here, as the views are layouted</a>
<a name="ln1318">		// asynchronously, and FitToBounds() would still have the wrong size</a>
<a name="ln1319">	fImageView-&gt;FitToBounds();</a>
<a name="ln1320">}</a>
<a name="ln1321"> </a>
<a name="ln1322"> </a>
<a name="ln1323">void</a>
<a name="ln1324">ShowImageWindow::_ApplySettings()</a>
<a name="ln1325">{</a>
<a name="ln1326">	ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln1327"> </a>
<a name="ln1328">	if (settings-&gt;Lock()) {</a>
<a name="ln1329">		fShowCaption = settings-&gt;GetBool(&quot;ShowCaption&quot;, fShowCaption);</a>
<a name="ln1330">		fPrintOptions.SetBounds(BRect(0, 0, 1023, 767));</a>
<a name="ln1331"> </a>
<a name="ln1332">		fSlideShowDelay = settings-&gt;GetTime(&quot;SlideShowDelay&quot;, fSlideShowDelay);</a>
<a name="ln1333"> </a>
<a name="ln1334">		fPrintOptions.SetOption((enum PrintOptions::Option)settings-&gt;GetInt32(</a>
<a name="ln1335">			&quot;PO:Option&quot;, fPrintOptions.Option()));</a>
<a name="ln1336">		fPrintOptions.SetZoomFactor(</a>
<a name="ln1337">			settings-&gt;GetFloat(&quot;PO:ZoomFactor&quot;, fPrintOptions.ZoomFactor()));</a>
<a name="ln1338">		fPrintOptions.SetDPI(settings-&gt;GetFloat(&quot;PO:DPI&quot;, fPrintOptions.DPI()));</a>
<a name="ln1339">		fPrintOptions.SetWidth(</a>
<a name="ln1340">			settings-&gt;GetFloat(&quot;PO:Width&quot;, fPrintOptions.Width()));</a>
<a name="ln1341">		fPrintOptions.SetHeight(</a>
<a name="ln1342">			settings-&gt;GetFloat(&quot;PO:Height&quot;, fPrintOptions.Height()));</a>
<a name="ln1343"> </a>
<a name="ln1344">		fShowToolBar = settings-&gt;GetBool(&quot;ShowToolBar&quot;, fShowToolBar);</a>
<a name="ln1345"> </a>
<a name="ln1346">		settings-&gt;Unlock();</a>
<a name="ln1347">	}</a>
<a name="ln1348">}</a>
<a name="ln1349"> </a>
<a name="ln1350"> </a>
<a name="ln1351">void</a>
<a name="ln1352">ShowImageWindow::_SavePrintOptions()</a>
<a name="ln1353">{</a>
<a name="ln1354">	ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln1355"> </a>
<a name="ln1356">	if (settings-&gt;Lock()) {</a>
<a name="ln1357">		settings-&gt;SetInt32(&quot;PO:Option&quot;, fPrintOptions.Option());</a>
<a name="ln1358">		settings-&gt;SetFloat(&quot;PO:ZoomFactor&quot;, fPrintOptions.ZoomFactor());</a>
<a name="ln1359">		settings-&gt;SetFloat(&quot;PO:DPI&quot;, fPrintOptions.DPI());</a>
<a name="ln1360">		settings-&gt;SetFloat(&quot;PO:Width&quot;, fPrintOptions.Width());</a>
<a name="ln1361">		settings-&gt;SetFloat(&quot;PO:Height&quot;, fPrintOptions.Height());</a>
<a name="ln1362">		settings-&gt;Unlock();</a>
<a name="ln1363">	}</a>
<a name="ln1364">}</a>
<a name="ln1365"> </a>
<a name="ln1366"> </a>
<a name="ln1367">bool</a>
<a name="ln1368">ShowImageWindow::_PageSetup()</a>
<a name="ln1369">{</a>
<a name="ln1370">	BPrintJob printJob(fImageView-&gt;Image()-&gt;name);</a>
<a name="ln1371">	if (fPrintSettings != NULL)</a>
<a name="ln1372">		printJob.SetSettings(new BMessage(*fPrintSettings));</a>
<a name="ln1373"> </a>
<a name="ln1374">	status_t status = printJob.ConfigPage();</a>
<a name="ln1375">	if (status == B_OK) {</a>
<a name="ln1376">		delete fPrintSettings;</a>
<a name="ln1377">		fPrintSettings = printJob.Settings();</a>
<a name="ln1378">	}</a>
<a name="ln1379"> </a>
<a name="ln1380">	return status == B_OK;</a>
<a name="ln1381">}</a>
<a name="ln1382"> </a>
<a name="ln1383"> </a>
<a name="ln1384">void</a>
<a name="ln1385">ShowImageWindow::_PrepareForPrint()</a>
<a name="ln1386">{</a>
<a name="ln1387">	if (fPrintSettings == NULL) {</a>
<a name="ln1388">		BPrintJob printJob(fImageView-&gt;Image()-&gt;name);</a>
<a name="ln1389">		if (printJob.ConfigJob() == B_OK)</a>
<a name="ln1390">			fPrintSettings = printJob.Settings();</a>
<a name="ln1391">	}</a>
<a name="ln1392"> </a>
<a name="ln1393">	fPrintOptions.SetBounds(fImageView-&gt;Bitmap()-&gt;Bounds());</a>
<a name="ln1394">	fPrintOptions.SetWidth(fImageView-&gt;Bitmap()-&gt;Bounds().Width() + 1);</a>
<a name="ln1395"> </a>
<a name="ln1396">	new PrintOptionsWindow(BPoint(Frame().left + 30, Frame().top + 50),</a>
<a name="ln1397">		&amp;fPrintOptions, this);</a>
<a name="ln1398">}</a>
<a name="ln1399"> </a>
<a name="ln1400"> </a>
<a name="ln1401">void</a>
<a name="ln1402">ShowImageWindow::_Print(BMessage* msg)</a>
<a name="ln1403">{</a>
<a name="ln1404">	status_t st;</a>
<a name="ln1405">	if (msg-&gt;FindInt32(&quot;status&quot;, &amp;st) != B_OK || st != B_OK)</a>
<a name="ln1406">		return;</a>
<a name="ln1407"> </a>
<a name="ln1408">	_SavePrintOptions();</a>
<a name="ln1409"> </a>
<a name="ln1410">	BPrintJob printJob(fImageView-&gt;Image()-&gt;name);</a>
<a name="ln1411">	if (fPrintSettings)</a>
<a name="ln1412">		printJob.SetSettings(new BMessage(*fPrintSettings));</a>
<a name="ln1413"> </a>
<a name="ln1414">	if (printJob.ConfigJob() == B_OK) {</a>
<a name="ln1415">		delete fPrintSettings;</a>
<a name="ln1416">		fPrintSettings = printJob.Settings();</a>
<a name="ln1417"> </a>
<a name="ln1418">		// first/lastPage is unused for now</a>
<a name="ln1419">		int32 firstPage = printJob.FirstPage();</a>
<a name="ln1420">		int32 lastPage = printJob.LastPage();</a>
<a name="ln1421">		BRect printableRect = printJob.PrintableRect();</a>
<a name="ln1422"> </a>
<a name="ln1423">		if (firstPage &lt; 1)</a>
<a name="ln1424">			firstPage = 1;</a>
<a name="ln1425">		if (lastPage &lt; firstPage)</a>
<a name="ln1426">			lastPage = firstPage;</a>
<a name="ln1427"> </a>
<a name="ln1428">		BBitmap* bitmap = fImageView-&gt;Bitmap();</a>
<a name="ln1429">		float imageWidth = bitmap-&gt;Bounds().Width() + 1.0;</a>
<a name="ln1430">		float imageHeight = bitmap-&gt;Bounds().Height() + 1.0;</a>
<a name="ln1431"> </a>
<a name="ln1432">		float width;</a>
<a name="ln1433">		switch (fPrintOptions.Option()) {</a>
<a name="ln1434">			case PrintOptions::kFitToPage: {</a>
<a name="ln1435">				float w1 = printableRect.Width() + 1;</a>
<a name="ln1436">				float w2 = imageWidth * (printableRect.Height() + 1)</a>
<a name="ln1437">					/ imageHeight;</a>
<a name="ln1438">				if (w2 &lt; w1)</a>
<a name="ln1439">					width = w2;</a>
<a name="ln1440">				else</a>
<a name="ln1441">					width = w1;</a>
<a name="ln1442">			}	break;</a>
<a name="ln1443">			case PrintOptions::kZoomFactor:</a>
<a name="ln1444">				width = imageWidth * fPrintOptions.ZoomFactor();</a>
<a name="ln1445">				break;</a>
<a name="ln1446">			case PrintOptions::kDPI:</a>
<a name="ln1447">				width = imageWidth * 72.0 / fPrintOptions.DPI();</a>
<a name="ln1448">				break;</a>
<a name="ln1449">			case PrintOptions::kWidth:</a>
<a name="ln1450">			case PrintOptions::kHeight:</a>
<a name="ln1451">				width = fPrintOptions.Width();</a>
<a name="ln1452">				break;</a>
<a name="ln1453"> </a>
<a name="ln1454">			default:</a>
<a name="ln1455">				// keep compiler silent; should not reach here</a>
<a name="ln1456">				width = imageWidth;</a>
<a name="ln1457">		}</a>
<a name="ln1458"> </a>
<a name="ln1459">		// TODO: eventually print large images on several pages</a>
<a name="ln1460">		printJob.BeginJob();</a>
<a name="ln1461">		fImageView-&gt;SetScale(width / imageWidth);</a>
<a name="ln1462">		// coordinates are relative to printable rectangle</a>
<a name="ln1463">		BRect bounds(bitmap-&gt;Bounds());</a>
<a name="ln1464">		printJob.DrawView(fImageView, bounds, BPoint(0, 0));</a>
<a name="ln1465">		fImageView-&gt;SetScale(1.0);</a>
<a name="ln1466">		printJob.SpoolPage();</a>
<a name="ln1467">		printJob.CommitJob();</a>
<a name="ln1468">	}</a>
<a name="ln1469">}</a>
<a name="ln1470"> </a>
<a name="ln1471"> </a>
<a name="ln1472">void</a>
<a name="ln1473">ShowImageWindow::_SetSlideShowDelay(bigtime_t delay)</a>
<a name="ln1474">{</a>
<a name="ln1475">	if (fSlideShowDelay == delay)</a>
<a name="ln1476">		return;</a>
<a name="ln1477"> </a>
<a name="ln1478">	fSlideShowDelay = delay;</a>
<a name="ln1479"> </a>
<a name="ln1480">	ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln1481">	if (settings-&gt;Lock()) {</a>
<a name="ln1482">		settings-&gt;SetTime(&quot;SlideShowDelay&quot;, fSlideShowDelay);</a>
<a name="ln1483">		settings-&gt;Unlock();</a>
<a name="ln1484">	}</a>
<a name="ln1485"> </a>
<a name="ln1486">	if (fSlideShowRunner != NULL)</a>
<a name="ln1487">		_StartSlideShow();</a>
<a name="ln1488">}</a>
<a name="ln1489"> </a>
<a name="ln1490"> </a>
<a name="ln1491">void</a>
<a name="ln1492">ShowImageWindow::_StartSlideShow()</a>
<a name="ln1493">{</a>
<a name="ln1494">	_StopSlideShow();</a>
<a name="ln1495"> </a>
<a name="ln1496">	BMessage nextSlide(kMsgNextSlide);</a>
<a name="ln1497">	fSlideShowRunner = new BMessageRunner(this, &amp;nextSlide, fSlideShowDelay);</a>
<a name="ln1498">}</a>
<a name="ln1499"> </a>
<a name="ln1500"> </a>
<a name="ln1501">void</a>
<a name="ln1502">ShowImageWindow::_StopSlideShow()</a>
<a name="ln1503">{</a>
<a name="ln1504">	if (fSlideShowRunner != NULL) {</a>
<a name="ln1505">		delete fSlideShowRunner;</a>
<a name="ln1506">		fSlideShowRunner = NULL;</a>
<a name="ln1507">	}</a>
<a name="ln1508">}</a>
<a name="ln1509"> </a>
<a name="ln1510"> </a>
<a name="ln1511">void</a>
<a name="ln1512">ShowImageWindow::_UpdateRatingMenu()</a>
<a name="ln1513">{</a>
<a name="ln1514">	BFile file(&amp;fNavigator.CurrentRef(), B_READ_ONLY);</a>
<a name="ln1515">	if (file.InitCheck() != B_OK)</a>
<a name="ln1516">		return;</a>
<a name="ln1517">	int32 rating;</a>
<a name="ln1518">	ssize_t size = sizeof(rating);</a>
<a name="ln1519">	if (file.ReadAttr(&quot;Media:Rating&quot;, B_INT32_TYPE, 0, &amp;rating, size) != size)</a>
<a name="ln1520">		rating = 0;</a>
<a name="ln1521">	// TODO: Finding the correct item could be more robust, like by looking</a>
<a name="ln1522">	// at the message of each item.</a>
<a name="ln1523">	for (int32 i = 1; i &lt;= 10; i++) {</a>
<a name="ln1524">		BMenuItem* item = fRatingMenu-&gt;ItemAt(i - 1);</a>
<a name="ln1525">		if (item == NULL)</a>
<a name="ln1526">			break;</a>
<a name="ln1527">		item-&gt;SetMarked(i == rating);</a>
<a name="ln1528">	}</a>
<a name="ln1529">}</a>
<a name="ln1530"> </a>
<a name="ln1531"> </a>
<a name="ln1532">void</a>
<a name="ln1533">ShowImageWindow::_SaveWidthAndHeight()</a>
<a name="ln1534">{</a>
<a name="ln1535">	if (fNavigator.CurrentPage() != 1)</a>
<a name="ln1536">		return;</a>
<a name="ln1537"> </a>
<a name="ln1538">	if (fImageView-&gt;Bitmap() == NULL)</a>
<a name="ln1539">		return;</a>
<a name="ln1540"> </a>
<a name="ln1541">	BRect bounds = fImageView-&gt;Bitmap()-&gt;Bounds();</a>
<a name="ln1542">	int32 width = bounds.IntegerWidth() + 1;</a>
<a name="ln1543">	int32 height = bounds.IntegerHeight() + 1;</a>
<a name="ln1544"> </a>
<a name="ln1545">	BNode node(&amp;fNavigator.CurrentRef());</a>
<a name="ln1546">	if (node.InitCheck() != B_OK)</a>
<a name="ln1547">		return;</a>
<a name="ln1548"> </a>
<a name="ln1549">	const char* kWidthAttrName = &quot;Media:Width&quot;;</a>
<a name="ln1550">	const char* kHeightAttrName = &quot;Media:Height&quot;;</a>
<a name="ln1551"> </a>
<a name="ln1552">	int32 widthAttr;</a>
<a name="ln1553">	ssize_t attrSize = node.ReadAttr(kWidthAttrName, B_INT32_TYPE, 0,</a>
<a name="ln1554">		&amp;widthAttr, sizeof(widthAttr));</a>
<a name="ln1555">	if (attrSize &lt;= 0 || widthAttr != width)</a>
<a name="ln1556">		node.WriteAttr(kWidthAttrName, B_INT32_TYPE, 0, &amp;width, sizeof(width));</a>
<a name="ln1557"> </a>
<a name="ln1558">	int32 heightAttr;</a>
<a name="ln1559">	attrSize = node.ReadAttr(kHeightAttrName, B_INT32_TYPE, 0,</a>
<a name="ln1560">		&amp;heightAttr, sizeof(heightAttr));</a>
<a name="ln1561">	if (attrSize &lt;= 0 || heightAttr != height)</a>
<a name="ln1562">		node.WriteAttr(kHeightAttrName, B_INT32_TYPE, 0, &amp;height, sizeof(height));</a>
<a name="ln1563">}</a>
<a name="ln1564"> </a>
<a name="ln1565"> </a>
<a name="ln1566">void</a>
<a name="ln1567">ShowImageWindow::_SetToolBarVisible(bool visible, bool animate)</a>
<a name="ln1568">{</a>
<a name="ln1569">	if (visible == fToolBarVisible)</a>
<a name="ln1570">		return;</a>
<a name="ln1571"> </a>
<a name="ln1572">	fToolBarVisible = visible;</a>
<a name="ln1573">	float diff = fToolBar-&gt;Bounds().Height() + 2;</a>
<a name="ln1574">	if (!visible)</a>
<a name="ln1575">		diff = -diff;</a>
<a name="ln1576">	else</a>
<a name="ln1577">		fToolBar-&gt;Show();</a>
<a name="ln1578"> </a>
<a name="ln1579">	if (animate) {</a>
<a name="ln1580">		// Slide the controls into view. We do this with messages in order</a>
<a name="ln1581">		// not to block the window thread.</a>
<a name="ln1582">		const float kAnimationOffsets[] = { 0.05, 0.2, 0.5, 0.2, 0.05 };</a>
<a name="ln1583">		const int32 steps = sizeof(kAnimationOffsets) / sizeof(float);</a>
<a name="ln1584">		for (int32 i = 0; i &lt; steps; i++) {</a>
<a name="ln1585">			BMessage message(kMsgSlideToolBar);</a>
<a name="ln1586">			message.AddFloat(&quot;offset&quot;, floorf(diff * kAnimationOffsets[i]));</a>
<a name="ln1587">			PostMessage(&amp;message, this);</a>
<a name="ln1588">		}</a>
<a name="ln1589">		BMessage finalMessage(kMsgFinishSlidingToolBar);</a>
<a name="ln1590">		finalMessage.AddFloat(&quot;offset&quot;, visible ? 0 : diff);</a>
<a name="ln1591">		finalMessage.AddBool(&quot;show&quot;, visible);</a>
<a name="ln1592">		PostMessage(&amp;finalMessage, this);</a>
<a name="ln1593">	} else {</a>
<a name="ln1594">		fScrollView-&gt;ResizeBy(0, -diff);</a>
<a name="ln1595">		fScrollView-&gt;MoveBy(0, diff);</a>
<a name="ln1596">		fToolBar-&gt;MoveBy(0, diff);</a>
<a name="ln1597">		if (!visible)</a>
<a name="ln1598">			fToolBar-&gt;Hide();</a>
<a name="ln1599">	}</a>
<a name="ln1600">}</a>
<a name="ln1601"> </a>
<a name="ln1602"> </a>
<a name="ln1603">void</a>
<a name="ln1604">ShowImageWindow::_SetToolBarBorder(bool visible)</a>
<a name="ln1605">{</a>
<a name="ln1606">	float inset = visible</a>
<a name="ln1607">		? ceilf(be_control_look-&gt;DefaultItemSpacing() / 2) : 0;</a>
<a name="ln1608"> </a>
<a name="ln1609">	fToolBar-&gt;GroupLayout()-&gt;SetInsets(inset, 0, inset, 0);</a>
<a name="ln1610">}</a>
<a name="ln1611"> </a>
<a name="ln1612"> </a>
<a name="ln1613">bool</a>
<a name="ln1614">ShowImageWindow::QuitRequested()</a>
<a name="ln1615">{</a>
<a name="ln1616">	if (fSavePanel) {</a>
<a name="ln1617">		// Don't allow this window to be closed if a save panel is open</a>
<a name="ln1618">		return false;</a>
<a name="ln1619">	}</a>
<a name="ln1620"> </a>
<a name="ln1621">	if (!_ClosePrompt())</a>
<a name="ln1622">		return false;</a>
<a name="ln1623"> </a>
<a name="ln1624">	ShowImageSettings* settings = my_app-&gt;Settings();</a>
<a name="ln1625">	if (settings-&gt;Lock()) {</a>
<a name="ln1626">		if (fFullScreen)</a>
<a name="ln1627">			settings-&gt;SetRect(&quot;WindowFrame&quot;, fWindowFrame);</a>
<a name="ln1628">		else</a>
<a name="ln1629">			settings-&gt;SetRect(&quot;WindowFrame&quot;, Frame());</a>
<a name="ln1630">		settings-&gt;Unlock();</a>
<a name="ln1631">	}</a>
<a name="ln1632"> </a>
<a name="ln1633">	be_app-&gt;PostMessage(MSG_WINDOW_HAS_QUIT);</a>
<a name="ln1634"> </a>
<a name="ln1635">	return true;</a>
<a name="ln1636">}</a>

</code></pre>
<div class="balloon" rel="1110"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="1237"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
