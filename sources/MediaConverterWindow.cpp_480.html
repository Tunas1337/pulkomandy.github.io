
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>MediaConverterWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">// Copyright 1999, Be Incorporated. All Rights Reserved.</a>
<a name="ln2">// Copyright 2000-2004, Jun Suzuki. All Rights Reserved.</a>
<a name="ln3">// Copyright 2007, 2010 Stephan AÃŸmus. All Rights Reserved.</a>
<a name="ln4">// Copyright 2010-2013, Haiku, Inc. All Rights Reserved.</a>
<a name="ln5">// This file may be used under the terms of the Be Sample Code License.</a>
<a name="ln6"> </a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;MediaConverterWindow.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;stdio.h&gt;</a>
<a name="ln11">#include &lt;string.h&gt;</a>
<a name="ln12">#include &lt;unistd.h&gt;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;Alert.h&gt;</a>
<a name="ln15">#include &lt;Application.h&gt;</a>
<a name="ln16">#include &lt;Box.h&gt;</a>
<a name="ln17">#include &lt;Button.h&gt;</a>
<a name="ln18">#include &lt;Catalog.h&gt;</a>
<a name="ln19">#include &lt;ControlLook.h&gt;</a>
<a name="ln20">#include &lt;FilePanel.h&gt;</a>
<a name="ln21">#include &lt;FindDirectory.h&gt;</a>
<a name="ln22">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln23">#include &lt;Locale.h&gt;</a>
<a name="ln24">#include &lt;Menu.h&gt;</a>
<a name="ln25">#include &lt;MenuBar.h&gt;</a>
<a name="ln26">#include &lt;MenuField.h&gt;</a>
<a name="ln27">#include &lt;MenuItem.h&gt;</a>
<a name="ln28">#include &lt;Path.h&gt;</a>
<a name="ln29">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln30">#include &lt;Roster.h&gt;</a>
<a name="ln31">#include &lt;ScrollBar.h&gt;</a>
<a name="ln32">#include &lt;ScrollView.h&gt;</a>
<a name="ln33">#include &lt;Slider.h&gt;</a>
<a name="ln34">#include &lt;StringView.h&gt;</a>
<a name="ln35">#include &lt;TextControl.h&gt;</a>
<a name="ln36"> </a>
<a name="ln37">#include &quot;MediaFileInfoView.h&quot;</a>
<a name="ln38">#include &quot;MediaFileListView.h&quot;</a>
<a name="ln39">#include &quot;MessageConstants.h&quot;</a>
<a name="ln40"> </a>
<a name="ln41"> </a>
<a name="ln42">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln43">#define B_TRANSLATION_CONTEXT &quot;MediaConverter&quot;</a>
<a name="ln44">#define VERSION &quot;1.3.0&quot;</a>
<a name="ln45"> </a>
<a name="ln46"> </a>
<a name="ln47">static const unsigned int kMinSourceWidth = 12;</a>
<a name="ln48">static const unsigned int kQualitySliderWidth = 28;</a>
<a name="ln49">static const unsigned int kDurationWidth = 10;</a>
<a name="ln50"> </a>
<a name="ln51"> </a>
<a name="ln52">// #pragma mark - DirectoryFilter</a>
<a name="ln53"> </a>
<a name="ln54"> </a>
<a name="ln55">class DirectoryFilter : public BRefFilter {</a>
<a name="ln56">public:</a>
<a name="ln57">	DirectoryFilter() {};</a>
<a name="ln58">	virtual bool Filter(const entry_ref* ref,</a>
<a name="ln59">		BNode* node, struct stat_beos* st, const char* filetype)</a>
<a name="ln60">	{</a>
<a name="ln61">		// ToDo: Fix this properly in Tracker</a>
<a name="ln62">		// If you create a folder, then rename it, node is NULL.</a>
<a name="ln63">		// The BeBook says: &quot;Note that the function is never sent an</a>
<a name="ln64">		// abstract entry, so the node, st, and filetype arguments will</a>
<a name="ln65">		// always be valid.&quot;</a>
<a name="ln66">		return node == NULL ? false : node-&gt;IsDirectory();</a>
<a name="ln67">	}</a>
<a name="ln68">};</a>
<a name="ln69"> </a>
<a name="ln70"> </a>
<a name="ln71">// #pragma mark - FileFormatMenuItem</a>
<a name="ln72"> </a>
<a name="ln73"> </a>
<a name="ln74">class FileFormatMenuItem : public BMenuItem {</a>
<a name="ln75">public:</a>
<a name="ln76">	FileFormatMenuItem(media_file_format* format);</a>
<a name="ln77">	virtual ~FileFormatMenuItem();</a>
<a name="ln78"> </a>
<a name="ln79">	media_file_format fFileFormat;</a>
<a name="ln80">};</a>
<a name="ln81"> </a>
<a name="ln82"> </a>
<a name="ln83">FileFormatMenuItem::FileFormatMenuItem(media_file_format* format)</a>
<a name="ln84">	:</a>
<a name="ln85">	BMenuItem(format-&gt;pretty_name, new BMessage(FORMAT_SELECT_MESSAGE))</a>
<a name="ln86">{</a>
<a name="ln87">	memcpy(&amp;fFileFormat, format, sizeof(fFileFormat));</a>
<a name="ln88">}</a>
<a name="ln89"> </a>
<a name="ln90"> </a>
<a name="ln91">FileFormatMenuItem::~FileFormatMenuItem()</a>
<a name="ln92">{</a>
<a name="ln93">}</a>
<a name="ln94"> </a>
<a name="ln95"> </a>
<a name="ln96">// #pragma mark - CodecMenuItem</a>
<a name="ln97"> </a>
<a name="ln98"> </a>
<a name="ln99">class CodecMenuItem : public BMenuItem {</a>
<a name="ln100">public:</a>
<a name="ln101">	CodecMenuItem(media_codec_info* ci, uint32 message_type);</a>
<a name="ln102">	virtual ~CodecMenuItem();</a>
<a name="ln103"> </a>
<a name="ln104">	media_codec_info fCodecInfo;</a>
<a name="ln105">};</a>
<a name="ln106"> </a>
<a name="ln107"> </a>
<a name="ln108">CodecMenuItem::CodecMenuItem(media_codec_info* ci, uint32 message_type)</a>
<a name="ln109">	:</a>
<a name="ln110">	BMenuItem(ci-&gt;pretty_name, new BMessage(message_type))</a>
<a name="ln111">{</a>
<a name="ln112">	memcpy(&amp;fCodecInfo, ci, sizeof(fCodecInfo));</a>
<a name="ln113">}</a>
<a name="ln114"> </a>
<a name="ln115"> </a>
<a name="ln116">CodecMenuItem::~CodecMenuItem()</a>
<a name="ln117">{</a>
<a name="ln118">}</a>
<a name="ln119"> </a>
<a name="ln120"> </a>
<a name="ln121">// #pragma mark - OutputBox</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">class OutputBox : public BBox {</a>
<a name="ln125">public:</a>
<a name="ln126">	OutputBox(border_style border, BView* child);</a>
<a name="ln127">	virtual void FrameResized(float width, float height)</a>
<a name="ln128">	{</a>
<a name="ln129">		MediaConverterWindow* window</a>
<a name="ln130">			= dynamic_cast&lt;MediaConverterWindow*&gt;(Window());</a>
<a name="ln131">		if (window != NULL)</a>
<a name="ln132">			window-&gt;TruncateOutputFolderPath();</a>
<a name="ln133">		BBox::FrameResized(width, height);</a>
<a name="ln134">	}</a>
<a name="ln135">};</a>
<a name="ln136"> </a>
<a name="ln137"> </a>
<a name="ln138">OutputBox::OutputBox(border_style border, BView* child)</a>
<a name="ln139">	:</a>
<a name="ln140">	BBox(border, child)</a>
<a name="ln141">{</a>
<a name="ln142">}</a>
<a name="ln143"> </a>
<a name="ln144"> </a>
<a name="ln145">// #pragma mark - MediaConverterWindow</a>
<a name="ln146"> </a>
<a name="ln147"> </a>
<a name="ln148">MediaConverterWindow::MediaConverterWindow(BRect frame)</a>
<a name="ln149">	:</a>
<a name="ln150">	BWindow(frame, B_TRANSLATE_SYSTEM_NAME(&quot;MediaConverter&quot;),</a>
<a name="ln151">		B_TITLED_WINDOW_LOOK, B_NORMAL_WINDOW_FEEL, B_NOT_ZOOMABLE</a>
<a name="ln152">		| B_NOT_V_RESIZABLE | B_ASYNCHRONOUS_CONTROLS</a>
<a name="ln153">		| B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln154">	fVideoQuality(75),</a>
<a name="ln155">	fAudioQuality(75),</a>
<a name="ln156">	fSaveFilePanel(NULL),</a>
<a name="ln157">	fOpenFilePanel(NULL),</a>
<a name="ln158">	fOutputDirSpecified(false),</a>
<a name="ln159">	fEnabled(true),</a>
<a name="ln160">	fConverting(false),</a>
<a name="ln161">	fCancelling(false)</a>
<a name="ln162">{</a>
<a name="ln163">	BPath outputDir;</a>
<a name="ln164">	if (find_directory(B_USER_DIRECTORY, &amp;outputDir) != B_OK)</a>
<a name="ln165">		outputDir.SetTo(&quot;/boot/home&quot;);</a>
<a name="ln166">	fOutputDir.SetTo(outputDir.Path());</a>
<a name="ln167"> </a>
<a name="ln168">	fMenuBar = new BMenuBar(&quot;menubar&quot;);</a>
<a name="ln169">	_CreateMenu();</a>
<a name="ln170"> </a>
<a name="ln171">	float padding = be_control_look-&gt;DefaultItemSpacing();</a>
<a name="ln172"> </a>
<a name="ln173">	fListView = new MediaFileListView();</a>
<a name="ln174">	fListView-&gt;SetExplicitMinSize(BSize(padding * kMinSourceWidth, B_SIZE_UNSET));</a>
<a name="ln175">	BScrollView* scroller = new BScrollView(NULL, fListView, 0, false, true);</a>
<a name="ln176"> </a>
<a name="ln177">	// file list view box</a>
<a name="ln178">	fSourcesBox = new BBox(B_FANCY_BORDER, scroller);</a>
<a name="ln179">	fSourcesBox-&gt;SetLayout(new BGroupLayout(B_HORIZONTAL, 0));</a>
<a name="ln180">		// fSourcesBox's layout adjusted in _UpdateLabels</a>
<a name="ln181"> </a>
<a name="ln182">	// info box</a>
<a name="ln183">	fInfoView = new MediaFileInfoView();</a>
<a name="ln184">	fInfoView-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_USE_FULL_WIDTH,</a>
<a name="ln185">		B_ALIGN_VERTICAL_UNSET));</a>
<a name="ln186">	fInfoBox = new BBox(B_FANCY_BORDER, fInfoView);</a>
<a name="ln187"> </a>
<a name="ln188">	// output menu fields</a>
<a name="ln189">	fFormatMenu = new BMenuField(NULL, B_TRANSLATE(&quot;File format:&quot;),</a>
<a name="ln190">		new BPopUpMenu(&quot;&quot;));</a>
<a name="ln191">	fAudioMenu = new BMenuField(NULL, B_TRANSLATE(&quot;Audio encoding:&quot;),</a>
<a name="ln192">		new BPopUpMenu(&quot;&quot;));</a>
<a name="ln193">	fVideoMenu = new BMenuField(NULL, B_TRANSLATE(&quot;Video encoding:&quot;),</a>
<a name="ln194">		new BPopUpMenu(&quot;&quot;));</a>
<a name="ln195"> </a>
<a name="ln196">	// output folder</a>
<a name="ln197">	fDestButton = new BButton(B_TRANSLATE(&quot;Output folder&quot;),</a>
<a name="ln198">		new BMessage(OUTPUT_FOLDER_MESSAGE));</a>
<a name="ln199">	BAlignment labelAlignment(be_control_look-&gt;DefaultLabelAlignment());</a>
<a name="ln200">	fOutputFolder = new BStringView(NULL, outputDir.Path());</a>
<a name="ln201">	fOutputFolder-&gt;SetExplicitAlignment(labelAlignment);</a>
<a name="ln202"> </a>
<a name="ln203">	// start/end duration</a>
<a name="ln204">	fStartDurationTC = new BTextControl(NULL, &quot;0&quot;, NULL);</a>
<a name="ln205">	BLayoutItem* startDuration = fStartDurationTC-&gt;CreateTextViewLayoutItem();</a>
<a name="ln206">	startDuration-&gt;SetExplicitSize(BSize(padding * kDurationWidth, B_SIZE_UNSET));</a>
<a name="ln207">	startDuration-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln208">		B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln209">	fEndDurationTC = new BTextControl(NULL, &quot;0&quot;, NULL);</a>
<a name="ln210">	BLayoutItem* endDuration = fEndDurationTC-&gt;CreateTextViewLayoutItem();</a>
<a name="ln211">	endDuration-&gt;SetExplicitSize(BSize(padding * kDurationWidth, B_SIZE_UNSET));</a>
<a name="ln212">	endDuration-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln213">		B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln214"> </a>
<a name="ln215">	// video quality</a>
<a name="ln216">	fVideoQualitySlider = new BSlider(&quot;VSlider&quot;, &quot;&quot; ,</a>
<a name="ln217">		new BMessage(VIDEO_QUALITY_CHANGED_MESSAGE), 1, 100, B_HORIZONTAL);</a>
<a name="ln218">	fVideoQualitySlider-&gt;SetModificationMessage(</a>
<a name="ln219">		new BMessage(VIDEO_QUALITY_CHANGED_MESSAGE));</a>
<a name="ln220">	fVideoQualitySlider-&gt;SetValue(fVideoQuality);</a>
<a name="ln221">	fVideoQualitySlider-&gt;SetEnabled(false);</a>
<a name="ln222">	fVideoQualitySlider-&gt;SetExplicitSize(BSize(padding * kQualitySliderWidth,</a>
<a name="ln223">		B_SIZE_UNSET));</a>
<a name="ln224"> </a>
<a name="ln225">	// audio quality</a>
<a name="ln226">	fAudioQualitySlider = new BSlider(&quot;ASlider&quot;, &quot;&quot; ,</a>
<a name="ln227">		new BMessage(AUDIO_QUALITY_CHANGED_MESSAGE), 1, 100, B_HORIZONTAL);</a>
<a name="ln228">	fAudioQualitySlider-&gt;SetModificationMessage(</a>
<a name="ln229">		new BMessage(AUDIO_QUALITY_CHANGED_MESSAGE));</a>
<a name="ln230">	fAudioQualitySlider-&gt;SetValue(fAudioQuality);</a>
<a name="ln231">	fAudioQualitySlider-&gt;SetEnabled(false);</a>
<a name="ln232">	fAudioQualitySlider-&gt;SetExplicitSize(BSize(padding * kQualitySliderWidth,</a>
<a name="ln233">		B_SIZE_UNSET));</a>
<a name="ln234"> </a>
<a name="ln235">	// output format box</a>
<a name="ln236">	BView* outputGrid = BLayoutBuilder::Grid&lt;&gt;()</a>
<a name="ln237">		.Add(fFormatMenu-&gt;CreateLabelLayoutItem(), 0, 0)</a>
<a name="ln238">		.Add(fFormatMenu-&gt;CreateMenuBarLayoutItem(), 1, 0)</a>
<a name="ln239">		.Add(fAudioMenu-&gt;CreateLabelLayoutItem(), 0, 1)</a>
<a name="ln240">		.Add(fAudioMenu-&gt;CreateMenuBarLayoutItem(), 1, 1)</a>
<a name="ln241">		.Add(fVideoMenu-&gt;CreateLabelLayoutItem(), 0, 2)</a>
<a name="ln242">		.Add(fVideoMenu-&gt;CreateMenuBarLayoutItem(), 1, 2)</a>
<a name="ln243">		.Add(fDestButton, 0, 3)</a>
<a name="ln244">		.Add(fOutputFolder, 1, 3)</a>
<a name="ln245">		.Add(fStartDurationTC-&gt;CreateLabelLayoutItem(), 0, 4)</a>
<a name="ln246">		.Add(startDuration, 1, 4)</a>
<a name="ln247">		.Add(fEndDurationTC-&gt;CreateLabelLayoutItem(), 0, 5)</a>
<a name="ln248">		.Add(endDuration, 1, 5)</a>
<a name="ln249">		.Add(fVideoQualitySlider, 0, 6, 2, 1)</a>
<a name="ln250">		.Add(fAudioQualitySlider, 0, 7, 2, 1)</a>
<a name="ln251">		.View();</a>
<a name="ln252">	outputGrid-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_USE_FULL_WIDTH,</a>
<a name="ln253">		B_ALIGN_USE_FULL_HEIGHT));</a>
<a name="ln254">	fOutputBox = new OutputBox(B_FANCY_BORDER, outputGrid);</a>
<a name="ln255">	fOutputBox-&gt;SetLayout(new BGroupLayout(B_HORIZONTAL, 0));</a>
<a name="ln256">		// fOutputBox's layout adjusted in _UpdateLabels</a>
<a name="ln257"> </a>
<a name="ln258">	// buttons</a>
<a name="ln259">	fPreviewButton = new BButton(B_TRANSLATE(&quot;Preview&quot;),</a>
<a name="ln260">		new BMessage(PREVIEW_MESSAGE));</a>
<a name="ln261">	fPreviewButton-&gt;SetEnabled(false);</a>
<a name="ln262"> </a>
<a name="ln263">	fConvertButton = new BButton(B_TRANSLATE(&quot;Convert&quot;),</a>
<a name="ln264">		new BMessage(CONVERT_BUTTON_MESSAGE));</a>
<a name="ln265"> </a>
<a name="ln266">	// Status views</a>
<a name="ln267">	fStatus = new BStringView(NULL, NULL);</a>
<a name="ln268">	fStatus-&gt;SetExplicitAlignment(labelAlignment);</a>
<a name="ln269">	fFileStatus = new BStringView(NULL, NULL);</a>
<a name="ln270">	fFileStatus-&gt;SetExplicitAlignment(labelAlignment);</a>
<a name="ln271"> </a>
<a name="ln272">	SetStatusMessage(&quot;&quot;);</a>
<a name="ln273">	_UpdateLabels();</a>
<a name="ln274"> </a>
<a name="ln275">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln276">		.SetInsets(0, 0, 0, 0)</a>
<a name="ln277">		.Add(fMenuBar)</a>
<a name="ln278">		.AddSplit(B_HORIZONTAL, B_USE_DEFAULT_SPACING)</a>
<a name="ln279">			.SetInsets(B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING,</a>
<a name="ln280">				B_USE_WINDOW_SPACING, 0)</a>
<a name="ln281">			.Add(fSourcesBox)</a>
<a name="ln282">			.AddGroup(B_VERTICAL, B_USE_ITEM_SPACING)</a>
<a name="ln283">				.Add(fInfoBox)</a>
<a name="ln284">				.Add(fOutputBox)</a>
<a name="ln285">			.End()</a>
<a name="ln286">		.End()</a>
<a name="ln287">		.AddGrid(B_USE_ITEM_SPACING)</a>
<a name="ln288">			.SetInsets(B_USE_WINDOW_SPACING, B_USE_DEFAULT_SPACING,</a>
<a name="ln289">				B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING)</a>
<a name="ln290">			.Add(fStatus, 0, 0)</a>
<a name="ln291">			.Add(fFileStatus, 0, 1)</a>
<a name="ln292">			.Add(BSpaceLayoutItem::CreateGlue(), 1, 0)</a>
<a name="ln293">			.Add(fPreviewButton, 2, 0)</a>
<a name="ln294">			.Add(fConvertButton, 3, 0)</a>
<a name="ln295">		.End();</a>
<a name="ln296">}</a>
<a name="ln297"> </a>
<a name="ln298"> </a>
<a name="ln299">MediaConverterWindow::~MediaConverterWindow()</a>
<a name="ln300">{</a>
<a name="ln301">	delete fSaveFilePanel;</a>
<a name="ln302">	delete fOpenFilePanel;</a>
<a name="ln303">}</a>
<a name="ln304"> </a>
<a name="ln305"> </a>
<a name="ln306">// #pragma mark -</a>
<a name="ln307"> </a>
<a name="ln308"> </a>
<a name="ln309">void</a>
<a name="ln310">MediaConverterWindow::MessageReceived(BMessage* message)</a>
<a name="ln311">{</a>
<a name="ln312">	entry_ref inRef;</a>
<a name="ln313"> </a>
<a name="ln314">	char buffer[40];</a>
<a name="ln315">	BEntry inEntry;</a>
<a name="ln316"> </a>
<a name="ln317">	switch (message-&gt;what) {</a>
<a name="ln318">		#if B_BEOS_VERSION &lt;= B_BEOS_VERSION_6</a>
<a name="ln319">		case B_LANGUAGE_CHANGED:</a>
<a name="ln320">			LanguageChanged();</a>
<a name="ln321">			break;</a>
<a name="ln322">		#endif</a>
<a name="ln323"> </a>
<a name="ln324">		case INIT_FORMAT_MENUS:</a>
<a name="ln325">			BuildFormatMenu();</a>
<a name="ln326">			if (CountSourceFiles() == 0)</a>
<a name="ln327">				SetEnabled(false, false);</a>
<a name="ln328">			break;</a>
<a name="ln329"> </a>
<a name="ln330">		case B_SIMPLE_DATA:</a>
<a name="ln331">			if (message-&gt;WasDropped()) {</a>
<a name="ln332">				DetachCurrentMessage();</a>
<a name="ln333">				message-&gt;what = B_REFS_RECEIVED;</a>
<a name="ln334">				BMessenger(be_app).SendMessage(message);</a>
<a name="ln335">				delete message;</a>
<a name="ln336">			}</a>
<a name="ln337">			break;</a>
<a name="ln338"> </a>
<a name="ln339">		case FORMAT_SELECT_MESSAGE:</a>
<a name="ln340">			BuildAudioVideoMenus();</a>
<a name="ln341">			break;</a>
<a name="ln342">		case AUDIO_CODEC_SELECT_MESSAGE:</a>
<a name="ln343">			break;</a>
<a name="ln344">		case VIDEO_CODEC_SELECT_MESSAGE:</a>
<a name="ln345">			break;</a>
<a name="ln346"> </a>
<a name="ln347">		case CONVERT_BUTTON_MESSAGE:</a>
<a name="ln348">			if (!fConverting) {</a>
<a name="ln349">				fConvertButton-&gt;SetLabel(B_TRANSLATE(&quot;Cancel&quot;));</a>
<a name="ln350">				fConverting = true;</a>
<a name="ln351">				SetStatusMessage(B_TRANSLATE(&quot;Convert&quot;));</a>
<a name="ln352">				SetEnabled(false, true);</a>
<a name="ln353">				BMessenger(be_app).SendMessage(START_CONVERSION_MESSAGE);</a>
<a name="ln354">			} else if (!fCancelling) {</a>
<a name="ln355">				fCancelling = true;</a>
<a name="ln356">				SetStatusMessage(B_TRANSLATE(&quot;Cancelling&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln357">				BMessenger(be_app).SendMessage(CANCEL_CONVERSION_MESSAGE);</a>
<a name="ln358">			}</a>
<a name="ln359">			break;</a>
<a name="ln360"> </a>
<a name="ln361">		case CONVERSION_DONE_MESSAGE:</a>
<a name="ln362">		{</a>
<a name="ln363">			SetStatusMessage(fCancelling ? B_TRANSLATE(&quot;Conversion cancelled&quot;)</a>
<a name="ln364">				: B_TRANSLATE(&quot;Conversion completed&quot;));</a>
<a name="ln365">			fConverting = false;</a>
<a name="ln366">			fCancelling = false;</a>
<a name="ln367">			bool enable = CountSourceFiles() &gt; 0;</a>
<a name="ln368">			SetEnabled(enable, enable);</a>
<a name="ln369">			fConvertButton-&gt;SetLabel(B_TRANSLATE(&quot;Convert&quot;));</a>
<a name="ln370">			break;</a>
<a name="ln371">		}</a>
<a name="ln372"> </a>
<a name="ln373">		case OUTPUT_FOLDER_MESSAGE:</a>
<a name="ln374">			// Execute Save Panel</a>
<a name="ln375">			if (fSaveFilePanel == NULL) {</a>
<a name="ln376">				BButton* selectThisDir;</a>
<a name="ln377"> </a>
<a name="ln378">				BMessage folderSelect(FOLDER_SELECT_MESSAGE);</a>
<a name="ln379">				fSaveFilePanel = new BFilePanel(B_OPEN_PANEL, NULL, NULL,</a>
<a name="ln380">					B_DIRECTORY_NODE, true, &amp;folderSelect, NULL, false, true);</a>
<a name="ln381">				fSaveFilePanel-&gt;SetButtonLabel(B_DEFAULT_BUTTON,</a>
<a name="ln382">					B_TRANSLATE(&quot;Select&quot;));</a>
<a name="ln383">				fSaveFilePanel-&gt;SetTarget(this);</a>
<a name="ln384"> </a>
<a name="ln385">				fSaveFilePanel-&gt;Window()-&gt;Lock();</a>
<a name="ln386">				fSaveFilePanel-&gt;Window()-&gt;SetTitle(</a>
<a name="ln387">					B_TRANSLATE(&quot;MediaConverter+:SaveDirectory&quot;));</a>
<a name="ln388">				BRect buttonRect</a>
<a name="ln389">					= fSaveFilePanel-&gt;Window()-&gt;ChildAt(0)-&gt;FindView(</a>
<a name="ln390">						&quot;cancel button&quot;)-&gt;Frame();</a>
<a name="ln391">				buttonRect.right  = buttonRect.left - 20;</a>
<a name="ln392">				buttonRect.left = buttonRect.right - 130;</a>
<a name="ln393">				selectThisDir = new BButton(buttonRect, NULL,</a>
<a name="ln394">					B_TRANSLATE(&quot;Select this folder&quot;),</a>
<a name="ln395">					new BMessage(SELECT_THIS_DIR_MESSAGE),</a>
<a name="ln396">					B_FOLLOW_BOTTOM | B_FOLLOW_RIGHT);</a>
<a name="ln397">				selectThisDir-&gt;SetTarget(this);</a>
<a name="ln398">				fSaveFilePanel-&gt;Window()-&gt;ChildAt(0)-&gt;AddChild(selectThisDir);</a>
<a name="ln399">				fSaveFilePanel-&gt;Window()-&gt;Unlock();</a>
<a name="ln400"> </a>
<a name="ln401">				fSaveFilePanel-&gt;SetRefFilter(new DirectoryFilter);</a>
<a name="ln402">			}</a>
<a name="ln403">			fSaveFilePanel-&gt;Show();</a>
<a name="ln404">			break;</a>
<a name="ln405"> </a>
<a name="ln406">		case FOLDER_SELECT_MESSAGE:</a>
<a name="ln407">			// &quot;SELECT&quot; Button at Save Panel Pushed</a>
<a name="ln408">			fSaveFilePanel-&gt;GetNextSelectedRef(&amp;inRef);</a>
<a name="ln409">			inEntry.SetTo(&amp;inRef, true);</a>
<a name="ln410">			_SetOutputFolder(inEntry);</a>
<a name="ln411">			fOutputDirSpecified = true;</a>
<a name="ln412">			fSaveFilePanel-&gt;Rewind();</a>
<a name="ln413">			break;</a>
<a name="ln414"> </a>
<a name="ln415">		case SELECT_THIS_DIR_MESSAGE:</a>
<a name="ln416">			// &quot;THIS DIR&quot; Button at Save Panel Pushed</a>
<a name="ln417">			fSaveFilePanel-&gt;GetPanelDirectory(&amp;inRef);</a>
<a name="ln418">			fSaveFilePanel-&gt;Hide();</a>
<a name="ln419">			inEntry.SetTo(&amp;inRef, true);</a>
<a name="ln420">			_SetOutputFolder(inEntry);</a>
<a name="ln421">			fOutputDirSpecified = true;</a>
<a name="ln422">			break;</a>
<a name="ln423"> </a>
<a name="ln424">		case OPEN_FILE_MESSAGE:</a>
<a name="ln425">			// Execute Open Panel</a>
<a name="ln426">			if (!fOpenFilePanel) {</a>
<a name="ln427">				fOpenFilePanel = new BFilePanel(B_OPEN_PANEL, NULL, NULL,</a>
<a name="ln428">					B_FILE_NODE, true, NULL, NULL, false, true);</a>
<a name="ln429">				fOpenFilePanel-&gt;SetTarget(this);</a>
<a name="ln430">			}</a>
<a name="ln431">			fOpenFilePanel-&gt;Show();</a>
<a name="ln432">			break;</a>
<a name="ln433"> </a>
<a name="ln434">		case B_REFS_RECEIVED:</a>
<a name="ln435">			// Media Files Seleced by Open Panel</a>
<a name="ln436">			DetachCurrentMessage();</a>
<a name="ln437">			message-&gt;what = B_REFS_RECEIVED;</a>
<a name="ln438">			BMessenger(be_app).SendMessage(message);</a>
<a name="ln439">			// fall through</a>
<a name="ln440"> </a>
<a name="ln441">		case B_CANCEL:</a>
<a name="ln442">			break;</a>
<a name="ln443"> </a>
<a name="ln444">		case QUIT_MESSAGE:</a>
<a name="ln445">			MediaConverterWindow::QuitRequested();</a>
<a name="ln446">			break;</a>
<a name="ln447"> </a>
<a name="ln448">		case PREVIEW_MESSAGE:</a>
<a name="ln449">		{</a>
<a name="ln450">			// Build the command line to launch the preview application.</a>
<a name="ln451">			// TODO: Launch the default app instead of hardcoded MediaPlayer!</a>
<a name="ln452">			int32 srcIndex = fListView-&gt;CurrentSelection();</a>
<a name="ln453">			BMediaFile* inFile = NULL;</a>
<a name="ln454">			status_t status = GetSourceFileAt(srcIndex, &amp;inFile, &amp;inRef);</a>
<a name="ln455"> </a>
<a name="ln456">			const char* argv[3];</a>
<a name="ln457">			BString startPosString;</a>
<a name="ln458">			BPath path;</a>
<a name="ln459"> </a>
<a name="ln460">			if (status == B_OK) {</a>
<a name="ln461">				argv[0] = &quot;-pos&quot;;</a>
<a name="ln462">					// NOTE: -pos argument is currently not supported by Haiku</a>
<a name="ln463">					// MediaPlayer.</a>
<a name="ln464">				startPosString &lt;&lt; fStartDurationTC-&gt;Text();</a>
<a name="ln465">				startPosString &lt;&lt; &quot;000&quot;;</a>
<a name="ln466">				argv[1] = startPosString.String();</a>
<a name="ln467"> </a>
<a name="ln468">				status = inEntry.SetTo(&amp;inRef);</a>
<a name="ln469">			}</a>
<a name="ln470"> </a>
<a name="ln471">			if (status == B_OK) {</a>
<a name="ln472">				status = inEntry.GetPath(&amp;path);</a>
<a name="ln473">				if (status == B_OK)</a>
<a name="ln474">					argv[2] = path.Path();</a>
<a name="ln475">			}</a>
<a name="ln476"> </a>
<a name="ln477">			if (status == B_OK) {</a>
<a name="ln478">				status = be_roster-&gt;Launch(</a>
<a name="ln479">					&quot;application/x-vnd.Haiku-MediaPlayer&quot;,</a>
<a name="ln480">					3, (char**)argv, NULL);</a>
<a name="ln481">			}</a>
<a name="ln482"> </a>
<a name="ln483">			if (status != B_OK &amp;&amp; status != B_ALREADY_RUNNING) {</a>
<a name="ln484">				BString errorString(B_TRANSLATE(&quot;Error launching: %strError%&quot;));</a>
<a name="ln485">				errorString.ReplaceFirst(&quot;%strError%&quot;, strerror(status));</a>
<a name="ln486">				BAlert* alert = new BAlert(B_TRANSLATE(&quot;Error&quot;),</a>
<a name="ln487">					errorString.String(), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln488">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln489">				alert-&gt;Go();</a>
<a name="ln490">			}</a>
<a name="ln491">			break;</a>
<a name="ln492">		}</a>
<a name="ln493"> </a>
<a name="ln494">		case VIDEO_QUALITY_CHANGED_MESSAGE:</a>
<a name="ln495">		{</a>
<a name="ln496">			int32 value;</a>
<a name="ln497">			message-&gt;FindInt32(&quot;be:value&quot;, &amp;value);</a>
<a name="ln498">			snprintf(buffer, sizeof(buffer),</a>
<a name="ln499">				B_TRANSLATE(&quot;Video quality: %3d%%&quot;), (int8)value);</a>
<a name="ln500">			fVideoQualitySlider-&gt;SetLabel(buffer);</a>
<a name="ln501">			fVideoQuality = value;</a>
<a name="ln502">			break;</a>
<a name="ln503">		}</a>
<a name="ln504"> </a>
<a name="ln505">		case AUDIO_QUALITY_CHANGED_MESSAGE:</a>
<a name="ln506">		{</a>
<a name="ln507">			int32 value;</a>
<a name="ln508">			message-&gt;FindInt32(&quot;be:value&quot;, &amp;value);</a>
<a name="ln509">			snprintf(buffer, sizeof(buffer),</a>
<a name="ln510">				B_TRANSLATE(&quot;Audio quality: %3d%%&quot;), (int8)value);</a>
<a name="ln511">			fAudioQualitySlider-&gt;SetLabel(buffer);</a>
<a name="ln512">			fAudioQuality = value;</a>
<a name="ln513">			break;</a>
<a name="ln514">		}</a>
<a name="ln515"> </a>
<a name="ln516">		default:</a>
<a name="ln517">			BWindow::MessageReceived(message);</a>
<a name="ln518">	}</a>
<a name="ln519">}</a>
<a name="ln520"> </a>
<a name="ln521"> </a>
<a name="ln522">bool</a>
<a name="ln523">MediaConverterWindow::QuitRequested()</a>
<a name="ln524">{</a>
<a name="ln525">	if (!fConverting) {</a>
<a name="ln526">		BMessenger(be_app).SendMessage(B_QUIT_REQUESTED);</a>
<a name="ln527">		return true;</a>
<a name="ln528">	} else if (!fCancelling) {</a>
<a name="ln529">		fCancelling = true;</a>
<a name="ln530">		SetStatusMessage(B_TRANSLATE(&quot;Cancelling&quot;));</a>
<a name="ln531">		BMessenger(be_app).SendMessage(CANCEL_CONVERSION_MESSAGE);</a>
<a name="ln532">	}</a>
<a name="ln533"> </a>
<a name="ln534">	return false;</a>
<a name="ln535">}</a>
<a name="ln536"> </a>
<a name="ln537"> </a>
<a name="ln538">// #pragma mark -</a>
<a name="ln539"> </a>
<a name="ln540"> </a>
<a name="ln541">void</a>
<a name="ln542">MediaConverterWindow::LanguageChanged()</a>
<a name="ln543">{</a>
<a name="ln544">	_DestroyMenu();</a>
<a name="ln545">	_CreateMenu();</a>
<a name="ln546">	_UpdateLabels();</a>
<a name="ln547">	BuildAudioVideoMenus();</a>
<a name="ln548">	Lock();</a>
<a name="ln549">	fInfoView-&gt;Invalidate();</a>
<a name="ln550">	Unlock();</a>
<a name="ln551">}</a>
<a name="ln552"> </a>
<a name="ln553"> </a>
<a name="ln554">void</a>
<a name="ln555">MediaConverterWindow::BuildAudioVideoMenus()</a>
<a name="ln556">{</a>
<a name="ln557">	BMenu* menu = fAudioMenu-&gt;Menu();</a>
<a name="ln558">	BMenuItem* item;</a>
<a name="ln559"> </a>
<a name="ln560">	// clear out old audio codec menu items</a>
<a name="ln561">	while ((item = menu-&gt;RemoveItem((int32)0)) != NULL)</a>
<a name="ln562">		delete item;</a>
<a name="ln563"> </a>
<a name="ln564">	bool separator = true;</a>
<a name="ln565"> </a>
<a name="ln566">	// get selected file format</a>
<a name="ln567">	FileFormatMenuItem* ffmi</a>
<a name="ln568">		= (FileFormatMenuItem*)fFormatMenu-&gt;Menu()-&gt;FindMarked();</a>
<a name="ln569">	media_file_format* mf_format = &amp;(ffmi-&gt;fFileFormat);</a>
<a name="ln570"> </a>
<a name="ln571">	media_format format, outfmt;</a>
<a name="ln572">	format.Clear();</a>
<a name="ln573">	media_codec_info codec_info;</a>
<a name="ln574">	int32 cookie = 0;</a>
<a name="ln575">	CodecMenuItem* cmi;</a>
<a name="ln576"> </a>
<a name="ln577">	// add available audio encoders to menu</a>
<a name="ln578">	format.type = B_MEDIA_RAW_AUDIO;</a>
<a name="ln579">	format.u.raw_audio = media_raw_audio_format::wildcard;</a>
<a name="ln580">	while (get_next_encoder(&amp;cookie, mf_format, &amp;format, &amp;outfmt, &amp;codec_info)</a>
<a name="ln581">			== B_OK) {</a>
<a name="ln582">		if (separator) {</a>
<a name="ln583">			menu-&gt;AddItem(new BMenuItem(</a>
<a name="ln584">				B_TRANSLATE_CONTEXT(&quot;No audio&quot;, &quot;Audio codecs list&quot;),</a>
<a name="ln585">				new BMessage(AUDIO_CODEC_SELECT_MESSAGE)));</a>
<a name="ln586">			menu-&gt;AddSeparatorItem();</a>
<a name="ln587">			separator = false;</a>
<a name="ln588">		}</a>
<a name="ln589"> </a>
<a name="ln590">		cmi = new CodecMenuItem(&amp;codec_info, AUDIO_CODEC_SELECT_MESSAGE);</a>
<a name="ln591">		menu-&gt;AddItem(cmi);</a>
<a name="ln592">		// reset media format struct</a>
<a name="ln593">/*</a>
<a name="ln594">		format.type = B_MEDIA_RAW_AUDIO;</a>
<a name="ln595">		format.u.raw_audio = media_raw_audio_format::wildcard;</a>
<a name="ln596">*/</a>
<a name="ln597">	}</a>
<a name="ln598"> </a>
<a name="ln599">	// mark first audio encoder</a>
<a name="ln600">	item = menu-&gt;ItemAt(0);</a>
<a name="ln601">	if (item != NULL) {</a>
<a name="ln602">		fAudioMenu-&gt;SetEnabled(fEnabled);</a>
<a name="ln603">		fAudioQualitySlider-&gt;SetEnabled(fEnabled);</a>
<a name="ln604">		item-&gt;SetMarked(true);</a>
<a name="ln605">		((BInvoker*)item)-&gt;Invoke();</a>
<a name="ln606">	} else {</a>
<a name="ln607">		item = new BMenuItem(</a>
<a name="ln608">			B_TRANSLATE_CONTEXT(&quot;None available&quot;, &quot;Audio codecs&quot;), NULL);</a>
<a name="ln609">		menu-&gt;AddItem(item);</a>
<a name="ln610">		item-&gt;SetMarked(true);</a>
<a name="ln611">		fAudioMenu-&gt;SetEnabled(false);</a>
<a name="ln612">		fAudioQualitySlider-&gt;SetEnabled(false);</a>
<a name="ln613">	}</a>
<a name="ln614"> </a>
<a name="ln615">	// clear out old video codec menu items</a>
<a name="ln616">	menu = fVideoMenu-&gt;Menu();</a>
<a name="ln617">	while ((item = menu-&gt;RemoveItem((int32)0)) != NULL)</a>
<a name="ln618">		delete item;</a>
<a name="ln619"> </a>
<a name="ln620">	separator = true;</a>
<a name="ln621"> </a>
<a name="ln622">	// construct a generic video format.  Some of these parameters</a>
<a name="ln623">	// seem silly, but are needed for R4.5.x, which is more picky</a>
<a name="ln624">	// than subsequent BeOS releases will be.</a>
<a name="ln625">	format.Clear();</a>
<a name="ln626">	format.type = B_MEDIA_RAW_VIDEO;</a>
<a name="ln627">	format.u.raw_video.last_active = (uint32)(240 - 1);</a>
<a name="ln628">	format.u.raw_video.orientation = B_VIDEO_TOP_LEFT_RIGHT;</a>
<a name="ln629">	format.u.raw_video.display.format = B_RGB32;</a>
<a name="ln630">	format.u.raw_video.display.line_width = (int32)320;</a>
<a name="ln631">	format.u.raw_video.display.line_count = (int32)240;</a>
<a name="ln632">	format.u.raw_video.display.bytes_per_row = 4 * 320;</a>
<a name="ln633"> </a>
<a name="ln634">	// add available video encoders to menu</a>
<a name="ln635">	cookie = 0;</a>
<a name="ln636">	while (get_next_encoder(&amp;cookie, mf_format, &amp;format, &amp;outfmt, &amp;codec_info)</a>
<a name="ln637">			== B_OK) {</a>
<a name="ln638">		if (separator) {</a>
<a name="ln639">			menu-&gt;AddItem(new BMenuItem(</a>
<a name="ln640">				B_TRANSLATE_CONTEXT(&quot;No video&quot;, &quot;Video codecs list&quot;),</a>
<a name="ln641">				new BMessage(VIDEO_CODEC_SELECT_MESSAGE)));</a>
<a name="ln642">			menu-&gt;AddSeparatorItem();</a>
<a name="ln643">			separator = false;</a>
<a name="ln644">		}</a>
<a name="ln645"> </a>
<a name="ln646">		cmi = new CodecMenuItem(&amp;codec_info, VIDEO_CODEC_SELECT_MESSAGE);</a>
<a name="ln647">		menu-&gt;AddItem(cmi);</a>
<a name="ln648">	}</a>
<a name="ln649"> </a>
<a name="ln650">	// mark first video encoder</a>
<a name="ln651">	item = menu-&gt;ItemAt(0);</a>
<a name="ln652">	if (item != NULL) {</a>
<a name="ln653">		fVideoMenu-&gt;SetEnabled(fEnabled);</a>
<a name="ln654">		fVideoQualitySlider-&gt;SetEnabled(fEnabled);</a>
<a name="ln655">		item-&gt;SetMarked(true);</a>
<a name="ln656">		((BInvoker*)item)-&gt;Invoke();</a>
<a name="ln657">	} else {</a>
<a name="ln658">		item = new BMenuItem(</a>
<a name="ln659">			B_TRANSLATE_CONTEXT(&quot;None available&quot;, &quot;Video codecs&quot;), NULL);</a>
<a name="ln660">		menu-&gt;AddItem(item);</a>
<a name="ln661">		item-&gt;SetMarked(true);</a>
<a name="ln662">		fVideoMenu-&gt;SetEnabled(false);</a>
<a name="ln663">		fVideoQualitySlider-&gt;SetEnabled(false);</a>
<a name="ln664">	}</a>
<a name="ln665">}</a>
<a name="ln666"> </a>
<a name="ln667">void</a>
<a name="ln668">MediaConverterWindow::GetSelectedFormatInfo(media_file_format** format,</a>
<a name="ln669">	media_codec_info** audio, media_codec_info** video)</a>
<a name="ln670">{</a>
<a name="ln671">	*audio = NULL;</a>
<a name="ln672">	*video = NULL;</a>
<a name="ln673">	*format = NULL;</a>
<a name="ln674"> </a>
<a name="ln675">	FileFormatMenuItem* formatItem =</a>
<a name="ln676">		dynamic_cast&lt;FileFormatMenuItem*&gt;(fFormatMenu-&gt;Menu()-&gt;FindMarked());</a>
<a name="ln677">	if (formatItem != NULL)</a>
<a name="ln678">		*format = &amp;(formatItem-&gt;fFileFormat);</a>
<a name="ln679"> </a>
<a name="ln680">	*audio = *video = NULL;</a>
<a name="ln681">	CodecMenuItem* codecItem =</a>
<a name="ln682">		dynamic_cast&lt;CodecMenuItem*&gt;(fAudioMenu-&gt;Menu()-&gt;FindMarked());</a>
<a name="ln683">	if (codecItem != NULL)</a>
<a name="ln684">		*audio =  &amp;(codecItem-&gt;fCodecInfo);</a>
<a name="ln685"> </a>
<a name="ln686">	codecItem = dynamic_cast&lt;CodecMenuItem*&gt;(fVideoMenu-&gt;Menu()-&gt;FindMarked());</a>
<a name="ln687">	if (codecItem != NULL)</a>
<a name="ln688">		*video =  &amp;(codecItem-&gt;fCodecInfo);</a>
<a name="ln689">}</a>
<a name="ln690"> </a>
<a name="ln691"> </a>
<a name="ln692">void</a>
<a name="ln693">MediaConverterWindow::BuildFormatMenu()</a>
<a name="ln694">{</a>
<a name="ln695">	BMenu* menu = fFormatMenu-&gt;Menu();</a>
<a name="ln696">	BMenuItem* item;</a>
<a name="ln697"> </a>
<a name="ln698">	// clear out old format menu items</a>
<a name="ln699">	while ((item = menu-&gt;RemoveItem((int32)0)) != NULL)</a>
<a name="ln700">		delete item;</a>
<a name="ln701"> </a>
<a name="ln702">	// add menu items for each file format</a>
<a name="ln703">	media_file_format mfi;</a>
<a name="ln704">	int32 cookie = 0;</a>
<a name="ln705">	FileFormatMenuItem* ff_item;</a>
<a name="ln706">	while (get_next_file_format(&amp;cookie, &amp;mfi) == B_OK) {</a>
<a name="ln707">		if ((mfi.capabilities &amp; media_file_format::B_WRITABLE) == 0)</a>
<a name="ln708">			continue;</a>
<a name="ln709">		ff_item = new FileFormatMenuItem(&amp;mfi);</a>
<a name="ln710">		menu-&gt;AddItem(ff_item);</a>
<a name="ln711">	}</a>
<a name="ln712"> </a>
<a name="ln713">	// mark first item</a>
<a name="ln714">	item = menu-&gt;ItemAt(0);</a>
<a name="ln715">	if (item != NULL) {</a>
<a name="ln716">		item-&gt;SetMarked(true);</a>
<a name="ln717">		((BInvoker*)item)-&gt;Invoke();</a>
<a name="ln718">	}</a>
<a name="ln719">}</a>
<a name="ln720"> </a>
<a name="ln721"> </a>
<a name="ln722">void</a>
<a name="ln723">MediaConverterWindow::SetFileMessage(const char* message)</a>
<a name="ln724">{</a>
<a name="ln725">	fFileStatus-&gt;SetText(message);</a>
<a name="ln726">}</a>
<a name="ln727"> </a>
<a name="ln728"> </a>
<a name="ln729">void</a>
<a name="ln730">MediaConverterWindow::SetStatusMessage(const char* message)</a>
<a name="ln731">{</a>
<a name="ln732">	fStatus-&gt;SetText(message);</a>
<a name="ln733">}</a>
<a name="ln734"> </a>
<a name="ln735"> </a>
<a name="ln736">// #pragma mark -</a>
<a name="ln737"> </a>
<a name="ln738"> </a>
<a name="ln739">bool</a>
<a name="ln740">MediaConverterWindow::AddSourceFile(BMediaFile* file, const entry_ref&amp; ref)</a>
<a name="ln741">{</a>
<a name="ln742">	if (!fListView-&gt;AddMediaItem(file, ref))</a>
<a name="ln743">		return false;</a>
<a name="ln744"> </a>
<a name="ln745">	if (!fOutputDirSpecified) {</a>
<a name="ln746">		BEntry entry(&amp;ref);</a>
<a name="ln747">		entry.GetParent(&amp;entry);</a>
<a name="ln748">		_SetOutputFolder(entry);</a>
<a name="ln749">	}</a>
<a name="ln750"> </a>
<a name="ln751">	return true;</a>
<a name="ln752">}</a>
<a name="ln753"> </a>
<a name="ln754"> </a>
<a name="ln755">void</a>
<a name="ln756">MediaConverterWindow::RemoveSourceFile(int32 index)</a>
<a name="ln757">{</a>
<a name="ln758">	delete fListView-&gt;RemoveItem(index);</a>
<a name="ln759">	fStartDurationTC-&gt;SetText(&quot;0&quot;);</a>
<a name="ln760">	fEndDurationTC-&gt;SetText(&quot;0&quot;);</a>
<a name="ln761">}</a>
<a name="ln762"> </a>
<a name="ln763"> </a>
<a name="ln764">int32</a>
<a name="ln765">MediaConverterWindow::CountSourceFiles()</a>
<a name="ln766">{</a>
<a name="ln767">	return fListView-&gt;CountItems();</a>
<a name="ln768">}</a>
<a name="ln769"> </a>
<a name="ln770"> </a>
<a name="ln771">status_t</a>
<a name="ln772">MediaConverterWindow::GetSourceFileAt(int32 index, BMediaFile** _file,</a>
<a name="ln773">	entry_ref* ref)</a>
<a name="ln774">{</a>
<a name="ln775">	MediaFileListItem* item = dynamic_cast&lt;MediaFileListItem*&gt;(</a>
<a name="ln776">		fListView-&gt;ItemAt(index));</a>
<a name="ln777">	if (item != NULL) {</a>
<a name="ln778">		*_file = item-&gt;fMediaFile;</a>
<a name="ln779">		*ref = item-&gt;fRef;</a>
<a name="ln780">		return B_OK;</a>
<a name="ln781">	} else</a>
<a name="ln782">		return B_ERROR;</a>
<a name="ln783">}</a>
<a name="ln784"> </a>
<a name="ln785"> </a>
<a name="ln786">void</a>
<a name="ln787">MediaConverterWindow::SourceFileSelectionChanged()</a>
<a name="ln788">{</a>
<a name="ln789">	int32 selected = fListView-&gt;CurrentSelection();</a>
<a name="ln790">	BMediaFile* file = NULL;</a>
<a name="ln791">	entry_ref ref;</a>
<a name="ln792">	bool enabled = GetSourceFileAt(selected, &amp;file, &amp;ref) == B_OK;</a>
<a name="ln793"> </a>
<a name="ln794">	fPreviewButton-&gt;SetEnabled(enabled);</a>
<a name="ln795">	fVideoQualitySlider-&gt;SetEnabled(enabled);</a>
<a name="ln796">	fAudioQualitySlider-&gt;SetEnabled(enabled);</a>
<a name="ln797">	fStartDurationTC-&gt;SetEnabled(enabled);</a>
<a name="ln798">	fEndDurationTC-&gt;SetEnabled(enabled);</a>
<a name="ln799"> </a>
<a name="ln800">	BString duration;</a>
<a name="ln801">	if (enabled) {</a>
<a name="ln802">		fInfoView-&gt;Update(file, &amp;ref);</a>
<a name="ln803">		// HACK: get the fInfoView to update the duration &quot;synchronously&quot;</a>
<a name="ln804">		UpdateIfNeeded();</a>
<a name="ln805">		duration &lt;&lt; fInfoView-&gt;Duration() / 1000;</a>
<a name="ln806">	} else</a>
<a name="ln807">		duration = &quot;0&quot;;</a>
<a name="ln808"> </a>
<a name="ln809">	// update duration text controls</a>
<a name="ln810">	fStartDurationTC-&gt;SetText(&quot;0&quot;);</a>
<a name="ln811">	fEndDurationTC-&gt;SetText(duration.String());</a>
<a name="ln812">}</a>
<a name="ln813"> </a>
<a name="ln814"> </a>
<a name="ln815">// #pragma mark -</a>
<a name="ln816"> </a>
<a name="ln817"> </a>
<a name="ln818">void</a>
<a name="ln819">MediaConverterWindow::SetEnabled(bool enabled, bool convertEnabled)</a>
<a name="ln820">{</a>
<a name="ln821">	fConvertButton-&gt;SetEnabled(convertEnabled);</a>
<a name="ln822">	if (enabled == fEnabled)</a>
<a name="ln823">		return;</a>
<a name="ln824"> </a>
<a name="ln825">	fFormatMenu-&gt;SetEnabled(enabled);</a>
<a name="ln826">	fAudioMenu-&gt;SetEnabled(enabled);</a>
<a name="ln827">	fVideoMenu-&gt;SetEnabled(enabled);</a>
<a name="ln828">	fListView-&gt;SetEnabled(enabled);</a>
<a name="ln829">	fStartDurationTC-&gt;SetEnabled(enabled);</a>
<a name="ln830">	fEndDurationTC-&gt;SetEnabled(enabled);</a>
<a name="ln831"> </a>
<a name="ln832">	fEnabled = enabled;</a>
<a name="ln833">}</a>
<a name="ln834"> </a>
<a name="ln835"> </a>
<a name="ln836">bool</a>
<a name="ln837">MediaConverterWindow::IsEnabled()</a>
<a name="ln838">{</a>
<a name="ln839">	return fEnabled;</a>
<a name="ln840">}</a>
<a name="ln841"> </a>
<a name="ln842"> </a>
<a name="ln843">const char*</a>
<a name="ln844">MediaConverterWindow::StartDuration() const</a>
<a name="ln845">{</a>
<a name="ln846">	return fStartDurationTC-&gt;Text();</a>
<a name="ln847">}</a>
<a name="ln848"> </a>
<a name="ln849"> </a>
<a name="ln850">const char*</a>
<a name="ln851">MediaConverterWindow::EndDuration() const</a>
<a name="ln852">{</a>
<a name="ln853">	return fEndDurationTC-&gt;Text();</a>
<a name="ln854">}</a>
<a name="ln855"> </a>
<a name="ln856"> </a>
<a name="ln857">BDirectory</a>
<a name="ln858">MediaConverterWindow::OutputDirectory() const</a>
<a name="ln859">{</a>
<a name="ln860">	return fOutputDir;</a>
<a name="ln861">}</a>
<a name="ln862"> </a>
<a name="ln863"> </a>
<a name="ln864">void</a>
<a name="ln865">MediaConverterWindow::SetAudioQualityLabel(const char* label)</a>
<a name="ln866">{</a>
<a name="ln867">	fAudioQualitySlider-&gt;SetLabel(label);</a>
<a name="ln868">}</a>
<a name="ln869"> </a>
<a name="ln870"> </a>
<a name="ln871">void</a>
<a name="ln872">MediaConverterWindow::SetVideoQualityLabel(const char* label)</a>
<a name="ln873">{</a>
<a name="ln874">	fVideoQualitySlider-&gt;SetLabel(label);</a>
<a name="ln875">}</a>
<a name="ln876"> </a>
<a name="ln877"> </a>
<a name="ln878">void</a>
<a name="ln879">MediaConverterWindow::TruncateOutputFolderPath()</a>
<a name="ln880">{</a>
<a name="ln881">	BEntry entry;</a>
<a name="ln882">	fOutputDir.GetEntry(&amp;entry);</a>
<a name="ln883">	BPath path;</a>
<a name="ln884">	entry.GetPath(&amp;path);</a>
<a name="ln885">	BString pathString(path.Path());</a>
<a name="ln886">	float maxWidth = fVideoMenu-&gt;MenuBar()-&gt;Frame().Width();</a>
<a name="ln887"> </a>
<a name="ln888">	fOutputFolder-&gt;TruncateString(&amp;pathString, B_TRUNCATE_MIDDLE, maxWidth);</a>
<a name="ln889">	fOutputFolder-&gt;SetText(pathString.String());</a>
<a name="ln890">	if (fOutputFolder-&gt;StringWidth(path.Path()) &gt; maxWidth)</a>
<a name="ln891">		fOutputFolder-&gt;SetToolTip(path.Path());</a>
<a name="ln892">	else</a>
<a name="ln893">		fOutputFolder-&gt;SetToolTip((const char*)NULL);</a>
<a name="ln894">}</a>
<a name="ln895"> </a>
<a name="ln896"> </a>
<a name="ln897">// #pragma mark -</a>
<a name="ln898"> </a>
<a name="ln899"> </a>
<a name="ln900">void</a>
<a name="ln901">MediaConverterWindow::_UpdateLabels()</a>
<a name="ln902">{</a>
<a name="ln903">	if (fSourcesBox != NULL) {</a>
<a name="ln904">		fSourcesBox-&gt;SetLabel(B_TRANSLATE(&quot;Source files&quot;));</a>
<a name="ln905">		_UpdateBBoxLayoutInsets(fSourcesBox);</a>
<a name="ln906">	}</a>
<a name="ln907"> </a>
<a name="ln908">	if (fInfoBox != NULL)</a>
<a name="ln909">		fInfoBox-&gt;SetLabel(B_TRANSLATE(&quot;File details&quot;));</a>
<a name="ln910"> </a>
<a name="ln911">	if (fOutputBox != NULL) {</a>
<a name="ln912">		fOutputBox-&gt;SetLabel(B_TRANSLATE(&quot;Output format&quot;));</a>
<a name="ln913">		_UpdateBBoxLayoutInsets(fOutputBox);</a>
<a name="ln914">	}</a>
<a name="ln915"> </a>
<a name="ln916">	if (fConvertButton != NULL)</a>
<a name="ln917">		fConvertButton-&gt;SetLabel(B_TRANSLATE(&quot;Convert&quot;));</a>
<a name="ln918"> </a>
<a name="ln919">	if (fPreviewButton != NULL)</a>
<a name="ln920">		fPreviewButton-&gt;SetLabel(B_TRANSLATE(&quot;Preview&quot;));</a>
<a name="ln921"> </a>
<a name="ln922">	if (fDestButton != NULL)</a>
<a name="ln923">		fDestButton-&gt;SetLabel(B_TRANSLATE(&quot;Output folder&quot;));</a>
<a name="ln924"> </a>
<a name="ln925">	if (fVideoQualitySlider != NULL) {</a>
<a name="ln926">		char buffer[40];</a>
<a name="ln927">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Video quality: %3d%%&quot;),</a>
<a name="ln928">			(int8)fVideoQuality);</a>
<a name="ln929">		fVideoQualitySlider-&gt;SetLabel(buffer);</a>
<a name="ln930">		fVideoQualitySlider-&gt;SetLimitLabels(B_TRANSLATE(&quot;Low&quot;),</a>
<a name="ln931">			B_TRANSLATE(&quot;High&quot;));</a>
<a name="ln932">	}</a>
<a name="ln933"> </a>
<a name="ln934">	if (fAudioQualitySlider != NULL) {</a>
<a name="ln935">		char buffer[40];</a>
<a name="ln936">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Audio quality: %3d%%&quot;),</a>
<a name="ln937">			(int8)fAudioQuality);</a>
<a name="ln938">		fAudioQualitySlider-&gt;SetLabel(buffer);</a>
<a name="ln939">		fAudioQualitySlider-&gt;SetLimitLabels(B_TRANSLATE(&quot;Low&quot;),</a>
<a name="ln940">			B_TRANSLATE(&quot;High&quot;));</a>
<a name="ln941">	}</a>
<a name="ln942"> </a>
<a name="ln943">	if (fStartDurationTC != NULL)</a>
<a name="ln944">		fStartDurationTC-&gt;SetLabel(B_TRANSLATE(&quot;Start [ms]: &quot;));</a>
<a name="ln945"> </a>
<a name="ln946">	if (fEndDurationTC != NULL)</a>
<a name="ln947">		fEndDurationTC-&gt;SetLabel(B_TRANSLATE(&quot;EndÂ  Â [ms]: &quot;));</a>
<a name="ln948"> </a>
<a name="ln949">	if (fFormatMenu != NULL)</a>
<a name="ln950">		fFormatMenu-&gt;SetLabel(B_TRANSLATE(&quot;File format:&quot;));</a>
<a name="ln951"> </a>
<a name="ln952">	if (fAudioMenu != NULL)</a>
<a name="ln953">		fAudioMenu-&gt;SetLabel(B_TRANSLATE(&quot;Audio encoding:&quot;));</a>
<a name="ln954"> </a>
<a name="ln955">	if (fVideoMenu != NULL)</a>
<a name="ln956">		fVideoMenu-&gt;SetLabel(B_TRANSLATE(&quot;Video encoding:&quot;));</a>
<a name="ln957"> </a>
<a name="ln958">	SetFileMessage(B_TRANSLATE(&quot;Drop media files onto this window&quot;));</a>
<a name="ln959">}</a>
<a name="ln960"> </a>
<a name="ln961"> </a>
<a name="ln962">void</a>
<a name="ln963">MediaConverterWindow::_UpdateBBoxLayoutInsets(BBox* box)</a>
<a name="ln964">{</a>
<a name="ln965">	BTwoDimensionalLayout* layout</a>
<a name="ln966">		= dynamic_cast&lt;BTwoDimensionalLayout*&gt;(box-&gt;GetLayout());</a>
<a name="ln967">	if (layout != NULL) {</a>
<a name="ln968">		float padding = be_control_look-&gt;DefaultItemSpacing();</a>
<a name="ln969">		layout-&gt;SetInsets(padding, box-&gt;TopBorderOffset() + padding, padding,</a>
<a name="ln970">			padding);</a>
<a name="ln971">	}</a>
<a name="ln972">}</a>
<a name="ln973"> </a>
<a name="ln974"> </a>
<a name="ln975">void</a>
<a name="ln976">MediaConverterWindow::_DestroyMenu()</a>
<a name="ln977">{</a>
<a name="ln978">	BMenu* menu;</a>
<a name="ln979"> </a>
<a name="ln980">	while ((menu = fMenuBar-&gt;SubmenuAt(0)) != NULL) {</a>
<a name="ln981">		fMenuBar-&gt;RemoveItem(menu);</a>
<a name="ln982">		delete menu;</a>
<a name="ln983">	}</a>
<a name="ln984">}</a>
<a name="ln985"> </a>
<a name="ln986"> </a>
<a name="ln987">void</a>
<a name="ln988">MediaConverterWindow::_CreateMenu()</a>
<a name="ln989">{</a>
<a name="ln990">	BMenu* menu;</a>
<a name="ln991">	BMenuItem* item;</a>
<a name="ln992"> </a>
<a name="ln993">	menu = new BMenu(B_TRANSLATE_CONTEXT(&quot;File&quot;, &quot;Menu&quot;));</a>
<a name="ln994">	item = new BMenuItem(B_TRANSLATE_CONTEXT(&quot;Open&quot; B_UTF8_ELLIPSIS, &quot;Menu&quot;),</a>
<a name="ln995">		new BMessage(OPEN_FILE_MESSAGE), 'O');</a>
<a name="ln996">	menu-&gt;AddItem(item);</a>
<a name="ln997">	menu-&gt;AddSeparatorItem();</a>
<a name="ln998">	item = new BMenuItem(B_TRANSLATE_CONTEXT(&quot;Quit&quot;, &quot;Menu&quot;),</a>
<a name="ln999">		new BMessage(QUIT_MESSAGE), 'Q');</a>
<a name="ln1000">	menu-&gt;AddItem(item);</a>
<a name="ln1001"> </a>
<a name="ln1002">	fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1003">}</a>
<a name="ln1004"> </a>
<a name="ln1005"> </a>
<a name="ln1006">void</a>
<a name="ln1007">MediaConverterWindow::_SetOutputFolder(BEntry entry)</a>
<a name="ln1008">{</a>
<a name="ln1009">	BPath path;</a>
<a name="ln1010">	entry.GetPath(&amp;path);</a>
<a name="ln1011">	if (access(path.Path(), W_OK) != -1) {</a>
<a name="ln1012">		fOutputDir.SetTo(&amp;entry);</a>
<a name="ln1013">	} else {</a>
<a name="ln1014">		BString errorString(B_TRANSLATE(&quot;Error writing to location: %strPath%.&quot;</a>
<a name="ln1015">			&quot; Defaulting to location: /boot/home&quot;));</a>
<a name="ln1016">		errorString.ReplaceFirst(&quot;%strPath%&quot;, path.Path());</a>
<a name="ln1017">		BAlert* alert = new BAlert(B_TRANSLATE(&quot;Error&quot;),</a>
<a name="ln1018">			errorString.String(), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln1019">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1020">		alert-&gt;Go();</a>
<a name="ln1021">		fOutputDir.SetTo(&quot;/boot/home&quot;);</a>
<a name="ln1022">	}</a>
<a name="ln1023">	TruncateOutputFolderPath();</a>
<a name="ln1024">}</a>

</code></pre>
<div class="balloon" rel="1022"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="490"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
