
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>PicturePlayer.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2001-2018, Haiku Inc.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Marc Flerackers (mflerackers@androme.be)</a>
<a name="ln7"> *		Stefano Ceccherini (stefano.ceccherini@gmail.com)</a>
<a name="ln8"> *		Marcus Overhagen (marcus@overhagen.de)</a>
<a name="ln9"> *		Stephan AÃŸmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln10"> */</a>
<a name="ln11"> </a>
<a name="ln12">/**	PicturePlayer is used to play picture data. */</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;PicturePlayer.h&gt;</a>
<a name="ln15"> </a>
<a name="ln16">#include &lt;stdio.h&gt;</a>
<a name="ln17">#include &lt;stdlib.h&gt;</a>
<a name="ln18">#include &lt;string.h&gt;</a>
<a name="ln19"> </a>
<a name="ln20">#include &lt;AffineTransform.h&gt;</a>
<a name="ln21">#include &lt;PictureProtocol.h&gt;</a>
<a name="ln22">#include &lt;Shape.h&gt;</a>
<a name="ln23"> </a>
<a name="ln24"> </a>
<a name="ln25">using BPrivate::PicturePlayer;</a>
<a name="ln26"> </a>
<a name="ln27"> </a>
<a name="ln28">struct adapter_context {</a>
<a name="ln29">	void* user_data;</a>
<a name="ln30">	void** function_table;</a>
<a name="ln31">};</a>
<a name="ln32"> </a>
<a name="ln33"> </a>
<a name="ln34">static void</a>
<a name="ln35">nop()</a>
<a name="ln36">{</a>
<a name="ln37">}</a>
<a name="ln38"> </a>
<a name="ln39"> </a>
<a name="ln40">static void</a>
<a name="ln41">move_pen_by(void* _context, const BPoint&amp; delta)</a>
<a name="ln42">{</a>
<a name="ln43">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln44">	((void (*)(void*, BPoint))context-&gt;function_table[1])(context-&gt;user_data,</a>
<a name="ln45">		delta);</a>
<a name="ln46">}</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">static void</a>
<a name="ln50">stroke_line(void* _context, const BPoint&amp; start, const BPoint&amp; end)</a>
<a name="ln51">{</a>
<a name="ln52">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln53">	((void (*)(void*, BPoint, BPoint))context-&gt;function_table[2])(</a>
<a name="ln54">		context-&gt;user_data, start, end);</a>
<a name="ln55">}</a>
<a name="ln56"> </a>
<a name="ln57"> </a>
<a name="ln58">static void</a>
<a name="ln59">draw_rect(void* _context, const BRect&amp; rect, bool fill)</a>
<a name="ln60">{</a>
<a name="ln61">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln62">	((void (*)(void*, BRect))context-&gt;function_table[fill ? 4 : 3])(</a>
<a name="ln63">		context-&gt;user_data, rect);</a>
<a name="ln64">}</a>
<a name="ln65"> </a>
<a name="ln66"> </a>
<a name="ln67">static void</a>
<a name="ln68">draw_round_rect(void* _context, const BRect&amp; rect, const BPoint&amp; radii,</a>
<a name="ln69">	bool fill)</a>
<a name="ln70">{</a>
<a name="ln71">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln72">	((void (*)(void*, BRect, BPoint))context-&gt;function_table[fill ? 6 : 5])(</a>
<a name="ln73">		context-&gt;user_data, rect, radii);</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76"> </a>
<a name="ln77">static void</a>
<a name="ln78">draw_bezier(void* _context, size_t numPoints, const BPoint _points[], bool fill)</a>
<a name="ln79">{</a>
<a name="ln80">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln81">	if (numPoints != 4)</a>
<a name="ln82">		return;</a>
<a name="ln83"> </a>
<a name="ln84">	BPoint points[4] = { _points[0], _points[1], _points[2], _points[3] };</a>
<a name="ln85">	((void (*)(void*, BPoint*))context-&gt;function_table[fill ? 8 : 7])(</a>
<a name="ln86">		context-&gt;user_data, points);</a>
<a name="ln87">}</a>
<a name="ln88"> </a>
<a name="ln89"> </a>
<a name="ln90">static void</a>
<a name="ln91">draw_arc(void* _context, const BPoint&amp; center, const BPoint&amp; radii,</a>
<a name="ln92">	float startTheta, float arcTheta, bool fill)</a>
<a name="ln93">{</a>
<a name="ln94">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln95">	((void (*)(void*, BPoint, BPoint, float, float))</a>
<a name="ln96">		context-&gt;function_table[fill ? 10 : 9])(context-&gt;user_data, center,</a>
<a name="ln97">			radii, startTheta, arcTheta);</a>
<a name="ln98">}</a>
<a name="ln99"> </a>
<a name="ln100"> </a>
<a name="ln101">static void</a>
<a name="ln102">draw_ellipse(void* _context, const BRect&amp; rect, bool fill)</a>
<a name="ln103">{</a>
<a name="ln104">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln105">	BPoint radii((rect.Width() + 1) / 2.0f, (rect.Height() + 1) / 2.0f);</a>
<a name="ln106">	BPoint center = rect.LeftTop() + radii;</a>
<a name="ln107">	((void (*)(void*, BPoint, BPoint))</a>
<a name="ln108">		context-&gt;function_table[fill ? 12 : 11])(context-&gt;user_data, center,</a>
<a name="ln109">			radii);</a>
<a name="ln110">}</a>
<a name="ln111"> </a>
<a name="ln112"> </a>
<a name="ln113">static void</a>
<a name="ln114">draw_polygon(void* _context, size_t numPoints, const BPoint _points[],</a>
<a name="ln115">	bool isClosed, bool fill)</a>
<a name="ln116">{</a>
<a name="ln117">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln118"> </a>
<a name="ln119">	// This is rather ugly but works for such a trivial class.</a>
<a name="ln120">	const size_t kMaxStackCount = 200;</a>
<a name="ln121">	char stackData[kMaxStackCount * sizeof(BPoint)];</a>
<a name="ln122">	BPoint* points = (BPoint*)stackData;</a>
<a name="ln123">	if (numPoints &gt; kMaxStackCount) {</a>
<a name="ln124">		points = (BPoint*)malloc(numPoints * sizeof(BPoint));</a>
<a name="ln125">		if (points == NULL)</a>
<a name="ln126">			return;</a>
<a name="ln127">	}</a>
<a name="ln128"> </a>
<a name="ln129">	memcpy((void*)points, _points, numPoints * sizeof(BPoint));</a>
<a name="ln130"> </a>
<a name="ln131">	((void (*)(void*, int32, BPoint*, bool))</a>
<a name="ln132">		context-&gt;function_table[fill ? 14 : 13])(context-&gt;user_data, numPoints,</a>
<a name="ln133">			points, isClosed);</a>
<a name="ln134"> </a>
<a name="ln135">	if (numPoints &gt; kMaxStackCount)</a>
<a name="ln136">		free(points);</a>
<a name="ln137">}</a>
<a name="ln138"> </a>
<a name="ln139"> </a>
<a name="ln140">static void</a>
<a name="ln141">draw_shape(void* _context, const BShape&amp; shape, bool fill)</a>
<a name="ln142">{</a>
<a name="ln143">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln144">	((void (*)(void*, BShape))context-&gt;function_table[fill ? 16 : 15])(</a>
<a name="ln145">		context-&gt;user_data, shape);</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148"> </a>
<a name="ln149">static void</a>
<a name="ln150">draw_string(void* _context, const char* _string, size_t length,</a>
<a name="ln151">	float deltaSpace, float deltaNonSpace)</a>
<a name="ln152">{</a>
<a name="ln153">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln154">	char* string = strndup(_string, length);</a>
<a name="ln155"> </a>
<a name="ln156">	((void (*)(void*, char*, float, float))</a>
<a name="ln157">		context-&gt;function_table[17])(context-&gt;user_data, string, deltaSpace,</a>
<a name="ln158">			deltaNonSpace);</a>
<a name="ln159"> </a>
<a name="ln160">	free(string);</a>
<a name="ln161">}</a>
<a name="ln162"> </a>
<a name="ln163"> </a>
<a name="ln164">static void</a>
<a name="ln165">draw_pixels(void* _context, const BRect&amp; src, const BRect&amp; dest, uint32 width,</a>
<a name="ln166">	uint32 height, size_t bytesPerRow, color_space pixelFormat, uint32 options,</a>
<a name="ln167">	const void* _data, size_t length)</a>
<a name="ln168">{</a>
<a name="ln169">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln170">	void* data = malloc(length);</a>
<a name="ln171">	if (data == NULL)</a>
<a name="ln172">		return;</a>
<a name="ln173"> </a>
<a name="ln174">	memcpy(data, _data, length);</a>
<a name="ln175"> </a>
<a name="ln176">	((void (*)(void*, BRect, BRect, int32, int32, int32, int32, int32, void*))</a>
<a name="ln177">		context-&gt;function_table[18])(context-&gt;user_data, src, dest, width,</a>
<a name="ln178">			height, bytesPerRow, pixelFormat, options, data);</a>
<a name="ln179"> </a>
<a name="ln180">	free(data);</a>
<a name="ln181">}</a>
<a name="ln182"> </a>
<a name="ln183"> </a>
<a name="ln184">static void</a>
<a name="ln185">draw_picture(void* _context, const BPoint&amp; where, int32 token)</a>
<a name="ln186">{</a>
<a name="ln187">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln188">	((void (*)(void*, BPoint, int32))context-&gt;function_table[19])(</a>
<a name="ln189">		context-&gt;user_data, where, token);</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192"> </a>
<a name="ln193">static void</a>
<a name="ln194">set_clipping_rects(void* _context, size_t numRects, const BRect _rects[])</a>
<a name="ln195">{</a>
<a name="ln196">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln197"> </a>
<a name="ln198">	// This is rather ugly but works for such a trivial class.</a>
<a name="ln199">	const size_t kMaxStackCount = 100;</a>
<a name="ln200">	char stackData[kMaxStackCount * sizeof(BRect)];</a>
<a name="ln201">	BRect* rects = (BRect*)stackData;</a>
<a name="ln202">	if (numRects &gt; kMaxStackCount) {</a>
<a name="ln203">		rects = (BRect*)malloc(numRects * sizeof(BRect));</a>
<a name="ln204">		if (rects == NULL)</a>
<a name="ln205">			return;</a>
<a name="ln206">	}</a>
<a name="ln207"> </a>
<a name="ln208">	memcpy((void*)rects, _rects, numRects * sizeof(BRect));</a>
<a name="ln209"> </a>
<a name="ln210">	((void (*)(void*, BRect*, uint32))context-&gt;function_table[20])(</a>
<a name="ln211">		context-&gt;user_data, rects, numRects);</a>
<a name="ln212"> </a>
<a name="ln213">	if (numRects &gt; kMaxStackCount)</a>
<a name="ln214">		free(rects);</a>
<a name="ln215">}</a>
<a name="ln216"> </a>
<a name="ln217"> </a>
<a name="ln218">static void</a>
<a name="ln219">clip_to_picture(void* _context, int32 token, const BPoint&amp; origin,</a>
<a name="ln220">	bool clipToInverse)</a>
<a name="ln221">{</a>
<a name="ln222">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln223">	((void (*)(void*, int32, BPoint, bool))context-&gt;function_table[21])(</a>
<a name="ln224">			context-&gt;user_data, token, origin, clipToInverse);</a>
<a name="ln225">}</a>
<a name="ln226"> </a>
<a name="ln227"> </a>
<a name="ln228">static void</a>
<a name="ln229">push_state(void* _context)</a>
<a name="ln230">{</a>
<a name="ln231">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln232">	((void (*)(void*))context-&gt;function_table[22])(context-&gt;user_data);</a>
<a name="ln233">}</a>
<a name="ln234"> </a>
<a name="ln235"> </a>
<a name="ln236">static void</a>
<a name="ln237">pop_state(void* _context)</a>
<a name="ln238">{</a>
<a name="ln239">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln240">	((void (*)(void*))context-&gt;function_table[23])(context-&gt;user_data);</a>
<a name="ln241">}</a>
<a name="ln242"> </a>
<a name="ln243"> </a>
<a name="ln244">static void</a>
<a name="ln245">enter_state_change(void* _context)</a>
<a name="ln246">{</a>
<a name="ln247">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln248">	((void (*)(void*))context-&gt;function_table[24])(context-&gt;user_data);</a>
<a name="ln249">}</a>
<a name="ln250"> </a>
<a name="ln251"> </a>
<a name="ln252">static void</a>
<a name="ln253">exit_state_change(void* _context)</a>
<a name="ln254">{</a>
<a name="ln255">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln256">	((void (*)(void*))context-&gt;function_table[25])(context-&gt;user_data);</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259"> </a>
<a name="ln260">static void</a>
<a name="ln261">enter_font_state(void* _context)</a>
<a name="ln262">{</a>
<a name="ln263">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln264">	((void (*)(void*))context-&gt;function_table[26])(context-&gt;user_data);</a>
<a name="ln265">}</a>
<a name="ln266"> </a>
<a name="ln267"> </a>
<a name="ln268">static void</a>
<a name="ln269">exit_font_state(void* _context)</a>
<a name="ln270">{</a>
<a name="ln271">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln272">	((void (*)(void*))context-&gt;function_table[27])(context-&gt;user_data);</a>
<a name="ln273">}</a>
<a name="ln274"> </a>
<a name="ln275"> </a>
<a name="ln276">static void</a>
<a name="ln277">set_origin(void* _context, const BPoint&amp; origin)</a>
<a name="ln278">{</a>
<a name="ln279">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln280">	((void (*)(void*, BPoint))context-&gt;function_table[28])(context-&gt;user_data,</a>
<a name="ln281">		origin);</a>
<a name="ln282">}</a>
<a name="ln283"> </a>
<a name="ln284"> </a>
<a name="ln285">static void</a>
<a name="ln286">set_pen_location(void* _context, const BPoint&amp; penLocation)</a>
<a name="ln287">{</a>
<a name="ln288">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln289">	((void (*)(void*, BPoint))context-&gt;function_table[29])(context-&gt;user_data,</a>
<a name="ln290">		penLocation);</a>
<a name="ln291">}</a>
<a name="ln292"> </a>
<a name="ln293"> </a>
<a name="ln294">static void</a>
<a name="ln295">set_drawing_mode(void* _context, drawing_mode mode)</a>
<a name="ln296">{</a>
<a name="ln297">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln298">	((void (*)(void*, drawing_mode))context-&gt;function_table[30])(</a>
<a name="ln299">		context-&gt;user_data, mode);</a>
<a name="ln300">}</a>
<a name="ln301"> </a>
<a name="ln302"> </a>
<a name="ln303">static void</a>
<a name="ln304">set_line_mode(void* _context, cap_mode capMode, join_mode joinMode,</a>
<a name="ln305">	float miterLimit)</a>
<a name="ln306">{</a>
<a name="ln307">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln308">	((void (*)(void*, cap_mode, join_mode, float))context-&gt;function_table[31])(</a>
<a name="ln309">		context-&gt;user_data, capMode, joinMode, miterLimit);</a>
<a name="ln310">}</a>
<a name="ln311"> </a>
<a name="ln312"> </a>
<a name="ln313">static void</a>
<a name="ln314">set_pen_size(void* _context, float size)</a>
<a name="ln315">{</a>
<a name="ln316">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln317">	((void (*)(void*, float))context-&gt;function_table[32])(context-&gt;user_data,</a>
<a name="ln318">		size);</a>
<a name="ln319">}</a>
<a name="ln320"> </a>
<a name="ln321"> </a>
<a name="ln322">static void</a>
<a name="ln323">set_fore_color(void* _context, const rgb_color&amp; color)</a>
<a name="ln324">{</a>
<a name="ln325">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln326">	((void (*)(void*, rgb_color))context-&gt;function_table[33])(</a>
<a name="ln327">		context-&gt;user_data, color);</a>
<a name="ln328">}</a>
<a name="ln329"> </a>
<a name="ln330"> </a>
<a name="ln331">static void</a>
<a name="ln332">set_back_color(void* _context, const rgb_color&amp; color)</a>
<a name="ln333">{</a>
<a name="ln334">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln335">	((void (*)(void*, rgb_color))context-&gt;function_table[34])(</a>
<a name="ln336">		context-&gt;user_data, color);</a>
<a name="ln337">}</a>
<a name="ln338"> </a>
<a name="ln339"> </a>
<a name="ln340">static void</a>
<a name="ln341">set_stipple_pattern(void* _context, const pattern&amp; stipplePattern)</a>
<a name="ln342">{</a>
<a name="ln343">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln344">	((void (*)(void*, pattern))context-&gt;function_table[35])(context-&gt;user_data,</a>
<a name="ln345">		stipplePattern);</a>
<a name="ln346">}</a>
<a name="ln347"> </a>
<a name="ln348"> </a>
<a name="ln349">static void</a>
<a name="ln350">set_scale(void* _context, float scale)</a>
<a name="ln351">{</a>
<a name="ln352">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln353">	((void (*)(void*, float))context-&gt;function_table[36])(context-&gt;user_data,</a>
<a name="ln354">		scale);</a>
<a name="ln355">}</a>
<a name="ln356"> </a>
<a name="ln357"> </a>
<a name="ln358">static void</a>
<a name="ln359">set_font_family(void* _context, const char* _family, size_t length)</a>
<a name="ln360">{</a>
<a name="ln361">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln362">	char* family = strndup(_family, length);</a>
<a name="ln363"> </a>
<a name="ln364">	((void (*)(void*, char*))context-&gt;function_table[37])(context-&gt;user_data,</a>
<a name="ln365">		family);</a>
<a name="ln366"> </a>
<a name="ln367">	free(family);</a>
<a name="ln368">}</a>
<a name="ln369"> </a>
<a name="ln370"> </a>
<a name="ln371">static void</a>
<a name="ln372">set_font_style(void* _context, const char* _style, size_t length)</a>
<a name="ln373">{</a>
<a name="ln374">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln375">	char* style = strndup(_style, length);</a>
<a name="ln376"> </a>
<a name="ln377">	((void (*)(void*, char*))context-&gt;function_table[38])(context-&gt;user_data,</a>
<a name="ln378">		style);</a>
<a name="ln379"> </a>
<a name="ln380">	free(style);</a>
<a name="ln381">}</a>
<a name="ln382"> </a>
<a name="ln383"> </a>
<a name="ln384">static void</a>
<a name="ln385">set_font_spacing(void* _context, uint8 spacing)</a>
<a name="ln386">{</a>
<a name="ln387">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln388">	((void (*)(void*, int32))context-&gt;function_table[39])(context-&gt;user_data,</a>
<a name="ln389">		spacing);</a>
<a name="ln390">}</a>
<a name="ln391"> </a>
<a name="ln392"> </a>
<a name="ln393">static void</a>
<a name="ln394">set_font_size(void* _context, float size)</a>
<a name="ln395">{</a>
<a name="ln396">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln397">	((void (*)(void*, float))context-&gt;function_table[40])(context-&gt;user_data,</a>
<a name="ln398">		size);</a>
<a name="ln399">}</a>
<a name="ln400"> </a>
<a name="ln401"> </a>
<a name="ln402">static void</a>
<a name="ln403">set_font_rotation(void* _context, float rotation)</a>
<a name="ln404">{</a>
<a name="ln405">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln406">	((void (*)(void*, float))context-&gt;function_table[41])(context-&gt;user_data,</a>
<a name="ln407">		rotation);</a>
<a name="ln408">}</a>
<a name="ln409"> </a>
<a name="ln410"> </a>
<a name="ln411">static void</a>
<a name="ln412">set_font_encoding(void* _context, uint8 encoding)</a>
<a name="ln413">{</a>
<a name="ln414">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln415">	((void (*)(void*, int32))context-&gt;function_table[42])(context-&gt;user_data,</a>
<a name="ln416">		encoding);</a>
<a name="ln417">}</a>
<a name="ln418"> </a>
<a name="ln419"> </a>
<a name="ln420">static void</a>
<a name="ln421">set_font_flags(void* _context, uint32 flags)</a>
<a name="ln422">{</a>
<a name="ln423">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln424">	((void (*)(void*, int32))context-&gt;function_table[43])(context-&gt;user_data,</a>
<a name="ln425">		flags);</a>
<a name="ln426">}</a>
<a name="ln427"> </a>
<a name="ln428"> </a>
<a name="ln429">static void</a>
<a name="ln430">set_font_shear(void* _context, float shear)</a>
<a name="ln431">{</a>
<a name="ln432">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln433">	((void (*)(void*, float))context-&gt;function_table[44])(context-&gt;user_data,</a>
<a name="ln434">		shear);</a>
<a name="ln435">}</a>
<a name="ln436"> </a>
<a name="ln437"> </a>
<a name="ln438">static void</a>
<a name="ln439">set_font_face(void* _context, uint16 face)</a>
<a name="ln440">{</a>
<a name="ln441">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln442">	((void (*)(void*, int32))context-&gt;function_table[46])(context-&gt;user_data,</a>
<a name="ln443">		face);</a>
<a name="ln444">}</a>
<a name="ln445"> </a>
<a name="ln446"> </a>
<a name="ln447">static void</a>
<a name="ln448">set_blending_mode(void* _context, source_alpha alphaSrcMode,</a>
<a name="ln449">	alpha_function alphaFncMode)</a>
<a name="ln450">{</a>
<a name="ln451">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln452">	((void (*)(void*, source_alpha, alpha_function))</a>
<a name="ln453">		context-&gt;function_table[47])(context-&gt;user_data, alphaSrcMode,</a>
<a name="ln454">			alphaFncMode);</a>
<a name="ln455">}</a>
<a name="ln456"> </a>
<a name="ln457"> </a>
<a name="ln458">static void</a>
<a name="ln459">set_transform(void* _context, const BAffineTransform&amp; transform)</a>
<a name="ln460">{</a>
<a name="ln461">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln462">	((void (*)(void*, const BAffineTransform&amp;))</a>
<a name="ln463">		context-&gt;function_table[48])(context-&gt;user_data, transform);</a>
<a name="ln464">}</a>
<a name="ln465"> </a>
<a name="ln466"> </a>
<a name="ln467">static void</a>
<a name="ln468">translate_by(void* _context, double x, double y)</a>
<a name="ln469">{</a>
<a name="ln470">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln471">	((void (*)(void*, double, double))</a>
<a name="ln472">		context-&gt;function_table[49])(context-&gt;user_data, x, y);</a>
<a name="ln473">}</a>
<a name="ln474"> </a>
<a name="ln475"> </a>
<a name="ln476">static void</a>
<a name="ln477">scale_by(void* _context, double x, double y)</a>
<a name="ln478">{</a>
<a name="ln479">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln480">	((void (*)(void*, double, double))</a>
<a name="ln481">		context-&gt;function_table[50])(context-&gt;user_data, x, y);</a>
<a name="ln482">}</a>
<a name="ln483"> </a>
<a name="ln484"> </a>
<a name="ln485">static void</a>
<a name="ln486">rotate_by(void* _context, double angleRadians)</a>
<a name="ln487">{</a>
<a name="ln488">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln489">	((void (*)(void*, double))</a>
<a name="ln490">		context-&gt;function_table[51])(context-&gt;user_data, angleRadians);</a>
<a name="ln491">}</a>
<a name="ln492"> </a>
<a name="ln493"> </a>
<a name="ln494">static void</a>
<a name="ln495">blend_layer(void* _context, Layer* layer)</a>
<a name="ln496">{</a>
<a name="ln497">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln498">	((void (*)(void*, Layer*))</a>
<a name="ln499">		context-&gt;function_table[52])(context-&gt;user_data, layer);</a>
<a name="ln500">}</a>
<a name="ln501"> </a>
<a name="ln502"> </a>
<a name="ln503">static void</a>
<a name="ln504">clip_to_rect(void* _context, const BRect&amp; rect, bool inverse)</a>
<a name="ln505">{</a>
<a name="ln506">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln507">	((void (*)(void*, const BRect&amp;, bool))</a>
<a name="ln508">		context-&gt;function_table[53])(context-&gt;user_data, rect, inverse);</a>
<a name="ln509">}</a>
<a name="ln510"> </a>
<a name="ln511"> </a>
<a name="ln512">static void</a>
<a name="ln513">clip_to_shape(void* _context, int32 opCount, const uint32 opList[],</a>
<a name="ln514">	int32 ptCount, const BPoint ptList[], bool inverse)</a>
<a name="ln515">{</a>
<a name="ln516">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln517">	((void (*)(void*, int32, const uint32*, int32, const BPoint*, bool))</a>
<a name="ln518">		context-&gt;function_table[54])(context-&gt;user_data, opCount, opList,</a>
<a name="ln519">			ptCount, ptList, inverse);</a>
<a name="ln520">}</a>
<a name="ln521"> </a>
<a name="ln522"> </a>
<a name="ln523">static void</a>
<a name="ln524">draw_string_locations(void* _context, const char* _string, size_t length,</a>
<a name="ln525">	const BPoint* locations, size_t locationCount)</a>
<a name="ln526">{</a>
<a name="ln527">	adapter_context* context = reinterpret_cast&lt;adapter_context*&gt;(_context);</a>
<a name="ln528">	char* string = strndup(_string, length);</a>
<a name="ln529"> </a>
<a name="ln530">	((void (*)(void*, char*, const BPoint*, size_t))</a>
<a name="ln531">		context-&gt;function_table[55])(context-&gt;user_data, string, locations,</a>
<a name="ln532">			locationCount);</a>
<a name="ln533"> </a>
<a name="ln534">	free(string);</a>
<a name="ln535">}</a>
<a name="ln536"> </a>
<a name="ln537"> </a>
<a name="ln538"> </a>
<a name="ln539">#if DEBUG &gt; 1</a>
<a name="ln540">static const char *</a>
<a name="ln541">PictureOpToString(int op)</a>
<a name="ln542">{</a>
<a name="ln543">	#define RETURN_STRING(x) case x: return #x</a>
<a name="ln544"> </a>
<a name="ln545">	switch(op) {</a>
<a name="ln546">		RETURN_STRING(B_PIC_MOVE_PEN_BY);</a>
<a name="ln547">		RETURN_STRING(B_PIC_STROKE_LINE);</a>
<a name="ln548">		RETURN_STRING(B_PIC_STROKE_RECT);</a>
<a name="ln549">		RETURN_STRING(B_PIC_FILL_RECT);</a>
<a name="ln550">		RETURN_STRING(B_PIC_STROKE_ROUND_RECT);</a>
<a name="ln551">		RETURN_STRING(B_PIC_FILL_ROUND_RECT);</a>
<a name="ln552">		RETURN_STRING(B_PIC_STROKE_BEZIER);</a>
<a name="ln553">		RETURN_STRING(B_PIC_FILL_BEZIER);</a>
<a name="ln554">		RETURN_STRING(B_PIC_STROKE_POLYGON);</a>
<a name="ln555">		RETURN_STRING(B_PIC_FILL_POLYGON);</a>
<a name="ln556">		RETURN_STRING(B_PIC_STROKE_SHAPE);</a>
<a name="ln557">		RETURN_STRING(B_PIC_FILL_SHAPE);</a>
<a name="ln558">		RETURN_STRING(B_PIC_DRAW_STRING);</a>
<a name="ln559">		RETURN_STRING(B_PIC_DRAW_STRING_LOCATIONS);</a>
<a name="ln560">		RETURN_STRING(B_PIC_DRAW_PIXELS);</a>
<a name="ln561">		RETURN_STRING(B_PIC_DRAW_PICTURE);</a>
<a name="ln562">		RETURN_STRING(B_PIC_STROKE_ARC);</a>
<a name="ln563">		RETURN_STRING(B_PIC_FILL_ARC);</a>
<a name="ln564">		RETURN_STRING(B_PIC_STROKE_ELLIPSE);</a>
<a name="ln565">		RETURN_STRING(B_PIC_FILL_ELLIPSE);</a>
<a name="ln566"> </a>
<a name="ln567">		RETURN_STRING(B_PIC_ENTER_STATE_CHANGE);</a>
<a name="ln568">		RETURN_STRING(B_PIC_SET_CLIPPING_RECTS);</a>
<a name="ln569">		RETURN_STRING(B_PIC_CLIP_TO_PICTURE);</a>
<a name="ln570">		RETURN_STRING(B_PIC_PUSH_STATE);</a>
<a name="ln571">		RETURN_STRING(B_PIC_POP_STATE);</a>
<a name="ln572">		RETURN_STRING(B_PIC_CLEAR_CLIPPING_RECTS);</a>
<a name="ln573"> </a>
<a name="ln574">		RETURN_STRING(B_PIC_SET_ORIGIN);</a>
<a name="ln575">		RETURN_STRING(B_PIC_SET_PEN_LOCATION);</a>
<a name="ln576">		RETURN_STRING(B_PIC_SET_DRAWING_MODE);</a>
<a name="ln577">		RETURN_STRING(B_PIC_SET_LINE_MODE);</a>
<a name="ln578">		RETURN_STRING(B_PIC_SET_PEN_SIZE);</a>
<a name="ln579">		RETURN_STRING(B_PIC_SET_SCALE);</a>
<a name="ln580">		RETURN_STRING(B_PIC_SET_TRANSFORM);</a>
<a name="ln581">		RETURN_STRING(B_PIC_SET_FORE_COLOR);</a>
<a name="ln582">		RETURN_STRING(B_PIC_SET_BACK_COLOR);</a>
<a name="ln583">		RETURN_STRING(B_PIC_SET_STIPLE_PATTERN);</a>
<a name="ln584">		RETURN_STRING(B_PIC_ENTER_FONT_STATE);</a>
<a name="ln585">		RETURN_STRING(B_PIC_SET_BLENDING_MODE);</a>
<a name="ln586">		RETURN_STRING(B_PIC_SET_FONT_FAMILY);</a>
<a name="ln587">		RETURN_STRING(B_PIC_SET_FONT_STYLE);</a>
<a name="ln588">		RETURN_STRING(B_PIC_SET_FONT_SPACING);</a>
<a name="ln589">		RETURN_STRING(B_PIC_SET_FONT_ENCODING);</a>
<a name="ln590">		RETURN_STRING(B_PIC_SET_FONT_FLAGS);</a>
<a name="ln591">		RETURN_STRING(B_PIC_SET_FONT_SIZE);</a>
<a name="ln592">		RETURN_STRING(B_PIC_SET_FONT_ROTATE);</a>
<a name="ln593">		RETURN_STRING(B_PIC_SET_FONT_SHEAR);</a>
<a name="ln594">		RETURN_STRING(B_PIC_SET_FONT_BPP);</a>
<a name="ln595">		RETURN_STRING(B_PIC_SET_FONT_FACE);</a>
<a name="ln596"> </a>
<a name="ln597">		RETURN_STRING(B_PIC_AFFINE_TRANSLATE);</a>
<a name="ln598">		RETURN_STRING(B_PIC_AFFINE_SCALE);</a>
<a name="ln599">		RETURN_STRING(B_PIC_AFFINE_ROTATE);</a>
<a name="ln600"> </a>
<a name="ln601">		RETURN_STRING(B_PIC_BLEND_LAYER);</a>
<a name="ln602"> </a>
<a name="ln603">		default: return &quot;Unknown op&quot;;</a>
<a name="ln604">	}</a>
<a name="ln605">	#undef RETURN_STRING</a>
<a name="ln606">}</a>
<a name="ln607">#endif</a>
<a name="ln608"> </a>
<a name="ln609"> </a>
<a name="ln610">PicturePlayer::PicturePlayer(const void *data, size_t size, BList *pictures)</a>
<a name="ln611">	:	fData(data),</a>
<a name="ln612">		fSize(size),</a>
<a name="ln613">		fPictures(pictures)</a>
<a name="ln614">{</a>
<a name="ln615">}</a>
<a name="ln616"> </a>
<a name="ln617"> </a>
<a name="ln618">PicturePlayer::~PicturePlayer()</a>
<a name="ln619">{</a>
<a name="ln620">}</a>
<a name="ln621"> </a>
<a name="ln622"> </a>
<a name="ln623">status_t</a>
<a name="ln624">PicturePlayer::Play(void** callBackTable, int32 tableEntries, void* userData)</a>
<a name="ln625">{</a>
<a name="ln626">	const BPrivate::picture_player_callbacks kAdapterCallbacks = {</a>
<a name="ln627">		move_pen_by,</a>
<a name="ln628">		stroke_line,</a>
<a name="ln629">		draw_rect,</a>
<a name="ln630">		draw_round_rect,</a>
<a name="ln631">		draw_bezier,</a>
<a name="ln632">		draw_arc,</a>
<a name="ln633">		draw_ellipse,</a>
<a name="ln634">		draw_polygon,</a>
<a name="ln635">		draw_shape,</a>
<a name="ln636">		draw_string,</a>
<a name="ln637">		draw_pixels,</a>
<a name="ln638">		draw_picture,</a>
<a name="ln639">		set_clipping_rects,</a>
<a name="ln640">		clip_to_picture,</a>
<a name="ln641">		push_state,</a>
<a name="ln642">		pop_state,</a>
<a name="ln643">		enter_state_change,</a>
<a name="ln644">		exit_state_change,</a>
<a name="ln645">		enter_font_state,</a>
<a name="ln646">		exit_font_state,</a>
<a name="ln647">		set_origin,</a>
<a name="ln648">		set_pen_location,</a>
<a name="ln649">		set_drawing_mode,</a>
<a name="ln650">		set_line_mode,</a>
<a name="ln651">		set_pen_size,</a>
<a name="ln652">		set_fore_color,</a>
<a name="ln653">		set_back_color,</a>
<a name="ln654">		set_stipple_pattern,</a>
<a name="ln655">		set_scale,</a>
<a name="ln656">		set_font_family,</a>
<a name="ln657">		set_font_style,</a>
<a name="ln658">		set_font_spacing,</a>
<a name="ln659">		set_font_size,</a>
<a name="ln660">		set_font_rotation,</a>
<a name="ln661">		set_font_encoding,</a>
<a name="ln662">		set_font_flags,</a>
<a name="ln663">		set_font_shear,</a>
<a name="ln664">		set_font_face,</a>
<a name="ln665">		set_blending_mode,</a>
<a name="ln666">		set_transform,</a>
<a name="ln667">		translate_by,</a>
<a name="ln668">		scale_by,</a>
<a name="ln669">		rotate_by,</a>
<a name="ln670">		blend_layer,</a>
<a name="ln671">		clip_to_rect,</a>
<a name="ln672">		clip_to_shape,</a>
<a name="ln673">		draw_string_locations</a>
<a name="ln674">	};</a>
<a name="ln675"> </a>
<a name="ln676">	// We don't check if the functions in the table are NULL, but we</a>
<a name="ln677">	// check the tableEntries to see if the table is big enough.</a>
<a name="ln678">	// If an application supplies the wrong size or an invalid pointer,</a>
<a name="ln679">	// it's its own fault.</a>
<a name="ln680"> </a>
<a name="ln681">	// If the caller supplied a function table smaller than needed,</a>
<a name="ln682">	// we use our dummy table, and copy the supported ops from the supplied one.</a>
<a name="ln683">	void *dummyTable[kOpsTableSize];</a>
<a name="ln684"> </a>
<a name="ln685">	adapter_context adapterContext;</a>
<a name="ln686">	adapterContext.user_data = userData;</a>
<a name="ln687">	adapterContext.function_table = callBackTable;</a>
<a name="ln688"> </a>
<a name="ln689">	if ((size_t)tableEntries &lt; kOpsTableSize) {</a>
<a name="ln690">		memcpy(dummyTable, callBackTable, tableEntries * sizeof(void*));</a>
<a name="ln691">		for (size_t i = (size_t)tableEntries; i &lt; kOpsTableSize; i++)</a>
<a name="ln692">			dummyTable[i] = (void*)nop;</a>
<a name="ln693"> </a>
<a name="ln694">		adapterContext.function_table = dummyTable;</a>
<a name="ln695">	}</a>
<a name="ln696"> </a>
<a name="ln697">	return _Play(kAdapterCallbacks, &amp;adapterContext, fData, fSize, 0);</a>
<a name="ln698">}</a>
<a name="ln699"> </a>
<a name="ln700"> </a>
<a name="ln701">status_t</a>
<a name="ln702">PicturePlayer::Play(const picture_player_callbacks&amp; callbacks,</a>
<a name="ln703">	size_t callbacksSize, void* userData)</a>
<a name="ln704">{</a>
<a name="ln705">	return _Play(callbacks, userData, fData, fSize, 0);</a>
<a name="ln706">}</a>
<a name="ln707"> </a>
<a name="ln708"> </a>
<a name="ln709">class DataReader {</a>
<a name="ln710">public:</a>
<a name="ln711">		DataReader(const void* buffer, size_t length)</a>
<a name="ln712">			:</a>
<a name="ln713">			fBuffer((const uint8*)buffer),</a>
<a name="ln714">			fRemaining(length)</a>
<a name="ln715">		{</a>
<a name="ln716">		}</a>
<a name="ln717"> </a>
<a name="ln718">		size_t</a>
<a name="ln719">		Remaining() const</a>
<a name="ln720">		{</a>
<a name="ln721">			return fRemaining;</a>
<a name="ln722">		}</a>
<a name="ln723"> </a>
<a name="ln724">		template&lt;typename T&gt;</a>
<a name="ln725">		bool</a>
<a name="ln726">		Get(const T*&amp; typed, size_t count = 1)</a>
<a name="ln727">		{</a>
<a name="ln728">			if (fRemaining &lt; sizeof(T) * count)</a>
<a name="ln729">				return false;</a>
<a name="ln730"> </a>
<a name="ln731">			typed = reinterpret_cast&lt;const T *&gt;(fBuffer);</a>
<a name="ln732">			fRemaining -= sizeof(T) * count;</a>
<a name="ln733">			fBuffer += sizeof(T) * count;</a>
<a name="ln734">			return true;</a>
<a name="ln735">		}</a>
<a name="ln736"> </a>
<a name="ln737">		template&lt;typename T&gt;</a>
<a name="ln738">		bool</a>
<a name="ln739">		GetRemaining(const T*&amp; buffer, size_t&amp; size)</a>
<a name="ln740">		{</a>
<a name="ln741">			if (fRemaining == 0)</a>
<a name="ln742">				return false;</a>
<a name="ln743"> </a>
<a name="ln744">			buffer = reinterpret_cast&lt;const T*&gt;(fBuffer);</a>
<a name="ln745">			size = fRemaining;</a>
<a name="ln746">			fRemaining = 0;</a>
<a name="ln747">			return true;</a>
<a name="ln748">		}</a>
<a name="ln749"> </a>
<a name="ln750">private:</a>
<a name="ln751">		const uint8*	fBuffer;</a>
<a name="ln752">		size_t			fRemaining;</a>
<a name="ln753">};</a>
<a name="ln754"> </a>
<a name="ln755"> </a>
<a name="ln756">struct picture_data_entry_header {</a>
<a name="ln757">	uint16 op;</a>
<a name="ln758">	uint32 size;</a>
<a name="ln759">} _PACKED;</a>
<a name="ln760"> </a>
<a name="ln761"> </a>
<a name="ln762">status_t</a>
<a name="ln763">PicturePlayer::_Play(const picture_player_callbacks&amp; callbacks, void* userData,</a>
<a name="ln764">	const void* buffer, size_t length, uint16 parentOp)</a>
<a name="ln765">{</a>
<a name="ln766">#if DEBUG</a>
<a name="ln767">	printf(&quot;Start rendering %sBPicture...\n&quot;, parentOp != 0 ? &quot;sub &quot; : &quot;&quot;);</a>
<a name="ln768">	bigtime_t startTime = system_time();</a>
<a name="ln769">	int32 numOps = 0;</a>
<a name="ln770">#endif</a>
<a name="ln771"> </a>
<a name="ln772">	DataReader pictureReader(buffer, length);</a>
<a name="ln773"> </a>
<a name="ln774">	while (pictureReader.Remaining() &gt; 0) {</a>
<a name="ln775">		const picture_data_entry_header* header;</a>
<a name="ln776">		const uint8* opData = NULL;</a>
<a name="ln777">		if (!pictureReader.Get(header)</a>
<a name="ln778">			|| !pictureReader.Get(opData, header-&gt;size)) {</a>
<a name="ln779">			return B_BAD_DATA;</a>
<a name="ln780">		}</a>
<a name="ln781"> </a>
<a name="ln782">		DataReader reader(opData, header-&gt;size);</a>
<a name="ln783"> </a>
<a name="ln784">		// Disallow ops that don't fit the parent.</a>
<a name="ln785">		switch (parentOp) {</a>
<a name="ln786">			case 0:</a>
<a name="ln787">				// No parent op, no restrictions.</a>
<a name="ln788">				break;</a>
<a name="ln789"> </a>
<a name="ln790">			case B_PIC_ENTER_STATE_CHANGE:</a>
<a name="ln791">				if (header-&gt;op &lt;= B_PIC_ENTER_STATE_CHANGE</a>
<a name="ln792">					|| header-&gt;op &gt; B_PIC_SET_TRANSFORM) {</a>
<a name="ln793">					return B_BAD_DATA;</a>
<a name="ln794">				}</a>
<a name="ln795">				break;</a>
<a name="ln796"> </a>
<a name="ln797">			case B_PIC_ENTER_FONT_STATE:</a>
<a name="ln798">				if (header-&gt;op &lt; B_PIC_SET_FONT_FAMILY</a>
<a name="ln799">					|| header-&gt;op &gt; B_PIC_SET_FONT_FACE) {</a>
<a name="ln800">					return B_BAD_DATA;</a>
<a name="ln801">					}</a>
<a name="ln802">				break;</a>
<a name="ln803"> </a>
<a name="ln804">			default:</a>
<a name="ln805">				return B_BAD_DATA;</a>
<a name="ln806">		}</a>
<a name="ln807"> </a>
<a name="ln808">#if DEBUG &gt; 1</a>
<a name="ln809">		bigtime_t startOpTime = system_time();</a>
<a name="ln810">		printf(&quot;Op %s &quot;, PictureOpToString(header-&gt;op));</a>
<a name="ln811">#endif</a>
<a name="ln812">		switch (header-&gt;op) {</a>
<a name="ln813">			case B_PIC_MOVE_PEN_BY:</a>
<a name="ln814">			{</a>
<a name="ln815">				const BPoint* where;</a>
<a name="ln816">				if (callbacks.move_pen_by == NULL || !reader.Get(where))</a>
<a name="ln817">					break;</a>
<a name="ln818"> </a>
<a name="ln819">				callbacks.move_pen_by(userData, *where);</a>
<a name="ln820">				break;</a>
<a name="ln821">			}</a>
<a name="ln822"> </a>
<a name="ln823">			case B_PIC_STROKE_LINE:</a>
<a name="ln824">			{</a>
<a name="ln825">				const BPoint* start;</a>
<a name="ln826">				const BPoint* end;</a>
<a name="ln827">				if (callbacks.stroke_line == NULL || !reader.Get(start)</a>
<a name="ln828">					|| !reader.Get(end)) {</a>
<a name="ln829">					break;</a>
<a name="ln830">				}</a>
<a name="ln831"> </a>
<a name="ln832">				callbacks.stroke_line(userData, *start, *end);</a>
<a name="ln833">				break;</a>
<a name="ln834">			}</a>
<a name="ln835"> </a>
<a name="ln836">			case B_PIC_STROKE_RECT:</a>
<a name="ln837">			case B_PIC_FILL_RECT:</a>
<a name="ln838">			{</a>
<a name="ln839">				const BRect* rect;</a>
<a name="ln840">				if (callbacks.draw_rect == NULL || !reader.Get(rect))</a>
<a name="ln841">					break;</a>
<a name="ln842"> </a>
<a name="ln843">				callbacks.draw_rect(userData, *rect,</a>
<a name="ln844">					header-&gt;op == B_PIC_FILL_RECT);</a>
<a name="ln845">				break;</a>
<a name="ln846">			}</a>
<a name="ln847"> </a>
<a name="ln848">			case B_PIC_STROKE_ROUND_RECT:</a>
<a name="ln849">			case B_PIC_FILL_ROUND_RECT:</a>
<a name="ln850">			{</a>
<a name="ln851">				const BRect* rect;</a>
<a name="ln852">				const BPoint* radii;</a>
<a name="ln853">				if (callbacks.draw_round_rect == NULL || !reader.Get(rect)</a>
<a name="ln854">					|| !reader.Get(radii)) {</a>
<a name="ln855">					break;</a>
<a name="ln856">				}</a>
<a name="ln857"> </a>
<a name="ln858">				callbacks.draw_round_rect(userData, *rect, *radii,</a>
<a name="ln859">					header-&gt;op == B_PIC_FILL_ROUND_RECT);</a>
<a name="ln860">				break;</a>
<a name="ln861">			}</a>
<a name="ln862"> </a>
<a name="ln863">			case B_PIC_STROKE_BEZIER:</a>
<a name="ln864">			case B_PIC_FILL_BEZIER:</a>
<a name="ln865">			{</a>
<a name="ln866">				const size_t kNumControlPoints = 4;</a>
<a name="ln867">				const BPoint* controlPoints;</a>
<a name="ln868">				if (callbacks.draw_bezier == NULL</a>
<a name="ln869">					|| !reader.Get(controlPoints, kNumControlPoints)) {</a>
<a name="ln870">					break;</a>
<a name="ln871">				}</a>
<a name="ln872"> </a>
<a name="ln873">				callbacks.draw_bezier(userData, kNumControlPoints,</a>
<a name="ln874">					controlPoints, header-&gt;op == B_PIC_FILL_BEZIER);</a>
<a name="ln875">				break;</a>
<a name="ln876">			}</a>
<a name="ln877"> </a>
<a name="ln878">			case B_PIC_STROKE_ARC:</a>
<a name="ln879">			case B_PIC_FILL_ARC:</a>
<a name="ln880">			{</a>
<a name="ln881">				const BPoint* center;</a>
<a name="ln882">				const BPoint* radii;</a>
<a name="ln883">				const float* startTheta;</a>
<a name="ln884">				const float* arcTheta;</a>
<a name="ln885">				if (callbacks.draw_arc == NULL || !reader.Get(center)</a>
<a name="ln886">					|| !reader.Get(radii) || !reader.Get(startTheta)</a>
<a name="ln887">					|| !reader.Get(arcTheta)) {</a>
<a name="ln888">					break;</a>
<a name="ln889">				}</a>
<a name="ln890"> </a>
<a name="ln891">				callbacks.draw_arc(userData, *center, *radii, *startTheta,</a>
<a name="ln892">					*arcTheta, header-&gt;op == B_PIC_FILL_ARC);</a>
<a name="ln893">				break;</a>
<a name="ln894">			}</a>
<a name="ln895"> </a>
<a name="ln896">			case B_PIC_STROKE_ELLIPSE:</a>
<a name="ln897">			case B_PIC_FILL_ELLIPSE:</a>
<a name="ln898">			{</a>
<a name="ln899">				const BRect* rect;</a>
<a name="ln900">				if (callbacks.draw_ellipse == NULL || !reader.Get(rect))</a>
<a name="ln901">					break;</a>
<a name="ln902"> </a>
<a name="ln903">				callbacks.draw_ellipse(userData, *rect,</a>
<a name="ln904">					header-&gt;op == B_PIC_FILL_ELLIPSE);</a>
<a name="ln905">				break;</a>
<a name="ln906">			}</a>
<a name="ln907"> </a>
<a name="ln908">			case B_PIC_STROKE_POLYGON:</a>
<a name="ln909">			case B_PIC_FILL_POLYGON:</a>
<a name="ln910">			{</a>
<a name="ln911">				const uint32* numPoints;</a>
<a name="ln912">				const BPoint* points;</a>
<a name="ln913">				if (callbacks.draw_polygon == NULL || !reader.Get(numPoints)</a>
<a name="ln914">					|| !reader.Get(points, *numPoints)) {</a>
<a name="ln915">					break;</a>
<a name="ln916">				}</a>
<a name="ln917"> </a>
<a name="ln918">				bool isClosed = true;</a>
<a name="ln919">				const bool* closedPointer;</a>
<a name="ln920">				if (header-&gt;op != B_PIC_FILL_POLYGON) {</a>
<a name="ln921">					if (!reader.Get(closedPointer))</a>
<a name="ln922">						break;</a>
<a name="ln923"> </a>
<a name="ln924">					isClosed = *closedPointer;</a>
<a name="ln925">				}</a>
<a name="ln926"> </a>
<a name="ln927">				callbacks.draw_polygon(userData, *numPoints, points, isClosed,</a>
<a name="ln928">					header-&gt;op == B_PIC_FILL_POLYGON);</a>
<a name="ln929">				break;</a>
<a name="ln930">			}</a>
<a name="ln931"> </a>
<a name="ln932">			case B_PIC_STROKE_SHAPE:</a>
<a name="ln933">			case B_PIC_FILL_SHAPE:</a>
<a name="ln934">			{</a>
<a name="ln935">				const uint32* opCount;</a>
<a name="ln936">				const uint32* pointCount;</a>
<a name="ln937">				const uint32* opList;</a>
<a name="ln938">				const BPoint* pointList;</a>
<a name="ln939">				if (callbacks.draw_shape == NULL || !reader.Get(opCount)</a>
<a name="ln940">					|| !reader.Get(pointCount) || !reader.Get(opList, *opCount)</a>
<a name="ln941">					|| !reader.Get(pointList, *pointCount)) {</a>
<a name="ln942">					break;</a>
<a name="ln943">				}</a>
<a name="ln944"> </a>
<a name="ln945">				// TODO: remove BShape data copying</a>
<a name="ln946">				BShape shape;</a>
<a name="ln947">				shape.SetData(*opCount, *pointCount, opList, pointList);</a>
<a name="ln948"> </a>
<a name="ln949">				callbacks.draw_shape(userData, shape,</a>
<a name="ln950">					header-&gt;op == B_PIC_FILL_SHAPE);</a>
<a name="ln951">				break;</a>
<a name="ln952">			}</a>
<a name="ln953"> </a>
<a name="ln954">			case B_PIC_DRAW_STRING:</a>
<a name="ln955">			{</a>
<a name="ln956">				const float* escapementSpace;</a>
<a name="ln957">				const float* escapementNonSpace;</a>
<a name="ln958">				const char* string;</a>
<a name="ln959">				size_t length;</a>
<a name="ln960">				if (callbacks.draw_string == NULL</a>
<a name="ln961">					|| !reader.Get(escapementSpace)</a>
<a name="ln962">					|| !reader.Get(escapementNonSpace)</a>
<a name="ln963">					|| !reader.GetRemaining(string, length)) {</a>
<a name="ln964">					break;</a>
<a name="ln965">				}</a>
<a name="ln966"> </a>
<a name="ln967">				callbacks.draw_string(userData, string, length,</a>
<a name="ln968">					*escapementSpace, *escapementNonSpace);</a>
<a name="ln969">				break;</a>
<a name="ln970">			}</a>
<a name="ln971"> </a>
<a name="ln972">			case B_PIC_DRAW_STRING_LOCATIONS:</a>
<a name="ln973">			{</a>
<a name="ln974">				const uint32* pointCount;</a>
<a name="ln975">				const BPoint* pointList;</a>
<a name="ln976">				const char* string;</a>
<a name="ln977">				size_t length;</a>
<a name="ln978">				if (callbacks.draw_string_locations == NULL</a>
<a name="ln979">					|| !reader.Get(pointCount)</a>
<a name="ln980">					|| !reader.Get(pointList, *pointCount)</a>
<a name="ln981">					|| !reader.GetRemaining(string, length)) {</a>
<a name="ln982">					break;</a>
<a name="ln983">				}</a>
<a name="ln984"> </a>
<a name="ln985">				callbacks.draw_string_locations(userData, string, length,</a>
<a name="ln986">					pointList, *pointCount);</a>
<a name="ln987">				break;</a>
<a name="ln988">			}</a>
<a name="ln989"> </a>
<a name="ln990">			case B_PIC_DRAW_PIXELS:</a>
<a name="ln991">			{</a>
<a name="ln992">				const BRect* sourceRect;</a>
<a name="ln993">				const BRect* destinationRect;</a>
<a name="ln994">				const uint32* width;</a>
<a name="ln995">				const uint32* height;</a>
<a name="ln996">				const uint32* bytesPerRow;</a>
<a name="ln997">				const uint32* colorSpace;</a>
<a name="ln998">				const uint32* flags;</a>
<a name="ln999">				const void* data;</a>
<a name="ln1000">				size_t length;</a>
<a name="ln1001">				if (callbacks.draw_pixels == NULL || !reader.Get(sourceRect)</a>
<a name="ln1002">					|| !reader.Get(destinationRect) || !reader.Get(width)</a>
<a name="ln1003">					|| !reader.Get(height) || !reader.Get(bytesPerRow)</a>
<a name="ln1004">					|| !reader.Get(colorSpace) || !reader.Get(flags)</a>
<a name="ln1005">					|| !reader.GetRemaining(data, length)) {</a>
<a name="ln1006">					break;</a>
<a name="ln1007">				}</a>
<a name="ln1008"> </a>
<a name="ln1009">				callbacks.draw_pixels(userData, *sourceRect, *destinationRect,</a>
<a name="ln1010">					*width, *height, *bytesPerRow, (color_space)*colorSpace,</a>
<a name="ln1011">					*flags, data, length);</a>
<a name="ln1012">				break;</a>
<a name="ln1013">			}</a>
<a name="ln1014"> </a>
<a name="ln1015">			case B_PIC_DRAW_PICTURE:</a>
<a name="ln1016">			{</a>
<a name="ln1017">				const BPoint* where;</a>
<a name="ln1018">				const int32* token;</a>
<a name="ln1019">				if (callbacks.draw_picture == NULL || !reader.Get(where)</a>
<a name="ln1020">					|| !reader.Get(token)) {</a>
<a name="ln1021">					break;</a>
<a name="ln1022">				}</a>
<a name="ln1023"> </a>
<a name="ln1024">				callbacks.draw_picture(userData, *where, *token);</a>
<a name="ln1025">				break;</a>
<a name="ln1026">			}</a>
<a name="ln1027"> </a>
<a name="ln1028">			case B_PIC_SET_CLIPPING_RECTS:</a>
<a name="ln1029">			{</a>
<a name="ln1030">				const uint32* numRects;</a>
<a name="ln1031">				const BRect* rects;</a>
<a name="ln1032">				if (callbacks.set_clipping_rects == NULL</a>
<a name="ln1033">					|| !reader.Get(numRects) || !reader.Get(rects, *numRects)) {</a>
<a name="ln1034">					break;</a>
<a name="ln1035">				}</a>
<a name="ln1036"> </a>
<a name="ln1037">				callbacks.set_clipping_rects(userData, *numRects, rects);</a>
<a name="ln1038">				break;</a>
<a name="ln1039">			}</a>
<a name="ln1040"> </a>
<a name="ln1041">			case B_PIC_CLEAR_CLIPPING_RECTS:</a>
<a name="ln1042">			{</a>
<a name="ln1043">				if (callbacks.set_clipping_rects == NULL)</a>
<a name="ln1044">					break;</a>
<a name="ln1045"> </a>
<a name="ln1046">				callbacks.set_clipping_rects(userData, 0, NULL);</a>
<a name="ln1047">				break;</a>
<a name="ln1048">			}</a>
<a name="ln1049"> </a>
<a name="ln1050">			case B_PIC_CLIP_TO_PICTURE:</a>
<a name="ln1051">			{</a>
<a name="ln1052">				const int32* token;</a>
<a name="ln1053">				const BPoint* where;</a>
<a name="ln1054">				const bool* inverse;</a>
<a name="ln1055">				if (callbacks.clip_to_picture == NULL || !reader.Get(token)</a>
<a name="ln1056">					|| !reader.Get(where) || !reader.Get(inverse))</a>
<a name="ln1057">					break;</a>
<a name="ln1058"> </a>
<a name="ln1059">				callbacks.clip_to_picture(userData, *token, *where, *inverse);</a>
<a name="ln1060">				break;</a>
<a name="ln1061">			}</a>
<a name="ln1062"> </a>
<a name="ln1063">			case B_PIC_PUSH_STATE:</a>
<a name="ln1064">			{</a>
<a name="ln1065">				if (callbacks.push_state == NULL)</a>
<a name="ln1066">					break;</a>
<a name="ln1067"> </a>
<a name="ln1068">				callbacks.push_state(userData);</a>
<a name="ln1069">				break;</a>
<a name="ln1070">			}</a>
<a name="ln1071"> </a>
<a name="ln1072">			case B_PIC_POP_STATE:</a>
<a name="ln1073">			{</a>
<a name="ln1074">				if (callbacks.pop_state == NULL)</a>
<a name="ln1075">					break;</a>
<a name="ln1076"> </a>
<a name="ln1077">				callbacks.pop_state(userData);</a>
<a name="ln1078">				break;</a>
<a name="ln1079">			}</a>
<a name="ln1080"> </a>
<a name="ln1081">			case B_PIC_ENTER_STATE_CHANGE:</a>
<a name="ln1082">			case B_PIC_ENTER_FONT_STATE:</a>
<a name="ln1083">			{</a>
<a name="ln1084">				const void* data;</a>
<a name="ln1085">				size_t length;</a>
<a name="ln1086">				if (!reader.GetRemaining(data, length))</a>
<a name="ln1087">					break;</a>
<a name="ln1088"> </a>
<a name="ln1089">				if (header-&gt;op == B_PIC_ENTER_STATE_CHANGE) {</a>
<a name="ln1090">					if (callbacks.enter_state_change != NULL)</a>
<a name="ln1091">						callbacks.enter_state_change(userData);</a>
<a name="ln1092">				} else if (callbacks.enter_font_state != NULL)</a>
<a name="ln1093">					callbacks.enter_font_state(userData);</a>
<a name="ln1094"> </a>
<a name="ln1095">				status_t result = _Play(callbacks, userData, data, length,</a>
<a name="ln1096">					header-&gt;op);</a>
<a name="ln1097">				if (result != B_OK)</a>
<a name="ln1098">					return result;</a>
<a name="ln1099"> </a>
<a name="ln1100">				if (header-&gt;op == B_PIC_ENTER_STATE_CHANGE) {</a>
<a name="ln1101">					if (callbacks.exit_state_change != NULL)</a>
<a name="ln1102">						callbacks.exit_state_change(userData);</a>
<a name="ln1103">				} else if (callbacks.exit_font_state != NULL)</a>
<a name="ln1104">					callbacks.exit_font_state(userData);</a>
<a name="ln1105"> </a>
<a name="ln1106">				break;</a>
<a name="ln1107">			}</a>
<a name="ln1108"> </a>
<a name="ln1109">			case B_PIC_SET_ORIGIN:</a>
<a name="ln1110">			{</a>
<a name="ln1111">				const BPoint* origin;</a>
<a name="ln1112">				if (callbacks.set_origin == NULL || !reader.Get(origin))</a>
<a name="ln1113">					break;</a>
<a name="ln1114"> </a>
<a name="ln1115">				callbacks.set_origin(userData, *origin);</a>
<a name="ln1116">				break;</a>
<a name="ln1117">			}</a>
<a name="ln1118"> </a>
<a name="ln1119">			case B_PIC_SET_PEN_LOCATION:</a>
<a name="ln1120">			{</a>
<a name="ln1121">				const BPoint* location;</a>
<a name="ln1122">				if (callbacks.set_pen_location == NULL || !reader.Get(location))</a>
<a name="ln1123">					break;</a>
<a name="ln1124"> </a>
<a name="ln1125">				callbacks.set_pen_location(userData, *location);</a>
<a name="ln1126">				break;</a>
<a name="ln1127">			}</a>
<a name="ln1128"> </a>
<a name="ln1129">			case B_PIC_SET_DRAWING_MODE:</a>
<a name="ln1130">			{</a>
<a name="ln1131">				const uint16* mode;</a>
<a name="ln1132">				if (callbacks.set_drawing_mode == NULL || !reader.Get(mode))</a>
<a name="ln1133">					break;</a>
<a name="ln1134"> </a>
<a name="ln1135">				callbacks.set_drawing_mode(userData, (drawing_mode)*mode);</a>
<a name="ln1136">				break;</a>
<a name="ln1137">			}</a>
<a name="ln1138"> </a>
<a name="ln1139">			case B_PIC_SET_LINE_MODE:</a>
<a name="ln1140">			{</a>
<a name="ln1141">				const uint16* capMode;</a>
<a name="ln1142">				const uint16* joinMode;</a>
<a name="ln1143">				const float* miterLimit;</a>
<a name="ln1144">				if (callbacks.set_line_mode == NULL || !reader.Get(capMode)</a>
<a name="ln1145">					|| !reader.Get(joinMode) || !reader.Get(miterLimit)) {</a>
<a name="ln1146">					break;</a>
<a name="ln1147">				}</a>
<a name="ln1148"> </a>
<a name="ln1149">				callbacks.set_line_mode(userData, (cap_mode)*capMode,</a>
<a name="ln1150">					(join_mode)*joinMode, *miterLimit);</a>
<a name="ln1151">				break;</a>
<a name="ln1152">			}</a>
<a name="ln1153"> </a>
<a name="ln1154">			case B_PIC_SET_PEN_SIZE:</a>
<a name="ln1155">			{</a>
<a name="ln1156">				const float* penSize;</a>
<a name="ln1157">				if (callbacks.set_pen_size == NULL || !reader.Get(penSize))</a>
<a name="ln1158">					break;</a>
<a name="ln1159"> </a>
<a name="ln1160">				callbacks.set_pen_size(userData, *penSize);</a>
<a name="ln1161">				break;</a>
<a name="ln1162">			}</a>
<a name="ln1163"> </a>
<a name="ln1164">			case B_PIC_SET_FORE_COLOR:</a>
<a name="ln1165">			{</a>
<a name="ln1166">				const rgb_color* color;</a>
<a name="ln1167">				if (callbacks.set_fore_color == NULL || !reader.Get(color))</a>
<a name="ln1168">					break;</a>
<a name="ln1169"> </a>
<a name="ln1170">				callbacks.set_fore_color(userData, *color);</a>
<a name="ln1171">				break;</a>
<a name="ln1172">			}</a>
<a name="ln1173"> </a>
<a name="ln1174">			case B_PIC_SET_BACK_COLOR:</a>
<a name="ln1175">			{</a>
<a name="ln1176">				const rgb_color* color;</a>
<a name="ln1177">				if (callbacks.set_back_color == NULL || !reader.Get(color))</a>
<a name="ln1178">					break;</a>
<a name="ln1179"> </a>
<a name="ln1180">				callbacks.set_back_color(userData, *color);</a>
<a name="ln1181">				break;</a>
<a name="ln1182">			}</a>
<a name="ln1183"> </a>
<a name="ln1184">			case B_PIC_SET_STIPLE_PATTERN:</a>
<a name="ln1185">			{</a>
<a name="ln1186">				const pattern* stipplePattern;</a>
<a name="ln1187">				if (callbacks.set_stipple_pattern == NULL</a>
<a name="ln1188">					|| !reader.Get(stipplePattern)) {</a>
<a name="ln1189">					break;</a>
<a name="ln1190">				}</a>
<a name="ln1191"> </a>
<a name="ln1192">				callbacks.set_stipple_pattern(userData, *stipplePattern);</a>
<a name="ln1193">				break;</a>
<a name="ln1194">			}</a>
<a name="ln1195"> </a>
<a name="ln1196">			case B_PIC_SET_SCALE:</a>
<a name="ln1197">			{</a>
<a name="ln1198">				const float* scale;</a>
<a name="ln1199">				if (callbacks.set_scale == NULL || !reader.Get(scale))</a>
<a name="ln1200">					break;</a>
<a name="ln1201"> </a>
<a name="ln1202">				callbacks.set_scale(userData, *scale);</a>
<a name="ln1203">				break;</a>
<a name="ln1204">			}</a>
<a name="ln1205"> </a>
<a name="ln1206">			case B_PIC_SET_FONT_FAMILY:</a>
<a name="ln1207">			{</a>
<a name="ln1208">				const char* family;</a>
<a name="ln1209">				size_t length;</a>
<a name="ln1210">				if (callbacks.set_font_family == NULL</a>
<a name="ln1211">					|| !reader.GetRemaining(family, length)) {</a>
<a name="ln1212">					break;</a>
<a name="ln1213">				}</a>
<a name="ln1214"> </a>
<a name="ln1215">				callbacks.set_font_family(userData, family, length);</a>
<a name="ln1216">				break;</a>
<a name="ln1217">			}</a>
<a name="ln1218"> </a>
<a name="ln1219">			case B_PIC_SET_FONT_STYLE:</a>
<a name="ln1220">			{</a>
<a name="ln1221">				const char* style;</a>
<a name="ln1222">				size_t length;</a>
<a name="ln1223">				if (callbacks.set_font_style == NULL</a>
<a name="ln1224">					|| !reader.GetRemaining(style, length)) {</a>
<a name="ln1225">					break;</a>
<a name="ln1226">				}</a>
<a name="ln1227"> </a>
<a name="ln1228">				callbacks.set_font_style(userData, style, length);</a>
<a name="ln1229">				break;</a>
<a name="ln1230">			}</a>
<a name="ln1231"> </a>
<a name="ln1232">			case B_PIC_SET_FONT_SPACING:</a>
<a name="ln1233">			{</a>
<a name="ln1234">				const uint32* spacing;</a>
<a name="ln1235">				if (callbacks.set_font_spacing == NULL || !reader.Get(spacing))</a>
<a name="ln1236">					break;</a>
<a name="ln1237"> </a>
<a name="ln1238">				callbacks.set_font_spacing(userData, *spacing);</a>
<a name="ln1239">				break;</a>
<a name="ln1240">			}</a>
<a name="ln1241"> </a>
<a name="ln1242">			case B_PIC_SET_FONT_SIZE:</a>
<a name="ln1243">			{</a>
<a name="ln1244">				const float* size;</a>
<a name="ln1245">				if (callbacks.set_font_size == NULL || !reader.Get(size))</a>
<a name="ln1246">					break;</a>
<a name="ln1247"> </a>
<a name="ln1248">				callbacks.set_font_size(userData, *size);</a>
<a name="ln1249">				break;</a>
<a name="ln1250">			}</a>
<a name="ln1251"> </a>
<a name="ln1252">			case B_PIC_SET_FONT_ROTATE:</a>
<a name="ln1253">			{</a>
<a name="ln1254">				const float* rotation;</a>
<a name="ln1255">				if (callbacks.set_font_rotation == NULL</a>
<a name="ln1256">					|| !reader.Get(rotation)) {</a>
<a name="ln1257">					break;</a>
<a name="ln1258">				}</a>
<a name="ln1259"> </a>
<a name="ln1260">				callbacks.set_font_rotation(userData, *rotation);</a>
<a name="ln1261">				break;</a>
<a name="ln1262">			}</a>
<a name="ln1263"> </a>
<a name="ln1264">			case B_PIC_SET_FONT_ENCODING:</a>
<a name="ln1265">			{</a>
<a name="ln1266">				const uint32* encoding;</a>
<a name="ln1267">				if (callbacks.set_font_encoding == NULL</a>
<a name="ln1268">					|| !reader.Get(encoding)) {</a>
<a name="ln1269">					break;</a>
<a name="ln1270">				}</a>
<a name="ln1271"> </a>
<a name="ln1272">				callbacks.set_font_encoding(userData, *encoding);</a>
<a name="ln1273">				break;</a>
<a name="ln1274">			}</a>
<a name="ln1275"> </a>
<a name="ln1276">			case B_PIC_SET_FONT_FLAGS:</a>
<a name="ln1277">			{</a>
<a name="ln1278">				const uint32* flags;</a>
<a name="ln1279">				if (callbacks.set_font_flags == NULL || !reader.Get(flags))</a>
<a name="ln1280">					break;</a>
<a name="ln1281"> </a>
<a name="ln1282">				callbacks.set_font_flags(userData, *flags);</a>
<a name="ln1283">				break;</a>
<a name="ln1284">			}</a>
<a name="ln1285"> </a>
<a name="ln1286">			case B_PIC_SET_FONT_SHEAR:</a>
<a name="ln1287">			{</a>
<a name="ln1288">				const float* shear;</a>
<a name="ln1289">				if (callbacks.set_font_shear == NULL || !reader.Get(shear))</a>
<a name="ln1290">					break;</a>
<a name="ln1291"> </a>
<a name="ln1292">				callbacks.set_font_shear(userData, *shear);</a>
<a name="ln1293">				break;</a>
<a name="ln1294">			}</a>
<a name="ln1295"> </a>
<a name="ln1296">			case B_PIC_SET_FONT_FACE:</a>
<a name="ln1297">			{</a>
<a name="ln1298">				const uint32* face;</a>
<a name="ln1299">				if (callbacks.set_font_face == NULL || !reader.Get(face))</a>
<a name="ln1300">					break;</a>
<a name="ln1301"> </a>
<a name="ln1302">				callbacks.set_font_face(userData, *face);</a>
<a name="ln1303">				break;</a>
<a name="ln1304">			}</a>
<a name="ln1305"> </a>
<a name="ln1306">			case B_PIC_SET_BLENDING_MODE:</a>
<a name="ln1307">			{</a>
<a name="ln1308">				const uint16* alphaSourceMode;</a>
<a name="ln1309">				const uint16* alphaFunctionMode;</a>
<a name="ln1310">				if (callbacks.set_blending_mode == NULL</a>
<a name="ln1311">					|| !reader.Get(alphaSourceMode)</a>
<a name="ln1312">					|| !reader.Get(alphaFunctionMode)) {</a>
<a name="ln1313">					break;</a>
<a name="ln1314">				}</a>
<a name="ln1315"> </a>
<a name="ln1316">				callbacks.set_blending_mode(userData,</a>
<a name="ln1317">					(source_alpha)*alphaSourceMode,</a>
<a name="ln1318">					(alpha_function)*alphaFunctionMode);</a>
<a name="ln1319">				break;</a>
<a name="ln1320">			}</a>
<a name="ln1321"> </a>
<a name="ln1322">			case B_PIC_SET_TRANSFORM:</a>
<a name="ln1323">			{</a>
<a name="ln1324">				const BAffineTransform* transform;</a>
<a name="ln1325">				if (callbacks.set_transform == NULL || !reader.Get(transform))</a>
<a name="ln1326">					break;</a>
<a name="ln1327"> </a>
<a name="ln1328">				callbacks.set_transform(userData, *transform);</a>
<a name="ln1329">				break;</a>
<a name="ln1330">			}</a>
<a name="ln1331"> </a>
<a name="ln1332">			case B_PIC_AFFINE_TRANSLATE:</a>
<a name="ln1333">			{</a>
<a name="ln1334">				const double* x;</a>
<a name="ln1335">				const double* y;</a>
<a name="ln1336">				if (callbacks.translate_by == NULL || !reader.Get(x)</a>
<a name="ln1337">					|| !reader.Get(y)) {</a>
<a name="ln1338">					break;</a>
<a name="ln1339">				}</a>
<a name="ln1340"> </a>
<a name="ln1341">				callbacks.translate_by(userData, *x, *y);</a>
<a name="ln1342">				break;</a>
<a name="ln1343">			}</a>
<a name="ln1344"> </a>
<a name="ln1345">			case B_PIC_AFFINE_SCALE:</a>
<a name="ln1346">			{</a>
<a name="ln1347">				const double* x;</a>
<a name="ln1348">				const double* y;</a>
<a name="ln1349">				if (callbacks.scale_by == NULL || !reader.Get(x)</a>
<a name="ln1350">					|| !reader.Get(y)) {</a>
<a name="ln1351">					break;</a>
<a name="ln1352">				}</a>
<a name="ln1353"> </a>
<a name="ln1354">				callbacks.scale_by(userData, *x, *y);</a>
<a name="ln1355">				break;</a>
<a name="ln1356">			}</a>
<a name="ln1357"> </a>
<a name="ln1358">			case B_PIC_AFFINE_ROTATE:</a>
<a name="ln1359">			{</a>
<a name="ln1360">				const double* angleRadians;</a>
<a name="ln1361">				if (callbacks.rotate_by == NULL || !reader.Get(angleRadians))</a>
<a name="ln1362">					break;</a>
<a name="ln1363"> </a>
<a name="ln1364">				callbacks.rotate_by(userData, *angleRadians);</a>
<a name="ln1365">				break;</a>
<a name="ln1366">			}</a>
<a name="ln1367"> </a>
<a name="ln1368">			case B_PIC_BLEND_LAYER:</a>
<a name="ln1369">			{</a>
<a name="ln1370">				Layer* const* layer;</a>
<a name="ln1371">				if (callbacks.blend_layer == NULL || !reader.Get&lt;Layer*&gt;(layer))</a>
<a name="ln1372">					break;</a>
<a name="ln1373"> </a>
<a name="ln1374">				callbacks.blend_layer(userData, *layer);</a>
<a name="ln1375">				break;</a>
<a name="ln1376">			}</a>
<a name="ln1377"> </a>
<a name="ln1378">			case B_PIC_CLIP_TO_RECT:</a>
<a name="ln1379">			{</a>
<a name="ln1380">				const bool* inverse;</a>
<a name="ln1381">				const BRect* rect;</a>
<a name="ln1382"> </a>
<a name="ln1383">				if (callbacks.clip_to_rect == NULL || !reader.Get(inverse)</a>
<a name="ln1384">					|| !reader.Get(rect)) {</a>
<a name="ln1385">					break;</a>
<a name="ln1386">				}</a>
<a name="ln1387"> </a>
<a name="ln1388">				callbacks.clip_to_rect(userData, *rect, *inverse);</a>
<a name="ln1389">				break;</a>
<a name="ln1390">			}</a>
<a name="ln1391"> </a>
<a name="ln1392">			case B_PIC_CLIP_TO_SHAPE:</a>
<a name="ln1393">			{</a>
<a name="ln1394">				const bool* inverse;</a>
<a name="ln1395">				const uint32* opCount;</a>
<a name="ln1396">				const uint32* pointCount;</a>
<a name="ln1397">				const uint32* opList;</a>
<a name="ln1398">				const BPoint* pointList;</a>
<a name="ln1399">				if (callbacks.clip_to_shape == NULL || !reader.Get(inverse)</a>
<a name="ln1400">					|| !reader.Get(opCount) || !reader.Get(pointCount)</a>
<a name="ln1401">					|| !reader.Get(opList, *opCount)</a>
<a name="ln1402">					|| !reader.Get(pointList, *pointCount)) {</a>
<a name="ln1403">					break;</a>
<a name="ln1404">				}</a>
<a name="ln1405"> </a>
<a name="ln1406">				callbacks.clip_to_shape(userData, *opCount, opList,</a>
<a name="ln1407">					*pointCount, pointList, *inverse);</a>
<a name="ln1408">				break;</a>
<a name="ln1409">			}</a>
<a name="ln1410"> </a>
<a name="ln1411">			default:</a>
<a name="ln1412">				break;</a>
<a name="ln1413">		}</a>
<a name="ln1414"> </a>
<a name="ln1415">#if DEBUG</a>
<a name="ln1416">		numOps++;</a>
<a name="ln1417">#if DEBUG &gt; 1</a>
<a name="ln1418">		printf(&quot;executed in %&quot; B_PRId64 &quot; usecs\n&quot;, system_time()</a>
<a name="ln1419">			- startOpTime);</a>
<a name="ln1420">#endif</a>
<a name="ln1421">#endif</a>
<a name="ln1422">	}</a>
<a name="ln1423"> </a>
<a name="ln1424">#if DEBUG</a>
<a name="ln1425">	printf(&quot;Done! %&quot; B_PRId32 &quot; ops, rendering completed in %&quot; B_PRId64</a>
<a name="ln1426">		&quot; usecs.\n&quot;, numOps, system_time() - startTime);</a>
<a name="ln1427">#endif</a>
<a name="ln1428">	return B_OK;</a>
<a name="ln1429">}</a>

</code></pre>
<div class="balloon" rel="124"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v630/" target="_blank">V630</a> The 'malloc' function is used to allocate memory for an array of objects which are classes containing constructors.</p></div>
<div class="balloon" rel="203"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v630/" target="_blank">V630</a> The 'malloc' function is used to allocate memory for an array of objects which are classes containing constructors.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
