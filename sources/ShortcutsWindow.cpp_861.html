
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ShortcutsWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 1999-2009 Jeremy Friesner</a>
<a name="ln3"> * Copyright 2009-2010 Haiku, Inc. All rights reserved.</a>
<a name="ln4"> * Distributed under the terms of the MIT License.</a>
<a name="ln5"> *</a>
<a name="ln6"> * Authors:</a>
<a name="ln7"> *		Jeremy Friesner</a>
<a name="ln8"> *		Fredrik Mod√©en</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;ShortcutsWindow.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;math.h&gt;</a>
<a name="ln15">#include &lt;stdio.h&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;Alert.h&gt;</a>
<a name="ln18">#include &lt;Application.h&gt;</a>
<a name="ln19">#include &lt;Button.h&gt;</a>
<a name="ln20">#include &lt;Catalog.h&gt;</a>
<a name="ln21">#include &lt;Clipboard.h&gt;</a>
<a name="ln22">#include &lt;ColumnListView.h&gt;</a>
<a name="ln23">#include &lt;ColumnTypes.h&gt;</a>
<a name="ln24">#include &lt;ControlLook.h&gt;</a>
<a name="ln25">#include &lt;File.h&gt;</a>
<a name="ln26">#include &lt;FilePanel.h&gt;</a>
<a name="ln27">#include &lt;FindDirectory.h&gt;</a>
<a name="ln28">#include &lt;Input.h&gt;</a>
<a name="ln29">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln30">#include &lt;Locale.h&gt;</a>
<a name="ln31">#include &lt;Message.h&gt;</a>
<a name="ln32">#include &lt;Menu.h&gt;</a>
<a name="ln33">#include &lt;MenuBar.h&gt;</a>
<a name="ln34">#include &lt;MenuItem.h&gt;</a>
<a name="ln35">#include &lt;MessageFilter.h&gt;</a>
<a name="ln36">#include &lt;Path.h&gt;</a>
<a name="ln37">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln38">#include &lt;Screen.h&gt;</a>
<a name="ln39">#include &lt;ScrollBar.h&gt;</a>
<a name="ln40">#include &lt;ScrollView.h&gt;</a>
<a name="ln41">#include &lt;String.h&gt;</a>
<a name="ln42">#include &lt;SupportDefs.h&gt;</a>
<a name="ln43"> </a>
<a name="ln44">#include &quot;EditWindow.h&quot;</a>
<a name="ln45">#include &quot;KeyInfos.h&quot;</a>
<a name="ln46">#include &quot;MetaKeyStateMap.h&quot;</a>
<a name="ln47">#include &quot;ParseCommandLine.h&quot;</a>
<a name="ln48">#include &quot;PopUpColumn.h&quot;</a>
<a name="ln49">#include &quot;ShortcutsFilterConstants.h&quot;</a>
<a name="ln50">#include &quot;ShortcutsSpec.h&quot;</a>
<a name="ln51"> </a>
<a name="ln52"> </a>
<a name="ln53">// Window sizing constraints</a>
<a name="ln54">#define MAX_WIDTH 10000</a>
<a name="ln55">#define MAX_HEIGHT 10000</a>
<a name="ln56">	// SetSizeLimits does not provide a mechanism for specifying an</a>
<a name="ln57">	// unrestricted maximum. 10,000 seems to be the most common value used</a>
<a name="ln58">	// in other Haiku system applications.</a>
<a name="ln59"> </a>
<a name="ln60">#define WINDOW_SETTINGS_FILE_NAME &quot;Shortcuts_window_settings&quot;</a>
<a name="ln61">	// Because the &quot;shortcuts_settings&quot; file (SHORTCUTS_SETTING_FILE_NAME) is</a>
<a name="ln62">	// already used as a communications method between this configurator and</a>
<a name="ln63">	// the &quot;shortcut_catcher&quot; input_server filter, it should not be overloaded</a>
<a name="ln64">	// with window position information, instead, a separate file is used.</a>
<a name="ln65"> </a>
<a name="ln66">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln67">#define B_TRANSLATION_CONTEXT &quot;ShortcutsWindow&quot;</a>
<a name="ln68"> </a>
<a name="ln69">#define ERROR &quot;Shortcuts error&quot;</a>
<a name="ln70">#define WARNING &quot;Shortcuts warning&quot;</a>
<a name="ln71"> </a>
<a name="ln72"> </a>
<a name="ln73">// Creates a pop-up-menu that reflects the possible states of the specified</a>
<a name="ln74">// meta-key.</a>
<a name="ln75">static BPopUpMenu*</a>
<a name="ln76">CreateMetaPopUp(int column)</a>
<a name="ln77">{</a>
<a name="ln78">	MetaKeyStateMap&amp; map = GetNthKeyMap(column);</a>
<a name="ln79">	BPopUpMenu* popup = new BPopUpMenu(NULL, false);</a>
<a name="ln80">	int stateCount = map.GetNumStates();</a>
<a name="ln81"> </a>
<a name="ln82">	for (int i = 0; i &lt; stateCount; i++)</a>
<a name="ln83">		popup-&gt;AddItem(new BMenuItem(map.GetNthStateDesc(i), NULL));</a>
<a name="ln84"> </a>
<a name="ln85">	return popup;</a>
<a name="ln86">}</a>
<a name="ln87"> </a>
<a name="ln88"> </a>
<a name="ln89">// Creates a pop-up that allows the user to choose a key-cap visually</a>
<a name="ln90">static BPopUpMenu*</a>
<a name="ln91">CreateKeysPopUp()</a>
<a name="ln92">{</a>
<a name="ln93">	BPopUpMenu* popup = new BPopUpMenu(NULL, false);</a>
<a name="ln94">	int numKeys = GetNumKeyIndices();</a>
<a name="ln95">	for (int i = 0; i &lt; numKeys; i++) {</a>
<a name="ln96">		const char* next = GetKeyName(i);</a>
<a name="ln97">		if (next != NULL)</a>
<a name="ln98">			popup-&gt;AddItem(new BMenuItem(next, NULL));</a>
<a name="ln99">	}</a>
<a name="ln100"> </a>
<a name="ln101">	return popup;</a>
<a name="ln102">}</a>
<a name="ln103"> </a>
<a name="ln104"> </a>
<a name="ln105">ShortcutsWindow::ShortcutsWindow()</a>
<a name="ln106">	:</a>
<a name="ln107">	BWindow(BRect(0, 0, 0, 0), B_TRANSLATE_SYSTEM_NAME(&quot;Shortcuts&quot;),</a>
<a name="ln108">		B_TITLED_WINDOW, B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln109">	fSavePanel(NULL),</a>
<a name="ln110">	fOpenPanel(NULL),</a>
<a name="ln111">	fSelectPanel(NULL),</a>
<a name="ln112">	fKeySetModified(false),</a>
<a name="ln113">	fLastOpenWasAppend(false)</a>
<a name="ln114">{</a>
<a name="ln115">	ShortcutsSpec::InitializeMetaMaps();</a>
<a name="ln116"> </a>
<a name="ln117">	BMenuBar* menuBar = new BMenuBar(&quot;Menu Bar&quot;);</a>
<a name="ln118"> </a>
<a name="ln119">	BMenu* fileMenu = new BMenu(B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln120">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Open KeySet&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln121">		new BMessage(OPEN_KEYSET), 'O'));</a>
<a name="ln122">	fileMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln123">		B_TRANSLATE(&quot;Append KeySet&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln124">		new BMessage(APPEND_KEYSET), 'A'));</a>
<a name="ln125">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Revert to saved&quot;),</a>
<a name="ln126">		new BMessage(REVERT_KEYSET), 'R'));</a>
<a name="ln127">	fileMenu-&gt;AddItem(new BSeparatorItem);</a>
<a name="ln128">	fileMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln129">		B_TRANSLATE(&quot;Save KeySet as&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln130">		new BMessage(SAVE_KEYSET_AS), 'S'));</a>
<a name="ln131">	fileMenu-&gt;AddItem(new BSeparatorItem);</a>
<a name="ln132">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln133">		new BMessage(B_QUIT_REQUESTED), 'Q'));</a>
<a name="ln134">	menuBar-&gt;AddItem(fileMenu);</a>
<a name="ln135"> </a>
<a name="ln136">	fColumnListView = new BColumnListView(NULL,</a>
<a name="ln137">		B_WILL_DRAW | B_FRAME_EVENTS, B_FANCY_BORDER, false);</a>
<a name="ln138"> </a>
<a name="ln139">	float cellWidth = be_plain_font-&gt;StringWidth(&quot;Either&quot;) + 20;</a>
<a name="ln140">		// ShortcutsSpec does not seem to translate the string &quot;Either&quot;.</a>
<a name="ln141"> </a>
<a name="ln142">	for (int i = 0; i &lt; ShortcutsSpec::NUM_META_COLUMNS; i++) {</a>
<a name="ln143">		const char* name = ShortcutsSpec::GetColumnName(i);</a>
<a name="ln144">		float headerWidth = be_plain_font-&gt;StringWidth(name) + 20;</a>
<a name="ln145">		float width = max_c(headerWidth, cellWidth);</a>
<a name="ln146"> </a>
<a name="ln147">		fColumnListView-&gt;AddColumn(new PopUpColumn(CreateMetaPopUp(i), name,</a>
<a name="ln148">				width, width - 1, width * 1.5, B_TRUNCATE_END, false, true, 1),</a>
<a name="ln149">			fColumnListView-&gt;CountColumns());</a>
<a name="ln150">	}</a>
<a name="ln151"> </a>
<a name="ln152">	float keyCellWidth = be_plain_font-&gt;StringWidth(&quot;Caps Lock&quot;) + 20;</a>
<a name="ln153">	fColumnListView-&gt;AddColumn(new PopUpColumn(CreateKeysPopUp(),</a>
<a name="ln154">			B_TRANSLATE(&quot;Key&quot;), keyCellWidth, keyCellWidth - 10,</a>
<a name="ln155">			keyCellWidth + 30, B_TRUNCATE_END),</a>
<a name="ln156">		fColumnListView-&gt;CountColumns());</a>
<a name="ln157">	BPopUpMenu* popup = new BPopUpMenu(NULL, false);</a>
<a name="ln158">	popup-&gt;AddItem(new BMenuItem(</a>
<a name="ln159">		B_TRANSLATE(&quot;(Choose application with file requester)&quot;), NULL));</a>
<a name="ln160">	popup-&gt;AddItem(new BMenuItem(</a>
<a name="ln161">		B_TRANSLATE(&quot;*InsertString \&quot;Your Text Here\&quot;&quot;), NULL));</a>
<a name="ln162">	popup-&gt;AddItem(new BMenuItem(</a>
<a name="ln163">		B_TRANSLATE(&quot;*MoveMouse +20 +0&quot;), NULL));</a>
<a name="ln164">	popup-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;*MoveMouseTo 50% 50%&quot;), NULL));</a>
<a name="ln165">	popup-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;*MouseButton 1&quot;), NULL));</a>
<a name="ln166">	popup-&gt;AddItem(new BMenuItem(</a>
<a name="ln167">		B_TRANSLATE(&quot;*LaunchHandler text/html&quot;), NULL));</a>
<a name="ln168">	popup-&gt;AddItem(new BMenuItem(</a>
<a name="ln169">		B_TRANSLATE(&quot;*Multi \&quot;*MoveMouseTo 100% 0\&quot; \&quot;*MouseButton 1\&quot;&quot;),</a>
<a name="ln170">		NULL));</a>
<a name="ln171">	popup-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;*MouseDown&quot;), NULL));</a>
<a name="ln172">	popup-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;*MouseUp&quot;), NULL));</a>
<a name="ln173">	popup-&gt;AddItem(new BMenuItem(</a>
<a name="ln174">		B_TRANSLATE(&quot;*SendMessage application/x-vnd.Be-TRAK 'Tfnd'&quot;), NULL));</a>
<a name="ln175">	popup-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;*Beep&quot;), NULL));</a>
<a name="ln176">	fColumnListView-&gt;AddColumn(new PopUpColumn(popup, B_TRANSLATE(&quot;Application&quot;),</a>
<a name="ln177">			300.0, 223.0, 324.0, B_TRUNCATE_END, true),</a>
<a name="ln178">		fColumnListView-&gt;CountColumns());</a>
<a name="ln179"> </a>
<a name="ln180">	fColumnListView-&gt;SetSelectionMessage(new BMessage(HOTKEY_ITEM_SELECTED));</a>
<a name="ln181">	fColumnListView-&gt;SetSelectionMode(B_SINGLE_SELECTION_LIST);</a>
<a name="ln182">	fColumnListView-&gt;SetTarget(this);</a>
<a name="ln183"> </a>
<a name="ln184">	fAddButton = new BButton(&quot;add&quot;, B_TRANSLATE(&quot;Add new shortcut&quot;),</a>
<a name="ln185">		new BMessage(ADD_HOTKEY_ITEM));</a>
<a name="ln186"> </a>
<a name="ln187">	fRemoveButton = new BButton(&quot;remove&quot;,</a>
<a name="ln188">		B_TRANSLATE(&quot;Remove selected shortcut&quot;),</a>
<a name="ln189">		new BMessage(REMOVE_HOTKEY_ITEM));</a>
<a name="ln190">	fRemoveButton-&gt;SetEnabled(false);</a>
<a name="ln191"> </a>
<a name="ln192">	fSaveButton = new BButton(&quot;save&quot;, B_TRANSLATE(&quot;Save &amp; apply&quot;),</a>
<a name="ln193">		new BMessage(SAVE_KEYSET));</a>
<a name="ln194">	fSaveButton-&gt;SetEnabled(false);</a>
<a name="ln195"> </a>
<a name="ln196">	CenterOnScreen();</a>
<a name="ln197"> </a>
<a name="ln198">	fColumnListView-&gt;ResizeAllColumnsToPreferred();</a>
<a name="ln199"> </a>
<a name="ln200">	entry_ref windowSettingsRef;</a>
<a name="ln201">	if (_GetWindowSettingsFile(&amp;windowSettingsRef)) {</a>
<a name="ln202">		// The window settings file is not accepted via B_REFS_RECEIVED; this</a>
<a name="ln203">		// is a behind-the-scenes file that the user will never see or</a>
<a name="ln204">		// interact with.</a>
<a name="ln205">		BFile windowSettingsFile(&amp;windowSettingsRef, B_READ_ONLY);</a>
<a name="ln206">		BMessage loadMessage;</a>
<a name="ln207">		if (loadMessage.Unflatten(&amp;windowSettingsFile) == B_OK)</a>
<a name="ln208">			_LoadWindowSettings(loadMessage);</a>
<a name="ln209">	}</a>
<a name="ln210"> </a>
<a name="ln211">	entry_ref keySetRef;</a>
<a name="ln212">	if (_GetSettingsFile(&amp;keySetRef)) {</a>
<a name="ln213">		BMessage message(B_REFS_RECEIVED);</a>
<a name="ln214">		message.AddRef(&quot;refs&quot;, &amp;keySetRef);</a>
<a name="ln215">		message.AddString(&quot;startupRef&quot;, &quot;please&quot;);</a>
<a name="ln216">		PostMessage(&amp;message);</a>
<a name="ln217">			// tell ourselves to load this file if it exists</a>
<a name="ln218">	}</a>
<a name="ln219"> </a>
<a name="ln220">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln221">		.Add(menuBar)</a>
<a name="ln222">		.AddGroup(B_VERTICAL)</a>
<a name="ln223">			.SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET))</a>
<a name="ln224">			.SetInsets(B_USE_WINDOW_SPACING)</a>
<a name="ln225">			.Add(fColumnListView)</a>
<a name="ln226">			.AddGroup(B_HORIZONTAL)</a>
<a name="ln227">				.AddGroup(B_HORIZONTAL)</a>
<a name="ln228">				.SetExplicitAlignment(BAlignment(B_ALIGN_LEFT, B_ALIGN_TOP))</a>
<a name="ln229">				.Add(fAddButton)</a>
<a name="ln230">				.Add(fRemoveButton)</a>
<a name="ln231">				.End()</a>
<a name="ln232">				.AddGroup(B_HORIZONTAL)</a>
<a name="ln233">					.SetExplicitAlignment(BAlignment(B_ALIGN_RIGHT, B_ALIGN_TOP))</a>
<a name="ln234">					.Add(fSaveButton)</a>
<a name="ln235">				.End()</a>
<a name="ln236">			.End()</a>
<a name="ln237">		.End();</a>
<a name="ln238"> </a>
<a name="ln239">	Show();</a>
<a name="ln240">}</a>
<a name="ln241"> </a>
<a name="ln242"> </a>
<a name="ln243">ShortcutsWindow::~ShortcutsWindow()</a>
<a name="ln244">{</a>
<a name="ln245">	delete fSavePanel;</a>
<a name="ln246">	delete fOpenPanel;</a>
<a name="ln247">	delete fSelectPanel;</a>
<a name="ln248">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln249">}</a>
<a name="ln250"> </a>
<a name="ln251"> </a>
<a name="ln252">bool</a>
<a name="ln253">ShortcutsWindow::QuitRequested()</a>
<a name="ln254">{</a>
<a name="ln255">	bool result = true;</a>
<a name="ln256"> </a>
<a name="ln257">	if (fKeySetModified) {</a>
<a name="ln258">		BAlert* alert = new BAlert(WARNING,</a>
<a name="ln259">			B_TRANSLATE(&quot;Save changes before closing?&quot;),</a>
<a name="ln260">			B_TRANSLATE(&quot;Cancel&quot;), B_TRANSLATE(&quot;Don't save&quot;),</a>
<a name="ln261">			B_TRANSLATE(&quot;Save&quot;));</a>
<a name="ln262">		alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln263">		alert-&gt;SetShortcut(1, 'd');</a>
<a name="ln264">		alert-&gt;SetShortcut(2, 's');</a>
<a name="ln265">		switch (alert-&gt;Go()) {</a>
<a name="ln266">			case 0:</a>
<a name="ln267">				result = false;</a>
<a name="ln268">				break;</a>
<a name="ln269"> </a>
<a name="ln270">			case 1:</a>
<a name="ln271">				result = true;</a>
<a name="ln272">				break;</a>
<a name="ln273"> </a>
<a name="ln274">			case 2:</a>
<a name="ln275">				// Save: automatically if possible, otherwise go back and open</a>
<a name="ln276">				// up the file requester</a>
<a name="ln277">				if (fLastSaved.InitCheck() == B_OK) {</a>
<a name="ln278">					if (_SaveKeySet(fLastSaved) == false) {</a>
<a name="ln279">						BAlert* alert = new BAlert(ERROR,</a>
<a name="ln280">							B_TRANSLATE(&quot;Shortcuts was unable to save your &quot;</a>
<a name="ln281">								&quot;KeySet file!&quot;),</a>
<a name="ln282">							B_TRANSLATE(&quot;Oh no&quot;));</a>
<a name="ln283">						alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln284">						alert-&gt;Go();</a>
<a name="ln285">						result = true; // quit anyway</a>
<a name="ln286">					}</a>
<a name="ln287">				} else {</a>
<a name="ln288">					PostMessage(SAVE_KEYSET);</a>
<a name="ln289">					result = false;</a>
<a name="ln290">				}</a>
<a name="ln291">				break;</a>
<a name="ln292">		}</a>
<a name="ln293">	}</a>
<a name="ln294"> </a>
<a name="ln295">	if (result) {</a>
<a name="ln296">		fColumnListView-&gt;DeselectAll();</a>
<a name="ln297"> </a>
<a name="ln298">		// Save the window position.</a>
<a name="ln299">		entry_ref ref;</a>
<a name="ln300">		if (_GetWindowSettingsFile(&amp;ref)) {</a>
<a name="ln301">			BEntry entry(&amp;ref);</a>
<a name="ln302">			_SaveWindowSettings(entry);</a>
<a name="ln303">		}</a>
<a name="ln304">	}</a>
<a name="ln305"> </a>
<a name="ln306">	return result;</a>
<a name="ln307">}</a>
<a name="ln308"> </a>
<a name="ln309"> </a>
<a name="ln310">bool</a>
<a name="ln311">ShortcutsWindow::_GetSettingsFile(entry_ref* eref)</a>
<a name="ln312">{</a>
<a name="ln313">	BPath path;</a>
<a name="ln314">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path) != B_OK)</a>
<a name="ln315">		return false;</a>
<a name="ln316">	else</a>
<a name="ln317">		path.Append(SHORTCUTS_SETTING_FILE_NAME);</a>
<a name="ln318"> </a>
<a name="ln319">	if (BEntry(path.Path(), true).GetRef(eref) == B_OK)</a>
<a name="ln320">		return true;</a>
<a name="ln321">	else</a>
<a name="ln322">		return false;</a>
<a name="ln323">}</a>
<a name="ln324"> </a>
<a name="ln325"> </a>
<a name="ln326">// Saves a settings file to (saveEntry). Returns true iff successful.</a>
<a name="ln327">bool</a>
<a name="ln328">ShortcutsWindow::_SaveKeySet(BEntry&amp; saveEntry)</a>
<a name="ln329">{</a>
<a name="ln330">	BFile saveTo(&amp;saveEntry, B_WRITE_ONLY | B_CREATE_FILE | B_ERASE_FILE);</a>
<a name="ln331">	if (saveTo.InitCheck() != B_OK)</a>
<a name="ln332">		return false;</a>
<a name="ln333"> </a>
<a name="ln334">	BMessage saveMessage;</a>
<a name="ln335">	for (int i = 0; i &lt; fColumnListView-&gt;CountRows(); i++) {</a>
<a name="ln336">		BMessage next;</a>
<a name="ln337">		if (((ShortcutsSpec*)fColumnListView-&gt;RowAt(i))-&gt;Archive(&amp;next)</a>
<a name="ln338">				== B_OK) {</a>
<a name="ln339">			saveMessage.AddMessage(&quot;spec&quot;, &amp;next);</a>
<a name="ln340">		} else</a>
<a name="ln341">			printf(&quot;Error archiving ShortcutsSpec #%i!\n&quot;, i);</a>
<a name="ln342">	}</a>
<a name="ln343"> </a>
<a name="ln344">	bool result = (saveMessage.Flatten(&amp;saveTo) == B_OK);</a>
<a name="ln345"> </a>
<a name="ln346">	if (result) {</a>
<a name="ln347">		fKeySetModified = false;</a>
<a name="ln348">		fSaveButton-&gt;SetEnabled(false);</a>
<a name="ln349">	}</a>
<a name="ln350"> </a>
<a name="ln351">	return result;</a>
<a name="ln352">}</a>
<a name="ln353"> </a>
<a name="ln354"> </a>
<a name="ln355">// Appends new entries from the file specified in the &quot;spec&quot; entry of</a>
<a name="ln356">// (loadMessage). Returns true iff successful.</a>
<a name="ln357">bool</a>
<a name="ln358">ShortcutsWindow::_LoadKeySet(const BMessage&amp; loadMessage)</a>
<a name="ln359">{</a>
<a name="ln360">	int i = 0;</a>
<a name="ln361">	BMessage message;</a>
<a name="ln362">	while (loadMessage.FindMessage(&quot;spec&quot;, i++, &amp;message) == B_OK) {</a>
<a name="ln363">		ShortcutsSpec* spec</a>
<a name="ln364">			= (ShortcutsSpec*)ShortcutsSpec::Instantiate(&amp;message);</a>
<a name="ln365">		if (spec != NULL)</a>
<a name="ln366">			fColumnListView-&gt;AddRow(spec);</a>
<a name="ln367">		else</a>
<a name="ln368">			printf(&quot;_LoadKeySet: Error parsing spec!\n&quot;);</a>
<a name="ln369">	}</a>
<a name="ln370"> </a>
<a name="ln371">	return true;</a>
<a name="ln372">}</a>
<a name="ln373"> </a>
<a name="ln374"> </a>
<a name="ln375">// Gets the filesystem location of the &quot;Shortcuts_window_settings&quot; file.</a>
<a name="ln376">bool</a>
<a name="ln377">ShortcutsWindow::_GetWindowSettingsFile(entry_ref* eref)</a>
<a name="ln378">{</a>
<a name="ln379">	BPath path;</a>
<a name="ln380">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path) != B_OK)</a>
<a name="ln381">		return false;</a>
<a name="ln382">	else</a>
<a name="ln383">		path.Append(WINDOW_SETTINGS_FILE_NAME);</a>
<a name="ln384"> </a>
<a name="ln385">	return BEntry(path.Path(), true).GetRef(eref) == B_OK;</a>
<a name="ln386">}</a>
<a name="ln387"> </a>
<a name="ln388"> </a>
<a name="ln389">// Saves the application settings file to (saveEntry).  Because this is a</a>
<a name="ln390">// non-essential file, errors are ignored when writing the settings.</a>
<a name="ln391">void</a>
<a name="ln392">ShortcutsWindow::_SaveWindowSettings(BEntry&amp; saveEntry)</a>
<a name="ln393">{</a>
<a name="ln394">	BFile saveTo(&amp;saveEntry, B_WRITE_ONLY | B_CREATE_FILE | B_ERASE_FILE);</a>
<a name="ln395">	if (saveTo.InitCheck() != B_OK)</a>
<a name="ln396">		return;</a>
<a name="ln397"> </a>
<a name="ln398">	BMessage saveMsg;</a>
<a name="ln399">	saveMsg.AddRect(&quot;window frame&quot;, Frame());</a>
<a name="ln400"> </a>
<a name="ln401">	BMessage columnsState;</a>
<a name="ln402">	fColumnListView-&gt;SaveState(&amp;columnsState);</a>
<a name="ln403">	saveMsg.AddMessage (&quot;columns state&quot;, &amp;columnsState);</a>
<a name="ln404"> </a>
<a name="ln405">	saveMsg.Flatten(&amp;saveTo);</a>
<a name="ln406">}</a>
<a name="ln407"> </a>
<a name="ln408"> </a>
<a name="ln409">// Loads the application settings file from (loadMessage) and resizes</a>
<a name="ln410">// the interface to match the previously saved settings. Because this</a>
<a name="ln411">// is a non-essential file, errors are ignored when loading the settings.</a>
<a name="ln412">void</a>
<a name="ln413">ShortcutsWindow::_LoadWindowSettings(const BMessage&amp; loadMessage)</a>
<a name="ln414">{</a>
<a name="ln415">	BRect frame;</a>
<a name="ln416">	if (loadMessage.FindRect(&quot;window frame&quot;, &amp;frame) == B_OK) {</a>
<a name="ln417">		// ensure the frame does not resize below the computed minimum.</a>
<a name="ln418">		float width = max_c(Bounds().right, frame.right - frame.left);</a>
<a name="ln419">		float height = max_c(Bounds().bottom, frame.bottom - frame.top);</a>
<a name="ln420">		ResizeTo(width, height);</a>
<a name="ln421"> </a>
<a name="ln422">		// ensure the frame is not placed outside of the screen.</a>
<a name="ln423">		BScreen screen(this);</a>
<a name="ln424">		float left = min_c(screen.Frame().right - width, frame.left);</a>
<a name="ln425">		float top = min_c(screen.Frame().bottom - height, frame.top);</a>
<a name="ln426">		MoveTo(left, top);</a>
<a name="ln427">	}</a>
<a name="ln428"> </a>
<a name="ln429">	BMessage columnsStateMessage;</a>
<a name="ln430">	if (loadMessage.FindMessage (&quot;columns state&quot;, &amp;columnsStateMessage) == B_OK)</a>
<a name="ln431">		fColumnListView-&gt;LoadState(&amp;columnsStateMessage);</a>
<a name="ln432">}</a>
<a name="ln433"> </a>
<a name="ln434"> </a>
<a name="ln435">// Creates a new entry and adds it to the GUI. (defaultCommand) will be the</a>
<a name="ln436">// text in the entry, or NULL if no text is desired.</a>
<a name="ln437">void</a>
<a name="ln438">ShortcutsWindow::_AddNewSpec(const char* defaultCommand)</a>
<a name="ln439">{</a>
<a name="ln440">	_MarkKeySetModified();</a>
<a name="ln441"> </a>
<a name="ln442">	ShortcutsSpec* spec;</a>
<a name="ln443">	BRow* curSel = fColumnListView-&gt;CurrentSelection();</a>
<a name="ln444">	if (curSel)</a>
<a name="ln445">		spec = new ShortcutsSpec(*((ShortcutsSpec*)curSel));</a>
<a name="ln446">	else {</a>
<a name="ln447">		spec = new ShortcutsSpec(&quot;&quot;);</a>
<a name="ln448">		for (int i = 0; i &lt; fColumnListView-&gt;CountColumns(); i++)</a>
<a name="ln449">			spec-&gt;SetField(new BStringField(&quot;&quot;), i);</a>
<a name="ln450">	}</a>
<a name="ln451"> </a>
<a name="ln452">	fColumnListView-&gt;AddRow(spec);</a>
<a name="ln453">	fColumnListView-&gt;AddToSelection(spec);</a>
<a name="ln454">	fColumnListView-&gt;ScrollTo(spec);</a>
<a name="ln455">	if (defaultCommand)</a>
<a name="ln456">		spec-&gt;SetCommand(defaultCommand);</a>
<a name="ln457">}</a>
<a name="ln458"> </a>
<a name="ln459"> </a>
<a name="ln460">void</a>
<a name="ln461">ShortcutsWindow::MessageReceived(BMessage* message)</a>
<a name="ln462">{</a>
<a name="ln463">	switch (message-&gt;what) {</a>
<a name="ln464">		case OPEN_KEYSET:</a>
<a name="ln465">		case APPEND_KEYSET:</a>
<a name="ln466">			fLastOpenWasAppend = (message-&gt;what == APPEND_KEYSET);</a>
<a name="ln467">			if (fOpenPanel)</a>
<a name="ln468">				fOpenPanel-&gt;Show();</a>
<a name="ln469">			else {</a>
<a name="ln470">				BMessenger messenger(this);</a>
<a name="ln471">				fOpenPanel = new BFilePanel(B_OPEN_PANEL, &amp;messenger, NULL,</a>
<a name="ln472">					0, false);</a>
<a name="ln473">				fOpenPanel-&gt;Show();</a>
<a name="ln474">			}</a>
<a name="ln475">			fOpenPanel-&gt;SetButtonLabel(B_DEFAULT_BUTTON, fLastOpenWasAppend ?</a>
<a name="ln476">				B_TRANSLATE(&quot;Append&quot;) : B_TRANSLATE(&quot;Open&quot;));</a>
<a name="ln477">			break;</a>
<a name="ln478"> </a>
<a name="ln479">		// send a message to myself, to get me to reload the settings file</a>
<a name="ln480">		case REVERT_KEYSET:</a>
<a name="ln481">		{</a>
<a name="ln482">			fLastOpenWasAppend = false;</a>
<a name="ln483">			BMessage reload(B_REFS_RECEIVED);</a>
<a name="ln484">			entry_ref eref;</a>
<a name="ln485">			_GetSettingsFile(&amp;eref);</a>
<a name="ln486">			reload.AddRef(&quot;refs&quot;, &amp;eref);</a>
<a name="ln487">			reload.AddString(&quot;startupRef&quot;, &quot;yeah&quot;);</a>
<a name="ln488">			PostMessage(&amp;reload);</a>
<a name="ln489">			break;</a>
<a name="ln490">		}</a>
<a name="ln491"> </a>
<a name="ln492">		// respond to drag-and-drop messages here</a>
<a name="ln493">		case B_SIMPLE_DATA:</a>
<a name="ln494">		{</a>
<a name="ln495">			int i = 0;</a>
<a name="ln496"> </a>
<a name="ln497">			entry_ref ref;</a>
<a name="ln498">			while (message-&gt;FindRef(&quot;refs&quot;, i++, &amp;ref) == B_OK) {</a>
<a name="ln499">				BEntry entry(&amp;ref);</a>
<a name="ln500">				if (entry.InitCheck() == B_OK) {</a>
<a name="ln501">					BPath path(&amp;entry);</a>
<a name="ln502"> </a>
<a name="ln503">					if (path.InitCheck() == B_OK) {</a>
<a name="ln504">						// Add a new item with the given path.</a>
<a name="ln505">						BString str(path.Path());</a>
<a name="ln506">						DoStandardEscapes(str);</a>
<a name="ln507">						_AddNewSpec(str.String());</a>
<a name="ln508">					}</a>
<a name="ln509">				}</a>
<a name="ln510">			}</a>
<a name="ln511">			break;</a>
<a name="ln512">		}</a>
<a name="ln513"> </a>
<a name="ln514">		// respond to FileRequester's messages here</a>
<a name="ln515">		case B_REFS_RECEIVED:</a>
<a name="ln516">		{</a>
<a name="ln517">			// Find file ref</a>
<a name="ln518">			entry_ref ref;</a>
<a name="ln519">			bool isStartMsg = message-&gt;HasString(&quot;startupRef&quot;);</a>
<a name="ln520">			if (message-&gt;FindRef(&quot;refs&quot;, &amp;ref) == B_OK) {</a>
<a name="ln521">				// load the file into (fileMsg)</a>
<a name="ln522">				BMessage fileMsg;</a>
<a name="ln523">				{</a>
<a name="ln524">					BFile file(&amp;ref, B_READ_ONLY);</a>
<a name="ln525">					if ((file.InitCheck() != B_OK)</a>
<a name="ln526">						|| (fileMsg.Unflatten(&amp;file) != B_OK)) {</a>
<a name="ln527">						if (isStartMsg) {</a>
<a name="ln528">							// use this to save to anyway</a>
<a name="ln529">							fLastSaved = BEntry(&amp;ref);</a>
<a name="ln530">							break;</a>
<a name="ln531">						} else {</a>
<a name="ln532">							BAlert* alert = new BAlert(ERROR,</a>
<a name="ln533">								B_TRANSLATE(&quot;Shortcuts was couldn't open your &quot;</a>
<a name="ln534">								&quot;KeySet file!&quot;), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln535">							alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln536">							alert-&gt;Go(NULL);</a>
<a name="ln537">							break;</a>
<a name="ln538">						}</a>
<a name="ln539">					}</a>
<a name="ln540">				}</a>
<a name="ln541"> </a>
<a name="ln542">				if (fLastOpenWasAppend == false) {</a>
<a name="ln543">					// Clear the menu...</a>
<a name="ln544">					while (fColumnListView-&gt;CountRows()) {</a>
<a name="ln545">						ShortcutsSpec* row =</a>
<a name="ln546">							static_cast&lt;ShortcutsSpec*&gt;(fColumnListView-&gt;RowAt(0));</a>
<a name="ln547">						fColumnListView-&gt;RemoveRow(row);</a>
<a name="ln548">						delete row;</a>
<a name="ln549">					}</a>
<a name="ln550">				}</a>
<a name="ln551"> </a>
<a name="ln552">				if (_LoadKeySet(fileMsg)) {</a>
<a name="ln553">					if (isStartMsg) fLastSaved = BEntry(&amp;ref);</a>
<a name="ln554">					fSaveButton-&gt;SetEnabled(isStartMsg == false);</a>
<a name="ln555"> </a>
<a name="ln556">					// If we just loaded in the Shortcuts settings file, then</a>
<a name="ln557">					// no need to tell the user to save on exit.</a>
<a name="ln558">					entry_ref eref;</a>
<a name="ln559">					_GetSettingsFile(&amp;eref);</a>
<a name="ln560">					if (ref == eref) fKeySetModified = false;</a>
<a name="ln561">				} else {</a>
<a name="ln562">					BAlert* alert = new BAlert(ERROR,</a>
<a name="ln563">						B_TRANSLATE(&quot;Shortcuts was unable to parse your &quot;</a>
<a name="ln564">						&quot;KeySet file!&quot;), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln565">					alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln566">					alert-&gt;Go(NULL);</a>
<a name="ln567">					break;</a>
<a name="ln568">				}</a>
<a name="ln569">			}</a>
<a name="ln570">			break;</a>
<a name="ln571">		}</a>
<a name="ln572"> </a>
<a name="ln573">		// these messages come from the pop-up menu of the Applications column</a>
<a name="ln574">		case SELECT_APPLICATION:</a>
<a name="ln575">		{</a>
<a name="ln576">			ShortcutsSpec* row =</a>
<a name="ln577">				static_cast&lt;ShortcutsSpec*&gt;(fColumnListView-&gt;CurrentSelection());</a>
<a name="ln578">			if (row != NULL) {</a>
<a name="ln579">				entry_ref aref;</a>
<a name="ln580">				if (message-&gt;FindRef(&quot;refs&quot;, &amp;aref) == B_OK) {</a>
<a name="ln581">					BEntry ent(&amp;aref);</a>
<a name="ln582">					if (ent.InitCheck() == B_OK) {</a>
<a name="ln583">						BPath path;</a>
<a name="ln584">						if ((ent.GetPath(&amp;path) == B_OK)</a>
<a name="ln585">							&amp;&amp; (row-&gt;</a>
<a name="ln586">								ProcessColumnTextString(ShortcutsSpec::STRING_COLUMN_INDEX,</a>
<a name="ln587">									path.Path()))) {</a>
<a name="ln588">							_MarkKeySetModified();</a>
<a name="ln589">						}</a>
<a name="ln590">					}</a>
<a name="ln591">				}</a>
<a name="ln592">			}</a>
<a name="ln593">			break;</a>
<a name="ln594">		}</a>
<a name="ln595"> </a>
<a name="ln596">		case SAVE_KEYSET:</a>
<a name="ln597">		{</a>
<a name="ln598">			bool showSaveError = false;</a>
<a name="ln599"> </a>
<a name="ln600">			const char* name;</a>
<a name="ln601">			entry_ref entry;</a>
<a name="ln602">			if ((message-&gt;FindString(&quot;name&quot;, &amp;name) == B_OK)</a>
<a name="ln603">				&amp;&amp; (message-&gt;FindRef(&quot;directory&quot;, &amp;entry) == B_OK)) {</a>
<a name="ln604">				BDirectory dir(&amp;entry);</a>
<a name="ln605">				BEntry saveTo(&amp;dir, name, true);</a>
<a name="ln606">				showSaveError = ((saveTo.InitCheck() != B_OK)</a>
<a name="ln607">					|| (_SaveKeySet(saveTo) == false));</a>
<a name="ln608">			} else if (fLastSaved.InitCheck() == B_OK) {</a>
<a name="ln609">				// We've saved this before, save over previous file.</a>
<a name="ln610">				showSaveError = (_SaveKeySet(fLastSaved) == false);</a>
<a name="ln611">			} else</a>
<a name="ln612">				PostMessage(SAVE_KEYSET_AS);</a>
<a name="ln613">					// open the save requester...</a>
<a name="ln614"> </a>
<a name="ln615">			if (showSaveError) {</a>
<a name="ln616">				BAlert* alert = new BAlert(ERROR,</a>
<a name="ln617">					B_TRANSLATE(&quot;Shortcuts wasn't able to save your keyset.&quot;),</a>
<a name="ln618">					B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln619">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln620">				alert-&gt;Go(NULL);</a>
<a name="ln621">			}</a>
<a name="ln622">			break;</a>
<a name="ln623">		}</a>
<a name="ln624"> </a>
<a name="ln625">		case SAVE_KEYSET_AS:</a>
<a name="ln626">		{</a>
<a name="ln627">			if (fSavePanel)</a>
<a name="ln628">				fSavePanel-&gt;Show();</a>
<a name="ln629">			else {</a>
<a name="ln630">				BMessage message(SAVE_KEYSET);</a>
<a name="ln631">				BMessenger messenger(this);</a>
<a name="ln632">				fSavePanel = new BFilePanel(B_SAVE_PANEL, &amp;messenger, NULL, 0,</a>
<a name="ln633">					false, &amp;message);</a>
<a name="ln634">				fSavePanel-&gt;Show();</a>
<a name="ln635">			}</a>
<a name="ln636">			break;</a>
<a name="ln637">		}</a>
<a name="ln638"> </a>
<a name="ln639">		case ADD_HOTKEY_ITEM:</a>
<a name="ln640">			_AddNewSpec(NULL);</a>
<a name="ln641">			break;</a>
<a name="ln642"> </a>
<a name="ln643">		case REMOVE_HOTKEY_ITEM:</a>
<a name="ln644">		{</a>
<a name="ln645">			BRow* item = fColumnListView-&gt;CurrentSelection();</a>
<a name="ln646">			if (item) {</a>
<a name="ln647">				int index = fColumnListView-&gt;IndexOf(item);</a>
<a name="ln648">				fColumnListView-&gt;RemoveRow(item);</a>
<a name="ln649">				delete item;</a>
<a name="ln650">				_MarkKeySetModified();</a>
<a name="ln651"> </a>
<a name="ln652">				// Rules for new selection: If there is an item at (index),</a>
<a name="ln653">				// select it. Otherwise, if there is an item at (index-1),</a>
<a name="ln654">				// select it. Otherwise, select nothing.</a>
<a name="ln655">				int num = fColumnListView-&gt;CountRows();</a>
<a name="ln656">				if (num &gt; 0) {</a>
<a name="ln657">					if (index &lt; num)</a>
<a name="ln658">						fColumnListView-&gt;AddToSelection(</a>
<a name="ln659">							fColumnListView-&gt;RowAt(index));</a>
<a name="ln660">					else {</a>
<a name="ln661">						if (index &gt; 0)</a>
<a name="ln662">							index--;</a>
<a name="ln663">						if (index &lt; num)</a>
<a name="ln664">							fColumnListView-&gt;AddToSelection(</a>
<a name="ln665">								fColumnListView-&gt;RowAt(index));</a>
<a name="ln666">					}</a>
<a name="ln667">				}</a>
<a name="ln668">			}</a>
<a name="ln669">			break;</a>
<a name="ln670">		}</a>
<a name="ln671"> </a>
<a name="ln672">		// Received when the user clicks on the ColumnListView</a>
<a name="ln673">		case HOTKEY_ITEM_SELECTED:</a>
<a name="ln674">		{</a>
<a name="ln675">			if (fColumnListView-&gt;CountRows() &gt; 0)</a>
<a name="ln676">				fRemoveButton-&gt;SetEnabled(true);</a>
<a name="ln677">			else</a>
<a name="ln678">				fRemoveButton-&gt;SetEnabled(false);</a>
<a name="ln679">			break;</a>
<a name="ln680">		}</a>
<a name="ln681"> </a>
<a name="ln682">		// Received when an entry is to be modified in response to GUI activity</a>
<a name="ln683">		case HOTKEY_ITEM_MODIFIED:</a>
<a name="ln684">		{</a>
<a name="ln685">			int32 row, column;</a>
<a name="ln686"> </a>
<a name="ln687">			if ((message-&gt;FindInt32(&quot;row&quot;, &amp;row) == B_OK)</a>
<a name="ln688">				&amp;&amp; (message-&gt;FindInt32(&quot;column&quot;, &amp;column) == B_OK)) {</a>
<a name="ln689">				int32 key;</a>
<a name="ln690">				const char* bytes;</a>
<a name="ln691"> </a>
<a name="ln692">				if (row &gt;= 0) {</a>
<a name="ln693">					ShortcutsSpec* item = (ShortcutsSpec*)</a>
<a name="ln694">						fColumnListView-&gt;RowAt(row);</a>
<a name="ln695">					bool repaintNeeded = false; // default</a>
<a name="ln696"> </a>
<a name="ln697">					if (message-&gt;HasInt32(&quot;mouseClick&quot;)) {</a>
<a name="ln698">						repaintNeeded = item-&gt;ProcessColumnMouseClick(column);</a>
<a name="ln699">					} else if ((message-&gt;FindString(&quot;bytes&quot;, &amp;bytes) == B_OK)</a>
<a name="ln700">						&amp;&amp; (message-&gt;FindInt32(&quot;key&quot;, &amp;key) == B_OK)) {</a>
<a name="ln701">						repaintNeeded = item-&gt;ProcessColumnKeyStroke(column,</a>
<a name="ln702">							bytes, key);</a>
<a name="ln703">					} else if (message-&gt;FindInt32(&quot;unmappedkey&quot;, &amp;key) ==</a>
<a name="ln704">						B_OK) {</a>
<a name="ln705">						repaintNeeded = ((column == item-&gt;KEY_COLUMN_INDEX)</a>
<a name="ln706">							&amp;&amp; ((key &gt; 0xFF) || (GetKeyName(key) != NULL))</a>
<a name="ln707">							&amp;&amp; (item-&gt;ProcessColumnKeyStroke(column, NULL,</a>
<a name="ln708">							key)));</a>
<a name="ln709">					} else if (message-&gt;FindString(&quot;text&quot;, &amp;bytes) == B_OK) {</a>
<a name="ln710">						if ((bytes[0] == '(')&amp;&amp;(bytes[1] == 'C')) {</a>
<a name="ln711">							if (fSelectPanel)</a>
<a name="ln712">								fSelectPanel-&gt;Show();</a>
<a name="ln713">							else {</a>
<a name="ln714">								BMessage message(SELECT_APPLICATION);</a>
<a name="ln715">								BMessenger m(this);</a>
<a name="ln716">								fSelectPanel = new BFilePanel(B_OPEN_PANEL, &amp;m,</a>
<a name="ln717">									NULL, 0, false, &amp;message);</a>
<a name="ln718">								fSelectPanel-&gt;Show();</a>
<a name="ln719">							}</a>
<a name="ln720">							fSelectPanel-&gt;SetButtonLabel(B_DEFAULT_BUTTON,</a>
<a name="ln721">								B_TRANSLATE(&quot;Select&quot;));</a>
<a name="ln722">						} else</a>
<a name="ln723">							repaintNeeded = item-&gt;ProcessColumnTextString(</a>
<a name="ln724">								column, bytes);</a>
<a name="ln725">					}</a>
<a name="ln726"> </a>
<a name="ln727">					if (repaintNeeded) {</a>
<a name="ln728">						fColumnListView-&gt;Invalidate(row);</a>
<a name="ln729">						_MarkKeySetModified();</a>
<a name="ln730">					}</a>
<a name="ln731">				}</a>
<a name="ln732">			}</a>
<a name="ln733">			break;</a>
<a name="ln734">		}</a>
<a name="ln735"> </a>
<a name="ln736">		default:</a>
<a name="ln737">			BWindow::MessageReceived(message);</a>
<a name="ln738">			break;</a>
<a name="ln739">	}</a>
<a name="ln740">}</a>
<a name="ln741"> </a>
<a name="ln742"> </a>
<a name="ln743">void</a>
<a name="ln744">ShortcutsWindow::_MarkKeySetModified()</a>
<a name="ln745">{</a>
<a name="ln746">	if (fKeySetModified == false) {</a>
<a name="ln747">		fKeySetModified = true;</a>
<a name="ln748">		fSaveButton-&gt;SetEnabled(true);</a>
<a name="ln749">	}</a>
<a name="ln750">}</a>
<a name="ln751"> </a>
<a name="ln752"> </a>
<a name="ln753">void</a>
<a name="ln754">ShortcutsWindow::Quit()</a>
<a name="ln755">{</a>
<a name="ln756">	BWindow::Quit();</a>
<a name="ln757">}</a>
<a name="ln758"> </a>
<a name="ln759"> </a>
<a name="ln760">void</a>
<a name="ln761">ShortcutsWindow::DispatchMessage(BMessage* message, BHandler* handler)</a>
<a name="ln762">{</a>
<a name="ln763">	switch (message-&gt;what) {</a>
<a name="ln764">		case B_SIMPLE_DATA:</a>
<a name="ln765">			MessageReceived(message);</a>
<a name="ln766">			break;</a>
<a name="ln767"> </a>
<a name="ln768">		case B_COPY:</a>
<a name="ln769">		case B_CUT:</a>
<a name="ln770">			if (be_clipboard-&gt;Lock()) {</a>
<a name="ln771">				ShortcutsSpec* row =</a>
<a name="ln772">					static_cast&lt;ShortcutsSpec*&gt;(fColumnListView-&gt;CurrentSelection());</a>
<a name="ln773">				if (row) {</a>
<a name="ln774">					BMessage* data = be_clipboard-&gt;Data();</a>
<a name="ln775">					data-&gt;RemoveName(&quot;text/plain&quot;);</a>
<a name="ln776">					data-&gt;AddData(&quot;text/plain&quot;, B_MIME_TYPE,</a>
<a name="ln777">						row-&gt;GetCellText(ShortcutsSpec::STRING_COLUMN_INDEX),</a>
<a name="ln778">						strlen(row-&gt;GetCellText(ShortcutsSpec::STRING_COLUMN_INDEX)));</a>
<a name="ln779">					be_clipboard-&gt;Commit();</a>
<a name="ln780"> </a>
<a name="ln781">					if (message-&gt;what == B_CUT) {</a>
<a name="ln782">						row-&gt;ProcessColumnTextString(</a>
<a name="ln783">							ShortcutsSpec::STRING_COLUMN_INDEX, &quot;&quot;);</a>
<a name="ln784">						_MarkKeySetModified();</a>
<a name="ln785">					}</a>
<a name="ln786">				}</a>
<a name="ln787">				be_clipboard-&gt;Unlock();</a>
<a name="ln788">			}</a>
<a name="ln789">			break;</a>
<a name="ln790"> </a>
<a name="ln791">		case B_PASTE:</a>
<a name="ln792">			if (be_clipboard-&gt;Lock()) {</a>
<a name="ln793">				BMessage* data = be_clipboard-&gt;Data();</a>
<a name="ln794">				const char* text;</a>
<a name="ln795">				ssize_t textLen;</a>
<a name="ln796">				if (data-&gt;FindData(&quot;text/plain&quot;, B_MIME_TYPE, (const void**)</a>
<a name="ln797">					&amp;text, &amp;textLen) == B_OK) {</a>
<a name="ln798">					ShortcutsSpec* row =</a>
<a name="ln799">					static_cast&lt;ShortcutsSpec*&gt;(fColumnListView-&gt;CurrentSelection());</a>
<a name="ln800">					if (row) {</a>
<a name="ln801">						for (ssize_t i = 0; i &lt; textLen; i++) {</a>
<a name="ln802">							char buf[2] = {text[i], 0x00};</a>
<a name="ln803">							row-&gt;ProcessColumnKeyStroke(</a>
<a name="ln804">								ShortcutsSpec::STRING_COLUMN_INDEX, buf, 0);</a>
<a name="ln805">						}</a>
<a name="ln806">					}</a>
<a name="ln807">					_MarkKeySetModified();</a>
<a name="ln808">				}</a>
<a name="ln809">				be_clipboard-&gt;Unlock();</a>
<a name="ln810">			}</a>
<a name="ln811">			break;</a>
<a name="ln812"> </a>
<a name="ln813">		case B_KEY_DOWN:</a>
<a name="ln814">			ShortcutsSpec* selected;</a>
<a name="ln815">			if (message-&gt;GetInt32(&quot;modifiers&quot;, 0) != 0)</a>
<a name="ln816">				BWindow::DispatchMessage(message, handler);</a>
<a name="ln817">			else if (handler == fColumnListView</a>
<a name="ln818">				&amp;&amp; (selected =</a>
<a name="ln819">					static_cast&lt;ShortcutsSpec*&gt;(fColumnListView-&gt;CurrentSelection()))) {</a>
<a name="ln820">				selected-&gt;ProcessColumnTextString(</a>
<a name="ln821">						ShortcutsSpec::KEY_COLUMN_INDEX,</a>
<a name="ln822">						GetKeyName(message-&gt;GetInt32(&quot;key&quot;, 0)));</a>
<a name="ln823">				_MarkKeySetModified();</a>
<a name="ln824">			}</a>
<a name="ln825">			break;</a>
<a name="ln826"> </a>
<a name="ln827">		default:</a>
<a name="ln828">			BWindow::DispatchMessage(message, handler);</a>
<a name="ln829">			break;</a>
<a name="ln830">	}</a>
<a name="ln831">}</a>

</code></pre>
<div class="balloon" rel="286"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="293"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="621"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
