
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Controller.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Controller.cpp - Media Player for the Haiku Operating System</a>
<a name="ln3"> *</a>
<a name="ln4"> * Copyright (C) 2006 Marcus Overhagen &lt;marcus@overhagen.de&gt;</a>
<a name="ln5"> * Copyright (C) 2007-2008 Stephan Aßmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln6"> * Copyright (C) 2007-2009 Fredrik Modéen &lt;[FirstName]@[LastName].se&gt;</a>
<a name="ln7"> *</a>
<a name="ln8"> * Released under the terms of the MIT license.</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;Controller.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;new&gt;</a>
<a name="ln15">#include &lt;stdio.h&gt;</a>
<a name="ln16">#include &lt;string.h&gt;</a>
<a name="ln17"> </a>
<a name="ln18">#include &lt;Autolock.h&gt;</a>
<a name="ln19">#include &lt;Bitmap.h&gt;</a>
<a name="ln20">#include &lt;Catalog.h&gt;</a>
<a name="ln21">#include &lt;Debug.h&gt;</a>
<a name="ln22">#include &lt;Path.h&gt;</a>
<a name="ln23">#include &lt;Window.h&gt; // for debugging only</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;AutoDeleter.h&quot;</a>
<a name="ln26">#include &quot;ControllerView.h&quot;</a>
<a name="ln27">#include &quot;MainApp.h&quot;</a>
<a name="ln28">#include &quot;PlaybackState.h&quot;</a>
<a name="ln29">#include &quot;Settings.h&quot;</a>
<a name="ln30">#include &quot;VideoView.h&quot;</a>
<a name="ln31"> </a>
<a name="ln32">// suppliers</a>
<a name="ln33">#include &quot;AudioTrackSupplier.h&quot;</a>
<a name="ln34">#include &quot;MediaTrackAudioSupplier.h&quot;</a>
<a name="ln35">#include &quot;MediaTrackVideoSupplier.h&quot;</a>
<a name="ln36">#include &quot;ProxyAudioSupplier.h&quot;</a>
<a name="ln37">#include &quot;ProxyVideoSupplier.h&quot;</a>
<a name="ln38">#include &quot;SubTitles.h&quot;</a>
<a name="ln39">#include &quot;TrackSupplier.h&quot;</a>
<a name="ln40">#include &quot;VideoTrackSupplier.h&quot;</a>
<a name="ln41"> </a>
<a name="ln42"> </a>
<a name="ln43">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln44">#define B_TRANSLATION_CONTEXT &quot;MediaPlayer-Controller&quot;</a>
<a name="ln45">#define MIN_WIDTH 250</a>
<a name="ln46"> </a>
<a name="ln47">using std::nothrow;</a>
<a name="ln48"> </a>
<a name="ln49"> </a>
<a name="ln50">class TrackSupplierReleaser {</a>
<a name="ln51">public:</a>
<a name="ln52">	TrackSupplierReleaser(PlaylistItemRef&amp; owner)</a>
<a name="ln53">		:</a>
<a name="ln54">		fOwner(owner),</a>
<a name="ln55">		fRelease(true)</a>
<a name="ln56">		{}</a>
<a name="ln57"> </a>
<a name="ln58">	virtual ~TrackSupplierReleaser()</a>
<a name="ln59">	{</a>
<a name="ln60">		if (fRelease)</a>
<a name="ln61">			fOwner.Get()-&gt;ReleaseTrackSupplier();</a>
<a name="ln62">	}</a>
<a name="ln63"> </a>
<a name="ln64">	void Detach()</a>
<a name="ln65">	{</a>
<a name="ln66">		fRelease = false;</a>
<a name="ln67">	}</a>
<a name="ln68"> </a>
<a name="ln69">private:</a>
<a name="ln70">	PlaylistItemRef&amp;	fOwner;</a>
<a name="ln71">	bool				fRelease;</a>
<a name="ln72">};</a>
<a name="ln73"> </a>
<a name="ln74"> </a>
<a name="ln75">void</a>
<a name="ln76">HandleError(const char *text, status_t err)</a>
<a name="ln77">{</a>
<a name="ln78">	if (err != B_OK) {</a>
<a name="ln79">		printf(&quot;%s. error 0x%08x (%s)\n&quot;,text, (int)err, strerror(err));</a>
<a name="ln80">		fflush(NULL);</a>
<a name="ln81">		exit(1);</a>
<a name="ln82">	}</a>
<a name="ln83">}</a>
<a name="ln84"> </a>
<a name="ln85"> </a>
<a name="ln86">// #pragma mark - Controller::Listener</a>
<a name="ln87"> </a>
<a name="ln88"> </a>
<a name="ln89">Controller::Listener::Listener() {}</a>
<a name="ln90">Controller::Listener::~Listener() {}</a>
<a name="ln91">void Controller::Listener::FileFinished() {}</a>
<a name="ln92">void Controller::Listener::FileChanged(PlaylistItem* item, status_t result) {}</a>
<a name="ln93">void Controller::Listener::VideoTrackChanged(int32) {}</a>
<a name="ln94">void Controller::Listener::AudioTrackChanged(int32) {}</a>
<a name="ln95">void Controller::Listener::SubTitleTrackChanged(int32) {}</a>
<a name="ln96">void Controller::Listener::VideoStatsChanged() {}</a>
<a name="ln97">void Controller::Listener::AudioStatsChanged() {}</a>
<a name="ln98">void Controller::Listener::PlaybackStateChanged(uint32) {}</a>
<a name="ln99">void Controller::Listener::PositionChanged(float) {}</a>
<a name="ln100">void Controller::Listener::SeekHandled(int64 seekFrame) {}</a>
<a name="ln101">void Controller::Listener::VolumeChanged(float) {}</a>
<a name="ln102">void Controller::Listener::MutedChanged(bool) {}</a>
<a name="ln103"> </a>
<a name="ln104"> </a>
<a name="ln105">// #pragma mark - Controller</a>
<a name="ln106"> </a>
<a name="ln107"> </a>
<a name="ln108">enum {</a>
<a name="ln109">	MSG_SET_TO = 'stto'</a>
<a name="ln110">};</a>
<a name="ln111"> </a>
<a name="ln112"> </a>
<a name="ln113">Controller::Controller()</a>
<a name="ln114">	:</a>
<a name="ln115">	NodeManager(),</a>
<a name="ln116">	fVideoView(NULL),</a>
<a name="ln117">	fVolume(1.0),</a>
<a name="ln118">	fActiveVolume(1.0),</a>
<a name="ln119">	fMuted(false),</a>
<a name="ln120"> </a>
<a name="ln121">	fItem(NULL),</a>
<a name="ln122"> </a>
<a name="ln123">	fVideoSupplier(new ProxyVideoSupplier()),</a>
<a name="ln124">	fAudioSupplier(new ProxyAudioSupplier(this)),</a>
<a name="ln125">	fVideoTrackSupplier(NULL),</a>
<a name="ln126">	fAudioTrackSupplier(NULL),</a>
<a name="ln127">	fSubTitles(NULL),</a>
<a name="ln128">	fSubTitlesIndex(-1),</a>
<a name="ln129"> </a>
<a name="ln130">	fCurrentFrame(0),</a>
<a name="ln131">	fDuration(0),</a>
<a name="ln132">	fVideoFrameRate(25.0),</a>
<a name="ln133"> </a>
<a name="ln134">	fPendingSeekRequests(0),</a>
<a name="ln135">	fSeekFrame(-1),</a>
<a name="ln136">	fRequestedSeekFrame(-1),</a>
<a name="ln137"> </a>
<a name="ln138">	fGlobalSettingsListener(this),</a>
<a name="ln139"> </a>
<a name="ln140">	fListeners(4)</a>
<a name="ln141">{</a>
<a name="ln142">	Settings::Default()-&gt;AddListener(&amp;fGlobalSettingsListener);</a>
<a name="ln143">	_AdoptGlobalSettings();</a>
<a name="ln144"> </a>
<a name="ln145">	fAutoplay = fAutoplaySetting;</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148"> </a>
<a name="ln149">Controller::~Controller()</a>
<a name="ln150">{</a>
<a name="ln151">	Settings::Default()-&gt;RemoveListener(&amp;fGlobalSettingsListener);</a>
<a name="ln152">	SetTo(NULL);</a>
<a name="ln153">}</a>
<a name="ln154"> </a>
<a name="ln155"> </a>
<a name="ln156">// #pragma mark - NodeManager interface</a>
<a name="ln157"> </a>
<a name="ln158"> </a>
<a name="ln159">void</a>
<a name="ln160">Controller::MessageReceived(BMessage* message)</a>
<a name="ln161">{</a>
<a name="ln162">	switch (message-&gt;what) {</a>
<a name="ln163">		case MSG_OBJECT_CHANGED:</a>
<a name="ln164">			// received from fGlobalSettingsListener</a>
<a name="ln165">			// TODO: find out which object, if we ever watch more than</a>
<a name="ln166">			// the global settings instance...</a>
<a name="ln167">			_AdoptGlobalSettings();</a>
<a name="ln168">			break;</a>
<a name="ln169"> </a>
<a name="ln170">		case MSG_SET_TO:</a>
<a name="ln171">		{</a>
<a name="ln172">			PlaylistItem* item;</a>
<a name="ln173">			if (message-&gt;FindPointer(&quot;item&quot;, (void**)&amp;item) == B_OK) {</a>
<a name="ln174">				PlaylistItemRef itemRef(item, true);</a>
<a name="ln175">					// The reference was passed with the message.</a>
<a name="ln176">				SetTo(itemRef);</a>
<a name="ln177">			} else</a>
<a name="ln178">				_NotifyFileChanged(NULL, B_BAD_VALUE);</a>
<a name="ln179"> </a>
<a name="ln180">			break;</a>
<a name="ln181">		}</a>
<a name="ln182"> </a>
<a name="ln183">		default:</a>
<a name="ln184">			NodeManager::MessageReceived(message);</a>
<a name="ln185">	}</a>
<a name="ln186">}</a>
<a name="ln187"> </a>
<a name="ln188"> </a>
<a name="ln189">int64</a>
<a name="ln190">Controller::Duration()</a>
<a name="ln191">{</a>
<a name="ln192">	return _FrameDuration();</a>
<a name="ln193">}</a>
<a name="ln194"> </a>
<a name="ln195"> </a>
<a name="ln196">VideoTarget*</a>
<a name="ln197">Controller::CreateVideoTarget()</a>
<a name="ln198">{</a>
<a name="ln199">	return fVideoView;</a>
<a name="ln200">}</a>
<a name="ln201"> </a>
<a name="ln202"> </a>
<a name="ln203">VideoSupplier*</a>
<a name="ln204">Controller::CreateVideoSupplier()</a>
<a name="ln205">{</a>
<a name="ln206">	return fVideoSupplier;</a>
<a name="ln207">}</a>
<a name="ln208"> </a>
<a name="ln209"> </a>
<a name="ln210">AudioSupplier*</a>
<a name="ln211">Controller::CreateAudioSupplier()</a>
<a name="ln212">{</a>
<a name="ln213">	return fAudioSupplier;</a>
<a name="ln214">}</a>
<a name="ln215"> </a>
<a name="ln216"> </a>
<a name="ln217">// #pragma mark -</a>
<a name="ln218"> </a>
<a name="ln219"> </a>
<a name="ln220">status_t</a>
<a name="ln221">Controller::SetToAsync(const PlaylistItemRef&amp; item)</a>
<a name="ln222">{</a>
<a name="ln223">	PlaylistItemRef additionalReference(item);</a>
<a name="ln224"> </a>
<a name="ln225">	BMessage message(MSG_SET_TO);</a>
<a name="ln226">	status_t ret = message.AddPointer(&quot;item&quot;, item.Get());</a>
<a name="ln227">	if (ret != B_OK)</a>
<a name="ln228">		return ret;</a>
<a name="ln229"> </a>
<a name="ln230">	ret = PostMessage(&amp;message);</a>
<a name="ln231">	if (ret != B_OK)</a>
<a name="ln232">		return ret;</a>
<a name="ln233"> </a>
<a name="ln234">	// The additional reference is now passed along with the message...</a>
<a name="ln235">	additionalReference.Detach();</a>
<a name="ln236"> </a>
<a name="ln237">	return B_OK;</a>
<a name="ln238">}</a>
<a name="ln239"> </a>
<a name="ln240"> </a>
<a name="ln241">status_t</a>
<a name="ln242">Controller::SetTo(const PlaylistItemRef&amp; item)</a>
<a name="ln243">{</a>
<a name="ln244">	BAutolock _(this);</a>
<a name="ln245"> </a>
<a name="ln246">	if (fItem == item) {</a>
<a name="ln247">		if (InitCheck() == B_OK) {</a>
<a name="ln248">			if (fAutoplay) {</a>
<a name="ln249">				SetPosition(0.0);</a>
<a name="ln250">				StartPlaying(true);</a>
<a name="ln251">			}</a>
<a name="ln252">		}</a>
<a name="ln253">		return B_OK;</a>
<a name="ln254">	}</a>
<a name="ln255"> </a>
<a name="ln256">	fAudioSupplier-&gt;SetSupplier(NULL, fVideoFrameRate);</a>
<a name="ln257">	fVideoSupplier-&gt;SetSupplier(NULL);</a>
<a name="ln258"> </a>
<a name="ln259">	if (fItem != NULL)</a>
<a name="ln260">		TrackSupplierReleaser oldSupplierReleaser(fItem);</a>
<a name="ln261"> </a>
<a name="ln262">	fItem = item;</a>
<a name="ln263"> </a>
<a name="ln264">	// Do not delete the supplier chain until after we called</a>
<a name="ln265">	// NodeManager::Init() to setup a new media node chain</a>
<a name="ln266">	ObjectDeleter&lt;VideoTrackSupplier&gt; videoSupplierDeleter(</a>
<a name="ln267">		fVideoTrackSupplier);</a>
<a name="ln268">	ObjectDeleter&lt;AudioTrackSupplier&gt; audioSupplierDeleter(</a>
<a name="ln269">		fAudioTrackSupplier);</a>
<a name="ln270"> </a>
<a name="ln271">	fVideoTrackSupplier = NULL;</a>
<a name="ln272">	fAudioTrackSupplier = NULL;</a>
<a name="ln273">	fSubTitles = NULL;</a>
<a name="ln274">	fSubTitlesIndex = -1;</a>
<a name="ln275"> </a>
<a name="ln276">	fCurrentFrame = 0;</a>
<a name="ln277">	fDuration = 0;</a>
<a name="ln278">	fVideoFrameRate = 25.0;</a>
<a name="ln279"> </a>
<a name="ln280">	fPendingSeekRequests = 0;</a>
<a name="ln281">	fSeekFrame = -1;</a>
<a name="ln282">	fRequestedSeekFrame = -1;</a>
<a name="ln283"> </a>
<a name="ln284">	if (fItem.Get() == NULL)</a>
<a name="ln285">		return B_BAD_VALUE;</a>
<a name="ln286"> </a>
<a name="ln287">	TrackSupplier* trackSupplier = fItem-&gt;GetTrackSupplier();</a>
<a name="ln288">	if (trackSupplier == NULL) {</a>
<a name="ln289">		_NotifyFileChanged(item.Get(), B_NO_MEMORY);</a>
<a name="ln290">		return B_NO_MEMORY;</a>
<a name="ln291">	}</a>
<a name="ln292">	TrackSupplierReleaser trackSupplierReleaser(fItem);</a>
<a name="ln293"> </a>
<a name="ln294">	status_t err = trackSupplier-&gt;InitCheck();</a>
<a name="ln295">	if (err != B_OK) {</a>
<a name="ln296">		printf(&quot;Controller::SetTo: InitCheck failed\n&quot;);</a>
<a name="ln297">		_NotifyFileChanged(item.Get(), err);</a>
<a name="ln298">		return err;</a>
<a name="ln299">	}</a>
<a name="ln300"> </a>
<a name="ln301">	if (trackSupplier-&gt;CountAudioTracks() == 0</a>
<a name="ln302">		&amp;&amp; trackSupplier-&gt;CountVideoTracks() == 0) {</a>
<a name="ln303">		_NotifyFileChanged(item.Get(), B_MEDIA_NO_HANDLER);</a>
<a name="ln304">		return B_MEDIA_NO_HANDLER;</a>
<a name="ln305">	}</a>
<a name="ln306"> </a>
<a name="ln307">	SelectAudioTrack(0);</a>
<a name="ln308">	SelectVideoTrack(0);</a>
<a name="ln309"> </a>
<a name="ln310">	if (fAudioTrackSupplier == NULL &amp;&amp; fVideoTrackSupplier == NULL) {</a>
<a name="ln311">		printf(&quot;Controller::SetTo: no audio or video tracks found or &quot;</a>
<a name="ln312">			&quot;no decoders\n&quot;);</a>
<a name="ln313">		_NotifyFileChanged(item.Get(), B_MEDIA_NO_HANDLER);</a>
<a name="ln314">		return B_MEDIA_NO_HANDLER;</a>
<a name="ln315">	}</a>
<a name="ln316"> </a>
<a name="ln317">	trackSupplierReleaser.Detach();</a>
<a name="ln318"> </a>
<a name="ln319">	// prevent blocking the creation of new overlay buffers</a>
<a name="ln320">	if (fVideoView)</a>
<a name="ln321">		fVideoView-&gt;DisableOverlay();</a>
<a name="ln322"> </a>
<a name="ln323">	// get video properties (if there is video at all)</a>
<a name="ln324">	bool useOverlays = fVideoView ? fVideoView-&gt;UseOverlays() : true;</a>
<a name="ln325"> </a>
<a name="ln326">	int width;</a>
<a name="ln327">	int height;</a>
<a name="ln328">	GetSize(&amp;width, &amp;height);</a>
<a name="ln329">	color_space preferredVideoFormat = B_NO_COLOR_SPACE;</a>
<a name="ln330">	if (fVideoTrackSupplier != NULL) {</a>
<a name="ln331">		const media_format&amp; format = fVideoTrackSupplier-&gt;Format();</a>
<a name="ln332">		preferredVideoFormat = format.u.raw_video.display.format;</a>
<a name="ln333">	}</a>
<a name="ln334"> </a>
<a name="ln335">	uint32 enabledNodes;</a>
<a name="ln336">	if (!fVideoTrackSupplier)</a>
<a name="ln337">		enabledNodes = AUDIO_ONLY;</a>
<a name="ln338">	else if (!fAudioTrackSupplier)</a>
<a name="ln339">		enabledNodes = VIDEO_ONLY;</a>
<a name="ln340">	else</a>
<a name="ln341">		enabledNodes = AUDIO_AND_VIDEO;</a>
<a name="ln342"> </a>
<a name="ln343">	float audioFrameRate = 44100.0f;</a>
<a name="ln344">	uint32 audioChannels = 2;</a>
<a name="ln345">	if (fAudioTrackSupplier != NULL) {</a>
<a name="ln346">		const media_format&amp; audioTrackFormat = fAudioTrackSupplier-&gt;Format();</a>
<a name="ln347">		audioFrameRate = audioTrackFormat.u.raw_audio.frame_rate;</a>
<a name="ln348">		audioChannels = audioTrackFormat.u.raw_audio.channel_count;</a>
<a name="ln349">	}</a>
<a name="ln350"> </a>
<a name="ln351">	if (InitCheck() != B_OK) {</a>
<a name="ln352">		Init(BRect(0, 0, width - 1, height - 1), fVideoFrameRate,</a>
<a name="ln353">			preferredVideoFormat, audioFrameRate, audioChannels, LOOPING_ALL,</a>
<a name="ln354">			false, 1.0, enabledNodes, useOverlays);</a>
<a name="ln355">	} else {</a>
<a name="ln356">		FormatChanged(BRect(0, 0, width - 1, height - 1), fVideoFrameRate,</a>
<a name="ln357">			preferredVideoFormat, audioFrameRate, audioChannels, enabledNodes,</a>
<a name="ln358">			useOverlays);</a>
<a name="ln359">	}</a>
<a name="ln360"> </a>
<a name="ln361">	_NotifyFileChanged(item.Get(), B_OK);</a>
<a name="ln362"> </a>
<a name="ln363">	if (fAutoplay)</a>
<a name="ln364">		StartPlaying(true);</a>
<a name="ln365"> </a>
<a name="ln366">	return B_OK;</a>
<a name="ln367">}</a>
<a name="ln368"> </a>
<a name="ln369"> </a>
<a name="ln370">void</a>
<a name="ln371">Controller::PlayerActivated(bool active)</a>
<a name="ln372">{</a>
<a name="ln373">	if (LockWithTimeout(5000) != B_OK)</a>
<a name="ln374">		return;</a>
<a name="ln375"> </a>
<a name="ln376">	if (active &amp;&amp; gMainApp-&gt;PlayerCount() &gt; 1) {</a>
<a name="ln377">		if (fActiveVolume != fVolume)</a>
<a name="ln378">			SetVolume(fActiveVolume);</a>
<a name="ln379">	} else {</a>
<a name="ln380">		fActiveVolume = fVolume;</a>
<a name="ln381">		if (gMainApp-&gt;PlayerCount() &gt; 1)</a>
<a name="ln382">			switch (fBackgroundMovieVolumeMode) {</a>
<a name="ln383">				case mpSettings::BG_MOVIES_MUTED:</a>
<a name="ln384">					SetVolume(0.0);</a>
<a name="ln385">					break;</a>
<a name="ln386">				case mpSettings::BG_MOVIES_HALF_VLUME:</a>
<a name="ln387">					SetVolume(fVolume * 0.25);</a>
<a name="ln388">					break;</a>
<a name="ln389">				case mpSettings::BG_MOVIES_FULL_VOLUME:</a>
<a name="ln390">				default:</a>
<a name="ln391">					break;</a>
<a name="ln392">			}</a>
<a name="ln393">	}</a>
<a name="ln394"> </a>
<a name="ln395">	Unlock();</a>
<a name="ln396">}</a>
<a name="ln397"> </a>
<a name="ln398"> </a>
<a name="ln399">void</a>
<a name="ln400">Controller::GetSize(int *width, int *height, int* _widthAspect,</a>
<a name="ln401">	int* _heightAspect)</a>
<a name="ln402">{</a>
<a name="ln403">	BAutolock _(this);</a>
<a name="ln404"> </a>
<a name="ln405">	if (fVideoTrackSupplier) {</a>
<a name="ln406">		media_format format = fVideoTrackSupplier-&gt;Format();</a>
<a name="ln407">		*height = format.u.raw_video.display.line_count;</a>
<a name="ln408">		*width = format.u.raw_video.display.line_width;</a>
<a name="ln409">		int widthAspect = 0;</a>
<a name="ln410">		int heightAspect = 0;</a>
<a name="ln411">		// Ignore format aspect when both values are 1. If they have been</a>
<a name="ln412">		// intentionally at 1:1 then no harm is done for quadratic videos,</a>
<a name="ln413">		// only if the video is indeed encoded anamorphotic, but supposed</a>
<a name="ln414">		// to be displayed quadratic... extremely unlikely.</a>
<a name="ln415">		if (format.u.raw_video.pixel_width_aspect</a>
<a name="ln416">			!= format.u.raw_video.pixel_height_aspect</a>
<a name="ln417">			&amp;&amp; format.u.raw_video.pixel_width_aspect != 1) {</a>
<a name="ln418">			widthAspect = format.u.raw_video.pixel_width_aspect;</a>
<a name="ln419">			heightAspect = format.u.raw_video.pixel_height_aspect;</a>
<a name="ln420">		}</a>
<a name="ln421">		if (_widthAspect != NULL)</a>
<a name="ln422">			*_widthAspect = widthAspect;</a>
<a name="ln423">		if (_heightAspect != NULL)</a>
<a name="ln424">			*_heightAspect = heightAspect;</a>
<a name="ln425">	} else {</a>
<a name="ln426">		*height = 0;</a>
<a name="ln427">		*width = 0;</a>
<a name="ln428">		if (_widthAspect != NULL)</a>
<a name="ln429">			*_widthAspect = 1;</a>
<a name="ln430">		if (_heightAspect != NULL)</a>
<a name="ln431">			*_heightAspect = 1;</a>
<a name="ln432">	}</a>
<a name="ln433">}</a>
<a name="ln434"> </a>
<a name="ln435"> </a>
<a name="ln436">int</a>
<a name="ln437">Controller::AudioTrackCount()</a>
<a name="ln438">{</a>
<a name="ln439">	BAutolock _(this);</a>
<a name="ln440"> </a>
<a name="ln441">	if (fItem != NULL &amp;&amp; fItem-&gt;HasTrackSupplier())</a>
<a name="ln442">		return fItem-&gt;GetTrackSupplier()-&gt;CountAudioTracks();</a>
<a name="ln443">	return 0;</a>
<a name="ln444">}</a>
<a name="ln445"> </a>
<a name="ln446"> </a>
<a name="ln447">int</a>
<a name="ln448">Controller::VideoTrackCount()</a>
<a name="ln449">{</a>
<a name="ln450">	BAutolock _(this);</a>
<a name="ln451"> </a>
<a name="ln452">	if (fItem != NULL &amp;&amp; fItem-&gt;HasTrackSupplier())</a>
<a name="ln453">		return fItem-&gt;GetTrackSupplier()-&gt;CountVideoTracks();</a>
<a name="ln454">	return 0;</a>
<a name="ln455">}</a>
<a name="ln456"> </a>
<a name="ln457"> </a>
<a name="ln458">int</a>
<a name="ln459">Controller::SubTitleTrackCount()</a>
<a name="ln460">{</a>
<a name="ln461">	BAutolock _(this);</a>
<a name="ln462"> </a>
<a name="ln463">	if (fItem != NULL &amp;&amp; fItem-&gt;HasTrackSupplier())</a>
<a name="ln464">		return fItem-&gt;GetTrackSupplier()-&gt;CountSubTitleTracks();</a>
<a name="ln465">	return 0;</a>
<a name="ln466">}</a>
<a name="ln467"> </a>
<a name="ln468"> </a>
<a name="ln469">status_t</a>
<a name="ln470">Controller::SelectAudioTrack(int n)</a>
<a name="ln471">{</a>
<a name="ln472">	BAutolock _(this);</a>
<a name="ln473">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln474">		return B_NO_INIT;</a>
<a name="ln475"> </a>
<a name="ln476">	ObjectDeleter&lt;AudioTrackSupplier&gt; deleter(fAudioTrackSupplier);</a>
<a name="ln477">	fAudioTrackSupplier</a>
<a name="ln478">		= fItem-&gt;GetTrackSupplier()-&gt;CreateAudioTrackForIndex(n);</a>
<a name="ln479">	if (fAudioTrackSupplier == NULL)</a>
<a name="ln480">		return B_BAD_INDEX;</a>
<a name="ln481"> </a>
<a name="ln482">	bigtime_t a = fAudioTrackSupplier-&gt;Duration();</a>
<a name="ln483">	bigtime_t v = fVideoTrackSupplier != NULL</a>
<a name="ln484">		? fVideoTrackSupplier-&gt;Duration() : 0;</a>
<a name="ln485">	fDuration = max_c(a, v);</a>
<a name="ln486">	DurationChanged();</a>
<a name="ln487">	// TODO: notify duration changed!</a>
<a name="ln488"> </a>
<a name="ln489">	fAudioSupplier-&gt;SetSupplier(fAudioTrackSupplier, fVideoFrameRate);</a>
<a name="ln490"> </a>
<a name="ln491">	_NotifyAudioTrackChanged(n);</a>
<a name="ln492">	return B_OK;</a>
<a name="ln493">}</a>
<a name="ln494"> </a>
<a name="ln495"> </a>
<a name="ln496">int</a>
<a name="ln497">Controller::CurrentAudioTrack()</a>
<a name="ln498">{</a>
<a name="ln499">	BAutolock _(this);</a>
<a name="ln500"> </a>
<a name="ln501">	if (fAudioTrackSupplier == NULL)</a>
<a name="ln502">		return -1;</a>
<a name="ln503"> </a>
<a name="ln504">	return fAudioTrackSupplier-&gt;TrackIndex();</a>
<a name="ln505">}</a>
<a name="ln506"> </a>
<a name="ln507"> </a>
<a name="ln508">int</a>
<a name="ln509">Controller::AudioTrackChannelCount()</a>
<a name="ln510">{</a>
<a name="ln511">	media_format format;</a>
<a name="ln512">	if (GetEncodedAudioFormat(&amp;format) == B_OK)</a>
<a name="ln513">		return format.u.encoded_audio.output.channel_count;</a>
<a name="ln514"> </a>
<a name="ln515">	return 2;</a>
<a name="ln516">}</a>
<a name="ln517"> </a>
<a name="ln518"> </a>
<a name="ln519">status_t</a>
<a name="ln520">Controller::SelectVideoTrack(int n)</a>
<a name="ln521">{</a>
<a name="ln522">	BAutolock _(this);</a>
<a name="ln523"> </a>
<a name="ln524">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln525">		return B_NO_INIT;</a>
<a name="ln526"> </a>
<a name="ln527">	ObjectDeleter&lt;VideoTrackSupplier&gt; deleter(fVideoTrackSupplier);</a>
<a name="ln528">	fVideoTrackSupplier</a>
<a name="ln529">		= fItem-&gt;GetTrackSupplier()-&gt;CreateVideoTrackForIndex(n);</a>
<a name="ln530">	if (fVideoTrackSupplier == NULL)</a>
<a name="ln531">		return B_BAD_INDEX;</a>
<a name="ln532"> </a>
<a name="ln533">	bigtime_t a = fAudioTrackSupplier ? fAudioTrackSupplier-&gt;Duration() : 0;</a>
<a name="ln534">	bigtime_t v = fVideoTrackSupplier-&gt;Duration();</a>
<a name="ln535">	fDuration = max_c(a, v);</a>
<a name="ln536">	fVideoFrameRate = fVideoTrackSupplier-&gt;Format().u.raw_video.field_rate;</a>
<a name="ln537">	if (fVideoFrameRate &lt;= 0.0) {</a>
<a name="ln538">		printf(&quot;Controller::SelectVideoTrack(%d) - invalid video frame rate: %.1f\n&quot;,</a>
<a name="ln539">			n, fVideoFrameRate);</a>
<a name="ln540">		fVideoFrameRate = 25.0;</a>
<a name="ln541">	}</a>
<a name="ln542"> </a>
<a name="ln543">	DurationChanged();</a>
<a name="ln544">	// TODO: notify duration changed!</a>
<a name="ln545"> </a>
<a name="ln546">	fVideoSupplier-&gt;SetSupplier(fVideoTrackSupplier);</a>
<a name="ln547"> </a>
<a name="ln548">	_NotifyVideoTrackChanged(n);</a>
<a name="ln549">	return B_OK;</a>
<a name="ln550">}</a>
<a name="ln551"> </a>
<a name="ln552"> </a>
<a name="ln553">int</a>
<a name="ln554">Controller::CurrentVideoTrack()</a>
<a name="ln555">{</a>
<a name="ln556">	BAutolock _(this);</a>
<a name="ln557"> </a>
<a name="ln558">	if (fVideoTrackSupplier == NULL)</a>
<a name="ln559">		return -1;</a>
<a name="ln560"> </a>
<a name="ln561">	return fVideoTrackSupplier-&gt;TrackIndex();</a>
<a name="ln562">}</a>
<a name="ln563"> </a>
<a name="ln564"> </a>
<a name="ln565">status_t</a>
<a name="ln566">Controller::SelectSubTitleTrack(int n)</a>
<a name="ln567">{</a>
<a name="ln568">	BAutolock _(this);</a>
<a name="ln569"> </a>
<a name="ln570">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln571">		return B_NO_INIT;</a>
<a name="ln572"> </a>
<a name="ln573">	fSubTitlesIndex = n;</a>
<a name="ln574">	fSubTitles =</a>
<a name="ln575">		fItem-&gt;GetTrackSupplier()-&gt;SubTitleTrackForIndex(n);</a>
<a name="ln576"> </a>
<a name="ln577">	const SubTitle* subTitle = NULL;</a>
<a name="ln578">	if (fSubTitles != NULL)</a>
<a name="ln579">		subTitle = fSubTitles-&gt;SubTitleAt(_TimePosition());</a>
<a name="ln580">	if (subTitle != NULL)</a>
<a name="ln581">		fVideoView-&gt;SetSubTitle(subTitle-&gt;text.String());</a>
<a name="ln582">	else</a>
<a name="ln583">		fVideoView-&gt;SetSubTitle(NULL);</a>
<a name="ln584"> </a>
<a name="ln585">	_NotifySubTitleTrackChanged(n);</a>
<a name="ln586">	return B_OK;</a>
<a name="ln587">}</a>
<a name="ln588"> </a>
<a name="ln589"> </a>
<a name="ln590">int</a>
<a name="ln591">Controller::CurrentSubTitleTrack()</a>
<a name="ln592">{</a>
<a name="ln593">	BAutolock _(this);</a>
<a name="ln594"> </a>
<a name="ln595">	if (fSubTitles == NULL)</a>
<a name="ln596">		return -1;</a>
<a name="ln597"> </a>
<a name="ln598">	return fSubTitlesIndex;</a>
<a name="ln599">}</a>
<a name="ln600"> </a>
<a name="ln601"> </a>
<a name="ln602">const char*</a>
<a name="ln603">Controller::SubTitleTrackName(int n)</a>
<a name="ln604">{</a>
<a name="ln605">	BAutolock _(this);</a>
<a name="ln606"> </a>
<a name="ln607">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln608">		return NULL;</a>
<a name="ln609"> </a>
<a name="ln610">	const SubTitles* subTitles</a>
<a name="ln611">		= fItem-&gt;GetTrackSupplier()-&gt;SubTitleTrackForIndex(n);</a>
<a name="ln612">	if (subTitles == NULL)</a>
<a name="ln613">		return NULL;</a>
<a name="ln614"> </a>
<a name="ln615">	return subTitles-&gt;Name();</a>
<a name="ln616">}</a>
<a name="ln617"> </a>
<a name="ln618"> </a>
<a name="ln619">// #pragma mark -</a>
<a name="ln620"> </a>
<a name="ln621"> </a>
<a name="ln622">void</a>
<a name="ln623">Controller::Stop()</a>
<a name="ln624">{</a>
<a name="ln625">	//printf(&quot;Controller::Stop\n&quot;);</a>
<a name="ln626"> </a>
<a name="ln627">	BAutolock _(this);</a>
<a name="ln628"> </a>
<a name="ln629">	StopPlaying();</a>
<a name="ln630">	SetPosition(0.0);</a>
<a name="ln631"> </a>
<a name="ln632">	fAutoplay = fAutoplaySetting;</a>
<a name="ln633">}</a>
<a name="ln634"> </a>
<a name="ln635"> </a>
<a name="ln636">void</a>
<a name="ln637">Controller::Play()</a>
<a name="ln638">{</a>
<a name="ln639">	//printf(&quot;Controller::Play\n&quot;);</a>
<a name="ln640"> </a>
<a name="ln641">	BAutolock _(this);</a>
<a name="ln642"> </a>
<a name="ln643">	StartPlaying();</a>
<a name="ln644">	fAutoplay = true;</a>
<a name="ln645">}</a>
<a name="ln646"> </a>
<a name="ln647"> </a>
<a name="ln648">void</a>
<a name="ln649">Controller::Pause()</a>
<a name="ln650">{</a>
<a name="ln651">//	printf(&quot;Controller::Pause\n&quot;);</a>
<a name="ln652"> </a>
<a name="ln653">	BAutolock _(this);</a>
<a name="ln654"> </a>
<a name="ln655">	PausePlaying();</a>
<a name="ln656"> </a>
<a name="ln657">	fAutoplay = fAutoplaySetting;</a>
<a name="ln658">}</a>
<a name="ln659"> </a>
<a name="ln660"> </a>
<a name="ln661">void</a>
<a name="ln662">Controller::TogglePlaying()</a>
<a name="ln663">{</a>
<a name="ln664">//	printf(&quot;Controller::TogglePlaying\n&quot;);</a>
<a name="ln665"> </a>
<a name="ln666">	BAutolock _(this);</a>
<a name="ln667"> </a>
<a name="ln668">	if (InitCheck() == B_OK) {</a>
<a name="ln669">		NodeManager::TogglePlaying();</a>
<a name="ln670"> </a>
<a name="ln671">		fAutoplay = IsPlaying() || fAutoplaySetting;</a>
<a name="ln672">	}</a>
<a name="ln673">}</a>
<a name="ln674"> </a>
<a name="ln675"> </a>
<a name="ln676">uint32</a>
<a name="ln677">Controller::PlaybackState()</a>
<a name="ln678">{</a>
<a name="ln679">	BAutolock _(this);</a>
<a name="ln680"> </a>
<a name="ln681">	return _PlaybackState(PlaybackManager::PlayMode());</a>
<a name="ln682">}</a>
<a name="ln683"> </a>
<a name="ln684"> </a>
<a name="ln685">bigtime_t</a>
<a name="ln686">Controller::TimeDuration()</a>
<a name="ln687">{</a>
<a name="ln688">	BAutolock _(this);</a>
<a name="ln689"> </a>
<a name="ln690">	return fDuration;</a>
<a name="ln691">}</a>
<a name="ln692"> </a>
<a name="ln693"> </a>
<a name="ln694">bigtime_t</a>
<a name="ln695">Controller::TimePosition()</a>
<a name="ln696">{</a>
<a name="ln697">	BAutolock _(this);</a>
<a name="ln698"> </a>
<a name="ln699">	return _TimePosition();</a>
<a name="ln700">}</a>
<a name="ln701"> </a>
<a name="ln702"> </a>
<a name="ln703">status_t</a>
<a name="ln704">Controller::SaveState(bool reset)</a>
<a name="ln705">{</a>
<a name="ln706">	if (fItem.Get() == NULL)</a>
<a name="ln707">		return B_OK;</a>
<a name="ln708">	if (reset)</a>
<a name="ln709">		fCurrentFrame = 0;</a>
<a name="ln710">	status_t status = fItem.Get()-&gt;SetLastVolume(fVolume);</a>
<a name="ln711">	if (status == B_OK)</a>
<a name="ln712">		status = fItem.Get()-&gt;SetLastFrame(fCurrentFrame);</a>
<a name="ln713">	else</a>
<a name="ln714">		fItem.Get()-&gt;SetLastFrame(fCurrentFrame);</a>
<a name="ln715">	return status;</a>
<a name="ln716">}</a>
<a name="ln717"> </a>
<a name="ln718"> </a>
<a name="ln719">void</a>
<a name="ln720">Controller::RestoreState()</a>
<a name="ln721">{</a>
<a name="ln722">	PlaylistItem *item =fItem.Get();</a>
<a name="ln723">	if (item == NULL)</a>
<a name="ln724">		return;</a>
<a name="ln725"> </a>
<a name="ln726">	int lastFrame = item-&gt;LastFrame();</a>
<a name="ln727">	float lastVolume = item-&gt;LastVolume();</a>
<a name="ln728"> </a>
<a name="ln729">	// Don't Pause()/Play() if we have nothing to do.</a>
<a name="ln730">	if (lastFrame &lt;= 0 &amp;&amp; lastVolume &lt; 0)</a>
<a name="ln731">		return;</a>
<a name="ln732"> </a>
<a name="ln733">	Pause();</a>
<a name="ln734"> </a>
<a name="ln735">	if (lastFrame &gt; 0) {</a>
<a name="ln736">		bool resume = fResume == mpSettings::RESUME_ALWAYS;</a>
<a name="ln737">		if (fResume == mpSettings::RESUME_ASK) {</a>
<a name="ln738">			BString label;</a>
<a name="ln739">			int32 time = (int32)((float)lastFrame * TimeDuration()</a>
<a name="ln740">					/ (1000000 * _FrameDuration()));</a>
<a name="ln741">			label.SetToFormat(B_TRANSLATE(&quot;Do you want to resume %s at %dm%ds?&quot;),</a>
<a name="ln742">					item-&gt;Name().String(), time / 60, time % 60);</a>
<a name="ln743">			BAlert *alert = new BAlert(B_TRANSLATE(&quot;Resume?&quot;), label,</a>
<a name="ln744">					B_TRANSLATE(&quot;Resume&quot;), B_TRANSLATE(&quot;Reset&quot;));</a>
<a name="ln745">			resume = alert-&gt;Go() == 0;</a>
<a name="ln746">		}</a>
<a name="ln747"> </a>
<a name="ln748">		if (resume)</a>
<a name="ln749">			SetFramePosition(lastFrame);</a>
<a name="ln750">	}</a>
<a name="ln751"> </a>
<a name="ln752">	if (lastVolume &gt;= 0)</a>
<a name="ln753">		SetVolume(lastVolume);</a>
<a name="ln754"> </a>
<a name="ln755">	Play();</a>
<a name="ln756">}</a>
<a name="ln757"> </a>
<a name="ln758"> </a>
<a name="ln759">void</a>
<a name="ln760">Controller::SetVolume(float value)</a>
<a name="ln761">{</a>
<a name="ln762">//	printf(&quot;Controller::SetVolume %.4f\n&quot;, value);</a>
<a name="ln763">	BAutolock _(this);</a>
<a name="ln764"> </a>
<a name="ln765">	value = max_c(0.0, min_c(2.0, value));</a>
<a name="ln766"> </a>
<a name="ln767">	if (fVolume != value) {</a>
<a name="ln768">		if (fMuted)</a>
<a name="ln769">			ToggleMute();</a>
<a name="ln770"> </a>
<a name="ln771">		fVolume = value;</a>
<a name="ln772">		fAudioSupplier-&gt;SetVolume(fVolume);</a>
<a name="ln773"> </a>
<a name="ln774">		_NotifyVolumeChanged(fVolume);</a>
<a name="ln775">	}</a>
<a name="ln776">}</a>
<a name="ln777"> </a>
<a name="ln778"> </a>
<a name="ln779">void</a>
<a name="ln780">Controller::VolumeUp()</a>
<a name="ln781">{</a>
<a name="ln782">	// TODO: linear &lt;-&gt; exponential</a>
<a name="ln783">	SetVolume(Volume() + 0.05);</a>
<a name="ln784">}</a>
<a name="ln785"> </a>
<a name="ln786"> </a>
<a name="ln787">void</a>
<a name="ln788">Controller::VolumeDown()</a>
<a name="ln789">{</a>
<a name="ln790">	// TODO: linear &lt;-&gt; exponential</a>
<a name="ln791">	SetVolume(Volume() - 0.05);</a>
<a name="ln792">}</a>
<a name="ln793"> </a>
<a name="ln794"> </a>
<a name="ln795">void</a>
<a name="ln796">Controller::ToggleMute()</a>
<a name="ln797">{</a>
<a name="ln798">	BAutolock _(this);</a>
<a name="ln799"> </a>
<a name="ln800">	fMuted = !fMuted;</a>
<a name="ln801"> </a>
<a name="ln802">	if (fMuted)</a>
<a name="ln803">		fAudioSupplier-&gt;SetVolume(0.0);</a>
<a name="ln804">	else</a>
<a name="ln805">		fAudioSupplier-&gt;SetVolume(fVolume);</a>
<a name="ln806"> </a>
<a name="ln807">	_NotifyMutedChanged(fMuted);</a>
<a name="ln808">}</a>
<a name="ln809"> </a>
<a name="ln810"> </a>
<a name="ln811">float</a>
<a name="ln812">Controller::Volume()</a>
<a name="ln813">{</a>
<a name="ln814">	BAutolock _(this);</a>
<a name="ln815"> </a>
<a name="ln816">	return fVolume;</a>
<a name="ln817">}</a>
<a name="ln818"> </a>
<a name="ln819"> </a>
<a name="ln820">int64</a>
<a name="ln821">Controller::SetPosition(float value)</a>
<a name="ln822">{</a>
<a name="ln823">	BAutolock _(this);</a>
<a name="ln824"> </a>
<a name="ln825">	return SetFramePosition(_FrameDuration() * value);</a>
<a name="ln826">}</a>
<a name="ln827"> </a>
<a name="ln828"> </a>
<a name="ln829">int64</a>
<a name="ln830">Controller::SetFramePosition(int64 value)</a>
<a name="ln831">{</a>
<a name="ln832">	BAutolock _(this);</a>
<a name="ln833"> </a>
<a name="ln834">	fPendingSeekRequests++;</a>
<a name="ln835">	fRequestedSeekFrame = max_c(0, min_c(_FrameDuration(), value));</a>
<a name="ln836">	fSeekFrame = fRequestedSeekFrame;</a>
<a name="ln837"> </a>
<a name="ln838">	int64 currentFrame = CurrentFrame();</a>
<a name="ln839"> </a>
<a name="ln840">	// Snap to a video keyframe, since that will be the fastest</a>
<a name="ln841">	// to display and seeking will feel more snappy. Note that we</a>
<a name="ln842">	// don't store this change in fSeekFrame, since we still want</a>
<a name="ln843">	// to report the originally requested seek frame in TimePosition()</a>
<a name="ln844">	// until we could reach that frame.</a>
<a name="ln845">	if (Duration() &gt; 240 &amp;&amp; fVideoTrackSupplier != NULL</a>
<a name="ln846">		&amp;&amp; abs(value - currentFrame) &gt; 5) {</a>
<a name="ln847">		fVideoTrackSupplier-&gt;FindKeyFrameForFrame(&amp;fSeekFrame);</a>
<a name="ln848">	}</a>
<a name="ln849"> </a>
<a name="ln850">//printf(&quot;SetFramePosition(%lld) -&gt; %lld (current: %lld, duration: %lld) &quot;</a>
<a name="ln851">//&quot;(video: %p)\n&quot;, value, fSeekFrame, currentFrame, _FrameDuration(),</a>
<a name="ln852">//fVideoTrackSupplier);</a>
<a name="ln853">	if (fSeekFrame != currentFrame) {</a>
<a name="ln854">		int64 seekFrame = fSeekFrame;</a>
<a name="ln855">		SetCurrentFrame(fSeekFrame);</a>
<a name="ln856">			// May trigger the notification and reset fSeekFrame,</a>
<a name="ln857">			// if next current frame == seek frame.</a>
<a name="ln858">		return seekFrame;</a>
<a name="ln859">	} else</a>
<a name="ln860">		NotifySeekHandled(fRequestedSeekFrame);</a>
<a name="ln861">	return currentFrame;</a>
<a name="ln862">}</a>
<a name="ln863"> </a>
<a name="ln864"> </a>
<a name="ln865">int64</a>
<a name="ln866">Controller::SetTimePosition(bigtime_t value)</a>
<a name="ln867">{</a>
<a name="ln868">	BAutolock _(this);</a>
<a name="ln869"> </a>
<a name="ln870">	return SetPosition((float)value / TimeDuration());</a>
<a name="ln871">}</a>
<a name="ln872"> </a>
<a name="ln873"> </a>
<a name="ln874">// #pragma mark -</a>
<a name="ln875"> </a>
<a name="ln876"> </a>
<a name="ln877">bool</a>
<a name="ln878">Controller::HasFile()</a>
<a name="ln879">{</a>
<a name="ln880">	// you need to hold the data lock</a>
<a name="ln881">	return fItem != NULL &amp;&amp; fItem-&gt;HasTrackSupplier();</a>
<a name="ln882">}</a>
<a name="ln883"> </a>
<a name="ln884"> </a>
<a name="ln885">status_t</a>
<a name="ln886">Controller::GetFileFormatInfo(media_file_format* fileFormat)</a>
<a name="ln887">{</a>
<a name="ln888">	// you need to hold the data lock</a>
<a name="ln889">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln890">		return B_NO_INIT;</a>
<a name="ln891">	return fItem-&gt;GetTrackSupplier()-&gt;GetFileFormatInfo(fileFormat);</a>
<a name="ln892">}</a>
<a name="ln893"> </a>
<a name="ln894"> </a>
<a name="ln895">status_t</a>
<a name="ln896">Controller::GetCopyright(BString* copyright)</a>
<a name="ln897">{</a>
<a name="ln898">	// you need to hold the data lock</a>
<a name="ln899">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln900">		return B_NO_INIT;</a>
<a name="ln901">	return fItem-&gt;GetTrackSupplier()-&gt;GetCopyright(copyright);</a>
<a name="ln902">}</a>
<a name="ln903"> </a>
<a name="ln904"> </a>
<a name="ln905">status_t</a>
<a name="ln906">Controller::GetLocation(BString* location)</a>
<a name="ln907">{</a>
<a name="ln908">	// you need to hold the data lock</a>
<a name="ln909">	if (fItem.Get() == NULL)</a>
<a name="ln910">		return B_NO_INIT;</a>
<a name="ln911">	*location = fItem-&gt;LocationURI();</a>
<a name="ln912">	return B_OK;</a>
<a name="ln913">}</a>
<a name="ln914"> </a>
<a name="ln915"> </a>
<a name="ln916">status_t</a>
<a name="ln917">Controller::GetName(BString* name)</a>
<a name="ln918">{</a>
<a name="ln919">	// you need to hold the data lock</a>
<a name="ln920">	if (fItem.Get() == NULL)</a>
<a name="ln921">		return B_NO_INIT;</a>
<a name="ln922">	*name = fItem-&gt;Name();</a>
<a name="ln923">	return B_OK;</a>
<a name="ln924">}</a>
<a name="ln925"> </a>
<a name="ln926"> </a>
<a name="ln927">status_t</a>
<a name="ln928">Controller::GetEncodedVideoFormat(media_format* format)</a>
<a name="ln929">{</a>
<a name="ln930">	// you need to hold the data lock</a>
<a name="ln931">	if (fVideoTrackSupplier)</a>
<a name="ln932">		return fVideoTrackSupplier-&gt;GetEncodedFormat(format);</a>
<a name="ln933">	return B_NO_INIT;</a>
<a name="ln934">}</a>
<a name="ln935"> </a>
<a name="ln936"> </a>
<a name="ln937">status_t</a>
<a name="ln938">Controller::GetVideoCodecInfo(media_codec_info* info)</a>
<a name="ln939">{</a>
<a name="ln940">	// you need to hold the data lock</a>
<a name="ln941">	if (fVideoTrackSupplier)</a>
<a name="ln942">		return fVideoTrackSupplier-&gt;GetCodecInfo(info);</a>
<a name="ln943">	return B_NO_INIT;</a>
<a name="ln944">}</a>
<a name="ln945"> </a>
<a name="ln946"> </a>
<a name="ln947">status_t</a>
<a name="ln948">Controller::GetEncodedAudioFormat(media_format* format)</a>
<a name="ln949">{</a>
<a name="ln950">	// you need to hold the data lock</a>
<a name="ln951">	if (fAudioTrackSupplier)</a>
<a name="ln952">		return fAudioTrackSupplier-&gt;GetEncodedFormat(format);</a>
<a name="ln953">	return B_NO_INIT;</a>
<a name="ln954">}</a>
<a name="ln955"> </a>
<a name="ln956"> </a>
<a name="ln957">status_t</a>
<a name="ln958">Controller::GetAudioCodecInfo(media_codec_info* info)</a>
<a name="ln959">{</a>
<a name="ln960">	// you need to hold the data lock</a>
<a name="ln961">	if (fAudioTrackSupplier)</a>
<a name="ln962">		return fAudioTrackSupplier-&gt;GetCodecInfo(info);</a>
<a name="ln963">	return B_NO_INIT;</a>
<a name="ln964">}</a>
<a name="ln965"> </a>
<a name="ln966"> </a>
<a name="ln967">status_t</a>
<a name="ln968">Controller::GetMetaData(BMessage* metaData)</a>
<a name="ln969">{</a>
<a name="ln970">	// you need to hold the data lock</a>
<a name="ln971">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln972">		return B_NO_INIT;</a>
<a name="ln973">	return fItem-&gt;GetTrackSupplier()-&gt;GetMetaData(metaData);</a>
<a name="ln974">}</a>
<a name="ln975"> </a>
<a name="ln976"> </a>
<a name="ln977">status_t</a>
<a name="ln978">Controller::GetVideoMetaData(int32 index, BMessage* metaData)</a>
<a name="ln979">{</a>
<a name="ln980">	// you need to hold the data lock</a>
<a name="ln981">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln982">		return B_NO_INIT;</a>
<a name="ln983">	return fItem-&gt;GetTrackSupplier()-&gt;GetVideoMetaData(index, metaData);</a>
<a name="ln984">}</a>
<a name="ln985"> </a>
<a name="ln986"> </a>
<a name="ln987">status_t</a>
<a name="ln988">Controller::GetAudioMetaData(int32 index, BMessage* metaData)</a>
<a name="ln989">{</a>
<a name="ln990">	// you need to hold the data lock</a>
<a name="ln991">	if (fItem == NULL || !fItem-&gt;HasTrackSupplier())</a>
<a name="ln992">		return B_NO_INIT;</a>
<a name="ln993">	return fItem-&gt;GetTrackSupplier()-&gt;GetAudioMetaData(index, metaData);</a>
<a name="ln994">}</a>
<a name="ln995"> </a>
<a name="ln996"> </a>
<a name="ln997">// #pragma mark -</a>
<a name="ln998"> </a>
<a name="ln999"> </a>
<a name="ln1000">void</a>
<a name="ln1001">Controller::SetVideoView(VideoView *view)</a>
<a name="ln1002">{</a>
<a name="ln1003">	BAutolock _(this);</a>
<a name="ln1004"> </a>
<a name="ln1005">	fVideoView = view;</a>
<a name="ln1006">}</a>
<a name="ln1007"> </a>
<a name="ln1008"> </a>
<a name="ln1009">bool</a>
<a name="ln1010">Controller::IsOverlayActive()</a>
<a name="ln1011">{</a>
<a name="ln1012">	if (fVideoView)</a>
<a name="ln1013">		return fVideoView-&gt;IsOverlayActive();</a>
<a name="ln1014"> </a>
<a name="ln1015">	return false;</a>
<a name="ln1016">}</a>
<a name="ln1017"> </a>
<a name="ln1018"> </a>
<a name="ln1019">// #pragma mark -</a>
<a name="ln1020"> </a>
<a name="ln1021"> </a>
<a name="ln1022">bool</a>
<a name="ln1023">Controller::AddListener(Listener* listener)</a>
<a name="ln1024">{</a>
<a name="ln1025">	BAutolock _(this);</a>
<a name="ln1026"> </a>
<a name="ln1027">	if (listener &amp;&amp; !fListeners.HasItem(listener))</a>
<a name="ln1028">		return fListeners.AddItem(listener);</a>
<a name="ln1029">	return false;</a>
<a name="ln1030">}</a>
<a name="ln1031"> </a>
<a name="ln1032"> </a>
<a name="ln1033">void</a>
<a name="ln1034">Controller::RemoveListener(Listener* listener)</a>
<a name="ln1035">{</a>
<a name="ln1036">	BAutolock _(this);</a>
<a name="ln1037"> </a>
<a name="ln1038">	fListeners.RemoveItem(listener);</a>
<a name="ln1039">}</a>
<a name="ln1040"> </a>
<a name="ln1041"> </a>
<a name="ln1042">// #pragma mark - Private</a>
<a name="ln1043"> </a>
<a name="ln1044"> </a>
<a name="ln1045">void</a>
<a name="ln1046">Controller::_AdoptGlobalSettings()</a>
<a name="ln1047">{</a>
<a name="ln1048">	mpSettings settings;</a>
<a name="ln1049">	Settings::Default()-&gt;Get(settings);</a>
<a name="ln1050"> </a>
<a name="ln1051">	fAutoplaySetting = settings.autostart;</a>
<a name="ln1052">	// not yet used:</a>
<a name="ln1053">	fLoopMovies = settings.loopMovie;</a>
<a name="ln1054">	fLoopSounds = settings.loopSound;</a>
<a name="ln1055">	fBackgroundMovieVolumeMode = settings.backgroundMovieVolumeMode;</a>
<a name="ln1056">	fResume = settings.resume;</a>
<a name="ln1057">}</a>
<a name="ln1058"> </a>
<a name="ln1059"> </a>
<a name="ln1060">uint32</a>
<a name="ln1061">Controller::_PlaybackState(int32 playingMode) const</a>
<a name="ln1062">{</a>
<a name="ln1063">	uint32 state = 0;</a>
<a name="ln1064">	switch (playingMode) {</a>
<a name="ln1065">		case MODE_PLAYING_PAUSED_FORWARD:</a>
<a name="ln1066">		case MODE_PLAYING_PAUSED_BACKWARD:</a>
<a name="ln1067">			state = PLAYBACK_STATE_PAUSED;</a>
<a name="ln1068">			break;</a>
<a name="ln1069">		case MODE_PLAYING_FORWARD:</a>
<a name="ln1070">		case MODE_PLAYING_BACKWARD:</a>
<a name="ln1071">			state = PLAYBACK_STATE_PLAYING;</a>
<a name="ln1072">			break;</a>
<a name="ln1073"> </a>
<a name="ln1074">		default:</a>
<a name="ln1075">			state = PLAYBACK_STATE_STOPPED;</a>
<a name="ln1076">			break;</a>
<a name="ln1077">	}</a>
<a name="ln1078">	return state;</a>
<a name="ln1079">}</a>
<a name="ln1080"> </a>
<a name="ln1081"> </a>
<a name="ln1082">bigtime_t</a>
<a name="ln1083">Controller::_TimePosition() const</a>
<a name="ln1084">{</a>
<a name="ln1085">	if (fDuration == 0)</a>
<a name="ln1086">		return 0;</a>
<a name="ln1087"> </a>
<a name="ln1088">	// Check if we are still waiting to reach the seekframe,</a>
<a name="ln1089">	// pass the last pending seek frame back to the caller, so</a>
<a name="ln1090">	// that the view of the current frame/time from the outside</a>
<a name="ln1091">	// does not depend on the internal latency to reach requested</a>
<a name="ln1092">	// frames asynchronously.</a>
<a name="ln1093">	int64 frame;</a>
<a name="ln1094">	if (fPendingSeekRequests &gt; 0)</a>
<a name="ln1095">		frame = fRequestedSeekFrame;</a>
<a name="ln1096">	else</a>
<a name="ln1097">		frame = fCurrentFrame;</a>
<a name="ln1098"> </a>
<a name="ln1099">	return frame * fDuration / _FrameDuration();</a>
<a name="ln1100">}</a>
<a name="ln1101"> </a>
<a name="ln1102"> </a>
<a name="ln1103">int64</a>
<a name="ln1104">Controller::_FrameDuration() const</a>
<a name="ln1105">{</a>
<a name="ln1106">	// This should really be total frames (video frames at that)</a>
<a name="ln1107">	// TODO: It is not so nice that the MediaPlayer still measures</a>
<a name="ln1108">	// in video frames if only playing audio. Here for example, it will</a>
<a name="ln1109">	// return a duration of 0 if the audio clip happens to be shorter than</a>
<a name="ln1110">	// one video frame at 25 fps.</a>
<a name="ln1111">	return (int64)((double)fDuration * fVideoFrameRate / 1000000.0);</a>
<a name="ln1112">}</a>
<a name="ln1113"> </a>
<a name="ln1114"> </a>
<a name="ln1115">// #pragma mark - Notifications</a>
<a name="ln1116"> </a>
<a name="ln1117"> </a>
<a name="ln1118">void</a>
<a name="ln1119">Controller::_NotifyFileChanged(PlaylistItem* item, status_t result) const</a>
<a name="ln1120">{</a>
<a name="ln1121">	BList listeners(fListeners);</a>
<a name="ln1122">	int32 count = listeners.CountItems();</a>
<a name="ln1123">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1124">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1125">		listener-&gt;FileChanged(item, result);</a>
<a name="ln1126">	}</a>
<a name="ln1127">}</a>
<a name="ln1128"> </a>
<a name="ln1129"> </a>
<a name="ln1130">void</a>
<a name="ln1131">Controller::_NotifyFileFinished() const</a>
<a name="ln1132">{</a>
<a name="ln1133">	BList listeners(fListeners);</a>
<a name="ln1134">	int32 count = listeners.CountItems();</a>
<a name="ln1135">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1136">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1137">		listener-&gt;FileFinished();</a>
<a name="ln1138">	}</a>
<a name="ln1139">}</a>
<a name="ln1140"> </a>
<a name="ln1141"> </a>
<a name="ln1142">void</a>
<a name="ln1143">Controller::_NotifyVideoTrackChanged(int32 index) const</a>
<a name="ln1144">{</a>
<a name="ln1145">	BList listeners(fListeners);</a>
<a name="ln1146">	int32 count = listeners.CountItems();</a>
<a name="ln1147">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1148">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1149">		listener-&gt;VideoTrackChanged(index);</a>
<a name="ln1150">	}</a>
<a name="ln1151">}</a>
<a name="ln1152"> </a>
<a name="ln1153"> </a>
<a name="ln1154">void</a>
<a name="ln1155">Controller::_NotifyAudioTrackChanged(int32 index) const</a>
<a name="ln1156">{</a>
<a name="ln1157">	BList listeners(fListeners);</a>
<a name="ln1158">	int32 count = listeners.CountItems();</a>
<a name="ln1159">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1160">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1161">		listener-&gt;AudioTrackChanged(index);</a>
<a name="ln1162">	}</a>
<a name="ln1163">}</a>
<a name="ln1164"> </a>
<a name="ln1165"> </a>
<a name="ln1166">void</a>
<a name="ln1167">Controller::_NotifySubTitleTrackChanged(int32 index) const</a>
<a name="ln1168">{</a>
<a name="ln1169">	BList listeners(fListeners);</a>
<a name="ln1170">	int32 count = listeners.CountItems();</a>
<a name="ln1171">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1172">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1173">		listener-&gt;SubTitleTrackChanged(index);</a>
<a name="ln1174">	}</a>
<a name="ln1175">}</a>
<a name="ln1176"> </a>
<a name="ln1177"> </a>
<a name="ln1178">void</a>
<a name="ln1179">Controller::_NotifyVideoStatsChanged() const</a>
<a name="ln1180">{</a>
<a name="ln1181">	BList listeners(fListeners);</a>
<a name="ln1182">	int32 count = listeners.CountItems();</a>
<a name="ln1183">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1184">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1185">		listener-&gt;VideoStatsChanged();</a>
<a name="ln1186">	}</a>
<a name="ln1187">}</a>
<a name="ln1188"> </a>
<a name="ln1189"> </a>
<a name="ln1190">void</a>
<a name="ln1191">Controller::_NotifyAudioStatsChanged() const</a>
<a name="ln1192">{</a>
<a name="ln1193">	BList listeners(fListeners);</a>
<a name="ln1194">	int32 count = listeners.CountItems();</a>
<a name="ln1195">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1196">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1197">		listener-&gt;AudioStatsChanged();</a>
<a name="ln1198">	}</a>
<a name="ln1199">}</a>
<a name="ln1200"> </a>
<a name="ln1201"> </a>
<a name="ln1202">void</a>
<a name="ln1203">Controller::_NotifyPlaybackStateChanged(uint32 state) const</a>
<a name="ln1204">{</a>
<a name="ln1205">	BList listeners(fListeners);</a>
<a name="ln1206">	int32 count = listeners.CountItems();</a>
<a name="ln1207">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1208">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1209">		listener-&gt;PlaybackStateChanged(state);</a>
<a name="ln1210">	}</a>
<a name="ln1211">}</a>
<a name="ln1212"> </a>
<a name="ln1213"> </a>
<a name="ln1214">void</a>
<a name="ln1215">Controller::_NotifyPositionChanged(float position) const</a>
<a name="ln1216">{</a>
<a name="ln1217">	BList listeners(fListeners);</a>
<a name="ln1218">	int32 count = listeners.CountItems();</a>
<a name="ln1219">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1220">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1221">		listener-&gt;PositionChanged(position);</a>
<a name="ln1222">	}</a>
<a name="ln1223">}</a>
<a name="ln1224"> </a>
<a name="ln1225"> </a>
<a name="ln1226">void</a>
<a name="ln1227">Controller::_NotifySeekHandled(int64 seekFrame) const</a>
<a name="ln1228">{</a>
<a name="ln1229">	BList listeners(fListeners);</a>
<a name="ln1230">	int32 count = listeners.CountItems();</a>
<a name="ln1231">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1232">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1233">		listener-&gt;SeekHandled(seekFrame);</a>
<a name="ln1234">	}</a>
<a name="ln1235">}</a>
<a name="ln1236"> </a>
<a name="ln1237"> </a>
<a name="ln1238">void</a>
<a name="ln1239">Controller::_NotifyVolumeChanged(float volume) const</a>
<a name="ln1240">{</a>
<a name="ln1241">	BList listeners(fListeners);</a>
<a name="ln1242">	int32 count = listeners.CountItems();</a>
<a name="ln1243">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1244">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1245">		listener-&gt;VolumeChanged(volume);</a>
<a name="ln1246">	}</a>
<a name="ln1247">}</a>
<a name="ln1248"> </a>
<a name="ln1249"> </a>
<a name="ln1250">void</a>
<a name="ln1251">Controller::_NotifyMutedChanged(bool muted) const</a>
<a name="ln1252">{</a>
<a name="ln1253">	BList listeners(fListeners);</a>
<a name="ln1254">	int32 count = listeners.CountItems();</a>
<a name="ln1255">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1256">		Listener* listener = (Listener*)listeners.ItemAtFast(i);</a>
<a name="ln1257">		listener-&gt;MutedChanged(muted);</a>
<a name="ln1258">	}</a>
<a name="ln1259">}</a>
<a name="ln1260"> </a>
<a name="ln1261"> </a>
<a name="ln1262">void</a>
<a name="ln1263">Controller::NotifyPlayModeChanged(int32 mode) const</a>
<a name="ln1264">{</a>
<a name="ln1265">	uint32 state = _PlaybackState(mode);</a>
<a name="ln1266">	if (fVideoView)</a>
<a name="ln1267">		fVideoView-&gt;SetPlaying(state == PLAYBACK_STATE_PLAYING);</a>
<a name="ln1268">	_NotifyPlaybackStateChanged(state);</a>
<a name="ln1269">}</a>
<a name="ln1270"> </a>
<a name="ln1271"> </a>
<a name="ln1272">void</a>
<a name="ln1273">Controller::NotifyLoopModeChanged(int32 mode) const</a>
<a name="ln1274">{</a>
<a name="ln1275">}</a>
<a name="ln1276"> </a>
<a name="ln1277"> </a>
<a name="ln1278">void</a>
<a name="ln1279">Controller::NotifyLoopingEnabledChanged(bool enabled) const</a>
<a name="ln1280">{</a>
<a name="ln1281">}</a>
<a name="ln1282"> </a>
<a name="ln1283"> </a>
<a name="ln1284">void</a>
<a name="ln1285">Controller::NotifyVideoBoundsChanged(BRect bounds) const</a>
<a name="ln1286">{</a>
<a name="ln1287">}</a>
<a name="ln1288"> </a>
<a name="ln1289"> </a>
<a name="ln1290">void</a>
<a name="ln1291">Controller::NotifyFPSChanged(float fps) const</a>
<a name="ln1292">{</a>
<a name="ln1293">}</a>
<a name="ln1294"> </a>
<a name="ln1295"> </a>
<a name="ln1296">void</a>
<a name="ln1297">Controller::NotifyCurrentFrameChanged(int64 frame) const</a>
<a name="ln1298">{</a>
<a name="ln1299">	fCurrentFrame = frame;</a>
<a name="ln1300">	bigtime_t timePosition = _TimePosition();</a>
<a name="ln1301">	_NotifyPositionChanged((float)timePosition / fDuration);</a>
<a name="ln1302"> </a>
<a name="ln1303">	if (fSubTitles != NULL) {</a>
<a name="ln1304">		const SubTitle* subTitle = fSubTitles-&gt;SubTitleAt(timePosition);</a>
<a name="ln1305">		if (subTitle != NULL)</a>
<a name="ln1306">			fVideoView-&gt;SetSubTitle(subTitle-&gt;text.String());</a>
<a name="ln1307">		else</a>
<a name="ln1308">			fVideoView-&gt;SetSubTitle(NULL);</a>
<a name="ln1309">	}</a>
<a name="ln1310">}</a>
<a name="ln1311"> </a>
<a name="ln1312"> </a>
<a name="ln1313">void</a>
<a name="ln1314">Controller::NotifySpeedChanged(float speed) const</a>
<a name="ln1315">{</a>
<a name="ln1316">}</a>
<a name="ln1317"> </a>
<a name="ln1318"> </a>
<a name="ln1319">void</a>
<a name="ln1320">Controller::NotifyFrameDropped() const</a>
<a name="ln1321">{</a>
<a name="ln1322">//	printf(&quot;Controller::NotifyFrameDropped()\n&quot;);</a>
<a name="ln1323">}</a>
<a name="ln1324"> </a>
<a name="ln1325"> </a>
<a name="ln1326">void</a>
<a name="ln1327">Controller::NotifyStopFrameReached() const</a>
<a name="ln1328">{</a>
<a name="ln1329">	// Currently, this means we reached the end of the current</a>
<a name="ln1330">	// file and should play the next file</a>
<a name="ln1331">	_NotifyFileFinished();</a>
<a name="ln1332">}</a>
<a name="ln1333"> </a>
<a name="ln1334"> </a>
<a name="ln1335">void</a>
<a name="ln1336">Controller::NotifySeekHandled(int64 seekedFrame) const</a>
<a name="ln1337">{</a>
<a name="ln1338">	if (fPendingSeekRequests == 0)</a>
<a name="ln1339">		return;</a>
<a name="ln1340"> </a>
<a name="ln1341">	fPendingSeekRequests--;</a>
<a name="ln1342">	if (fPendingSeekRequests == 0) {</a>
<a name="ln1343">		fSeekFrame = -1;</a>
<a name="ln1344">		fRequestedSeekFrame = -1;</a>
<a name="ln1345">	}</a>
<a name="ln1346"> </a>
<a name="ln1347">	_NotifySeekHandled(seekedFrame);</a>
<a name="ln1348">}</a>
<a name="ln1349"> </a>

</code></pre>
<div class="balloon" rel="746"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
