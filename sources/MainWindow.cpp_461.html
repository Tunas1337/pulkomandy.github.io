
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>MainWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2006-2011, Stephan AÃŸmus &lt;superstippi@gmx.de&gt;.</a>
<a name="ln3"> * All rights reserved. Distributed under the terms of the MIT License.</a>
<a name="ln4"> */</a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;MainWindow.h&quot;</a>
<a name="ln7"> </a>
<a name="ln8">#include &lt;new&gt;</a>
<a name="ln9">#include &lt;stdio.h&gt;</a>
<a name="ln10"> </a>
<a name="ln11">#include &lt;Alert.h&gt;</a>
<a name="ln12">#include &lt;Catalog.h&gt;</a>
<a name="ln13">#include &lt;Clipboard.h&gt;</a>
<a name="ln14">#include &lt;GridLayout.h&gt;</a>
<a name="ln15">#include &lt;GroupLayout.h&gt;</a>
<a name="ln16">#include &lt;GroupView.h&gt;</a>
<a name="ln17">#include &lt;Directory.h&gt;</a>
<a name="ln18">#include &lt;Entry.h&gt;</a>
<a name="ln19">#include &lt;File.h&gt;</a>
<a name="ln20">#include &lt;fs_attr.h&gt;</a>
<a name="ln21">#include &lt;Locale.h&gt;</a>
<a name="ln22">#include &lt;Menu.h&gt;</a>
<a name="ln23">#include &lt;MenuBar.h&gt;</a>
<a name="ln24">#include &lt;MenuItem.h&gt;</a>
<a name="ln25">#include &lt;Message.h&gt;</a>
<a name="ln26">#include &lt;Screen.h&gt;</a>
<a name="ln27">#include &lt;ScrollView.h&gt;</a>
<a name="ln28"> </a>
<a name="ln29">#include &quot;support_ui.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">#include &quot;AddPathsCommand.h&quot;</a>
<a name="ln32">#include &quot;AddShapesCommand.h&quot;</a>
<a name="ln33">#include &quot;AddStylesCommand.h&quot;</a>
<a name="ln34">#include &quot;AttributeSaver.h&quot;</a>
<a name="ln35">#include &quot;BitmapExporter.h&quot;</a>
<a name="ln36">#include &quot;BitmapSetSaver.h&quot;</a>
<a name="ln37">#include &quot;CanvasView.h&quot;</a>
<a name="ln38">#include &quot;CommandStack.h&quot;</a>
<a name="ln39">#include &quot;CompoundCommand.h&quot;</a>
<a name="ln40">#include &quot;CurrentColor.h&quot;</a>
<a name="ln41">#include &quot;Document.h&quot;</a>
<a name="ln42">#include &quot;FlatIconExporter.h&quot;</a>
<a name="ln43">#include &quot;FlatIconFormat.h&quot;</a>
<a name="ln44">#include &quot;FlatIconImporter.h&quot;</a>
<a name="ln45">#include &quot;IconObjectListView.h&quot;</a>
<a name="ln46">#include &quot;IconEditorApp.h&quot;</a>
<a name="ln47">#include &quot;IconView.h&quot;</a>
<a name="ln48">#include &quot;MessageExporter.h&quot;</a>
<a name="ln49">#include &quot;MessageImporter.h&quot;</a>
<a name="ln50">#include &quot;MessengerSaver.h&quot;</a>
<a name="ln51">#include &quot;NativeSaver.h&quot;</a>
<a name="ln52">#include &quot;PathListView.h&quot;</a>
<a name="ln53">#include &quot;RDefExporter.h&quot;</a>
<a name="ln54">#include &quot;ScrollView.h&quot;</a>
<a name="ln55">#include &quot;SimpleFileSaver.h&quot;</a>
<a name="ln56">#include &quot;ShapeListView.h&quot;</a>
<a name="ln57">#include &quot;SourceExporter.h&quot;</a>
<a name="ln58">#include &quot;StyleListView.h&quot;</a>
<a name="ln59">#include &quot;StyleView.h&quot;</a>
<a name="ln60">#include &quot;SVGExporter.h&quot;</a>
<a name="ln61">#include &quot;SVGImporter.h&quot;</a>
<a name="ln62">#include &quot;SwatchGroup.h&quot;</a>
<a name="ln63">#include &quot;TransformerListView.h&quot;</a>
<a name="ln64">#include &quot;TransformGradientBox.h&quot;</a>
<a name="ln65">#include &quot;TransformShapesBox.h&quot;</a>
<a name="ln66">#include &quot;Util.h&quot;</a>
<a name="ln67"> </a>
<a name="ln68">// TODO: just for testing</a>
<a name="ln69">#include &quot;AffineTransformer.h&quot;</a>
<a name="ln70">#include &quot;GradientTransformable.h&quot;</a>
<a name="ln71">#include &quot;Icon.h&quot;</a>
<a name="ln72">#include &quot;MultipleManipulatorState.h&quot;</a>
<a name="ln73">#include &quot;PathManipulator.h&quot;</a>
<a name="ln74">#include &quot;Shape.h&quot;</a>
<a name="ln75">#include &quot;ShapeContainer.h&quot;</a>
<a name="ln76">#include &quot;ShapeListView.h&quot;</a>
<a name="ln77">#include &quot;StrokeTransformer.h&quot;</a>
<a name="ln78">#include &quot;Style.h&quot;</a>
<a name="ln79">#include &quot;StyleContainer.h&quot;</a>
<a name="ln80">#include &quot;VectorPath.h&quot;</a>
<a name="ln81"> </a>
<a name="ln82">#include &quot;StyledTextImporter.h&quot;</a>
<a name="ln83"> </a>
<a name="ln84"> </a>
<a name="ln85">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln86">#define B_TRANSLATION_CONTEXT &quot;Icon-O-Matic-Main&quot;</a>
<a name="ln87"> </a>
<a name="ln88"> </a>
<a name="ln89">using std::nothrow;</a>
<a name="ln90"> </a>
<a name="ln91">enum {</a>
<a name="ln92">	MSG_UNDO						= 'undo',</a>
<a name="ln93">	MSG_REDO						= 'redo',</a>
<a name="ln94">	MSG_UNDO_STACK_CHANGED			= 'usch',</a>
<a name="ln95"> </a>
<a name="ln96">	MSG_PATH_SELECTED				= 'vpsl',</a>
<a name="ln97">	MSG_STYLE_SELECTED				= 'stsl',</a>
<a name="ln98">	MSG_SHAPE_SELECTED				= 'spsl',</a>
<a name="ln99"> </a>
<a name="ln100">	MSG_SHAPE_RESET_TRANSFORMATION	= 'rtsh',</a>
<a name="ln101">	MSG_STYLE_RESET_TRANSFORMATION	= 'rtst',</a>
<a name="ln102"> </a>
<a name="ln103">	MSG_MOUSE_FILTER_MODE			= 'mfmd',</a>
<a name="ln104"> </a>
<a name="ln105">	MSG_RENAME_OBJECT				= 'rnam',</a>
<a name="ln106">};</a>
<a name="ln107"> </a>
<a name="ln108"> </a>
<a name="ln109">MainWindow::MainWindow(BRect frame, IconEditorApp* app,</a>
<a name="ln110">		const BMessage* settings)</a>
<a name="ln111">	:</a>
<a name="ln112">	BWindow(frame, B_TRANSLATE_SYSTEM_NAME(&quot;Icon-O-Matic&quot;),</a>
<a name="ln113">		B_DOCUMENT_WINDOW_LOOK, B_NORMAL_WINDOW_FEEL,</a>
<a name="ln114">		B_ASYNCHRONOUS_CONTROLS | B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln115">	fApp(app),</a>
<a name="ln116">	fDocument(new Document(B_TRANSLATE(&quot;Untitled&quot;))),</a>
<a name="ln117">	fCurrentColor(new CurrentColor()),</a>
<a name="ln118">	fIcon(NULL),</a>
<a name="ln119">	fMessageAfterSave(NULL)</a>
<a name="ln120">{</a>
<a name="ln121">	_Init();</a>
<a name="ln122"> </a>
<a name="ln123">	RestoreSettings(settings);</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126"> </a>
<a name="ln127">MainWindow::~MainWindow()</a>
<a name="ln128">{</a>
<a name="ln129">	SetIcon(NULL);</a>
<a name="ln130"> </a>
<a name="ln131">	delete fState;</a>
<a name="ln132"> </a>
<a name="ln133">	// Make sure there are no listeners attached to the document anymore.</a>
<a name="ln134">	while (BView* child = ChildAt(0L)) {</a>
<a name="ln135">		child-&gt;RemoveSelf();</a>
<a name="ln136">		delete child;</a>
<a name="ln137">	}</a>
<a name="ln138"> </a>
<a name="ln139">	fDocument-&gt;CommandStack()-&gt;RemoveObserver(this);</a>
<a name="ln140"> </a>
<a name="ln141">	// NOTE: it is important that the GUI has been deleted</a>
<a name="ln142">	// at this point, so that all the listener/observer</a>
<a name="ln143">	// stuff is properly detached</a>
<a name="ln144">	delete fDocument;</a>
<a name="ln145"> </a>
<a name="ln146">	delete fMessageAfterSave;</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149"> </a>
<a name="ln150">// #pragma mark -</a>
<a name="ln151"> </a>
<a name="ln152"> </a>
<a name="ln153">void</a>
<a name="ln154">MainWindow::MessageReceived(BMessage* message)</a>
<a name="ln155">{</a>
<a name="ln156">	bool discard = false;</a>
<a name="ln157"> </a>
<a name="ln158">	// Figure out if we need the write lock on the Document. For most</a>
<a name="ln159">	// messages we do, but exporting takes place in another thread and</a>
<a name="ln160">	// locking is taken care of there.</a>
<a name="ln161">	bool requiresWriteLock = true;</a>
<a name="ln162">	switch (message-&gt;what) {</a>
<a name="ln163">		case MSG_SAVE:</a>
<a name="ln164">		case MSG_EXPORT:</a>
<a name="ln165">		case MSG_SAVE_AS:</a>
<a name="ln166">		case MSG_EXPORT_AS:</a>
<a name="ln167">			requiresWriteLock = false;</a>
<a name="ln168">			break;</a>
<a name="ln169">		default:</a>
<a name="ln170">			break;</a>
<a name="ln171">	}</a>
<a name="ln172">	if (requiresWriteLock &amp;&amp; !fDocument-&gt;WriteLock()) {</a>
<a name="ln173">		BWindow::MessageReceived(message);</a>
<a name="ln174">		return;</a>
<a name="ln175">	}</a>
<a name="ln176"> </a>
<a name="ln177">	if (message-&gt;WasDropped()) {</a>
<a name="ln178">		const rgb_color* color;</a>
<a name="ln179">		ssize_t length;</a>
<a name="ln180">		// create styles from dropped colors</a>
<a name="ln181">		for (int32 i = 0; message-&gt;FindData(&quot;RGBColor&quot;, B_RGB_COLOR_TYPE, i, </a>
<a name="ln182">			(const void**)&amp;color, &amp;length) == B_OK; i++) {</a>
<a name="ln183">			if (length != sizeof(rgb_color))</a>
<a name="ln184">				continue;</a>
<a name="ln185">			char name[30];</a>
<a name="ln186">			sprintf(name, </a>
<a name="ln187">				B_TRANSLATE_CONTEXT(&quot;Color (#%02x%02x%02x)&quot;, </a>
<a name="ln188">					&quot;Style name after dropping a color&quot;), </a>
<a name="ln189">				color-&gt;red, color-&gt;green, color-&gt;blue);</a>
<a name="ln190">			Style* style = new (nothrow) Style(*color);</a>
<a name="ln191">			style-&gt;SetName(name);</a>
<a name="ln192">			Style* styles[1] = { style };</a>
<a name="ln193">			AddStylesCommand* styleCommand = new (nothrow) AddStylesCommand(</a>
<a name="ln194">				fDocument-&gt;Icon()-&gt;Styles(), styles, 1,</a>
<a name="ln195">				fDocument-&gt;Icon()-&gt;Styles()-&gt;CountStyles());</a>
<a name="ln196">			fDocument-&gt;CommandStack()-&gt;Perform(styleCommand);</a>
<a name="ln197">			// don't handle anything else,</a>
<a name="ln198">			// or we might paste the clipboard on B_PASTE</a>
<a name="ln199">			discard = true;</a>
<a name="ln200">		}</a>
<a name="ln201">	}</a>
<a name="ln202"> </a>
<a name="ln203">	switch (message-&gt;what) {</a>
<a name="ln204"> </a>
<a name="ln205">		case B_REFS_RECEIVED:</a>
<a name="ln206">		case B_SIMPLE_DATA:</a>
<a name="ln207">			// If our icon is empty, open the file in this window,</a>
<a name="ln208">			// otherwise forward to the application which will open</a>
<a name="ln209">			// it in another window, unless we append.</a>
<a name="ln210">			message-&gt;what = B_REFS_RECEIVED;</a>
<a name="ln211">			if (fDocument-&gt;Icon()-&gt;Styles()-&gt;CountStyles() == 0</a>
<a name="ln212">				&amp;&amp; fDocument-&gt;Icon()-&gt;Paths()-&gt;CountPaths() == 0</a>
<a name="ln213">				&amp;&amp; fDocument-&gt;Icon()-&gt;Shapes()-&gt;CountShapes() == 0) {</a>
<a name="ln214">				entry_ref ref;</a>
<a name="ln215">				if (message-&gt;FindRef(&quot;refs&quot;, &amp;ref) == B_OK)</a>
<a name="ln216">					Open(ref);</a>
<a name="ln217">				break;</a>
<a name="ln218">			}</a>
<a name="ln219">			if (modifiers() &amp; B_SHIFT_KEY) {</a>
<a name="ln220">				// We want the icon appended to this window.</a>
<a name="ln221">				message-&gt;AddBool(&quot;append&quot;, true);</a>
<a name="ln222">				message-&gt;AddPointer(&quot;window&quot;, this);</a>
<a name="ln223">			}</a>
<a name="ln224">			be_app-&gt;PostMessage(message);</a>
<a name="ln225">			break;</a>
<a name="ln226"> </a>
<a name="ln227">		case B_PASTE:</a>
<a name="ln228">		case B_MIME_DATA:</a>
<a name="ln229">		{</a>
<a name="ln230">			BMessage* clip = message;</a>
<a name="ln231">			status_t err;</a>
<a name="ln232"> </a>
<a name="ln233">			if (discard)</a>
<a name="ln234">				break;</a>
<a name="ln235"> </a>
<a name="ln236">			if (message-&gt;what == B_PASTE) {</a>
<a name="ln237">				if (!be_clipboard-&gt;Lock())</a>
<a name="ln238">					break;</a>
<a name="ln239">				clip = be_clipboard-&gt;Data();</a>
<a name="ln240">			}</a>
<a name="ln241"> </a>
<a name="ln242">			if (!clip || !clip-&gt;HasData(&quot;text/plain&quot;, B_MIME_TYPE)) {</a>
<a name="ln243">				if (message-&gt;what == B_PASTE)</a>
<a name="ln244">					be_clipboard-&gt;Unlock();</a>
<a name="ln245">				break;</a>
<a name="ln246">			}</a>
<a name="ln247"> </a>
<a name="ln248">			Icon* icon = new (std::nothrow) Icon(*fDocument-&gt;Icon());</a>
<a name="ln249">			if (icon != NULL) {</a>
<a name="ln250">				StyledTextImporter importer;</a>
<a name="ln251">				err = importer.Import(icon, clip);</a>
<a name="ln252">				if (err &gt;= B_OK) {</a>
<a name="ln253">					AutoWriteLocker locker(fDocument);</a>
<a name="ln254"> </a>
<a name="ln255">					SetIcon(NULL);</a>
<a name="ln256"> </a>
<a name="ln257">					// incorporate the loaded icon into the document</a>
<a name="ln258">					// (either replace it or append to it)</a>
<a name="ln259">					fDocument-&gt;MakeEmpty(false);</a>
<a name="ln260">						// if append, the document savers are preserved</a>
<a name="ln261">					fDocument-&gt;SetIcon(icon);</a>
<a name="ln262">					SetIcon(icon);</a>
<a name="ln263">				}</a>
<a name="ln264">			}</a>
<a name="ln265"> </a>
<a name="ln266">			if (message-&gt;what == B_PASTE)</a>
<a name="ln267">				be_clipboard-&gt;Unlock();</a>
<a name="ln268">			break;</a>
<a name="ln269">		}</a>
<a name="ln270"> </a>
<a name="ln271">		case MSG_OPEN:</a>
<a name="ln272">			// If our icon is empty, we want the icon to open in this</a>
<a name="ln273">			// window.</a>
<a name="ln274">			if (fDocument-&gt;Icon()-&gt;Styles()-&gt;CountStyles() == 0</a>
<a name="ln275">				&amp;&amp; fDocument-&gt;Icon()-&gt;Paths()-&gt;CountPaths() == 0</a>
<a name="ln276">				&amp;&amp; fDocument-&gt;Icon()-&gt;Shapes()-&gt;CountShapes() == 0) {</a>
<a name="ln277">				message-&gt;AddPointer(&quot;window&quot;, this);</a>
<a name="ln278">			}</a>
<a name="ln279">			be_app-&gt;PostMessage(message);</a>
<a name="ln280">			break;</a>
<a name="ln281"> </a>
<a name="ln282">		case MSG_SAVE:</a>
<a name="ln283">		case MSG_EXPORT:</a>
<a name="ln284">		{</a>
<a name="ln285">			DocumentSaver* saver;</a>
<a name="ln286">			if (message-&gt;what == MSG_SAVE)</a>
<a name="ln287">				saver = fDocument-&gt;NativeSaver();</a>
<a name="ln288">			else</a>
<a name="ln289">				saver = fDocument-&gt;ExportSaver();</a>
<a name="ln290">			if (saver != NULL) {</a>
<a name="ln291">				saver-&gt;Save(fDocument);</a>
<a name="ln292">				_PickUpActionBeforeSave();</a>
<a name="ln293">				break;</a>
<a name="ln294">			} // else fall through</a>
<a name="ln295">		}</a>
<a name="ln296">		case MSG_SAVE_AS:</a>
<a name="ln297">		case MSG_EXPORT_AS:</a>
<a name="ln298">		{</a>
<a name="ln299">			int32 exportMode;</a>
<a name="ln300">			if (message-&gt;FindInt32(&quot;export mode&quot;, &amp;exportMode) &lt; B_OK)</a>
<a name="ln301">				exportMode = EXPORT_MODE_MESSAGE;</a>
<a name="ln302">			entry_ref ref;</a>
<a name="ln303">			const char* name;</a>
<a name="ln304">			if (message-&gt;FindRef(&quot;directory&quot;, &amp;ref) == B_OK</a>
<a name="ln305">				&amp;&amp; message-&gt;FindString(&quot;name&quot;, &amp;name) == B_OK) {</a>
<a name="ln306">				// this message comes from the file panel</a>
<a name="ln307">				BDirectory dir(&amp;ref);</a>
<a name="ln308">				BEntry entry;</a>
<a name="ln309">				if (dir.InitCheck() &gt;= B_OK</a>
<a name="ln310">					&amp;&amp; entry.SetTo(&amp;dir, name, true) &gt;= B_OK</a>
<a name="ln311">					&amp;&amp; entry.GetRef(&amp;ref) &gt;= B_OK) {</a>
<a name="ln312"> </a>
<a name="ln313">					// create the document saver and remember it for later</a>
<a name="ln314">					DocumentSaver* saver = _CreateSaver(ref, exportMode);</a>
<a name="ln315">					if (saver != NULL) {</a>
<a name="ln316">						if (fDocument-&gt;WriteLock()) {</a>
<a name="ln317">							if (exportMode == EXPORT_MODE_MESSAGE)</a>
<a name="ln318">								fDocument-&gt;SetNativeSaver(saver);</a>
<a name="ln319">							else</a>
<a name="ln320">								fDocument-&gt;SetExportSaver(saver);</a>
<a name="ln321">							_UpdateWindowTitle();</a>
<a name="ln322">							fDocument-&gt;WriteUnlock();</a>
<a name="ln323">						}</a>
<a name="ln324">						saver-&gt;Save(fDocument);</a>
<a name="ln325">						_PickUpActionBeforeSave();</a>
<a name="ln326">					}</a>
<a name="ln327">				}</a>
<a name="ln328">// TODO: ...</a>
<a name="ln329">//				_SyncPanels(fSavePanel, fOpenPanel);</a>
<a name="ln330">			} else {</a>
<a name="ln331">				// configure the file panel</a>
<a name="ln332">				uint32 requestRefWhat = MSG_SAVE_AS;</a>
<a name="ln333">				bool isExportMode = message-&gt;what == MSG_EXPORT_AS</a>
<a name="ln334">					|| message-&gt;what == MSG_EXPORT;</a>
<a name="ln335">				if (isExportMode)</a>
<a name="ln336">					requestRefWhat = MSG_EXPORT_AS;</a>
<a name="ln337">				const char* saveText = _FileName(isExportMode);</a>
<a name="ln338"> </a>
<a name="ln339">				BMessage requestRef(requestRefWhat);</a>
<a name="ln340">				if (saveText != NULL)</a>
<a name="ln341">					requestRef.AddString(&quot;save text&quot;, saveText);</a>
<a name="ln342">				requestRef.AddMessenger(&quot;target&quot;, BMessenger(this, this));</a>
<a name="ln343">				be_app-&gt;PostMessage(&amp;requestRef);</a>
<a name="ln344">			}</a>
<a name="ln345">			break;</a>
<a name="ln346">		}</a>
<a name="ln347">		case B_CANCEL:</a>
<a name="ln348">			// FilePanel was canceled, do not execute the fMessageAfterSave</a>
<a name="ln349">			// next time a file panel is used, in case it was set!</a>
<a name="ln350">			delete fMessageAfterSave;</a>
<a name="ln351">			fMessageAfterSave = NULL;</a>
<a name="ln352">			break;</a>
<a name="ln353"> </a>
<a name="ln354">		case MSG_UNDO:</a>
<a name="ln355">			fDocument-&gt;CommandStack()-&gt;Undo();</a>
<a name="ln356">			break;</a>
<a name="ln357">		case MSG_REDO:</a>
<a name="ln358">			fDocument-&gt;CommandStack()-&gt;Redo();</a>
<a name="ln359">			break;</a>
<a name="ln360">		case MSG_UNDO_STACK_CHANGED:</a>
<a name="ln361">		{</a>
<a name="ln362">			// relable Undo item and update enabled status</a>
<a name="ln363">			BString label(B_TRANSLATE(&quot;Undo&quot;));</a>
<a name="ln364">			fUndoMI-&gt;SetEnabled(fDocument-&gt;CommandStack()-&gt;GetUndoName(label));</a>
<a name="ln365">			if (fUndoMI-&gt;IsEnabled())</a>
<a name="ln366">				fUndoMI-&gt;SetLabel(label.String());</a>
<a name="ln367">			else {</a>
<a name="ln368">				fUndoMI-&gt;SetLabel(B_TRANSLATE_CONTEXT(&quot;&lt;nothing to undo&gt;&quot;,</a>
<a name="ln369">					&quot;Icon-O-Matic-Menu-Edit&quot;));</a>
<a name="ln370">			}</a>
<a name="ln371">	</a>
<a name="ln372">			// relable Redo item and update enabled status</a>
<a name="ln373">			label.SetTo(B_TRANSLATE(&quot;Redo&quot;));</a>
<a name="ln374">			fRedoMI-&gt;SetEnabled(fDocument-&gt;CommandStack()-&gt;GetRedoName(label));</a>
<a name="ln375">			if (fRedoMI-&gt;IsEnabled())</a>
<a name="ln376">				fRedoMI-&gt;SetLabel(label.String());</a>
<a name="ln377">			else {</a>
<a name="ln378">				fRedoMI-&gt;SetLabel(B_TRANSLATE_CONTEXT(&quot;&lt;nothing to redo&gt;&quot;,</a>
<a name="ln379">					&quot;Icon-O-Matic-Menu-Edit&quot;));</a>
<a name="ln380">			}</a>
<a name="ln381">			break;</a>
<a name="ln382">		}</a>
<a name="ln383"> </a>
<a name="ln384">		case MSG_MOUSE_FILTER_MODE:</a>
<a name="ln385">		{</a>
<a name="ln386">			uint32 mode;</a>
<a name="ln387">			if (message-&gt;FindInt32(&quot;mode&quot;, (int32*)&amp;mode) == B_OK)</a>
<a name="ln388">				fCanvasView-&gt;SetMouseFilterMode(mode);</a>
<a name="ln389">			break;</a>
<a name="ln390">		}</a>
<a name="ln391"> </a>
<a name="ln392">		case MSG_ADD_SHAPE: {</a>
<a name="ln393">			AddStylesCommand* styleCommand = NULL;</a>
<a name="ln394">			Style* style = NULL;</a>
<a name="ln395">			if (message-&gt;HasBool(&quot;style&quot;)) {</a>
<a name="ln396">				new_style(fCurrentColor-&gt;Color(),</a>
<a name="ln397">					fDocument-&gt;Icon()-&gt;Styles(), &amp;style, &amp;styleCommand);</a>
<a name="ln398">			}</a>
<a name="ln399">		</a>
<a name="ln400">			AddPathsCommand* pathCommand = NULL;</a>
<a name="ln401">			VectorPath* path = NULL;</a>
<a name="ln402">			if (message-&gt;HasBool(&quot;path&quot;)) {</a>
<a name="ln403">				new_path(fDocument-&gt;Icon()-&gt;Paths(), &amp;path, &amp;pathCommand);</a>
<a name="ln404">			}</a>
<a name="ln405">		</a>
<a name="ln406">			if (!style) {</a>
<a name="ln407">				// use current or first style</a>
<a name="ln408">				int32 currentStyle = fStyleListView-&gt;CurrentSelection(0);</a>
<a name="ln409">				style = fDocument-&gt;Icon()-&gt;Styles()-&gt;StyleAt(currentStyle);</a>
<a name="ln410">				if (!style)</a>
<a name="ln411">					style = fDocument-&gt;Icon()-&gt;Styles()-&gt;StyleAt(0);</a>
<a name="ln412">			}</a>
<a name="ln413">		</a>
<a name="ln414">			Shape* shape = new (nothrow) Shape(style);</a>
<a name="ln415">			Shape* shapes[1];</a>
<a name="ln416">			shapes[0] = shape;</a>
<a name="ln417">			AddShapesCommand* shapeCommand = new (nothrow) AddShapesCommand(</a>
<a name="ln418">				fDocument-&gt;Icon()-&gt;Shapes(), shapes, 1,</a>
<a name="ln419">				fDocument-&gt;Icon()-&gt;Shapes()-&gt;CountShapes(),</a>
<a name="ln420">				fDocument-&gt;Selection());</a>
<a name="ln421">		</a>
<a name="ln422">			if (path &amp;&amp; shape)</a>
<a name="ln423">				shape-&gt;Paths()-&gt;AddPath(path);</a>
<a name="ln424">		</a>
<a name="ln425">			::Command* command = NULL;</a>
<a name="ln426">			if (styleCommand || pathCommand) {</a>
<a name="ln427">				if (styleCommand &amp;&amp; pathCommand) {</a>
<a name="ln428">					Command** commands = new Command*[3];</a>
<a name="ln429">					commands[0] = styleCommand;</a>
<a name="ln430">					commands[1] = pathCommand;</a>
<a name="ln431">					commands[2] = shapeCommand;</a>
<a name="ln432">					command = new CompoundCommand(commands, 3,</a>
<a name="ln433">						B_TRANSLATE_CONTEXT(&quot;Add shape with path &amp; style&quot;,</a>
<a name="ln434">							&quot;Icon-O-Matic-Menu-Shape&quot;),</a>
<a name="ln435">						0);</a>
<a name="ln436">				} else if (styleCommand) {</a>
<a name="ln437">					Command** commands = new Command*[2];</a>
<a name="ln438">					commands[0] = styleCommand;</a>
<a name="ln439">					commands[1] = shapeCommand;</a>
<a name="ln440">					command = new CompoundCommand(commands, 2,</a>
<a name="ln441">						B_TRANSLATE_CONTEXT(&quot;Add shape with style&quot;,</a>
<a name="ln442">							&quot;Icon-O-Matic-Menu-Shape&quot;), </a>
<a name="ln443">						0);</a>
<a name="ln444">				} else {</a>
<a name="ln445">					Command** commands = new Command*[2];</a>
<a name="ln446">					commands[0] = pathCommand;</a>
<a name="ln447">					commands[1] = shapeCommand;</a>
<a name="ln448">					command = new CompoundCommand(commands, 2,</a>
<a name="ln449">						B_TRANSLATE_CONTEXT(&quot;Add shape with path&quot;,</a>
<a name="ln450">							&quot;Icon-O-Matic-Menu-Shape&quot;), </a>
<a name="ln451">						0);</a>
<a name="ln452">				}</a>
<a name="ln453">			} else {</a>
<a name="ln454">				command = shapeCommand;</a>
<a name="ln455">			}</a>
<a name="ln456">			fDocument-&gt;CommandStack()-&gt;Perform(command);</a>
<a name="ln457">			break;</a>
<a name="ln458">		}</a>
<a name="ln459"> </a>
<a name="ln460">// TODO: listen to selection in CanvasView to add a manipulator</a>
<a name="ln461">case MSG_PATH_SELECTED: {</a>
<a name="ln462">	VectorPath* path;</a>
<a name="ln463">	if (message-&gt;FindPointer(&quot;path&quot;, (void**)&amp;path) &lt; B_OK)</a>
<a name="ln464">		path = NULL;</a>
<a name="ln465"> </a>
<a name="ln466">	fPathListView-&gt;SetCurrentShape(NULL);</a>
<a name="ln467">	fStyleListView-&gt;SetCurrentShape(NULL);</a>
<a name="ln468">	fTransformerListView-&gt;SetShape(NULL);</a>
<a name="ln469">	</a>
<a name="ln470">	fState-&gt;DeleteManipulators();</a>
<a name="ln471">	if (fDocument-&gt;Icon()-&gt;Paths()-&gt;HasPath(path)) {</a>
<a name="ln472">		PathManipulator* pathManipulator = new (nothrow) PathManipulator(path);</a>
<a name="ln473">		fState-&gt;AddManipulator(pathManipulator);</a>
<a name="ln474">	}</a>
<a name="ln475">	break;</a>
<a name="ln476">}</a>
<a name="ln477">case MSG_STYLE_SELECTED:</a>
<a name="ln478">case MSG_STYLE_TYPE_CHANGED: {</a>
<a name="ln479">	Style* style;</a>
<a name="ln480">	if (message-&gt;FindPointer(&quot;style&quot;, (void**)&amp;style) &lt; B_OK)</a>
<a name="ln481">		style = NULL;</a>
<a name="ln482">	if (!fDocument-&gt;Icon()-&gt;Styles()-&gt;HasStyle(style))</a>
<a name="ln483">		style = NULL;</a>
<a name="ln484"> </a>
<a name="ln485">	fStyleView-&gt;SetStyle(style);</a>
<a name="ln486">	fPathListView-&gt;SetCurrentShape(NULL);</a>
<a name="ln487">	fStyleListView-&gt;SetCurrentShape(NULL);</a>
<a name="ln488">	fTransformerListView-&gt;SetShape(NULL);</a>
<a name="ln489"> </a>
<a name="ln490">	fState-&gt;DeleteManipulators();</a>
<a name="ln491">	Gradient* gradient = style ? style-&gt;Gradient() : NULL;</a>
<a name="ln492">	if (gradient != NULL) {</a>
<a name="ln493">		TransformGradientBox* transformBox</a>
<a name="ln494">			= new (nothrow) TransformGradientBox(fCanvasView, gradient, NULL);</a>
<a name="ln495">		fState-&gt;AddManipulator(transformBox);</a>
<a name="ln496">	}</a>
<a name="ln497">	break;</a>
<a name="ln498">}</a>
<a name="ln499">case MSG_SHAPE_SELECTED: {</a>
<a name="ln500">	Shape* shape;</a>
<a name="ln501">	if (message-&gt;FindPointer(&quot;shape&quot;, (void**)&amp;shape) &lt; B_OK)</a>
<a name="ln502">		shape = NULL;</a>
<a name="ln503">	if (!fIcon || !fIcon-&gt;Shapes()-&gt;HasShape(shape))</a>
<a name="ln504">		shape = NULL;</a>
<a name="ln505"> </a>
<a name="ln506">	fPathListView-&gt;SetCurrentShape(shape);</a>
<a name="ln507">	fStyleListView-&gt;SetCurrentShape(shape);</a>
<a name="ln508">	fTransformerListView-&gt;SetShape(shape);</a>
<a name="ln509"> </a>
<a name="ln510">	BList selectedShapes;</a>
<a name="ln511">	ShapeContainer* shapes = fDocument-&gt;Icon()-&gt;Shapes();</a>
<a name="ln512">	int32 count = shapes-&gt;CountShapes();</a>
<a name="ln513">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln514">		shape = shapes-&gt;ShapeAtFast(i);</a>
<a name="ln515">		if (shape-&gt;IsSelected()) {</a>
<a name="ln516">			selectedShapes.AddItem((void*)shape);</a>
<a name="ln517">		}</a>
<a name="ln518">	}</a>
<a name="ln519"> </a>
<a name="ln520">	fState-&gt;DeleteManipulators();</a>
<a name="ln521">	if (selectedShapes.CountItems() &gt; 0) {</a>
<a name="ln522">		TransformShapesBox* transformBox = new (nothrow) TransformShapesBox(</a>
<a name="ln523">			fCanvasView,</a>
<a name="ln524">			(const Shape**)selectedShapes.Items(),</a>
<a name="ln525">			selectedShapes.CountItems());</a>
<a name="ln526">		fState-&gt;AddManipulator(transformBox);</a>
<a name="ln527">	}</a>
<a name="ln528">	break;</a>
<a name="ln529">}</a>
<a name="ln530">		case MSG_RENAME_OBJECT:</a>
<a name="ln531">			fPropertyListView-&gt;FocusNameProperty();</a>
<a name="ln532">			break;</a>
<a name="ln533"> </a>
<a name="ln534">		default:</a>
<a name="ln535">			BWindow::MessageReceived(message);</a>
<a name="ln536">	}</a>
<a name="ln537"> </a>
<a name="ln538">	if (requiresWriteLock)</a>
<a name="ln539">		fDocument-&gt;WriteUnlock();</a>
<a name="ln540">}</a>
<a name="ln541"> </a>
<a name="ln542"> </a>
<a name="ln543">bool</a>
<a name="ln544">MainWindow::QuitRequested()</a>
<a name="ln545">{</a>
<a name="ln546">	if (!_CheckSaveIcon(CurrentMessage()))</a>
<a name="ln547">		return false;</a>
<a name="ln548"> </a>
<a name="ln549">	BMessage message(MSG_WINDOW_CLOSED);</a>
<a name="ln550"> </a>
<a name="ln551">	BMessage settings;</a>
<a name="ln552">	StoreSettings(&amp;settings);	</a>
<a name="ln553">	message.AddMessage(&quot;settings&quot;, &amp;settings);</a>
<a name="ln554">	message.AddRect(&quot;window frame&quot;, Frame());</a>
<a name="ln555"> </a>
<a name="ln556">	be_app-&gt;PostMessage(&amp;message);</a>
<a name="ln557"> </a>
<a name="ln558">	return true;</a>
<a name="ln559">}</a>
<a name="ln560"> </a>
<a name="ln561"> </a>
<a name="ln562">void</a>
<a name="ln563">MainWindow::WorkspaceActivated(int32 workspace, bool active)</a>
<a name="ln564">{</a>
<a name="ln565">	BWindow::WorkspaceActivated(workspace, active);</a>
<a name="ln566"> </a>
<a name="ln567">	// NOTE: hack to workaround buggy BScreen::DesktopColor() on R5</a>
<a name="ln568"> </a>
<a name="ln569">	uint32 workspaces = Workspaces();</a>
<a name="ln570">	if (!active || ((1 &lt;&lt; workspace) &amp; workspaces) == 0)</a>
<a name="ln571">		return;</a>
<a name="ln572"> </a>
<a name="ln573">	WorkspacesChanged(workspaces, workspaces);</a>
<a name="ln574">}</a>
<a name="ln575"> </a>
<a name="ln576"> </a>
<a name="ln577">void</a>
<a name="ln578">MainWindow::WorkspacesChanged(uint32 oldWorkspaces, uint32 newWorkspaces)</a>
<a name="ln579">{</a>
<a name="ln580">	if (oldWorkspaces != newWorkspaces)</a>
<a name="ln581">		BWindow::WorkspacesChanged(oldWorkspaces, newWorkspaces);</a>
<a name="ln582"> </a>
<a name="ln583">	BScreen screen(this);</a>
<a name="ln584"> </a>
<a name="ln585">	// Unfortunately, this is buggy on R5: screen.DesktopColor()</a>
<a name="ln586">	// as well as ui_color(B_DESKTOP_COLOR) return the color</a>
<a name="ln587">	// of the *active* screen, not the one on which this window</a>
<a name="ln588">	// is. So this trick only works when you drag this window</a>
<a name="ln589">	// from another workspace onto the current workspace, not</a>
<a name="ln590">	// when you drag the window from the current workspace onto</a>
<a name="ln591">	// another workspace and then switch to the other workspace.</a>
<a name="ln592"> </a>
<a name="ln593">	fIconPreview32Desktop-&gt;SetIconBGColor(screen.DesktopColor());</a>
<a name="ln594">	fIconPreview64-&gt;SetIconBGColor(screen.DesktopColor());</a>
<a name="ln595">}</a>
<a name="ln596"> </a>
<a name="ln597"> </a>
<a name="ln598">// #pragma mark -</a>
<a name="ln599"> </a>
<a name="ln600"> </a>
<a name="ln601">void</a>
<a name="ln602">MainWindow::ObjectChanged(const Observable* object)</a>
<a name="ln603">{</a>
<a name="ln604">	if (!fDocument || !fDocument-&gt;ReadLock())</a>
<a name="ln605">		return;</a>
<a name="ln606"> </a>
<a name="ln607">	if (object == fDocument-&gt;CommandStack())</a>
<a name="ln608">		PostMessage(MSG_UNDO_STACK_CHANGED);</a>
<a name="ln609"> </a>
<a name="ln610">	fDocument-&gt;ReadUnlock();</a>
<a name="ln611">}</a>
<a name="ln612"> </a>
<a name="ln613"> </a>
<a name="ln614">// #pragma mark -</a>
<a name="ln615"> </a>
<a name="ln616"> </a>
<a name="ln617">void</a>
<a name="ln618">MainWindow::MakeEmpty()</a>
<a name="ln619">{</a>
<a name="ln620">	fPathListView-&gt;SetCurrentShape(NULL);</a>
<a name="ln621">	fStyleListView-&gt;SetCurrentShape(NULL);</a>
<a name="ln622">	fStyleView-&gt;SetStyle(NULL);</a>
<a name="ln623"> </a>
<a name="ln624">	fTransformerListView-&gt;SetShape(NULL);</a>
<a name="ln625"> </a>
<a name="ln626">	fState-&gt;DeleteManipulators();</a>
<a name="ln627">}</a>
<a name="ln628"> </a>
<a name="ln629"> </a>
<a name="ln630">void</a>
<a name="ln631">MainWindow::Open(const entry_ref&amp; ref, bool append)</a>
<a name="ln632">{</a>
<a name="ln633">	BFile file(&amp;ref, B_READ_ONLY);</a>
<a name="ln634">	if (file.InitCheck() &lt; B_OK)</a>
<a name="ln635">		return;</a>
<a name="ln636"> </a>
<a name="ln637">	Icon* icon;</a>
<a name="ln638">	if (append)</a>
<a name="ln639">		icon = new (nothrow) Icon(*fDocument-&gt;Icon());</a>
<a name="ln640">	else</a>
<a name="ln641">		icon = new (nothrow) Icon();</a>
<a name="ln642"> </a>
<a name="ln643">	if (icon == NULL) {</a>
<a name="ln644">		// TODO: Report error to user.</a>
<a name="ln645">		return;</a>
<a name="ln646">	}</a>
<a name="ln647"> </a>
<a name="ln648">	enum {</a>
<a name="ln649">		REF_NONE = 0,</a>
<a name="ln650">		REF_MESSAGE,</a>
<a name="ln651">		REF_FLAT,</a>
<a name="ln652">		REF_FLAT_ATTR,</a>
<a name="ln653">		REF_SVG</a>
<a name="ln654">	};</a>
<a name="ln655">	uint32 refMode = REF_NONE;</a>
<a name="ln656"> </a>
<a name="ln657">	// try different file types</a>
<a name="ln658">	FlatIconImporter flatImporter;</a>
<a name="ln659">	status_t ret = flatImporter.Import(icon, &amp;file);</a>
<a name="ln660">	if (ret &gt;= B_OK) {</a>
<a name="ln661">		refMode = REF_FLAT;</a>
<a name="ln662">	} else {</a>
<a name="ln663">		file.Seek(0, SEEK_SET);</a>
<a name="ln664">		MessageImporter msgImporter;</a>
<a name="ln665">		ret = msgImporter.Import(icon, &amp;file);</a>
<a name="ln666">		if (ret &gt;= B_OK) {</a>
<a name="ln667">			refMode = REF_MESSAGE;</a>
<a name="ln668">		} else {</a>
<a name="ln669">			file.Seek(0, SEEK_SET);</a>
<a name="ln670">			SVGImporter svgImporter;</a>
<a name="ln671">			ret = svgImporter.Import(icon, &amp;ref);</a>
<a name="ln672">			if (ret &gt;= B_OK) {</a>
<a name="ln673">				refMode = REF_SVG;</a>
<a name="ln674">			} else {</a>
<a name="ln675">				// fall back to flat icon format but use the icon attribute</a>
<a name="ln676">				ret = B_OK;</a>
<a name="ln677">				attr_info attrInfo;</a>
<a name="ln678">				if (file.GetAttrInfo(kVectorAttrNodeName, &amp;attrInfo) == B_OK) {</a>
<a name="ln679">					if (attrInfo.type != B_VECTOR_ICON_TYPE)</a>
<a name="ln680">						ret = B_ERROR;</a>
<a name="ln681">					// If the attribute is there, we must succeed in reading</a>
<a name="ln682">					// an icon! Otherwise we may overwrite an existing icon</a>
<a name="ln683">					// when the user saves.</a>
<a name="ln684">					uint8* buffer = NULL;</a>
<a name="ln685">					if (ret == B_OK) {</a>
<a name="ln686">						buffer = new(nothrow) uint8[attrInfo.size];</a>
<a name="ln687">						if (buffer == NULL)</a>
<a name="ln688">							ret = B_NO_MEMORY;</a>
<a name="ln689">					}</a>
<a name="ln690">					if (ret == B_OK) {</a>
<a name="ln691">						ssize_t bytesRead = file.ReadAttr(kVectorAttrNodeName,</a>
<a name="ln692">							B_VECTOR_ICON_TYPE, 0, buffer, attrInfo.size);</a>
<a name="ln693">						if (bytesRead != (ssize_t)attrInfo.size) {</a>
<a name="ln694">							ret = bytesRead &lt; 0 ? (status_t)bytesRead</a>
<a name="ln695">								: B_IO_ERROR;</a>
<a name="ln696">						}</a>
<a name="ln697">					}</a>
<a name="ln698">					if (ret == B_OK) {</a>
<a name="ln699">						ret = flatImporter.Import(icon, buffer, attrInfo.size);</a>
<a name="ln700">						if (ret == B_OK)</a>
<a name="ln701">							refMode = REF_FLAT_ATTR;</a>
<a name="ln702">					}</a>
<a name="ln703"> </a>
<a name="ln704">					delete[] buffer;</a>
<a name="ln705">				} else {</a>
<a name="ln706">					// If there is no icon attribute, simply fall back</a>
<a name="ln707">					// to creating an icon for this file. TODO: We may or may</a>
<a name="ln708">					// not want to display an alert asking the user if that is</a>
<a name="ln709">					// what he wants to do.</a>
<a name="ln710">					refMode = REF_FLAT_ATTR;</a>
<a name="ln711">				}</a>
<a name="ln712">			}</a>
<a name="ln713">		}</a>
<a name="ln714">	}</a>
<a name="ln715"> </a>
<a name="ln716">	if (ret &lt; B_OK) {</a>
<a name="ln717">		// inform user of failure at this point</a>
<a name="ln718">		BString helper(B_TRANSLATE(&quot;Opening the document failed!&quot;));</a>
<a name="ln719">		helper &lt;&lt; &quot;\n\n&quot; &lt;&lt; B_TRANSLATE(&quot;Error: &quot;) &lt;&lt; strerror(ret);</a>
<a name="ln720">		BAlert* alert = new BAlert(</a>
<a name="ln721">			B_TRANSLATE_CONTEXT(&quot;bad news&quot;, &quot;Title of error alert&quot;),</a>
<a name="ln722">			helper.String(), </a>
<a name="ln723">			B_TRANSLATE_CONTEXT(&quot;Bummer&quot;, </a>
<a name="ln724">				&quot;Cancel button - error alert&quot;),	</a>
<a name="ln725">			NULL, NULL);</a>
<a name="ln726">		// launch alert asynchronously</a>
<a name="ln727">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln728">		alert-&gt;Go(NULL);</a>
<a name="ln729"> </a>
<a name="ln730">		delete icon;</a>
<a name="ln731">		return;</a>
<a name="ln732">	}</a>
<a name="ln733"> </a>
<a name="ln734">	AutoWriteLocker locker(fDocument);</a>
<a name="ln735"> </a>
<a name="ln736">	// incorporate the loaded icon into the document</a>
<a name="ln737">	// (either replace it or append to it)</a>
<a name="ln738">	fDocument-&gt;MakeEmpty(!append);</a>
<a name="ln739">		// if append, the document savers are preserved</a>
<a name="ln740">	fDocument-&gt;SetIcon(icon);</a>
<a name="ln741">	if (!append) {</a>
<a name="ln742">		// document got replaced, but we have at</a>
<a name="ln743">		// least one ref already</a>
<a name="ln744">		switch (refMode) {</a>
<a name="ln745">			case REF_MESSAGE:</a>
<a name="ln746">				fDocument-&gt;SetNativeSaver(new NativeSaver(ref));</a>
<a name="ln747">				break;</a>
<a name="ln748">			case REF_FLAT:</a>
<a name="ln749">				fDocument-&gt;SetExportSaver(</a>
<a name="ln750">					new SimpleFileSaver(new FlatIconExporter(), ref));</a>
<a name="ln751">				break;</a>
<a name="ln752">			case REF_FLAT_ATTR:</a>
<a name="ln753">				fDocument-&gt;SetNativeSaver(</a>
<a name="ln754">					new AttributeSaver(ref, kVectorAttrNodeName));</a>
<a name="ln755">				break;</a>
<a name="ln756">			case REF_SVG:</a>
<a name="ln757">				fDocument-&gt;SetExportSaver(</a>
<a name="ln758">					new SimpleFileSaver(new SVGExporter(), ref));</a>
<a name="ln759">				break;</a>
<a name="ln760">		}</a>
<a name="ln761">	}</a>
<a name="ln762"> </a>
<a name="ln763">	locker.Unlock();</a>
<a name="ln764"> </a>
<a name="ln765">	SetIcon(icon);</a>
<a name="ln766"> </a>
<a name="ln767">	_UpdateWindowTitle();</a>
<a name="ln768">}</a>
<a name="ln769"> </a>
<a name="ln770"> </a>
<a name="ln771">void</a>
<a name="ln772">MainWindow::Open(const BMessenger&amp; externalObserver, const uint8* data,</a>
<a name="ln773">	size_t size)</a>
<a name="ln774">{</a>
<a name="ln775">	if (!_CheckSaveIcon(CurrentMessage()))</a>
<a name="ln776">		return;</a>
<a name="ln777"> </a>
<a name="ln778">	if (!externalObserver.IsValid())</a>
<a name="ln779">		return;</a>
<a name="ln780"> </a>
<a name="ln781">	Icon* icon = new (nothrow) Icon();</a>
<a name="ln782">	if (!icon)</a>
<a name="ln783">		return;</a>
<a name="ln784"> </a>
<a name="ln785">	if (data &amp;&amp; size &gt; 0) {</a>
<a name="ln786">		// try to open the icon from the provided data</a>
<a name="ln787">		FlatIconImporter flatImporter;</a>
<a name="ln788">		status_t ret = flatImporter.Import(icon, const_cast&lt;uint8*&gt;(data),</a>
<a name="ln789">			size);</a>
<a name="ln790">			// NOTE: the const_cast is a bit ugly, but no harm is done</a>
<a name="ln791">			// the reason is that the LittleEndianBuffer knows read and write</a>
<a name="ln792">			// mode, in this case it is used read-only, and it does not assume</a>
<a name="ln793">			// ownership of the buffer</a>
<a name="ln794"> </a>
<a name="ln795">		if (ret &lt; B_OK) {</a>
<a name="ln796">			// inform user of failure at this point</a>
<a name="ln797">			BString helper(B_TRANSLATE(&quot;Opening the icon failed!&quot;));</a>
<a name="ln798">			helper &lt;&lt; &quot;\n\n&quot; &lt;&lt; B_TRANSLATE(&quot;Error: &quot;) &lt;&lt; strerror(ret);</a>
<a name="ln799">			BAlert* alert = new BAlert(</a>
<a name="ln800">				B_TRANSLATE_CONTEXT(&quot;bad news&quot;, &quot;Title of error alert&quot;),</a>
<a name="ln801">				helper.String(), </a>
<a name="ln802">				B_TRANSLATE_CONTEXT(&quot;Bummer&quot;, </a>
<a name="ln803">					&quot;Cancel button - error alert&quot;),	</a>
<a name="ln804">				NULL, NULL);</a>
<a name="ln805">			// launch alert asynchronously</a>
<a name="ln806">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln807">			alert-&gt;Go(NULL);</a>
<a name="ln808"> </a>
<a name="ln809">			delete icon;</a>
<a name="ln810">			return;</a>
<a name="ln811">		}</a>
<a name="ln812">	}</a>
<a name="ln813"> </a>
<a name="ln814">	AutoWriteLocker locker(fDocument);</a>
<a name="ln815"> </a>
<a name="ln816">	SetIcon(NULL);</a>
<a name="ln817"> </a>
<a name="ln818">	// incorporate the loaded icon into the document</a>
<a name="ln819">	// (either replace it or append to it)</a>
<a name="ln820">	fDocument-&gt;MakeEmpty();</a>
<a name="ln821">	fDocument-&gt;SetIcon(icon);</a>
<a name="ln822"> </a>
<a name="ln823">	fDocument-&gt;SetNativeSaver(new MessengerSaver(externalObserver));</a>
<a name="ln824"> </a>
<a name="ln825">	locker.Unlock();</a>
<a name="ln826"> </a>
<a name="ln827">	SetIcon(icon);</a>
<a name="ln828">}</a>
<a name="ln829"> </a>
<a name="ln830"> </a>
<a name="ln831">void</a>
<a name="ln832">MainWindow::SetIcon(Icon* icon)</a>
<a name="ln833">{</a>
<a name="ln834">	if (fIcon == icon)</a>
<a name="ln835">		return;</a>
<a name="ln836"> </a>
<a name="ln837">	Icon* oldIcon = fIcon;</a>
<a name="ln838"> </a>
<a name="ln839">	fIcon = icon;</a>
<a name="ln840"> </a>
<a name="ln841">	if (fIcon != NULL)</a>
<a name="ln842">		fIcon-&gt;AcquireReference();</a>
<a name="ln843">	else</a>
<a name="ln844">		MakeEmpty();</a>
<a name="ln845"> </a>
<a name="ln846">	fCanvasView-&gt;SetIcon(fIcon);</a>
<a name="ln847"> </a>
<a name="ln848">	fPathListView-&gt;SetPathContainer(fIcon != NULL ? fIcon-&gt;Paths() : NULL);</a>
<a name="ln849">	fPathListView-&gt;SetShapeContainer(fIcon != NULL ? fIcon-&gt;Shapes() : NULL);</a>
<a name="ln850"> </a>
<a name="ln851">	fStyleListView-&gt;SetStyleContainer(fIcon != NULL ? fIcon-&gt;Styles() : NULL);</a>
<a name="ln852">	fStyleListView-&gt;SetShapeContainer(fIcon != NULL ? fIcon-&gt;Shapes() : NULL);</a>
<a name="ln853"> </a>
<a name="ln854">	fShapeListView-&gt;SetShapeContainer(fIcon != NULL ? fIcon-&gt;Shapes() : NULL);</a>
<a name="ln855">	fShapeListView-&gt;SetStyleContainer(fIcon != NULL ? fIcon-&gt;Styles() : NULL);</a>
<a name="ln856">	fShapeListView-&gt;SetPathContainer(fIcon != NULL ? fIcon-&gt;Paths() : NULL);</a>
<a name="ln857"> </a>
<a name="ln858">	// icon previews</a>
<a name="ln859">	fIconPreview16Folder-&gt;SetIcon(fIcon);</a>
<a name="ln860">	fIconPreview16Menu-&gt;SetIcon(fIcon);</a>
<a name="ln861">	fIconPreview32Folder-&gt;SetIcon(fIcon);</a>
<a name="ln862">	fIconPreview32Desktop-&gt;SetIcon(fIcon);</a>
<a name="ln863">//	fIconPreview48-&gt;SetIcon(fIcon);</a>
<a name="ln864">	fIconPreview64-&gt;SetIcon(fIcon);</a>
<a name="ln865"> </a>
<a name="ln866">	// keep this last</a>
<a name="ln867">	if (oldIcon != NULL)</a>
<a name="ln868">		oldIcon-&gt;ReleaseReference();</a>
<a name="ln869">}</a>
<a name="ln870"> </a>
<a name="ln871"> </a>
<a name="ln872">// #pragma mark -</a>
<a name="ln873"> </a>
<a name="ln874"> </a>
<a name="ln875">void</a>
<a name="ln876">MainWindow::StoreSettings(BMessage* archive)</a>
<a name="ln877">{</a>
<a name="ln878">	if (archive-&gt;ReplaceUInt32(&quot;mouse filter mode&quot;,</a>
<a name="ln879">			fCanvasView-&gt;MouseFilterMode()) != B_OK) {</a>
<a name="ln880">		archive-&gt;AddUInt32(&quot;mouse filter mode&quot;,</a>
<a name="ln881">			fCanvasView-&gt;MouseFilterMode());</a>
<a name="ln882">	}</a>
<a name="ln883">}</a>
<a name="ln884"> </a>
<a name="ln885"> </a>
<a name="ln886">void</a>
<a name="ln887">MainWindow::RestoreSettings(const BMessage* archive)</a>
<a name="ln888">{</a>
<a name="ln889">	uint32 mouseFilterMode;</a>
<a name="ln890">	if (archive-&gt;FindUInt32(&quot;mouse filter mode&quot;, &amp;mouseFilterMode) == B_OK) {</a>
<a name="ln891">		fCanvasView-&gt;SetMouseFilterMode(mouseFilterMode);</a>
<a name="ln892">		fMouseFilterOffMI-&gt;SetMarked(mouseFilterMode == SNAPPING_OFF);</a>
<a name="ln893">		fMouseFilter64MI-&gt;SetMarked(mouseFilterMode == SNAPPING_64);</a>
<a name="ln894">		fMouseFilter32MI-&gt;SetMarked(mouseFilterMode == SNAPPING_32);</a>
<a name="ln895">		fMouseFilter16MI-&gt;SetMarked(mouseFilterMode == SNAPPING_16);</a>
<a name="ln896">	}</a>
<a name="ln897">}</a>
<a name="ln898"> </a>
<a name="ln899"> </a>
<a name="ln900">// #pragma mark -</a>
<a name="ln901"> </a>
<a name="ln902"> </a>
<a name="ln903">void</a>
<a name="ln904">MainWindow::_Init()</a>
<a name="ln905">{</a>
<a name="ln906">	// create the GUI</a>
<a name="ln907">	_CreateGUI();</a>
<a name="ln908"> </a>
<a name="ln909">	// fix up scrollbar layout in listviews</a>
<a name="ln910">	_ImproveScrollBarLayout(fPathListView);</a>
<a name="ln911">	_ImproveScrollBarLayout(fStyleListView);</a>
<a name="ln912">	_ImproveScrollBarLayout(fShapeListView);</a>
<a name="ln913">	_ImproveScrollBarLayout(fTransformerListView);</a>
<a name="ln914"> </a>
<a name="ln915">	// TODO: move this to CanvasView?</a>
<a name="ln916">	fState = new MultipleManipulatorState(fCanvasView);</a>
<a name="ln917">	fCanvasView-&gt;SetState(fState);</a>
<a name="ln918"> </a>
<a name="ln919">	fCanvasView-&gt;SetCatchAllEvents(true);</a>
<a name="ln920">	fCanvasView-&gt;SetCommandStack(fDocument-&gt;CommandStack());</a>
<a name="ln921">	fCanvasView-&gt;SetMouseFilterMode(SNAPPING_64);</a>
<a name="ln922">	fMouseFilter64MI-&gt;SetMarked(true);</a>
<a name="ln923">//	fCanvasView-&gt;SetSelection(fDocument-&gt;Selection());</a>
<a name="ln924"> </a>
<a name="ln925">	fPathListView-&gt;SetMenu(fPathMenu);</a>
<a name="ln926">	fPathListView-&gt;SetCommandStack(fDocument-&gt;CommandStack());</a>
<a name="ln927">	fPathListView-&gt;SetSelection(fDocument-&gt;Selection());</a>
<a name="ln928"> </a>
<a name="ln929">	fStyleListView-&gt;SetMenu(fStyleMenu);</a>
<a name="ln930">	fStyleListView-&gt;SetCommandStack(fDocument-&gt;CommandStack());</a>
<a name="ln931">	fStyleListView-&gt;SetSelection(fDocument-&gt;Selection());</a>
<a name="ln932">	fStyleListView-&gt;SetCurrentColor(fCurrentColor);</a>
<a name="ln933"> </a>
<a name="ln934">	fStyleView-&gt;SetCommandStack(fDocument-&gt;CommandStack());</a>
<a name="ln935">	fStyleView-&gt;SetCurrentColor(fCurrentColor);</a>
<a name="ln936"> </a>
<a name="ln937">	fShapeListView-&gt;SetMenu(fShapeMenu);</a>
<a name="ln938">	fShapeListView-&gt;SetCommandStack(fDocument-&gt;CommandStack());</a>
<a name="ln939">	fShapeListView-&gt;SetSelection(fDocument-&gt;Selection());</a>
<a name="ln940"> </a>
<a name="ln941">	fTransformerListView-&gt;SetMenu(fTransformerMenu);</a>
<a name="ln942">	fTransformerListView-&gt;SetCommandStack(fDocument-&gt;CommandStack());</a>
<a name="ln943">	fTransformerListView-&gt;SetSelection(fDocument-&gt;Selection());</a>
<a name="ln944"> </a>
<a name="ln945">	fPropertyListView-&gt;SetCommandStack(fDocument-&gt;CommandStack());</a>
<a name="ln946">	fPropertyListView-&gt;SetSelection(fDocument-&gt;Selection());</a>
<a name="ln947">	fPropertyListView-&gt;SetMenu(fPropertyMenu);</a>
<a name="ln948"> </a>
<a name="ln949">	fDocument-&gt;CommandStack()-&gt;AddObserver(this);</a>
<a name="ln950"> </a>
<a name="ln951">	fSwatchGroup-&gt;SetCurrentColor(fCurrentColor);</a>
<a name="ln952"> </a>
<a name="ln953">	SetIcon(fDocument-&gt;Icon());</a>
<a name="ln954"> </a>
<a name="ln955">	AddShortcut('Y', 0, new BMessage(MSG_UNDO));</a>
<a name="ln956">	AddShortcut('Y', B_SHIFT_KEY, new BMessage(MSG_REDO));</a>
<a name="ln957">	AddShortcut('E', 0, new BMessage(MSG_RENAME_OBJECT));</a>
<a name="ln958">}</a>
<a name="ln959"> </a>
<a name="ln960"> </a>
<a name="ln961">void</a>
<a name="ln962">MainWindow::_CreateGUI()</a>
<a name="ln963">{</a>
<a name="ln964">	SetLayout(new BGroupLayout(B_HORIZONTAL));</a>
<a name="ln965"> </a>
<a name="ln966">	BGridLayout* layout = new BGridLayout();</a>
<a name="ln967">	layout-&gt;SetSpacing(0, 0);</a>
<a name="ln968">	BView* rootView = new BView(&quot;root view&quot;, 0, layout);</a>
<a name="ln969">	AddChild(rootView);</a>
<a name="ln970">	rootView-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln971"> </a>
<a name="ln972">	BGroupView* leftTopView = new BGroupView(B_VERTICAL, 0);</a>
<a name="ln973">	layout-&gt;AddView(leftTopView, 0, 0);</a>
<a name="ln974"> </a>
<a name="ln975">	// views along the left side</a>
<a name="ln976">	leftTopView-&gt;AddChild(_CreateMenuBar());</a>
<a name="ln977"> </a>
<a name="ln978">	float splitWidth = 13 * be_plain_font-&gt;Size();</a>
<a name="ln979">	BSize minSize = leftTopView-&gt;MinSize();</a>
<a name="ln980">	splitWidth = std::max(splitWidth, minSize.width);</a>
<a name="ln981">	leftTopView-&gt;SetExplicitMaxSize(BSize(splitWidth, B_SIZE_UNSET));</a>
<a name="ln982">	leftTopView-&gt;SetExplicitMinSize(BSize(splitWidth, B_SIZE_UNSET));</a>
<a name="ln983"> </a>
<a name="ln984">	BGroupView* iconPreviews = new BGroupView(B_HORIZONTAL);</a>
<a name="ln985">	iconPreviews-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln986">	iconPreviews-&gt;GroupLayout()-&gt;SetSpacing(5);</a>
<a name="ln987"> </a>
<a name="ln988">	// icon previews</a>
<a name="ln989">	fIconPreview16Folder = new IconView(BRect(0, 0, 15, 15),</a>
<a name="ln990">		&quot;icon preview 16 folder&quot;);</a>
<a name="ln991">	fIconPreview16Menu = new IconView(BRect(0, 0, 15, 15),</a>
<a name="ln992">		&quot;icon preview 16 menu&quot;);</a>
<a name="ln993">	fIconPreview16Menu-&gt;SetLowColor(ui_color(B_MENU_BACKGROUND_COLOR));</a>
<a name="ln994"> </a>
<a name="ln995">	fIconPreview32Folder = new IconView(BRect(0, 0, 31, 31),</a>
<a name="ln996">		&quot;icon preview 32 folder&quot;);</a>
<a name="ln997">	fIconPreview32Desktop = new IconView(BRect(0, 0, 31, 31),</a>
<a name="ln998">		&quot;icon preview 32 desktop&quot;);</a>
<a name="ln999">	fIconPreview32Desktop-&gt;SetLowColor(ui_color(B_DESKTOP_COLOR));</a>
<a name="ln1000"> </a>
<a name="ln1001">	fIconPreview64 = new IconView(BRect(0, 0, 63, 63), &quot;icon preview 64&quot;);</a>
<a name="ln1002">	fIconPreview64-&gt;SetLowColor(ui_color(B_DESKTOP_COLOR));</a>
<a name="ln1003"> </a>
<a name="ln1004"> </a>
<a name="ln1005">	BGroupView* smallPreviews = new BGroupView(B_VERTICAL);</a>
<a name="ln1006">	smallPreviews-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln1007">	smallPreviews-&gt;GroupLayout()-&gt;SetSpacing(5);</a>
<a name="ln1008"> </a>
<a name="ln1009">	smallPreviews-&gt;AddChild(fIconPreview16Folder);</a>
<a name="ln1010">	smallPreviews-&gt;AddChild(fIconPreview16Menu);</a>
<a name="ln1011"> </a>
<a name="ln1012">	BGroupView* mediumPreviews = new BGroupView(B_VERTICAL);</a>
<a name="ln1013">	mediumPreviews-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln1014">	mediumPreviews-&gt;GroupLayout()-&gt;SetSpacing(5);</a>
<a name="ln1015"> </a>
<a name="ln1016">	mediumPreviews-&gt;AddChild(fIconPreview32Folder);</a>
<a name="ln1017">	mediumPreviews-&gt;AddChild(fIconPreview32Desktop);</a>
<a name="ln1018"> </a>
<a name="ln1019">//	iconPreviews-&gt;AddChild(fIconPreview48);</a>
<a name="ln1020"> </a>
<a name="ln1021">	iconPreviews-&gt;AddChild(smallPreviews);</a>
<a name="ln1022">	iconPreviews-&gt;AddChild(mediumPreviews);</a>
<a name="ln1023">	iconPreviews-&gt;AddChild(fIconPreview64);</a>
<a name="ln1024">	iconPreviews-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNSET, B_SIZE_UNLIMITED));</a>
<a name="ln1025"> </a>
<a name="ln1026">	leftTopView-&gt;AddChild(iconPreviews);</a>
<a name="ln1027"> </a>
<a name="ln1028">	</a>
<a name="ln1029">	BGroupView* leftSideView = new BGroupView(B_VERTICAL, 0);</a>
<a name="ln1030">	layout-&gt;AddView(leftSideView, 0, 1);</a>
<a name="ln1031">	leftSideView-&gt;SetExplicitMaxSize(BSize(splitWidth, B_SIZE_UNSET));</a>
<a name="ln1032"> </a>
<a name="ln1033">	// path menu and list view</a>
<a name="ln1034">	BMenuBar* menuBar = new BMenuBar(&quot;path menu bar&quot;);</a>
<a name="ln1035">	menuBar-&gt;AddItem(fPathMenu);</a>
<a name="ln1036">	leftSideView-&gt;AddChild(menuBar);</a>
<a name="ln1037"> </a>
<a name="ln1038">	fPathListView = new PathListView(BRect(0, 0, splitWidth, 100),</a>
<a name="ln1039">		&quot;path list view&quot;, new BMessage(MSG_PATH_SELECTED), this);</a>
<a name="ln1040"> </a>
<a name="ln1041">	BView* scrollView = new BScrollView(&quot;path list scroll view&quot;,</a>
<a name="ln1042">		fPathListView, B_FOLLOW_NONE, 0, false, true, B_NO_BORDER);</a>
<a name="ln1043">	leftSideView-&gt;AddChild(scrollView);</a>
<a name="ln1044"> </a>
<a name="ln1045">	// shape list view</a>
<a name="ln1046">	menuBar = new BMenuBar(&quot;shape menu bar&quot;);</a>
<a name="ln1047">	menuBar-&gt;AddItem(fShapeMenu);</a>
<a name="ln1048">	leftSideView-&gt;AddChild(menuBar);</a>
<a name="ln1049"> </a>
<a name="ln1050">	fShapeListView = new ShapeListView(BRect(0, 0, splitWidth, 100),</a>
<a name="ln1051">		&quot;shape list view&quot;, new BMessage(MSG_SHAPE_SELECTED), this);</a>
<a name="ln1052">	scrollView = new BScrollView(&quot;shape list scroll view&quot;,</a>
<a name="ln1053">		fShapeListView, B_FOLLOW_NONE, 0, false, true, B_NO_BORDER);</a>
<a name="ln1054">	leftSideView-&gt;AddChild(scrollView);</a>
<a name="ln1055"> </a>
<a name="ln1056">	// transformer list view</a>
<a name="ln1057">	menuBar = new BMenuBar(&quot;transformer menu bar&quot;);</a>
<a name="ln1058">	menuBar-&gt;AddItem(fTransformerMenu);</a>
<a name="ln1059">	leftSideView-&gt;AddChild(menuBar);</a>
<a name="ln1060"> </a>
<a name="ln1061">	fTransformerListView = new TransformerListView(BRect(0, 0, splitWidth, 100),</a>
<a name="ln1062">		&quot;transformer list view&quot;);</a>
<a name="ln1063">	scrollView = new BScrollView(&quot;transformer list scroll view&quot;,</a>
<a name="ln1064">		fTransformerListView, B_FOLLOW_NONE, 0, false, true, B_NO_BORDER);</a>
<a name="ln1065">	leftSideView-&gt;AddChild(scrollView);</a>
<a name="ln1066"> </a>
<a name="ln1067">	// property list view</a>
<a name="ln1068">	menuBar = new BMenuBar(&quot;property menu bar&quot;);</a>
<a name="ln1069">	menuBar-&gt;AddItem(fPropertyMenu);</a>
<a name="ln1070">	leftSideView-&gt;AddChild(menuBar);</a>
<a name="ln1071"> </a>
<a name="ln1072">	fPropertyListView = new IconObjectListView();</a>
<a name="ln1073"> </a>
<a name="ln1074">	// scroll view around property list view</a>
<a name="ln1075">	ScrollView* propScrollView = new ScrollView(fPropertyListView,</a>
<a name="ln1076">		SCROLL_VERTICAL, BRect(0, 0, splitWidth, 100), &quot;property scroll view&quot;,</a>
<a name="ln1077">		B_FOLLOW_NONE, B_WILL_DRAW | B_FRAME_EVENTS, B_PLAIN_BORDER,</a>
<a name="ln1078">		BORDER_RIGHT);</a>
<a name="ln1079">	leftSideView-&gt;AddChild(propScrollView);</a>
<a name="ln1080"> </a>
<a name="ln1081">	BGroupLayout* topSide = new BGroupLayout(B_HORIZONTAL);</a>
<a name="ln1082">	topSide-&gt;SetSpacing(0);</a>
<a name="ln1083">	BView* topSideView = new BView(&quot;top side view&quot;, 0, topSide);</a>
<a name="ln1084">	layout-&gt;AddView(topSideView, 1, 0);</a>
<a name="ln1085"> </a>
<a name="ln1086">	// canvas view</a>
<a name="ln1087">	BRect canvasBounds = BRect(0, 0, 200, 200);</a>
<a name="ln1088">	fCanvasView = new CanvasView(canvasBounds);</a>
<a name="ln1089"> </a>
<a name="ln1090">	// scroll view around canvas view</a>
<a name="ln1091">	canvasBounds.bottom += B_H_SCROLL_BAR_HEIGHT;</a>
<a name="ln1092">	canvasBounds.right += B_V_SCROLL_BAR_WIDTH;</a>
<a name="ln1093">	ScrollView* canvasScrollView = new ScrollView(fCanvasView, SCROLL_VERTICAL</a>
<a name="ln1094">			| SCROLL_HORIZONTAL | SCROLL_VISIBLE_RECT_IS_CHILD_BOUNDS,</a>
<a name="ln1095">		canvasBounds, &quot;canvas scroll view&quot;, B_FOLLOW_NONE,</a>
<a name="ln1096">		B_WILL_DRAW | B_FRAME_EVENTS, B_NO_BORDER);</a>
<a name="ln1097">	layout-&gt;AddView(canvasScrollView, 1, 1);</a>
<a name="ln1098"> </a>
<a name="ln1099">	// views along the top</a>
<a name="ln1100"> </a>
<a name="ln1101">	BGroupLayout* styleGroup = new BGroupLayout(B_VERTICAL, 0);</a>
<a name="ln1102">	BView* styleGroupView = new BView(&quot;style group&quot;, 0, styleGroup);</a>
<a name="ln1103">	topSide-&gt;AddView(styleGroupView);</a>
<a name="ln1104"> </a>
<a name="ln1105">	// style list view</a>
<a name="ln1106">	menuBar = new BMenuBar(&quot;style menu bar&quot;);</a>
<a name="ln1107">	menuBar-&gt;AddItem(fStyleMenu);</a>
<a name="ln1108">	styleGroup-&gt;AddView(menuBar);</a>
<a name="ln1109"> </a>
<a name="ln1110">	fStyleListView = new StyleListView(BRect(0, 0, splitWidth, 100),</a>
<a name="ln1111">		&quot;style list view&quot;, new BMessage(MSG_STYLE_SELECTED), this);</a>
<a name="ln1112">	scrollView = new BScrollView(&quot;style list scroll view&quot;, fStyleListView,</a>
<a name="ln1113">		B_FOLLOW_NONE, 0, false, true, B_NO_BORDER);</a>
<a name="ln1114">	scrollView-&gt;SetExplicitMaxSize(BSize(splitWidth, B_SIZE_UNLIMITED));</a>
<a name="ln1115">	styleGroup-&gt;AddView(scrollView);</a>
<a name="ln1116"> </a>
<a name="ln1117">	// style view</a>
<a name="ln1118">	fStyleView = new StyleView(BRect(0, 0, 200, 100));</a>
<a name="ln1119">	topSide-&gt;AddView(fStyleView);</a>
<a name="ln1120"> </a>
<a name="ln1121">	// swatch group</a>
<a name="ln1122">	BGroupLayout* swatchGroup = new BGroupLayout(B_VERTICAL);</a>
<a name="ln1123">	swatchGroup-&gt;SetSpacing(0);</a>
<a name="ln1124">	BView* swatchGroupView = new BView(&quot;swatch group&quot;, 0, swatchGroup);</a>
<a name="ln1125">	topSide-&gt;AddView(swatchGroupView);</a>
<a name="ln1126"> </a>
<a name="ln1127">	menuBar = new BMenuBar(&quot;swatches menu bar&quot;);</a>
<a name="ln1128">	menuBar-&gt;AddItem(fSwatchMenu);</a>
<a name="ln1129">	swatchGroup-&gt;AddView(menuBar);</a>
<a name="ln1130"> </a>
<a name="ln1131">	fSwatchGroup = new SwatchGroup(BRect(0, 0, 100, 100));</a>
<a name="ln1132">	swatchGroup-&gt;AddView(fSwatchGroup);</a>
<a name="ln1133"> </a>
<a name="ln1134">	swatchGroupView-&gt;SetExplicitMaxSize(swatchGroupView-&gt;MinSize());</a>
<a name="ln1135"> </a>
<a name="ln1136">	// make sure the top side has fixed height</a>
<a name="ln1137">	topSideView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED,</a>
<a name="ln1138">		swatchGroupView-&gt;MinSize().height));</a>
<a name="ln1139">}</a>
<a name="ln1140"> </a>
<a name="ln1141">BMenuBar*</a>
<a name="ln1142">MainWindow::_CreateMenuBar()</a>
<a name="ln1143">{</a>
<a name="ln1144">	BMenuBar* menuBar = new BMenuBar(&quot;main menu&quot;);</a>
<a name="ln1145"> </a>
<a name="ln1146"> </a>
<a name="ln1147">	#undef B_TRANSLATION_CONTEXT</a>
<a name="ln1148">	#define B_TRANSLATION_CONTEXT &quot;Icon-O-Matic-Menus&quot;</a>
<a name="ln1149">	</a>
<a name="ln1150">	</a>
<a name="ln1151">	BMenu* fileMenu = new BMenu(B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln1152">	BMenu* editMenu = new BMenu(B_TRANSLATE(&quot;Edit&quot;));</a>
<a name="ln1153">	BMenu* settingsMenu = new BMenu(B_TRANSLATE(&quot;Settings&quot;));</a>
<a name="ln1154">	fPathMenu = new BMenu(B_TRANSLATE(&quot;Path&quot;));</a>
<a name="ln1155">	fStyleMenu = new BMenu(B_TRANSLATE(&quot;Style&quot;));</a>
<a name="ln1156">	fShapeMenu = new BMenu(B_TRANSLATE(&quot;Shape&quot;));</a>
<a name="ln1157">	fTransformerMenu = new BMenu(B_TRANSLATE(&quot;Transformer&quot;));</a>
<a name="ln1158">	fPropertyMenu = new BMenu(B_TRANSLATE(&quot;Properties&quot;));</a>
<a name="ln1159">	fSwatchMenu = new BMenu(B_TRANSLATE(&quot;Swatches&quot;));</a>
<a name="ln1160"> </a>
<a name="ln1161">	menuBar-&gt;AddItem(fileMenu);</a>
<a name="ln1162">	menuBar-&gt;AddItem(editMenu);</a>
<a name="ln1163">	menuBar-&gt;AddItem(settingsMenu);</a>
<a name="ln1164"> </a>
<a name="ln1165"> </a>
<a name="ln1166">	// File</a>
<a name="ln1167">	#undef B_TRANSLATION_CONTEXT</a>
<a name="ln1168">	#define B_TRANSLATION_CONTEXT &quot;Icon-O-Matic-Menu-File&quot;</a>
<a name="ln1169">	</a>
<a name="ln1170"> </a>
<a name="ln1171">	BMenuItem* item = new BMenuItem(B_TRANSLATE(&quot;New&quot;),</a>
<a name="ln1172">		new BMessage(MSG_NEW), 'N');</a>
<a name="ln1173">	fileMenu-&gt;AddItem(item);</a>
<a name="ln1174">	item-&gt;SetTarget(be_app);</a>
<a name="ln1175">	item = new BMenuItem(B_TRANSLATE(&quot;Open&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1176">		new BMessage(MSG_OPEN), 'O');</a>
<a name="ln1177">	fileMenu-&gt;AddItem(item);</a>
<a name="ln1178">	BMessage* appendMessage = new BMessage(MSG_APPEND);</a>
<a name="ln1179">	appendMessage-&gt;AddPointer(&quot;window&quot;, this);</a>
<a name="ln1180">	item = new BMenuItem(B_TRANSLATE(&quot;Append&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1181">		appendMessage, 'O', B_SHIFT_KEY);</a>
<a name="ln1182">	fileMenu-&gt;AddItem(item);</a>
<a name="ln1183">	item-&gt;SetTarget(be_app);</a>
<a name="ln1184">	fileMenu-&gt;AddSeparatorItem();</a>
<a name="ln1185">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Save&quot;),</a>
<a name="ln1186">		new BMessage(MSG_SAVE), 'S'));</a>
<a name="ln1187">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Save as&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1188">		new BMessage(MSG_SAVE_AS), 'S', B_SHIFT_KEY));</a>
<a name="ln1189">	fileMenu-&gt;AddSeparatorItem();</a>
<a name="ln1190">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Export&quot;),</a>
<a name="ln1191">		new BMessage(MSG_EXPORT), 'P'));</a>
<a name="ln1192">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Export as&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1193">		new BMessage(MSG_EXPORT_AS), 'P', B_SHIFT_KEY));</a>
<a name="ln1194">	fileMenu-&gt;AddSeparatorItem();</a>
<a name="ln1195">	fileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Close&quot;),</a>
<a name="ln1196">		new BMessage(B_QUIT_REQUESTED), 'W'));</a>
<a name="ln1197">	item = new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln1198">		new BMessage(B_QUIT_REQUESTED), 'Q');</a>
<a name="ln1199">	fileMenu-&gt;AddItem(item);</a>
<a name="ln1200">	item-&gt;SetTarget(be_app);</a>
<a name="ln1201"> </a>
<a name="ln1202">	// Edit</a>
<a name="ln1203">	#undef B_TRANSLATION_CONTEXT</a>
<a name="ln1204">	#define B_TRANSLATION_CONTEXT &quot;Icon-O-Matic-Menu-Edit&quot;</a>
<a name="ln1205">	</a>
<a name="ln1206">	</a>
<a name="ln1207">	fUndoMI = new BMenuItem(B_TRANSLATE(&quot;&lt;nothing to undo&gt;&quot;),</a>
<a name="ln1208">		new BMessage(MSG_UNDO), 'Z');</a>
<a name="ln1209">	fRedoMI = new BMenuItem(B_TRANSLATE(&quot;&lt;nothing to redo&gt;&quot;),</a>
<a name="ln1210">		new BMessage(MSG_REDO), 'Z', B_SHIFT_KEY);</a>
<a name="ln1211"> </a>
<a name="ln1212">	fUndoMI-&gt;SetEnabled(false);</a>
<a name="ln1213">	fRedoMI-&gt;SetEnabled(false);</a>
<a name="ln1214"> </a>
<a name="ln1215">	editMenu-&gt;AddItem(fUndoMI);</a>
<a name="ln1216">	editMenu-&gt;AddItem(fRedoMI);</a>
<a name="ln1217"> </a>
<a name="ln1218"> </a>
<a name="ln1219">	// Settings</a>
<a name="ln1220">	#undef B_TRANSLATION_CONTEXT</a>
<a name="ln1221">	#define B_TRANSLATION_CONTEXT &quot;Icon-O-Matic-Menu-Settings&quot;</a>
<a name="ln1222">	</a>
<a name="ln1223">	</a>
<a name="ln1224">	BMenu* filterModeMenu = new BMenu(B_TRANSLATE(&quot;Snap to grid&quot;));</a>
<a name="ln1225">	BMessage* message = new BMessage(MSG_MOUSE_FILTER_MODE);</a>
<a name="ln1226">	message-&gt;AddInt32(&quot;mode&quot;, SNAPPING_OFF);</a>
<a name="ln1227">	fMouseFilterOffMI = new BMenuItem(B_TRANSLATE(&quot;Off&quot;), message, '4');</a>
<a name="ln1228">	filterModeMenu-&gt;AddItem(fMouseFilterOffMI);</a>
<a name="ln1229"> </a>
<a name="ln1230">	message = new BMessage(MSG_MOUSE_FILTER_MODE);</a>
<a name="ln1231">	message-&gt;AddInt32(&quot;mode&quot;, SNAPPING_64);</a>
<a name="ln1232">	fMouseFilter64MI = new BMenuItem(&quot;64 x 64&quot;, message, '3');</a>
<a name="ln1233">	filterModeMenu-&gt;AddItem(fMouseFilter64MI);</a>
<a name="ln1234"> </a>
<a name="ln1235">	message = new BMessage(MSG_MOUSE_FILTER_MODE);</a>
<a name="ln1236">	message-&gt;AddInt32(&quot;mode&quot;, SNAPPING_32);</a>
<a name="ln1237">	fMouseFilter32MI = new BMenuItem(&quot;32 x 32&quot;, message, '2');</a>
<a name="ln1238">	filterModeMenu-&gt;AddItem(fMouseFilter32MI);</a>
<a name="ln1239"> </a>
<a name="ln1240">	message = new BMessage(MSG_MOUSE_FILTER_MODE);</a>
<a name="ln1241">	message-&gt;AddInt32(&quot;mode&quot;, SNAPPING_16);</a>
<a name="ln1242">	fMouseFilter16MI = new BMenuItem(&quot;16 x 16&quot;, message, '1');</a>
<a name="ln1243">	filterModeMenu-&gt;AddItem(fMouseFilter16MI);</a>
<a name="ln1244"> </a>
<a name="ln1245">	filterModeMenu-&gt;SetRadioMode(true);</a>
<a name="ln1246"> </a>
<a name="ln1247">	settingsMenu-&gt;AddItem(filterModeMenu);</a>
<a name="ln1248"> </a>
<a name="ln1249">	return menuBar;</a>
<a name="ln1250">}</a>
<a name="ln1251"> </a>
<a name="ln1252"> </a>
<a name="ln1253">void</a>
<a name="ln1254">MainWindow::_ImproveScrollBarLayout(BView* target)</a>
<a name="ln1255">{</a>
<a name="ln1256">	// NOTE: The BListViews for which this function is used</a>
<a name="ln1257">	// are directly below a BMenuBar. If the BScrollBar and</a>
<a name="ln1258">	// the BMenuBar share bottom/top border respectively, the</a>
<a name="ln1259">	// GUI looks a little more polished. This trick can be</a>
<a name="ln1260">	// removed if/when the BScrollViews are embedded in a</a>
<a name="ln1261">	// surounding border like in WonderBrush.</a>
<a name="ln1262"> </a>
<a name="ln1263">	if (BScrollBar* scrollBar = target-&gt;ScrollBar(B_VERTICAL)) {</a>
<a name="ln1264">		scrollBar-&gt;MoveBy(0, -1);</a>
<a name="ln1265">		scrollBar-&gt;ResizeBy(0, 1);</a>
<a name="ln1266">	}</a>
<a name="ln1267">}</a>
<a name="ln1268"> </a>
<a name="ln1269"> </a>
<a name="ln1270">// #pragma mark -</a>
<a name="ln1271"> </a>
<a name="ln1272"> </a>
<a name="ln1273">bool</a>
<a name="ln1274">MainWindow::_CheckSaveIcon(const BMessage* currentMessage)</a>
<a name="ln1275">{</a>
<a name="ln1276">	if (fDocument-&gt;IsEmpty() || fDocument-&gt;CommandStack()-&gt;IsSaved())</a>
<a name="ln1277">		return true;</a>
<a name="ln1278"> </a>
<a name="ln1279">	// Make sure the user sees us.</a>
<a name="ln1280">	Activate();</a>
<a name="ln1281"> </a>
<a name="ln1282">	BAlert* alert = new BAlert(&quot;save&quot;, </a>
<a name="ln1283">		B_TRANSLATE(&quot;Save changes to current icon before closing?&quot;),</a>
<a name="ln1284">			B_TRANSLATE(&quot;Cancel&quot;), B_TRANSLATE(&quot;Don't save&quot;),</a>
<a name="ln1285">			B_TRANSLATE(&quot;Save&quot;), B_WIDTH_AS_USUAL,	B_OFFSET_SPACING,</a>
<a name="ln1286">			B_WARNING_ALERT);</a>
<a name="ln1287">	alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln1288">	alert-&gt;SetShortcut(1, 'd');</a>
<a name="ln1289">	alert-&gt;SetShortcut(2, 's');</a>
<a name="ln1290">	int32 choice = alert-&gt;Go();</a>
<a name="ln1291">	switch (choice) {</a>
<a name="ln1292">		case 0:</a>
<a name="ln1293">			// cancel</a>
<a name="ln1294">			return false;</a>
<a name="ln1295">		case 1:</a>
<a name="ln1296">			// don't save</a>
<a name="ln1297">			return true;</a>
<a name="ln1298">		case 2:</a>
<a name="ln1299">		default:</a>
<a name="ln1300">			// cancel (save first) but pick up what we were doing before</a>
<a name="ln1301">			PostMessage(MSG_SAVE);</a>
<a name="ln1302">			if (currentMessage != NULL) {</a>
<a name="ln1303">				delete fMessageAfterSave;</a>
<a name="ln1304">				fMessageAfterSave = new BMessage(*currentMessage);</a>
<a name="ln1305">			}</a>
<a name="ln1306">			return false;</a>
<a name="ln1307">	}</a>
<a name="ln1308">}</a>
<a name="ln1309"> </a>
<a name="ln1310"> </a>
<a name="ln1311">void</a>
<a name="ln1312">MainWindow::_PickUpActionBeforeSave()</a>
<a name="ln1313">{</a>
<a name="ln1314">	if (fDocument-&gt;WriteLock()) {</a>
<a name="ln1315">		fDocument-&gt;CommandStack()-&gt;Save();</a>
<a name="ln1316">		fDocument-&gt;WriteUnlock();</a>
<a name="ln1317">	}</a>
<a name="ln1318"> </a>
<a name="ln1319">	if (fMessageAfterSave == NULL)</a>
<a name="ln1320">		return;</a>
<a name="ln1321"> </a>
<a name="ln1322">	PostMessage(fMessageAfterSave);</a>
<a name="ln1323">	delete fMessageAfterSave;</a>
<a name="ln1324">	fMessageAfterSave = NULL;</a>
<a name="ln1325">}</a>
<a name="ln1326"> </a>
<a name="ln1327"> </a>
<a name="ln1328">// #pragma mark -</a>
<a name="ln1329"> </a>
<a name="ln1330"> </a>
<a name="ln1331">void</a>
<a name="ln1332">MainWindow::_MakeIconEmpty()</a>
<a name="ln1333">{</a>
<a name="ln1334">	if (!_CheckSaveIcon(CurrentMessage()))</a>
<a name="ln1335">		return;</a>
<a name="ln1336"> </a>
<a name="ln1337">	AutoWriteLocker locker(fDocument);</a>
<a name="ln1338"> </a>
<a name="ln1339">	MakeEmpty();</a>
<a name="ln1340">	fDocument-&gt;MakeEmpty();</a>
<a name="ln1341"> </a>
<a name="ln1342">	locker.Unlock();</a>
<a name="ln1343">}</a>
<a name="ln1344"> </a>
<a name="ln1345"> </a>
<a name="ln1346">DocumentSaver*</a>
<a name="ln1347">MainWindow::_CreateSaver(const entry_ref&amp; ref, uint32 exportMode)</a>
<a name="ln1348">{</a>
<a name="ln1349">	DocumentSaver* saver;</a>
<a name="ln1350"> </a>
<a name="ln1351">	switch (exportMode) {</a>
<a name="ln1352">		case EXPORT_MODE_FLAT_ICON:</a>
<a name="ln1353">			saver = new SimpleFileSaver(new FlatIconExporter(), ref);</a>
<a name="ln1354">			break;</a>
<a name="ln1355"> </a>
<a name="ln1356">		case EXPORT_MODE_ICON_ATTR:</a>
<a name="ln1357">		case EXPORT_MODE_ICON_MIME_ATTR: {</a>
<a name="ln1358">			const char* attrName</a>
<a name="ln1359">				= exportMode == EXPORT_MODE_ICON_ATTR ?</a>
<a name="ln1360">					kVectorAttrNodeName : kVectorAttrMimeName;</a>
<a name="ln1361">			saver = new AttributeSaver(ref, attrName);</a>
<a name="ln1362">			break;</a>
<a name="ln1363">		}</a>
<a name="ln1364"> </a>
<a name="ln1365">		case EXPORT_MODE_ICON_RDEF:</a>
<a name="ln1366">			saver = new SimpleFileSaver(new RDefExporter(), ref);</a>
<a name="ln1367">			break;</a>
<a name="ln1368">		case EXPORT_MODE_ICON_SOURCE:</a>
<a name="ln1369">			saver = new SimpleFileSaver(new SourceExporter(), ref);</a>
<a name="ln1370">			break;</a>
<a name="ln1371"> </a>
<a name="ln1372">		case EXPORT_MODE_BITMAP_16:</a>
<a name="ln1373">			saver = new SimpleFileSaver(new BitmapExporter(16), ref);</a>
<a name="ln1374">			break;</a>
<a name="ln1375">		case EXPORT_MODE_BITMAP_32:</a>
<a name="ln1376">			saver = new SimpleFileSaver(new BitmapExporter(32), ref);</a>
<a name="ln1377">			break;</a>
<a name="ln1378">		case EXPORT_MODE_BITMAP_64:</a>
<a name="ln1379">			saver = new SimpleFileSaver(new BitmapExporter(64), ref);</a>
<a name="ln1380">			break;</a>
<a name="ln1381"> </a>
<a name="ln1382">		case EXPORT_MODE_BITMAP_SET:</a>
<a name="ln1383">			saver = new BitmapSetSaver(ref);</a>
<a name="ln1384">			break;</a>
<a name="ln1385"> </a>
<a name="ln1386">		case EXPORT_MODE_SVG:</a>
<a name="ln1387">			saver = new SimpleFileSaver(new SVGExporter(), ref);</a>
<a name="ln1388">			break;</a>
<a name="ln1389"> </a>
<a name="ln1390">		case EXPORT_MODE_MESSAGE:</a>
<a name="ln1391">		default:</a>
<a name="ln1392">			saver = new NativeSaver(ref);</a>
<a name="ln1393">			break;</a>
<a name="ln1394">	}</a>
<a name="ln1395"> </a>
<a name="ln1396">	return saver;</a>
<a name="ln1397">}</a>
<a name="ln1398"> </a>
<a name="ln1399"> </a>
<a name="ln1400">const char*</a>
<a name="ln1401">MainWindow::_FileName(bool preferExporter) const</a>
<a name="ln1402">{</a>
<a name="ln1403">	FileSaver* saver1;</a>
<a name="ln1404">	FileSaver* saver2;</a>
<a name="ln1405">	if (preferExporter) {</a>
<a name="ln1406">		saver1 = dynamic_cast&lt;FileSaver*&gt;(fDocument-&gt;ExportSaver());</a>
<a name="ln1407">		saver2 = dynamic_cast&lt;FileSaver*&gt;(fDocument-&gt;NativeSaver());</a>
<a name="ln1408">	} else {</a>
<a name="ln1409">		saver1 = dynamic_cast&lt;FileSaver*&gt;(fDocument-&gt;NativeSaver());</a>
<a name="ln1410">		saver2 = dynamic_cast&lt;FileSaver*&gt;(fDocument-&gt;ExportSaver());</a>
<a name="ln1411">	}</a>
<a name="ln1412">	const char* fileName = NULL;</a>
<a name="ln1413">	if (saver1 != NULL)</a>
<a name="ln1414">		fileName = saver1-&gt;Ref()-&gt;name;</a>
<a name="ln1415">	if ((fileName == NULL || fileName[0] == '\0') &amp;&amp; saver2 != NULL)</a>
<a name="ln1416">		fileName = saver2-&gt;Ref()-&gt;name;</a>
<a name="ln1417">	return fileName;</a>
<a name="ln1418">}</a>
<a name="ln1419"> </a>
<a name="ln1420"> </a>
<a name="ln1421">void</a>
<a name="ln1422">MainWindow::_UpdateWindowTitle()</a>
<a name="ln1423">{</a>
<a name="ln1424">	const char* fileName = _FileName(false);</a>
<a name="ln1425">	if (fileName != NULL)</a>
<a name="ln1426">		SetTitle(fileName);</a>
<a name="ln1427">	else</a>
<a name="ln1428">		SetTitle(B_TRANSLATE_SYSTEM_NAME(&quot;Icon-O-Matic&quot;));</a>
<a name="ln1429">}</a>
<a name="ln1430"> </a>

</code></pre>
<div class="balloon" rel="1294"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="810"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="731"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
