
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>MediaDefs.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2015, Dario Casalinuovo</a>
<a name="ln3"> * Copyright 2004, 2006, Jérôme Duval.</a>
<a name="ln4"> * Copyright 2003-2004, Andrew Bachmann.</a>
<a name="ln5"> * Copyright 2002-2004, 2006 Marcus Overhagen.</a>
<a name="ln6"> * Copyright 2002, Eric Jaessler.</a>
<a name="ln7"> * All rights reserved. Distributed under the terms of the MIT license.</a>
<a name="ln8"> */</a>
<a name="ln9"> </a>
<a name="ln10"> </a>
<a name="ln11">#include &lt;MediaDefs.h&gt;</a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;Application.h&gt;</a>
<a name="ln14">#include &lt;Bitmap.h&gt;</a>
<a name="ln15">#include &lt;Catalog.h&gt;</a>
<a name="ln16">#include &lt;IconUtils.h&gt;</a>
<a name="ln17">#include &lt;LaunchRoster.h&gt;</a>
<a name="ln18">#include &lt;Locale.h&gt;</a>
<a name="ln19">#include &lt;MediaNode.h&gt;</a>
<a name="ln20">#include &lt;MediaRoster.h&gt;</a>
<a name="ln21">#include &lt;Node.h&gt;</a>
<a name="ln22">#include &lt;Notification.h&gt;</a>
<a name="ln23">#include &lt;Roster.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;inttypes.h&gt;</a>
<a name="ln26">#include &lt;stdio.h&gt;</a>
<a name="ln27">#include &lt;string.h&gt;</a>
<a name="ln28"> </a>
<a name="ln29">#include &quot;AddOnManager.h&quot;</a>
<a name="ln30">#include &quot;DataExchange.h&quot;</a>
<a name="ln31">#include &quot;MediaDebug.h&quot;</a>
<a name="ln32">#include &quot;MediaMisc.h&quot;</a>
<a name="ln33">#include &quot;MediaRosterEx.h&quot;</a>
<a name="ln34"> </a>
<a name="ln35"> </a>
<a name="ln36">#define META_DATA_MAX_SIZE			(16 &lt;&lt; 20)</a>
<a name="ln37">#define META_DATA_AREA_MIN_SIZE		32000</a>
<a name="ln38"> </a>
<a name="ln39">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln40">#define B_TRANSLATION_CONTEXT &quot;MediaDefs&quot;</a>
<a name="ln41"> </a>
<a name="ln42"> </a>
<a name="ln43">// #pragma mark - media_destination</a>
<a name="ln44"> </a>
<a name="ln45"> </a>
<a name="ln46">media_destination::media_destination(port_id port, int32 id)</a>
<a name="ln47">	:</a>
<a name="ln48">	port(port),</a>
<a name="ln49">	id(id)</a>
<a name="ln50">{</a>
<a name="ln51">}</a>
<a name="ln52"> </a>
<a name="ln53"> </a>
<a name="ln54">media_destination::media_destination(const media_destination&amp; clone)</a>
<a name="ln55">	:</a>
<a name="ln56">	port(clone.port),</a>
<a name="ln57">	id(clone.id)</a>
<a name="ln58">{</a>
<a name="ln59">}</a>
<a name="ln60"> </a>
<a name="ln61"> </a>
<a name="ln62">media_destination&amp;</a>
<a name="ln63">media_destination::operator=(const media_destination&amp; clone)</a>
<a name="ln64">{</a>
<a name="ln65">	port = clone.port;</a>
<a name="ln66">	id = clone.id;</a>
<a name="ln67">	return *this;</a>
<a name="ln68">}</a>
<a name="ln69"> </a>
<a name="ln70"> </a>
<a name="ln71">media_destination::media_destination()</a>
<a name="ln72">	:</a>
<a name="ln73">	port(-1),</a>
<a name="ln74">	id(-1)</a>
<a name="ln75">{</a>
<a name="ln76">}</a>
<a name="ln77"> </a>
<a name="ln78"> </a>
<a name="ln79">media_destination::~media_destination()</a>
<a name="ln80">{</a>
<a name="ln81">}</a>
<a name="ln82"> </a>
<a name="ln83"> </a>
<a name="ln84">media_destination media_destination::null(-1, -1);</a>
<a name="ln85"> </a>
<a name="ln86"> </a>
<a name="ln87">// #pragma mark - media_source</a>
<a name="ln88"> </a>
<a name="ln89"> </a>
<a name="ln90">media_source::media_source(port_id port,</a>
<a name="ln91">						   int32 id)</a>
<a name="ln92">	:</a>
<a name="ln93">	port(port),</a>
<a name="ln94">	id(id)</a>
<a name="ln95">{</a>
<a name="ln96">}</a>
<a name="ln97"> </a>
<a name="ln98"> </a>
<a name="ln99">media_source::media_source(const media_source&amp; clone)</a>
<a name="ln100">	:</a>
<a name="ln101">	port(clone.port),</a>
<a name="ln102">	id(clone.id)</a>
<a name="ln103">{</a>
<a name="ln104">}</a>
<a name="ln105"> </a>
<a name="ln106"> </a>
<a name="ln107">media_source&amp;</a>
<a name="ln108">media_source::operator=(const media_source&amp; clone)</a>
<a name="ln109">{</a>
<a name="ln110">	port = clone.port;</a>
<a name="ln111">	id = clone.id;</a>
<a name="ln112">	return *this;</a>
<a name="ln113">}</a>
<a name="ln114"> </a>
<a name="ln115"> </a>
<a name="ln116">media_source::media_source()</a>
<a name="ln117">	:</a>
<a name="ln118">	port(-1),</a>
<a name="ln119">	id(-1)</a>
<a name="ln120">{</a>
<a name="ln121">}</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">media_source::~media_source()</a>
<a name="ln125">{</a>
<a name="ln126">}</a>
<a name="ln127"> </a>
<a name="ln128"> </a>
<a name="ln129">media_source media_source::null(-1, -1);</a>
<a name="ln130"> </a>
<a name="ln131"> </a>
<a name="ln132">// #pragma mark -</a>
<a name="ln133"> </a>
<a name="ln134"> </a>
<a name="ln135">bool</a>
<a name="ln136">operator==(const media_destination&amp; a, const media_destination&amp; b)</a>
<a name="ln137">{</a>
<a name="ln138">	return a.port == b.port &amp;&amp; a.id == b.id;</a>
<a name="ln139">}</a>
<a name="ln140"> </a>
<a name="ln141"> </a>
<a name="ln142">bool</a>
<a name="ln143">operator!=(const media_destination&amp; a, const media_destination&amp; b)</a>
<a name="ln144">{</a>
<a name="ln145">	return a.port != b.port || a.id != b.id;</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148"> </a>
<a name="ln149">bool</a>
<a name="ln150">operator&lt;(const media_destination&amp; a, const media_destination&amp; b)</a>
<a name="ln151">{</a>
<a name="ln152">	UNIMPLEMENTED();</a>
<a name="ln153">	return false;</a>
<a name="ln154">}</a>
<a name="ln155"> </a>
<a name="ln156"> </a>
<a name="ln157">bool</a>
<a name="ln158">operator==(const media_source&amp; a, const media_source&amp; b)</a>
<a name="ln159">{</a>
<a name="ln160">	return a.port == b.port &amp;&amp; a.id == b.id;</a>
<a name="ln161">}</a>
<a name="ln162"> </a>
<a name="ln163"> </a>
<a name="ln164">bool</a>
<a name="ln165">operator!=(const media_source&amp; a, const media_source&amp; b)</a>
<a name="ln166">{</a>
<a name="ln167">	return a.port != b.port || a.id != b.id;</a>
<a name="ln168">}</a>
<a name="ln169"> </a>
<a name="ln170"> </a>
<a name="ln171">bool</a>
<a name="ln172">operator&lt;(const media_source&amp; a, const media_source&amp; b)</a>
<a name="ln173">{</a>
<a name="ln174">	UNIMPLEMENTED();</a>
<a name="ln175">	return false;</a>
<a name="ln176">}</a>
<a name="ln177"> </a>
<a name="ln178"> </a>
<a name="ln179">bool</a>
<a name="ln180">operator==(const media_node&amp; a, const media_node&amp; b)</a>
<a name="ln181">{</a>
<a name="ln182">	return a.node == b.node &amp;&amp; a.port == b.port &amp;&amp; a.kind == b.kind;</a>
<a name="ln183">}</a>
<a name="ln184"> </a>
<a name="ln185"> </a>
<a name="ln186">bool</a>
<a name="ln187">operator!=(const media_node&amp; a, const media_node&amp; b)</a>
<a name="ln188">{</a>
<a name="ln189">	return a.node != b.node || a.port != b.port || a.kind != b.kind;</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192"> </a>
<a name="ln193">bool</a>
<a name="ln194">operator&lt;(const media_node&amp; a, const media_node&amp; b)</a>
<a name="ln195">{</a>
<a name="ln196">	UNIMPLEMENTED();</a>
<a name="ln197">	return false;</a>
<a name="ln198">}</a>
<a name="ln199"> </a>
<a name="ln200"> </a>
<a name="ln201">// #pragma mark -</a>
<a name="ln202"> </a>
<a name="ln203"> </a>
<a name="ln204">media_multi_audio_format media_raw_audio_format::wildcard;</a>
<a name="ln205"> </a>
<a name="ln206">media_multi_audio_format media_multi_audio_format::wildcard;</a>
<a name="ln207"> </a>
<a name="ln208">media_encoded_audio_format media_encoded_audio_format::wildcard = {{0}};</a>
<a name="ln209"> </a>
<a name="ln210">media_video_display_info media_video_display_info::wildcard = {(color_space)0};</a>
<a name="ln211"> </a>
<a name="ln212">media_raw_video_format media_raw_video_format::wildcard = {0};</a>
<a name="ln213"> </a>
<a name="ln214">media_encoded_video_format media_encoded_video_format::wildcard = {{0}};</a>
<a name="ln215"> </a>
<a name="ln216">media_multistream_format media_multistream_format::wildcard = {0};</a>
<a name="ln217"> </a>
<a name="ln218"> </a>
<a name="ln219">// #pragma mark - media_format::Matches() support</a>
<a name="ln220"> </a>
<a name="ln221"> </a>
<a name="ln222">static bool</a>
<a name="ln223">raw_audio_format_matches(const media_raw_audio_format&amp; a,</a>
<a name="ln224">	const media_raw_audio_format&amp; b)</a>
<a name="ln225">{</a>
<a name="ln226">	if (a.frame_rate != 0 &amp;&amp; b.frame_rate != 0 &amp;&amp; a.frame_rate != b.frame_rate)</a>
<a name="ln227">		return false;</a>
<a name="ln228">	if (a.channel_count != 0 &amp;&amp; b.channel_count != 0</a>
<a name="ln229">		&amp;&amp; a.channel_count != b.channel_count) {</a>
<a name="ln230">		return false;</a>
<a name="ln231">	}</a>
<a name="ln232">	if (a.format != 0 &amp;&amp; b.format != 0 &amp;&amp; a.format != b.format)</a>
<a name="ln233">		return false;</a>
<a name="ln234">	if (a.byte_order != 0 &amp;&amp; b.byte_order != 0 &amp;&amp; a.byte_order != b.byte_order)</a>
<a name="ln235">		return false;</a>
<a name="ln236">	if (a.buffer_size != 0 &amp;&amp; b.buffer_size != 0</a>
<a name="ln237">		&amp;&amp; a.buffer_size != b.buffer_size) {</a>
<a name="ln238">		return false;</a>
<a name="ln239">	}</a>
<a name="ln240">	if (a.frame_rate != 0 &amp;&amp; b.frame_rate != 0 &amp;&amp; a.frame_rate != b.frame_rate)</a>
<a name="ln241">		return false;</a>
<a name="ln242">	return true;</a>
<a name="ln243">}</a>
<a name="ln244"> </a>
<a name="ln245"> </a>
<a name="ln246">static bool</a>
<a name="ln247">multi_audio_info_matches(const media_multi_audio_info&amp; a,</a>
<a name="ln248">	const media_multi_audio_info&amp; b)</a>
<a name="ln249">{</a>
<a name="ln250">	if (a.channel_mask != 0 &amp;&amp; b.channel_mask != 0</a>
<a name="ln251">		&amp;&amp; a.channel_mask != b.channel_mask) {</a>
<a name="ln252">		return false;</a>
<a name="ln253">	}</a>
<a name="ln254">	if (a.valid_bits != 0 &amp;&amp; b.valid_bits != 0 &amp;&amp; a.valid_bits != b.valid_bits)</a>
<a name="ln255">		return false;</a>
<a name="ln256">	if (a.matrix_mask != 0 &amp;&amp; b.matrix_mask != 0</a>
<a name="ln257">		&amp;&amp; a.matrix_mask != b.matrix_mask) {</a>
<a name="ln258">		return false;</a>
<a name="ln259">	}</a>
<a name="ln260">	return true;</a>
<a name="ln261">}</a>
<a name="ln262"> </a>
<a name="ln263"> </a>
<a name="ln264">static bool</a>
<a name="ln265">multi_audio_format_matches(const media_multi_audio_format&amp; a,</a>
<a name="ln266">	const media_multi_audio_format&amp; b)</a>
<a name="ln267">{</a>
<a name="ln268">	return raw_audio_format_matches(a, b) &amp;&amp; multi_audio_info_matches(a, b);</a>
<a name="ln269">}</a>
<a name="ln270"> </a>
<a name="ln271"> </a>
<a name="ln272">static bool</a>
<a name="ln273">raw_video_format_matches(const media_raw_video_format&amp; a,</a>
<a name="ln274">	const media_raw_video_format&amp; b)</a>
<a name="ln275">{</a>
<a name="ln276">	if (a.field_rate != 0 &amp;&amp; b.field_rate != 0</a>
<a name="ln277">		&amp;&amp; a.field_rate != b.field_rate) {</a>
<a name="ln278">		return false;</a>
<a name="ln279">	}</a>
<a name="ln280">	if (a.interlace != 0 &amp;&amp; b.interlace != 0</a>
<a name="ln281">		&amp;&amp; a.interlace != b.interlace) {</a>
<a name="ln282">		return false;</a>
<a name="ln283">	}</a>
<a name="ln284">	if (a.first_active != 0 &amp;&amp; b.first_active != 0</a>
<a name="ln285">		&amp;&amp; a.first_active != b.first_active) {</a>
<a name="ln286">		return false;</a>
<a name="ln287">	}</a>
<a name="ln288">	if (a.last_active != 0 &amp;&amp; b.last_active != 0</a>
<a name="ln289">		&amp;&amp; a.last_active != b.last_active) {</a>
<a name="ln290">		return false;</a>
<a name="ln291">	}</a>
<a name="ln292">	if (a.orientation != 0 &amp;&amp; b.orientation != 0</a>
<a name="ln293">		&amp;&amp; a.orientation != b.orientation) {</a>
<a name="ln294">		return false;</a>
<a name="ln295">	}</a>
<a name="ln296">	if (a.pixel_width_aspect != 0 &amp;&amp; b.pixel_width_aspect != 0</a>
<a name="ln297">		&amp;&amp; a.pixel_width_aspect != b.pixel_width_aspect) {</a>
<a name="ln298">		return false;</a>
<a name="ln299">	}</a>
<a name="ln300">	if (a.pixel_height_aspect != 0 &amp;&amp; b.pixel_height_aspect != 0</a>
<a name="ln301">		&amp;&amp; a.pixel_height_aspect != b.pixel_height_aspect) {</a>
<a name="ln302">		return false;</a>
<a name="ln303">	}</a>
<a name="ln304">	if (a.display.format != 0 &amp;&amp; b.display.format != 0</a>
<a name="ln305">		&amp;&amp; a.display.format != b.display.format) {</a>
<a name="ln306">		return false;</a>
<a name="ln307">	}</a>
<a name="ln308">	if (a.display.line_width != 0 &amp;&amp; b.display.line_width != 0</a>
<a name="ln309">		&amp;&amp; a.display.line_width != b.display.line_width) {</a>
<a name="ln310">		return false;</a>
<a name="ln311">	}</a>
<a name="ln312">	if (a.display.line_count != 0 &amp;&amp; b.display.line_count != 0</a>
<a name="ln313">		&amp;&amp; a.display.line_count != b.display.line_count) {</a>
<a name="ln314">		return false;</a>
<a name="ln315">	}</a>
<a name="ln316">	if (a.display.bytes_per_row != 0 &amp;&amp; b.display.bytes_per_row != 0</a>
<a name="ln317">		&amp;&amp; a.display.bytes_per_row != b.display.bytes_per_row) {</a>
<a name="ln318">		return false;</a>
<a name="ln319">	}</a>
<a name="ln320">	if (a.display.pixel_offset != 0 &amp;&amp; b.display.pixel_offset != 0</a>
<a name="ln321">		&amp;&amp; a.display.pixel_offset != b.display.pixel_offset) {</a>
<a name="ln322">		return false;</a>
<a name="ln323">	}</a>
<a name="ln324">	if (a.display.line_offset != 0 &amp;&amp; b.display.line_offset != 0</a>
<a name="ln325">		&amp;&amp; a.display.line_offset != b.display.line_offset) {</a>
<a name="ln326">		return false;</a>
<a name="ln327">	}</a>
<a name="ln328">	if (a.display.flags != 0 &amp;&amp; b.display.flags != 0</a>
<a name="ln329">		&amp;&amp; a.display.flags != b.display.flags) {</a>
<a name="ln330">		return false;</a>
<a name="ln331">	}</a>
<a name="ln332"> </a>
<a name="ln333">	return true;</a>
<a name="ln334">}</a>
<a name="ln335"> </a>
<a name="ln336"> </a>
<a name="ln337">static bool</a>
<a name="ln338">multistream_format_matches(const media_multistream_format&amp; a,</a>
<a name="ln339">	const media_multistream_format&amp; b)</a>
<a name="ln340">{</a>
<a name="ln341">	if (a.avg_bit_rate != 0 &amp;&amp; b.avg_bit_rate != 0</a>
<a name="ln342">		&amp;&amp; a.avg_bit_rate != b.avg_bit_rate) {</a>
<a name="ln343">		return false;</a>
<a name="ln344">	}</a>
<a name="ln345">	if (a.max_bit_rate != 0 &amp;&amp; b.max_bit_rate != 0</a>
<a name="ln346">		&amp;&amp; a.max_bit_rate != b.max_bit_rate) {</a>
<a name="ln347">		return false;</a>
<a name="ln348">	}</a>
<a name="ln349">	if (a.avg_chunk_size != 0 &amp;&amp; b.avg_chunk_size != 0</a>
<a name="ln350">		&amp;&amp; a.avg_chunk_size != b.avg_chunk_size) {</a>
<a name="ln351">		return false;</a>
<a name="ln352">	}</a>
<a name="ln353">	if (a.max_chunk_size != 0 &amp;&amp; b.max_chunk_size != 0</a>
<a name="ln354">		&amp;&amp; a.max_chunk_size != b.max_chunk_size) {</a>
<a name="ln355">		return false;</a>
<a name="ln356">	}</a>
<a name="ln357">	if (a.flags != 0 &amp;&amp; b.flags != 0 &amp;&amp; a.flags != b.flags)</a>
<a name="ln358">		return false;</a>
<a name="ln359">	if (a.format != 0 &amp;&amp; b.format != 0 &amp;&amp; a.format != b.format)</a>
<a name="ln360">		return false;</a>
<a name="ln361"> </a>
<a name="ln362">	if (a.format == 0 &amp;&amp; b.format == 0) {</a>
<a name="ln363">		// TODO: How do we compare two formats with no type?</a>
<a name="ln364">		return true;</a>
<a name="ln365">	}</a>
<a name="ln366"> </a>
<a name="ln367">	switch ((a.format != 0) ? a.format : b.format) {</a>
<a name="ln368">		default:</a>
<a name="ln369">			return true; // TODO: really?</a>
<a name="ln370"> </a>
<a name="ln371">		case media_multistream_format::B_VID:</a>
<a name="ln372">			if (a.u.vid.frame_rate != 0 &amp;&amp; b.u.vid.frame_rate != 0</a>
<a name="ln373">				&amp;&amp; a.u.vid.frame_rate != b.u.vid.frame_rate) {</a>
<a name="ln374">				return false;</a>
<a name="ln375">			}</a>
<a name="ln376">			if (a.u.vid.width != 0 &amp;&amp; b.u.vid.width != 0</a>
<a name="ln377">				&amp;&amp; a.u.vid.width != b.u.vid.width) {</a>
<a name="ln378">				return false;</a>
<a name="ln379">			}</a>
<a name="ln380">			if (a.u.vid.height != 0 &amp;&amp; b.u.vid.height != 0</a>
<a name="ln381">				&amp;&amp; a.u.vid.height != b.u.vid.height) {</a>
<a name="ln382">				return false;</a>
<a name="ln383">			}</a>
<a name="ln384">			if (a.u.vid.space != 0 &amp;&amp; b.u.vid.space != 0</a>
<a name="ln385">				&amp;&amp; a.u.vid.space != b.u.vid.space) {</a>
<a name="ln386">				return false;</a>
<a name="ln387">			}</a>
<a name="ln388">			if (a.u.vid.sampling_rate != 0 &amp;&amp; b.u.vid.sampling_rate != 0</a>
<a name="ln389">				&amp;&amp; a.u.vid.sampling_rate != b.u.vid.sampling_rate) {</a>
<a name="ln390">				return false;</a>
<a name="ln391">			}</a>
<a name="ln392">			if (a.u.vid.sample_format != 0 &amp;&amp; b.u.vid.sample_format != 0</a>
<a name="ln393">				&amp;&amp; a.u.vid.sample_format != b.u.vid.sample_format) {</a>
<a name="ln394">				return false;</a>
<a name="ln395">			}</a>
<a name="ln396">			if (a.u.vid.byte_order != 0 &amp;&amp; b.u.vid.byte_order != 0</a>
<a name="ln397">				&amp;&amp; a.u.vid.byte_order != b.u.vid.byte_order) {</a>
<a name="ln398">				return false;</a>
<a name="ln399">			}</a>
<a name="ln400">			if (a.u.vid.channel_count != 0 &amp;&amp; b.u.vid.channel_count != 0</a>
<a name="ln401">				&amp;&amp; a.u.vid.channel_count != b.u.vid.channel_count) {</a>
<a name="ln402">				return false;</a>
<a name="ln403">			}</a>
<a name="ln404">			return true;</a>
<a name="ln405"> </a>
<a name="ln406">		case media_multistream_format::B_AVI:</a>
<a name="ln407">			if (a.u.avi.us_per_frame != 0 &amp;&amp; b.u.avi.us_per_frame != 0</a>
<a name="ln408">				&amp;&amp; a.u.avi.us_per_frame != b.u.avi.us_per_frame) {</a>
<a name="ln409">				return false;</a>
<a name="ln410">			}</a>
<a name="ln411">			if (a.u.avi.width != 0 &amp;&amp; b.u.avi.width != 0</a>
<a name="ln412">				&amp;&amp; a.u.avi.width != b.u.avi.width) {</a>
<a name="ln413">				return false;</a>
<a name="ln414">			}</a>
<a name="ln415">			if (a.u.avi.height != 0 &amp;&amp; b.u.avi.height != 0</a>
<a name="ln416">				&amp;&amp; a.u.avi.height != b.u.avi.height) {</a>
<a name="ln417">				return false;</a>
<a name="ln418">			}</a>
<a name="ln419">			if (a.u.avi.type_count != 0 &amp;&amp; b.u.avi.type_count != 0</a>
<a name="ln420">				&amp;&amp; a.u.avi.type_count != b.u.avi.type_count) {</a>
<a name="ln421">				return false;</a>
<a name="ln422">			}</a>
<a name="ln423">			if (a.u.avi.types[0] != 0 &amp;&amp; b.u.avi.types[0] != 0</a>
<a name="ln424">				&amp;&amp; a.u.avi.types[0] != b.u.avi.types[0]) {</a>
<a name="ln425">				return false;</a>
<a name="ln426">			}</a>
<a name="ln427">			if (a.u.avi.types[1] != 0 &amp;&amp; b.u.avi.types[1] != 0</a>
<a name="ln428">				&amp;&amp; a.u.avi.types[1] != b.u.avi.types[1]) {</a>
<a name="ln429">				return false;</a>
<a name="ln430">			}</a>
<a name="ln431">			if (a.u.avi.types[2] != 0 &amp;&amp; b.u.avi.types[2] != 0</a>
<a name="ln432">				&amp;&amp; a.u.avi.types[2] != b.u.avi.types[2]) {</a>
<a name="ln433">				return false;</a>
<a name="ln434">			}</a>
<a name="ln435">			if (a.u.avi.types[3] != 0 &amp;&amp; b.u.avi.types[3] != 0</a>
<a name="ln436">				&amp;&amp; a.u.avi.types[3] != b.u.avi.types[3]) {</a>
<a name="ln437">				return false;</a>
<a name="ln438">			}</a>
<a name="ln439">			if (a.u.avi.types[4] != 0 &amp;&amp; b.u.avi.types[4] != 0</a>
<a name="ln440">				&amp;&amp; a.u.avi.types[4] != b.u.avi.types[4]) {</a>
<a name="ln441">				return false;</a>
<a name="ln442">			}</a>
<a name="ln443">			return true;</a>
<a name="ln444">	}</a>
<a name="ln445">}</a>
<a name="ln446"> </a>
<a name="ln447"> </a>
<a name="ln448">static bool</a>
<a name="ln449">encoded_audio_format_matches(const media_encoded_audio_format&amp; a,</a>
<a name="ln450">	const media_encoded_audio_format&amp; b)</a>
<a name="ln451">{</a>
<a name="ln452">	if (!raw_audio_format_matches(a.output, b.output))</a>
<a name="ln453">		return false;</a>
<a name="ln454">	if (a.encoding != 0 &amp;&amp; b.encoding != 0 &amp;&amp; a.encoding != b.encoding)</a>
<a name="ln455">		return false;</a>
<a name="ln456">	if (a.bit_rate != 0 &amp;&amp; b.bit_rate != 0 &amp;&amp; a.bit_rate != b.bit_rate)</a>
<a name="ln457">		return false;</a>
<a name="ln458">	if (a.frame_size != 0 &amp;&amp; b.frame_size != 0 &amp;&amp; a.frame_size != b.frame_size)</a>
<a name="ln459">		return false;</a>
<a name="ln460">	if (!multi_audio_info_matches(a.multi_info, b.multi_info))</a>
<a name="ln461">		return false;</a>
<a name="ln462"> </a>
<a name="ln463">	if (a.encoding == 0 &amp;&amp; b.encoding == 0)</a>
<a name="ln464">		return true; // can't compare</a>
<a name="ln465"> </a>
<a name="ln466">	switch((a.encoding != 0) ? a.encoding : b.encoding) {</a>
<a name="ln467">		case media_encoded_audio_format::B_ANY:</a>
<a name="ln468">		default:</a>
<a name="ln469">			return true;</a>
<a name="ln470">	}</a>
<a name="ln471">}</a>
<a name="ln472"> </a>
<a name="ln473"> </a>
<a name="ln474">static bool</a>
<a name="ln475">encoded_video_format_matches(const media_encoded_video_format&amp; a,</a>
<a name="ln476">	const media_encoded_video_format&amp; b)</a>
<a name="ln477">{</a>
<a name="ln478">	if (!raw_video_format_matches(a.output, b.output))</a>
<a name="ln479">		return false;</a>
<a name="ln480">	if (a.encoding != 0 &amp;&amp; b.encoding != 0 &amp;&amp; a.encoding != b.encoding)</a>
<a name="ln481">		return false;</a>
<a name="ln482"> </a>
<a name="ln483">	if (a.avg_bit_rate != 0 &amp;&amp; b.avg_bit_rate != 0</a>
<a name="ln484">		&amp;&amp; a.avg_bit_rate != b.avg_bit_rate) {</a>
<a name="ln485">		return false;</a>
<a name="ln486">	}</a>
<a name="ln487">	if (a.max_bit_rate != 0 &amp;&amp; b.max_bit_rate != 0</a>
<a name="ln488">		&amp;&amp; a.max_bit_rate != b.max_bit_rate) {</a>
<a name="ln489">		return false;</a>
<a name="ln490">	}</a>
<a name="ln491">	if (a.frame_size != 0 &amp;&amp; b.frame_size != 0</a>
<a name="ln492">		&amp;&amp; a.frame_size != b.frame_size) {</a>
<a name="ln493">		return false;</a>
<a name="ln494">	}</a>
<a name="ln495">	if (a.forward_history != 0 &amp;&amp; b.forward_history != 0</a>
<a name="ln496">		&amp;&amp; a.forward_history != b.forward_history) {</a>
<a name="ln497">		return false;</a>
<a name="ln498">	}</a>
<a name="ln499">	if (a.backward_history != 0 &amp;&amp; b.backward_history != 0</a>
<a name="ln500">		&amp;&amp; a.backward_history != b.backward_history) {</a>
<a name="ln501">		return false;</a>
<a name="ln502">	}</a>
<a name="ln503"> </a>
<a name="ln504">	if (a.encoding == 0 &amp;&amp; b.encoding == 0)</a>
<a name="ln505">		return true; // can't compare</a>
<a name="ln506"> </a>
<a name="ln507">	switch((a.encoding != 0) ? a.encoding : b.encoding) {</a>
<a name="ln508">		case media_encoded_video_format::B_ANY:</a>
<a name="ln509">		default:</a>
<a name="ln510">			return true;</a>
<a name="ln511">	}</a>
<a name="ln512">}</a>
<a name="ln513"> </a>
<a name="ln514"> </a>
<a name="ln515">// #pragma mark - media_format::SpecializeTo() support</a>
<a name="ln516"> </a>
<a name="ln517"> </a>
<a name="ln518">static void</a>
<a name="ln519">raw_audio_format_specialize(media_raw_audio_format* format,</a>
<a name="ln520">	const media_raw_audio_format* other)</a>
<a name="ln521">{</a>
<a name="ln522">	if (format-&gt;frame_rate == 0)</a>
<a name="ln523">		format-&gt;frame_rate = other-&gt;frame_rate;</a>
<a name="ln524">	if (format-&gt;channel_count == 0)</a>
<a name="ln525">		format-&gt;channel_count = other-&gt;channel_count;</a>
<a name="ln526">	if (format-&gt;format == 0)</a>
<a name="ln527">		format-&gt;format = other-&gt;format;</a>
<a name="ln528">	if (format-&gt;byte_order == 0)</a>
<a name="ln529">		format-&gt;byte_order = other-&gt;byte_order;</a>
<a name="ln530">	if (format-&gt;buffer_size == 0)</a>
<a name="ln531">		format-&gt;buffer_size = other-&gt;buffer_size;</a>
<a name="ln532">	if (format-&gt;frame_rate == 0)</a>
<a name="ln533">		format-&gt;frame_rate = other-&gt;frame_rate;</a>
<a name="ln534">}</a>
<a name="ln535"> </a>
<a name="ln536"> </a>
<a name="ln537">static void</a>
<a name="ln538">multi_audio_info_specialize(media_multi_audio_info* format,</a>
<a name="ln539">	const media_multi_audio_info* other)</a>
<a name="ln540">{</a>
<a name="ln541">	if (format-&gt;channel_mask == 0)</a>
<a name="ln542">		format-&gt;channel_mask = other-&gt;channel_mask;</a>
<a name="ln543">	if (format-&gt;valid_bits == 0)</a>
<a name="ln544">		format-&gt;valid_bits = other-&gt;valid_bits;</a>
<a name="ln545">	if (format-&gt;matrix_mask == 0)</a>
<a name="ln546">		format-&gt;matrix_mask = other-&gt;matrix_mask;</a>
<a name="ln547">}</a>
<a name="ln548"> </a>
<a name="ln549"> </a>
<a name="ln550">static void</a>
<a name="ln551">multi_audio_format_specialize(media_multi_audio_format* format,</a>
<a name="ln552">	const media_multi_audio_format* other)</a>
<a name="ln553">{</a>
<a name="ln554">	raw_audio_format_specialize(format, other);</a>
<a name="ln555">	multi_audio_info_specialize(format, other);</a>
<a name="ln556">}</a>
<a name="ln557"> </a>
<a name="ln558"> </a>
<a name="ln559">static void</a>
<a name="ln560">raw_video_format_specialize(media_raw_video_format* format,</a>
<a name="ln561">	const media_raw_video_format* other)</a>
<a name="ln562">{</a>
<a name="ln563">	if (format-&gt;field_rate == 0)</a>
<a name="ln564">		format-&gt;field_rate = other-&gt;field_rate;</a>
<a name="ln565">	if (format-&gt;interlace == 0)</a>
<a name="ln566">		format-&gt;interlace = other-&gt;interlace;</a>
<a name="ln567">	if (format-&gt;first_active == 0)</a>
<a name="ln568">		format-&gt;first_active = other-&gt;first_active;</a>
<a name="ln569">	if (format-&gt;last_active == 0)</a>
<a name="ln570">		format-&gt;last_active = other-&gt;last_active;</a>
<a name="ln571">	if (format-&gt;orientation == 0)</a>
<a name="ln572">		format-&gt;orientation = other-&gt;orientation;</a>
<a name="ln573">	if (format-&gt;pixel_width_aspect == 0)</a>
<a name="ln574">		format-&gt;pixel_width_aspect = other-&gt;pixel_width_aspect;</a>
<a name="ln575">	if (format-&gt;pixel_height_aspect == 0)</a>
<a name="ln576">		format-&gt;pixel_height_aspect = other-&gt;pixel_height_aspect;</a>
<a name="ln577">	if (format-&gt;display.format == 0)</a>
<a name="ln578">		format-&gt;display.format = other-&gt;display.format;</a>
<a name="ln579">	if (format-&gt;display.line_width == 0)</a>
<a name="ln580">		format-&gt;display.line_width = other-&gt;display.line_width;</a>
<a name="ln581">	if (format-&gt;display.line_count == 0)</a>
<a name="ln582">		format-&gt;display.line_count = other-&gt;display.line_count;</a>
<a name="ln583">	if (format-&gt;display.bytes_per_row == 0)</a>
<a name="ln584">		format-&gt;display.bytes_per_row = other-&gt;display.bytes_per_row;</a>
<a name="ln585">	if (format-&gt;display.pixel_offset == 0)</a>
<a name="ln586">		format-&gt;display.pixel_offset = other-&gt;display.pixel_offset;</a>
<a name="ln587">	if (format-&gt;display.line_offset == 0)</a>
<a name="ln588">		format-&gt;display.line_offset = other-&gt;display.line_offset;</a>
<a name="ln589">	if (format-&gt;display.flags == 0)</a>
<a name="ln590">		format-&gt;display.flags = other-&gt;display.flags;</a>
<a name="ln591">}</a>
<a name="ln592"> </a>
<a name="ln593"> </a>
<a name="ln594">static void</a>
<a name="ln595">multistream_format_specialize(media_multistream_format* format,</a>
<a name="ln596">	const media_multistream_format* other)</a>
<a name="ln597">{</a>
<a name="ln598">	if (format-&gt;avg_bit_rate == 0)</a>
<a name="ln599">		format-&gt;avg_bit_rate = other-&gt;avg_bit_rate;</a>
<a name="ln600">	if (format-&gt;max_bit_rate == 0)</a>
<a name="ln601">		format-&gt;max_bit_rate = other-&gt;max_bit_rate;</a>
<a name="ln602">	if (format-&gt;avg_chunk_size == 0)</a>
<a name="ln603">		format-&gt;avg_chunk_size = other-&gt;avg_chunk_size;</a>
<a name="ln604">	if (format-&gt;max_chunk_size == 0)</a>
<a name="ln605">		format-&gt;max_chunk_size = other-&gt;max_chunk_size;</a>
<a name="ln606">	if (format-&gt;flags == 0)</a>
<a name="ln607">		format-&gt;flags = other-&gt;flags;</a>
<a name="ln608">	if (format-&gt;format == 0)</a>
<a name="ln609">		format-&gt;format = other-&gt;format;</a>
<a name="ln610"> </a>
<a name="ln611">	switch (format-&gt;format) {</a>
<a name="ln612">		case media_multistream_format::B_VID:</a>
<a name="ln613">			if (format-&gt;u.vid.frame_rate == 0)</a>
<a name="ln614">				format-&gt;u.vid.frame_rate = other-&gt;u.vid.frame_rate;</a>
<a name="ln615">			if (format-&gt;u.vid.width == 0)</a>
<a name="ln616">				format-&gt;u.vid.width = other-&gt;u.vid.width;</a>
<a name="ln617">			if (format-&gt;u.vid.height == 0)</a>
<a name="ln618">				format-&gt;u.vid.height = other-&gt;u.vid.height;</a>
<a name="ln619">			if (format-&gt;u.vid.space == 0)</a>
<a name="ln620">				format-&gt;u.vid.space = other-&gt;u.vid.space;</a>
<a name="ln621">			if (format-&gt;u.vid.sampling_rate == 0)</a>
<a name="ln622">				format-&gt;u.vid.sampling_rate = other-&gt;u.vid.sampling_rate;</a>
<a name="ln623">			if (format-&gt;u.vid.sample_format == 0)</a>
<a name="ln624">				format-&gt;u.vid.sample_format = other-&gt;u.vid.sample_format;</a>
<a name="ln625">			if (format-&gt;u.vid.byte_order == 0)</a>
<a name="ln626">				format-&gt;u.vid.byte_order = other-&gt;u.vid.byte_order;</a>
<a name="ln627">			if (format-&gt;u.vid.channel_count == 0)</a>
<a name="ln628">				format-&gt;u.vid.channel_count = other-&gt;u.vid.channel_count;</a>
<a name="ln629">			break;</a>
<a name="ln630"> </a>
<a name="ln631">		case media_multistream_format::B_AVI:</a>
<a name="ln632">			if (format-&gt;u.avi.us_per_frame == 0)</a>
<a name="ln633">				format-&gt;u.avi.us_per_frame = other-&gt;u.avi.us_per_frame;</a>
<a name="ln634">			if (format-&gt;u.avi.width == 0)</a>
<a name="ln635">				format-&gt;u.avi.width = other-&gt;u.avi.width;</a>
<a name="ln636">			if (format-&gt;u.avi.height == 0)</a>
<a name="ln637">				format-&gt;u.avi.height = other-&gt;u.avi.height;</a>
<a name="ln638">			if (format-&gt;u.avi.type_count == 0)</a>
<a name="ln639">				format-&gt;u.avi.type_count = other-&gt;u.avi.type_count;</a>
<a name="ln640">			if (format-&gt;u.avi.types[0] == 0)</a>
<a name="ln641">				format-&gt;u.avi.types[0] = other-&gt;u.avi.types[0];</a>
<a name="ln642">			if (format-&gt;u.avi.types[1] == 0)</a>
<a name="ln643">				format-&gt;u.avi.types[1] = other-&gt;u.avi.types[1];</a>
<a name="ln644">			if (format-&gt;u.avi.types[2] == 0)</a>
<a name="ln645">				format-&gt;u.avi.types[2] = other-&gt;u.avi.types[2];</a>
<a name="ln646">			if (format-&gt;u.avi.types[3] == 0)</a>
<a name="ln647">				format-&gt;u.avi.types[3] = other-&gt;u.avi.types[3];</a>
<a name="ln648">			if (format-&gt;u.avi.types[4] == 0)</a>
<a name="ln649">				format-&gt;u.avi.types[4] = other-&gt;u.avi.types[4];</a>
<a name="ln650">			break;</a>
<a name="ln651"> </a>
<a name="ln652">		default:</a>
<a name="ln653">			ERROR(&quot;media_format::SpecializeTo can't specialize &quot;</a>
<a name="ln654">				&quot;media_multistream_format of format %&quot; B_PRId32 &quot;\n&quot;,</a>
<a name="ln655">				format-&gt;format);</a>
<a name="ln656">	}</a>
<a name="ln657">}</a>
<a name="ln658"> </a>
<a name="ln659"> </a>
<a name="ln660">static void</a>
<a name="ln661">encoded_audio_format_specialize(media_encoded_audio_format* format,</a>
<a name="ln662">	const media_encoded_audio_format* other)</a>
<a name="ln663">{</a>
<a name="ln664">	raw_audio_format_specialize(&amp;format-&gt;output, &amp;other-&gt;output);</a>
<a name="ln665">	if (format-&gt;encoding == 0)</a>
<a name="ln666">		format-&gt;encoding = other-&gt;encoding;</a>
<a name="ln667">	if (format-&gt;bit_rate == 0)</a>
<a name="ln668">		format-&gt;bit_rate = other-&gt;bit_rate;</a>
<a name="ln669">	if (format-&gt;frame_size == 0)</a>
<a name="ln670">		format-&gt;frame_size = other-&gt;frame_size;</a>
<a name="ln671">	multi_audio_info_specialize(&amp;format-&gt;multi_info, &amp;other-&gt;multi_info);</a>
<a name="ln672">}</a>
<a name="ln673"> </a>
<a name="ln674"> </a>
<a name="ln675">static void</a>
<a name="ln676">encoded_video_format_specialize(media_encoded_video_format* format,</a>
<a name="ln677">	const media_encoded_video_format* other)</a>
<a name="ln678">{</a>
<a name="ln679">	raw_video_format_specialize(&amp;format-&gt;output, &amp;other-&gt;output);</a>
<a name="ln680">	if (format-&gt;avg_bit_rate == 0)</a>
<a name="ln681">		format-&gt;avg_bit_rate = other-&gt;avg_bit_rate;</a>
<a name="ln682">	if (format-&gt;max_bit_rate == 0)</a>
<a name="ln683">		format-&gt;max_bit_rate = other-&gt;max_bit_rate;</a>
<a name="ln684">	if (format-&gt;encoding == 0)</a>
<a name="ln685">		format-&gt;encoding = other-&gt;encoding;</a>
<a name="ln686">	if (format-&gt;frame_size == 0)</a>
<a name="ln687">		format-&gt;frame_size = other-&gt;frame_size;</a>
<a name="ln688">	if (format-&gt;forward_history == 0)</a>
<a name="ln689">		format-&gt;forward_history = other-&gt;forward_history;</a>
<a name="ln690">	if (format-&gt;backward_history == 0)</a>
<a name="ln691">		format-&gt;backward_history = other-&gt;backward_history;</a>
<a name="ln692">}</a>
<a name="ln693"> </a>
<a name="ln694"> </a>
<a name="ln695">// #pragma mark - media_format</a>
<a name="ln696"> </a>
<a name="ln697"> </a>
<a name="ln698">bool</a>
<a name="ln699">media_format::Matches(const media_format* other) const</a>
<a name="ln700">{</a>
<a name="ln701">	CALLED();</a>
<a name="ln702"> </a>
<a name="ln703">	if (type == 0 &amp;&amp; other-&gt;type == 0) {</a>
<a name="ln704">		// TODO: How do we compare two formats with no type?</a>
<a name="ln705">		return true;</a>
<a name="ln706">	}</a>
<a name="ln707"> </a>
<a name="ln708">	if (type != 0 &amp;&amp; other-&gt;type != 0 &amp;&amp; type != other-&gt;type)</a>
<a name="ln709">		return false;</a>
<a name="ln710"> </a>
<a name="ln711">	switch ((type != 0) ? type : other-&gt;type) {</a>
<a name="ln712">		case B_MEDIA_RAW_AUDIO:</a>
<a name="ln713">			return multi_audio_format_matches(u.raw_audio, other-&gt;u.raw_audio);</a>
<a name="ln714"> </a>
<a name="ln715">		case B_MEDIA_RAW_VIDEO:</a>
<a name="ln716">			return raw_video_format_matches(u.raw_video, other-&gt;u.raw_video);</a>
<a name="ln717"> </a>
<a name="ln718">		case B_MEDIA_MULTISTREAM:</a>
<a name="ln719">			return multistream_format_matches(u.multistream,</a>
<a name="ln720">				other-&gt;u.multistream);</a>
<a name="ln721"> </a>
<a name="ln722">		case B_MEDIA_ENCODED_AUDIO:</a>
<a name="ln723">			return encoded_audio_format_matches(u.encoded_audio,</a>
<a name="ln724">				other-&gt;u.encoded_audio);</a>
<a name="ln725"> </a>
<a name="ln726">		case B_MEDIA_ENCODED_VIDEO:</a>
<a name="ln727">			return encoded_video_format_matches(u.encoded_video,</a>
<a name="ln728">				other-&gt;u.encoded_video);</a>
<a name="ln729"> </a>
<a name="ln730">		default:</a>
<a name="ln731">			return true; // TODO: really?</a>
<a name="ln732">	}</a>
<a name="ln733">}</a>
<a name="ln734"> </a>
<a name="ln735"> </a>
<a name="ln736">void</a>
<a name="ln737">media_format::SpecializeTo(const media_format* otherFormat)</a>
<a name="ln738">{</a>
<a name="ln739">	CALLED();</a>
<a name="ln740"> </a>
<a name="ln741">	if (type == 0 &amp;&amp; otherFormat-&gt;type == 0) {</a>
<a name="ln742">		ERROR(&quot;media_format::SpecializeTo can't specialize wildcard to other &quot;</a>
<a name="ln743">			&quot;wildcard format\n&quot;);</a>
<a name="ln744">		return;</a>
<a name="ln745">	}</a>
<a name="ln746"> </a>
<a name="ln747">	if (type == 0)</a>
<a name="ln748">		type = otherFormat-&gt;type;</a>
<a name="ln749"> </a>
<a name="ln750">	switch (type) {</a>
<a name="ln751">		case B_MEDIA_RAW_AUDIO:</a>
<a name="ln752">			multi_audio_format_specialize(&amp;u.raw_audio,</a>
<a name="ln753">				&amp;otherFormat-&gt;u.raw_audio);</a>
<a name="ln754">			return;</a>
<a name="ln755"> </a>
<a name="ln756">		case B_MEDIA_RAW_VIDEO:</a>
<a name="ln757">			raw_video_format_specialize(&amp;u.raw_video,</a>
<a name="ln758">				&amp;otherFormat-&gt;u.raw_video);</a>
<a name="ln759">			return;</a>
<a name="ln760"> </a>
<a name="ln761">		case B_MEDIA_MULTISTREAM:</a>
<a name="ln762">			multistream_format_specialize(&amp;u.multistream,</a>
<a name="ln763">				&amp;otherFormat-&gt;u.multistream);</a>
<a name="ln764">			return;</a>
<a name="ln765"> </a>
<a name="ln766">		case B_MEDIA_ENCODED_AUDIO:</a>
<a name="ln767">			encoded_audio_format_specialize(&amp;u.encoded_audio,</a>
<a name="ln768">				&amp;otherFormat-&gt;u.encoded_audio);</a>
<a name="ln769">			return;</a>
<a name="ln770"> </a>
<a name="ln771">		case B_MEDIA_ENCODED_VIDEO:</a>
<a name="ln772">			encoded_video_format_specialize(&amp;u.encoded_video,</a>
<a name="ln773">				&amp;otherFormat-&gt;u.encoded_video);</a>
<a name="ln774">			return;</a>
<a name="ln775"> </a>
<a name="ln776">		default:</a>
<a name="ln777">			ERROR(&quot;media_format::SpecializeTo can't specialize format &quot;</a>
<a name="ln778">				&quot;type %d\n&quot;, type);</a>
<a name="ln779">	}</a>
<a name="ln780">}</a>
<a name="ln781"> </a>
<a name="ln782"> </a>
<a name="ln783">status_t</a>
<a name="ln784">media_format::SetMetaData(const void* data, size_t size)</a>
<a name="ln785">{</a>
<a name="ln786">	if (!data || size &gt; META_DATA_MAX_SIZE)</a>
<a name="ln787">		return B_BAD_VALUE;</a>
<a name="ln788"> </a>
<a name="ln789">	void* new_addr;</a>
<a name="ln790">	area_id new_area;</a>
<a name="ln791">	if (size &lt; META_DATA_AREA_MIN_SIZE) {</a>
<a name="ln792">		new_area = B_BAD_VALUE;</a>
<a name="ln793">		new_addr = malloc(size);</a>
<a name="ln794">		if (!new_addr)</a>
<a name="ln795">			return B_NO_MEMORY;</a>
<a name="ln796">	} else {</a>
<a name="ln797">		new_area = create_area(&quot;meta_data_area&quot;, &amp;new_addr, B_ANY_ADDRESS,</a>
<a name="ln798">			ROUND_UP_TO_PAGE(size), B_NO_LOCK, B_READ_AREA | B_WRITE_AREA);</a>
<a name="ln799">		if (new_area &lt; 0)</a>
<a name="ln800">			return (status_t)new_area;</a>
<a name="ln801">	}</a>
<a name="ln802"> </a>
<a name="ln803">	if (meta_data_area &gt; 0)</a>
<a name="ln804">		delete_area(meta_data_area);</a>
<a name="ln805">	else</a>
<a name="ln806">		free(meta_data);</a>
<a name="ln807"> </a>
<a name="ln808">	meta_data = new_addr;</a>
<a name="ln809">	meta_data_size = size;</a>
<a name="ln810">	meta_data_area = new_area;</a>
<a name="ln811"> </a>
<a name="ln812">	memcpy(meta_data, data, size);</a>
<a name="ln813"> </a>
<a name="ln814">	if (meta_data_area &gt; 0)</a>
<a name="ln815">		set_area_protection(meta_data_area, B_READ_AREA);</a>
<a name="ln816"> </a>
<a name="ln817">	return B_OK;</a>
<a name="ln818">}</a>
<a name="ln819"> </a>
<a name="ln820"> </a>
<a name="ln821">const void*</a>
<a name="ln822">media_format::MetaData() const</a>
<a name="ln823">{</a>
<a name="ln824">	return meta_data;</a>
<a name="ln825">}</a>
<a name="ln826"> </a>
<a name="ln827"> </a>
<a name="ln828">int32</a>
<a name="ln829">media_format::MetaDataSize() const</a>
<a name="ln830">{</a>
<a name="ln831">	return meta_data_size;</a>
<a name="ln832">}</a>
<a name="ln833"> </a>
<a name="ln834"> </a>
<a name="ln835">void</a>
<a name="ln836">media_format::Unflatten(const char *flatBuffer)</a>
<a name="ln837">{</a>
<a name="ln838">	// TODO: we should not!!! make flat copies of media_format</a>
<a name="ln839">	memcpy(this, flatBuffer, sizeof(*this));</a>
<a name="ln840">	meta_data = NULL;</a>
<a name="ln841">	meta_data_area = B_BAD_VALUE;</a>
<a name="ln842">}</a>
<a name="ln843"> </a>
<a name="ln844"> </a>
<a name="ln845">void</a>
<a name="ln846">media_format::Clear()</a>
<a name="ln847">{</a>
<a name="ln848">	memset(this, 0x00, sizeof(*this));</a>
<a name="ln849">	meta_data = NULL;</a>
<a name="ln850">	meta_data_area = B_BAD_VALUE;</a>
<a name="ln851">}</a>
<a name="ln852"> </a>
<a name="ln853"> </a>
<a name="ln854">media_format::media_format()</a>
<a name="ln855">{</a>
<a name="ln856">	this-&gt;Clear();</a>
<a name="ln857">}</a>
<a name="ln858"> </a>
<a name="ln859"> </a>
<a name="ln860">media_format::media_format(const media_format&amp; other)</a>
<a name="ln861">{</a>
<a name="ln862">	this-&gt;Clear();</a>
<a name="ln863">	*this = other;</a>
<a name="ln864">}</a>
<a name="ln865"> </a>
<a name="ln866"> </a>
<a name="ln867">media_format::~media_format()</a>
<a name="ln868">{</a>
<a name="ln869">	if (meta_data_area &gt; 0)</a>
<a name="ln870">		delete_area(meta_data_area);</a>
<a name="ln871">	else</a>
<a name="ln872">		free(meta_data);</a>
<a name="ln873">}</a>
<a name="ln874"> </a>
<a name="ln875"> </a>
<a name="ln876">// final</a>
<a name="ln877">media_format&amp;</a>
<a name="ln878">media_format::operator=(const media_format&amp; clone)</a>
<a name="ln879">{</a>
<a name="ln880">	// get rid of this format's meta data</a>
<a name="ln881">	this-&gt;~media_format();</a>
<a name="ln882">		// danger: using only ~media_format() would call the constructor</a>
<a name="ln883"> </a>
<a name="ln884">	// make a binary copy</a>
<a name="ln885">	memcpy(this, &amp;clone, sizeof(*this));</a>
<a name="ln886">	// some binary copies are invalid:</a>
<a name="ln887">	meta_data = NULL;</a>
<a name="ln888">	meta_data_area = B_BAD_VALUE;</a>
<a name="ln889"> </a>
<a name="ln890">	// clone or copy the meta data</a>
<a name="ln891">	if (clone.meta_data) {</a>
<a name="ln892">		if (clone.meta_data_area != B_BAD_VALUE) {</a>
<a name="ln893">			meta_data_area = clone_area(&quot;meta_data_clone_area&quot;, &amp;meta_data,</a>
<a name="ln894">				B_ANY_ADDRESS, B_READ_AREA, clone.meta_data_area);</a>
<a name="ln895">			if (meta_data_area &lt; 0) {</a>
<a name="ln896">				// whoops, we just lost our meta data</a>
<a name="ln897">				meta_data = NULL;</a>
<a name="ln898">				meta_data_size = 0;</a>
<a name="ln899">			}</a>
<a name="ln900">		} else {</a>
<a name="ln901">			meta_data = malloc(meta_data_size);</a>
<a name="ln902">			if (meta_data) {</a>
<a name="ln903">				memcpy(meta_data, clone.meta_data, meta_data_size);</a>
<a name="ln904">			} else {</a>
<a name="ln905">				// whoops, we just lost our meta data</a>
<a name="ln906">				meta_data_size = 0;</a>
<a name="ln907">			}</a>
<a name="ln908">		}</a>
<a name="ln909">	}</a>
<a name="ln910">	return *this;</a>
<a name="ln911">}</a>
<a name="ln912"> </a>
<a name="ln913"> </a>
<a name="ln914">// #pragma mark -</a>
<a name="ln915"> </a>
<a name="ln916"> </a>
<a name="ln917">bool</a>
<a name="ln918">operator==(const media_raw_audio_format&amp; a, const media_raw_audio_format&amp; b)</a>
<a name="ln919">{</a>
<a name="ln920">	return a.frame_rate == b.frame_rate</a>
<a name="ln921">		&amp;&amp; a.channel_count == b.channel_count</a>
<a name="ln922">		&amp;&amp; a.format == b.format</a>
<a name="ln923">		&amp;&amp; a.byte_order == b.byte_order</a>
<a name="ln924">		&amp;&amp; a.buffer_size == b.buffer_size;</a>
<a name="ln925">}</a>
<a name="ln926"> </a>
<a name="ln927"> </a>
<a name="ln928">bool</a>
<a name="ln929">operator==(const media_multi_audio_info&amp; a, const media_multi_audio_info&amp; b)</a>
<a name="ln930">{</a>
<a name="ln931">	return a.channel_mask == b.channel_mask</a>
<a name="ln932">		&amp;&amp; a.valid_bits == b.valid_bits</a>
<a name="ln933">		&amp;&amp; a.matrix_mask == b.matrix_mask;</a>
<a name="ln934">}</a>
<a name="ln935"> </a>
<a name="ln936"> </a>
<a name="ln937">bool</a>
<a name="ln938">operator==(const media_multi_audio_format&amp; a,</a>
<a name="ln939">	const media_multi_audio_format&amp; b)</a>
<a name="ln940">{</a>
<a name="ln941">	return (media_raw_audio_format)a == (media_raw_audio_format)b</a>
<a name="ln942">		&amp;&amp; (media_multi_audio_info)a == (media_multi_audio_info)b;</a>
<a name="ln943">}</a>
<a name="ln944"> </a>
<a name="ln945"> </a>
<a name="ln946">bool</a>
<a name="ln947">operator==(const media_encoded_audio_format&amp; a,</a>
<a name="ln948">	const media_encoded_audio_format&amp; b)</a>
<a name="ln949">{</a>
<a name="ln950">	return a.output == b.output</a>
<a name="ln951">		&amp;&amp; a.encoding == b.encoding</a>
<a name="ln952">		&amp;&amp; a.bit_rate == b.bit_rate</a>
<a name="ln953">		&amp;&amp; a.frame_size == b.frame_size</a>
<a name="ln954">		&amp;&amp; a.multi_info == b.multi_info;</a>
<a name="ln955">}</a>
<a name="ln956"> </a>
<a name="ln957"> </a>
<a name="ln958">bool</a>
<a name="ln959">operator==(const media_video_display_info&amp; a,</a>
<a name="ln960">	const media_video_display_info&amp; b)</a>
<a name="ln961">{</a>
<a name="ln962">	return a.format == b.format</a>
<a name="ln963">		&amp;&amp; a.line_width == b.line_width</a>
<a name="ln964">		&amp;&amp; a.line_count == b.line_count</a>
<a name="ln965">		&amp;&amp; a.bytes_per_row == b.bytes_per_row</a>
<a name="ln966">		&amp;&amp; a.pixel_offset == b.pixel_offset</a>
<a name="ln967">		&amp;&amp; a.line_offset == b.line_offset</a>
<a name="ln968">		&amp;&amp; a.flags == b.flags;</a>
<a name="ln969">}</a>
<a name="ln970"> </a>
<a name="ln971"> </a>
<a name="ln972">bool</a>
<a name="ln973">operator==(const media_raw_video_format&amp; a, const media_raw_video_format&amp; b)</a>
<a name="ln974">{</a>
<a name="ln975">	return a.field_rate == b.field_rate</a>
<a name="ln976">		&amp;&amp; a.interlace == b.interlace</a>
<a name="ln977">		&amp;&amp; a.first_active == b.first_active</a>
<a name="ln978">		&amp;&amp; a.last_active == b.last_active</a>
<a name="ln979">		&amp;&amp; a.orientation == b.orientation</a>
<a name="ln980">		&amp;&amp; a.pixel_width_aspect == b.pixel_width_aspect</a>
<a name="ln981">		&amp;&amp; a.pixel_height_aspect == b.pixel_height_aspect</a>
<a name="ln982">		&amp;&amp; a.display == b.display;</a>
<a name="ln983">}</a>
<a name="ln984"> </a>
<a name="ln985"> </a>
<a name="ln986">bool</a>
<a name="ln987">operator==(const media_encoded_video_format&amp; a,</a>
<a name="ln988">	const media_encoded_video_format&amp; b)</a>
<a name="ln989">{</a>
<a name="ln990">	return a.output == b.output</a>
<a name="ln991">		&amp;&amp; a.avg_bit_rate == b.avg_bit_rate</a>
<a name="ln992">		&amp;&amp; a.max_bit_rate == b.max_bit_rate</a>
<a name="ln993">		&amp;&amp; a.encoding == b.encoding</a>
<a name="ln994">		&amp;&amp; a.frame_size == b.frame_size</a>
<a name="ln995">		&amp;&amp; a.forward_history == b.forward_history</a>
<a name="ln996">		&amp;&amp; a.backward_history == b.backward_history;</a>
<a name="ln997">}</a>
<a name="ln998"> </a>
<a name="ln999"> </a>
<a name="ln1000">bool</a>
<a name="ln1001">operator==(const media_multistream_format::vid_info&amp; a,</a>
<a name="ln1002">	const media_multistream_format::vid_info&amp; b)</a>
<a name="ln1003">{</a>
<a name="ln1004">	return a.frame_rate == b.frame_rate</a>
<a name="ln1005">		&amp;&amp; a.width == b.width</a>
<a name="ln1006">		&amp;&amp; a.height == b.height</a>
<a name="ln1007">		&amp;&amp; a.space == b.space</a>
<a name="ln1008">		&amp;&amp; a.sampling_rate == b.sampling_rate</a>
<a name="ln1009">		&amp;&amp; a.sample_format == b.sample_format</a>
<a name="ln1010">		&amp;&amp; a.byte_order == b.byte_order</a>
<a name="ln1011">		&amp;&amp; a.channel_count == b.channel_count;</a>
<a name="ln1012">}</a>
<a name="ln1013"> </a>
<a name="ln1014"> </a>
<a name="ln1015">bool</a>
<a name="ln1016">operator==(const media_multistream_format::avi_info&amp; a,</a>
<a name="ln1017">	const media_multistream_format::avi_info&amp; b)</a>
<a name="ln1018">{</a>
<a name="ln1019">	return a.us_per_frame == b.us_per_frame</a>
<a name="ln1020">		&amp;&amp; a.width == b.width</a>
<a name="ln1021">		&amp;&amp; a.height == b.height</a>
<a name="ln1022">		&amp;&amp; a.type_count == b.type_count</a>
<a name="ln1023">		&amp;&amp; a.types[0] == b.types[0]</a>
<a name="ln1024">		&amp;&amp; a.types[1] == b.types[1]</a>
<a name="ln1025">		&amp;&amp; a.types[2] == b.types[2]</a>
<a name="ln1026">		&amp;&amp; a.types[3] == b.types[3]</a>
<a name="ln1027">		&amp;&amp; a.types[4] == b.types[4];</a>
<a name="ln1028">}</a>
<a name="ln1029"> </a>
<a name="ln1030"> </a>
<a name="ln1031">bool</a>
<a name="ln1032">operator==(const media_multistream_format&amp; a,</a>
<a name="ln1033">	const media_multistream_format&amp; b)</a>
<a name="ln1034">{</a>
<a name="ln1035">	if (a.avg_bit_rate != b.avg_bit_rate</a>
<a name="ln1036">		|| a.max_bit_rate != b.max_bit_rate</a>
<a name="ln1037">		|| a.avg_chunk_size != b.avg_chunk_size</a>
<a name="ln1038">		|| a.max_chunk_size != b.max_chunk_size</a>
<a name="ln1039">		|| a.format != b.format</a>
<a name="ln1040">		|| a.flags != b.flags) {</a>
<a name="ln1041">		return false;</a>
<a name="ln1042">	}</a>
<a name="ln1043"> </a>
<a name="ln1044">	switch (a.format) {</a>
<a name="ln1045">		case media_multistream_format::B_VID:</a>
<a name="ln1046">			return a.u.vid == b.u.vid;</a>
<a name="ln1047"> </a>
<a name="ln1048">		case media_multistream_format::B_AVI:</a>
<a name="ln1049">			return a.u.avi == b.u.avi;</a>
<a name="ln1050"> </a>
<a name="ln1051">		default:</a>
<a name="ln1052">			return true; // TODO: really?</a>
<a name="ln1053">	}</a>
<a name="ln1054">}</a>
<a name="ln1055"> </a>
<a name="ln1056"> </a>
<a name="ln1057">bool</a>
<a name="ln1058">operator==(const media_format&amp; a, const media_format&amp; b)</a>
<a name="ln1059">{</a>
<a name="ln1060">	if (a.type != b.type</a>
<a name="ln1061">		|| a.user_data_type != b.user_data_type</a>
<a name="ln1062">		// TODO: compare user_data[48] ?</a>
<a name="ln1063">		|| a.require_flags != b.require_flags</a>
<a name="ln1064">		|| a.deny_flags != b.deny_flags) {</a>
<a name="ln1065">		return false;</a>
<a name="ln1066">	}</a>
<a name="ln1067"> </a>
<a name="ln1068">	switch (a.type) {</a>
<a name="ln1069">		case B_MEDIA_RAW_AUDIO:</a>
<a name="ln1070">			return a.u.raw_audio == b.u.raw_audio;</a>
<a name="ln1071"> </a>
<a name="ln1072">		case B_MEDIA_RAW_VIDEO:</a>
<a name="ln1073">			return a.u.raw_video == b.u.raw_video;</a>
<a name="ln1074"> </a>
<a name="ln1075">		case B_MEDIA_MULTISTREAM:</a>
<a name="ln1076">			return a.u.multistream == b.u.multistream;</a>
<a name="ln1077"> </a>
<a name="ln1078">		case B_MEDIA_ENCODED_AUDIO:</a>
<a name="ln1079">			return a.u.encoded_audio == b.u.encoded_audio;</a>
<a name="ln1080"> </a>
<a name="ln1081">		case B_MEDIA_ENCODED_VIDEO:</a>
<a name="ln1082">			return a.u.encoded_video == b.u.encoded_video;</a>
<a name="ln1083"> </a>
<a name="ln1084">		default:</a>
<a name="ln1085">			return true; // TODO: really?</a>
<a name="ln1086">	}</a>
<a name="ln1087">}</a>
<a name="ln1088"> </a>
<a name="ln1089"> </a>
<a name="ln1090">// #pragma mark -</a>
<a name="ln1091"> </a>
<a name="ln1092"> </a>
<a name="ln1093">/*! return \c true if a and b are compatible (accounting for wildcards)</a>
<a name="ln1094">	a is the format you want to feed to something accepting b</a>
<a name="ln1095">*/</a>
<a name="ln1096">bool</a>
<a name="ln1097">format_is_compatible(const media_format&amp; a, const media_format&amp; b)</a>
<a name="ln1098">{</a>
<a name="ln1099">	return a.Matches(&amp;b);</a>
<a name="ln1100">}</a>
<a name="ln1101"> </a>
<a name="ln1102"> </a>
<a name="ln1103">bool</a>
<a name="ln1104">string_for_format(const media_format&amp; f, char* buf, size_t size)</a>
<a name="ln1105">{</a>
<a name="ln1106">	char encoding[10]; /* maybe Be wanted to use some 4CCs ? */</a>
<a name="ln1107">	const char* videoOrientation = &quot;0&quot;; /* I'd use &quot;NC&quot;, R5 uses 0. */</a>
<a name="ln1108"> </a>
<a name="ln1109">	if (buf == NULL)</a>
<a name="ln1110">		return false;</a>
<a name="ln1111">	switch (f.type) {</a>
<a name="ln1112">	case B_MEDIA_RAW_AUDIO:</a>
<a name="ln1113">		snprintf(buf, size,</a>
<a name="ln1114">			&quot;raw_audio;%g;%&quot; B_PRIu32 &quot;;0x%&quot; B_PRIx32 &quot;;%&quot; B_PRIu32 &quot;;0x%&quot;</a>
<a name="ln1115">				B_PRIxSIZE &quot;;0x%#&quot; B_PRIx32 &quot;;%d;0x%04x&quot;,</a>
<a name="ln1116">			f.u.raw_audio.frame_rate,</a>
<a name="ln1117">			f.u.raw_audio.channel_count,</a>
<a name="ln1118">			f.u.raw_audio.format,</a>
<a name="ln1119">			f.u.raw_audio.byte_order,</a>
<a name="ln1120">			f.u.raw_audio.buffer_size,</a>
<a name="ln1121">			f.u.raw_audio.channel_mask,</a>
<a name="ln1122">			f.u.raw_audio.valid_bits,</a>
<a name="ln1123">			f.u.raw_audio.matrix_mask);</a>
<a name="ln1124">		return true;</a>
<a name="ln1125">	case B_MEDIA_RAW_VIDEO:</a>
<a name="ln1126">		if (f.u.raw_video.orientation == B_VIDEO_TOP_LEFT_RIGHT)</a>
<a name="ln1127">			videoOrientation = &quot;TopLR&quot;;</a>
<a name="ln1128">		else if (f.u.raw_video.orientation == B_VIDEO_BOTTOM_LEFT_RIGHT)</a>
<a name="ln1129">			videoOrientation = &quot;BotLR&quot;;</a>
<a name="ln1130">		snprintf(buf, size, &quot;raw_video;%g;0x%x;%&quot; B_PRIu32 &quot;;%&quot; B_PRIu32 &quot;;%&quot;</a>
<a name="ln1131">				B_PRIu32 &quot;;%&quot; B_PRIu32 &quot;;%s;%d;%d&quot;,</a>
<a name="ln1132">			f.u.raw_video.field_rate,</a>
<a name="ln1133">			f.u.raw_video.display.format,</a>
<a name="ln1134">			f.u.raw_video.interlace,</a>
<a name="ln1135">			f.u.raw_video.display.line_width,</a>
<a name="ln1136">			f.u.raw_video.display.line_count,</a>
<a name="ln1137">			f.u.raw_video.first_active,</a>
<a name="ln1138">			videoOrientation,</a>
<a name="ln1139">			f.u.raw_video.pixel_width_aspect,</a>
<a name="ln1140">			f.u.raw_video.pixel_height_aspect);</a>
<a name="ln1141">		return true;</a>
<a name="ln1142">	case B_MEDIA_ENCODED_AUDIO:</a>
<a name="ln1143">		snprintf(encoding, 10, &quot;%d&quot;, f.u.encoded_audio.encoding);</a>
<a name="ln1144">		snprintf(buf, size,</a>
<a name="ln1145">			&quot;caudio;%s;%g;%ld;(%g;%&quot; B_PRIu32 &quot;;0x%&quot; B_PRIx32 &quot;;%&quot; B_PRIu32</a>
<a name="ln1146">				&quot;;0x%&quot; B_PRIxSIZE &quot;;0x%08&quot; B_PRIx32 &quot;;%d;0x%04x)&quot;,</a>
<a name="ln1147">			encoding,</a>
<a name="ln1148">			f.u.encoded_audio.bit_rate,</a>
<a name="ln1149">			f.u.encoded_audio.frame_size,</a>
<a name="ln1150">			f.u.encoded_audio.output.frame_rate,</a>
<a name="ln1151">			f.u.encoded_audio.output.channel_count,</a>
<a name="ln1152">			f.u.encoded_audio.output.format,</a>
<a name="ln1153">			f.u.encoded_audio.output.byte_order,</a>
<a name="ln1154">			f.u.encoded_audio.output.buffer_size,</a>
<a name="ln1155">			f.u.encoded_audio.multi_info.channel_mask,</a>
<a name="ln1156">			f.u.encoded_audio.multi_info.valid_bits,</a>
<a name="ln1157">			f.u.encoded_audio.multi_info.matrix_mask);</a>
<a name="ln1158">		return true;</a>
<a name="ln1159">	case B_MEDIA_ENCODED_VIDEO:</a>
<a name="ln1160">		snprintf(encoding, 10, &quot;%d&quot;, f.u.encoded_video.encoding);</a>
<a name="ln1161">		if (f.u.encoded_video.output.orientation == B_VIDEO_TOP_LEFT_RIGHT)</a>
<a name="ln1162">			videoOrientation = &quot;TopLR&quot;;</a>
<a name="ln1163">		else if (f.u.encoded_video.output.orientation == B_VIDEO_BOTTOM_LEFT_RIGHT)</a>
<a name="ln1164">			videoOrientation = &quot;BotLR&quot;;</a>
<a name="ln1165">		snprintf(buf, size,</a>
<a name="ln1166">			&quot;cvideo;%s;%g;%g;%&quot; B_PRIuSIZE &quot;;(%g;0x%x;%&quot; B_PRIu32 &quot;;%&quot; B_PRIu32</a>
<a name="ln1167">				&quot;;%&quot; B_PRIu32 &quot;;%&quot; B_PRIu32 &quot;;%s;%d;%d)&quot;,</a>
<a name="ln1168">			encoding,</a>
<a name="ln1169">			f.u.encoded_video.avg_bit_rate,</a>
<a name="ln1170">			f.u.encoded_video.max_bit_rate,</a>
<a name="ln1171">			f.u.encoded_video.frame_size,</a>
<a name="ln1172">			f.u.encoded_video.output.field_rate,</a>
<a name="ln1173">			f.u.encoded_video.output.display.format,</a>
<a name="ln1174">			f.u.encoded_video.output.interlace,</a>
<a name="ln1175">			f.u.encoded_video.output.display.line_width,</a>
<a name="ln1176">			f.u.encoded_video.output.display.line_count,</a>
<a name="ln1177">			f.u.encoded_video.output.first_active,</a>
<a name="ln1178">			videoOrientation,</a>
<a name="ln1179">			f.u.encoded_video.output.pixel_width_aspect,</a>
<a name="ln1180">			f.u.encoded_video.output.pixel_height_aspect);</a>
<a name="ln1181">		return true;</a>
<a name="ln1182">	default:</a>
<a name="ln1183">		snprintf(buf, size, &quot;%d-&quot;, f.type);</a>
<a name="ln1184">		unsigned char* p = (unsigned char*)&amp;(f.u);</a>
<a name="ln1185">		size -= strlen(buf);</a>
<a name="ln1186">		buf += strlen(buf);</a>
<a name="ln1187">		for (int i = 0; (size &gt; 2) &amp;&amp; (i &lt; 96); i++) {</a>
<a name="ln1188">			snprintf(buf, 3, &quot;%2.2x&quot;, *(p + i));</a>
<a name="ln1189">			buf+=2;</a>
<a name="ln1190">			size-=2;</a>
<a name="ln1191">		}</a>
<a name="ln1192">		return true; // ?</a>
<a name="ln1193">	}</a>
<a name="ln1194">	return false;</a>
<a name="ln1195">}</a>
<a name="ln1196"> </a>
<a name="ln1197"> </a>
<a name="ln1198">// #pragma mark -</a>
<a name="ln1199"> </a>
<a name="ln1200"> </a>
<a name="ln1201">bool</a>
<a name="ln1202">operator==(const media_file_format_id&amp; a, const media_file_format_id&amp; b)</a>
<a name="ln1203">{</a>
<a name="ln1204">	return a.node == b.node &amp;&amp; a.device == b.device</a>
<a name="ln1205">		&amp;&amp; a.internal_id == b.internal_id;</a>
<a name="ln1206">}</a>
<a name="ln1207"> </a>
<a name="ln1208"> </a>
<a name="ln1209">bool</a>
<a name="ln1210">operator&lt;(const media_file_format_id&amp; a, const media_file_format_id&amp; b)</a>
<a name="ln1211">{</a>
<a name="ln1212">	return a.internal_id &lt; b.internal_id;</a>
<a name="ln1213">}</a>
<a name="ln1214"> </a>
<a name="ln1215"> </a>
<a name="ln1216">// #pragma mark -</a>
<a name="ln1217"> </a>
<a name="ln1218"> </a>
<a name="ln1219">//! Use this function to iterate through available file format writers.</a>
<a name="ln1220">status_t</a>
<a name="ln1221">get_next_file_format(int32* cookie, media_file_format* mff)</a>
<a name="ln1222">{</a>
<a name="ln1223">	if (cookie == NULL || mff == NULL)</a>
<a name="ln1224">		return B_BAD_VALUE;</a>
<a name="ln1225"> </a>
<a name="ln1226">	status_t ret = AddOnManager::GetInstance()-&gt;GetFileFormat(mff, *cookie);</a>
<a name="ln1227">	if (ret != B_OK)</a>
<a name="ln1228">		return ret;</a>
<a name="ln1229"> </a>
<a name="ln1230">	*cookie = *cookie + 1;</a>
<a name="ln1231"> </a>
<a name="ln1232">	return B_OK;</a>
<a name="ln1233">}</a>
<a name="ln1234"> </a>
<a name="ln1235"> </a>
<a name="ln1236">// #pragma mark -</a>
<a name="ln1237"> </a>
<a name="ln1238"> </a>
<a name="ln1239">// final &amp; verified</a>
<a name="ln1240">const char* B_MEDIA_SERVER_SIGNATURE = &quot;application/x-vnd.Be.media-server&quot;;</a>
<a name="ln1241">const char* B_MEDIA_ADDON_SERVER_SIGNATURE = &quot;application/x-vnd.Be.addon-host&quot;;</a>
<a name="ln1242"> </a>
<a name="ln1243">const type_code B_CODEC_TYPE_INFO = 0x040807b2;</a>
<a name="ln1244"> </a>
<a name="ln1245"> </a>
<a name="ln1246">// #pragma mark -</a>
<a name="ln1247"> </a>
<a name="ln1248"> </a>
<a name="ln1249">// shutdown_media_server() and launch_media_server()</a>
<a name="ln1250">// are provided by libbe.so in BeOS R5</a>
<a name="ln1251"> </a>
<a name="ln1252">#define MEDIA_SERVICE_NOTIFICATION_ID &quot;MediaServiceNotificationID&quot;</a>
<a name="ln1253"> </a>
<a name="ln1254"> </a>
<a name="ln1255">void</a>
<a name="ln1256">notify_system(float progress, const char* message)</a>
<a name="ln1257">{</a>
<a name="ln1258">	BNotification notification(B_PROGRESS_NOTIFICATION);</a>
<a name="ln1259">	notification.SetMessageID(MEDIA_SERVICE_NOTIFICATION_ID);</a>
<a name="ln1260">	notification.SetProgress(progress);</a>
<a name="ln1261">	notification.SetGroup(B_TRANSLATE(&quot;Media Service&quot;));</a>
<a name="ln1262">	notification.SetContent(message);</a>
<a name="ln1263"> </a>
<a name="ln1264">	app_info info;</a>
<a name="ln1265">	be_app-&gt;GetAppInfo(&amp;info);</a>
<a name="ln1266">	BBitmap icon(BRect(0, 0, 32, 32), B_RGBA32);</a>
<a name="ln1267">	BNode node(&amp;info.ref);</a>
<a name="ln1268">	BIconUtils::GetVectorIcon(&amp;node, &quot;BEOS:ICON&quot;, &amp;icon);</a>
<a name="ln1269">	notification.SetIcon(&amp;icon);</a>
<a name="ln1270"> </a>
<a name="ln1271">	notification.Send();</a>
<a name="ln1272">}</a>
<a name="ln1273"> </a>
<a name="ln1274"> </a>
<a name="ln1275">void</a>
<a name="ln1276">progress_shutdown(int stage,</a>
<a name="ln1277">	bool (*progress)(int stage, const char* message, void* cookie),</a>
<a name="ln1278">	void* cookie)</a>
<a name="ln1279">{</a>
<a name="ln1280">	// parameter &quot;message&quot; is no longer used. It is kept for compatibility with</a>
<a name="ln1281">	// BeOS as this is used as a shutdown_media_server callback.</a>
<a name="ln1282"> </a>
<a name="ln1283">	TRACE(&quot;stage: %i\n&quot;, stage);</a>
<a name="ln1284">	const char* string = &quot;Unknown stage&quot;;</a>
<a name="ln1285">	switch (stage) {</a>
<a name="ln1286">		case 10:</a>
<a name="ln1287">			string = B_TRANSLATE(&quot;Stopping media server&quot; B_UTF8_ELLIPSIS);</a>
<a name="ln1288">			break;</a>
<a name="ln1289">		case 20:</a>
<a name="ln1290">			string = B_TRANSLATE(&quot;Waiting for media_server to quit.&quot;);</a>
<a name="ln1291">			break;</a>
<a name="ln1292">		case 40:</a>
<a name="ln1293">			string = B_TRANSLATE(&quot;Telling media_addon_server to quit.&quot;);</a>
<a name="ln1294">			break;</a>
<a name="ln1295">		case 50:</a>
<a name="ln1296">			string = B_TRANSLATE(&quot;Waiting for media_addon_server to quit.&quot;);</a>
<a name="ln1297">			break;</a>
<a name="ln1298">		case 70:</a>
<a name="ln1299">			string = B_TRANSLATE(&quot;Cleaning up.&quot;);</a>
<a name="ln1300">			break;</a>
<a name="ln1301">		case 100:</a>
<a name="ln1302">			string = B_TRANSLATE(&quot;Done shutting down.&quot;);</a>
<a name="ln1303">			break;</a>
<a name="ln1304">	}</a>
<a name="ln1305"> </a>
<a name="ln1306">	if (progress == NULL)</a>
<a name="ln1307">		notify_system(stage / 100.0f, string);</a>
<a name="ln1308">	else</a>
<a name="ln1309">		progress(stage, string, cookie);</a>
<a name="ln1310">}</a>
<a name="ln1311"> </a>
<a name="ln1312"> </a>
<a name="ln1313">status_t</a>
<a name="ln1314">shutdown_media_server(bigtime_t timeout,</a>
<a name="ln1315">	bool (*progress)(int stage, const char* message, void* cookie),</a>
<a name="ln1316">	void* cookie)</a>
<a name="ln1317">{</a>
<a name="ln1318">	BMessage msg(B_QUIT_REQUESTED);</a>
<a name="ln1319">	status_t err = B_MEDIA_SYSTEM_FAILURE;</a>
<a name="ln1320">	bool shutdown = false;</a>
<a name="ln1321"> </a>
<a name="ln1322">	BMediaRoster* roster = BMediaRoster::Roster(&amp;err);</a>
<a name="ln1323">	if (roster == NULL || err != B_OK)</a>
<a name="ln1324">		return err;</a>
<a name="ln1325"> </a>
<a name="ln1326">	if (progress == NULL &amp;&amp; roster-&gt;Lock()) {</a>
<a name="ln1327">		MediaRosterEx(roster)-&gt;EnableLaunchNotification(true, true);</a>
<a name="ln1328">		roster-&gt;Unlock();</a>
<a name="ln1329">	}</a>
<a name="ln1330"> </a>
<a name="ln1331">	if ((err = msg.AddBool(&quot;be:_user_request&quot;, true)) != B_OK)</a>
<a name="ln1332">		return err;</a>
<a name="ln1333"> </a>
<a name="ln1334">	team_id mediaServer = be_roster-&gt;TeamFor(B_MEDIA_SERVER_SIGNATURE);</a>
<a name="ln1335">	team_id addOnServer = be_roster-&gt;TeamFor(B_MEDIA_ADDON_SERVER_SIGNATURE);</a>
<a name="ln1336"> </a>
<a name="ln1337">	if (mediaServer != B_ERROR) {</a>
<a name="ln1338">		BMessage reply;</a>
<a name="ln1339">		BMessenger messenger(B_MEDIA_SERVER_SIGNATURE, mediaServer);</a>
<a name="ln1340">		progress_shutdown(10, progress, cookie);</a>
<a name="ln1341"> </a>
<a name="ln1342">		err = messenger.SendMessage(&amp;msg, &amp;reply, 2000000, 2000000);</a>
<a name="ln1343">		reply.FindBool(&quot;_shutdown&quot;, &amp;shutdown);</a>
<a name="ln1344">		if (err == B_TIMED_OUT || shutdown == false) {</a>
<a name="ln1345">			if (messenger.IsValid())</a>
<a name="ln1346">				kill_team(mediaServer);</a>
<a name="ln1347">		} else if (err != B_OK)</a>
<a name="ln1348">			return err;</a>
<a name="ln1349"> </a>
<a name="ln1350">		progress_shutdown(20, progress, cookie);</a>
<a name="ln1351"> </a>
<a name="ln1352">		int32 rv;</a>
<a name="ln1353">		if (reply.FindInt32(&quot;error&quot;, &amp;rv) == B_OK &amp;&amp; rv != B_OK)</a>
<a name="ln1354">			return rv;</a>
<a name="ln1355">	}</a>
<a name="ln1356"> </a>
<a name="ln1357">	if (addOnServer != B_ERROR) {</a>
<a name="ln1358">		shutdown = false;</a>
<a name="ln1359">		BMessage reply;</a>
<a name="ln1360">		BMessenger messenger(B_MEDIA_ADDON_SERVER_SIGNATURE, addOnServer);</a>
<a name="ln1361">		progress_shutdown(40, progress, cookie);</a>
<a name="ln1362"> </a>
<a name="ln1363">		// The media_server usually shutdown the media_addon_server,</a>
<a name="ln1364">		// if not let's do something.</a>
<a name="ln1365">		if (messenger.IsValid()) {</a>
<a name="ln1366">			err = messenger.SendMessage(&amp;msg, &amp;reply, 2000000, 2000000);</a>
<a name="ln1367">			reply.FindBool(&quot;_shutdown&quot;, &amp;shutdown);</a>
<a name="ln1368">			if (err == B_TIMED_OUT || shutdown == false) {</a>
<a name="ln1369">				if (messenger.IsValid())</a>
<a name="ln1370">					kill_team(addOnServer);</a>
<a name="ln1371">			} else if (err != B_OK)</a>
<a name="ln1372">				return err;</a>
<a name="ln1373"> </a>
<a name="ln1374">			progress_shutdown(50, progress, cookie);</a>
<a name="ln1375"> </a>
<a name="ln1376">			int32 rv;</a>
<a name="ln1377">			if (reply.FindInt32(&quot;error&quot;, &amp;rv) == B_OK &amp;&amp; rv != B_OK)</a>
<a name="ln1378">				return rv;</a>
<a name="ln1379">		}</a>
<a name="ln1380">	}</a>
<a name="ln1381"> </a>
<a name="ln1382">	progress_shutdown(100, progress, cookie);</a>
<a name="ln1383">	return B_OK;</a>
<a name="ln1384">}</a>
<a name="ln1385"> </a>
<a name="ln1386"> </a>
<a name="ln1387">void</a>
<a name="ln1388">progress_startup(int stage,</a>
<a name="ln1389">	bool (*progress)(int stage, const char* message, void* cookie),</a>
<a name="ln1390">	void* cookie)</a>
<a name="ln1391">{</a>
<a name="ln1392">	// parameter &quot;message&quot; is no longer used. It is kept for compatibility with</a>
<a name="ln1393">	// BeOS as this is used as a shutdown_media_server callback.</a>
<a name="ln1394"> </a>
<a name="ln1395">	TRACE(&quot;stage: %i\n&quot;, stage);</a>
<a name="ln1396">	const char* string = &quot;Unknown stage&quot;;</a>
<a name="ln1397">	switch (stage) {</a>
<a name="ln1398">		case 10:</a>
<a name="ln1399">			string = B_TRANSLATE(&quot;Stopping media server&quot; B_UTF8_ELLIPSIS);</a>
<a name="ln1400">			break;</a>
<a name="ln1401">		case 20:</a>
<a name="ln1402">			string = B_TRANSLATE(&quot;Stopping media_addon_server.&quot;);</a>
<a name="ln1403">			break;</a>
<a name="ln1404">		case 50:</a>
<a name="ln1405">			string = B_TRANSLATE(&quot;Starting media_services.&quot;);</a>
<a name="ln1406">			break;</a>
<a name="ln1407">		case 90:</a>
<a name="ln1408">			string = B_TRANSLATE(&quot;Error occurred starting media services.&quot;);</a>
<a name="ln1409">			break;</a>
<a name="ln1410">		case 100:</a>
<a name="ln1411">			string = B_TRANSLATE(&quot;Ready for use.&quot;);</a>
<a name="ln1412">			break;</a>
<a name="ln1413">	}</a>
<a name="ln1414"> </a>
<a name="ln1415">	if (progress == NULL)</a>
<a name="ln1416">		notify_system(stage / 100.0f, string);</a>
<a name="ln1417">	else</a>
<a name="ln1418">		progress(stage, string, cookie);</a>
<a name="ln1419">}</a>
<a name="ln1420"> </a>
<a name="ln1421"> </a>
<a name="ln1422">status_t</a>
<a name="ln1423">launch_media_server(bigtime_t timeout,</a>
<a name="ln1424">	bool (*progress)(int stage, const char* message, void* cookie),</a>
<a name="ln1425">	void* cookie, uint32 flags)</a>
<a name="ln1426">{</a>
<a name="ln1427">	if (BMediaRoster::IsRunning())</a>
<a name="ln1428">		return B_ALREADY_RUNNING;</a>
<a name="ln1429"> </a>
<a name="ln1430">	status_t err = B_MEDIA_SYSTEM_FAILURE;</a>
<a name="ln1431">	BMediaRoster* roster = BMediaRoster::Roster(&amp;err);</a>
<a name="ln1432">	if (roster == NULL || err != B_OK)</a>
<a name="ln1433">		return err;</a>
<a name="ln1434"> </a>
<a name="ln1435">	if (progress == NULL &amp;&amp; roster-&gt;Lock()) {</a>
<a name="ln1436">		MediaRosterEx(roster)-&gt;EnableLaunchNotification(true, true);</a>
<a name="ln1437">		roster-&gt;Unlock();</a>
<a name="ln1438">	}</a>
<a name="ln1439"> </a>
<a name="ln1440">	// The media_server crashed</a>
<a name="ln1441">	if (be_roster-&gt;IsRunning(B_MEDIA_ADDON_SERVER_SIGNATURE)) {</a>
<a name="ln1442">		progress_startup(10, progress, cookie);</a>
<a name="ln1443">		kill_team(be_roster-&gt;TeamFor(B_MEDIA_ADDON_SERVER_SIGNATURE));</a>
<a name="ln1444">	}</a>
<a name="ln1445"> </a>
<a name="ln1446">	// The media_addon_server crashed</a>
<a name="ln1447">	if (be_roster-&gt;IsRunning(B_MEDIA_SERVER_SIGNATURE)) {</a>
<a name="ln1448">		progress_startup(20, progress, cookie);</a>
<a name="ln1449">		kill_team(be_roster-&gt;TeamFor(B_MEDIA_SERVER_SIGNATURE));</a>
<a name="ln1450">	}</a>
<a name="ln1451"> </a>
<a name="ln1452">	progress_startup(50, progress, cookie);</a>
<a name="ln1453"> </a>
<a name="ln1454">	err = BLaunchRoster().Start(B_MEDIA_SERVER_SIGNATURE);</a>
<a name="ln1455"> </a>
<a name="ln1456">	if (err != B_OK)</a>
<a name="ln1457">		progress_startup(90, progress, cookie);</a>
<a name="ln1458">	else if (progress != NULL) {</a>
<a name="ln1459">		progress_startup(100, progress, cookie);</a>
<a name="ln1460">		err = B_OK;</a>
<a name="ln1461">	}</a>
<a name="ln1462"> </a>
<a name="ln1463">	return err;</a>
<a name="ln1464">}</a>
<a name="ln1465"> </a>
<a name="ln1466"> </a>
<a name="ln1467">// #pragma mark - media_encode_info</a>
<a name="ln1468"> </a>
<a name="ln1469"> </a>
<a name="ln1470">media_encode_info::media_encode_info()</a>
<a name="ln1471">{</a>
<a name="ln1472">	flags = 0;</a>
<a name="ln1473">	used_data_size = 0;</a>
<a name="ln1474">	start_time = 0;</a>
<a name="ln1475">	time_to_encode = INT64_MAX;</a>
<a name="ln1476">	file_format_data = NULL;</a>
<a name="ln1477">	file_format_data_size = 0;</a>
<a name="ln1478">	codec_data = NULL;</a>
<a name="ln1479">	codec_data_size = 0;</a>
<a name="ln1480">}</a>
<a name="ln1481"> </a>
<a name="ln1482"> </a>
<a name="ln1483">media_decode_info::media_decode_info()</a>
<a name="ln1484">{</a>
<a name="ln1485">	time_to_decode = INT64_MAX;</a>
<a name="ln1486">	file_format_data = NULL;</a>
<a name="ln1487">	file_format_data_size = 0;</a>
<a name="ln1488">	codec_data = NULL;</a>
<a name="ln1489">	codec_data_size = 0;</a>
<a name="ln1490">}</a>
<a name="ln1491"> </a>
<a name="ln1492"> </a>

</code></pre>
<div class="balloon" rel="684"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'format->encoding == 0' is always true.</p></div>
<div class="balloon" rel="665"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'format->encoding == 0' is always true.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
