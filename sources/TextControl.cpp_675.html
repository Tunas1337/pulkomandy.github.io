
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>TextControl.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2001-2015, Haiku Inc.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Frans van Nispen (xlr8@tref.nl)</a>
<a name="ln7"> *		Stephan AÃŸmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln8"> *		Ingo Weinhold &lt;bonefish@cs.tu-berlin.de&gt;</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">/*!	BTextControl displays text that can act like a control. */</a>
<a name="ln13"> </a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;TextControl.h&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;string.h&gt;</a>
<a name="ln18"> </a>
<a name="ln19">#include &lt;AbstractLayoutItem.h&gt;</a>
<a name="ln20">#include &lt;ControlLook.h&gt;</a>
<a name="ln21">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln22">#include &lt;Message.h&gt;</a>
<a name="ln23">#include &lt;PropertyInfo.h&gt;</a>
<a name="ln24">#include &lt;Region.h&gt;</a>
<a name="ln25">#include &lt;Window.h&gt;</a>
<a name="ln26"> </a>
<a name="ln27">#include &lt;binary_compatibility/Interface.h&gt;</a>
<a name="ln28">#include &lt;binary_compatibility/Support.h&gt;</a>
<a name="ln29"> </a>
<a name="ln30">#include &quot;TextInput.h&quot;</a>
<a name="ln31"> </a>
<a name="ln32"> </a>
<a name="ln33">//#define TRACE_TEXT_CONTROL</a>
<a name="ln34">#ifdef TRACE_TEXT_CONTROL</a>
<a name="ln35">#	include &lt;stdio.h&gt;</a>
<a name="ln36">#	include &lt;FunctionTracer.h&gt;</a>
<a name="ln37">	static int32 sFunctionDepth = -1;</a>
<a name="ln38">#	define CALLED(x...)	FunctionTracer _ft(&quot;BTextControl&quot;, __FUNCTION__, \</a>
<a name="ln39">							sFunctionDepth)</a>
<a name="ln40">#	define TRACE(x...)	{ BString _to; \</a>
<a name="ln41">							_to.Append(' ', (sFunctionDepth + 1) * 2); \</a>
<a name="ln42">							printf(&quot;%s&quot;, _to.String()); printf(x); }</a>
<a name="ln43">#else</a>
<a name="ln44">#	define CALLED(x...)</a>
<a name="ln45">#	define TRACE(x...)</a>
<a name="ln46">#endif</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">namespace {</a>
<a name="ln50">	const char* const kFrameField = &quot;BTextControl:layoutitem:frame&quot;;</a>
<a name="ln51">	const char* const kTextViewItemField = &quot;BTextControl:textViewItem&quot;;</a>
<a name="ln52">	const char* const kLabelItemField = &quot;BMenuField:labelItem&quot;;</a>
<a name="ln53">}</a>
<a name="ln54"> </a>
<a name="ln55"> </a>
<a name="ln56">static property_info sPropertyList[] = {</a>
<a name="ln57">	{</a>
<a name="ln58">		&quot;Value&quot;,</a>
<a name="ln59">		{ B_GET_PROPERTY, B_SET_PROPERTY },</a>
<a name="ln60">		{ B_DIRECT_SPECIFIER },</a>
<a name="ln61">		NULL, 0,</a>
<a name="ln62">		{ B_STRING_TYPE }</a>
<a name="ln63">	},</a>
<a name="ln64"> </a>
<a name="ln65">	{ 0 }</a>
<a name="ln66">};</a>
<a name="ln67"> </a>
<a name="ln68"> </a>
<a name="ln69">class BTextControl::LabelLayoutItem : public BAbstractLayoutItem {</a>
<a name="ln70">public:</a>
<a name="ln71">								LabelLayoutItem(BTextControl* parent);</a>
<a name="ln72">								LabelLayoutItem(BMessage* from);</a>
<a name="ln73"> </a>
<a name="ln74">	virtual	bool				IsVisible();</a>
<a name="ln75">	virtual	void				SetVisible(bool visible);</a>
<a name="ln76"> </a>
<a name="ln77">	virtual	BRect				Frame();</a>
<a name="ln78">	virtual	void				SetFrame(BRect frame);</a>
<a name="ln79"> </a>
<a name="ln80">			void				SetParent(BTextControl* parent);</a>
<a name="ln81">	virtual	BView*				View();</a>
<a name="ln82"> </a>
<a name="ln83">	virtual	BSize				BaseMinSize();</a>
<a name="ln84">	virtual	BSize				BaseMaxSize();</a>
<a name="ln85">	virtual	BSize				BasePreferredSize();</a>
<a name="ln86">	virtual	BAlignment			BaseAlignment();</a>
<a name="ln87"> </a>
<a name="ln88">			BRect				FrameInParent() const;</a>
<a name="ln89"> </a>
<a name="ln90">	virtual status_t			Archive(BMessage* into, bool deep = true) const;</a>
<a name="ln91">	static	BArchivable*		Instantiate(BMessage* from);</a>
<a name="ln92"> </a>
<a name="ln93">private:</a>
<a name="ln94">			BTextControl*		fParent;</a>
<a name="ln95">			BRect				fFrame;</a>
<a name="ln96">};</a>
<a name="ln97"> </a>
<a name="ln98"> </a>
<a name="ln99">class BTextControl::TextViewLayoutItem : public BAbstractLayoutItem {</a>
<a name="ln100">public:</a>
<a name="ln101">								TextViewLayoutItem(BTextControl* parent);</a>
<a name="ln102">								TextViewLayoutItem(BMessage* from);</a>
<a name="ln103"> </a>
<a name="ln104">	virtual	bool				IsVisible();</a>
<a name="ln105">	virtual	void				SetVisible(bool visible);</a>
<a name="ln106"> </a>
<a name="ln107">	virtual	BRect				Frame();</a>
<a name="ln108">	virtual	void				SetFrame(BRect frame);</a>
<a name="ln109"> </a>
<a name="ln110">			void				SetParent(BTextControl* parent);</a>
<a name="ln111">	virtual	BView*				View();</a>
<a name="ln112"> </a>
<a name="ln113">	virtual	BSize				BaseMinSize();</a>
<a name="ln114">	virtual	BSize				BaseMaxSize();</a>
<a name="ln115">	virtual	BSize				BasePreferredSize();</a>
<a name="ln116">	virtual	BAlignment			BaseAlignment();</a>
<a name="ln117"> </a>
<a name="ln118">			BRect				FrameInParent() const;</a>
<a name="ln119"> </a>
<a name="ln120">	virtual status_t			Archive(BMessage* into, bool deep = true) const;</a>
<a name="ln121">	static	BArchivable*		Instantiate(BMessage* from);</a>
<a name="ln122">private:</a>
<a name="ln123">			BTextControl*		fParent;</a>
<a name="ln124">			BRect				fFrame;</a>
<a name="ln125">};</a>
<a name="ln126"> </a>
<a name="ln127"> </a>
<a name="ln128">struct BTextControl::LayoutData {</a>
<a name="ln129">	LayoutData(float width, float height)</a>
<a name="ln130">		:</a>
<a name="ln131">		label_layout_item(NULL),</a>
<a name="ln132">		text_view_layout_item(NULL),</a>
<a name="ln133">		previous_width(width),</a>
<a name="ln134">		previous_height(height),</a>
<a name="ln135">		valid(false)</a>
<a name="ln136">	{</a>
<a name="ln137">	}</a>
<a name="ln138"> </a>
<a name="ln139">	LabelLayoutItem*	label_layout_item;</a>
<a name="ln140">	TextViewLayoutItem*	text_view_layout_item;</a>
<a name="ln141">	float				previous_width;		// used in FrameResized() for</a>
<a name="ln142">	float				previous_height;	// invalidation</a>
<a name="ln143">	font_height			font_info;</a>
<a name="ln144">	float				label_width;</a>
<a name="ln145">	float				label_height;</a>
<a name="ln146">	BSize				min;</a>
<a name="ln147">	BSize				text_view_min;</a>
<a name="ln148">	bool				valid;</a>
<a name="ln149">};</a>
<a name="ln150"> </a>
<a name="ln151"> </a>
<a name="ln152">static const int32 kFrameMargin = 2;</a>
<a name="ln153">static const int32 kLabelInputSpacing = 3;</a>
<a name="ln154"> </a>
<a name="ln155"> </a>
<a name="ln156">// #pragma mark - BTextControl</a>
<a name="ln157"> </a>
<a name="ln158"> </a>
<a name="ln159">BTextControl::BTextControl(BRect frame, const char* name, const char* label,</a>
<a name="ln160">	const char* text, BMessage* message, uint32 resizeMask, uint32 flags)</a>
<a name="ln161">	:</a>
<a name="ln162">	BControl(frame, name, label, message, resizeMask, flags | B_FRAME_EVENTS)</a>
<a name="ln163">{</a>
<a name="ln164">	_InitData(label);</a>
<a name="ln165">	_InitText(text);</a>
<a name="ln166">	_ValidateLayout();</a>
<a name="ln167">}</a>
<a name="ln168"> </a>
<a name="ln169"> </a>
<a name="ln170">BTextControl::BTextControl(const char* name, const char* label,</a>
<a name="ln171">	const char* text, BMessage* message, uint32 flags)</a>
<a name="ln172">	:</a>
<a name="ln173">	BControl(name, label, message, flags | B_FRAME_EVENTS)</a>
<a name="ln174">{</a>
<a name="ln175">	_InitData(label);</a>
<a name="ln176">	_InitText(text);</a>
<a name="ln177">	_ValidateLayout();</a>
<a name="ln178">}</a>
<a name="ln179"> </a>
<a name="ln180"> </a>
<a name="ln181">BTextControl::BTextControl(const char* label, const char* text,</a>
<a name="ln182">	BMessage* message)</a>
<a name="ln183">	:</a>
<a name="ln184">	BControl(NULL, label, message,</a>
<a name="ln185">		B_WILL_DRAW | B_NAVIGABLE | B_FRAME_EVENTS)</a>
<a name="ln186">{</a>
<a name="ln187">	_InitData(label);</a>
<a name="ln188">	_InitText(text);</a>
<a name="ln189">	_ValidateLayout();</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192"> </a>
<a name="ln193">BTextControl::~BTextControl()</a>
<a name="ln194">{</a>
<a name="ln195">	SetModificationMessage(NULL);</a>
<a name="ln196">	delete fLayoutData;</a>
<a name="ln197">}</a>
<a name="ln198"> </a>
<a name="ln199"> </a>
<a name="ln200">//	#pragma mark - Archiving</a>
<a name="ln201"> </a>
<a name="ln202"> </a>
<a name="ln203">BTextControl::BTextControl(BMessage* archive)</a>
<a name="ln204">	:</a>
<a name="ln205">	BControl(BUnarchiver::PrepareArchive(archive))</a>
<a name="ln206">{</a>
<a name="ln207">	BUnarchiver unarchiver(archive);</a>
<a name="ln208"> </a>
<a name="ln209">	_InitData(Label(), archive);</a>
<a name="ln210"> </a>
<a name="ln211">	if (!BUnarchiver::IsArchiveManaged(archive))</a>
<a name="ln212">		_InitText(NULL, archive);</a>
<a name="ln213"> </a>
<a name="ln214">	status_t err = B_OK;</a>
<a name="ln215">	if (archive-&gt;HasFloat(&quot;_divide&quot;))</a>
<a name="ln216">		err = archive-&gt;FindFloat(&quot;_divide&quot;, &amp;fDivider);</a>
<a name="ln217"> </a>
<a name="ln218">	if (err == B_OK &amp;&amp; archive-&gt;HasMessage(&quot;_mod_msg&quot;)) {</a>
<a name="ln219">		BMessage* message = new BMessage;</a>
<a name="ln220">		err = archive-&gt;FindMessage(&quot;_mod_msg&quot;, message);</a>
<a name="ln221">		SetModificationMessage(message);</a>
<a name="ln222">	}</a>
<a name="ln223"> </a>
<a name="ln224">	unarchiver.Finish(err);</a>
<a name="ln225">}</a>
<a name="ln226"> </a>
<a name="ln227"> </a>
<a name="ln228">BArchivable*</a>
<a name="ln229">BTextControl::Instantiate(BMessage* archive)</a>
<a name="ln230">{</a>
<a name="ln231">	if (validate_instantiation(archive, &quot;BTextControl&quot;))</a>
<a name="ln232">		return new BTextControl(archive);</a>
<a name="ln233"> </a>
<a name="ln234">	return NULL;</a>
<a name="ln235">}</a>
<a name="ln236"> </a>
<a name="ln237"> </a>
<a name="ln238">status_t</a>
<a name="ln239">BTextControl::Archive(BMessage* data, bool deep) const</a>
<a name="ln240">{</a>
<a name="ln241">	BArchiver archiver(data);</a>
<a name="ln242">	status_t result = BControl::Archive(data, deep);</a>
<a name="ln243"> </a>
<a name="ln244">	alignment labelAlignment;</a>
<a name="ln245">	alignment textAlignment;</a>
<a name="ln246">	if (result == B_OK)</a>
<a name="ln247">		GetAlignment(&amp;labelAlignment, &amp;textAlignment);</a>
<a name="ln248"> </a>
<a name="ln249">	if (result == B_OK)</a>
<a name="ln250">		result = data-&gt;AddInt32(&quot;_a_label&quot;, labelAlignment);</a>
<a name="ln251"> </a>
<a name="ln252">	if (result == B_OK)</a>
<a name="ln253">		result = data-&gt;AddInt32(&quot;_a_text&quot;, textAlignment);</a>
<a name="ln254"> </a>
<a name="ln255">	if (result == B_OK)</a>
<a name="ln256">		result = data-&gt;AddFloat(&quot;_divide&quot;, Divider());</a>
<a name="ln257"> </a>
<a name="ln258">	if (result == B_OK &amp;&amp; ModificationMessage() != NULL)</a>
<a name="ln259">		result = data-&gt;AddMessage(&quot;_mod_msg&quot;, ModificationMessage());</a>
<a name="ln260"> </a>
<a name="ln261">	return archiver.Finish(result);</a>
<a name="ln262">}</a>
<a name="ln263"> </a>
<a name="ln264"> </a>
<a name="ln265">status_t</a>
<a name="ln266">BTextControl::AllArchived(BMessage* into) const</a>
<a name="ln267">{</a>
<a name="ln268">	BArchiver archiver(into);</a>
<a name="ln269">	status_t err = B_OK;</a>
<a name="ln270"> </a>
<a name="ln271">	if (archiver.IsArchived(fLayoutData-&gt;text_view_layout_item)) {</a>
<a name="ln272">		err = archiver.AddArchivable(kTextViewItemField,</a>
<a name="ln273">			fLayoutData-&gt;text_view_layout_item);</a>
<a name="ln274">	}</a>
<a name="ln275"> </a>
<a name="ln276">	if (err == B_OK &amp;&amp; archiver.IsArchived(fLayoutData-&gt;label_layout_item)) {</a>
<a name="ln277">		err = archiver.AddArchivable(kLabelItemField,</a>
<a name="ln278">			fLayoutData-&gt;label_layout_item);</a>
<a name="ln279">	}</a>
<a name="ln280"> </a>
<a name="ln281">	return err;</a>
<a name="ln282">}</a>
<a name="ln283"> </a>
<a name="ln284"> </a>
<a name="ln285">status_t</a>
<a name="ln286">BTextControl::AllUnarchived(const BMessage* from)</a>
<a name="ln287">{</a>
<a name="ln288">	status_t err;</a>
<a name="ln289">	if ((err = BControl::AllUnarchived(from)) != B_OK)</a>
<a name="ln290">		return err;</a>
<a name="ln291"> </a>
<a name="ln292">	_InitText(NULL, from);</a>
<a name="ln293"> </a>
<a name="ln294">	BUnarchiver unarchiver(from);</a>
<a name="ln295">	if (unarchiver.IsInstantiated(kTextViewItemField)) {</a>
<a name="ln296">		err = unarchiver.FindObject(kTextViewItemField,</a>
<a name="ln297">			BUnarchiver::B_DONT_ASSUME_OWNERSHIP,</a>
<a name="ln298">			fLayoutData-&gt;text_view_layout_item);</a>
<a name="ln299"> </a>
<a name="ln300">		if (err == B_OK)</a>
<a name="ln301">			fLayoutData-&gt;text_view_layout_item-&gt;SetParent(this);</a>
<a name="ln302">		else</a>
<a name="ln303">			return err;</a>
<a name="ln304">	}</a>
<a name="ln305"> </a>
<a name="ln306">	if (unarchiver.IsInstantiated(kLabelItemField)) {</a>
<a name="ln307">		err = unarchiver.FindObject(kLabelItemField,</a>
<a name="ln308">			BUnarchiver::B_DONT_ASSUME_OWNERSHIP,</a>
<a name="ln309">			fLayoutData-&gt;label_layout_item);</a>
<a name="ln310"> </a>
<a name="ln311">		if (err == B_OK)</a>
<a name="ln312">			fLayoutData-&gt;label_layout_item-&gt;SetParent(this);</a>
<a name="ln313">	}</a>
<a name="ln314">	return err;</a>
<a name="ln315">}</a>
<a name="ln316"> </a>
<a name="ln317"> </a>
<a name="ln318">//	#pragma mark - Hook methods</a>
<a name="ln319"> </a>
<a name="ln320"> </a>
<a name="ln321">void</a>
<a name="ln322">BTextControl::AllAttached()</a>
<a name="ln323">{</a>
<a name="ln324">	BControl::AllAttached();</a>
<a name="ln325">}</a>
<a name="ln326"> </a>
<a name="ln327"> </a>
<a name="ln328">void</a>
<a name="ln329">BTextControl::AllDetached()</a>
<a name="ln330">{</a>
<a name="ln331">	BControl::AllDetached();</a>
<a name="ln332">}</a>
<a name="ln333"> </a>
<a name="ln334"> </a>
<a name="ln335">void</a>
<a name="ln336">BTextControl::AttachedToWindow()</a>
<a name="ln337">{</a>
<a name="ln338">	BControl::AttachedToWindow();</a>
<a name="ln339"> </a>
<a name="ln340">	_UpdateTextViewColors(IsEnabled());</a>
<a name="ln341">	fText-&gt;MakeEditable(IsEnabled());</a>
<a name="ln342">}</a>
<a name="ln343"> </a>
<a name="ln344"> </a>
<a name="ln345">void</a>
<a name="ln346">BTextControl::DetachedFromWindow()</a>
<a name="ln347">{</a>
<a name="ln348">	BControl::DetachedFromWindow();</a>
<a name="ln349">}</a>
<a name="ln350"> </a>
<a name="ln351"> </a>
<a name="ln352">void</a>
<a name="ln353">BTextControl::Draw(BRect updateRect)</a>
<a name="ln354">{</a>
<a name="ln355">	bool enabled = IsEnabled();</a>
<a name="ln356">	bool active = fText-&gt;IsFocus() &amp;&amp; Window()-&gt;IsActive();</a>
<a name="ln357"> </a>
<a name="ln358">	BRect rect = fText-&gt;Frame();</a>
<a name="ln359">	rect.InsetBy(-2, -2);</a>
<a name="ln360"> </a>
<a name="ln361">	rgb_color base = ViewColor();</a>
<a name="ln362">	uint32 flags = fLook;</a>
<a name="ln363">	if (!enabled)</a>
<a name="ln364">		flags |= BControlLook::B_DISABLED;</a>
<a name="ln365"> </a>
<a name="ln366">	if (active)</a>
<a name="ln367">		flags |= BControlLook::B_FOCUSED;</a>
<a name="ln368"> </a>
<a name="ln369">	be_control_look-&gt;DrawTextControlBorder(this, rect, updateRect, base,</a>
<a name="ln370">		flags);</a>
<a name="ln371"> </a>
<a name="ln372">	if (Label() != NULL) {</a>
<a name="ln373">		if (fLayoutData-&gt;label_layout_item != NULL) {</a>
<a name="ln374">			rect = fLayoutData-&gt;label_layout_item-&gt;FrameInParent();</a>
<a name="ln375">		} else {</a>
<a name="ln376">			rect = Bounds();</a>
<a name="ln377">			rect.right = fDivider - kLabelInputSpacing;</a>
<a name="ln378">		}</a>
<a name="ln379"> </a>
<a name="ln380">		// erase the is control flag before drawing the label so that the label</a>
<a name="ln381">		// will get drawn using B_PANEL_TEXT_COLOR</a>
<a name="ln382">		flags &amp;= ~BControlLook::B_IS_CONTROL;</a>
<a name="ln383"> </a>
<a name="ln384">		be_control_look-&gt;DrawLabel(this, Label(), rect, updateRect,</a>
<a name="ln385">			base, flags, BAlignment(fLabelAlign, B_ALIGN_MIDDLE));</a>
<a name="ln386">	}</a>
<a name="ln387">}</a>
<a name="ln388"> </a>
<a name="ln389"> </a>
<a name="ln390">void</a>
<a name="ln391">BTextControl::FrameMoved(BPoint newPosition)</a>
<a name="ln392">{</a>
<a name="ln393">	BControl::FrameMoved(newPosition);</a>
<a name="ln394">}</a>
<a name="ln395"> </a>
<a name="ln396"> </a>
<a name="ln397">void</a>
<a name="ln398">BTextControl::FrameResized(float width, float height)</a>
<a name="ln399">{</a>
<a name="ln400">	CALLED();</a>
<a name="ln401"> </a>
<a name="ln402">	BControl::FrameResized(width, height);</a>
<a name="ln403"> </a>
<a name="ln404">	// TODO: this causes flickering still...</a>
<a name="ln405"> </a>
<a name="ln406">	// changes in width</a>
<a name="ln407"> </a>
<a name="ln408">	BRect bounds = Bounds();</a>
<a name="ln409"> </a>
<a name="ln410">	if (bounds.Width() &gt; fLayoutData-&gt;previous_width) {</a>
<a name="ln411">		// invalidate the region between the old and the new right border</a>
<a name="ln412">		BRect rect = bounds;</a>
<a name="ln413">		rect.left += fLayoutData-&gt;previous_width - kFrameMargin;</a>
<a name="ln414">		rect.right--;</a>
<a name="ln415">		Invalidate(rect);</a>
<a name="ln416">	} else if (bounds.Width() &lt; fLayoutData-&gt;previous_width) {</a>
<a name="ln417">		// invalidate the region of the new right border</a>
<a name="ln418">		BRect rect = bounds;</a>
<a name="ln419">		rect.left = rect.right - kFrameMargin;</a>
<a name="ln420">		Invalidate(rect);</a>
<a name="ln421">	}</a>
<a name="ln422"> </a>
<a name="ln423">	// changes in height</a>
<a name="ln424"> </a>
<a name="ln425">	if (bounds.Height() &gt; fLayoutData-&gt;previous_height) {</a>
<a name="ln426">		// invalidate the region between the old and the new bottom border</a>
<a name="ln427">		BRect rect = bounds;</a>
<a name="ln428">		rect.top += fLayoutData-&gt;previous_height - kFrameMargin;</a>
<a name="ln429">		rect.bottom--;</a>
<a name="ln430">		Invalidate(rect);</a>
<a name="ln431">		// invalidate label area</a>
<a name="ln432">		rect = bounds;</a>
<a name="ln433">		rect.right = fDivider;</a>
<a name="ln434">		Invalidate(rect);</a>
<a name="ln435">	} else if (bounds.Height() &lt; fLayoutData-&gt;previous_height) {</a>
<a name="ln436">		// invalidate the region of the new bottom border</a>
<a name="ln437">		BRect rect = bounds;</a>
<a name="ln438">		rect.top = rect.bottom - kFrameMargin;</a>
<a name="ln439">		Invalidate(rect);</a>
<a name="ln440">		// invalidate label area</a>
<a name="ln441">		rect = bounds;</a>
<a name="ln442">		rect.right = fDivider;</a>
<a name="ln443">		Invalidate(rect);</a>
<a name="ln444">	}</a>
<a name="ln445"> </a>
<a name="ln446">	fLayoutData-&gt;previous_width = bounds.Width();</a>
<a name="ln447">	fLayoutData-&gt;previous_height = bounds.Height();</a>
<a name="ln448"> </a>
<a name="ln449">	TRACE(&quot;width: %.2f, height: %.2f\n&quot;, bounds.Width(), bounds.Height());</a>
<a name="ln450">}</a>
<a name="ln451"> </a>
<a name="ln452"> </a>
<a name="ln453">status_t</a>
<a name="ln454">BTextControl::Invoke(BMessage* message)</a>
<a name="ln455">{</a>
<a name="ln456">	return BControl::Invoke(message);</a>
<a name="ln457">}</a>
<a name="ln458"> </a>
<a name="ln459"> </a>
<a name="ln460">void</a>
<a name="ln461">BTextControl::LayoutInvalidated(bool descendants)</a>
<a name="ln462">{</a>
<a name="ln463">	CALLED();</a>
<a name="ln464"> </a>
<a name="ln465">	fLayoutData-&gt;valid = false;</a>
<a name="ln466">}</a>
<a name="ln467"> </a>
<a name="ln468"> </a>
<a name="ln469">void</a>
<a name="ln470">BTextControl::MessageReceived(BMessage* message)</a>
<a name="ln471">{</a>
<a name="ln472">	if (message-&gt;what == B_COLORS_UPDATED) {</a>
<a name="ln473"> </a>
<a name="ln474">		if (message-&gt;HasColor(ui_color_name(B_PANEL_BACKGROUND_COLOR))</a>
<a name="ln475">			|| message-&gt;HasColor(ui_color_name(B_PANEL_TEXT_COLOR))</a>
<a name="ln476">			|| message-&gt;HasColor(ui_color_name(B_DOCUMENT_BACKGROUND_COLOR))</a>
<a name="ln477">			|| message-&gt;HasColor(ui_color_name(B_DOCUMENT_TEXT_COLOR))) {</a>
<a name="ln478">			_UpdateTextViewColors(IsEnabled());</a>
<a name="ln479">		}</a>
<a name="ln480">	}</a>
<a name="ln481"> </a>
<a name="ln482">	if (message-&gt;what == B_GET_PROPERTY || message-&gt;what == B_SET_PROPERTY) {</a>
<a name="ln483">		BMessage reply(B_REPLY);</a>
<a name="ln484">		bool handled = false;</a>
<a name="ln485"> </a>
<a name="ln486">		BMessage specifier;</a>
<a name="ln487">		int32 index;</a>
<a name="ln488">		int32 form;</a>
<a name="ln489">		const char* property;</a>
<a name="ln490">		if (message-&gt;GetCurrentSpecifier(&amp;index, &amp;specifier, &amp;form, &amp;property) == B_OK) {</a>
<a name="ln491">			if (strcmp(property, &quot;Value&quot;) == 0) {</a>
<a name="ln492">				if (message-&gt;what == B_GET_PROPERTY) {</a>
<a name="ln493">					reply.AddString(&quot;result&quot;, fText-&gt;Text());</a>
<a name="ln494">					handled = true;</a>
<a name="ln495">				} else {</a>
<a name="ln496">					const char* value = NULL;</a>
<a name="ln497">					// B_SET_PROPERTY</a>
<a name="ln498">					if (message-&gt;FindString(&quot;data&quot;, &amp;value) == B_OK) {</a>
<a name="ln499">						fText-&gt;SetText(value);</a>
<a name="ln500">						reply.AddInt32(&quot;error&quot;, B_OK);</a>
<a name="ln501">						handled = true;</a>
<a name="ln502">					}</a>
<a name="ln503">				}</a>
<a name="ln504">			}</a>
<a name="ln505">		}</a>
<a name="ln506"> </a>
<a name="ln507">		if (handled) {</a>
<a name="ln508">			message-&gt;SendReply(&amp;reply);</a>
<a name="ln509">			return;</a>
<a name="ln510">		}</a>
<a name="ln511">	}</a>
<a name="ln512"> </a>
<a name="ln513">	BControl::MessageReceived(message);</a>
<a name="ln514">}</a>
<a name="ln515"> </a>
<a name="ln516"> </a>
<a name="ln517">void</a>
<a name="ln518">BTextControl::MouseDown(BPoint where)</a>
<a name="ln519">{</a>
<a name="ln520">	if (!fText-&gt;IsFocus())</a>
<a name="ln521">		fText-&gt;MakeFocus(true);</a>
<a name="ln522">}</a>
<a name="ln523"> </a>
<a name="ln524"> </a>
<a name="ln525">void</a>
<a name="ln526">BTextControl::MouseMoved(BPoint where, uint32 transit,</a>
<a name="ln527">	const BMessage* dragMessage)</a>
<a name="ln528">{</a>
<a name="ln529">	BControl::MouseMoved(where, transit, dragMessage);</a>
<a name="ln530">}</a>
<a name="ln531"> </a>
<a name="ln532"> </a>
<a name="ln533">void</a>
<a name="ln534">BTextControl::MouseUp(BPoint where)</a>
<a name="ln535">{</a>
<a name="ln536">	BControl::MouseUp(where);</a>
<a name="ln537">}</a>
<a name="ln538"> </a>
<a name="ln539"> </a>
<a name="ln540">void</a>
<a name="ln541">BTextControl::WindowActivated(bool active)</a>
<a name="ln542">{</a>
<a name="ln543">	if (fText-&gt;IsFocus()) {</a>
<a name="ln544">		// invalidate to remove/show focus indication</a>
<a name="ln545">		BRect rect = fText-&gt;Frame();</a>
<a name="ln546">		rect.InsetBy(-1, -1);</a>
<a name="ln547">		Invalidate(rect);</a>
<a name="ln548"> </a>
<a name="ln549">		// help out embedded text view which doesn't</a>
<a name="ln550">		// get notified of this</a>
<a name="ln551">		fText-&gt;Invalidate();</a>
<a name="ln552">	}</a>
<a name="ln553">}</a>
<a name="ln554"> </a>
<a name="ln555"> </a>
<a name="ln556">//	#pragma mark - Getters and Setters</a>
<a name="ln557"> </a>
<a name="ln558"> </a>
<a name="ln559">void</a>
<a name="ln560">BTextControl::SetText(const char* text)</a>
<a name="ln561">{</a>
<a name="ln562">	if (InvokeKind() != B_CONTROL_INVOKED)</a>
<a name="ln563">		return;</a>
<a name="ln564"> </a>
<a name="ln565">	CALLED();</a>
<a name="ln566"> </a>
<a name="ln567">	fText-&gt;SetText(text);</a>
<a name="ln568"> </a>
<a name="ln569">	if (fText-&gt;IsFocus()) {</a>
<a name="ln570">		fText-&gt;SetInitialText();</a>
<a name="ln571">		fText-&gt;SelectAll();</a>
<a name="ln572">	}</a>
<a name="ln573"> </a>
<a name="ln574">	fText-&gt;Invalidate();</a>
<a name="ln575">}</a>
<a name="ln576"> </a>
<a name="ln577"> </a>
<a name="ln578">const char*</a>
<a name="ln579">BTextControl::Text() const</a>
<a name="ln580">{</a>
<a name="ln581">	return fText-&gt;Text();</a>
<a name="ln582">}</a>
<a name="ln583"> </a>
<a name="ln584"> </a>
<a name="ln585">int32</a>
<a name="ln586">BTextControl::TextLength() const</a>
<a name="ln587">{</a>
<a name="ln588">	return fText-&gt;TextLength();</a>
<a name="ln589">}</a>
<a name="ln590"> </a>
<a name="ln591"> </a>
<a name="ln592">void</a>
<a name="ln593">BTextControl::MarkAsInvalid(bool invalid)</a>
<a name="ln594">{</a>
<a name="ln595">	uint32 look = fLook;</a>
<a name="ln596"> </a>
<a name="ln597">	if (invalid)</a>
<a name="ln598">		fLook |= BControlLook::B_INVALID;</a>
<a name="ln599">	else</a>
<a name="ln600">		fLook &amp;= ~BControlLook::B_INVALID;</a>
<a name="ln601"> </a>
<a name="ln602">	if (look != fLook)</a>
<a name="ln603">		Invalidate();</a>
<a name="ln604">}</a>
<a name="ln605"> </a>
<a name="ln606"> </a>
<a name="ln607">void</a>
<a name="ln608">BTextControl::SetValue(int32 value)</a>
<a name="ln609">{</a>
<a name="ln610">	BControl::SetValue(value);</a>
<a name="ln611">}</a>
<a name="ln612"> </a>
<a name="ln613"> </a>
<a name="ln614">BTextView*</a>
<a name="ln615">BTextControl::TextView() const</a>
<a name="ln616">{</a>
<a name="ln617">	return fText;</a>
<a name="ln618">}</a>
<a name="ln619"> </a>
<a name="ln620"> </a>
<a name="ln621">void</a>
<a name="ln622">BTextControl::SetModificationMessage(BMessage* message)</a>
<a name="ln623">{</a>
<a name="ln624">	delete fModificationMessage;</a>
<a name="ln625">	fModificationMessage = message;</a>
<a name="ln626">}</a>
<a name="ln627"> </a>
<a name="ln628"> </a>
<a name="ln629">BMessage*</a>
<a name="ln630">BTextControl::ModificationMessage() const</a>
<a name="ln631">{</a>
<a name="ln632">	return fModificationMessage;</a>
<a name="ln633">}</a>
<a name="ln634"> </a>
<a name="ln635"> </a>
<a name="ln636">void</a>
<a name="ln637">BTextControl::SetAlignment(alignment labelAlignment, alignment textAlignment)</a>
<a name="ln638">{</a>
<a name="ln639">	fText-&gt;SetAlignment(textAlignment);</a>
<a name="ln640">	fText-&gt;AlignTextRect();</a>
<a name="ln641"> </a>
<a name="ln642">	if (fLabelAlign != labelAlignment) {</a>
<a name="ln643">		fLabelAlign = labelAlignment;</a>
<a name="ln644">		Invalidate();</a>
<a name="ln645">	}</a>
<a name="ln646">}</a>
<a name="ln647"> </a>
<a name="ln648"> </a>
<a name="ln649">void</a>
<a name="ln650">BTextControl::GetAlignment(alignment* _label, alignment* _text) const</a>
<a name="ln651">{</a>
<a name="ln652">	if (_label != NULL)</a>
<a name="ln653">		*_label = fLabelAlign;</a>
<a name="ln654"> </a>
<a name="ln655">	if (_text != NULL)</a>
<a name="ln656">		*_text = fText-&gt;Alignment();</a>
<a name="ln657">}</a>
<a name="ln658"> </a>
<a name="ln659"> </a>
<a name="ln660">void</a>
<a name="ln661">BTextControl::SetDivider(float position)</a>
<a name="ln662">{</a>
<a name="ln663">	fDivider = floorf(position + 0.5);</a>
<a name="ln664"> </a>
<a name="ln665">	_LayoutTextView();</a>
<a name="ln666"> </a>
<a name="ln667">	if (Window()) {</a>
<a name="ln668">		fText-&gt;Invalidate();</a>
<a name="ln669">		Invalidate();</a>
<a name="ln670">	}</a>
<a name="ln671">}</a>
<a name="ln672"> </a>
<a name="ln673"> </a>
<a name="ln674">float</a>
<a name="ln675">BTextControl::Divider() const</a>
<a name="ln676">{</a>
<a name="ln677">	return fDivider;</a>
<a name="ln678">}</a>
<a name="ln679"> </a>
<a name="ln680"> </a>
<a name="ln681">void</a>
<a name="ln682">BTextControl::MakeFocus(bool state)</a>
<a name="ln683">{</a>
<a name="ln684">	if (state != fText-&gt;IsFocus()) {</a>
<a name="ln685">		fText-&gt;MakeFocus(state);</a>
<a name="ln686"> </a>
<a name="ln687">		if (state)</a>
<a name="ln688">			fText-&gt;SelectAll();</a>
<a name="ln689">	}</a>
<a name="ln690">}</a>
<a name="ln691"> </a>
<a name="ln692"> </a>
<a name="ln693">void</a>
<a name="ln694">BTextControl::SetEnabled(bool enable)</a>
<a name="ln695">{</a>
<a name="ln696">	if (IsEnabled() == enable)</a>
<a name="ln697">		return;</a>
<a name="ln698"> </a>
<a name="ln699">	if (Window() != NULL) {</a>
<a name="ln700">		fText-&gt;MakeEditable(enable);</a>
<a name="ln701">		if (enable)</a>
<a name="ln702">			fText-&gt;SetFlags(fText-&gt;Flags() | B_NAVIGABLE);</a>
<a name="ln703">		else</a>
<a name="ln704">			fText-&gt;SetFlags(fText-&gt;Flags() &amp; ~B_NAVIGABLE);</a>
<a name="ln705"> </a>
<a name="ln706">		_UpdateTextViewColors(enable);</a>
<a name="ln707"> </a>
<a name="ln708">		fText-&gt;Invalidate();</a>
<a name="ln709">		Window()-&gt;UpdateIfNeeded();</a>
<a name="ln710">	}</a>
<a name="ln711"> </a>
<a name="ln712">	BControl::SetEnabled(enable);</a>
<a name="ln713">}</a>
<a name="ln714"> </a>
<a name="ln715"> </a>
<a name="ln716">void</a>
<a name="ln717">BTextControl::GetPreferredSize(float* _width, float* _height)</a>
<a name="ln718">{</a>
<a name="ln719">	CALLED();</a>
<a name="ln720"> </a>
<a name="ln721">	_ValidateLayoutData();</a>
<a name="ln722"> </a>
<a name="ln723">	if (_width) {</a>
<a name="ln724">		float minWidth = fLayoutData-&gt;min.width;</a>
<a name="ln725">		if (Label() == NULL &amp;&amp; !(Flags() &amp; B_SUPPORTS_LAYOUT)) {</a>
<a name="ln726">			// Indeed, only if there is no label! BeOS backwards compatible</a>
<a name="ln727">			// behavior:</a>
<a name="ln728">			minWidth = max_c(minWidth, Bounds().Width());</a>
<a name="ln729">		}</a>
<a name="ln730">		*_width = minWidth;</a>
<a name="ln731">	}</a>
<a name="ln732"> </a>
<a name="ln733">	if (_height)</a>
<a name="ln734">		*_height = fLayoutData-&gt;min.height;</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737"> </a>
<a name="ln738">void</a>
<a name="ln739">BTextControl::ResizeToPreferred()</a>
<a name="ln740">{</a>
<a name="ln741">	BView::ResizeToPreferred();</a>
<a name="ln742"> </a>
<a name="ln743">	fDivider = 0.0;</a>
<a name="ln744">	const char* label = Label();</a>
<a name="ln745">	if (label)</a>
<a name="ln746">		fDivider = ceil(StringWidth(label)) + 2.0;</a>
<a name="ln747"> </a>
<a name="ln748">	_LayoutTextView();</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751"> </a>
<a name="ln752">void</a>
<a name="ln753">BTextControl::SetFlags(uint32 flags)</a>
<a name="ln754">{</a>
<a name="ln755">	// If the textview is navigable, set it to not navigable if needed</a>
<a name="ln756">	// Else if it is not navigable, set it to navigable if needed</a>
<a name="ln757">	if (fText-&gt;Flags() &amp; B_NAVIGABLE) {</a>
<a name="ln758">		if (!(flags &amp; B_NAVIGABLE))</a>
<a name="ln759">			fText-&gt;SetFlags(fText-&gt;Flags() &amp; ~B_NAVIGABLE);</a>
<a name="ln760"> </a>
<a name="ln761">	} else {</a>
<a name="ln762">		if (flags &amp; B_NAVIGABLE)</a>
<a name="ln763">			fText-&gt;SetFlags(fText-&gt;Flags() | B_NAVIGABLE);</a>
<a name="ln764">	}</a>
<a name="ln765"> </a>
<a name="ln766">	// Don't make this one navigable</a>
<a name="ln767">	flags &amp;= ~B_NAVIGABLE;</a>
<a name="ln768"> </a>
<a name="ln769">	BView::SetFlags(flags);</a>
<a name="ln770">}</a>
<a name="ln771"> </a>
<a name="ln772"> </a>
<a name="ln773">//	#pragma mark - Scripting</a>
<a name="ln774"> </a>
<a name="ln775"> </a>
<a name="ln776">BHandler*</a>
<a name="ln777">BTextControl::ResolveSpecifier(BMessage* message, int32 index,</a>
<a name="ln778">	BMessage* specifier, int32 what, const char* property)</a>
<a name="ln779">{</a>
<a name="ln780">	BPropertyInfo propInfo(sPropertyList);</a>
<a name="ln781"> </a>
<a name="ln782">	if (propInfo.FindMatch(message, 0, specifier, what, property) &gt;= B_OK)</a>
<a name="ln783">		return this;</a>
<a name="ln784"> </a>
<a name="ln785">	return BControl::ResolveSpecifier(message, index, specifier, what,</a>
<a name="ln786">		property);</a>
<a name="ln787">}</a>
<a name="ln788"> </a>
<a name="ln789"> </a>
<a name="ln790">status_t</a>
<a name="ln791">BTextControl::GetSupportedSuites(BMessage* data)</a>
<a name="ln792">{</a>
<a name="ln793">	return BControl::GetSupportedSuites(data);</a>
<a name="ln794">}</a>
<a name="ln795"> </a>
<a name="ln796"> </a>
<a name="ln797">//	#pragma mark - Layout</a>
<a name="ln798"> </a>
<a name="ln799"> </a>
<a name="ln800">BSize</a>
<a name="ln801">BTextControl::MinSize()</a>
<a name="ln802">{</a>
<a name="ln803">	CALLED();</a>
<a name="ln804"> </a>
<a name="ln805">	_ValidateLayoutData();</a>
<a name="ln806">	return BLayoutUtils::ComposeSize(ExplicitMinSize(), fLayoutData-&gt;min);</a>
<a name="ln807">}</a>
<a name="ln808"> </a>
<a name="ln809"> </a>
<a name="ln810">BSize</a>
<a name="ln811">BTextControl::MaxSize()</a>
<a name="ln812">{</a>
<a name="ln813">	CALLED();</a>
<a name="ln814"> </a>
<a name="ln815">	_ValidateLayoutData();</a>
<a name="ln816"> </a>
<a name="ln817">	BSize max = fLayoutData-&gt;min;</a>
<a name="ln818">	max.width = B_SIZE_UNLIMITED;</a>
<a name="ln819"> </a>
<a name="ln820">	return BLayoutUtils::ComposeSize(ExplicitMaxSize(), max);</a>
<a name="ln821">}</a>
<a name="ln822"> </a>
<a name="ln823"> </a>
<a name="ln824">BSize</a>
<a name="ln825">BTextControl::PreferredSize()</a>
<a name="ln826">{</a>
<a name="ln827">	CALLED();</a>
<a name="ln828"> </a>
<a name="ln829">	_ValidateLayoutData();</a>
<a name="ln830">	return BLayoutUtils::ComposeSize(ExplicitPreferredSize(), fLayoutData-&gt;min);</a>
<a name="ln831">}</a>
<a name="ln832"> </a>
<a name="ln833"> </a>
<a name="ln834">BAlignment</a>
<a name="ln835">BTextControl::LayoutAlignment()</a>
<a name="ln836">{</a>
<a name="ln837">	CALLED();</a>
<a name="ln838"> </a>
<a name="ln839">	_ValidateLayoutData();</a>
<a name="ln840">	return BLayoutUtils::ComposeAlignment(ExplicitAlignment(),</a>
<a name="ln841">		BAlignment(B_ALIGN_LEFT, B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln842">}</a>
<a name="ln843"> </a>
<a name="ln844"> </a>
<a name="ln845">BLayoutItem*</a>
<a name="ln846">BTextControl::CreateLabelLayoutItem()</a>
<a name="ln847">{</a>
<a name="ln848">	if (!fLayoutData-&gt;label_layout_item)</a>
<a name="ln849">		fLayoutData-&gt;label_layout_item = new LabelLayoutItem(this);</a>
<a name="ln850"> </a>
<a name="ln851">	return fLayoutData-&gt;label_layout_item;</a>
<a name="ln852">}</a>
<a name="ln853"> </a>
<a name="ln854"> </a>
<a name="ln855">BLayoutItem*</a>
<a name="ln856">BTextControl::CreateTextViewLayoutItem()</a>
<a name="ln857">{</a>
<a name="ln858">	if (!fLayoutData-&gt;text_view_layout_item)</a>
<a name="ln859">		fLayoutData-&gt;text_view_layout_item = new TextViewLayoutItem(this);</a>
<a name="ln860"> </a>
<a name="ln861">	return fLayoutData-&gt;text_view_layout_item;</a>
<a name="ln862">}</a>
<a name="ln863"> </a>
<a name="ln864"> </a>
<a name="ln865">void</a>
<a name="ln866">BTextControl::DoLayout()</a>
<a name="ln867">{</a>
<a name="ln868">	// Bail out, if we shan't do layout.</a>
<a name="ln869">	if (!(Flags() &amp; B_SUPPORTS_LAYOUT))</a>
<a name="ln870">		return;</a>
<a name="ln871"> </a>
<a name="ln872">	CALLED();</a>
<a name="ln873"> </a>
<a name="ln874">	// If the user set a layout, we let the base class version call its</a>
<a name="ln875">	// hook.</a>
<a name="ln876">	if (GetLayout()) {</a>
<a name="ln877">		BView::DoLayout();</a>
<a name="ln878">		return;</a>
<a name="ln879">	}</a>
<a name="ln880"> </a>
<a name="ln881">	_ValidateLayoutData();</a>
<a name="ln882"> </a>
<a name="ln883">	// validate current size</a>
<a name="ln884">	BSize size(Bounds().Size());</a>
<a name="ln885">	if (size.width &lt; fLayoutData-&gt;min.width)</a>
<a name="ln886">		size.width = fLayoutData-&gt;min.width;</a>
<a name="ln887"> </a>
<a name="ln888">	if (size.height &lt; fLayoutData-&gt;min.height)</a>
<a name="ln889">		size.height = fLayoutData-&gt;min.height;</a>
<a name="ln890"> </a>
<a name="ln891">	BRect dirty(fText-&gt;Frame());</a>
<a name="ln892">	BRect textFrame;</a>
<a name="ln893"> </a>
<a name="ln894">	// divider</a>
<a name="ln895">	float divider = 0;</a>
<a name="ln896">	if (fLayoutData-&gt;text_view_layout_item != NULL) {</a>
<a name="ln897">		if (fLayoutData-&gt;label_layout_item != NULL) {</a>
<a name="ln898">			// We have layout items. They define the divider location.</a>
<a name="ln899">			divider = fabs(fLayoutData-&gt;text_view_layout_item-&gt;Frame().left</a>
<a name="ln900">				- fLayoutData-&gt;label_layout_item-&gt;Frame().left);</a>
<a name="ln901">		}</a>
<a name="ln902">		textFrame = fLayoutData-&gt;text_view_layout_item-&gt;FrameInParent();</a>
<a name="ln903">	} else {</a>
<a name="ln904">		if (fLayoutData-&gt;label_width &gt; 0) {</a>
<a name="ln905">			divider = fLayoutData-&gt;label_width</a>
<a name="ln906">				+ be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln907">		}</a>
<a name="ln908">		textFrame.Set(divider, 0, size.width, size.height);</a>
<a name="ln909">	}</a>
<a name="ln910"> </a>
<a name="ln911">	// place the text view and set the divider</a>
<a name="ln912">	textFrame.InsetBy(kFrameMargin, kFrameMargin);</a>
<a name="ln913">	BLayoutUtils::AlignInFrame(fText, textFrame);</a>
<a name="ln914"> </a>
<a name="ln915">	fDivider = divider;</a>
<a name="ln916"> </a>
<a name="ln917">	// invalidate dirty region</a>
<a name="ln918">	dirty = dirty | fText-&gt;Frame();</a>
<a name="ln919">	dirty.InsetBy(-kFrameMargin, -kFrameMargin);</a>
<a name="ln920"> </a>
<a name="ln921">	Invalidate(dirty);</a>
<a name="ln922">}</a>
<a name="ln923"> </a>
<a name="ln924"> </a>
<a name="ln925">// #pragma mark - protected methods</a>
<a name="ln926"> </a>
<a name="ln927"> </a>
<a name="ln928">status_t</a>
<a name="ln929">BTextControl::SetIcon(const BBitmap* icon, uint32 flags)</a>
<a name="ln930">{</a>
<a name="ln931">	return BControl::SetIcon(icon, flags);</a>
<a name="ln932">}</a>
<a name="ln933"> </a>
<a name="ln934"> </a>
<a name="ln935">// #pragma mark - private methods</a>
<a name="ln936"> </a>
<a name="ln937"> </a>
<a name="ln938">status_t</a>
<a name="ln939">BTextControl::Perform(perform_code code, void* _data)</a>
<a name="ln940">{</a>
<a name="ln941">	switch (code) {</a>
<a name="ln942">		case PERFORM_CODE_MIN_SIZE:</a>
<a name="ln943">			((perform_data_min_size*)_data)-&gt;return_value</a>
<a name="ln944">				= BTextControl::MinSize();</a>
<a name="ln945">			return B_OK;</a>
<a name="ln946"> </a>
<a name="ln947">		case PERFORM_CODE_MAX_SIZE:</a>
<a name="ln948">			((perform_data_max_size*)_data)-&gt;return_value</a>
<a name="ln949">				= BTextControl::MaxSize();</a>
<a name="ln950">			return B_OK;</a>
<a name="ln951"> </a>
<a name="ln952">		case PERFORM_CODE_PREFERRED_SIZE:</a>
<a name="ln953">			((perform_data_preferred_size*)_data)-&gt;return_value</a>
<a name="ln954">				= BTextControl::PreferredSize();</a>
<a name="ln955">			return B_OK;</a>
<a name="ln956"> </a>
<a name="ln957">		case PERFORM_CODE_LAYOUT_ALIGNMENT:</a>
<a name="ln958">			((perform_data_layout_alignment*)_data)-&gt;return_value</a>
<a name="ln959">				= BTextControl::LayoutAlignment();</a>
<a name="ln960">			return B_OK;</a>
<a name="ln961"> </a>
<a name="ln962">		case PERFORM_CODE_HAS_HEIGHT_FOR_WIDTH:</a>
<a name="ln963">			((perform_data_has_height_for_width*)_data)-&gt;return_value</a>
<a name="ln964">				= BTextControl::HasHeightForWidth();</a>
<a name="ln965">			return B_OK;</a>
<a name="ln966"> </a>
<a name="ln967">		case PERFORM_CODE_GET_HEIGHT_FOR_WIDTH:</a>
<a name="ln968">		{</a>
<a name="ln969">			perform_data_get_height_for_width* data</a>
<a name="ln970">				= (perform_data_get_height_for_width*)_data;</a>
<a name="ln971">			BTextControl::GetHeightForWidth(data-&gt;width, &amp;data-&gt;min, &amp;data-&gt;max,</a>
<a name="ln972">				&amp;data-&gt;preferred);</a>
<a name="ln973">			return B_OK;</a>
<a name="ln974">		}</a>
<a name="ln975"> </a>
<a name="ln976">		case PERFORM_CODE_SET_LAYOUT:</a>
<a name="ln977">		{</a>
<a name="ln978">			perform_data_set_layout* data = (perform_data_set_layout*)_data;</a>
<a name="ln979">			BTextControl::SetLayout(data-&gt;layout);</a>
<a name="ln980">			return B_OK;</a>
<a name="ln981">		}</a>
<a name="ln982"> </a>
<a name="ln983">		case PERFORM_CODE_LAYOUT_INVALIDATED:</a>
<a name="ln984">		{</a>
<a name="ln985">			perform_data_layout_invalidated* data</a>
<a name="ln986">				= (perform_data_layout_invalidated*)_data;</a>
<a name="ln987">			BTextControl::LayoutInvalidated(data-&gt;descendants);</a>
<a name="ln988">			return B_OK;</a>
<a name="ln989">		}</a>
<a name="ln990"> </a>
<a name="ln991">		case PERFORM_CODE_DO_LAYOUT:</a>
<a name="ln992">		{</a>
<a name="ln993">			BTextControl::DoLayout();</a>
<a name="ln994">			return B_OK;</a>
<a name="ln995">		}</a>
<a name="ln996"> </a>
<a name="ln997">		case PERFORM_CODE_SET_ICON:</a>
<a name="ln998">		{</a>
<a name="ln999">			perform_data_set_icon* data = (perform_data_set_icon*)_data;</a>
<a name="ln1000">			return BTextControl::SetIcon(data-&gt;icon, data-&gt;flags);</a>
<a name="ln1001">		}</a>
<a name="ln1002"> </a>
<a name="ln1003">		case PERFORM_CODE_ALL_UNARCHIVED:</a>
<a name="ln1004">		{</a>
<a name="ln1005">			perform_data_all_unarchived* data</a>
<a name="ln1006">				= (perform_data_all_unarchived*)_data;</a>
<a name="ln1007">			data-&gt;return_value = BTextControl::AllUnarchived(data-&gt;archive);</a>
<a name="ln1008">			return B_OK;</a>
<a name="ln1009">		}</a>
<a name="ln1010"> </a>
<a name="ln1011">		case PERFORM_CODE_ALL_ARCHIVED:</a>
<a name="ln1012">		{</a>
<a name="ln1013">			perform_data_all_archived* data</a>
<a name="ln1014">				= (perform_data_all_archived*)_data;</a>
<a name="ln1015">			data-&gt;return_value = BTextControl::AllArchived(data-&gt;archive);</a>
<a name="ln1016">			return B_OK;</a>
<a name="ln1017">		}</a>
<a name="ln1018">	}</a>
<a name="ln1019"> </a>
<a name="ln1020">	return BControl::Perform(code, _data);</a>
<a name="ln1021">}</a>
<a name="ln1022"> </a>
<a name="ln1023"> </a>
<a name="ln1024">//	#pragma mark - FBC padding</a>
<a name="ln1025"> </a>
<a name="ln1026"> </a>
<a name="ln1027">void BTextControl::_ReservedTextControl1() {}</a>
<a name="ln1028">void BTextControl::_ReservedTextControl2() {}</a>
<a name="ln1029">void BTextControl::_ReservedTextControl3() {}</a>
<a name="ln1030">void BTextControl::_ReservedTextControl4() {}</a>
<a name="ln1031"> </a>
<a name="ln1032"> </a>
<a name="ln1033">BTextControl&amp;</a>
<a name="ln1034">BTextControl::operator=(const BTextControl&amp;)</a>
<a name="ln1035">{</a>
<a name="ln1036">	return *this;</a>
<a name="ln1037">}</a>
<a name="ln1038"> </a>
<a name="ln1039"> </a>
<a name="ln1040">void</a>
<a name="ln1041">BTextControl::_UpdateTextViewColors(bool enable)</a>
<a name="ln1042">{</a>
<a name="ln1043">	rgb_color textColor = ui_color(B_DOCUMENT_TEXT_COLOR);</a>
<a name="ln1044">	rgb_color viewColor = ui_color(B_DOCUMENT_BACKGROUND_COLOR);</a>
<a name="ln1045">	BFont font;</a>
<a name="ln1046"> </a>
<a name="ln1047">	fText-&gt;GetFontAndColor(0, &amp;font);</a>
<a name="ln1048"> </a>
<a name="ln1049">	if (!enable) {</a>
<a name="ln1050">		textColor = disable_color(textColor, ViewColor());</a>
<a name="ln1051">		viewColor = disable_color(ViewColor(), viewColor);</a>
<a name="ln1052">	}</a>
<a name="ln1053"> </a>
<a name="ln1054">	fText-&gt;SetFontAndColor(&amp;font, B_FONT_ALL, &amp;textColor);</a>
<a name="ln1055">	fText-&gt;SetViewColor(viewColor);</a>
<a name="ln1056">	fText-&gt;SetLowColor(viewColor);</a>
<a name="ln1057">}</a>
<a name="ln1058"> </a>
<a name="ln1059"> </a>
<a name="ln1060">void</a>
<a name="ln1061">BTextControl::_CommitValue()</a>
<a name="ln1062">{</a>
<a name="ln1063">}</a>
<a name="ln1064"> </a>
<a name="ln1065"> </a>
<a name="ln1066">void</a>
<a name="ln1067">BTextControl::_InitData(const char* label, const BMessage* archive)</a>
<a name="ln1068">{</a>
<a name="ln1069">	BRect bounds(Bounds());</a>
<a name="ln1070"> </a>
<a name="ln1071">	fText = NULL;</a>
<a name="ln1072">	fModificationMessage = NULL;</a>
<a name="ln1073">	fLabelAlign = B_ALIGN_LEFT;</a>
<a name="ln1074">	fDivider = 0.0f;</a>
<a name="ln1075">	fLayoutData = new LayoutData(bounds.Width(), bounds.Height());</a>
<a name="ln1076"> </a>
<a name="ln1077">	int32 flags = 0;</a>
<a name="ln1078"> </a>
<a name="ln1079">	BFont font(be_plain_font);</a>
<a name="ln1080"> </a>
<a name="ln1081">	if (!archive || !archive-&gt;HasString(&quot;_fname&quot;))</a>
<a name="ln1082">		flags |= B_FONT_FAMILY_AND_STYLE;</a>
<a name="ln1083"> </a>
<a name="ln1084">	if (!archive || !archive-&gt;HasFloat(&quot;_fflt&quot;))</a>
<a name="ln1085">		flags |= B_FONT_SIZE;</a>
<a name="ln1086"> </a>
<a name="ln1087">	if (flags != 0)</a>
<a name="ln1088">		SetFont(&amp;font, flags);</a>
<a name="ln1089"> </a>
<a name="ln1090">	if (label != NULL)</a>
<a name="ln1091">		fDivider = floorf(bounds.Width() / 2.0f);</a>
<a name="ln1092"> </a>
<a name="ln1093">	fLook = 0;</a>
<a name="ln1094">}</a>
<a name="ln1095"> </a>
<a name="ln1096"> </a>
<a name="ln1097">void</a>
<a name="ln1098">BTextControl::_InitText(const char* initialText, const BMessage* archive)</a>
<a name="ln1099">{</a>
<a name="ln1100">	if (archive)</a>
<a name="ln1101">		fText = static_cast&lt;BPrivate::_BTextInput_*&gt;(FindView(&quot;_input_&quot;));</a>
<a name="ln1102"> </a>
<a name="ln1103">	if (fText == NULL) {</a>
<a name="ln1104">		BRect bounds(Bounds());</a>
<a name="ln1105">		BRect frame(fDivider, bounds.top, bounds.right, bounds.bottom);</a>
<a name="ln1106">		// we are stroking the frame around the text view, which</a>
<a name="ln1107">		// is 2 pixels wide</a>
<a name="ln1108">		frame.InsetBy(kFrameMargin, kFrameMargin);</a>
<a name="ln1109">		BRect textRect(frame.OffsetToCopy(B_ORIGIN));</a>
<a name="ln1110"> </a>
<a name="ln1111">		fText = new BPrivate::_BTextInput_(frame, textRect,</a>
<a name="ln1112">			B_FOLLOW_ALL, B_WILL_DRAW | B_FRAME_EVENTS</a>
<a name="ln1113">			| (Flags() &amp; B_NAVIGABLE));</a>
<a name="ln1114">		AddChild(fText);</a>
<a name="ln1115"> </a>
<a name="ln1116">		SetText(initialText);</a>
<a name="ln1117">		fText-&gt;SetAlignment(B_ALIGN_LEFT);</a>
<a name="ln1118">		fText-&gt;AlignTextRect();</a>
<a name="ln1119">	}</a>
<a name="ln1120"> </a>
<a name="ln1121">	// Although this is not strictly initializing the text view,</a>
<a name="ln1122">	// it cannot be done while fText is NULL, so it resides here.</a>
<a name="ln1123">	if (archive) {</a>
<a name="ln1124">		int32 labelAlignment = B_ALIGN_LEFT;</a>
<a name="ln1125">		int32 textAlignment = B_ALIGN_LEFT;</a>
<a name="ln1126"> </a>
<a name="ln1127">		status_t err = B_OK;</a>
<a name="ln1128">		if (archive-&gt;HasInt32(&quot;_a_label&quot;))</a>
<a name="ln1129">			err = archive-&gt;FindInt32(&quot;_a_label&quot;, &amp;labelAlignment);</a>
<a name="ln1130"> </a>
<a name="ln1131">		if (err == B_OK &amp;&amp; archive-&gt;HasInt32(&quot;_a_text&quot;))</a>
<a name="ln1132">			err = archive-&gt;FindInt32(&quot;_a_text&quot;, &amp;textAlignment);</a>
<a name="ln1133"> </a>
<a name="ln1134">		SetAlignment((alignment)labelAlignment, (alignment)textAlignment);</a>
<a name="ln1135">	}</a>
<a name="ln1136"> </a>
<a name="ln1137">	uint32 navigableFlags = Flags() &amp; B_NAVIGABLE;</a>
<a name="ln1138">	if (navigableFlags != 0)</a>
<a name="ln1139">		BView::SetFlags(Flags() &amp; ~B_NAVIGABLE);</a>
<a name="ln1140">}</a>
<a name="ln1141"> </a>
<a name="ln1142"> </a>
<a name="ln1143">void</a>
<a name="ln1144">BTextControl::_ValidateLayout()</a>
<a name="ln1145">{</a>
<a name="ln1146">	CALLED();</a>
<a name="ln1147"> </a>
<a name="ln1148">	_ValidateLayoutData();</a>
<a name="ln1149"> </a>
<a name="ln1150">	ResizeTo(Bounds().Width(), fLayoutData-&gt;min.height);</a>
<a name="ln1151"> </a>
<a name="ln1152">	_LayoutTextView();</a>
<a name="ln1153">}</a>
<a name="ln1154"> </a>
<a name="ln1155"> </a>
<a name="ln1156">void</a>
<a name="ln1157">BTextControl::_LayoutTextView()</a>
<a name="ln1158">{</a>
<a name="ln1159">	CALLED();</a>
<a name="ln1160"> </a>
<a name="ln1161">	BRect frame;</a>
<a name="ln1162">	if (fLayoutData-&gt;text_view_layout_item != NULL) {</a>
<a name="ln1163">		frame = fLayoutData-&gt;text_view_layout_item-&gt;FrameInParent();</a>
<a name="ln1164">	} else {</a>
<a name="ln1165">		frame = Bounds();</a>
<a name="ln1166">		frame.left = fDivider;</a>
<a name="ln1167">	}</a>
<a name="ln1168"> </a>
<a name="ln1169">	// we are stroking the frame around the text view, which</a>
<a name="ln1170">	// is 2 pixels wide</a>
<a name="ln1171">	frame.InsetBy(kFrameMargin, kFrameMargin);</a>
<a name="ln1172">	fText-&gt;MoveTo(frame.left, frame.top);</a>
<a name="ln1173">	fText-&gt;ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln1174">	fText-&gt;AlignTextRect();</a>
<a name="ln1175"> </a>
<a name="ln1176">	TRACE(&quot;width: %.2f, height: %.2f\n&quot;, Frame().Width(), Frame().Height());</a>
<a name="ln1177">	TRACE(&quot;fDivider: %.2f\n&quot;, fDivider);</a>
<a name="ln1178">	TRACE(&quot;fText frame: (%.2f, %.2f, %.2f, %.2f)\n&quot;,</a>
<a name="ln1179">		frame.left, frame.top, frame.right, frame.bottom);</a>
<a name="ln1180">}</a>
<a name="ln1181"> </a>
<a name="ln1182"> </a>
<a name="ln1183">void</a>
<a name="ln1184">BTextControl::_UpdateFrame()</a>
<a name="ln1185">{</a>
<a name="ln1186">	CALLED();</a>
<a name="ln1187"> </a>
<a name="ln1188">	if (fLayoutData-&gt;text_view_layout_item != NULL) {</a>
<a name="ln1189">		BRect textFrame = fLayoutData-&gt;text_view_layout_item-&gt;Frame();</a>
<a name="ln1190">		BRect labelFrame;</a>
<a name="ln1191">		if (fLayoutData-&gt;label_layout_item != NULL)</a>
<a name="ln1192">			labelFrame = fLayoutData-&gt;label_layout_item-&gt;Frame();</a>
<a name="ln1193"> </a>
<a name="ln1194">		BRect frame;</a>
<a name="ln1195">		if (labelFrame.IsValid()) {</a>
<a name="ln1196">			frame = textFrame | labelFrame;</a>
<a name="ln1197"> </a>
<a name="ln1198">			// update divider</a>
<a name="ln1199">			fDivider = fabs(textFrame.left - labelFrame.left);</a>
<a name="ln1200">		} else {</a>
<a name="ln1201">			frame = textFrame;</a>
<a name="ln1202">			fDivider = 0;</a>
<a name="ln1203">		}</a>
<a name="ln1204"> </a>
<a name="ln1205">		// update our frame</a>
<a name="ln1206">		MoveTo(frame.left, frame.top);</a>
<a name="ln1207">		BSize oldSize(Bounds().Size());</a>
<a name="ln1208">		ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln1209">		BSize newSize(Bounds().Size());</a>
<a name="ln1210"> </a>
<a name="ln1211">		// If the size changes, ResizeTo() will trigger a relayout, otherwise</a>
<a name="ln1212">		// we need to do that explicitly.</a>
<a name="ln1213">		if (newSize != oldSize)</a>
<a name="ln1214">			Relayout();</a>
<a name="ln1215">	}</a>
<a name="ln1216">}</a>
<a name="ln1217"> </a>
<a name="ln1218"> </a>
<a name="ln1219">void</a>
<a name="ln1220">BTextControl::_ValidateLayoutData()</a>
<a name="ln1221">{</a>
<a name="ln1222">	CALLED();</a>
<a name="ln1223"> </a>
<a name="ln1224">	if (fLayoutData-&gt;valid)</a>
<a name="ln1225">		return;</a>
<a name="ln1226"> </a>
<a name="ln1227">	// cache font height</a>
<a name="ln1228">	font_height&amp; fh = fLayoutData-&gt;font_info;</a>
<a name="ln1229">	GetFontHeight(&amp;fh);</a>
<a name="ln1230"> </a>
<a name="ln1231">	const char* label = Label();</a>
<a name="ln1232">	if (label != NULL) {</a>
<a name="ln1233">		fLayoutData-&gt;label_width = ceilf(StringWidth(label));</a>
<a name="ln1234">		fLayoutData-&gt;label_height = ceilf(fh.ascent) + ceilf(fh.descent);</a>
<a name="ln1235">	} else {</a>
<a name="ln1236">		fLayoutData-&gt;label_width = 0;</a>
<a name="ln1237">		fLayoutData-&gt;label_height = 0;</a>
<a name="ln1238">	}</a>
<a name="ln1239"> </a>
<a name="ln1240">	// compute the minimal divider</a>
<a name="ln1241">	float divider = 0;</a>
<a name="ln1242">	if (fLayoutData-&gt;label_width &gt; 0) {</a>
<a name="ln1243">		divider = fLayoutData-&gt;label_width</a>
<a name="ln1244">			+ be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln1245">	}</a>
<a name="ln1246"> </a>
<a name="ln1247">	// If we shan't do real layout, we let the current divider take influence.</a>
<a name="ln1248">	if (!(Flags() &amp; B_SUPPORTS_LAYOUT))</a>
<a name="ln1249">		divider = max_c(divider, fDivider);</a>
<a name="ln1250"> </a>
<a name="ln1251">	// get the minimal (== preferred) text view size</a>
<a name="ln1252">	fLayoutData-&gt;text_view_min = fText-&gt;MinSize();</a>
<a name="ln1253"> </a>
<a name="ln1254">	TRACE(&quot;text view min width: %.2f\n&quot;, fLayoutData-&gt;text_view_min.width);</a>
<a name="ln1255"> </a>
<a name="ln1256">	// compute our minimal (== preferred) size</a>
<a name="ln1257">	BSize min(fLayoutData-&gt;text_view_min);</a>
<a name="ln1258">	min.width += 2 * kFrameMargin;</a>
<a name="ln1259">	min.height += 2 * kFrameMargin;</a>
<a name="ln1260"> </a>
<a name="ln1261">	if (divider &gt; 0)</a>
<a name="ln1262">		min.width += divider;</a>
<a name="ln1263"> </a>
<a name="ln1264">	if (fLayoutData-&gt;label_height &gt; min.height)</a>
<a name="ln1265">		min.height = fLayoutData-&gt;label_height;</a>
<a name="ln1266"> </a>
<a name="ln1267">	fLayoutData-&gt;min = min;</a>
<a name="ln1268"> </a>
<a name="ln1269">	fLayoutData-&gt;valid = true;</a>
<a name="ln1270">	ResetLayoutInvalidation();</a>
<a name="ln1271"> </a>
<a name="ln1272">	TRACE(&quot;width: %.2f, height: %.2f\n&quot;, min.width, min.height);</a>
<a name="ln1273">}</a>
<a name="ln1274"> </a>
<a name="ln1275"> </a>
<a name="ln1276">// #pragma mark - BTextControl::LabelLayoutItem</a>
<a name="ln1277"> </a>
<a name="ln1278"> </a>
<a name="ln1279">BTextControl::LabelLayoutItem::LabelLayoutItem(BTextControl* parent)</a>
<a name="ln1280">	:</a>
<a name="ln1281">	fParent(parent),</a>
<a name="ln1282">	fFrame()</a>
<a name="ln1283">{</a>
<a name="ln1284">}</a>
<a name="ln1285"> </a>
<a name="ln1286"> </a>
<a name="ln1287">BTextControl::LabelLayoutItem::LabelLayoutItem(BMessage* from)</a>
<a name="ln1288">	:</a>
<a name="ln1289">	BAbstractLayoutItem(from),</a>
<a name="ln1290">	fParent(NULL),</a>
<a name="ln1291">	fFrame()</a>
<a name="ln1292">{</a>
<a name="ln1293">	from-&gt;FindRect(kFrameField, &amp;fFrame);</a>
<a name="ln1294">}</a>
<a name="ln1295"> </a>
<a name="ln1296"> </a>
<a name="ln1297">bool</a>
<a name="ln1298">BTextControl::LabelLayoutItem::IsVisible()</a>
<a name="ln1299">{</a>
<a name="ln1300">	return !fParent-&gt;IsHidden(fParent);</a>
<a name="ln1301">}</a>
<a name="ln1302"> </a>
<a name="ln1303"> </a>
<a name="ln1304">void</a>
<a name="ln1305">BTextControl::LabelLayoutItem::SetVisible(bool visible)</a>
<a name="ln1306">{</a>
<a name="ln1307">	// not allowed</a>
<a name="ln1308">}</a>
<a name="ln1309"> </a>
<a name="ln1310"> </a>
<a name="ln1311">BRect</a>
<a name="ln1312">BTextControl::LabelLayoutItem::Frame()</a>
<a name="ln1313">{</a>
<a name="ln1314">	return fFrame;</a>
<a name="ln1315">}</a>
<a name="ln1316"> </a>
<a name="ln1317"> </a>
<a name="ln1318">void</a>
<a name="ln1319">BTextControl::LabelLayoutItem::SetFrame(BRect frame)</a>
<a name="ln1320">{</a>
<a name="ln1321">	fFrame = frame;</a>
<a name="ln1322">	fParent-&gt;_UpdateFrame();</a>
<a name="ln1323">}</a>
<a name="ln1324"> </a>
<a name="ln1325"> </a>
<a name="ln1326">void</a>
<a name="ln1327">BTextControl::LabelLayoutItem::SetParent(BTextControl* parent)</a>
<a name="ln1328">{</a>
<a name="ln1329">	fParent = parent;</a>
<a name="ln1330">}</a>
<a name="ln1331"> </a>
<a name="ln1332"> </a>
<a name="ln1333">BView*</a>
<a name="ln1334">BTextControl::LabelLayoutItem::View()</a>
<a name="ln1335">{</a>
<a name="ln1336">	return fParent;</a>
<a name="ln1337">}</a>
<a name="ln1338"> </a>
<a name="ln1339"> </a>
<a name="ln1340">BSize</a>
<a name="ln1341">BTextControl::LabelLayoutItem::BaseMinSize()</a>
<a name="ln1342">{</a>
<a name="ln1343">	fParent-&gt;_ValidateLayoutData();</a>
<a name="ln1344"> </a>
<a name="ln1345">	if (!fParent-&gt;Label())</a>
<a name="ln1346">		return BSize(-1, -1);</a>
<a name="ln1347"> </a>
<a name="ln1348">	return BSize(fParent-&gt;fLayoutData-&gt;label_width</a>
<a name="ln1349">			+ be_control_look-&gt;DefaultLabelSpacing(),</a>
<a name="ln1350">		fParent-&gt;fLayoutData-&gt;label_height);</a>
<a name="ln1351">}</a>
<a name="ln1352"> </a>
<a name="ln1353"> </a>
<a name="ln1354">BSize</a>
<a name="ln1355">BTextControl::LabelLayoutItem::BaseMaxSize()</a>
<a name="ln1356">{</a>
<a name="ln1357">	return BaseMinSize();</a>
<a name="ln1358">}</a>
<a name="ln1359"> </a>
<a name="ln1360"> </a>
<a name="ln1361">BSize</a>
<a name="ln1362">BTextControl::LabelLayoutItem::BasePreferredSize()</a>
<a name="ln1363">{</a>
<a name="ln1364">	return BaseMinSize();</a>
<a name="ln1365">}</a>
<a name="ln1366"> </a>
<a name="ln1367"> </a>
<a name="ln1368">BAlignment</a>
<a name="ln1369">BTextControl::LabelLayoutItem::BaseAlignment()</a>
<a name="ln1370">{</a>
<a name="ln1371">	return BAlignment(B_ALIGN_USE_FULL_WIDTH, B_ALIGN_USE_FULL_HEIGHT);</a>
<a name="ln1372">}</a>
<a name="ln1373"> </a>
<a name="ln1374"> </a>
<a name="ln1375">BRect</a>
<a name="ln1376">BTextControl::LabelLayoutItem::FrameInParent() const</a>
<a name="ln1377">{</a>
<a name="ln1378">	return fFrame.OffsetByCopy(-fParent-&gt;Frame().left, -fParent-&gt;Frame().top);</a>
<a name="ln1379">}</a>
<a name="ln1380"> </a>
<a name="ln1381"> </a>
<a name="ln1382">status_t</a>
<a name="ln1383">BTextControl::LabelLayoutItem::Archive(BMessage* into, bool deep) const</a>
<a name="ln1384">{</a>
<a name="ln1385">	BArchiver archiver(into);</a>
<a name="ln1386">	status_t err = BAbstractLayoutItem::Archive(into, deep);</a>
<a name="ln1387">	if (err == B_OK)</a>
<a name="ln1388">		err = into-&gt;AddRect(kFrameField, fFrame);</a>
<a name="ln1389"> </a>
<a name="ln1390">	return archiver.Finish(err);</a>
<a name="ln1391">}</a>
<a name="ln1392"> </a>
<a name="ln1393"> </a>
<a name="ln1394">BArchivable*</a>
<a name="ln1395">BTextControl::LabelLayoutItem::Instantiate(BMessage* from)</a>
<a name="ln1396">{</a>
<a name="ln1397">	if (validate_instantiation(from, &quot;BTextControl::LabelLayoutItem&quot;))</a>
<a name="ln1398">		return new LabelLayoutItem(from);</a>
<a name="ln1399">	return NULL;</a>
<a name="ln1400">}</a>
<a name="ln1401"> </a>
<a name="ln1402"> </a>
<a name="ln1403">// #pragma mark - BTextControl::TextViewLayoutItem</a>
<a name="ln1404"> </a>
<a name="ln1405"> </a>
<a name="ln1406">BTextControl::TextViewLayoutItem::TextViewLayoutItem(BTextControl* parent)</a>
<a name="ln1407">	:</a>
<a name="ln1408">	fParent(parent),</a>
<a name="ln1409">	fFrame()</a>
<a name="ln1410">{</a>
<a name="ln1411">	// by default the part right of the divider shall have an unlimited maximum</a>
<a name="ln1412">	// width</a>
<a name="ln1413">	SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln1414">}</a>
<a name="ln1415"> </a>
<a name="ln1416"> </a>
<a name="ln1417">BTextControl::TextViewLayoutItem::TextViewLayoutItem(BMessage* from)</a>
<a name="ln1418">	:</a>
<a name="ln1419">	BAbstractLayoutItem(from),</a>
<a name="ln1420">	fParent(NULL),</a>
<a name="ln1421">	fFrame()</a>
<a name="ln1422">{</a>
<a name="ln1423">	from-&gt;FindRect(kFrameField, &amp;fFrame);</a>
<a name="ln1424">}</a>
<a name="ln1425"> </a>
<a name="ln1426"> </a>
<a name="ln1427">bool</a>
<a name="ln1428">BTextControl::TextViewLayoutItem::IsVisible()</a>
<a name="ln1429">{</a>
<a name="ln1430">	return !fParent-&gt;IsHidden(fParent);</a>
<a name="ln1431">}</a>
<a name="ln1432"> </a>
<a name="ln1433"> </a>
<a name="ln1434">void</a>
<a name="ln1435">BTextControl::TextViewLayoutItem::SetVisible(bool visible)</a>
<a name="ln1436">{</a>
<a name="ln1437">	// not allowed</a>
<a name="ln1438">}</a>
<a name="ln1439"> </a>
<a name="ln1440"> </a>
<a name="ln1441">BRect</a>
<a name="ln1442">BTextControl::TextViewLayoutItem::Frame()</a>
<a name="ln1443">{</a>
<a name="ln1444">	return fFrame;</a>
<a name="ln1445">}</a>
<a name="ln1446"> </a>
<a name="ln1447"> </a>
<a name="ln1448">void</a>
<a name="ln1449">BTextControl::TextViewLayoutItem::SetFrame(BRect frame)</a>
<a name="ln1450">{</a>
<a name="ln1451">	fFrame = frame;</a>
<a name="ln1452">	fParent-&gt;_UpdateFrame();</a>
<a name="ln1453">}</a>
<a name="ln1454"> </a>
<a name="ln1455"> </a>
<a name="ln1456">void</a>
<a name="ln1457">BTextControl::TextViewLayoutItem::SetParent(BTextControl* parent)</a>
<a name="ln1458">{</a>
<a name="ln1459">	fParent = parent;</a>
<a name="ln1460">}</a>
<a name="ln1461"> </a>
<a name="ln1462"> </a>
<a name="ln1463">BView*</a>
<a name="ln1464">BTextControl::TextViewLayoutItem::View()</a>
<a name="ln1465">{</a>
<a name="ln1466">	return fParent;</a>
<a name="ln1467">}</a>
<a name="ln1468"> </a>
<a name="ln1469"> </a>
<a name="ln1470">BSize</a>
<a name="ln1471">BTextControl::TextViewLayoutItem::BaseMinSize()</a>
<a name="ln1472">{</a>
<a name="ln1473">	fParent-&gt;_ValidateLayoutData();</a>
<a name="ln1474"> </a>
<a name="ln1475">	BSize size = fParent-&gt;fLayoutData-&gt;text_view_min;</a>
<a name="ln1476">	size.width += 2 * kFrameMargin;</a>
<a name="ln1477">	size.height += 2 * kFrameMargin;</a>
<a name="ln1478"> </a>
<a name="ln1479">	return size;</a>
<a name="ln1480">}</a>
<a name="ln1481"> </a>
<a name="ln1482"> </a>
<a name="ln1483">BSize</a>
<a name="ln1484">BTextControl::TextViewLayoutItem::BaseMaxSize()</a>
<a name="ln1485">{</a>
<a name="ln1486">	BSize size(BaseMinSize());</a>
<a name="ln1487">	size.width = B_SIZE_UNLIMITED;</a>
<a name="ln1488"> </a>
<a name="ln1489">	return size;</a>
<a name="ln1490">}</a>
<a name="ln1491"> </a>
<a name="ln1492"> </a>
<a name="ln1493">BSize</a>
<a name="ln1494">BTextControl::TextViewLayoutItem::BasePreferredSize()</a>
<a name="ln1495">{</a>
<a name="ln1496">	BSize size(BaseMinSize());</a>
<a name="ln1497">	// puh, no idea...</a>
<a name="ln1498">	size.width = 100;</a>
<a name="ln1499"> </a>
<a name="ln1500">	return size;</a>
<a name="ln1501">}</a>
<a name="ln1502"> </a>
<a name="ln1503"> </a>
<a name="ln1504">BAlignment</a>
<a name="ln1505">BTextControl::TextViewLayoutItem::BaseAlignment()</a>
<a name="ln1506">{</a>
<a name="ln1507">	return BAlignment(B_ALIGN_USE_FULL_WIDTH, B_ALIGN_USE_FULL_HEIGHT);</a>
<a name="ln1508">}</a>
<a name="ln1509"> </a>
<a name="ln1510"> </a>
<a name="ln1511">BRect</a>
<a name="ln1512">BTextControl::TextViewLayoutItem::FrameInParent() const</a>
<a name="ln1513">{</a>
<a name="ln1514">	return fFrame.OffsetByCopy(-fParent-&gt;Frame().left, -fParent-&gt;Frame().top);</a>
<a name="ln1515">}</a>
<a name="ln1516"> </a>
<a name="ln1517"> </a>
<a name="ln1518">status_t</a>
<a name="ln1519">BTextControl::TextViewLayoutItem::Archive(BMessage* into, bool deep) const</a>
<a name="ln1520">{</a>
<a name="ln1521">	BArchiver archiver(into);</a>
<a name="ln1522">	status_t err = BAbstractLayoutItem::Archive(into, deep);</a>
<a name="ln1523">	if (err == B_OK)</a>
<a name="ln1524">		err = into-&gt;AddRect(kFrameField, fFrame);</a>
<a name="ln1525"> </a>
<a name="ln1526">	return archiver.Finish(err);</a>
<a name="ln1527">}</a>
<a name="ln1528"> </a>
<a name="ln1529"> </a>
<a name="ln1530">BArchivable*</a>
<a name="ln1531">BTextControl::TextViewLayoutItem::Instantiate(BMessage* from)</a>
<a name="ln1532">{</a>
<a name="ln1533">	if (validate_instantiation(from, &quot;BTextControl::TextViewLayoutItem&quot;))</a>
<a name="ln1534">		return new TextViewLayoutItem(from);</a>
<a name="ln1535"> </a>
<a name="ln1536">	return NULL;</a>
<a name="ln1537">}</a>
<a name="ln1538"> </a>
<a name="ln1539"> </a>
<a name="ln1540">extern &quot;C&quot; void</a>
<a name="ln1541">B_IF_GCC_2(InvalidateLayout__12BTextControlb,</a>
<a name="ln1542">	_ZN12BTextControl16InvalidateLayoutEb)(BView* view, bool descendants)</a>
<a name="ln1543">{</a>
<a name="ln1544">	perform_data_layout_invalidated data;</a>
<a name="ln1545">	data.descendants = descendants;</a>
<a name="ln1546"> </a>
<a name="ln1547">	view-&gt;Perform(PERFORM_CODE_LAYOUT_INVALIDATED, &amp;data);</a>
<a name="ln1548">}</a>

</code></pre>
<div class="balloon" rel="129"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: font_info, label_width, label_height.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
