
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ConfigWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2007-2016 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Copyright 2001-2003 Dr. Zoidberg Enterprises. All rights reserved.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Distributed under the terms of the MIT License.</a>
<a name="ln6"> */</a>
<a name="ln7"> </a>
<a name="ln8"> </a>
<a name="ln9">//! Main E-Mail config window</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;ConfigWindow.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;new&gt;</a>
<a name="ln15">#include &lt;stdio.h&gt;</a>
<a name="ln16">#include &lt;string.h&gt;</a>
<a name="ln17"> </a>
<a name="ln18">#include &lt;Alert.h&gt;</a>
<a name="ln19">#include &lt;AppFileInfo.h&gt;</a>
<a name="ln20">#include &lt;Application.h&gt;</a>
<a name="ln21">#include &lt;Bitmap.h&gt;</a>
<a name="ln22">#include &lt;Box.h&gt;</a>
<a name="ln23">#include &lt;Button.h&gt;</a>
<a name="ln24">#include &lt;Catalog.h&gt;</a>
<a name="ln25">#include &lt;CheckBox.h&gt;</a>
<a name="ln26">#include &lt;ControlLook.h&gt;</a>
<a name="ln27">#include &lt;Directory.h&gt;</a>
<a name="ln28">#include &lt;Entry.h&gt;</a>
<a name="ln29">#include &lt;FindDirectory.h&gt;</a>
<a name="ln30">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln31">#include &lt;ListView.h&gt;</a>
<a name="ln32">#include &lt;Locale.h&gt;</a>
<a name="ln33">#include &lt;MailDaemon.h&gt;</a>
<a name="ln34">#include &lt;MailSettings.h&gt;</a>
<a name="ln35">#include &lt;MenuBar.h&gt;</a>
<a name="ln36">#include &lt;MenuField.h&gt;</a>
<a name="ln37">#include &lt;MenuItem.h&gt;</a>
<a name="ln38">#include &lt;Path.h&gt;</a>
<a name="ln39">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln40">#include &lt;Region.h&gt;</a>
<a name="ln41">#include &lt;Resources.h&gt;</a>
<a name="ln42">#include &lt;Roster.h&gt;</a>
<a name="ln43">#include &lt;Screen.h&gt;</a>
<a name="ln44">#include &lt;ScrollView.h&gt;</a>
<a name="ln45">#include &lt;SeparatorView.h&gt;</a>
<a name="ln46">#include &lt;StringView.h&gt;</a>
<a name="ln47">#include &lt;TabView.h&gt;</a>
<a name="ln48">#include &lt;TextControl.h&gt;</a>
<a name="ln49">#include &lt;TextView.h&gt;</a>
<a name="ln50"> </a>
<a name="ln51">#include &lt;MailPrivate.h&gt;</a>
<a name="ln52"> </a>
<a name="ln53">#include &quot;AutoConfigWindow.h&quot;</a>
<a name="ln54"> </a>
<a name="ln55"> </a>
<a name="ln56">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln57">#define B_TRANSLATION_CONTEXT &quot;Config Window&quot;</a>
<a name="ln58"> </a>
<a name="ln59"> </a>
<a name="ln60">using std::nothrow;</a>
<a name="ln61"> </a>
<a name="ln62">// define if you want to have an apply button</a>
<a name="ln63">//#define HAVE_APPLY_BUTTON</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">const uint32 kMsgAccountsRightClicked = 'arcl';</a>
<a name="ln67">const uint32 kMsgAccountSelected = 'acsl';</a>
<a name="ln68">const uint32 kMsgAddAccount = 'adac';</a>
<a name="ln69">const uint32 kMsgRemoveAccount = 'rmac';</a>
<a name="ln70"> </a>
<a name="ln71">const uint32 kMsgIntervalUnitChanged = 'iuch';</a>
<a name="ln72"> </a>
<a name="ln73">const uint32 kMsgShowStatusWindowChanged = 'shst';</a>
<a name="ln74">const uint32 kMsgStatusLookChanged = 'lkch';</a>
<a name="ln75">const uint32 kMsgStatusWorkspaceChanged = 'wsch';</a>
<a name="ln76"> </a>
<a name="ln77">const uint32 kMsgSaveSettings = 'svst';</a>
<a name="ln78">const uint32 kMsgRevertSettings = 'rvst';</a>
<a name="ln79">const uint32 kMsgCancelSettings = 'cnst';</a>
<a name="ln80"> </a>
<a name="ln81"> </a>
<a name="ln82"> </a>
<a name="ln83">AccountItem::AccountItem(const char* label, BMailAccountSettings* account,</a>
<a name="ln84">	item_types type)</a>
<a name="ln85">	:</a>
<a name="ln86">	BStringItem(label),</a>
<a name="ln87">	fAccount(account),</a>
<a name="ln88">	fType(type)</a>
<a name="ln89">{</a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92"> </a>
<a name="ln93">void</a>
<a name="ln94">AccountItem::Update(BView* owner, const BFont* font)</a>
<a name="ln95">{</a>
<a name="ln96">	if (fType == ACCOUNT_ITEM)</a>
<a name="ln97">		font = be_bold_font;</a>
<a name="ln98"> </a>
<a name="ln99">	BStringItem::Update(owner, font);</a>
<a name="ln100">}</a>
<a name="ln101"> </a>
<a name="ln102"> </a>
<a name="ln103">void</a>
<a name="ln104">AccountItem::DrawItem(BView* owner, BRect rect, bool complete)</a>
<a name="ln105">{</a>
<a name="ln106">	owner-&gt;PushState();</a>
<a name="ln107">	if (fType == ACCOUNT_ITEM)</a>
<a name="ln108">		owner-&gt;SetFont(be_bold_font);</a>
<a name="ln109"> </a>
<a name="ln110">	BStringItem::DrawItem(owner, rect, complete);</a>
<a name="ln111">	owner-&gt;PopState();</a>
<a name="ln112">}</a>
<a name="ln113"> </a>
<a name="ln114"> </a>
<a name="ln115">//	#pragma mark -</a>
<a name="ln116"> </a>
<a name="ln117"> </a>
<a name="ln118">class AccountsListView : public BListView {</a>
<a name="ln119">public:</a>
<a name="ln120">	AccountsListView(BHandler* target)</a>
<a name="ln121">		:</a>
<a name="ln122">		BListView(NULL, B_SINGLE_SELECTION_LIST),</a>
<a name="ln123">		fTarget(target)</a>
<a name="ln124">	{</a>
<a name="ln125">	}</a>
<a name="ln126"> </a>
<a name="ln127">	void</a>
<a name="ln128">	KeyDown(const char *bytes, int32 numBytes)</a>
<a name="ln129">	{</a>
<a name="ln130">		if (numBytes != 1)</a>
<a name="ln131">			return;</a>
<a name="ln132"> </a>
<a name="ln133">		if ((*bytes == B_DELETE) || (*bytes == B_BACKSPACE))</a>
<a name="ln134">			Window()-&gt;PostMessage(kMsgRemoveAccount);</a>
<a name="ln135"> </a>
<a name="ln136">		BListView::KeyDown(bytes,numBytes);</a>
<a name="ln137">	}</a>
<a name="ln138"> </a>
<a name="ln139">	void</a>
<a name="ln140">	MouseDown(BPoint point)</a>
<a name="ln141">	{</a>
<a name="ln142">		BListView::MouseDown(point);</a>
<a name="ln143"> </a>
<a name="ln144">		BPoint dummy;</a>
<a name="ln145">		uint32 buttons;</a>
<a name="ln146">		GetMouse(&amp;dummy, &amp;buttons);</a>
<a name="ln147">		if (buttons != B_SECONDARY_MOUSE_BUTTON)</a>
<a name="ln148">			return;</a>
<a name="ln149"> </a>
<a name="ln150">		int32 index = IndexOf(point);</a>
<a name="ln151">		if (index &lt; 0)</a>
<a name="ln152">			return;</a>
<a name="ln153"> </a>
<a name="ln154">		BMessage message(kMsgAccountsRightClicked);</a>
<a name="ln155">		ConvertToScreen(&amp;point);</a>
<a name="ln156">		message.AddPoint(&quot;point&quot;, point);</a>
<a name="ln157">		message.AddInt32(&quot;index&quot;, index);</a>
<a name="ln158">		BMessenger messenger(fTarget);</a>
<a name="ln159">		messenger.SendMessage(&amp;message);</a>
<a name="ln160">	}</a>
<a name="ln161"> </a>
<a name="ln162">private:</a>
<a name="ln163">			BHandler*			fTarget;</a>
<a name="ln164">};</a>
<a name="ln165"> </a>
<a name="ln166"> </a>
<a name="ln167">class BitmapView : public BView {</a>
<a name="ln168">	public:</a>
<a name="ln169">		BitmapView(BBitmap *bitmap)</a>
<a name="ln170">			:</a>
<a name="ln171">			BView(NULL, B_WILL_DRAW)</a>
<a name="ln172">		{</a>
<a name="ln173">			fBitmap = bitmap;</a>
<a name="ln174"> </a>
<a name="ln175">			SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln176">			SetBlendingMode(B_PIXEL_ALPHA, B_ALPHA_OVERLAY);</a>
<a name="ln177">			SetExplicitSize(bitmap-&gt;Bounds().Size());</a>
<a name="ln178">		}</a>
<a name="ln179"> </a>
<a name="ln180">		~BitmapView()</a>
<a name="ln181">		{</a>
<a name="ln182">			delete fBitmap;</a>
<a name="ln183">		}</a>
<a name="ln184"> </a>
<a name="ln185">		virtual void AttachedToWindow()</a>
<a name="ln186">		{</a>
<a name="ln187">			AdoptParentColors();</a>
<a name="ln188">		}</a>
<a name="ln189"> </a>
<a name="ln190">		virtual void Draw(BRect updateRect)</a>
<a name="ln191">		{</a>
<a name="ln192">			DrawBitmap(fBitmap, updateRect, updateRect);</a>
<a name="ln193">		}</a>
<a name="ln194"> </a>
<a name="ln195">	private:</a>
<a name="ln196">		BBitmap *fBitmap;</a>
<a name="ln197">};</a>
<a name="ln198"> </a>
<a name="ln199"> </a>
<a name="ln200">//	#pragma mark -</a>
<a name="ln201"> </a>
<a name="ln202"> </a>
<a name="ln203">ConfigWindow::ConfigWindow()</a>
<a name="ln204">	:</a>
<a name="ln205">	BWindow(BRect(100, 100, 600, 540), B_TRANSLATE_SYSTEM_NAME(&quot;E-mail&quot;),</a>
<a name="ln206">		B_TITLED_WINDOW,</a>
<a name="ln207">		B_ASYNCHRONOUS_CONTROLS | B_NOT_ZOOMABLE | B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln208">	fLastSelectedAccount(NULL),</a>
<a name="ln209">	fSaveSettings(false)</a>
<a name="ln210">{</a>
<a name="ln211">	BTabView* tabView = new BTabView(&quot;tab&quot;, B_WIDTH_FROM_WIDEST);</a>
<a name="ln212">	tabView-&gt;SetBorder(B_NO_BORDER);</a>
<a name="ln213"> </a>
<a name="ln214">	// accounts listview</a>
<a name="ln215"> </a>
<a name="ln216">	BView* view = new BView(&quot;accounts&quot;, 0);</a>
<a name="ln217">	tabView-&gt;AddTab(view);</a>
<a name="ln218">	tabView-&gt;TabAt(0)-&gt;SetLabel(B_TRANSLATE(&quot;Accounts&quot;));</a>
<a name="ln219"> </a>
<a name="ln220">	fAccountsListView = new AccountsListView(this);</a>
<a name="ln221">	fAccountsListView-&gt;SetExplicitPreferredSize(BSize(</a>
<a name="ln222">		fAccountsListView-&gt;StringWidth(&quot;W&quot;) * 22, B_SIZE_UNSET));</a>
<a name="ln223"> </a>
<a name="ln224">	BButton* addButton = new BButton(NULL, B_TRANSLATE(&quot;Add&quot;),</a>
<a name="ln225">		new BMessage(kMsgAddAccount));</a>
<a name="ln226">	fRemoveButton = new BButton(NULL, B_TRANSLATE(&quot;Remove&quot;),</a>
<a name="ln227">		new BMessage(kMsgRemoveAccount));</a>
<a name="ln228"> </a>
<a name="ln229">	fConfigView = new BView(NULL, 0);</a>
<a name="ln230">	fConfigView-&gt;SetLayout(new BGroupLayout(B_VERTICAL));</a>
<a name="ln231">	fConfigView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED));</a>
<a name="ln232">	fConfigView-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln233"> </a>
<a name="ln234">	BScrollView* scroller = new BScrollView(NULL, fAccountsListView, 0,</a>
<a name="ln235">		false, true);</a>
<a name="ln236"> </a>
<a name="ln237">	BLayoutBuilder::Group&lt;&gt;(view, B_HORIZONTAL)</a>
<a name="ln238">		.SetInsets(B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING,</a>
<a name="ln239">			B_USE_WINDOW_SPACING, B_USE_DEFAULT_SPACING)</a>
<a name="ln240">		.AddGroup(B_VERTICAL)</a>
<a name="ln241">			.Add(scroller)</a>
<a name="ln242">			.AddGroup(B_HORIZONTAL)</a>
<a name="ln243">				.Add(addButton)</a>
<a name="ln244">				.Add(fRemoveButton)</a>
<a name="ln245">			.End()</a>
<a name="ln246">		.End()</a>
<a name="ln247">		.Add(fConfigView, 2.0f);</a>
<a name="ln248"> </a>
<a name="ln249">	_ReplaceConfigView(_BuildHowToView());</a>
<a name="ln250"> </a>
<a name="ln251">	// general settings</a>
<a name="ln252"> </a>
<a name="ln253">	view = new BView(&quot;general&quot;, 0);</a>
<a name="ln254">	view-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED));</a>
<a name="ln255">	tabView-&gt;AddTab(view);</a>
<a name="ln256">	tabView-&gt;TabAt(1)-&gt;SetLabel(B_TRANSLATE(&quot;Settings&quot;));</a>
<a name="ln257"> </a>
<a name="ln258">	fCheckMailCheckBox = new BCheckBox(&quot;check&quot;, B_TRANSLATE(&quot;Check every&quot;),</a>
<a name="ln259">		NULL);</a>
<a name="ln260">	fIntervalControl = new BTextControl(&quot;time&quot;, B_TRANSLATE(&quot;minutes&quot;), NULL,</a>
<a name="ln261">		NULL);</a>
<a name="ln262"> </a>
<a name="ln263">	BPopUpMenu* statusPopUp = new BPopUpMenu(B_EMPTY_STRING);</a>
<a name="ln264">	const char* statusModes[] = {</a>
<a name="ln265">		B_TRANSLATE_COMMENT(&quot;Never&quot;, &quot;show status window&quot;),</a>
<a name="ln266">		B_TRANSLATE(&quot;While sending&quot;),</a>
<a name="ln267">		B_TRANSLATE(&quot;While sending and receiving&quot;)};</a>
<a name="ln268">	for (size_t i = 0; i &lt; sizeof(statusModes) / sizeof(statusModes[0]); i++) {</a>
<a name="ln269">		BMessage* msg = new BMessage(kMsgShowStatusWindowChanged);</a>
<a name="ln270">		BMenuItem* item = new BMenuItem(statusModes[i], msg);</a>
<a name="ln271">		statusPopUp-&gt;AddItem(item);</a>
<a name="ln272">		msg-&gt;AddInt32(&quot;ShowStatusWindow&quot;, i);</a>
<a name="ln273">	}</a>
<a name="ln274"> </a>
<a name="ln275">	fStatusModeField = new BMenuField(&quot;show status&quot;,</a>
<a name="ln276">		B_TRANSLATE(&quot;Show notifications:&quot;), statusPopUp);</a>
<a name="ln277"> </a>
<a name="ln278">	BMessage* msg = new BMessage(B_REFS_RECEIVED);</a>
<a name="ln279">	BButton* editMenuButton = new BButton(B_EMPTY_STRING,</a>
<a name="ln280">		B_TRANSLATE(&quot;Edit mailbox menu…&quot;), msg);</a>
<a name="ln281">	editMenuButton-&gt;SetTarget(BMessenger(&quot;application/x-vnd.Be-TRAK&quot;));</a>
<a name="ln282"> </a>
<a name="ln283">	BPath path;</a>
<a name="ln284">	find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path);</a>
<a name="ln285">	path.Append(&quot;Mail/Menu Links&quot;);</a>
<a name="ln286">	BEntry entry(path.Path());</a>
<a name="ln287">	if (entry.InitCheck() == B_OK &amp;&amp; entry.Exists()) {</a>
<a name="ln288">		entry_ref ref;</a>
<a name="ln289">		entry.GetRef(&amp;ref);</a>
<a name="ln290">		msg-&gt;AddRef(&quot;refs&quot;, &amp;ref);</a>
<a name="ln291">	} else</a>
<a name="ln292">		editMenuButton-&gt;SetEnabled(false);</a>
<a name="ln293"> </a>
<a name="ln294">	BLayoutBuilder::Group&lt;&gt;(view, B_VERTICAL)</a>
<a name="ln295">		.SetInsets(B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING,</a>
<a name="ln296">			B_USE_WINDOW_SPACING, B_USE_DEFAULT_SPACING)</a>
<a name="ln297">//		.AddGlue()</a>
<a name="ln298">		.AddGroup(B_HORIZONTAL, 0.f)</a>
<a name="ln299">			.AddGlue()</a>
<a name="ln300">			.Add(fCheckMailCheckBox)</a>
<a name="ln301">			.AddStrut(be_control_look-&gt;DefaultLabelSpacing())</a>
<a name="ln302">			.Add(fIntervalControl-&gt;CreateTextViewLayoutItem())</a>
<a name="ln303">			.AddStrut(be_control_look-&gt;DefaultLabelSpacing())</a>
<a name="ln304">			.Add(fIntervalControl-&gt;CreateLabelLayoutItem())</a>
<a name="ln305">			.AddGlue()</a>
<a name="ln306">		.End()</a>
<a name="ln307">		.AddGroup(B_HORIZONTAL, 0.f)</a>
<a name="ln308">			.AddGlue()</a>
<a name="ln309">			.Add(fStatusModeField-&gt;CreateLabelLayoutItem())</a>
<a name="ln310">			.Add(fStatusModeField-&gt;CreateMenuBarLayoutItem())</a>
<a name="ln311">			.AddGlue()</a>
<a name="ln312">		.End()</a>
<a name="ln313">		.Add(editMenuButton)</a>
<a name="ln314">		.AddGlue();</a>
<a name="ln315"> </a>
<a name="ln316">	// save/revert buttons</a>
<a name="ln317"> </a>
<a name="ln318">	BButton* applyButton = new BButton(&quot;apply&quot;, B_TRANSLATE(&quot;Apply&quot;),</a>
<a name="ln319">		new BMessage(kMsgSaveSettings));</a>
<a name="ln320">	BButton* revertButton = new BButton(&quot;revert&quot;, B_TRANSLATE(&quot;Revert&quot;),</a>
<a name="ln321">		new BMessage(kMsgRevertSettings));</a>
<a name="ln322"> </a>
<a name="ln323">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln324">		.SetInsets(0, B_USE_DEFAULT_SPACING, 0, B_USE_WINDOW_SPACING)</a>
<a name="ln325">		.Add(tabView)</a>
<a name="ln326">		.Add(new BSeparatorView(B_HORIZONTAL))</a>
<a name="ln327">		.AddGroup(B_HORIZONTAL, 0)</a>
<a name="ln328">			.Add(revertButton)</a>
<a name="ln329">			.AddGlue()</a>
<a name="ln330">			.Add(applyButton)</a>
<a name="ln331">			.SetInsets(B_USE_WINDOW_SPACING, B_USE_DEFAULT_SPACING,</a>
<a name="ln332">				B_USE_WINDOW_SPACING, 0);</a>
<a name="ln333"> </a>
<a name="ln334">	_LoadSettings();</a>
<a name="ln335"> </a>
<a name="ln336">	fAccountsListView-&gt;SetSelectionMessage(new BMessage(kMsgAccountSelected));</a>
<a name="ln337">	fAccountsListView-&gt;MakeFocus(true);</a>
<a name="ln338"> </a>
<a name="ln339">	ResizeToPreferred();</a>
<a name="ln340">	CenterOnScreen();</a>
<a name="ln341">}</a>
<a name="ln342"> </a>
<a name="ln343"> </a>
<a name="ln344">ConfigWindow::~ConfigWindow()</a>
<a name="ln345">{</a>
<a name="ln346">	while (fAccounts.CountItems() &gt; 0)</a>
<a name="ln347">		_RemoveAccount(fAccounts.ItemAt(0));</a>
<a name="ln348">	for (int32 i = 0; i &lt; fToDeleteAccounts.CountItems(); i++)</a>
<a name="ln349">		delete fToDeleteAccounts.ItemAt(i);</a>
<a name="ln350">}</a>
<a name="ln351"> </a>
<a name="ln352"> </a>
<a name="ln353">BView*</a>
<a name="ln354">ConfigWindow::_BuildHowToView()</a>
<a name="ln355">{</a>
<a name="ln356">	BView* groupView = new BView(&quot;howTo&quot;, 0);</a>
<a name="ln357"> </a>
<a name="ln358">	BitmapView* bitmapView = NULL;</a>
<a name="ln359">	app_info info;</a>
<a name="ln360">	if (be_app-&gt;GetAppInfo(&amp;info) == B_OK) {</a>
<a name="ln361">		BFile appFile(&amp;info.ref, B_READ_ONLY);</a>
<a name="ln362">		BAppFileInfo appFileInfo(&amp;appFile);</a>
<a name="ln363">		if (appFileInfo.InitCheck() == B_OK) {</a>
<a name="ln364">			BBitmap* bitmap = new (std::nothrow) BBitmap(BRect(0, 0, 63, 63),</a>
<a name="ln365">				B_RGBA32);</a>
<a name="ln366">			if (appFileInfo.GetIcon(bitmap, B_LARGE_ICON) == B_OK)</a>
<a name="ln367">				bitmapView = new BitmapView(bitmap);</a>
<a name="ln368">			else</a>
<a name="ln369">				delete bitmap;</a>
<a name="ln370">		}</a>
<a name="ln371">	}</a>
<a name="ln372"> </a>
<a name="ln373">	fHowToTextView = new BTextView(NULL, B_WILL_DRAW);</a>
<a name="ln374">	fHowToTextView-&gt;SetAlignment(B_ALIGN_CENTER);</a>
<a name="ln375">	fHowToTextView-&gt;SetText(B_TRANSLATE(</a>
<a name="ln376">		&quot;Create a new account with the Add button.\n\n&quot;</a>
<a name="ln377">		&quot;Remove an account with the Remove button on the selected item.\n\n&quot;</a>
<a name="ln378">		&quot;Select an item in the list to change its settings.&quot;));</a>
<a name="ln379"> </a>
<a name="ln380">	fHowToTextView-&gt;MakeEditable(false);</a>
<a name="ln381">	fHowToTextView-&gt;MakeSelectable(false);</a>
<a name="ln382"> </a>
<a name="ln383">	BFont font(be_plain_font);</a>
<a name="ln384">	float fontFactor = font.Size() / 12.0f;</a>
<a name="ln385"> </a>
<a name="ln386">	fHowToTextView-&gt;SetExplicitPreferredSize(</a>
<a name="ln387">		BSize(300 * fontFactor,400 * fontFactor));</a>
<a name="ln388"> </a>
<a name="ln389">	rgb_color textColor = ui_color(B_PANEL_TEXT_COLOR);</a>
<a name="ln390">	fHowToTextView-&gt;SetFontAndColor(&amp;font, B_FONT_ALL, &amp;textColor);</a>
<a name="ln391"> </a>
<a name="ln392">	BLayoutBuilder::Group&lt;&gt;(groupView, B_VERTICAL)</a>
<a name="ln393">		.AddGlue()</a>
<a name="ln394">		.Add(fHowToTextView)</a>
<a name="ln395">		.AddGlue();</a>
<a name="ln396"> </a>
<a name="ln397">	if (bitmapView != NULL)</a>
<a name="ln398">		groupView-&gt;GetLayout()-&gt;AddView(1, bitmapView);</a>
<a name="ln399"> </a>
<a name="ln400">	fHowToTextView-&gt;AdoptSystemColors();</a>
<a name="ln401"> </a>
<a name="ln402">	return groupView;</a>
<a name="ln403">}</a>
<a name="ln404"> </a>
<a name="ln405"> </a>
<a name="ln406">void</a>
<a name="ln407">ConfigWindow::_LoadSettings()</a>
<a name="ln408">{</a>
<a name="ln409">	// load accounts</a>
<a name="ln410">	for (int i = 0; i &lt; fAccounts.CountItems(); i++)</a>
<a name="ln411">		delete fAccounts.ItemAt(i);</a>
<a name="ln412">	fAccounts.MakeEmpty();</a>
<a name="ln413"> </a>
<a name="ln414">	_LoadAccounts();</a>
<a name="ln415"> </a>
<a name="ln416">	// load in general settings</a>
<a name="ln417">	BMailSettings settings;</a>
<a name="ln418">	status_t status = _SetToGeneralSettings(&amp;settings);</a>
<a name="ln419">	if (status != B_OK) {</a>
<a name="ln420">		fprintf(stderr, B_TRANSLATE(&quot;Error retrieving general settings: %s\n&quot;),</a>
<a name="ln421">			strerror(status));</a>
<a name="ln422">	}</a>
<a name="ln423">}</a>
<a name="ln424"> </a>
<a name="ln425"> </a>
<a name="ln426">void</a>
<a name="ln427">ConfigWindow::_LoadAccounts()</a>
<a name="ln428">{</a>
<a name="ln429">	BMailAccounts accounts;</a>
<a name="ln430">	for (int32 i = 0; i &lt; accounts.CountAccounts(); i++)</a>
<a name="ln431">		fAccounts.AddItem(new BMailAccountSettings(*accounts.AccountAt(i)));</a>
<a name="ln432"> </a>
<a name="ln433">	for (int i = 0; i &lt; fAccounts.CountItems(); i++) {</a>
<a name="ln434">		BMailAccountSettings* account = fAccounts.ItemAt(i);</a>
<a name="ln435">		_AddAccountToView(account);</a>
<a name="ln436">	}</a>
<a name="ln437">}</a>
<a name="ln438"> </a>
<a name="ln439"> </a>
<a name="ln440">void</a>
<a name="ln441">ConfigWindow::_SaveSettings()</a>
<a name="ln442">{</a>
<a name="ln443">	// collect changed accounts</a>
<a name="ln444">	BMessage changedAccounts(BPrivate::kMsgAccountsChanged);</a>
<a name="ln445">	for (int32 i = 0; i &lt; fAccounts.CountItems(); i++) {</a>
<a name="ln446">		BMailAccountSettings* account = fAccounts.ItemAt(i);</a>
<a name="ln447">		if (account &amp;&amp; account-&gt;HasBeenModified())</a>
<a name="ln448">			changedAccounts.AddInt32(&quot;account&quot;, account-&gt;AccountID());</a>
<a name="ln449">	}</a>
<a name="ln450">	for (int32 i = 0; i &lt; fToDeleteAccounts.CountItems(); i++) {</a>
<a name="ln451">		BMailAccountSettings* account = fToDeleteAccounts.ItemAt(i);</a>
<a name="ln452">		changedAccounts.AddInt32(&quot;account&quot;, account-&gt;AccountID());</a>
<a name="ln453">	}</a>
<a name="ln454"> </a>
<a name="ln455">	// cleanup account directory</a>
<a name="ln456">	for (int32 i = 0; i &lt; fToDeleteAccounts.CountItems(); i++) {</a>
<a name="ln457">		BMailAccountSettings* account = fToDeleteAccounts.ItemAt(i);</a>
<a name="ln458">		BEntry entry(account-&gt;AccountFile());</a>
<a name="ln459">		entry.Remove();</a>
<a name="ln460">		delete account;</a>
<a name="ln461">	}</a>
<a name="ln462">	fToDeleteAccounts.MakeEmpty();</a>
<a name="ln463"> </a>
<a name="ln464">	// Apply and save general settings</a>
<a name="ln465"> </a>
<a name="ln466">	BMailSettings settings;</a>
<a name="ln467">	if (fSaveSettings) {</a>
<a name="ln468">		bigtime_t interval = 0;</a>
<a name="ln469">		if (fCheckMailCheckBox-&gt;Value() == B_CONTROL_ON) {</a>
<a name="ln470">			// figure out time interval</a>
<a name="ln471">			float floatInterval;</a>
<a name="ln472">			sscanf(fIntervalControl-&gt;Text(), &quot;%f&quot;, &amp;floatInterval);</a>
<a name="ln473">			interval = bigtime_t(60000000L * floatInterval);</a>
<a name="ln474">		}</a>
<a name="ln475"> </a>
<a name="ln476">		settings.SetAutoCheckInterval(interval);</a>
<a name="ln477">		settings.SetDaemonAutoStarts(!fAccounts.IsEmpty());</a>
<a name="ln478"> </a>
<a name="ln479">		// status mode (alway, fetching/retrieving, ...)</a>
<a name="ln480">		int32 index = fStatusModeField-&gt;Menu()-&gt;IndexOf(</a>
<a name="ln481">			fStatusModeField-&gt;Menu()-&gt;FindMarked());</a>
<a name="ln482">		settings.SetShowStatusWindow(index);</a>
<a name="ln483"> </a>
<a name="ln484">		settings.Save();</a>
<a name="ln485">	}</a>
<a name="ln486"> </a>
<a name="ln487">	// Save accounts</a>
<a name="ln488"> </a>
<a name="ln489">	if (fSaveSettings) {</a>
<a name="ln490">		for (int i = 0; i &lt; fAccounts.CountItems(); i++)</a>
<a name="ln491">			fAccounts.ItemAt(i)-&gt;Save();</a>
<a name="ln492">	}</a>
<a name="ln493"> </a>
<a name="ln494">	BMessenger messenger(B_MAIL_DAEMON_SIGNATURE);</a>
<a name="ln495">	if (messenger.IsValid()) {</a>
<a name="ln496">		// server should reload general settings</a>
<a name="ln497">		messenger.SendMessage(BPrivate::kMsgSettingsUpdated);</a>
<a name="ln498">		// notify server about changed accounts</a>
<a name="ln499">		messenger.SendMessage(&amp;changedAccounts);</a>
<a name="ln500">	}</a>
<a name="ln501"> </a>
<a name="ln502">	// Start/stop the mail_daemon depending on the settings</a>
<a name="ln503">	BMailDaemon daemon;</a>
<a name="ln504">	if (fSaveSettings) {</a>
<a name="ln505">		if (settings.DaemonAutoStarts() &amp;&amp; !daemon.IsRunning())</a>
<a name="ln506">			daemon.Launch();</a>
<a name="ln507">		else if (!settings.DaemonAutoStarts() &amp;&amp; daemon.IsRunning())</a>
<a name="ln508">			daemon.Quit();</a>
<a name="ln509">	}</a>
<a name="ln510">}</a>
<a name="ln511"> </a>
<a name="ln512"> </a>
<a name="ln513">bool</a>
<a name="ln514">ConfigWindow::QuitRequested()</a>
<a name="ln515">{</a>
<a name="ln516">	_SaveSettings();</a>
<a name="ln517"> </a>
<a name="ln518">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln519">	return true;</a>
<a name="ln520">}</a>
<a name="ln521"> </a>
<a name="ln522"> </a>
<a name="ln523">void</a>
<a name="ln524">ConfigWindow::MessageReceived(BMessage *msg)</a>
<a name="ln525">{</a>
<a name="ln526">	float fontFactor = be_plain_font-&gt;Size() / 12.0f;</a>
<a name="ln527">	BRect autoConfigRect(0, 0, 400 * fontFactor, 300 * fontFactor);</a>
<a name="ln528">	BRect frame;</a>
<a name="ln529"> </a>
<a name="ln530">	AutoConfigWindow *autoConfigWindow = NULL;</a>
<a name="ln531">	switch (msg-&gt;what) {</a>
<a name="ln532">		case B_COLORS_UPDATED:</a>
<a name="ln533">		{</a>
<a name="ln534">			rgb_color textColor;</a>
<a name="ln535">			if (msg-&gt;FindColor(ui_color_name(B_PANEL_TEXT_COLOR), &amp;textColor)</a>
<a name="ln536">					== B_OK) {</a>
<a name="ln537">				BFont font;</a>
<a name="ln538">				fHowToTextView-&gt;SetFontAndColor(&amp;font, 0, &amp;textColor);</a>
<a name="ln539">			}</a>
<a name="ln540">			break;</a>
<a name="ln541">		}</a>
<a name="ln542"> </a>
<a name="ln543">		case kMsgAccountsRightClicked:</a>
<a name="ln544">		{</a>
<a name="ln545">			BPoint point;</a>
<a name="ln546">			msg-&gt;FindPoint(&quot;point&quot;, &amp;point);</a>
<a name="ln547">			int32 index = msg-&gt;FindInt32(&quot;index&quot;);</a>
<a name="ln548">			AccountItem* clickedItem = dynamic_cast&lt;AccountItem*&gt;(</a>
<a name="ln549">				fAccountsListView-&gt;ItemAt(index));</a>
<a name="ln550">			if (clickedItem == NULL || clickedItem-&gt;Type() != ACCOUNT_ITEM)</a>
<a name="ln551">				break;</a>
<a name="ln552"> </a>
<a name="ln553">			BPopUpMenu rightClickMenu(&quot;accounts&quot;, false, false);</a>
<a name="ln554"> </a>
<a name="ln555">			BMenuItem* inMenuItem = new BMenuItem(B_TRANSLATE(&quot;Incoming&quot;),</a>
<a name="ln556">				NULL);</a>
<a name="ln557">			BMenuItem* outMenuItem = new BMenuItem(B_TRANSLATE(&quot;Outgoing&quot;),</a>
<a name="ln558">				NULL);</a>
<a name="ln559">			rightClickMenu.AddItem(inMenuItem);</a>
<a name="ln560">			rightClickMenu.AddItem(outMenuItem);</a>
<a name="ln561"> </a>
<a name="ln562">			BMailAccountSettings* settings = clickedItem-&gt;Account();</a>
<a name="ln563">			if (settings-&gt;IsInboundEnabled())</a>
<a name="ln564">				inMenuItem-&gt;SetMarked(true);</a>
<a name="ln565">			if (settings-&gt;IsOutboundEnabled())</a>
<a name="ln566">				outMenuItem-&gt;SetMarked(true);</a>
<a name="ln567"> </a>
<a name="ln568">			BMenuItem* selectedItem = rightClickMenu.Go(point);</a>
<a name="ln569">			if (selectedItem == NULL)</a>
<a name="ln570">				break;</a>
<a name="ln571">			if (selectedItem == inMenuItem) {</a>
<a name="ln572">				AccountItem* item = dynamic_cast&lt;AccountItem*&gt;(</a>
<a name="ln573">					fAccountsListView-&gt;ItemAt(index + 1));</a>
<a name="ln574">				if (item == NULL)</a>
<a name="ln575">					break;</a>
<a name="ln576">				if (settings-&gt;IsInboundEnabled()) {</a>
<a name="ln577">					settings-&gt;SetInboundEnabled(false);</a>
<a name="ln578">					item-&gt;SetEnabled(false);</a>
<a name="ln579">				} else {</a>
<a name="ln580">					settings-&gt;SetInboundEnabled(true);</a>
<a name="ln581">					item-&gt;SetEnabled(true);</a>
<a name="ln582">				}</a>
<a name="ln583">			} else {</a>
<a name="ln584">				AccountItem* item = dynamic_cast&lt;AccountItem*&gt;(</a>
<a name="ln585">					fAccountsListView-&gt;ItemAt(index + 2));</a>
<a name="ln586">				if (item == NULL)</a>
<a name="ln587">					break;</a>
<a name="ln588">				if (settings-&gt;IsOutboundEnabled()) {</a>
<a name="ln589">					settings-&gt;SetOutboundEnabled(false);</a>
<a name="ln590">					item-&gt;SetEnabled(false);</a>
<a name="ln591">				} else {</a>
<a name="ln592">					settings-&gt;SetOutboundEnabled(true);</a>
<a name="ln593">					item-&gt;SetEnabled(true);</a>
<a name="ln594">				}</a>
<a name="ln595">			}</a>
<a name="ln596">		}</a>
<a name="ln597"> </a>
<a name="ln598">		case kMsgAccountSelected:</a>
<a name="ln599">		{</a>
<a name="ln600">			int32 index;</a>
<a name="ln601">			if (msg-&gt;FindInt32(&quot;index&quot;, &amp;index) != B_OK || index &lt; 0) {</a>
<a name="ln602">				// deselect current item</a>
<a name="ln603">				_ReplaceConfigView(_BuildHowToView());</a>
<a name="ln604">				break;</a>
<a name="ln605">			}</a>
<a name="ln606">			AccountItem* item = (AccountItem*)fAccountsListView-&gt;ItemAt(index);</a>
<a name="ln607">			if (item != NULL)</a>
<a name="ln608">				_AccountSelected(item);</a>
<a name="ln609">			break;</a>
<a name="ln610">		}</a>
<a name="ln611"> </a>
<a name="ln612">		case kMsgAddAccount:</a>
<a name="ln613">		{</a>
<a name="ln614">			frame = Frame();</a>
<a name="ln615">			autoConfigRect.OffsetTo(</a>
<a name="ln616">				frame.left + (frame.Width() - autoConfigRect.Width()) / 2,</a>
<a name="ln617">				frame.top + (frame.Width() - autoConfigRect.Height()) / 2);</a>
<a name="ln618">			autoConfigWindow = new AutoConfigWindow(autoConfigRect, this);</a>
<a name="ln619">			autoConfigWindow-&gt;Show();</a>
<a name="ln620">			break;</a>
<a name="ln621">		}</a>
<a name="ln622"> </a>
<a name="ln623">		case kMsgRemoveAccount:</a>
<a name="ln624">		{</a>
<a name="ln625">			int32 index = fAccountsListView-&gt;CurrentSelection();</a>
<a name="ln626">			if (index &gt;= 0) {</a>
<a name="ln627">				AccountItem *item = (AccountItem *)fAccountsListView-&gt;ItemAt(</a>
<a name="ln628">					index);</a>
<a name="ln629">				if (item != NULL) {</a>
<a name="ln630">					_RemoveAccount(item-&gt;Account());</a>
<a name="ln631">					_ReplaceConfigView(_BuildHowToView());</a>
<a name="ln632">				}</a>
<a name="ln633">			}</a>
<a name="ln634">			break;</a>
<a name="ln635">		}</a>
<a name="ln636"> </a>
<a name="ln637">		case kMsgIntervalUnitChanged:</a>
<a name="ln638">		{</a>
<a name="ln639">			int32 index;</a>
<a name="ln640">			if (msg-&gt;FindInt32(&quot;index&quot;,&amp;index) == B_OK)</a>
<a name="ln641">				fIntervalControl-&gt;SetEnabled(index != 0);</a>
<a name="ln642">			break;</a>
<a name="ln643">		}</a>
<a name="ln644"> </a>
<a name="ln645">		case kMsgShowStatusWindowChanged:</a>
<a name="ln646">		{</a>
<a name="ln647">			// the status window stuff is the only &quot;live&quot; setting</a>
<a name="ln648">			BMessenger messenger(&quot;application/x-vnd.Be-POST&quot;);</a>
<a name="ln649">			if (messenger.IsValid())</a>
<a name="ln650">				messenger.SendMessage(msg);</a>
<a name="ln651">			break;</a>
<a name="ln652">		}</a>
<a name="ln653"> </a>
<a name="ln654">		case kMsgRevertSettings:</a>
<a name="ln655">			_RevertToLastSettings();</a>
<a name="ln656">			break;</a>
<a name="ln657"> </a>
<a name="ln658">		case kMsgSaveSettings:</a>
<a name="ln659">			fSaveSettings = true;</a>
<a name="ln660">			_SaveSettings();</a>
<a name="ln661">			AccountUpdated(fLastSelectedAccount);</a>
<a name="ln662">			_ReplaceConfigView(_BuildHowToView());</a>
<a name="ln663">			fAccountsListView-&gt;DeselectAll();</a>
<a name="ln664">			break;</a>
<a name="ln665"> </a>
<a name="ln666">		default:</a>
<a name="ln667">			BWindow::MessageReceived(msg);</a>
<a name="ln668">			break;</a>
<a name="ln669">	}</a>
<a name="ln670">}</a>
<a name="ln671"> </a>
<a name="ln672"> </a>
<a name="ln673">BMailAccountSettings*</a>
<a name="ln674">ConfigWindow::AddAccount()</a>
<a name="ln675">{</a>
<a name="ln676">	BMailAccountSettings* account = new BMailAccountSettings;</a>
<a name="ln677">	if (!account)</a>
<a name="ln678">		return NULL;</a>
<a name="ln679">	fAccounts.AddItem(account);</a>
<a name="ln680">	_AddAccountToView(account);</a>
<a name="ln681">	return account;</a>
<a name="ln682">}</a>
<a name="ln683"> </a>
<a name="ln684"> </a>
<a name="ln685">void</a>
<a name="ln686">ConfigWindow::AccountUpdated(BMailAccountSettings* account)</a>
<a name="ln687">{</a>
<a name="ln688">	if (account == NULL)</a>
<a name="ln689">		return;</a>
<a name="ln690"> </a>
<a name="ln691">	for (int i = 0; i &lt; fAccountsListView-&gt;CountItems(); i++) {</a>
<a name="ln692">		AccountItem* item = (AccountItem*)fAccountsListView-&gt;ItemAt(i);</a>
<a name="ln693">		if (item-&gt;Account() == account) {</a>
<a name="ln694">			if (item-&gt;Type() == ACCOUNT_ITEM) {</a>
<a name="ln695">				item-&gt;SetText(account-&gt;Name());</a>
<a name="ln696">				fAccountsListView-&gt;Invalidate();</a>
<a name="ln697">			}</a>
<a name="ln698">		}</a>
<a name="ln699">	}</a>
<a name="ln700">}</a>
<a name="ln701"> </a>
<a name="ln702"> </a>
<a name="ln703">status_t</a>
<a name="ln704">ConfigWindow::_SetToGeneralSettings(BMailSettings* settings)</a>
<a name="ln705">{</a>
<a name="ln706">	if (settings == NULL)</a>
<a name="ln707">		return B_BAD_VALUE;</a>
<a name="ln708"> </a>
<a name="ln709">	status_t status = settings-&gt;InitCheck();</a>
<a name="ln710">	if (status != B_OK)</a>
<a name="ln711">		return status;</a>
<a name="ln712"> </a>
<a name="ln713">	// retrieval frequency</a>
<a name="ln714">	uint32 interval = uint32(settings-&gt;AutoCheckInterval() / 60000000L);</a>
<a name="ln715">	fCheckMailCheckBox-&gt;SetValue(interval != 0 ? B_CONTROL_ON : B_CONTROL_OFF);</a>
<a name="ln716"> </a>
<a name="ln717">	if (interval == 0)</a>
<a name="ln718">		interval = 5;</a>
<a name="ln719"> </a>
<a name="ln720">	BString intervalText;</a>
<a name="ln721">	intervalText.SetToFormat(&quot;%&quot; B_PRIu32, interval);</a>
<a name="ln722">	fIntervalControl-&gt;SetText(intervalText.String());</a>
<a name="ln723"> </a>
<a name="ln724">	int32 showStatusIndex = settings-&gt;ShowStatusWindow();</a>
<a name="ln725">	BMenuItem* item = fStatusModeField-&gt;Menu()-&gt;ItemAt(showStatusIndex);</a>
<a name="ln726">	if (item != NULL) {</a>
<a name="ln727">		item-&gt;SetMarked(true);</a>
<a name="ln728">		// send live update to the server by simulating a menu click</a>
<a name="ln729">		BMessage msg(kMsgShowStatusWindowChanged);</a>
<a name="ln730">		msg.AddInt32(&quot;ShowStatusWindow&quot;, showStatusIndex);</a>
<a name="ln731">		PostMessage(&amp;msg);</a>
<a name="ln732">	}</a>
<a name="ln733"> </a>
<a name="ln734">	return B_OK;</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737"> </a>
<a name="ln738">void</a>
<a name="ln739">ConfigWindow::_RevertToLastSettings()</a>
<a name="ln740">{</a>
<a name="ln741">	// revert general settings</a>
<a name="ln742">	BMailSettings settings;</a>
<a name="ln743"> </a>
<a name="ln744">	status_t status = _SetToGeneralSettings(&amp;settings);</a>
<a name="ln745">	if (status != B_OK) {</a>
<a name="ln746">		char text[256];</a>
<a name="ln747">		sprintf(text, B_TRANSLATE(</a>
<a name="ln748">				&quot;\nThe general settings couldn't be reverted.\n\n&quot;</a>
<a name="ln749">				&quot;Error retrieving general settings:\n%s\n&quot;),</a>
<a name="ln750">			strerror(status));</a>
<a name="ln751">		BAlert* alert = new BAlert(B_TRANSLATE(&quot;Error&quot;), text,</a>
<a name="ln752">			B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln753">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln754">		alert-&gt;Go();</a>
<a name="ln755">	}</a>
<a name="ln756"> </a>
<a name="ln757">	// revert account data</a>
<a name="ln758"> </a>
<a name="ln759">	if (fAccountsListView-&gt;CurrentSelection() != -1)</a>
<a name="ln760">		_ReplaceConfigView(_BuildHowToView());</a>
<a name="ln761"> </a>
<a name="ln762">	for (int32 i = 0; i &lt; fAccounts.CountItems(); i++) {</a>
<a name="ln763">		BMailAccountSettings* account = fAccounts.ItemAt(i);</a>
<a name="ln764">		_RemoveAccountFromListView(account);</a>
<a name="ln765">		delete account;</a>
<a name="ln766">	}</a>
<a name="ln767"> </a>
<a name="ln768">	fAccounts.MakeEmpty();</a>
<a name="ln769">	_LoadAccounts();</a>
<a name="ln770">}</a>
<a name="ln771"> </a>
<a name="ln772"> </a>
<a name="ln773">void</a>
<a name="ln774">ConfigWindow::_AddAccountToView(BMailAccountSettings* account)</a>
<a name="ln775">{</a>
<a name="ln776">	BString label;</a>
<a name="ln777">	label &lt;&lt; account-&gt;Name();</a>
<a name="ln778"> </a>
<a name="ln779">	AccountItem* item;</a>
<a name="ln780">	item = new AccountItem(label, account, ACCOUNT_ITEM);</a>
<a name="ln781">	fAccountsListView-&gt;AddItem(item);</a>
<a name="ln782"> </a>
<a name="ln783">	item = new AccountItem(B_TRANSLATE(&quot;\t\t· Incoming&quot;), account, INBOUND_ITEM);</a>
<a name="ln784">	fAccountsListView-&gt;AddItem(item);</a>
<a name="ln785">	if (!account-&gt;IsInboundEnabled())</a>
<a name="ln786">		item-&gt;SetEnabled(false);</a>
<a name="ln787"> </a>
<a name="ln788">	item = new AccountItem(B_TRANSLATE(&quot;\t\t· Outgoing&quot;), account,</a>
<a name="ln789">		OUTBOUND_ITEM);</a>
<a name="ln790">	fAccountsListView-&gt;AddItem(item);</a>
<a name="ln791">	if (!account-&gt;IsOutboundEnabled())</a>
<a name="ln792">		item-&gt;SetEnabled(false);</a>
<a name="ln793"> </a>
<a name="ln794">	item = new AccountItem(B_TRANSLATE(&quot;\t\t· E-mail filters&quot;), account,</a>
<a name="ln795">		FILTER_ITEM);</a>
<a name="ln796">	fAccountsListView-&gt;AddItem(item);</a>
<a name="ln797">}</a>
<a name="ln798"> </a>
<a name="ln799"> </a>
<a name="ln800">void</a>
<a name="ln801">ConfigWindow::_RemoveAccount(BMailAccountSettings* account)</a>
<a name="ln802">{</a>
<a name="ln803">	_RemoveAccountFromListView(account);</a>
<a name="ln804">	fAccounts.RemoveItem(account);</a>
<a name="ln805">	fToDeleteAccounts.AddItem(account);</a>
<a name="ln806">}</a>
<a name="ln807"> </a>
<a name="ln808"> </a>
<a name="ln809">void</a>
<a name="ln810">ConfigWindow::_RemoveAccountFromListView(BMailAccountSettings* account)</a>
<a name="ln811">{</a>
<a name="ln812">	if (fLastSelectedAccount == account) {</a>
<a name="ln813">		_ReplaceConfigView(_BuildHowToView());</a>
<a name="ln814">		fLastSelectedAccount = NULL;</a>
<a name="ln815">	}</a>
<a name="ln816"> </a>
<a name="ln817">	for (int i = fAccountsListView-&gt;CountItems(); i-- &gt; 0;) {</a>
<a name="ln818">		AccountItem* item = (AccountItem*)fAccountsListView-&gt;ItemAt(i);</a>
<a name="ln819">		if (item-&gt;Account() == account) {</a>
<a name="ln820">			fAccountsListView-&gt;RemoveItem(i);</a>
<a name="ln821">			delete item;</a>
<a name="ln822">		}</a>
<a name="ln823">	}</a>
<a name="ln824">}</a>
<a name="ln825"> </a>
<a name="ln826"> </a>
<a name="ln827">void</a>
<a name="ln828">ConfigWindow::_AccountSelected(AccountItem* item)</a>
<a name="ln829">{</a>
<a name="ln830">	AccountUpdated(fLastSelectedAccount);</a>
<a name="ln831"> </a>
<a name="ln832">	BMailAccountSettings* account = item-&gt;Account();</a>
<a name="ln833">	fLastSelectedAccount = account;</a>
<a name="ln834"> </a>
<a name="ln835">	BView* view = NULL;</a>
<a name="ln836">	switch (item-&gt;Type()) {</a>
<a name="ln837">		case ACCOUNT_ITEM:</a>
<a name="ln838">			view = new AccountConfigView(account);</a>
<a name="ln839">			break;</a>
<a name="ln840"> </a>
<a name="ln841">		case INBOUND_ITEM:</a>
<a name="ln842">			view = new ProtocolSettingsView(account-&gt;InboundAddOnRef(),</a>
<a name="ln843">				*account, account-&gt;InboundSettings());</a>
<a name="ln844">			break;</a>
<a name="ln845"> </a>
<a name="ln846">		case OUTBOUND_ITEM:</a>
<a name="ln847">			view = new ProtocolSettingsView(account-&gt;OutboundAddOnRef(),</a>
<a name="ln848">				*account, account-&gt;OutboundSettings());</a>
<a name="ln849">			break;</a>
<a name="ln850"> </a>
<a name="ln851">		case FILTER_ITEM:</a>
<a name="ln852">			view = new FiltersConfigView(*account);</a>
<a name="ln853">			break;</a>
<a name="ln854">	}</a>
<a name="ln855"> </a>
<a name="ln856">	_ReplaceConfigView(view);</a>
<a name="ln857">}</a>
<a name="ln858"> </a>
<a name="ln859"> </a>
<a name="ln860">void</a>
<a name="ln861">ConfigWindow::_ReplaceConfigView(BView* view)</a>
<a name="ln862">{</a>
<a name="ln863">	while (BView* child = fConfigView-&gt;ChildAt(0)) {</a>
<a name="ln864">		fConfigView-&gt;RemoveChild(child);</a>
<a name="ln865">		delete child;</a>
<a name="ln866">	}</a>
<a name="ln867"> </a>
<a name="ln868">	if (view != NULL)</a>
<a name="ln869">		fConfigView-&gt;AddChild(view);</a>
<a name="ln870">}</a>

</code></pre>
<div class="balloon" rel="755"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
