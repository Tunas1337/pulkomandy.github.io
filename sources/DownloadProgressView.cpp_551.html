
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>DownloadProgressView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright (C) 2010 Stephan AÃŸmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln3"> *</a>
<a name="ln4"> * All rights reserved. Distributed under the terms of the MIT License.</a>
<a name="ln5"> */</a>
<a name="ln6"> </a>
<a name="ln7">#include &quot;DownloadProgressView.h&quot;</a>
<a name="ln8"> </a>
<a name="ln9">#include &lt;stdio.h&gt;</a>
<a name="ln10"> </a>
<a name="ln11">#include &lt;Alert.h&gt;</a>
<a name="ln12">#include &lt;Application.h&gt;</a>
<a name="ln13">#include &lt;Bitmap.h&gt;</a>
<a name="ln14">#include &lt;Button.h&gt;</a>
<a name="ln15">#include &lt;Catalog.h&gt;</a>
<a name="ln16">#include &lt;Clipboard.h&gt;</a>
<a name="ln17">#include &lt;Directory.h&gt;</a>
<a name="ln18">#include &lt;DateTimeFormat.h&gt;</a>
<a name="ln19">#include &lt;DurationFormat.h&gt;</a>
<a name="ln20">#include &lt;Entry.h&gt;</a>
<a name="ln21">#include &lt;FindDirectory.h&gt;</a>
<a name="ln22">#include &lt;GroupLayoutBuilder.h&gt;</a>
<a name="ln23">#include &lt;Locale.h&gt;</a>
<a name="ln24">#include &lt;MenuItem.h&gt;</a>
<a name="ln25">#include &lt;NodeInfo.h&gt;</a>
<a name="ln26">#include &lt;NodeMonitor.h&gt;</a>
<a name="ln27">#include &lt;Notification.h&gt;</a>
<a name="ln28">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln29">#include &lt;Roster.h&gt;</a>
<a name="ln30">#include &lt;SpaceLayoutItem.h&gt;</a>
<a name="ln31">#include &lt;StatusBar.h&gt;</a>
<a name="ln32">#include &lt;StringView.h&gt;</a>
<a name="ln33">#include &lt;TimeFormat.h&gt;</a>
<a name="ln34"> </a>
<a name="ln35">#include &quot;BrowserWindow.h&quot;</a>
<a name="ln36">#include &quot;WebDownload.h&quot;</a>
<a name="ln37">#include &quot;WebPage.h&quot;</a>
<a name="ln38">#include &quot;StringForSize.h&quot;</a>
<a name="ln39"> </a>
<a name="ln40"> </a>
<a name="ln41">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln42">#define B_TRANSLATION_CONTEXT &quot;Download Window&quot;</a>
<a name="ln43"> </a>
<a name="ln44">enum {</a>
<a name="ln45">	OPEN_DOWNLOAD			= 'opdn',</a>
<a name="ln46">	RESTART_DOWNLOAD		= 'rsdn',</a>
<a name="ln47">	CANCEL_DOWNLOAD			= 'cndn',</a>
<a name="ln48">	REMOVE_DOWNLOAD			= 'rmdn',</a>
<a name="ln49">	COPY_URL_TO_CLIPBOARD	= 'curl',</a>
<a name="ln50">	OPEN_CONTAINING_FOLDER	= 'opfd',</a>
<a name="ln51">};</a>
<a name="ln52"> </a>
<a name="ln53">const bigtime_t kMaxUpdateInterval = 100000LL;</a>
<a name="ln54">const bigtime_t kSpeedReferenceInterval = 500000LL;</a>
<a name="ln55">const bigtime_t kShowSpeedInterval = 8000000LL;</a>
<a name="ln56">const bigtime_t kShowEstimatedFinishInterval = 4000000LL;</a>
<a name="ln57"> </a>
<a name="ln58">bigtime_t DownloadProgressView::sLastEstimatedFinishSpeedToggleTime = -1;</a>
<a name="ln59">bool DownloadProgressView::sShowSpeed = true;</a>
<a name="ln60">static const time_t kSecondsPerDay = 24 * 60 * 60;</a>
<a name="ln61">static const time_t kSecondsPerHour = 60 * 60;</a>
<a name="ln62"> </a>
<a name="ln63"> </a>
<a name="ln64">class IconView : public BView {</a>
<a name="ln65">public:</a>
<a name="ln66">	IconView(const BEntry&amp; entry)</a>
<a name="ln67">		:</a>
<a name="ln68">		BView(&quot;Download icon&quot;, B_WILL_DRAW),</a>
<a name="ln69">		fIconBitmap(BRect(0, 0, 31, 31), 0, B_RGBA32),</a>
<a name="ln70">		fDimmedIcon(false)</a>
<a name="ln71">	{</a>
<a name="ln72">		SetDrawingMode(B_OP_OVER);</a>
<a name="ln73">		SetTo(entry);</a>
<a name="ln74">	}</a>
<a name="ln75"> </a>
<a name="ln76">	IconView()</a>
<a name="ln77">		:</a>
<a name="ln78">		BView(&quot;Download icon&quot;, B_WILL_DRAW),</a>
<a name="ln79">		fIconBitmap(BRect(0, 0, 31, 31), 0, B_RGBA32),</a>
<a name="ln80">		fDimmedIcon(false)</a>
<a name="ln81">	{</a>
<a name="ln82">		SetDrawingMode(B_OP_OVER);</a>
<a name="ln83">		memset(fIconBitmap.Bits(), 0, fIconBitmap.BitsLength());</a>
<a name="ln84">	}</a>
<a name="ln85"> </a>
<a name="ln86">	IconView(BMessage* archive)</a>
<a name="ln87">		:</a>
<a name="ln88">		BView(&quot;Download icon&quot;, B_WILL_DRAW),</a>
<a name="ln89">		fIconBitmap(archive),</a>
<a name="ln90">		fDimmedIcon(true)</a>
<a name="ln91">	{</a>
<a name="ln92">		SetDrawingMode(B_OP_OVER);</a>
<a name="ln93">	}</a>
<a name="ln94"> </a>
<a name="ln95">	void SetTo(const BEntry&amp; entry)</a>
<a name="ln96">	{</a>
<a name="ln97">		BNode node(&amp;entry);</a>
<a name="ln98">		BNodeInfo info(&amp;node);</a>
<a name="ln99">		info.GetTrackerIcon(&amp;fIconBitmap, B_LARGE_ICON);</a>
<a name="ln100">		Invalidate();</a>
<a name="ln101">	}</a>
<a name="ln102"> </a>
<a name="ln103">	void SetIconDimmed(bool iconDimmed)</a>
<a name="ln104">	{</a>
<a name="ln105">		if (fDimmedIcon != iconDimmed) {</a>
<a name="ln106">			fDimmedIcon = iconDimmed;</a>
<a name="ln107">			Invalidate();</a>
<a name="ln108">		}</a>
<a name="ln109">	}</a>
<a name="ln110"> </a>
<a name="ln111">	bool IsIconDimmed() const</a>
<a name="ln112">	{</a>
<a name="ln113">		return fDimmedIcon;</a>
<a name="ln114">	}</a>
<a name="ln115"> </a>
<a name="ln116">	status_t SaveSettings(BMessage* archive)</a>
<a name="ln117">	{</a>
<a name="ln118">		return fIconBitmap.Archive(archive);</a>
<a name="ln119">	}</a>
<a name="ln120"> </a>
<a name="ln121">	virtual void AttachedToWindow()</a>
<a name="ln122">	{</a>
<a name="ln123">		AdoptParentColors();</a>
<a name="ln124">	}</a>
<a name="ln125"> </a>
<a name="ln126">	virtual void Draw(BRect updateRect)</a>
<a name="ln127">	{</a>
<a name="ln128">		if (fDimmedIcon) {</a>
<a name="ln129">			SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln130">			SetBlendingMode(B_CONSTANT_ALPHA, B_ALPHA_OVERLAY);</a>
<a name="ln131">			SetHighColor(0, 0, 0, 100);</a>
<a name="ln132">		}</a>
<a name="ln133">		DrawBitmapAsync(&amp;fIconBitmap);</a>
<a name="ln134">	}</a>
<a name="ln135"> </a>
<a name="ln136">	virtual BSize MinSize()</a>
<a name="ln137">	{</a>
<a name="ln138">		return BSize(fIconBitmap.Bounds().Width(),</a>
<a name="ln139">			fIconBitmap.Bounds().Height());</a>
<a name="ln140">	}</a>
<a name="ln141"> </a>
<a name="ln142">	virtual BSize PreferredSize()</a>
<a name="ln143">	{</a>
<a name="ln144">		return MinSize();</a>
<a name="ln145">	}</a>
<a name="ln146"> </a>
<a name="ln147">	virtual BSize MaxSize()</a>
<a name="ln148">	{</a>
<a name="ln149">		return MinSize();</a>
<a name="ln150">	}</a>
<a name="ln151"> </a>
<a name="ln152">	BBitmap* Bitmap()</a>
<a name="ln153">	{</a>
<a name="ln154">		return &amp;fIconBitmap;</a>
<a name="ln155">	}</a>
<a name="ln156"> </a>
<a name="ln157">private:</a>
<a name="ln158">	BBitmap	fIconBitmap;</a>
<a name="ln159">	bool	fDimmedIcon;</a>
<a name="ln160">};</a>
<a name="ln161"> </a>
<a name="ln162"> </a>
<a name="ln163">class SmallButton : public BButton {</a>
<a name="ln164">public:</a>
<a name="ln165">	SmallButton(const char* label, BMessage* message = NULL)</a>
<a name="ln166">		:</a>
<a name="ln167">		BButton(label, message)</a>
<a name="ln168">	{</a>
<a name="ln169">		BFont font;</a>
<a name="ln170">		GetFont(&amp;font);</a>
<a name="ln171">		float size = ceilf(font.Size() * 0.8);</a>
<a name="ln172">		font.SetSize(max_c(8, size));</a>
<a name="ln173">		SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln174">	}</a>
<a name="ln175">};</a>
<a name="ln176"> </a>
<a name="ln177"> </a>
<a name="ln178">// #pragma mark - DownloadProgressView</a>
<a name="ln179"> </a>
<a name="ln180"> </a>
<a name="ln181">DownloadProgressView::DownloadProgressView(BWebDownload* download)</a>
<a name="ln182">	:</a>
<a name="ln183">	BGroupView(B_HORIZONTAL, 8),</a>
<a name="ln184">	fDownload(download),</a>
<a name="ln185">	fURL(download-&gt;URL()),</a>
<a name="ln186">	fPath(download-&gt;Path())</a>
<a name="ln187">{</a>
<a name="ln188">}</a>
<a name="ln189"> </a>
<a name="ln190"> </a>
<a name="ln191">DownloadProgressView::DownloadProgressView(const BMessage* archive)</a>
<a name="ln192">	:</a>
<a name="ln193">	BGroupView(B_HORIZONTAL, 8),</a>
<a name="ln194">	fDownload(NULL),</a>
<a name="ln195">	fURL(),</a>
<a name="ln196">	fPath()</a>
<a name="ln197">{</a>
<a name="ln198">	const char* string;</a>
<a name="ln199">	if (archive-&gt;FindString(&quot;path&quot;, &amp;string) == B_OK)</a>
<a name="ln200">		fPath.SetTo(string);</a>
<a name="ln201">	if (archive-&gt;FindString(&quot;url&quot;, &amp;string) == B_OK)</a>
<a name="ln202">		fURL = string;</a>
<a name="ln203">}</a>
<a name="ln204"> </a>
<a name="ln205"> </a>
<a name="ln206">bool</a>
<a name="ln207">DownloadProgressView::Init(BMessage* archive)</a>
<a name="ln208">{</a>
<a name="ln209">	fCurrentSize = 0;</a>
<a name="ln210">	fExpectedSize = 0;</a>
<a name="ln211">	fLastUpdateTime = 0;</a>
<a name="ln212">	fBytesPerSecond = 0.0;</a>
<a name="ln213">	for (size_t i = 0; i &lt; kBytesPerSecondSlots; i++)</a>
<a name="ln214">		fBytesPerSecondSlot[i] = 0.0;</a>
<a name="ln215">	fCurrentBytesPerSecondSlot = 0;</a>
<a name="ln216">	fLastSpeedReferenceSize = 0;</a>
<a name="ln217">	fEstimatedFinishReferenceSize = 0;</a>
<a name="ln218"> </a>
<a name="ln219">	fProcessStartTime = fLastSpeedReferenceTime</a>
<a name="ln220">		= fEstimatedFinishReferenceTime	= system_time();</a>
<a name="ln221"> </a>
<a name="ln222">	SetViewColor(245, 245, 245);</a>
<a name="ln223">	SetFlags(Flags() | B_FULL_UPDATE_ON_RESIZE | B_WILL_DRAW);</a>
<a name="ln224"> </a>
<a name="ln225">	if (archive) {</a>
<a name="ln226">		fStatusBar = new BStatusBar(&quot;download progress&quot;, fPath.Leaf());</a>
<a name="ln227">		float value;</a>
<a name="ln228">		if (archive-&gt;FindFloat(&quot;value&quot;, &amp;value) == B_OK)</a>
<a name="ln229">			fStatusBar-&gt;SetTo(value);</a>
<a name="ln230">	} else</a>
<a name="ln231">		fStatusBar = new BStatusBar(&quot;download progress&quot;, &quot;Download&quot;);</a>
<a name="ln232">	fStatusBar-&gt;SetMaxValue(100);</a>
<a name="ln233">	fStatusBar-&gt;SetBarHeight(12);</a>
<a name="ln234"> </a>
<a name="ln235">	// fPath is only valid when constructed from archive (fDownload == NULL)</a>
<a name="ln236">	BEntry entry(fPath.Path());</a>
<a name="ln237"> </a>
<a name="ln238">	if (archive) {</a>
<a name="ln239">		if (!entry.Exists())</a>
<a name="ln240">			fIconView = new IconView(archive);</a>
<a name="ln241">		else</a>
<a name="ln242">			fIconView = new IconView(entry);</a>
<a name="ln243">	} else</a>
<a name="ln244">		fIconView = new IconView();</a>
<a name="ln245"> </a>
<a name="ln246">	if (!fDownload &amp;&amp; (fStatusBar-&gt;CurrentValue() &lt; 100 || !entry.Exists())) {</a>
<a name="ln247">		fTopButton = new SmallButton(B_TRANSLATE(&quot;Restart&quot;),</a>
<a name="ln248">			new BMessage(RESTART_DOWNLOAD));</a>
<a name="ln249">	} else {</a>
<a name="ln250">		fTopButton = new SmallButton(B_TRANSLATE(&quot;Open&quot;),</a>
<a name="ln251">			new BMessage(OPEN_DOWNLOAD));</a>
<a name="ln252">		fTopButton-&gt;SetEnabled(fDownload == NULL);</a>
<a name="ln253">	}</a>
<a name="ln254">	if (fDownload) {</a>
<a name="ln255">		fBottomButton = new SmallButton(B_TRANSLATE(&quot;Cancel&quot;),</a>
<a name="ln256">			new BMessage(CANCEL_DOWNLOAD));</a>
<a name="ln257">	} else {</a>
<a name="ln258">		fBottomButton = new SmallButton(B_TRANSLATE(&quot;Remove&quot;),</a>
<a name="ln259">			new BMessage(REMOVE_DOWNLOAD));</a>
<a name="ln260">		fBottomButton-&gt;SetEnabled(fDownload == NULL);</a>
<a name="ln261">	}</a>
<a name="ln262"> </a>
<a name="ln263">	fInfoView = new BStringView(&quot;info view&quot;, &quot;&quot;);</a>
<a name="ln264">	fInfoView-&gt;SetViewColor(ViewColor());</a>
<a name="ln265"> </a>
<a name="ln266">	BSize topButtonSize = fTopButton-&gt;PreferredSize();</a>
<a name="ln267">	BSize bottomButtonSize = fBottomButton-&gt;PreferredSize();</a>
<a name="ln268">	if (bottomButtonSize.width &lt; topButtonSize.width)</a>
<a name="ln269">		fBottomButton-&gt;SetExplicitMaxSize(topButtonSize);</a>
<a name="ln270">	else</a>
<a name="ln271">		fTopButton-&gt;SetExplicitMaxSize(bottomButtonSize);</a>
<a name="ln272"> </a>
<a name="ln273">	BGroupLayout* layout = GroupLayout();</a>
<a name="ln274">	layout-&gt;SetInsets(8, 5, 5, 6);</a>
<a name="ln275">	layout-&gt;AddView(fIconView);</a>
<a name="ln276">	BView* verticalGroup = BGroupLayoutBuilder(B_VERTICAL, 3)</a>
<a name="ln277">		.Add(fStatusBar)</a>
<a name="ln278">		.Add(fInfoView)</a>
<a name="ln279">		.TopView()</a>
<a name="ln280">	;</a>
<a name="ln281">	verticalGroup-&gt;SetViewColor(ViewColor());</a>
<a name="ln282">	layout-&gt;AddView(verticalGroup);</a>
<a name="ln283"> </a>
<a name="ln284">	verticalGroup = BGroupLayoutBuilder(B_VERTICAL, 3)</a>
<a name="ln285">		.Add(fTopButton)</a>
<a name="ln286">		.Add(fBottomButton)</a>
<a name="ln287">		.TopView()</a>
<a name="ln288">	;</a>
<a name="ln289">	verticalGroup-&gt;SetViewColor(ViewColor());</a>
<a name="ln290">	layout-&gt;AddView(verticalGroup);</a>
<a name="ln291"> </a>
<a name="ln292">	BFont font;</a>
<a name="ln293">	fInfoView-&gt;GetFont(&amp;font);</a>
<a name="ln294">	float fontSize = font.Size() * 0.8f;</a>
<a name="ln295">	font.SetSize(max_c(8.0f, fontSize));</a>
<a name="ln296">	fInfoView-&gt;SetFont(&amp;font, B_FONT_SIZE);</a>
<a name="ln297">	fInfoView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln298"> </a>
<a name="ln299">	return true;</a>
<a name="ln300">}</a>
<a name="ln301"> </a>
<a name="ln302"> </a>
<a name="ln303">status_t</a>
<a name="ln304">DownloadProgressView::SaveSettings(BMessage* archive)</a>
<a name="ln305">{</a>
<a name="ln306">	if (!archive)</a>
<a name="ln307">		return B_BAD_VALUE;</a>
<a name="ln308">	status_t ret = archive-&gt;AddString(&quot;path&quot;, fPath.Path());</a>
<a name="ln309">	if (ret == B_OK)</a>
<a name="ln310">		ret = archive-&gt;AddString(&quot;url&quot;, fURL.String());</a>
<a name="ln311">	if (ret == B_OK)</a>
<a name="ln312">		ret = archive-&gt;AddFloat(&quot;value&quot;, fStatusBar-&gt;CurrentValue());</a>
<a name="ln313">	if (ret == B_OK)</a>
<a name="ln314">		ret = fIconView-&gt;SaveSettings(archive);</a>
<a name="ln315">	return ret;</a>
<a name="ln316">}</a>
<a name="ln317"> </a>
<a name="ln318"> </a>
<a name="ln319">void</a>
<a name="ln320">DownloadProgressView::AttachedToWindow()</a>
<a name="ln321">{</a>
<a name="ln322">	if (fDownload) {</a>
<a name="ln323">		fDownload-&gt;SetProgressListener(BMessenger(this));</a>
<a name="ln324">		// Will start node monitor upon receiving the B_DOWNLOAD_STARTED</a>
<a name="ln325">		// message.</a>
<a name="ln326">	} else {</a>
<a name="ln327">		BEntry entry(fPath.Path());</a>
<a name="ln328">		if (entry.Exists())</a>
<a name="ln329">			_StartNodeMonitor(entry);</a>
<a name="ln330">	}</a>
<a name="ln331"> </a>
<a name="ln332">	fTopButton-&gt;SetTarget(this);</a>
<a name="ln333">	fBottomButton-&gt;SetTarget(this);</a>
<a name="ln334">}</a>
<a name="ln335"> </a>
<a name="ln336"> </a>
<a name="ln337">void</a>
<a name="ln338">DownloadProgressView::DetachedFromWindow()</a>
<a name="ln339">{</a>
<a name="ln340">	_StopNodeMonitor();</a>
<a name="ln341">}</a>
<a name="ln342"> </a>
<a name="ln343"> </a>
<a name="ln344">void</a>
<a name="ln345">DownloadProgressView::AllAttached()</a>
<a name="ln346">{</a>
<a name="ln347">	fStatusBar-&gt;SetLowColor(ViewColor());</a>
<a name="ln348">	fInfoView-&gt;SetLowColor(ViewColor());</a>
<a name="ln349">	fInfoView-&gt;SetHighColor(0, 0, 0, 255);</a>
<a name="ln350"> </a>
<a name="ln351">	SetViewColor(B_TRANSPARENT_COLOR);</a>
<a name="ln352">	SetLowColor(245, 245, 245);</a>
<a name="ln353">	SetHighColor(tint_color(LowColor(), B_DARKEN_1_TINT));</a>
<a name="ln354">}</a>
<a name="ln355"> </a>
<a name="ln356"> </a>
<a name="ln357">void</a>
<a name="ln358">DownloadProgressView::Draw(BRect updateRect)</a>
<a name="ln359">{</a>
<a name="ln360">	BRect bounds(Bounds());</a>
<a name="ln361">	bounds.bottom--;</a>
<a name="ln362">	FillRect(bounds, B_SOLID_LOW);</a>
<a name="ln363">	bounds.bottom++;</a>
<a name="ln364">	StrokeLine(bounds.LeftBottom(), bounds.RightBottom());</a>
<a name="ln365">}</a>
<a name="ln366"> </a>
<a name="ln367"> </a>
<a name="ln368">void</a>
<a name="ln369">DownloadProgressView::MessageReceived(BMessage* message)</a>
<a name="ln370">{</a>
<a name="ln371">	switch (message-&gt;what) {</a>
<a name="ln372">		case B_DOWNLOAD_STARTED:</a>
<a name="ln373">		{</a>
<a name="ln374">			BString path;</a>
<a name="ln375">			if (message-&gt;FindString(&quot;path&quot;, &amp;path) != B_OK)</a>
<a name="ln376">				break;</a>
<a name="ln377">			fPath.SetTo(path);</a>
<a name="ln378">			BEntry entry(fPath.Path());</a>
<a name="ln379">			fIconView-&gt;SetTo(entry);</a>
<a name="ln380">			fStatusBar-&gt;Reset(fPath.Leaf());</a>
<a name="ln381">			_StartNodeMonitor(entry);</a>
<a name="ln382"> </a>
<a name="ln383">			// Immediately switch to speed display whenever a new download</a>
<a name="ln384">			// starts.</a>
<a name="ln385">			sShowSpeed = true;</a>
<a name="ln386">			sLastEstimatedFinishSpeedToggleTime</a>
<a name="ln387">				= fProcessStartTime = fLastSpeedReferenceTime</a>
<a name="ln388">				= fEstimatedFinishReferenceTime = system_time();</a>
<a name="ln389">			break;</a>
<a name="ln390">		}</a>
<a name="ln391">		case B_DOWNLOAD_PROGRESS:</a>
<a name="ln392">		{</a>
<a name="ln393">			int64 currentSize;</a>
<a name="ln394">			int64 expectedSize;</a>
<a name="ln395">			if (message-&gt;FindInt64(&quot;current size&quot;, &amp;currentSize) == B_OK</a>
<a name="ln396">				&amp;&amp; message-&gt;FindInt64(&quot;expected size&quot;, &amp;expectedSize) == B_OK) {</a>
<a name="ln397">				_UpdateStatus(currentSize, expectedSize);</a>
<a name="ln398">			}</a>
<a name="ln399">			break;</a>
<a name="ln400">		}</a>
<a name="ln401">		case B_DOWNLOAD_REMOVED:</a>
<a name="ln402">			// TODO: This is a bit asymetric. The removed notification</a>
<a name="ln403">			// arrives here, but it would be nicer if it arrived</a>
<a name="ln404">			// at the window...</a>
<a name="ln405">			Window()-&gt;PostMessage(message);</a>
<a name="ln406">			break;</a>
<a name="ln407">		case OPEN_DOWNLOAD:</a>
<a name="ln408">		{</a>
<a name="ln409">			// TODO: In case of executable files, ask the user first!</a>
<a name="ln410">			entry_ref ref;</a>
<a name="ln411">			status_t status = get_ref_for_path(fPath.Path(), &amp;ref);</a>
<a name="ln412">			if (status == B_OK)</a>
<a name="ln413">				status = be_roster-&gt;Launch(&amp;ref);</a>
<a name="ln414">			if (status != B_OK &amp;&amp; status != B_ALREADY_RUNNING) {</a>
<a name="ln415">				BAlert* alert = new BAlert(B_TRANSLATE(&quot;Open download error&quot;),</a>
<a name="ln416">					B_TRANSLATE(&quot;The download could not be opened.&quot;),</a>
<a name="ln417">					B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln418">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln419">				alert-&gt;Go(NULL);</a>
<a name="ln420">			}</a>
<a name="ln421">			break;</a>
<a name="ln422">		}</a>
<a name="ln423">		case RESTART_DOWNLOAD:</a>
<a name="ln424">		{</a>
<a name="ln425">			// We can't create a download without a full web context (mainly</a>
<a name="ln426">			// because it needs to access the cookie jar), and when we get here</a>
<a name="ln427">			// the original context is long gone (possibly the browser was</a>
<a name="ln428">			// restarted). So we create a new window to restart the download</a>
<a name="ln429">			// in a fresh context.</a>
<a name="ln430">			// FIXME this has of course the huge downside of leaving the new</a>
<a name="ln431">			// window open with a blank page. I can't think of a better</a>
<a name="ln432">			// solution right now...</a>
<a name="ln433">			BMessage* request = new BMessage(NEW_WINDOW);</a>
<a name="ln434">			request-&gt;AddString(&quot;url&quot;, fURL);</a>
<a name="ln435">			be_app-&gt;PostMessage(request);</a>
<a name="ln436">			break;</a>
<a name="ln437">		}</a>
<a name="ln438"> </a>
<a name="ln439">		case CANCEL_DOWNLOAD:</a>
<a name="ln440">			CancelDownload();</a>
<a name="ln441">			break;</a>
<a name="ln442"> </a>
<a name="ln443">		case REMOVE_DOWNLOAD:</a>
<a name="ln444">		{</a>
<a name="ln445">			Window()-&gt;PostMessage(SAVE_SETTINGS);</a>
<a name="ln446">			RemoveSelf();</a>
<a name="ln447">			delete this;</a>
<a name="ln448">			// TOAST!</a>
<a name="ln449">			return;</a>
<a name="ln450">		}</a>
<a name="ln451">		case B_NODE_MONITOR:</a>
<a name="ln452">		{</a>
<a name="ln453">			int32 opCode;</a>
<a name="ln454">			if (message-&gt;FindInt32(&quot;opcode&quot;, &amp;opCode) != B_OK)</a>
<a name="ln455">				break;</a>
<a name="ln456">			switch (opCode) {</a>
<a name="ln457">				case B_ENTRY_REMOVED:</a>
<a name="ln458">					fIconView-&gt;SetIconDimmed(true);</a>
<a name="ln459">					CancelDownload();</a>
<a name="ln460">					break;</a>
<a name="ln461">				case B_ENTRY_MOVED:</a>
<a name="ln462">				{</a>
<a name="ln463">					// Follow the entry to the new location</a>
<a name="ln464">					dev_t device;</a>
<a name="ln465">					ino_t directory;</a>
<a name="ln466">					const char* name;</a>
<a name="ln467">					if (message-&gt;FindInt32(&quot;device&quot;,</a>
<a name="ln468">							reinterpret_cast&lt;int32*&gt;(&amp;device)) != B_OK</a>
<a name="ln469">						|| message-&gt;FindInt64(&quot;to directory&quot;,</a>
<a name="ln470">							reinterpret_cast&lt;int64*&gt;(&amp;directory)) != B_OK</a>
<a name="ln471">						|| message-&gt;FindString(&quot;name&quot;, &amp;name) != B_OK</a>
<a name="ln472">						|| strlen(name) == 0) {</a>
<a name="ln473">						break;</a>
<a name="ln474">					}</a>
<a name="ln475">					// Construct the BEntry and update fPath</a>
<a name="ln476">					entry_ref ref(device, directory, name);</a>
<a name="ln477">					BEntry entry(&amp;ref);</a>
<a name="ln478">					if (entry.GetPath(&amp;fPath) != B_OK)</a>
<a name="ln479">						break;</a>
<a name="ln480"> </a>
<a name="ln481">					// Find out if the directory is the Trash for this</a>
<a name="ln482">					// volume</a>
<a name="ln483">					char trashPath[B_PATH_NAME_LENGTH];</a>
<a name="ln484">					if (find_directory(B_TRASH_DIRECTORY, device, false,</a>
<a name="ln485">							trashPath, B_PATH_NAME_LENGTH) == B_OK) {</a>
<a name="ln486">						BPath trashDirectory(trashPath);</a>
<a name="ln487">						BPath parentDirectory;</a>
<a name="ln488">						fPath.GetParent(&amp;parentDirectory);</a>
<a name="ln489">						if (parentDirectory == trashDirectory) {</a>
<a name="ln490">							// The entry was moved into the Trash.</a>
<a name="ln491">							// If the download is still in progress,</a>
<a name="ln492">							// cancel it.</a>
<a name="ln493">							fIconView-&gt;SetIconDimmed(true);</a>
<a name="ln494">							CancelDownload();</a>
<a name="ln495">							break;</a>
<a name="ln496">						} else if (fIconView-&gt;IsIconDimmed()) {</a>
<a name="ln497">							// Maybe it was moved out of the trash.</a>
<a name="ln498">							fIconView-&gt;SetIconDimmed(false);</a>
<a name="ln499">						}</a>
<a name="ln500">					}</a>
<a name="ln501"> </a>
<a name="ln502">					// Inform download of the new path</a>
<a name="ln503">					if (fDownload)</a>
<a name="ln504">						fDownload-&gt;HasMovedTo(fPath);</a>
<a name="ln505"> </a>
<a name="ln506">					float value = fStatusBar-&gt;CurrentValue();</a>
<a name="ln507">					fStatusBar-&gt;Reset(name);</a>
<a name="ln508">					fStatusBar-&gt;SetTo(value);</a>
<a name="ln509">					Window()-&gt;PostMessage(SAVE_SETTINGS);</a>
<a name="ln510">					break;</a>
<a name="ln511">				}</a>
<a name="ln512">				case B_ATTR_CHANGED:</a>
<a name="ln513">				{</a>
<a name="ln514">					BEntry entry(fPath.Path());</a>
<a name="ln515">					fIconView-&gt;SetIconDimmed(false);</a>
<a name="ln516">					fIconView-&gt;SetTo(entry);</a>
<a name="ln517">					break;</a>
<a name="ln518">				}</a>
<a name="ln519">			}</a>
<a name="ln520">			break;</a>
<a name="ln521">		}</a>
<a name="ln522"> </a>
<a name="ln523">		// Context menu messages</a>
<a name="ln524">		case COPY_URL_TO_CLIPBOARD:</a>
<a name="ln525">			if (be_clipboard-&gt;Lock()) {</a>
<a name="ln526">				BMessage* data = be_clipboard-&gt;Data();</a>
<a name="ln527">				if (data != NULL) {</a>
<a name="ln528">					be_clipboard-&gt;Clear();</a>
<a name="ln529">					data-&gt;AddData(&quot;text/plain&quot;, B_MIME_TYPE, fURL.String(),</a>
<a name="ln530">						fURL.Length());</a>
<a name="ln531">				}</a>
<a name="ln532">				be_clipboard-&gt;Commit();</a>
<a name="ln533">				be_clipboard-&gt;Unlock();</a>
<a name="ln534">			}</a>
<a name="ln535">			break;</a>
<a name="ln536">		case OPEN_CONTAINING_FOLDER:</a>
<a name="ln537">			if (fPath.InitCheck() == B_OK) {</a>
<a name="ln538">				BEntry selected(fPath.Path());</a>
<a name="ln539">				if (!selected.Exists())</a>
<a name="ln540">					break;</a>
<a name="ln541"> </a>
<a name="ln542">				BPath containingFolder;</a>
<a name="ln543">				if (fPath.GetParent(&amp;containingFolder) != B_OK)</a>
<a name="ln544">					break;</a>
<a name="ln545">				entry_ref ref;</a>
<a name="ln546">				if (get_ref_for_path(containingFolder.Path(), &amp;ref) != B_OK)</a>
<a name="ln547">					break;</a>
<a name="ln548"> </a>
<a name="ln549">				// Ask Tracker to open the containing folder and select the</a>
<a name="ln550">				// file inside it.</a>
<a name="ln551">				BMessenger trackerMessenger(&quot;application/x-vnd.Be-TRAK&quot;);</a>
<a name="ln552"> </a>
<a name="ln553">				if (trackerMessenger.IsValid()) {</a>
<a name="ln554">					BMessage selectionCommand(B_REFS_RECEIVED);</a>
<a name="ln555">					selectionCommand.AddRef(&quot;refs&quot;, &amp;ref);</a>
<a name="ln556"> </a>
<a name="ln557">					node_ref selectedRef;</a>
<a name="ln558">					if (selected.GetNodeRef(&amp;selectedRef) == B_OK) {</a>
<a name="ln559">						selectionCommand.AddData(&quot;nodeRefToSelect&quot;, B_RAW_TYPE,</a>
<a name="ln560">							(void*)&amp;selectedRef, sizeof(node_ref));</a>
<a name="ln561">					}</a>
<a name="ln562"> </a>
<a name="ln563">					trackerMessenger.SendMessage(&amp;selectionCommand);</a>
<a name="ln564">				}</a>
<a name="ln565">			}</a>
<a name="ln566">			break;</a>
<a name="ln567"> </a>
<a name="ln568">		default:</a>
<a name="ln569">			BGroupView::MessageReceived(message);</a>
<a name="ln570">	}</a>
<a name="ln571">}</a>
<a name="ln572"> </a>
<a name="ln573"> </a>
<a name="ln574">void</a>
<a name="ln575">DownloadProgressView::ShowContextMenu(BPoint screenWhere)</a>
<a name="ln576">{</a>
<a name="ln577">	screenWhere += BPoint(2, 2);</a>
<a name="ln578"> </a>
<a name="ln579">	BPopUpMenu* contextMenu = new BPopUpMenu(&quot;download context&quot;);</a>
<a name="ln580">	BMenuItem* copyURL = new BMenuItem(B_TRANSLATE(&quot;Copy URL to clipboard&quot;),</a>
<a name="ln581">		new BMessage(COPY_URL_TO_CLIPBOARD));</a>
<a name="ln582">	copyURL-&gt;SetEnabled(fURL.Length() &gt; 0);</a>
<a name="ln583">	contextMenu-&gt;AddItem(copyURL);</a>
<a name="ln584">	BMenuItem* openFolder = new BMenuItem(B_TRANSLATE(&quot;Open containing folder&quot;),</a>
<a name="ln585">		new BMessage(OPEN_CONTAINING_FOLDER));</a>
<a name="ln586">	contextMenu-&gt;AddItem(openFolder);</a>
<a name="ln587"> </a>
<a name="ln588">	contextMenu-&gt;SetTargetForItems(this);</a>
<a name="ln589">	contextMenu-&gt;Go(screenWhere, true, true, true);</a>
<a name="ln590">}</a>
<a name="ln591"> </a>
<a name="ln592"> </a>
<a name="ln593">BWebDownload*</a>
<a name="ln594">DownloadProgressView::Download() const</a>
<a name="ln595">{</a>
<a name="ln596">	return fDownload;</a>
<a name="ln597">}</a>
<a name="ln598"> </a>
<a name="ln599"> </a>
<a name="ln600">const BString&amp;</a>
<a name="ln601">DownloadProgressView::URL() const</a>
<a name="ln602">{</a>
<a name="ln603">	return fURL;</a>
<a name="ln604">}</a>
<a name="ln605"> </a>
<a name="ln606"> </a>
<a name="ln607">bool</a>
<a name="ln608">DownloadProgressView::IsMissing() const</a>
<a name="ln609">{</a>
<a name="ln610">	return fIconView-&gt;IsIconDimmed();</a>
<a name="ln611">}</a>
<a name="ln612"> </a>
<a name="ln613"> </a>
<a name="ln614">bool</a>
<a name="ln615">DownloadProgressView::IsFinished() const</a>
<a name="ln616">{</a>
<a name="ln617">	return !fDownload &amp;&amp; fStatusBar-&gt;CurrentValue() == 100;</a>
<a name="ln618">}</a>
<a name="ln619"> </a>
<a name="ln620"> </a>
<a name="ln621">void</a>
<a name="ln622">DownloadProgressView::DownloadFinished()</a>
<a name="ln623">{</a>
<a name="ln624">	fDownload = NULL;</a>
<a name="ln625">	if (fExpectedSize == -1) {</a>
<a name="ln626">		fStatusBar-&gt;SetTo(100.0);</a>
<a name="ln627">		fExpectedSize = fCurrentSize;</a>
<a name="ln628">	}</a>
<a name="ln629">	fTopButton-&gt;SetEnabled(true);</a>
<a name="ln630">	fBottomButton-&gt;SetLabel(B_TRANSLATE(&quot;Remove&quot;));</a>
<a name="ln631">	fBottomButton-&gt;SetMessage(new BMessage(REMOVE_DOWNLOAD));</a>
<a name="ln632">	fBottomButton-&gt;SetEnabled(true);</a>
<a name="ln633">	fInfoView-&gt;SetText(&quot;&quot;);</a>
<a name="ln634">	fStatusBar-&gt;SetBarColor(ui_color(B_SUCCESS_COLOR));</a>
<a name="ln635"> </a>
<a name="ln636">	BNotification success(B_INFORMATION_NOTIFICATION);</a>
<a name="ln637">	success.SetGroup(B_TRANSLATE(&quot;WebPositive&quot;));</a>
<a name="ln638">	success.SetTitle(B_TRANSLATE(&quot;Download finished&quot;));</a>
<a name="ln639">	success.SetContent(fPath.Leaf());</a>
<a name="ln640">	BEntry entry(fPath.Path());</a>
<a name="ln641">	entry_ref ref;</a>
<a name="ln642">	entry.GetRef(&amp;ref);</a>
<a name="ln643">	success.SetOnClickFile(&amp;ref);</a>
<a name="ln644">	success.SetIcon(fIconView-&gt;Bitmap());</a>
<a name="ln645">	success.Send();</a>
<a name="ln646"> </a>
<a name="ln647">}</a>
<a name="ln648"> </a>
<a name="ln649"> </a>
<a name="ln650">void</a>
<a name="ln651">DownloadProgressView::CancelDownload()</a>
<a name="ln652">{</a>
<a name="ln653">	// Show the cancel notification, and set the progress bar red, only if the</a>
<a name="ln654">	// download was still running. In cases where the file is deleted after</a>
<a name="ln655">	// the download was finished, we don't want these things to happen.</a>
<a name="ln656">	if (fDownload) {</a>
<a name="ln657">		// Also cancel the download</a>
<a name="ln658">		fDownload-&gt;Cancel();</a>
<a name="ln659">		BNotification success(B_ERROR_NOTIFICATION);</a>
<a name="ln660">		success.SetGroup(B_TRANSLATE(&quot;WebPositive&quot;));</a>
<a name="ln661">		success.SetTitle(B_TRANSLATE(&quot;Download aborted&quot;));</a>
<a name="ln662">		success.SetContent(fPath.Leaf());</a>
<a name="ln663">		// Don't make a click on the notification open the file: it is not</a>
<a name="ln664">		// complete</a>
<a name="ln665">		success.SetIcon(fIconView-&gt;Bitmap());</a>
<a name="ln666">		success.Send();</a>
<a name="ln667"> </a>
<a name="ln668">		fStatusBar-&gt;SetBarColor(ui_color(B_FAILURE_COLOR));</a>
<a name="ln669">	}</a>
<a name="ln670"> </a>
<a name="ln671">	fDownload = NULL;</a>
<a name="ln672">	fTopButton-&gt;SetLabel(B_TRANSLATE(&quot;Restart&quot;));</a>
<a name="ln673">	fTopButton-&gt;SetMessage(new BMessage(RESTART_DOWNLOAD));</a>
<a name="ln674">	fTopButton-&gt;SetEnabled(true);</a>
<a name="ln675">	fBottomButton-&gt;SetLabel(B_TRANSLATE(&quot;Remove&quot;));</a>
<a name="ln676">	fBottomButton-&gt;SetMessage(new BMessage(REMOVE_DOWNLOAD));</a>
<a name="ln677">	fBottomButton-&gt;SetEnabled(true);</a>
<a name="ln678">	fInfoView-&gt;SetText(&quot;&quot;);</a>
<a name="ln679"> </a>
<a name="ln680">	fPath.Unset();</a>
<a name="ln681">}</a>
<a name="ln682"> </a>
<a name="ln683"> </a>
<a name="ln684">/*static*/ void</a>
<a name="ln685">DownloadProgressView::SpeedVersusEstimatedFinishTogglePulse()</a>
<a name="ln686">{</a>
<a name="ln687">	bigtime_t now = system_time();</a>
<a name="ln688">	if (sShowSpeed</a>
<a name="ln689">		&amp;&amp; sLastEstimatedFinishSpeedToggleTime + kShowSpeedInterval</a>
<a name="ln690">			&lt;= now) {</a>
<a name="ln691">		sShowSpeed = false;</a>
<a name="ln692">		sLastEstimatedFinishSpeedToggleTime = now;</a>
<a name="ln693">	} else if (!sShowSpeed</a>
<a name="ln694">		&amp;&amp; sLastEstimatedFinishSpeedToggleTime</a>
<a name="ln695">			+ kShowEstimatedFinishInterval &lt;= now) {</a>
<a name="ln696">		sShowSpeed = true;</a>
<a name="ln697">		sLastEstimatedFinishSpeedToggleTime = now;</a>
<a name="ln698">	}</a>
<a name="ln699">}</a>
<a name="ln700"> </a>
<a name="ln701"> </a>
<a name="ln702">// #pragma mark - private</a>
<a name="ln703"> </a>
<a name="ln704"> </a>
<a name="ln705">void</a>
<a name="ln706">DownloadProgressView::_UpdateStatus(off_t currentSize, off_t expectedSize)</a>
<a name="ln707">{</a>
<a name="ln708">	fCurrentSize = currentSize;</a>
<a name="ln709">	fExpectedSize = expectedSize;</a>
<a name="ln710"> </a>
<a name="ln711">	fStatusBar-&gt;SetTo(100.0 * currentSize / expectedSize);</a>
<a name="ln712"> </a>
<a name="ln713">	bigtime_t currentTime = system_time();</a>
<a name="ln714">	if ((currentTime - fLastUpdateTime) &gt; kMaxUpdateInterval) {</a>
<a name="ln715">		fLastUpdateTime = currentTime;</a>
<a name="ln716"> </a>
<a name="ln717">		if (currentTime &gt;= fLastSpeedReferenceTime + kSpeedReferenceInterval) {</a>
<a name="ln718">			// update current speed every kSpeedReferenceInterval</a>
<a name="ln719">			fCurrentBytesPerSecondSlot</a>
<a name="ln720">				= (fCurrentBytesPerSecondSlot + 1) % kBytesPerSecondSlots;</a>
<a name="ln721">			fBytesPerSecondSlot[fCurrentBytesPerSecondSlot]</a>
<a name="ln722">				= (double)(currentSize - fLastSpeedReferenceSize)</a>
<a name="ln723">					* 1000000LL / (currentTime - fLastSpeedReferenceTime);</a>
<a name="ln724">			fLastSpeedReferenceSize = currentSize;</a>
<a name="ln725">			fLastSpeedReferenceTime = currentTime;</a>
<a name="ln726">			fBytesPerSecond = 0.0;</a>
<a name="ln727">			size_t count = 0;</a>
<a name="ln728">			for (size_t i = 0; i &lt; kBytesPerSecondSlots; i++) {</a>
<a name="ln729">				if (fBytesPerSecondSlot[i] != 0.0) {</a>
<a name="ln730">					fBytesPerSecond += fBytesPerSecondSlot[i];</a>
<a name="ln731">					count++;</a>
<a name="ln732">				}</a>
<a name="ln733">			}</a>
<a name="ln734">			if (count &gt; 0)</a>
<a name="ln735">				fBytesPerSecond /= count;</a>
<a name="ln736">		}</a>
<a name="ln737">		_UpdateStatusText();</a>
<a name="ln738">	}</a>
<a name="ln739">}</a>
<a name="ln740"> </a>
<a name="ln741"> </a>
<a name="ln742">void</a>
<a name="ln743">DownloadProgressView::_UpdateStatusText()</a>
<a name="ln744">{</a>
<a name="ln745">	fInfoView-&gt;SetText(&quot;&quot;);</a>
<a name="ln746">	BString buffer;</a>
<a name="ln747">	if (sShowSpeed &amp;&amp; fBytesPerSecond != 0.0) {</a>
<a name="ln748">		// Draw speed info</a>
<a name="ln749">		char sizeBuffer[128];</a>
<a name="ln750">		buffer = &quot;(&quot;;</a>
<a name="ln751">		// Get strings for current and expected size and remove the unit</a>
<a name="ln752">		// from the current size string if it's the same as the expected</a>
<a name="ln753">		// size unit.</a>
<a name="ln754">		BString currentSize = string_for_size((double)fCurrentSize, sizeBuffer,</a>
<a name="ln755">			sizeof(sizeBuffer));</a>
<a name="ln756">		BString expectedSize = string_for_size((double)fExpectedSize, sizeBuffer,</a>
<a name="ln757">			sizeof(sizeBuffer));</a>
<a name="ln758">		int currentSizeUnitPos = currentSize.FindLast(' ');</a>
<a name="ln759">		int expectedSizeUnitPos = expectedSize.FindLast(' ');</a>
<a name="ln760">		if (currentSizeUnitPos &gt;= 0 &amp;&amp; expectedSizeUnitPos &gt;= 0</a>
<a name="ln761">			&amp;&amp; strcmp(currentSize.String() + currentSizeUnitPos,</a>
<a name="ln762">				expectedSize.String() + expectedSizeUnitPos) == 0) {</a>
<a name="ln763">			currentSize.Truncate(currentSizeUnitPos);</a>
<a name="ln764">		}</a>
<a name="ln765">		buffer &lt;&lt; currentSize;</a>
<a name="ln766">		buffer &lt;&lt; &quot; &quot;;</a>
<a name="ln767">		buffer &lt;&lt; B_TRANSLATE_COMMENT(&quot;of&quot;, &quot;...as in '12kB of 256kB'&quot;);</a>
<a name="ln768">		buffer &lt;&lt; &quot; &quot;;</a>
<a name="ln769">		buffer &lt;&lt; expectedSize;</a>
<a name="ln770">		buffer &lt;&lt; &quot;, &quot;;</a>
<a name="ln771">		buffer &lt;&lt; string_for_size(fBytesPerSecond, sizeBuffer,</a>
<a name="ln772">			sizeof(sizeBuffer));</a>
<a name="ln773">		buffer &lt;&lt; B_TRANSLATE_COMMENT(&quot;/s)&quot;, &quot;...as in 'per second'&quot;);</a>
<a name="ln774">		float stringWidth = fInfoView-&gt;StringWidth(buffer.String());</a>
<a name="ln775">		if (stringWidth &lt; fInfoView-&gt;Bounds().Width())</a>
<a name="ln776">			fInfoView-&gt;SetText(buffer.String());</a>
<a name="ln777">		else {</a>
<a name="ln778">			// complete string too wide, try with shorter version</a>
<a name="ln779">			buffer &lt;&lt; string_for_size(fBytesPerSecond, sizeBuffer,</a>
<a name="ln780">				sizeof(sizeBuffer));</a>
<a name="ln781">			buffer &lt;&lt; B_TRANSLATE_COMMENT(&quot;/s)&quot;, &quot;...as in 'per second'&quot;);</a>
<a name="ln782">			stringWidth = fInfoView-&gt;StringWidth(buffer.String());</a>
<a name="ln783">			if (stringWidth &lt; fInfoView-&gt;Bounds().Width())</a>
<a name="ln784">				fInfoView-&gt;SetText(buffer.String());</a>
<a name="ln785">		}</a>
<a name="ln786">	} else if (!sShowSpeed &amp;&amp; fCurrentSize &lt; fExpectedSize) {</a>
<a name="ln787">		double totalBytesPerSecond = (double)(fCurrentSize</a>
<a name="ln788">				- fEstimatedFinishReferenceSize)</a>
<a name="ln789">			* 1000000LL / (system_time() - fEstimatedFinishReferenceTime);</a>
<a name="ln790">		double secondsRemaining = (fExpectedSize - fCurrentSize)</a>
<a name="ln791">			/ totalBytesPerSecond;</a>
<a name="ln792">		time_t now = (time_t)real_time_clock();</a>
<a name="ln793">		time_t finishTime = (time_t)(now + secondsRemaining);</a>
<a name="ln794"> </a>
<a name="ln795">		BString timeText;</a>
<a name="ln796">		if (finishTime - now &gt; kSecondsPerDay) {</a>
<a name="ln797">			BDateTimeFormat().Format(timeText, finishTime,</a>
<a name="ln798">				B_MEDIUM_DATE_FORMAT, B_MEDIUM_TIME_FORMAT);</a>
<a name="ln799">		} else {</a>
<a name="ln800">			BTimeFormat().Format(timeText, finishTime,</a>
<a name="ln801">				B_MEDIUM_TIME_FORMAT);</a>
<a name="ln802">		}</a>
<a name="ln803"> </a>
<a name="ln804">		BString statusString;</a>
<a name="ln805">		BDurationFormat formatter;</a>
<a name="ln806">		BString finishString;</a>
<a name="ln807">		if (finishTime - now &gt; kSecondsPerHour) {</a>
<a name="ln808">			statusString.SetTo(B_TRANSLATE(&quot;(Finish: %date - Over %duration left)&quot;));</a>
<a name="ln809">			formatter.Format(finishString, now * 1000000LL, finishTime * 1000000LL);</a>
<a name="ln810">		} else {</a>
<a name="ln811">			statusString.SetTo(B_TRANSLATE(&quot;(Finish: %date - %duration left)&quot;));</a>
<a name="ln812">			formatter.Format(finishString, now * 1000000LL, finishTime * 1000000LL);</a>
<a name="ln813">		}</a>
<a name="ln814"> </a>
<a name="ln815">		statusString.ReplaceFirst(&quot;%date&quot;, timeText);</a>
<a name="ln816">		statusString.ReplaceFirst(&quot;%duration&quot;, finishString);</a>
<a name="ln817"> </a>
<a name="ln818">		float stringWidth = fInfoView-&gt;StringWidth(statusString.String());</a>
<a name="ln819">		if (stringWidth &lt; fInfoView-&gt;Bounds().Width())</a>
<a name="ln820">			fInfoView-&gt;SetText(statusString.String());</a>
<a name="ln821">		else {</a>
<a name="ln822">			// complete string too wide, try with shorter version</a>
<a name="ln823">			statusString.SetTo(B_TRANSLATE(&quot;(Finish: %date)&quot;));</a>
<a name="ln824">			statusString.ReplaceFirst(&quot;%date&quot;, timeText);</a>
<a name="ln825">			stringWidth = fInfoView-&gt;StringWidth(statusString.String());</a>
<a name="ln826">			if (stringWidth &lt; fInfoView-&gt;Bounds().Width())</a>
<a name="ln827">				fInfoView-&gt;SetText(statusString.String());</a>
<a name="ln828">		}</a>
<a name="ln829">	}</a>
<a name="ln830">}</a>
<a name="ln831"> </a>
<a name="ln832"> </a>
<a name="ln833">void</a>
<a name="ln834">DownloadProgressView::_StartNodeMonitor(const BEntry&amp; entry)</a>
<a name="ln835">{</a>
<a name="ln836">	node_ref nref;</a>
<a name="ln837">	if (entry.GetNodeRef(&amp;nref) == B_OK)</a>
<a name="ln838">		watch_node(&amp;nref, B_WATCH_ALL, this);</a>
<a name="ln839">}</a>
<a name="ln840"> </a>
<a name="ln841"> </a>
<a name="ln842">void</a>
<a name="ln843">DownloadProgressView::_StopNodeMonitor()</a>
<a name="ln844">{</a>
<a name="ln845">	stop_watching(this);</a>
<a name="ln846">}</a>
<a name="ln847"> </a>

</code></pre>
<div class="balloon" rel="590"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'contextMenu' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="420"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
