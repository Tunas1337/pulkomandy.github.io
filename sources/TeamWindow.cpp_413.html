
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>TeamWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2009-2012, Ingo Weinhold, ingo_weinhold@gmx.de.</a>
<a name="ln3"> * Copyright 2010-2017, Rene Gollent, rene@gollent.com.</a>
<a name="ln4"> * Distributed under the terms of the MIT License.</a>
<a name="ln5"> */</a>
<a name="ln6"> </a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;TeamWindow.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;stdio.h&gt;</a>
<a name="ln11"> </a>
<a name="ln12">#include &lt;Alert.h&gt;</a>
<a name="ln13">#include &lt;Button.h&gt;</a>
<a name="ln14">#include &lt;FilePanel.h&gt;</a>
<a name="ln15">#include &lt;FindDirectory.h&gt;</a>
<a name="ln16">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln17">#include &lt;Menu.h&gt;</a>
<a name="ln18">#include &lt;MenuBar.h&gt;</a>
<a name="ln19">#include &lt;MenuItem.h&gt;</a>
<a name="ln20">#include &lt;Message.h&gt;</a>
<a name="ln21">#include &lt;MessageFilter.h&gt;</a>
<a name="ln22">#include &lt;MessageRunner.h&gt;</a>
<a name="ln23">#include &lt;Path.h&gt;</a>
<a name="ln24">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln25">#include &lt;Query.h&gt;</a>
<a name="ln26">#include &lt;StringView.h&gt;</a>
<a name="ln27">#include &lt;TabView.h&gt;</a>
<a name="ln28">#include &lt;ScrollView.h&gt;</a>
<a name="ln29">#include &lt;SplitView.h&gt;</a>
<a name="ln30">#include &lt;TextView.h&gt;</a>
<a name="ln31">#include &lt;VolumeRoster.h&gt;</a>
<a name="ln32"> </a>
<a name="ln33">#include &lt;AutoDeleter.h&gt;</a>
<a name="ln34">#include &lt;AutoLocker.h&gt;</a>
<a name="ln35"> </a>
<a name="ln36">#include &quot;AppMessageCodes.h&quot;</a>
<a name="ln37">#include &quot;Breakpoint.h&quot;</a>
<a name="ln38">#include &quot;BreakpointEditWindow.h&quot;</a>
<a name="ln39">#include &quot;ConsoleOutputView.h&quot;</a>
<a name="ln40">#include &quot;CppLanguage.h&quot;</a>
<a name="ln41">#include &quot;CpuState.h&quot;</a>
<a name="ln42">#include &quot;DisassembledCode.h&quot;</a>
<a name="ln43">#include &quot;BreakpointEditWindow.h&quot;</a>
<a name="ln44">#include &quot;ExpressionEvaluationWindow.h&quot;</a>
<a name="ln45">#include &quot;ExpressionPromptWindow.h&quot;</a>
<a name="ln46">#include &quot;FileSourceCode.h&quot;</a>
<a name="ln47">#include &quot;GuiSettingsUtils.h&quot;</a>
<a name="ln48">#include &quot;GuiTeamUiSettings.h&quot;</a>
<a name="ln49">#include &quot;Image.h&quot;</a>
<a name="ln50">#include &quot;ImageDebugInfo.h&quot;</a>
<a name="ln51">#include &quot;InspectorWindow.h&quot;</a>
<a name="ln52">#include &quot;LocatableFile.h&quot;</a>
<a name="ln53">#include &quot;MessageCodes.h&quot;</a>
<a name="ln54">#include &quot;RegistersView.h&quot;</a>
<a name="ln55">#include &quot;StackTrace.h&quot;</a>
<a name="ln56">#include &quot;StackTraceView.h&quot;</a>
<a name="ln57">#include &quot;TeamSettingsWindow.h&quot;</a>
<a name="ln58">#include &quot;Tracing.h&quot;</a>
<a name="ln59">#include &quot;TypeComponentPath.h&quot;</a>
<a name="ln60">#include &quot;UiUtils.h&quot;</a>
<a name="ln61">#include &quot;UserInterface.h&quot;</a>
<a name="ln62">#include &quot;ValueNodeManager.h&quot;</a>
<a name="ln63">#include &quot;Value.h&quot;</a>
<a name="ln64">#include &quot;Variable.h&quot;</a>
<a name="ln65">#include &quot;WatchPromptWindow.h&quot;</a>
<a name="ln66"> </a>
<a name="ln67"> </a>
<a name="ln68">enum {</a>
<a name="ln69">	MAIN_TAB_INDEX_THREADS	= 0,</a>
<a name="ln70">	MAIN_TAB_INDEX_IMAGES	= 1</a>
<a name="ln71">};</a>
<a name="ln72"> </a>
<a name="ln73"> </a>
<a name="ln74">enum {</a>
<a name="ln75">	MSG_CHOOSE_DEBUG_REPORT_LOCATION	= 'ccrl',</a>
<a name="ln76">	MSG_DEBUG_REPORT_SAVED				= 'drsa',</a>
<a name="ln77">	MSG_CHOOSE_CORE_FILE_LOCATION		= 'ccfl',</a>
<a name="ln78">	MSG_CORE_FILE_WRITTEN				= 'cfsa',</a>
<a name="ln79">	MSG_LOCATE_SOURCE_IF_NEEDED			= 'lsin',</a>
<a name="ln80">	MSG_SOURCE_ENTRY_QUERY_COMPLETE		= 'seqc',</a>
<a name="ln81">	MSG_CLEAR_STACK_TRACE				= 'clst',</a>
<a name="ln82">	MSG_HANDLE_LOAD_SETTINGS			= 'hlst',</a>
<a name="ln83">	MSG_UPDATE_STATUS_BAR				= 'upsb'</a>
<a name="ln84">};</a>
<a name="ln85"> </a>
<a name="ln86"> </a>
<a name="ln87">// #pragma mark - ThreadStackFrameSelectionKey</a>
<a name="ln88"> </a>
<a name="ln89"> </a>
<a name="ln90">struct TeamWindow::ThreadStackFrameSelectionKey {</a>
<a name="ln91">	::Thread*	thread;</a>
<a name="ln92"> </a>
<a name="ln93">	ThreadStackFrameSelectionKey(::Thread* thread)</a>
<a name="ln94">		:</a>
<a name="ln95">		thread(thread)</a>
<a name="ln96">	{</a>
<a name="ln97">		thread-&gt;AcquireReference();</a>
<a name="ln98">	}</a>
<a name="ln99"> </a>
<a name="ln100">	~ThreadStackFrameSelectionKey()</a>
<a name="ln101">	{</a>
<a name="ln102">		thread-&gt;ReleaseReference();</a>
<a name="ln103">	}</a>
<a name="ln104"> </a>
<a name="ln105">	uint32 HashValue() const</a>
<a name="ln106">	{</a>
<a name="ln107">		return (uint32)thread-&gt;ID();</a>
<a name="ln108">	}</a>
<a name="ln109"> </a>
<a name="ln110">	bool operator==(const ThreadStackFrameSelectionKey&amp; other) const</a>
<a name="ln111">	{</a>
<a name="ln112">		return thread == other.thread;</a>
<a name="ln113">	}</a>
<a name="ln114">};</a>
<a name="ln115"> </a>
<a name="ln116"> </a>
<a name="ln117">// #pragma mark - ThreadStackFrameSelectionEntry</a>
<a name="ln118"> </a>
<a name="ln119"> </a>
<a name="ln120">struct TeamWindow::ThreadStackFrameSelectionEntry</a>
<a name="ln121">	: ThreadStackFrameSelectionKey {</a>
<a name="ln122">	ThreadStackFrameSelectionEntry* next;</a>
<a name="ln123">	StackFrame* selectedFrame;</a>
<a name="ln124"> </a>
<a name="ln125">	ThreadStackFrameSelectionEntry(::Thread* thread, StackFrame* frame)</a>
<a name="ln126">		:</a>
<a name="ln127">		ThreadStackFrameSelectionKey(thread),</a>
<a name="ln128">		selectedFrame(frame)</a>
<a name="ln129">	{</a>
<a name="ln130">	}</a>
<a name="ln131"> </a>
<a name="ln132">	inline StackFrame* SelectedFrame() const</a>
<a name="ln133">	{</a>
<a name="ln134">		return selectedFrame;</a>
<a name="ln135">	}</a>
<a name="ln136"> </a>
<a name="ln137">	void SetSelectedFrame(StackFrame* frame)</a>
<a name="ln138">	{</a>
<a name="ln139">		selectedFrame = frame;</a>
<a name="ln140">	}</a>
<a name="ln141">};</a>
<a name="ln142"> </a>
<a name="ln143"> </a>
<a name="ln144">// #pragma mark - ThreadStackFrameSelectionEntryHashDefinition</a>
<a name="ln145"> </a>
<a name="ln146"> </a>
<a name="ln147">struct TeamWindow::ThreadStackFrameSelectionEntryHashDefinition {</a>
<a name="ln148">	typedef ThreadStackFrameSelectionKey 	KeyType;</a>
<a name="ln149">	typedef ThreadStackFrameSelectionEntry	ValueType;</a>
<a name="ln150"> </a>
<a name="ln151">	size_t HashKey(const ThreadStackFrameSelectionKey&amp; key) const</a>
<a name="ln152">	{</a>
<a name="ln153">		return key.HashValue();</a>
<a name="ln154">	}</a>
<a name="ln155"> </a>
<a name="ln156">	size_t Hash(const ThreadStackFrameSelectionKey* value) const</a>
<a name="ln157">	{</a>
<a name="ln158">		return value-&gt;HashValue();</a>
<a name="ln159">	}</a>
<a name="ln160"> </a>
<a name="ln161">	bool Compare(const ThreadStackFrameSelectionKey&amp; key,</a>
<a name="ln162">		const ThreadStackFrameSelectionKey* value) const</a>
<a name="ln163">	{</a>
<a name="ln164">		return key == *value;</a>
<a name="ln165">	}</a>
<a name="ln166"> </a>
<a name="ln167">	ThreadStackFrameSelectionEntry*&amp; GetLink(</a>
<a name="ln168">		ThreadStackFrameSelectionEntry* value) const</a>
<a name="ln169">	{</a>
<a name="ln170">		return value-&gt;next;</a>
<a name="ln171">	}</a>
<a name="ln172">};</a>
<a name="ln173"> </a>
<a name="ln174"> </a>
<a name="ln175">// #pragma mark - PathViewMessageFilter</a>
<a name="ln176"> </a>
<a name="ln177"> </a>
<a name="ln178">class PathViewMessageFilter : public BMessageFilter {</a>
<a name="ln179">public:</a>
<a name="ln180">		PathViewMessageFilter(BMessenger teamWindow)</a>
<a name="ln181">			:</a>
<a name="ln182">			BMessageFilter(B_MOUSE_UP),</a>
<a name="ln183">			fTeamWindowMessenger(teamWindow)</a>
<a name="ln184">		{</a>
<a name="ln185">		}</a>
<a name="ln186"> </a>
<a name="ln187">		virtual filter_result Filter(BMessage*, BHandler**)</a>
<a name="ln188">		{</a>
<a name="ln189">			fTeamWindowMessenger.SendMessage(MSG_LOCATE_SOURCE_IF_NEEDED);</a>
<a name="ln190"> </a>
<a name="ln191">			return B_DISPATCH_MESSAGE;</a>
<a name="ln192">		}</a>
<a name="ln193"> </a>
<a name="ln194">private:</a>
<a name="ln195">		BMessenger fTeamWindowMessenger;</a>
<a name="ln196">};</a>
<a name="ln197"> </a>
<a name="ln198"> </a>
<a name="ln199">// #pragma mark - TeamWindow</a>
<a name="ln200"> </a>
<a name="ln201"> </a>
<a name="ln202">TeamWindow::TeamWindow(::Team* team, UserInterfaceListener* listener)</a>
<a name="ln203">	:</a>
<a name="ln204">	BWindow(BRect(100, 100, 899, 699), &quot;Team&quot;, B_TITLED_WINDOW,</a>
<a name="ln205">		B_ASYNCHRONOUS_CONTROLS | B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln206">	fTeam(team),</a>
<a name="ln207">	fActiveThread(NULL),</a>
<a name="ln208">	fActiveImage(NULL),</a>
<a name="ln209">	fActiveStackTrace(NULL),</a>
<a name="ln210">	fActiveStackFrame(NULL),</a>
<a name="ln211">	fThreadSelectionInfoTable(NULL),</a>
<a name="ln212">	fActiveBreakpoint(NULL),</a>
<a name="ln213">	fActiveFunction(NULL),</a>
<a name="ln214">	fActiveSourceCode(NULL),</a>
<a name="ln215">	fActiveSourceObject(ACTIVE_SOURCE_NONE),</a>
<a name="ln216">	fListener(listener),</a>
<a name="ln217">	fTraceUpdateRunner(NULL),</a>
<a name="ln218">	fTabView(NULL),</a>
<a name="ln219">	fLocalsTabView(NULL),</a>
<a name="ln220">	fThreadListView(NULL),</a>
<a name="ln221">	fImageListView(NULL),</a>
<a name="ln222">	fImageFunctionsView(NULL),</a>
<a name="ln223">	fBreakpointsView(NULL),</a>
<a name="ln224">	fVariablesView(NULL),</a>
<a name="ln225">	fRegistersView(NULL),</a>
<a name="ln226">	fStackTraceView(NULL),</a>
<a name="ln227">	fSourceView(NULL),</a>
<a name="ln228">	fRunButton(NULL),</a>
<a name="ln229">	fStepOverButton(NULL),</a>
<a name="ln230">	fStepIntoButton(NULL),</a>
<a name="ln231">	fStepOutButton(NULL),</a>
<a name="ln232">	fMenuBar(NULL),</a>
<a name="ln233">	fSourcePathView(NULL),</a>
<a name="ln234">	fStatusBarView(NULL),</a>
<a name="ln235">	fConsoleOutputView(NULL),</a>
<a name="ln236">	fFunctionSplitView(NULL),</a>
<a name="ln237">	fSourceSplitView(NULL),</a>
<a name="ln238">	fImageSplitView(NULL),</a>
<a name="ln239">	fThreadSplitView(NULL),</a>
<a name="ln240">	fConsoleSplitView(NULL),</a>
<a name="ln241">	fTeamSettingsWindow(NULL),</a>
<a name="ln242">	fBreakpointEditWindow(NULL),</a>
<a name="ln243">	fInspectorWindow(NULL),</a>
<a name="ln244">	fExpressionEvalWindow(NULL),</a>
<a name="ln245">	fExpressionPromptWindow(NULL),</a>
<a name="ln246">	fFilePanel(NULL),</a>
<a name="ln247">	fActiveSourceWorker(-1)</a>
<a name="ln248">{</a>
<a name="ln249">	_UpdateTitle();</a>
<a name="ln250"> </a>
<a name="ln251">	fTeam-&gt;AddListener(this);</a>
<a name="ln252">}</a>
<a name="ln253"> </a>
<a name="ln254"> </a>
<a name="ln255">TeamWindow::~TeamWindow()</a>
<a name="ln256">{</a>
<a name="ln257">	if (fThreadListView != NULL)</a>
<a name="ln258">		fThreadListView-&gt;UnsetListener();</a>
<a name="ln259">	if (fStackTraceView != NULL)</a>
<a name="ln260">		fStackTraceView-&gt;UnsetListener();</a>
<a name="ln261">	if (fSourceView != NULL)</a>
<a name="ln262">		fSourceView-&gt;UnsetListener();</a>
<a name="ln263">	if (fInspectorWindow != NULL) {</a>
<a name="ln264">		if (fInspectorWindow-&gt;Lock())</a>
<a name="ln265">			fInspectorWindow-&gt;Quit();</a>
<a name="ln266">	}</a>
<a name="ln267">	if (fExpressionEvalWindow != NULL) {</a>
<a name="ln268">		if (fExpressionEvalWindow-&gt;Lock())</a>
<a name="ln269">			fExpressionEvalWindow-&gt;Quit();</a>
<a name="ln270">	}</a>
<a name="ln271">	if (fExpressionPromptWindow != NULL) {</a>
<a name="ln272">		if (fExpressionPromptWindow-&gt;Lock())</a>
<a name="ln273">			fExpressionPromptWindow-&gt;Quit();</a>
<a name="ln274">	}</a>
<a name="ln275"> </a>
<a name="ln276">	fTeam-&gt;RemoveListener(this);</a>
<a name="ln277"> </a>
<a name="ln278">	_SetActiveSourceCode(NULL);</a>
<a name="ln279">	_SetActiveFunction(NULL);</a>
<a name="ln280">	_SetActiveBreakpoint(NULL);</a>
<a name="ln281">	_SetActiveStackFrame(NULL);</a>
<a name="ln282">	_SetActiveStackTrace(NULL);</a>
<a name="ln283">	_SetActiveImage(NULL);</a>
<a name="ln284">	_SetActiveThread(NULL);</a>
<a name="ln285"> </a>
<a name="ln286">	delete fFilePanel;</a>
<a name="ln287"> </a>
<a name="ln288">	ThreadStackFrameSelectionEntry* entry</a>
<a name="ln289">		= fThreadSelectionInfoTable-&gt;Clear(true);</a>
<a name="ln290"> </a>
<a name="ln291">	while (entry != NULL) {</a>
<a name="ln292">		ThreadStackFrameSelectionEntry* next = entry-&gt;next;</a>
<a name="ln293">		delete entry;</a>
<a name="ln294">		entry = next;</a>
<a name="ln295">	}</a>
<a name="ln296"> </a>
<a name="ln297">	delete fThreadSelectionInfoTable;</a>
<a name="ln298"> </a>
<a name="ln299">	if (fActiveSourceWorker &gt; 0)</a>
<a name="ln300">		wait_for_thread(fActiveSourceWorker, NULL);</a>
<a name="ln301">}</a>
<a name="ln302"> </a>
<a name="ln303"> </a>
<a name="ln304">/*static*/ TeamWindow*</a>
<a name="ln305">TeamWindow::Create(::Team* team, UserInterfaceListener* listener)</a>
<a name="ln306">{</a>
<a name="ln307">	TeamWindow* self = new TeamWindow(team, listener);</a>
<a name="ln308"> </a>
<a name="ln309">	try {</a>
<a name="ln310">		self-&gt;_Init();</a>
<a name="ln311">	} catch (...) {</a>
<a name="ln312">		delete self;</a>
<a name="ln313">		throw;</a>
<a name="ln314">	}</a>
<a name="ln315"> </a>
<a name="ln316">	return self;</a>
<a name="ln317">}</a>
<a name="ln318"> </a>
<a name="ln319"> </a>
<a name="ln320">void</a>
<a name="ln321">TeamWindow::DispatchMessage(BMessage* message, BHandler* handler)</a>
<a name="ln322">{</a>
<a name="ln323">	// Handle function key shortcuts for stepping</a>
<a name="ln324">	switch (message-&gt;what) {</a>
<a name="ln325">		case B_KEY_DOWN:</a>
<a name="ln326">			if (fActiveThread != NULL &amp;&amp; fTraceUpdateRunner == NULL) {</a>
<a name="ln327">				int32 key;</a>
<a name="ln328">				uint32 modifiers;</a>
<a name="ln329">				if (message-&gt;FindInt32(&quot;key&quot;, &amp;key) == B_OK</a>
<a name="ln330">					&amp;&amp; message-&gt;FindInt32(&quot;modifiers&quot;, (int32*)&amp;modifiers)</a>
<a name="ln331">					== B_OK) {</a>
<a name="ln332">					switch (key) {</a>
<a name="ln333">						case B_F5_KEY:</a>
<a name="ln334">							fListener-&gt;ThreadActionRequested(</a>
<a name="ln335">								fActiveThread-&gt;ID(), MSG_THREAD_RUN);</a>
<a name="ln336">							break;</a>
<a name="ln337">						case B_F10_KEY:</a>
<a name="ln338">							fListener-&gt;ThreadActionRequested(</a>
<a name="ln339">								fActiveThread-&gt;ID(), MSG_THREAD_STEP_OVER);</a>
<a name="ln340">							break;</a>
<a name="ln341">						case B_F11_KEY:</a>
<a name="ln342">							if ((modifiers &amp; B_SHIFT_KEY) != 0) {</a>
<a name="ln343">								fListener-&gt;ThreadActionRequested(</a>
<a name="ln344">									fActiveThread-&gt;ID(), MSG_THREAD_STEP_OUT);</a>
<a name="ln345">							} else {</a>
<a name="ln346">								fListener-&gt;ThreadActionRequested(</a>
<a name="ln347">									fActiveThread-&gt;ID(), MSG_THREAD_STEP_INTO);</a>
<a name="ln348">							}</a>
<a name="ln349">							break;</a>
<a name="ln350">						default:</a>
<a name="ln351">							break;</a>
<a name="ln352">					}</a>
<a name="ln353">				}</a>
<a name="ln354">			}</a>
<a name="ln355">			break;</a>
<a name="ln356"> </a>
<a name="ln357">		case B_COPY:</a>
<a name="ln358">		case B_SELECT_ALL:</a>
<a name="ln359">			BView* focusView = CurrentFocus();</a>
<a name="ln360">			if (focusView != NULL) {</a>
<a name="ln361">				focusView-&gt;MessageReceived(message);</a>
<a name="ln362">				return;</a>
<a name="ln363">			}</a>
<a name="ln364">			break;</a>
<a name="ln365">	}</a>
<a name="ln366">	BWindow::DispatchMessage(message, handler);</a>
<a name="ln367">}</a>
<a name="ln368"> </a>
<a name="ln369"> </a>
<a name="ln370">void</a>
<a name="ln371">TeamWindow::MessageReceived(BMessage* message)</a>
<a name="ln372">{</a>
<a name="ln373">	switch (message-&gt;what) {</a>
<a name="ln374">		case MSG_TEAM_RESTART_REQUESTED:</a>
<a name="ln375">		{</a>
<a name="ln376">			fListener-&gt;TeamRestartRequested();</a>
<a name="ln377">			break;</a>
<a name="ln378">		}</a>
<a name="ln379">		case MSG_CHOOSE_DEBUG_REPORT_LOCATION:</a>
<a name="ln380">		case MSG_CHOOSE_CORE_FILE_LOCATION:</a>
<a name="ln381">		{</a>
<a name="ln382">			try {</a>
<a name="ln383">				char filename[B_FILE_NAME_LENGTH];</a>
<a name="ln384">				if (message-&gt;what == MSG_CHOOSE_DEBUG_REPORT_LOCATION)</a>
<a name="ln385">					UiUtils::ReportNameForTeam(fTeam, filename, sizeof(filename));</a>
<a name="ln386">				else</a>
<a name="ln387">					UiUtils::CoreFileNameForTeam(fTeam, filename, sizeof(filename));</a>
<a name="ln388">				BMessenger msgr(this);</a>
<a name="ln389">				fFilePanel = new BFilePanel(B_SAVE_PANEL, &amp;msgr,</a>
<a name="ln390">					NULL, 0, false, new BMessage(</a>
<a name="ln391">						message-&gt;what == MSG_CHOOSE_DEBUG_REPORT_LOCATION ?</a>
<a name="ln392">							MSG_GENERATE_DEBUG_REPORT : MSG_WRITE_CORE_FILE));</a>
<a name="ln393">				fFilePanel-&gt;SetSaveText(filename);</a>
<a name="ln394">				fFilePanel-&gt;Show();</a>
<a name="ln395">			} catch (...) {</a>
<a name="ln396">				delete fFilePanel;</a>
<a name="ln397">				fFilePanel = NULL;</a>
<a name="ln398">			}</a>
<a name="ln399">			break;</a>
<a name="ln400">		}</a>
<a name="ln401">		case MSG_GENERATE_DEBUG_REPORT:</a>
<a name="ln402">		case MSG_WRITE_CORE_FILE:</a>
<a name="ln403">		{</a>
<a name="ln404">			delete fFilePanel;</a>
<a name="ln405">			fFilePanel = NULL;</a>
<a name="ln406"> </a>
<a name="ln407">			BPath path;</a>
<a name="ln408">			entry_ref ref;</a>
<a name="ln409">			if (message-&gt;FindRef(&quot;directory&quot;, &amp;ref) == B_OK</a>
<a name="ln410">				&amp;&amp; message-&gt;HasString(&quot;name&quot;)) {</a>
<a name="ln411">				path.SetTo(&amp;ref);</a>
<a name="ln412">				path.Append(message-&gt;FindString(&quot;name&quot;));</a>
<a name="ln413">				if (get_ref_for_path(path.Path(), &amp;ref) == B_OK) {</a>
<a name="ln414">					if (message-&gt;what == MSG_GENERATE_DEBUG_REPORT)</a>
<a name="ln415">						fListener-&gt;DebugReportRequested(&amp;ref);</a>
<a name="ln416">					else</a>
<a name="ln417">						fListener-&gt;WriteCoreFileRequested(&amp;ref);</a>
<a name="ln418">				}</a>
<a name="ln419">			}</a>
<a name="ln420">			break;</a>
<a name="ln421">		}</a>
<a name="ln422">		case MSG_DEBUG_REPORT_SAVED:</a>
<a name="ln423">		{</a>
<a name="ln424">			status_t finalStatus = message-&gt;GetInt32(&quot;status&quot;, B_OK);</a>
<a name="ln425">			BString data;</a>
<a name="ln426">			if (finalStatus == B_OK) {</a>
<a name="ln427">				data.SetToFormat(&quot;Debug report successfully saved to '%s'&quot;,</a>
<a name="ln428">					message-&gt;FindString(&quot;path&quot;));</a>
<a name="ln429">			} else {</a>
<a name="ln430">				data.SetToFormat(&quot;Failed to save debug report: '%s'&quot;,</a>
<a name="ln431">					strerror(finalStatus));</a>
<a name="ln432">			}</a>
<a name="ln433"> </a>
<a name="ln434">			BAlert *alert = new(std::nothrow) BAlert(&quot;Report saved&quot;,</a>
<a name="ln435">				data.String(), &quot;Close&quot;);</a>
<a name="ln436">			if (alert == NULL)</a>
<a name="ln437">				break;</a>
<a name="ln438"> </a>
<a name="ln439">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln440">			alert-&gt;Go();</a>
<a name="ln441">			break;</a>
<a name="ln442">		}</a>
<a name="ln443">		case MSG_CORE_FILE_WRITTEN:</a>
<a name="ln444">		{</a>
<a name="ln445">			status_t finalStatus = message-&gt;GetInt32(&quot;status&quot;, B_OK);</a>
<a name="ln446">			BString data;</a>
<a name="ln447">			if (finalStatus == B_OK) {</a>
<a name="ln448">				data.SetToFormat(&quot;Core file successfully written to '%s'&quot;,</a>
<a name="ln449">					message-&gt;FindString(&quot;path&quot;));</a>
<a name="ln450">			} else {</a>
<a name="ln451">				data.SetToFormat(&quot;Failed to write core file: '%s'&quot;,</a>
<a name="ln452">					strerror(finalStatus));</a>
<a name="ln453">			}</a>
<a name="ln454"> </a>
<a name="ln455">			BAlert *alert = new(std::nothrow) BAlert(&quot;Core file written&quot;,</a>
<a name="ln456">				data.String(), &quot;Close&quot;);</a>
<a name="ln457">			if (alert == NULL)</a>
<a name="ln458">				break;</a>
<a name="ln459"> </a>
<a name="ln460">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln461">			alert-&gt;Go();</a>
<a name="ln462">			break;</a>
<a name="ln463">		}</a>
<a name="ln464">		case MSG_SHOW_INSPECTOR_WINDOW:</a>
<a name="ln465">		{</a>
<a name="ln466">			if (fInspectorWindow) {</a>
<a name="ln467">				AutoLocker&lt;BWindow&gt; lock(fInspectorWindow);</a>
<a name="ln468">				if (lock.IsLocked())</a>
<a name="ln469">					fInspectorWindow-&gt;Activate(true);</a>
<a name="ln470">			} else {</a>
<a name="ln471">				try {</a>
<a name="ln472">					fInspectorWindow = InspectorWindow::Create(fTeam,</a>
<a name="ln473">						fListener, this);</a>
<a name="ln474">					if (fInspectorWindow != NULL) {</a>
<a name="ln475">						fInspectorWindow-&gt;LoadSettings(fUiSettings);</a>
<a name="ln476">						fInspectorWindow-&gt;Show();</a>
<a name="ln477">					}</a>
<a name="ln478">				} catch (...) {</a>
<a name="ln479">					// TODO: notify user</a>
<a name="ln480">				}</a>
<a name="ln481">			}</a>
<a name="ln482"> </a>
<a name="ln483">			target_addr_t address;</a>
<a name="ln484">			if (message-&gt;FindUInt64(&quot;address&quot;, &amp;address) == B_OK) {</a>
<a name="ln485">				BMessage addressMessage(MSG_INSPECT_ADDRESS);</a>
<a name="ln486">				addressMessage.AddUInt64(&quot;address&quot;, address);</a>
<a name="ln487">				fInspectorWindow-&gt;PostMessage(&amp;addressMessage);</a>
<a name="ln488">			}</a>
<a name="ln489">			break;</a>
<a name="ln490">		}</a>
<a name="ln491">		case MSG_INSPECTOR_WINDOW_CLOSED:</a>
<a name="ln492">		{</a>
<a name="ln493">			_SaveInspectorSettings(CurrentMessage());</a>
<a name="ln494">			fInspectorWindow = NULL;</a>
<a name="ln495">			break;</a>
<a name="ln496"> </a>
<a name="ln497">		}</a>
<a name="ln498">		case MSG_SHOW_EXPRESSION_WINDOW:</a>
<a name="ln499">		{</a>
<a name="ln500">			if (fExpressionEvalWindow != NULL) {</a>
<a name="ln501">				AutoLocker&lt;BWindow&gt; lock(fExpressionEvalWindow);</a>
<a name="ln502">				if (lock.IsLocked())</a>
<a name="ln503">					fExpressionEvalWindow-&gt;Activate(true);</a>
<a name="ln504">			} else {</a>
<a name="ln505">				try {</a>
<a name="ln506">					fExpressionEvalWindow = ExpressionEvaluationWindow::Create(</a>
<a name="ln507">						this, fTeam, fListener);</a>
<a name="ln508">					if (fExpressionEvalWindow != NULL)</a>
<a name="ln509">						fExpressionEvalWindow-&gt;Show();</a>
<a name="ln510">				} catch (...) {</a>
<a name="ln511">					// TODO: notify user</a>
<a name="ln512">				}</a>
<a name="ln513">			}</a>
<a name="ln514">			break;</a>
<a name="ln515">		}</a>
<a name="ln516">		case MSG_EXPRESSION_WINDOW_CLOSED:</a>
<a name="ln517">		{</a>
<a name="ln518">			fExpressionEvalWindow = NULL;</a>
<a name="ln519">			break;</a>
<a name="ln520">		}</a>
<a name="ln521">		case MSG_SHOW_EXPRESSION_PROMPT_WINDOW:</a>
<a name="ln522">		{</a>
<a name="ln523">			if (fExpressionPromptWindow != NULL) {</a>
<a name="ln524">				AutoLocker&lt;BWindow&gt; lock(fExpressionPromptWindow);</a>
<a name="ln525">				if (lock.IsLocked())</a>
<a name="ln526">					fExpressionPromptWindow-&gt;Activate(true);</a>
<a name="ln527">			} else {</a>
<a name="ln528">				try {</a>
<a name="ln529">					fExpressionPromptWindow = ExpressionPromptWindow::Create(</a>
<a name="ln530">						fVariablesView, this);</a>
<a name="ln531">					if (fExpressionPromptWindow != NULL)</a>
<a name="ln532">						fExpressionPromptWindow-&gt;Show();</a>
<a name="ln533">				} catch (...) {</a>
<a name="ln534">					// TODO: notify user</a>
<a name="ln535">				}</a>
<a name="ln536">			}</a>
<a name="ln537">			break;</a>
<a name="ln538">		}</a>
<a name="ln539">		case MSG_EXPRESSION_PROMPT_WINDOW_CLOSED:</a>
<a name="ln540">		{</a>
<a name="ln541">			fExpressionPromptWindow = NULL;</a>
<a name="ln542">			break;</a>
<a name="ln543">		}</a>
<a name="ln544">		case MSG_SHOW_TEAM_SETTINGS_WINDOW:</a>
<a name="ln545">		{</a>
<a name="ln546">			if (fTeamSettingsWindow != NULL) {</a>
<a name="ln547">				AutoLocker&lt;BWindow&gt; lock(fTeamSettingsWindow);</a>
<a name="ln548">				if (lock.IsLocked())</a>
<a name="ln549">					fTeamSettingsWindow-&gt;Activate(true);</a>
<a name="ln550">			} else {</a>
<a name="ln551">				try {</a>
<a name="ln552">					fTeamSettingsWindow</a>
<a name="ln553">						= TeamSettingsWindow::Create(</a>
<a name="ln554">						fTeam, fListener, this);</a>
<a name="ln555">					if (fTeamSettingsWindow != NULL)</a>
<a name="ln556">						fTeamSettingsWindow-&gt;Show();</a>
<a name="ln557">				} catch (...) {</a>
<a name="ln558">					// TODO: notify user</a>
<a name="ln559">				}</a>
<a name="ln560">			}</a>
<a name="ln561">			break;</a>
<a name="ln562">		}</a>
<a name="ln563">		case MSG_TEAM_SETTINGS_WINDOW_CLOSED:</a>
<a name="ln564">		{</a>
<a name="ln565">			fTeamSettingsWindow = NULL;</a>
<a name="ln566">			break;</a>
<a name="ln567">		}</a>
<a name="ln568">		case MSG_SHOW_BREAKPOINT_EDIT_WINDOW:</a>
<a name="ln569">		{</a>
<a name="ln570">			if (fBreakpointEditWindow != NULL) {</a>
<a name="ln571">				AutoLocker&lt;BWindow&gt; lock(fBreakpointEditWindow);</a>
<a name="ln572">				if (lock.IsLocked())</a>
<a name="ln573">					fBreakpointEditWindow-&gt;Activate(true);</a>
<a name="ln574">			} else {</a>
<a name="ln575">				UserBreakpoint* breakpoint;</a>
<a name="ln576">				if (message-&gt;FindPointer(&quot;breakpoint&quot;,</a>
<a name="ln577">					reinterpret_cast&lt;void**&gt;(&amp;breakpoint)) != B_OK) {</a>
<a name="ln578">					break;</a>
<a name="ln579">				}</a>
<a name="ln580"> </a>
<a name="ln581">				try {</a>
<a name="ln582">					fBreakpointEditWindow</a>
<a name="ln583">						= BreakpointEditWindow::Create(</a>
<a name="ln584">						fTeam, breakpoint, fListener, this);</a>
<a name="ln585">					if (fBreakpointEditWindow != NULL)</a>
<a name="ln586">						fBreakpointEditWindow-&gt;Show();</a>
<a name="ln587">				} catch (...) {</a>
<a name="ln588">					// TODO: notify user</a>
<a name="ln589">				}</a>
<a name="ln590">			}</a>
<a name="ln591">			break;</a>
<a name="ln592">		}</a>
<a name="ln593">		case MSG_BREAKPOINT_EDIT_WINDOW_CLOSED:</a>
<a name="ln594">		{</a>
<a name="ln595">			fBreakpointEditWindow = NULL;</a>
<a name="ln596">			break;</a>
<a name="ln597">		}</a>
<a name="ln598">		case MSG_SHOW_WATCH_VARIABLE_PROMPT:</a>
<a name="ln599">		{</a>
<a name="ln600">			target_addr_t address;</a>
<a name="ln601">			uint32 type;</a>
<a name="ln602">			int32 length;</a>
<a name="ln603"> </a>
<a name="ln604">			if (message-&gt;FindUInt64(&quot;address&quot;, &amp;address) != B_OK</a>
<a name="ln605">				|| message-&gt;FindUInt32(&quot;type&quot;, &amp;type) != B_OK</a>
<a name="ln606">				|| message-&gt;FindInt32(&quot;length&quot;, &amp;length) != B_OK) {</a>
<a name="ln607">				break;</a>
<a name="ln608">			}</a>
<a name="ln609"> </a>
<a name="ln610">			try {</a>
<a name="ln611">				WatchPromptWindow* window = WatchPromptWindow::Create(</a>
<a name="ln612">					fTeam-&gt;GetArchitecture(), address, type, length,</a>
<a name="ln613">					fListener);</a>
<a name="ln614">				window-&gt;Show();</a>
<a name="ln615">			} catch (...) {</a>
<a name="ln616">				// TODO: notify user</a>
<a name="ln617">			}</a>
<a name="ln618">			break;</a>
<a name="ln619">		}</a>
<a name="ln620">		case B_REFS_RECEIVED:</a>
<a name="ln621">		{</a>
<a name="ln622">			entry_ref locatedPath;</a>
<a name="ln623">			if (message-&gt;FindRef(&quot;refs&quot;, &amp;locatedPath) != B_OK)</a>
<a name="ln624">				break;</a>
<a name="ln625"> </a>
<a name="ln626">			_HandleResolveMissingSourceFile(locatedPath);</a>
<a name="ln627">			delete fFilePanel;</a>
<a name="ln628">			fFilePanel = NULL;</a>
<a name="ln629">			break;</a>
<a name="ln630">		}</a>
<a name="ln631">		case MSG_LOCATE_SOURCE_IF_NEEDED:</a>
<a name="ln632">		{</a>
<a name="ln633">			_HandleLocateSourceRequest();</a>
<a name="ln634">			break;</a>
<a name="ln635">		}</a>
<a name="ln636">		case MSG_SOURCE_ENTRY_QUERY_COMPLETE:</a>
<a name="ln637">		{</a>
<a name="ln638">			BStringList* entries;</a>
<a name="ln639">			if (message-&gt;FindPointer(&quot;entries&quot;, (void**)&amp;entries) == B_OK) {</a>
<a name="ln640">				ObjectDeleter&lt;BStringList&gt; entryDeleter(entries);</a>
<a name="ln641">				_HandleLocateSourceRequest(entries);</a>
<a name="ln642">			}</a>
<a name="ln643">			fActiveSourceWorker = -1;</a>
<a name="ln644">			break;</a>
<a name="ln645">		}</a>
<a name="ln646">		case MSG_THREAD_RUN:</a>
<a name="ln647">		case MSG_THREAD_STOP:</a>
<a name="ln648">		case MSG_THREAD_STEP_OVER:</a>
<a name="ln649">		case MSG_THREAD_STEP_INTO:</a>
<a name="ln650">		case MSG_THREAD_STEP_OUT:</a>
<a name="ln651">			if (fActiveThread != NULL &amp;&amp; fTraceUpdateRunner == NULL) {</a>
<a name="ln652">				fListener-&gt;ThreadActionRequested(fActiveThread-&gt;ID(),</a>
<a name="ln653">					message-&gt;what);</a>
<a name="ln654">			}</a>
<a name="ln655">			break;</a>
<a name="ln656"> </a>
<a name="ln657">		case MSG_CLEAR_STACK_TRACE:</a>
<a name="ln658">		{</a>
<a name="ln659">			if (fTraceUpdateRunner != NULL) {</a>
<a name="ln660">				_SetActiveStackTrace(NULL);</a>
<a name="ln661">				_UpdateRunButtons();</a>
<a name="ln662">			}</a>
<a name="ln663">			break;</a>
<a name="ln664">		}</a>
<a name="ln665">		case MSG_HANDLE_LOAD_SETTINGS:</a>
<a name="ln666">		{</a>
<a name="ln667">			GuiTeamUiSettings* settings;</a>
<a name="ln668">			if (message-&gt;FindPointer(&quot;settings&quot;,</a>
<a name="ln669">				reinterpret_cast&lt;void**&gt;(&amp;settings)) != B_OK) {</a>
<a name="ln670">				break;</a>
<a name="ln671">			}</a>
<a name="ln672"> </a>
<a name="ln673">			_LoadSettings(settings);</a>
<a name="ln674">			break;</a>
<a name="ln675">		}</a>
<a name="ln676">		case MSG_UPDATE_STATUS_BAR:</a>
<a name="ln677">		{</a>
<a name="ln678">			const char* messageText;</a>
<a name="ln679">			if (message-&gt;FindString(&quot;message&quot;, &amp;messageText) == B_OK)</a>
<a name="ln680">				fStatusBarView-&gt;SetText(messageText);</a>
<a name="ln681">			break;</a>
<a name="ln682">		}</a>
<a name="ln683">		case MSG_TEAM_RENAMED:</a>
<a name="ln684">		{</a>
<a name="ln685">			_UpdateTitle();</a>
<a name="ln686">			break;</a>
<a name="ln687">		}</a>
<a name="ln688">		case MSG_THREAD_STATE_CHANGED:</a>
<a name="ln689">		{</a>
<a name="ln690">			int32 threadID;</a>
<a name="ln691">			if (message-&gt;FindInt32(&quot;thread&quot;, &amp;threadID) != B_OK)</a>
<a name="ln692">				break;</a>
<a name="ln693"> </a>
<a name="ln694">			_HandleThreadStateChanged(threadID);</a>
<a name="ln695">			break;</a>
<a name="ln696">		}</a>
<a name="ln697">		case MSG_THREAD_CPU_STATE_CHANGED:</a>
<a name="ln698">		{</a>
<a name="ln699">			int32 threadID;</a>
<a name="ln700">			if (message-&gt;FindInt32(&quot;thread&quot;, &amp;threadID) != B_OK)</a>
<a name="ln701">				break;</a>
<a name="ln702"> </a>
<a name="ln703">			_HandleCpuStateChanged(threadID);</a>
<a name="ln704">			break;</a>
<a name="ln705">		}</a>
<a name="ln706"> </a>
<a name="ln707">		case MSG_THREAD_STACK_TRACE_CHANGED:</a>
<a name="ln708">		{</a>
<a name="ln709">			int32 threadID;</a>
<a name="ln710">			if (message-&gt;FindInt32(&quot;thread&quot;, &amp;threadID) != B_OK)</a>
<a name="ln711">				break;</a>
<a name="ln712"> </a>
<a name="ln713">			_HandleStackTraceChanged(threadID);</a>
<a name="ln714">			break;</a>
<a name="ln715">		}</a>
<a name="ln716"> </a>
<a name="ln717">		case MSG_IMAGE_DEBUG_INFO_CHANGED:</a>
<a name="ln718">		{</a>
<a name="ln719">			int32 imageID;</a>
<a name="ln720">			if (message-&gt;FindInt32(&quot;image&quot;, &amp;imageID) != B_OK)</a>
<a name="ln721">				break;</a>
<a name="ln722"> </a>
<a name="ln723">			_HandleImageDebugInfoChanged(imageID);</a>
<a name="ln724">			break;</a>
<a name="ln725">		}</a>
<a name="ln726"> </a>
<a name="ln727">		case MSG_CONSOLE_OUTPUT_RECEIVED:</a>
<a name="ln728">		{</a>
<a name="ln729">			int32 fd;</a>
<a name="ln730">			BString output;</a>
<a name="ln731">			if (message-&gt;FindInt32(&quot;fd&quot;, &amp;fd) != B_OK</a>
<a name="ln732">					|| message-&gt;FindString(&quot;output&quot;, &amp;output) != B_OK) {</a>
<a name="ln733">				break;</a>
<a name="ln734">			}</a>
<a name="ln735">			fConsoleOutputView-&gt;ConsoleOutputReceived(fd, output);</a>
<a name="ln736">			break;</a>
<a name="ln737">		}</a>
<a name="ln738"> </a>
<a name="ln739">		case MSG_USER_BREAKPOINT_CHANGED:</a>
<a name="ln740">		{</a>
<a name="ln741">			UserBreakpoint* breakpoint;</a>
<a name="ln742">			if (message-&gt;FindPointer(&quot;breakpoint&quot;, (void**)&amp;breakpoint) != B_OK)</a>
<a name="ln743">				break;</a>
<a name="ln744">			BReference&lt;UserBreakpoint&gt; breakpointReference(breakpoint, true);</a>
<a name="ln745"> </a>
<a name="ln746">			_HandleUserBreakpointChanged(breakpoint);</a>
<a name="ln747">			break;</a>
<a name="ln748">		}</a>
<a name="ln749"> </a>
<a name="ln750">		case MSG_WATCHPOINT_CHANGED:</a>
<a name="ln751">		{</a>
<a name="ln752">			Watchpoint* watchpoint;</a>
<a name="ln753">			if (message-&gt;FindPointer(&quot;watchpoint&quot;, (void**)&amp;watchpoint) != B_OK)</a>
<a name="ln754">				break;</a>
<a name="ln755">			BReference&lt;Watchpoint&gt; watchpointReference(watchpoint, true);</a>
<a name="ln756"> </a>
<a name="ln757">			_HandleWatchpointChanged(watchpoint);</a>
<a name="ln758">			break;</a>
<a name="ln759"> </a>
<a name="ln760">		}</a>
<a name="ln761"> </a>
<a name="ln762">		case MSG_FUNCTION_SOURCE_CODE_CHANGED:</a>
<a name="ln763">		{</a>
<a name="ln764">			_HandleSourceCodeChanged();</a>
<a name="ln765">			break;</a>
<a name="ln766">		}</a>
<a name="ln767"> </a>
<a name="ln768">		default:</a>
<a name="ln769">			BWindow::MessageReceived(message);</a>
<a name="ln770">			break;</a>
<a name="ln771">	}</a>
<a name="ln772">}</a>
<a name="ln773"> </a>
<a name="ln774"> </a>
<a name="ln775">bool</a>
<a name="ln776">TeamWindow::QuitRequested()</a>
<a name="ln777">{</a>
<a name="ln778">	fListener-&gt;UserInterfaceQuitRequested();</a>
<a name="ln779"> </a>
<a name="ln780">	return false;</a>
<a name="ln781">}</a>
<a name="ln782"> </a>
<a name="ln783"> </a>
<a name="ln784">status_t</a>
<a name="ln785">TeamWindow::LoadSettings(const GuiTeamUiSettings* settings)</a>
<a name="ln786">{</a>
<a name="ln787">	BMessage message(MSG_HANDLE_LOAD_SETTINGS);</a>
<a name="ln788">	message.AddPointer(&quot;settings&quot;, settings);</a>
<a name="ln789">	return PostMessage(&amp;message);</a>
<a name="ln790">}</a>
<a name="ln791"> </a>
<a name="ln792"> </a>
<a name="ln793">status_t</a>
<a name="ln794">TeamWindow::SaveSettings(GuiTeamUiSettings* settings)</a>
<a name="ln795">{</a>
<a name="ln796">	AutoLocker&lt;BWindow&gt; lock(this);</a>
<a name="ln797">	if (!lock.IsLocked())</a>
<a name="ln798">		return B_ERROR;</a>
<a name="ln799"> </a>
<a name="ln800">	BMessage inspectorSettings;</a>
<a name="ln801">	if (fUiSettings.Settings(&quot;inspectorWindow&quot;, inspectorSettings) == B_OK) {</a>
<a name="ln802">		if (!settings-&gt;AddSettings(&quot;inspectorWindow&quot;, inspectorSettings))</a>
<a name="ln803">			return B_NO_MEMORY;</a>
<a name="ln804">	}</a>
<a name="ln805"> </a>
<a name="ln806">	BMessage archive;</a>
<a name="ln807">	BMessage teamWindowSettings;</a>
<a name="ln808">	if (teamWindowSettings.AddRect(&quot;frame&quot;, Frame()) != B_OK)</a>
<a name="ln809">		return B_NO_MEMORY;</a>
<a name="ln810"> </a>
<a name="ln811">	if (GuiSettingsUtils::ArchiveSplitView(archive, fSourceSplitView) != B_OK)</a>
<a name="ln812">		return B_NO_MEMORY;</a>
<a name="ln813">	if (teamWindowSettings.AddMessage(&quot;sourceSplit&quot;, &amp;archive) != B_OK)</a>
<a name="ln814">		return B_NO_MEMORY;</a>
<a name="ln815"> </a>
<a name="ln816">	if (GuiSettingsUtils::ArchiveSplitView(archive, fFunctionSplitView) != B_OK)</a>
<a name="ln817">		return B_NO_MEMORY;</a>
<a name="ln818">	if (teamWindowSettings.AddMessage(&quot;functionSplit&quot;, &amp;archive) != B_OK)</a>
<a name="ln819">		return B_NO_MEMORY;</a>
<a name="ln820"> </a>
<a name="ln821">	if (GuiSettingsUtils::ArchiveSplitView(archive, fImageSplitView) != B_OK)</a>
<a name="ln822">		return B_NO_MEMORY;</a>
<a name="ln823">	if (teamWindowSettings.AddMessage(&quot;imageSplit&quot;, &amp;archive))</a>
<a name="ln824">		return B_NO_MEMORY;</a>
<a name="ln825"> </a>
<a name="ln826">	if (GuiSettingsUtils::ArchiveSplitView(archive, fThreadSplitView) != B_OK)</a>
<a name="ln827">		return B_NO_MEMORY;</a>
<a name="ln828">	if (teamWindowSettings.AddMessage(&quot;threadSplit&quot;, &amp;archive))</a>
<a name="ln829">		return B_NO_MEMORY;</a>
<a name="ln830"> </a>
<a name="ln831">	if (GuiSettingsUtils::ArchiveSplitView(archive, fConsoleSplitView) != B_OK)</a>
<a name="ln832">		return B_NO_MEMORY;</a>
<a name="ln833">	if (teamWindowSettings.AddMessage(&quot;consoleSplit&quot;, &amp;archive))</a>
<a name="ln834">		return B_NO_MEMORY;</a>
<a name="ln835"> </a>
<a name="ln836">	if (fImageListView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln837">		return B_NO_MEMORY;</a>
<a name="ln838">	if (teamWindowSettings.AddMessage(&quot;imageListView&quot;, &amp;archive))</a>
<a name="ln839">		return B_NO_MEMORY;</a>
<a name="ln840"> </a>
<a name="ln841">	if (fImageFunctionsView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln842">		return B_NO_MEMORY;</a>
<a name="ln843">	if (teamWindowSettings.AddMessage(&quot;imageFunctionsView&quot;, &amp;archive))</a>
<a name="ln844">		return B_NO_MEMORY;</a>
<a name="ln845"> </a>
<a name="ln846">	if (fThreadListView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln847">		return B_NO_MEMORY;</a>
<a name="ln848">	if (teamWindowSettings.AddMessage(&quot;threadListView&quot;, &amp;archive))</a>
<a name="ln849">		return B_NO_MEMORY;</a>
<a name="ln850"> </a>
<a name="ln851">	if (fVariablesView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln852">		return B_NO_MEMORY;</a>
<a name="ln853">	if (teamWindowSettings.AddMessage(&quot;variablesView&quot;, &amp;archive))</a>
<a name="ln854">		return B_NO_MEMORY;</a>
<a name="ln855"> </a>
<a name="ln856">	if (fRegistersView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln857">		return B_NO_MEMORY;</a>
<a name="ln858">	if (teamWindowSettings.AddMessage(&quot;registersView&quot;, &amp;archive))</a>
<a name="ln859">		return B_NO_MEMORY;</a>
<a name="ln860"> </a>
<a name="ln861">	if (fStackTraceView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln862">		return B_NO_MEMORY;</a>
<a name="ln863">	if (teamWindowSettings.AddMessage(&quot;stackTraceView&quot;, &amp;archive))</a>
<a name="ln864">		return B_NO_MEMORY;</a>
<a name="ln865"> </a>
<a name="ln866">	if (fBreakpointsView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln867">		return B_NO_MEMORY;</a>
<a name="ln868">	if (teamWindowSettings.AddMessage(&quot;breakpointsView&quot;, &amp;archive))</a>
<a name="ln869">		return B_NO_MEMORY;</a>
<a name="ln870"> </a>
<a name="ln871">	if (fConsoleOutputView-&gt;SaveSettings(archive) != B_OK)</a>
<a name="ln872">		return B_NO_MEMORY;</a>
<a name="ln873">	if (teamWindowSettings.AddMessage(&quot;consoleOutputView&quot;, &amp;archive))</a>
<a name="ln874">		return B_NO_MEMORY;</a>
<a name="ln875"> </a>
<a name="ln876">	if (!settings-&gt;AddSettings(&quot;teamWindow&quot;, teamWindowSettings))</a>
<a name="ln877">		return B_NO_MEMORY;</a>
<a name="ln878"> </a>
<a name="ln879">	return B_OK;</a>
<a name="ln880">}</a>
<a name="ln881"> </a>
<a name="ln882"> </a>
<a name="ln883">void</a>
<a name="ln884">TeamWindow::DisplayBackgroundStatus(const char* message)</a>
<a name="ln885">{</a>
<a name="ln886">	BMessage updateMessage(MSG_UPDATE_STATUS_BAR);</a>
<a name="ln887">	updateMessage.AddString(&quot;message&quot;, message);</a>
<a name="ln888">	PostMessage(&amp;updateMessage);</a>
<a name="ln889">}</a>
<a name="ln890"> </a>
<a name="ln891"> </a>
<a name="ln892">void</a>
<a name="ln893">TeamWindow::ThreadSelectionChanged(::Thread* thread)</a>
<a name="ln894">{</a>
<a name="ln895">	_SetActiveThread(thread);</a>
<a name="ln896">}</a>
<a name="ln897"> </a>
<a name="ln898"> </a>
<a name="ln899">void</a>
<a name="ln900">TeamWindow::ImageSelectionChanged(Image* image)</a>
<a name="ln901">{</a>
<a name="ln902">	_SetActiveImage(image);</a>
<a name="ln903">}</a>
<a name="ln904"> </a>
<a name="ln905"> </a>
<a name="ln906">void</a>
<a name="ln907">TeamWindow::StackFrameSelectionChanged(StackFrame* frame)</a>
<a name="ln908">{</a>
<a name="ln909">	_SetActiveStackFrame(frame);</a>
<a name="ln910">}</a>
<a name="ln911"> </a>
<a name="ln912"> </a>
<a name="ln913">void</a>
<a name="ln914">TeamWindow::FunctionSelectionChanged(FunctionInstance* function)</a>
<a name="ln915">{</a>
<a name="ln916">	// If the function wasn't already active, it was just selected by the user.</a>
<a name="ln917">	if (function != NULL &amp;&amp; function != fActiveFunction)</a>
<a name="ln918">		fActiveSourceObject = ACTIVE_SOURCE_FUNCTION;</a>
<a name="ln919"> </a>
<a name="ln920">	_SetActiveFunction(function);</a>
<a name="ln921">}</a>
<a name="ln922"> </a>
<a name="ln923"> </a>
<a name="ln924">void</a>
<a name="ln925">TeamWindow::BreakpointSelectionChanged(BreakpointProxyList &amp;proxies)</a>
<a name="ln926">{</a>
<a name="ln927">	if (proxies.CountItems() == 0 &amp;&amp; fActiveBreakpoint != NULL) {</a>
<a name="ln928">		fActiveBreakpoint-&gt;ReleaseReference();</a>
<a name="ln929">		fActiveBreakpoint = NULL;</a>
<a name="ln930">	} else if (proxies.CountItems() == 1) {</a>
<a name="ln931">		BreakpointProxy* proxy = proxies.ItemAt(0);</a>
<a name="ln932">		if (proxy-&gt;Type() == BREAKPOINT_PROXY_TYPE_BREAKPOINT)</a>
<a name="ln933">			_SetActiveBreakpoint(proxy-&gt;GetBreakpoint());</a>
<a name="ln934">	}</a>
<a name="ln935">	// if more than one item is selected, do nothing.</a>
<a name="ln936">}</a>
<a name="ln937"> </a>
<a name="ln938"> </a>
<a name="ln939">void</a>
<a name="ln940">TeamWindow::SetBreakpointEnabledRequested(UserBreakpoint* breakpoint,</a>
<a name="ln941">	bool enabled)</a>
<a name="ln942">{</a>
<a name="ln943">	fListener-&gt;SetBreakpointEnabledRequested(breakpoint, enabled);</a>
<a name="ln944">}</a>
<a name="ln945"> </a>
<a name="ln946"> </a>
<a name="ln947">void</a>
<a name="ln948">TeamWindow::ClearBreakpointRequested(UserBreakpoint* breakpoint)</a>
<a name="ln949">{</a>
<a name="ln950">	fListener-&gt;ClearBreakpointRequested(breakpoint);</a>
<a name="ln951">}</a>
<a name="ln952"> </a>
<a name="ln953"> </a>
<a name="ln954">void</a>
<a name="ln955">TeamWindow::SetBreakpointRequested(target_addr_t address, bool enabled)</a>
<a name="ln956">{</a>
<a name="ln957">	fListener-&gt;SetBreakpointRequested(address, enabled);</a>
<a name="ln958">}</a>
<a name="ln959"> </a>
<a name="ln960"> </a>
<a name="ln961">void</a>
<a name="ln962">TeamWindow::ClearBreakpointRequested(target_addr_t address)</a>
<a name="ln963">{</a>
<a name="ln964">	fListener-&gt;ClearBreakpointRequested(address);</a>
<a name="ln965">}</a>
<a name="ln966"> </a>
<a name="ln967"> </a>
<a name="ln968">void</a>
<a name="ln969">TeamWindow::ThreadActionRequested(::Thread* thread, uint32 action,</a>
<a name="ln970">	target_addr_t address)</a>
<a name="ln971">{</a>
<a name="ln972">	if (fTraceUpdateRunner == NULL)</a>
<a name="ln973">		fListener-&gt;ThreadActionRequested(thread-&gt;ID(), action, address);</a>
<a name="ln974">}</a>
<a name="ln975"> </a>
<a name="ln976"> </a>
<a name="ln977">void</a>
<a name="ln978">TeamWindow::FunctionSourceCodeRequested(FunctionInstance* function,</a>
<a name="ln979">	bool forceDisassembly)</a>
<a name="ln980">{</a>
<a name="ln981">	fListener-&gt;FunctionSourceCodeRequested(function, forceDisassembly);</a>
<a name="ln982">}</a>
<a name="ln983"> </a>
<a name="ln984"> </a>
<a name="ln985">void</a>
<a name="ln986">TeamWindow::SetWatchpointEnabledRequested(Watchpoint* watchpoint,</a>
<a name="ln987">	bool enabled)</a>
<a name="ln988">{</a>
<a name="ln989">	fListener-&gt;SetWatchpointEnabledRequested(watchpoint, enabled);</a>
<a name="ln990">}</a>
<a name="ln991"> </a>
<a name="ln992"> </a>
<a name="ln993">void</a>
<a name="ln994">TeamWindow::ClearWatchpointRequested(Watchpoint* watchpoint)</a>
<a name="ln995">{</a>
<a name="ln996">	fListener-&gt;ClearWatchpointRequested(watchpoint);</a>
<a name="ln997">}</a>
<a name="ln998"> </a>
<a name="ln999"> </a>
<a name="ln1000">void</a>
<a name="ln1001">TeamWindow::ValueNodeValueRequested(CpuState* cpuState,</a>
<a name="ln1002">	ValueNodeContainer* container, ValueNode* valueNode)</a>
<a name="ln1003">{</a>
<a name="ln1004">	fListener-&gt;ValueNodeValueRequested(cpuState, container, valueNode);</a>
<a name="ln1005">}</a>
<a name="ln1006"> </a>
<a name="ln1007"> </a>
<a name="ln1008">void</a>
<a name="ln1009">TeamWindow::ExpressionEvaluationRequested(ExpressionInfo* info,</a>
<a name="ln1010">	StackFrame* frame, ::Thread* thread)</a>
<a name="ln1011">{</a>
<a name="ln1012">	SourceLanguage* language;</a>
<a name="ln1013">	if (_GetActiveSourceLanguage(language) != B_OK)</a>
<a name="ln1014">		return;</a>
<a name="ln1015"> </a>
<a name="ln1016">	BReference&lt;SourceLanguage&gt; languageReference(language, true);</a>
<a name="ln1017">	fListener-&gt;ExpressionEvaluationRequested(language, info, frame, thread);</a>
<a name="ln1018">}</a>
<a name="ln1019"> </a>
<a name="ln1020"> </a>
<a name="ln1021">void</a>
<a name="ln1022">TeamWindow::ValueNodeWriteRequested(ValueNode* node, CpuState* state,</a>
<a name="ln1023">	Value* newValue)</a>
<a name="ln1024">{</a>
<a name="ln1025">	fListener-&gt;ValueNodeWriteRequested(node, state, newValue);</a>
<a name="ln1026">}</a>
<a name="ln1027"> </a>
<a name="ln1028"> </a>
<a name="ln1029">void</a>
<a name="ln1030">TeamWindow::TeamRenamed(const Team::Event&amp; event)</a>
<a name="ln1031">{</a>
<a name="ln1032">	PostMessage(MSG_TEAM_RENAMED);</a>
<a name="ln1033">}</a>
<a name="ln1034"> </a>
<a name="ln1035"> </a>
<a name="ln1036">void</a>
<a name="ln1037">TeamWindow::ThreadStateChanged(const Team::ThreadEvent&amp; event)</a>
<a name="ln1038">{</a>
<a name="ln1039">	BMessage message(MSG_THREAD_STATE_CHANGED);</a>
<a name="ln1040">	message.AddInt32(&quot;thread&quot;, event.GetThread()-&gt;ID());</a>
<a name="ln1041">	PostMessage(&amp;message);</a>
<a name="ln1042">}</a>
<a name="ln1043"> </a>
<a name="ln1044"> </a>
<a name="ln1045">void</a>
<a name="ln1046">TeamWindow::ThreadCpuStateChanged(const Team::ThreadEvent&amp; event)</a>
<a name="ln1047">{</a>
<a name="ln1048">	BMessage message(MSG_THREAD_CPU_STATE_CHANGED);</a>
<a name="ln1049">	message.AddInt32(&quot;thread&quot;, event.GetThread()-&gt;ID());</a>
<a name="ln1050">	PostMessage(&amp;message);</a>
<a name="ln1051">}</a>
<a name="ln1052"> </a>
<a name="ln1053"> </a>
<a name="ln1054">void</a>
<a name="ln1055">TeamWindow::ThreadStackTraceChanged(const Team::ThreadEvent&amp; event)</a>
<a name="ln1056">{</a>
<a name="ln1057">	BMessage message(MSG_THREAD_STACK_TRACE_CHANGED);</a>
<a name="ln1058">	message.AddInt32(&quot;thread&quot;, event.GetThread()-&gt;ID());</a>
<a name="ln1059">	PostMessage(&amp;message);</a>
<a name="ln1060">}</a>
<a name="ln1061"> </a>
<a name="ln1062"> </a>
<a name="ln1063">void</a>
<a name="ln1064">TeamWindow::ImageDebugInfoChanged(const Team::ImageEvent&amp; event)</a>
<a name="ln1065">{</a>
<a name="ln1066">	BMessage message(MSG_IMAGE_DEBUG_INFO_CHANGED);</a>
<a name="ln1067">	message.AddInt32(&quot;image&quot;, event.GetImage()-&gt;ID());</a>
<a name="ln1068">	PostMessage(&amp;message);</a>
<a name="ln1069">}</a>
<a name="ln1070"> </a>
<a name="ln1071"> </a>
<a name="ln1072">void</a>
<a name="ln1073">TeamWindow::ConsoleOutputReceived(const Team::ConsoleOutputEvent&amp; event)</a>
<a name="ln1074">{</a>
<a name="ln1075">	BMessage message(MSG_CONSOLE_OUTPUT_RECEIVED);</a>
<a name="ln1076">	message.AddInt32(&quot;fd&quot;, event.Descriptor());</a>
<a name="ln1077">	message.AddString(&quot;output&quot;, event.Output());</a>
<a name="ln1078">	PostMessage(&amp;message);</a>
<a name="ln1079">}</a>
<a name="ln1080"> </a>
<a name="ln1081"> </a>
<a name="ln1082">void</a>
<a name="ln1083">TeamWindow::UserBreakpointChanged(const Team::UserBreakpointEvent&amp; event)</a>
<a name="ln1084">{</a>
<a name="ln1085">	BMessage message(MSG_USER_BREAKPOINT_CHANGED);</a>
<a name="ln1086">	BReference&lt;UserBreakpoint&gt; breakpointReference(event.GetBreakpoint());</a>
<a name="ln1087">	if (message.AddPointer(&quot;breakpoint&quot;, event.GetBreakpoint()) == B_OK</a>
<a name="ln1088">		&amp;&amp; PostMessage(&amp;message) == B_OK) {</a>
<a name="ln1089">		breakpointReference.Detach();</a>
<a name="ln1090">	}</a>
<a name="ln1091">}</a>
<a name="ln1092"> </a>
<a name="ln1093"> </a>
<a name="ln1094">void</a>
<a name="ln1095">TeamWindow::WatchpointChanged(const Team::WatchpointEvent&amp; event)</a>
<a name="ln1096">{</a>
<a name="ln1097">	BMessage message(MSG_WATCHPOINT_CHANGED);</a>
<a name="ln1098">	BReference&lt;Watchpoint&gt; watchpointReference(event.GetWatchpoint());</a>
<a name="ln1099">	if (message.AddPointer(&quot;watchpoint&quot;, event.GetWatchpoint()) == B_OK</a>
<a name="ln1100">		&amp;&amp; PostMessage(&amp;message) == B_OK) {</a>
<a name="ln1101">		watchpointReference.Detach();</a>
<a name="ln1102">	}</a>
<a name="ln1103">}</a>
<a name="ln1104"> </a>
<a name="ln1105"> </a>
<a name="ln1106">void</a>
<a name="ln1107">TeamWindow::DebugReportChanged(const Team::DebugReportEvent&amp; event)</a>
<a name="ln1108">{</a>
<a name="ln1109">	BMessage message(MSG_DEBUG_REPORT_SAVED);</a>
<a name="ln1110">	message.AddString(&quot;path&quot;, event.GetReportPath());</a>
<a name="ln1111">	message.AddInt32(&quot;status&quot;, event.GetFinalStatus());</a>
<a name="ln1112">	PostMessage(&amp;message);</a>
<a name="ln1113">}</a>
<a name="ln1114"> </a>
<a name="ln1115"> </a>
<a name="ln1116">void</a>
<a name="ln1117">TeamWindow::CoreFileChanged(const Team::CoreFileChangedEvent&amp; event)</a>
<a name="ln1118">{</a>
<a name="ln1119">	BMessage message(MSG_CORE_FILE_WRITTEN);</a>
<a name="ln1120">	message.AddString(&quot;path&quot;, event.GetTargetPath());</a>
<a name="ln1121">	PostMessage(&amp;message);</a>
<a name="ln1122">}</a>
<a name="ln1123"> </a>
<a name="ln1124"> </a>
<a name="ln1125">void</a>
<a name="ln1126">TeamWindow::FunctionSourceCodeChanged(Function* function)</a>
<a name="ln1127">{</a>
<a name="ln1128">	TRACE_GUI(&quot;TeamWindow::FunctionSourceCodeChanged(%p): source: %p, &quot;</a>
<a name="ln1129">		&quot;state: %d\n&quot;, function, function-&gt;GetSourceCode(),</a>
<a name="ln1130">		function-&gt;SourceCodeState());</a>
<a name="ln1131"> </a>
<a name="ln1132">	PostMessage(MSG_FUNCTION_SOURCE_CODE_CHANGED);</a>
<a name="ln1133">}</a>
<a name="ln1134"> </a>
<a name="ln1135"> </a>
<a name="ln1136">void</a>
<a name="ln1137">TeamWindow::_Init()</a>
<a name="ln1138">{</a>
<a name="ln1139">	fThreadSelectionInfoTable = new ThreadStackFrameSelectionInfoTable;</a>
<a name="ln1140">	if (fThreadSelectionInfoTable-&gt;Init() != B_OK) {</a>
<a name="ln1141">		delete fThreadSelectionInfoTable;</a>
<a name="ln1142">		fThreadSelectionInfoTable = NULL;</a>
<a name="ln1143">		throw std::bad_alloc();</a>
<a name="ln1144">	}</a>
<a name="ln1145"> </a>
<a name="ln1146">	BScrollView* sourceScrollView;</a>
<a name="ln1147"> </a>
<a name="ln1148">	const float splitSpacing = 3.0f;</a>
<a name="ln1149"> </a>
<a name="ln1150">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0.0f)</a>
<a name="ln1151">		.Add(fMenuBar = new BMenuBar(&quot;Menu&quot;))</a>
<a name="ln1152">		.AddSplit(B_VERTICAL, splitSpacing)</a>
<a name="ln1153">			.GetSplitView(&amp;fFunctionSplitView)</a>
<a name="ln1154">			.SetInsets(B_USE_SMALL_INSETS)</a>
<a name="ln1155">			.Add(fTabView = new BTabView(&quot;tab view&quot;), 0.4f)</a>
<a name="ln1156">			.AddSplit(B_HORIZONTAL, splitSpacing)</a>
<a name="ln1157">				.GetSplitView(&amp;fSourceSplitView)</a>
<a name="ln1158">				.AddGroup(B_VERTICAL, B_USE_SMALL_SPACING)</a>
<a name="ln1159">					.AddGroup(B_HORIZONTAL, B_USE_SMALL_SPACING)</a>
<a name="ln1160">						.Add(fRunButton = new BButton(&quot;Run&quot;))</a>
<a name="ln1161">						.Add(fStepOverButton = new BButton(&quot;Step over&quot;))</a>
<a name="ln1162">						.Add(fStepIntoButton = new BButton(&quot;Step into&quot;))</a>
<a name="ln1163">						.Add(fStepOutButton = new BButton(&quot;Step out&quot;))</a>
<a name="ln1164">						.AddGlue()</a>
<a name="ln1165">					.End()</a>
<a name="ln1166">					.Add(fSourcePathView = new BStringView(</a>
<a name="ln1167">						&quot;source path&quot;,</a>
<a name="ln1168">						&quot;Source path unavailable.&quot;), 4.0f)</a>
<a name="ln1169">					.Add(sourceScrollView = new BScrollView(&quot;source scroll&quot;,</a>
<a name="ln1170">						NULL, 0, true, true), splitSpacing)</a>
<a name="ln1171">				.End()</a>
<a name="ln1172">				.Add(fLocalsTabView = new BTabView(&quot;locals view&quot;))</a>
<a name="ln1173">			.End()</a>
<a name="ln1174">			.AddSplit(B_VERTICAL, splitSpacing)</a>
<a name="ln1175">				.GetSplitView(&amp;fConsoleSplitView)</a>
<a name="ln1176">				.SetInsets(0.0)</a>
<a name="ln1177">				.Add(fConsoleOutputView = ConsoleOutputView::Create())</a>
<a name="ln1178">			.End()</a>
<a name="ln1179">		.End()</a>
<a name="ln1180">		.Add(fStatusBarView = new BStringView(&quot;status&quot;, &quot;Ready.&quot;));</a>
<a name="ln1181"> </a>
<a name="ln1182">	fStatusBarView-&gt;SetExplicitMinSize(BSize(50.0, B_SIZE_UNSET));</a>
<a name="ln1183">	fStatusBarView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln1184"> </a>
<a name="ln1185">	// add source view</a>
<a name="ln1186">	sourceScrollView-&gt;SetTarget(fSourceView = SourceView::Create(fTeam, this));</a>
<a name="ln1187"> </a>
<a name="ln1188">	// add threads tab</a>
<a name="ln1189">	BSplitView* threadGroup = new BSplitView(B_HORIZONTAL, splitSpacing);</a>
<a name="ln1190">	threadGroup-&gt;SetName(&quot;Threads&quot;);</a>
<a name="ln1191">	fTabView-&gt;AddTab(threadGroup);</a>
<a name="ln1192">	BLayoutBuilder::Split&lt;&gt;(threadGroup)</a>
<a name="ln1193">		.GetSplitView(&amp;fThreadSplitView)</a>
<a name="ln1194">		.Add(fThreadListView = ThreadListView::Create(fTeam, this))</a>
<a name="ln1195">		.Add(fStackTraceView = StackTraceView::Create(this));</a>
<a name="ln1196"> </a>
<a name="ln1197">	// add images tab</a>
<a name="ln1198">	BSplitView* imagesGroup = new BSplitView(B_HORIZONTAL, splitSpacing);</a>
<a name="ln1199">	imagesGroup-&gt;SetName(&quot;Images&quot;);</a>
<a name="ln1200">	fTabView-&gt;AddTab(imagesGroup);</a>
<a name="ln1201">	BLayoutBuilder::Split&lt;&gt;(imagesGroup)</a>
<a name="ln1202">		.GetSplitView(&amp;fImageSplitView)</a>
<a name="ln1203">		.Add(fImageListView = ImageListView::Create(fTeam, this))</a>
<a name="ln1204">		.Add(fImageFunctionsView = ImageFunctionsView::Create(this));</a>
<a name="ln1205"> </a>
<a name="ln1206">	// add breakpoints tab</a>
<a name="ln1207">	BGroupView* breakpointsGroup = new BGroupView(B_HORIZONTAL,</a>
<a name="ln1208">		B_USE_SMALL_SPACING);</a>
<a name="ln1209">	breakpointsGroup-&gt;SetName(&quot;Breakpoints&quot;);</a>
<a name="ln1210">	fTabView-&gt;AddTab(breakpointsGroup);</a>
<a name="ln1211">	BLayoutBuilder::Group&lt;&gt;(breakpointsGroup)</a>
<a name="ln1212">//		.SetInsets(0.0f)</a>
<a name="ln1213">		.Add(fBreakpointsView = BreakpointsView::Create(fTeam, this));</a>
<a name="ln1214"> </a>
<a name="ln1215">	ValueNodeManager* manager = new ValueNodeManager;</a>
<a name="ln1216"> </a>
<a name="ln1217">	// add local variables tab</a>
<a name="ln1218">	BView* tab = fVariablesView = VariablesView::Create(this, manager);</a>
<a name="ln1219">	fLocalsTabView-&gt;AddTab(tab);</a>
<a name="ln1220"> </a>
<a name="ln1221">	// add registers tab</a>
<a name="ln1222">	tab = fRegistersView = RegistersView::Create(fTeam-&gt;GetArchitecture());</a>
<a name="ln1223">	fLocalsTabView-&gt;AddTab(tab);</a>
<a name="ln1224"> </a>
<a name="ln1225">	fRunButton-&gt;SetMessage(new BMessage(MSG_THREAD_RUN));</a>
<a name="ln1226">	fStepOverButton-&gt;SetMessage(new BMessage(MSG_THREAD_STEP_OVER));</a>
<a name="ln1227">	fStepIntoButton-&gt;SetMessage(new BMessage(MSG_THREAD_STEP_INTO));</a>
<a name="ln1228">	fStepOutButton-&gt;SetMessage(new BMessage(MSG_THREAD_STEP_OUT));</a>
<a name="ln1229">	fRunButton-&gt;SetTarget(this);</a>
<a name="ln1230">	fStepOverButton-&gt;SetTarget(this);</a>
<a name="ln1231">	fStepIntoButton-&gt;SetTarget(this);</a>
<a name="ln1232">	fStepOutButton-&gt;SetTarget(this);</a>
<a name="ln1233"> </a>
<a name="ln1234">	fSourcePathView-&gt;SetExplicitMinSize(BSize(100.0, B_SIZE_UNSET));</a>
<a name="ln1235">	fSourcePathView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln1236">	BMessageFilter* filter = new(std::nothrow) PathViewMessageFilter(</a>
<a name="ln1237">		BMessenger(this));</a>
<a name="ln1238">	if (filter != NULL)</a>
<a name="ln1239">		fSourcePathView-&gt;AddFilter(filter);</a>
<a name="ln1240"> </a>
<a name="ln1241">	// add menus and menu items</a>
<a name="ln1242">	BMenu* menu = new BMenu(&quot;Debugger&quot;);</a>
<a name="ln1243">	fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1244">	BMenuItem* item = new BMenuItem(&quot;Start new team&quot; B_UTF8_ELLIPSIS,</a>
<a name="ln1245">		new BMessage(MSG_SHOW_START_TEAM_WINDOW));</a>
<a name="ln1246">	menu-&gt;AddItem(item);</a>
<a name="ln1247">	item-&gt;SetTarget(be_app);</a>
<a name="ln1248">	item = new BMenuItem(&quot;Show Teams window&quot; B_UTF8_ELLIPSIS,</a>
<a name="ln1249">		new BMessage(MSG_SHOW_TEAMS_WINDOW));</a>
<a name="ln1250">	menu-&gt;AddItem(item);</a>
<a name="ln1251">	item-&gt;SetTarget(be_app);</a>
<a name="ln1252">	menu = new BMenu(&quot;Team&quot;);</a>
<a name="ln1253">	fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1254">	item = new BMenuItem(&quot;Restart&quot;, new BMessage(</a>
<a name="ln1255">		MSG_TEAM_RESTART_REQUESTED), 'R', B_SHIFT_KEY);</a>
<a name="ln1256">	menu-&gt;AddItem(item);</a>
<a name="ln1257">	item-&gt;SetTarget(this);</a>
<a name="ln1258">	item = new BMenuItem(&quot;Close&quot;, new BMessage(B_QUIT_REQUESTED),</a>
<a name="ln1259">		'W');</a>
<a name="ln1260">	menu-&gt;AddItem(item);</a>
<a name="ln1261">	item-&gt;SetTarget(this);</a>
<a name="ln1262">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1263">	item = new BMenuItem(&quot;Settings&quot; B_UTF8_ELLIPSIS, new BMessage(</a>
<a name="ln1264">		MSG_SHOW_TEAM_SETTINGS_WINDOW));</a>
<a name="ln1265">	menu-&gt;AddItem(item);</a>
<a name="ln1266">	item-&gt;SetTarget(this);</a>
<a name="ln1267">	menu = new BMenu(&quot;Edit&quot;);</a>
<a name="ln1268">	fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1269">	item = new BMenuItem(&quot;Copy&quot;, new BMessage(B_COPY), 'C');</a>
<a name="ln1270">	menu-&gt;AddItem(item);</a>
<a name="ln1271">	item-&gt;SetTarget(this);</a>
<a name="ln1272">	item = new BMenuItem(&quot;Select all&quot;, new BMessage(B_SELECT_ALL), 'A');</a>
<a name="ln1273">	menu-&gt;AddItem(item);</a>
<a name="ln1274">	item-&gt;SetTarget(this);</a>
<a name="ln1275">	menu = new BMenu(&quot;Tools&quot;);</a>
<a name="ln1276">	fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1277">	item = new BMenuItem(&quot;Save debug report&quot;,</a>
<a name="ln1278">		new BMessage(MSG_CHOOSE_DEBUG_REPORT_LOCATION));</a>
<a name="ln1279">	menu-&gt;AddItem(item);</a>
<a name="ln1280">	item-&gt;SetTarget(this);</a>
<a name="ln1281">	item = new BMenuItem(&quot;Write core file&quot;,</a>
<a name="ln1282">		new BMessage(MSG_CHOOSE_CORE_FILE_LOCATION));</a>
<a name="ln1283">	menu-&gt;AddItem(item);</a>
<a name="ln1284">	item-&gt;SetTarget(this);</a>
<a name="ln1285">	item = new BMenuItem(&quot;Inspect memory&quot;,</a>
<a name="ln1286">		new BMessage(MSG_SHOW_INSPECTOR_WINDOW), 'I');</a>
<a name="ln1287">	menu-&gt;AddItem(item);</a>
<a name="ln1288">	item-&gt;SetTarget(this);</a>
<a name="ln1289">	item = new BMenuItem(&quot;Evaluate expression&quot;,</a>
<a name="ln1290">		new BMessage(MSG_SHOW_EXPRESSION_WINDOW), 'E');</a>
<a name="ln1291">	menu-&gt;AddItem(item);</a>
<a name="ln1292">	item-&gt;SetTarget(this);</a>
<a name="ln1293"> </a>
<a name="ln1294">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1295">	_UpdateRunButtons();</a>
<a name="ln1296">}</a>
<a name="ln1297"> </a>
<a name="ln1298"> </a>
<a name="ln1299">void</a>
<a name="ln1300">TeamWindow::_LoadSettings(const GuiTeamUiSettings* settings)</a>
<a name="ln1301">{</a>
<a name="ln1302">	BMessage teamWindowSettings;</a>
<a name="ln1303">	// no settings stored yet</a>
<a name="ln1304">	if (settings-&gt;Settings(&quot;teamWindow&quot;, teamWindowSettings) != B_OK)</a>
<a name="ln1305">		return;</a>
<a name="ln1306"> </a>
<a name="ln1307">	BRect frame;</a>
<a name="ln1308">	if (teamWindowSettings.FindRect(&quot;frame&quot;, &amp;frame) == B_OK) {</a>
<a name="ln1309">		ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln1310">		MoveTo(frame.left, frame.top);</a>
<a name="ln1311">	}</a>
<a name="ln1312"> </a>
<a name="ln1313">	BMessage archive;</a>
<a name="ln1314">	if (teamWindowSettings.FindMessage(&quot;sourceSplit&quot;, &amp;archive) == B_OK)</a>
<a name="ln1315">		GuiSettingsUtils::UnarchiveSplitView(archive, fSourceSplitView);</a>
<a name="ln1316"> </a>
<a name="ln1317">	if (teamWindowSettings.FindMessage(&quot;functionSplit&quot;, &amp;archive) == B_OK)</a>
<a name="ln1318">		GuiSettingsUtils::UnarchiveSplitView(archive, fFunctionSplitView);</a>
<a name="ln1319"> </a>
<a name="ln1320">	if (teamWindowSettings.FindMessage(&quot;imageSplit&quot;, &amp;archive) == B_OK)</a>
<a name="ln1321">		GuiSettingsUtils::UnarchiveSplitView(archive, fImageSplitView);</a>
<a name="ln1322"> </a>
<a name="ln1323">	if (teamWindowSettings.FindMessage(&quot;threadSplit&quot;, &amp;archive) == B_OK)</a>
<a name="ln1324">		GuiSettingsUtils::UnarchiveSplitView(archive, fThreadSplitView);</a>
<a name="ln1325"> </a>
<a name="ln1326">	if (teamWindowSettings.FindMessage(&quot;consoleSplit&quot;, &amp;archive) == B_OK)</a>
<a name="ln1327">		GuiSettingsUtils::UnarchiveSplitView(archive, fConsoleSplitView);</a>
<a name="ln1328"> </a>
<a name="ln1329">	if (teamWindowSettings.FindMessage(&quot;imageListView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1330">		fImageListView-&gt;LoadSettings(archive);</a>
<a name="ln1331"> </a>
<a name="ln1332">	if (teamWindowSettings.FindMessage(&quot;imageFunctionsView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1333">		fImageFunctionsView-&gt;LoadSettings(archive);</a>
<a name="ln1334"> </a>
<a name="ln1335">	if (teamWindowSettings.FindMessage(&quot;threadListView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1336">		fThreadListView-&gt;LoadSettings(archive);</a>
<a name="ln1337"> </a>
<a name="ln1338">	if (teamWindowSettings.FindMessage(&quot;variablesView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1339">		fVariablesView-&gt;LoadSettings(archive);</a>
<a name="ln1340"> </a>
<a name="ln1341">	if (teamWindowSettings.FindMessage(&quot;registersView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1342">		fRegistersView-&gt;LoadSettings(archive);</a>
<a name="ln1343"> </a>
<a name="ln1344">	if (teamWindowSettings.FindMessage(&quot;stackTraceView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1345">		fStackTraceView-&gt;LoadSettings(archive);</a>
<a name="ln1346"> </a>
<a name="ln1347">	if (teamWindowSettings.FindMessage(&quot;breakpointsView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1348">		fBreakpointsView-&gt;LoadSettings(archive);</a>
<a name="ln1349"> </a>
<a name="ln1350">	if (teamWindowSettings.FindMessage(&quot;consoleOutputView&quot;, &amp;archive) == B_OK)</a>
<a name="ln1351">		fConsoleOutputView-&gt;LoadSettings(archive);</a>
<a name="ln1352"> </a>
<a name="ln1353">	fUiSettings = *settings;</a>
<a name="ln1354">}</a>
<a name="ln1355"> </a>
<a name="ln1356"> </a>
<a name="ln1357">void</a>
<a name="ln1358">TeamWindow::_UpdateTitle()</a>
<a name="ln1359">{</a>
<a name="ln1360">	AutoLocker&lt; ::Team&gt; lock(fTeam);</a>
<a name="ln1361">	BString name = fTeam-&gt;Name();</a>
<a name="ln1362">	if (fTeam-&gt;ID() &gt;= 0)</a>
<a name="ln1363">		name &lt;&lt; &quot; (&quot; &lt;&lt; fTeam-&gt;ID() &lt;&lt; &quot;)&quot;;</a>
<a name="ln1364">	SetTitle(name.String());</a>
<a name="ln1365">}</a>
<a name="ln1366"> </a>
<a name="ln1367"> </a>
<a name="ln1368">void</a>
<a name="ln1369">TeamWindow::_SetActiveThread(::Thread* thread)</a>
<a name="ln1370">{</a>
<a name="ln1371">	if (thread == fActiveThread)</a>
<a name="ln1372">		return;</a>
<a name="ln1373"> </a>
<a name="ln1374">	if (fActiveThread != NULL)</a>
<a name="ln1375">		fActiveThread-&gt;ReleaseReference();</a>
<a name="ln1376"> </a>
<a name="ln1377">	fActiveThread = thread;</a>
<a name="ln1378"> </a>
<a name="ln1379">	if (fActiveThread != NULL)</a>
<a name="ln1380">		fActiveThread-&gt;AcquireReference();</a>
<a name="ln1381"> </a>
<a name="ln1382">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1383">	_UpdateRunButtons();</a>
<a name="ln1384"> </a>
<a name="ln1385">	StackTrace* stackTrace = fActiveThread != NULL</a>
<a name="ln1386">		? fActiveThread-&gt;GetStackTrace() : NULL;</a>
<a name="ln1387">	BReference&lt;StackTrace&gt; stackTraceReference(stackTrace);</a>
<a name="ln1388">		// hold a reference until we've set it</a>
<a name="ln1389"> </a>
<a name="ln1390">	locker.Unlock();</a>
<a name="ln1391"> </a>
<a name="ln1392">	fThreadListView-&gt;SetThread(fActiveThread);</a>
<a name="ln1393"> </a>
<a name="ln1394">	_SetActiveStackTrace(stackTrace);</a>
<a name="ln1395">	_UpdateCpuState();</a>
<a name="ln1396">}</a>
<a name="ln1397"> </a>
<a name="ln1398"> </a>
<a name="ln1399">void</a>
<a name="ln1400">TeamWindow::_SetActiveImage(Image* image)</a>
<a name="ln1401">{</a>
<a name="ln1402">	if (image == fActiveImage)</a>
<a name="ln1403">		return;</a>
<a name="ln1404"> </a>
<a name="ln1405">	if (fActiveImage != NULL)</a>
<a name="ln1406">		fActiveImage-&gt;ReleaseReference();</a>
<a name="ln1407"> </a>
<a name="ln1408">	fActiveImage = image;</a>
<a name="ln1409"> </a>
<a name="ln1410">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1411"> </a>
<a name="ln1412">	ImageDebugInfo* imageDebugInfo = NULL;</a>
<a name="ln1413">	BReference&lt;ImageDebugInfo&gt; imageDebugInfoReference;</a>
<a name="ln1414"> </a>
<a name="ln1415">	if (fActiveImage != NULL) {</a>
<a name="ln1416">		fActiveImage-&gt;AcquireReference();</a>
<a name="ln1417"> </a>
<a name="ln1418">		imageDebugInfo = fActiveImage-&gt;GetImageDebugInfo();</a>
<a name="ln1419">		imageDebugInfoReference.SetTo(imageDebugInfo);</a>
<a name="ln1420"> </a>
<a name="ln1421">		// If the debug info is not loaded yet, request it.</a>
<a name="ln1422">		if (fActiveImage-&gt;ImageDebugInfoState() == IMAGE_DEBUG_INFO_NOT_LOADED)</a>
<a name="ln1423">			fListener-&gt;ImageDebugInfoRequested(fActiveImage);</a>
<a name="ln1424">	}</a>
<a name="ln1425"> </a>
<a name="ln1426">	locker.Unlock();</a>
<a name="ln1427"> </a>
<a name="ln1428">	fImageListView-&gt;SetImage(fActiveImage);</a>
<a name="ln1429">	fImageFunctionsView-&gt;SetImageDebugInfo(imageDebugInfo);</a>
<a name="ln1430">}</a>
<a name="ln1431"> </a>
<a name="ln1432"> </a>
<a name="ln1433">void</a>
<a name="ln1434">TeamWindow::_SetActiveStackTrace(StackTrace* stackTrace)</a>
<a name="ln1435">{</a>
<a name="ln1436">	delete fTraceUpdateRunner;</a>
<a name="ln1437">	fTraceUpdateRunner = NULL;</a>
<a name="ln1438"> </a>
<a name="ln1439">	if (stackTrace == fActiveStackTrace)</a>
<a name="ln1440">		return;</a>
<a name="ln1441"> </a>
<a name="ln1442">	if (fActiveStackTrace != NULL)</a>
<a name="ln1443">		fActiveStackTrace-&gt;ReleaseReference();</a>
<a name="ln1444"> </a>
<a name="ln1445">	fActiveStackTrace = stackTrace;</a>
<a name="ln1446"> </a>
<a name="ln1447">	if (fActiveStackTrace != NULL)</a>
<a name="ln1448">		fActiveStackTrace-&gt;AcquireReference();</a>
<a name="ln1449"> </a>
<a name="ln1450">	fStackTraceView-&gt;SetStackTrace(fActiveStackTrace);</a>
<a name="ln1451">	fSourceView-&gt;SetStackTrace(fActiveStackTrace, fActiveThread);</a>
<a name="ln1452"> </a>
<a name="ln1453">	StackFrame* frame = NULL;</a>
<a name="ln1454">	if (fActiveStackTrace != NULL) {</a>
<a name="ln1455">		ThreadStackFrameSelectionEntry* entry</a>
<a name="ln1456">			= fThreadSelectionInfoTable-&gt;Lookup(fActiveThread);</a>
<a name="ln1457">		if (entry != NULL)</a>
<a name="ln1458">			frame = entry-&gt;SelectedFrame();</a>
<a name="ln1459">		else</a>
<a name="ln1460">			frame = fActiveStackTrace-&gt;FrameAt(0);</a>
<a name="ln1461">	}</a>
<a name="ln1462"> </a>
<a name="ln1463">	_SetActiveStackFrame(frame);</a>
<a name="ln1464">}</a>
<a name="ln1465"> </a>
<a name="ln1466"> </a>
<a name="ln1467">void</a>
<a name="ln1468">TeamWindow::_SetActiveStackFrame(StackFrame* frame)</a>
<a name="ln1469">{</a>
<a name="ln1470">	if (frame == fActiveStackFrame)</a>
<a name="ln1471">		return;</a>
<a name="ln1472"> </a>
<a name="ln1473">	if (fActiveStackFrame != NULL) {</a>
<a name="ln1474">		AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1475">		fActiveStackFrame-&gt;RemoveListener(this);</a>
<a name="ln1476">		locker.Unlock();</a>
<a name="ln1477"> </a>
<a name="ln1478">		fActiveStackFrame-&gt;ReleaseReference();</a>
<a name="ln1479">	}</a>
<a name="ln1480"> </a>
<a name="ln1481">	fActiveStackFrame = frame;</a>
<a name="ln1482"> </a>
<a name="ln1483">	if (fActiveStackFrame != NULL) {</a>
<a name="ln1484">		fActiveStackFrame-&gt;AcquireReference();</a>
<a name="ln1485"> </a>
<a name="ln1486">		AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1487">		fActiveStackFrame-&gt;AddListener(this);</a>
<a name="ln1488">		locker.Unlock();</a>
<a name="ln1489"> </a>
<a name="ln1490">		fActiveSourceObject = ACTIVE_SOURCE_STACK_FRAME;</a>
<a name="ln1491"> </a>
<a name="ln1492">		ThreadStackFrameSelectionEntry* entry</a>
<a name="ln1493">			= fThreadSelectionInfoTable-&gt;Lookup(fActiveThread);</a>
<a name="ln1494">		if (entry == NULL) {</a>
<a name="ln1495">			entry = new(std::nothrow) ThreadStackFrameSelectionEntry(</a>
<a name="ln1496">				fActiveThread, fActiveStackFrame);</a>
<a name="ln1497">			if (entry == NULL)</a>
<a name="ln1498">				return;</a>
<a name="ln1499"> </a>
<a name="ln1500">			ObjectDeleter&lt;ThreadStackFrameSelectionEntry&gt; entryDeleter(entry);</a>
<a name="ln1501">			if (fThreadSelectionInfoTable-&gt;Insert(entry) == B_OK)</a>
<a name="ln1502">				entryDeleter.Detach();</a>
<a name="ln1503">		} else</a>
<a name="ln1504">			entry-&gt;SetSelectedFrame(fActiveStackFrame);</a>
<a name="ln1505"> </a>
<a name="ln1506">		_SetActiveFunction(fActiveStackFrame-&gt;Function(), false);</a>
<a name="ln1507">	}</a>
<a name="ln1508"> </a>
<a name="ln1509">	_UpdateCpuState();</a>
<a name="ln1510"> </a>
<a name="ln1511">	fStackTraceView-&gt;SetStackFrame(fActiveStackFrame);</a>
<a name="ln1512">	if (fActiveStackFrame != NULL)</a>
<a name="ln1513">		fVariablesView-&gt;SetStackFrame(fActiveThread, fActiveStackFrame);</a>
<a name="ln1514">	else</a>
<a name="ln1515">		fVariablesView-&gt;SetStackFrame(NULL, NULL);</a>
<a name="ln1516">	fSourceView-&gt;SetStackFrame(fActiveStackFrame);</a>
<a name="ln1517">}</a>
<a name="ln1518"> </a>
<a name="ln1519"> </a>
<a name="ln1520">void</a>
<a name="ln1521">TeamWindow::_SetActiveBreakpoint(UserBreakpoint* breakpoint)</a>
<a name="ln1522">{</a>
<a name="ln1523">	if (breakpoint == fActiveBreakpoint)</a>
<a name="ln1524">		return;</a>
<a name="ln1525"> </a>
<a name="ln1526">	if (fActiveBreakpoint != NULL)</a>
<a name="ln1527">		fActiveBreakpoint-&gt;ReleaseReference();</a>
<a name="ln1528"> </a>
<a name="ln1529">	fActiveBreakpoint = breakpoint;</a>
<a name="ln1530"> </a>
<a name="ln1531">	if (fActiveBreakpoint != NULL) {</a>
<a name="ln1532">		fActiveBreakpoint-&gt;AcquireReference();</a>
<a name="ln1533"> </a>
<a name="ln1534">		// get the breakpoint's function (more exactly: some function instance)</a>
<a name="ln1535">		AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1536"> </a>
<a name="ln1537">		Function* function = fTeam-&gt;FunctionByID(</a>
<a name="ln1538">			breakpoint-&gt;Location().GetFunctionID());</a>
<a name="ln1539">		FunctionInstance* functionInstance = function != NULL</a>
<a name="ln1540">			? function-&gt;FirstInstance() : NULL;</a>
<a name="ln1541">		BReference&lt;FunctionInstance&gt; functionInstanceReference(</a>
<a name="ln1542">			functionInstance);</a>
<a name="ln1543"> </a>
<a name="ln1544">		locker.Unlock();</a>
<a name="ln1545"> </a>
<a name="ln1546">		fActiveSourceObject = ACTIVE_SOURCE_BREAKPOINT;</a>
<a name="ln1547"> </a>
<a name="ln1548">		_SetActiveFunction(functionInstance);</a>
<a name="ln1549"> </a>
<a name="ln1550">		// scroll to the breakpoint's source code line number (it is not done</a>
<a name="ln1551">		// automatically, if the active function remains the same)</a>
<a name="ln1552">		_ScrollToActiveFunction();</a>
<a name="ln1553">	}</a>
<a name="ln1554">}</a>
<a name="ln1555"> </a>
<a name="ln1556"> </a>
<a name="ln1557">void</a>
<a name="ln1558">TeamWindow::_SetActiveFunction(FunctionInstance* functionInstance,</a>
<a name="ln1559">	bool searchForFrame)</a>
<a name="ln1560">{</a>
<a name="ln1561">	if (functionInstance == fActiveFunction)</a>
<a name="ln1562">		return;</a>
<a name="ln1563"> </a>
<a name="ln1564">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1565"> </a>
<a name="ln1566">	if (fActiveFunction != NULL) {</a>
<a name="ln1567">		fActiveFunction-&gt;GetFunction()-&gt;RemoveListener(this);</a>
<a name="ln1568">		fActiveFunction-&gt;ReleaseReference();</a>
<a name="ln1569">	}</a>
<a name="ln1570"> </a>
<a name="ln1571">	// to avoid listener feedback problems, first unset the active function and</a>
<a name="ln1572">	// set the new image, if any</a>
<a name="ln1573">	locker.Unlock();</a>
<a name="ln1574"> </a>
<a name="ln1575">	fActiveFunction = NULL;</a>
<a name="ln1576"> </a>
<a name="ln1577">	if (functionInstance != NULL)</a>
<a name="ln1578">		_SetActiveImage(fTeam-&gt;ImageByAddress(functionInstance-&gt;Address()));</a>
<a name="ln1579"> </a>
<a name="ln1580">	fActiveFunction = functionInstance;</a>
<a name="ln1581"> </a>
<a name="ln1582">	locker.Lock();</a>
<a name="ln1583"> </a>
<a name="ln1584">	SourceCode* sourceCode = NULL;</a>
<a name="ln1585">	BReference&lt;SourceCode&gt; sourceCodeReference;</a>
<a name="ln1586"> </a>
<a name="ln1587">	if (fActiveFunction != NULL) {</a>
<a name="ln1588">		fActiveFunction-&gt;AcquireReference();</a>
<a name="ln1589">		fActiveFunction-&gt;GetFunction()-&gt;AddListener(this);</a>
<a name="ln1590"> </a>
<a name="ln1591">		Function* function = fActiveFunction-&gt;GetFunction();</a>
<a name="ln1592">		sourceCode = function-&gt;GetSourceCode();</a>
<a name="ln1593">		if (sourceCode == NULL)</a>
<a name="ln1594">			sourceCode = fActiveFunction-&gt;GetSourceCode();</a>
<a name="ln1595">		sourceCodeReference.SetTo(sourceCode);</a>
<a name="ln1596"> </a>
<a name="ln1597">		// If the source code is not loaded yet, request it.</a>
<a name="ln1598">		if (function-&gt;SourceCodeState() == FUNCTION_SOURCE_NOT_LOADED)</a>
<a name="ln1599">			fListener-&gt;FunctionSourceCodeRequested(fActiveFunction);</a>
<a name="ln1600">	}</a>
<a name="ln1601"> </a>
<a name="ln1602">	locker.Unlock();</a>
<a name="ln1603"> </a>
<a name="ln1604">	_SetActiveSourceCode(sourceCode);</a>
<a name="ln1605"> </a>
<a name="ln1606">	fImageFunctionsView-&gt;SetFunction(fActiveFunction);</a>
<a name="ln1607"> </a>
<a name="ln1608">	locker.Lock();</a>
<a name="ln1609"> </a>
<a name="ln1610">	if (!searchForFrame || fActiveStackTrace == NULL)</a>
<a name="ln1611">		return;</a>
<a name="ln1612"> </a>
<a name="ln1613">	// look if our current stack trace has a frame matching the selected</a>
<a name="ln1614">	// function. If so, set it to match.</a>
<a name="ln1615">	StackFrame* matchingFrame = NULL;</a>
<a name="ln1616">	BReference&lt;StackFrame&gt; frameRef;</a>
<a name="ln1617"> </a>
<a name="ln1618">	for (int32 i = 0; i &lt; fActiveStackTrace-&gt;CountFrames(); i++) {</a>
<a name="ln1619">		StackFrame* frame = fActiveStackTrace-&gt;FrameAt(i);</a>
<a name="ln1620">		if (frame-&gt;Function() == fActiveFunction) {</a>
<a name="ln1621">			matchingFrame = frame;</a>
<a name="ln1622">			frameRef.SetTo(frame);</a>
<a name="ln1623">			break;</a>
<a name="ln1624">		}</a>
<a name="ln1625">	}</a>
<a name="ln1626"> </a>
<a name="ln1627">	locker.Unlock();</a>
<a name="ln1628"> </a>
<a name="ln1629">	if (matchingFrame != NULL)</a>
<a name="ln1630">		_SetActiveStackFrame(matchingFrame);</a>
<a name="ln1631">}</a>
<a name="ln1632"> </a>
<a name="ln1633"> </a>
<a name="ln1634">void</a>
<a name="ln1635">TeamWindow::_SetActiveSourceCode(SourceCode* sourceCode)</a>
<a name="ln1636">{</a>
<a name="ln1637">	if (sourceCode == fActiveSourceCode) {</a>
<a name="ln1638">		_ScrollToActiveFunction();</a>
<a name="ln1639">		return;</a>
<a name="ln1640">	}</a>
<a name="ln1641"> </a>
<a name="ln1642">	if (fActiveSourceCode != NULL)</a>
<a name="ln1643">		fActiveSourceCode-&gt;ReleaseReference();</a>
<a name="ln1644"> </a>
<a name="ln1645">	fActiveSourceCode = sourceCode;</a>
<a name="ln1646"> </a>
<a name="ln1647">	if (fActiveSourceCode != NULL)</a>
<a name="ln1648">		fActiveSourceCode-&gt;AcquireReference();</a>
<a name="ln1649"> </a>
<a name="ln1650">	fSourceView-&gt;SetSourceCode(fActiveSourceCode);</a>
<a name="ln1651"> </a>
<a name="ln1652">	_UpdateSourcePathState();</a>
<a name="ln1653">	_ScrollToActiveFunction();</a>
<a name="ln1654">}</a>
<a name="ln1655"> </a>
<a name="ln1656">void</a>
<a name="ln1657">TeamWindow::_UpdateCpuState()</a>
<a name="ln1658">{</a>
<a name="ln1659">	// get the CPU state</a>
<a name="ln1660">	CpuState* cpuState = NULL;</a>
<a name="ln1661">	BReference&lt;CpuState&gt; cpuStateReference;</a>
<a name="ln1662">		// hold a reference until the register view has one</a>
<a name="ln1663"> </a>
<a name="ln1664">	if (fActiveThread != NULL) {</a>
<a name="ln1665">		// Get the CPU state from the active stack frame or the thread directly.</a>
<a name="ln1666">		if (fActiveStackFrame == NULL) {</a>
<a name="ln1667">			AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1668">			cpuState = fActiveThread-&gt;GetCpuState();</a>
<a name="ln1669">			cpuStateReference.SetTo(cpuState);</a>
<a name="ln1670">			locker.Unlock();</a>
<a name="ln1671">		} else</a>
<a name="ln1672">			cpuState = fActiveStackFrame-&gt;GetCpuState();</a>
<a name="ln1673">	}</a>
<a name="ln1674"> </a>
<a name="ln1675">	fRegistersView-&gt;SetCpuState(cpuState);</a>
<a name="ln1676">}</a>
<a name="ln1677"> </a>
<a name="ln1678"> </a>
<a name="ln1679">void</a>
<a name="ln1680">TeamWindow::_UpdateRunButtons()</a>
<a name="ln1681">{</a>
<a name="ln1682">	uint32 threadState = fActiveThread != NULL</a>
<a name="ln1683">		? fActiveThread-&gt;State() : THREAD_STATE_UNKNOWN;</a>
<a name="ln1684"> </a>
<a name="ln1685">	switch (threadState) {</a>
<a name="ln1686">		case THREAD_STATE_UNKNOWN:</a>
<a name="ln1687">			fRunButton-&gt;SetEnabled(false);</a>
<a name="ln1688">			fStepOverButton-&gt;SetEnabled(false);</a>
<a name="ln1689">			fStepIntoButton-&gt;SetEnabled(false);</a>
<a name="ln1690">			fStepOutButton-&gt;SetEnabled(false);</a>
<a name="ln1691">			break;</a>
<a name="ln1692">		case THREAD_STATE_RUNNING:</a>
<a name="ln1693">			if (fTraceUpdateRunner == NULL) {</a>
<a name="ln1694">				fRunButton-&gt;SetLabel(&quot;Debug&quot;);</a>
<a name="ln1695">				fRunButton-&gt;SetMessage(new BMessage(MSG_THREAD_STOP));</a>
<a name="ln1696">				fRunButton-&gt;SetEnabled(true);</a>
<a name="ln1697">				fStepOverButton-&gt;SetEnabled(false);</a>
<a name="ln1698">				fStepIntoButton-&gt;SetEnabled(false);</a>
<a name="ln1699">				fStepOutButton-&gt;SetEnabled(false);</a>
<a name="ln1700">			}</a>
<a name="ln1701">			break;</a>
<a name="ln1702">		case THREAD_STATE_STOPPED:</a>
<a name="ln1703">			fRunButton-&gt;SetLabel(&quot;Run&quot;);</a>
<a name="ln1704">			fRunButton-&gt;SetMessage(new BMessage(MSG_THREAD_RUN));</a>
<a name="ln1705">			fRunButton-&gt;SetEnabled(true);</a>
<a name="ln1706">			fStepOverButton-&gt;SetEnabled(true);</a>
<a name="ln1707">			fStepIntoButton-&gt;SetEnabled(true);</a>
<a name="ln1708">			fStepOutButton-&gt;SetEnabled(true);</a>
<a name="ln1709">			break;</a>
<a name="ln1710">	}</a>
<a name="ln1711">}</a>
<a name="ln1712"> </a>
<a name="ln1713"> </a>
<a name="ln1714">void</a>
<a name="ln1715">TeamWindow::_UpdateSourcePathState()</a>
<a name="ln1716">{</a>
<a name="ln1717">	LocatableFile* sourceFile = NULL;</a>
<a name="ln1718">	BString sourceText = &quot;Source file unavailable.&quot;;</a>
<a name="ln1719">	BString truncatedText;</a>
<a name="ln1720"> </a>
<a name="ln1721">	if (fActiveSourceCode != NULL) {</a>
<a name="ln1722">		sourceFile = fActiveFunction-&gt;GetFunctionDebugInfo()-&gt;SourceFile();</a>
<a name="ln1723"> </a>
<a name="ln1724">		if (sourceFile != NULL &amp;&amp; !sourceFile-&gt;GetLocatedPath(sourceText))</a>
<a name="ln1725">			sourceFile-&gt;GetPath(sourceText);</a>
<a name="ln1726"> </a>
<a name="ln1727">		function_source_state state = fActiveFunction-&gt;GetFunction()</a>
<a name="ln1728">			-&gt;SourceCodeState();</a>
<a name="ln1729">		if (state == FUNCTION_SOURCE_SUPPRESSED)</a>
<a name="ln1730">			sourceText.Prepend(&quot;Disassembly for: &quot;);</a>
<a name="ln1731">		else if (state != FUNCTION_SOURCE_NOT_LOADED</a>
<a name="ln1732">			&amp;&amp; fActiveSourceCode-&gt;GetSourceFile() == NULL</a>
<a name="ln1733">			&amp;&amp; sourceFile != NULL) {</a>
<a name="ln1734">			sourceText.Prepend(&quot;Click to locate source file '&quot;);</a>
<a name="ln1735">			sourceText += &quot;'&quot;;</a>
<a name="ln1736">			truncatedText = sourceText;</a>
<a name="ln1737">			fSourcePathView-&gt;TruncateString(&amp;truncatedText, B_TRUNCATE_MIDDLE,</a>
<a name="ln1738">				fSourcePathView-&gt;Bounds().Width());</a>
<a name="ln1739">		} else if (sourceFile != NULL)</a>
<a name="ln1740">			sourceText.Prepend(&quot;File: &quot;);</a>
<a name="ln1741">	}</a>
<a name="ln1742"> </a>
<a name="ln1743">	if (!truncatedText.IsEmpty() &amp;&amp; truncatedText != sourceText) {</a>
<a name="ln1744">		fSourcePathView-&gt;SetToolTip(sourceText);</a>
<a name="ln1745">		fSourcePathView-&gt;SetText(truncatedText);</a>
<a name="ln1746">	} else {</a>
<a name="ln1747">		fSourcePathView-&gt;SetText(sourceText);</a>
<a name="ln1748">		fSourcePathView-&gt;SetToolTip((const char*)NULL);</a>
<a name="ln1749">	}</a>
<a name="ln1750">}</a>
<a name="ln1751"> </a>
<a name="ln1752"> </a>
<a name="ln1753">void</a>
<a name="ln1754">TeamWindow::_ScrollToActiveFunction()</a>
<a name="ln1755">{</a>
<a name="ln1756">	// Scroll to the active function, if it has been selected manually.</a>
<a name="ln1757">	if (fActiveFunction == NULL || fActiveSourceCode == NULL)</a>
<a name="ln1758">		return;</a>
<a name="ln1759"> </a>
<a name="ln1760">	switch (fActiveSourceObject) {</a>
<a name="ln1761">		case ACTIVE_SOURCE_FUNCTION:</a>
<a name="ln1762">			fSourceView-&gt;ScrollToAddress(fActiveFunction-&gt;Address());</a>
<a name="ln1763">			break;</a>
<a name="ln1764">		case ACTIVE_SOURCE_BREAKPOINT:</a>
<a name="ln1765">		{</a>
<a name="ln1766">			if (fActiveBreakpoint == NULL)</a>
<a name="ln1767">				break;</a>
<a name="ln1768"> </a>
<a name="ln1769">			const UserBreakpointLocation&amp; location</a>
<a name="ln1770">				= fActiveBreakpoint-&gt;Location();</a>
<a name="ln1771">			int32 line = location.GetSourceLocation().Line();</a>
<a name="ln1772"> </a>
<a name="ln1773">			if (location.SourceFile() != NULL &amp;&amp; line &gt;= 0</a>
<a name="ln1774">				&amp;&amp; fActiveSourceCode-&gt;GetSourceFile()</a>
<a name="ln1775">					== location.SourceFile()) {</a>
<a name="ln1776">				fSourceView-&gt;ScrollToLine(line);</a>
<a name="ln1777">			} else {</a>
<a name="ln1778">				fSourceView-&gt;ScrollToAddress(</a>
<a name="ln1779">					fActiveFunction-&gt;Address()</a>
<a name="ln1780">						+ location.RelativeAddress());</a>
<a name="ln1781">			}</a>
<a name="ln1782">			break;</a>
<a name="ln1783">		}</a>
<a name="ln1784">		case ACTIVE_SOURCE_NONE:</a>
<a name="ln1785">		case ACTIVE_SOURCE_STACK_FRAME:</a>
<a name="ln1786">			break;</a>
<a name="ln1787">	}</a>
<a name="ln1788">}</a>
<a name="ln1789"> </a>
<a name="ln1790"> </a>
<a name="ln1791">void</a>
<a name="ln1792">TeamWindow::_HandleThreadStateChanged(thread_id threadID)</a>
<a name="ln1793">{</a>
<a name="ln1794">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1795"> </a>
<a name="ln1796">	::Thread* thread = fTeam-&gt;ThreadByID(threadID);</a>
<a name="ln1797">	if (thread == NULL)</a>
<a name="ln1798">		return;</a>
<a name="ln1799"> </a>
<a name="ln1800">	if (thread-&gt;State() != THREAD_STATE_STOPPED) {</a>
<a name="ln1801">		ThreadStackFrameSelectionEntry* entry</a>
<a name="ln1802">			= fThreadSelectionInfoTable-&gt;Lookup(thread);</a>
<a name="ln1803">		if (entry != NULL) {</a>
<a name="ln1804">			fThreadSelectionInfoTable-&gt;Remove(entry);</a>
<a name="ln1805">			delete entry;</a>
<a name="ln1806">		}</a>
<a name="ln1807">	}</a>
<a name="ln1808"> </a>
<a name="ln1809">	// If the thread has been stopped and we don't have an active thread yet</a>
<a name="ln1810">	// (or it isn't stopped), switch to this thread. Otherwise ignore the event.</a>
<a name="ln1811">	if (thread-&gt;State() == THREAD_STATE_STOPPED</a>
<a name="ln1812">		&amp;&amp; (fActiveThread == NULL</a>
<a name="ln1813">			|| (thread != fActiveThread</a>
<a name="ln1814">				&amp;&amp; fActiveThread-&gt;State() != THREAD_STATE_STOPPED))) {</a>
<a name="ln1815">		_SetActiveThread(thread);</a>
<a name="ln1816">	} else if (thread != fActiveThread) {</a>
<a name="ln1817">		// otherwise ignore the event, if the thread is not the active one</a>
<a name="ln1818">		return;</a>
<a name="ln1819">	}</a>
<a name="ln1820"> </a>
<a name="ln1821">	// Switch to the threads tab view when the thread has stopped.</a>
<a name="ln1822">	if (thread-&gt;State() == THREAD_STATE_STOPPED) {</a>
<a name="ln1823">		fTabView-&gt;Select(MAIN_TAB_INDEX_THREADS);</a>
<a name="ln1824"> </a>
<a name="ln1825">		// if we hit a breakpoint or exception, raise the window to the</a>
<a name="ln1826">		// foreground, since if this occurs while e.g. debugging a GUI</a>
<a name="ln1827">		// app, it might not be immediately obvious that such an event</a>
<a name="ln1828">		// occurred as the app may simply appear to hang.</a>
<a name="ln1829">		Activate();</a>
<a name="ln1830">	}</a>
<a name="ln1831"> </a>
<a name="ln1832">	_UpdateRunButtons();</a>
<a name="ln1833">}</a>
<a name="ln1834"> </a>
<a name="ln1835"> </a>
<a name="ln1836">void</a>
<a name="ln1837">TeamWindow::_HandleCpuStateChanged(thread_id threadID)</a>
<a name="ln1838">{</a>
<a name="ln1839">	// We're only interested in the currently selected thread</a>
<a name="ln1840">	if (fActiveThread == NULL || threadID != fActiveThread-&gt;ID())</a>
<a name="ln1841">		return;</a>
<a name="ln1842"> </a>
<a name="ln1843">	_UpdateCpuState();</a>
<a name="ln1844">}</a>
<a name="ln1845"> </a>
<a name="ln1846"> </a>
<a name="ln1847">void</a>
<a name="ln1848">TeamWindow::_HandleStackTraceChanged(thread_id threadID)</a>
<a name="ln1849">{</a>
<a name="ln1850">	// We're only interested in the currently selected thread</a>
<a name="ln1851">	if (fActiveThread == NULL || threadID != fActiveThread-&gt;ID())</a>
<a name="ln1852">		return;</a>
<a name="ln1853"> </a>
<a name="ln1854">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1855"> </a>
<a name="ln1856">	StackTrace* stackTrace = fActiveThread != NULL</a>
<a name="ln1857">		? fActiveThread-&gt;GetStackTrace() : NULL;</a>
<a name="ln1858">	BReference&lt;StackTrace&gt; stackTraceReference(stackTrace);</a>
<a name="ln1859">		// hold a reference until the register view has one</a>
<a name="ln1860"> </a>
<a name="ln1861">	locker.Unlock();</a>
<a name="ln1862"> </a>
<a name="ln1863">	if (stackTrace == NULL) {</a>
<a name="ln1864">		if (fTraceUpdateRunner != NULL)</a>
<a name="ln1865">			return;</a>
<a name="ln1866"> </a>
<a name="ln1867">		BMessage message(MSG_CLEAR_STACK_TRACE);</a>
<a name="ln1868">		fTraceUpdateRunner = new(std::nothrow) BMessageRunner(this,</a>
<a name="ln1869">			message, 250000, 1);</a>
<a name="ln1870">		if (fTraceUpdateRunner != NULL</a>
<a name="ln1871">			&amp;&amp; fTraceUpdateRunner-&gt;InitCheck() == B_OK) {</a>
<a name="ln1872">			fStackTraceView-&gt;SetStackTraceClearPending();</a>
<a name="ln1873">			fVariablesView-&gt;SetStackFrameClearPending();</a>
<a name="ln1874">			return;</a>
<a name="ln1875">		}</a>
<a name="ln1876">	}</a>
<a name="ln1877"> </a>
<a name="ln1878">	_SetActiveStackTrace(stackTrace);</a>
<a name="ln1879">}</a>
<a name="ln1880"> </a>
<a name="ln1881"> </a>
<a name="ln1882">void</a>
<a name="ln1883">TeamWindow::_HandleImageDebugInfoChanged(image_id imageID)</a>
<a name="ln1884">{</a>
<a name="ln1885">	TRACE_GUI(&quot;TeamWindow::_HandleImageDebugInfoChanged(%&quot; B_PRId32 &quot;)\n&quot;,</a>
<a name="ln1886">		imageID);</a>
<a name="ln1887"> </a>
<a name="ln1888">	// We're only interested in the currently selected thread</a>
<a name="ln1889">	if (fActiveImage == NULL || imageID != fActiveImage-&gt;ID())</a>
<a name="ln1890">		return;</a>
<a name="ln1891"> </a>
<a name="ln1892">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1893"> </a>
<a name="ln1894">	ImageDebugInfo* imageDebugInfo = fActiveImage != NULL</a>
<a name="ln1895">		? fActiveImage-&gt;GetImageDebugInfo() : NULL;</a>
<a name="ln1896"> </a>
<a name="ln1897">	TRACE_GUI(&quot;  image debug info: %p\n&quot;, imageDebugInfo);</a>
<a name="ln1898"> </a>
<a name="ln1899">	BReference&lt;ImageDebugInfo&gt; imageDebugInfoReference(imageDebugInfo);</a>
<a name="ln1900">		// hold a reference until we've set it</a>
<a name="ln1901"> </a>
<a name="ln1902">	locker.Unlock();</a>
<a name="ln1903"> </a>
<a name="ln1904">	fImageFunctionsView-&gt;SetImageDebugInfo(imageDebugInfo);</a>
<a name="ln1905">}</a>
<a name="ln1906"> </a>
<a name="ln1907"> </a>
<a name="ln1908">void</a>
<a name="ln1909">TeamWindow::_HandleSourceCodeChanged()</a>
<a name="ln1910">{</a>
<a name="ln1911">	// If we don't have an active function anymore, the message is obsolete.</a>
<a name="ln1912">	if (fActiveFunction == NULL)</a>
<a name="ln1913">		return;</a>
<a name="ln1914"> </a>
<a name="ln1915">	// get a reference to the source code</a>
<a name="ln1916">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln1917"> </a>
<a name="ln1918">	SourceCode* sourceCode = NULL;</a>
<a name="ln1919">	if (fActiveFunction-&gt;GetFunction()-&gt;SourceCodeState()</a>
<a name="ln1920">		== FUNCTION_SOURCE_LOADED) {</a>
<a name="ln1921">		sourceCode = fActiveFunction-&gt;GetFunction()-&gt;GetSourceCode();</a>
<a name="ln1922">	} else</a>
<a name="ln1923">		sourceCode = fActiveFunction-&gt;GetSourceCode();</a>
<a name="ln1924"> </a>
<a name="ln1925">	BReference&lt;SourceCode&gt; sourceCodeReference(sourceCode);</a>
<a name="ln1926"> </a>
<a name="ln1927">	locker.Unlock();</a>
<a name="ln1928"> </a>
<a name="ln1929">	_SetActiveSourceCode(sourceCode);</a>
<a name="ln1930">}</a>
<a name="ln1931"> </a>
<a name="ln1932"> </a>
<a name="ln1933">void</a>
<a name="ln1934">TeamWindow::_HandleUserBreakpointChanged(UserBreakpoint* breakpoint)</a>
<a name="ln1935">{</a>
<a name="ln1936">	fSourceView-&gt;UserBreakpointChanged(breakpoint);</a>
<a name="ln1937">	fBreakpointsView-&gt;UserBreakpointChanged(breakpoint);</a>
<a name="ln1938">}</a>
<a name="ln1939"> </a>
<a name="ln1940"> </a>
<a name="ln1941">void</a>
<a name="ln1942">TeamWindow::_HandleWatchpointChanged(Watchpoint* watchpoint)</a>
<a name="ln1943">{</a>
<a name="ln1944">	fBreakpointsView-&gt;WatchpointChanged(watchpoint);</a>
<a name="ln1945">}</a>
<a name="ln1946"> </a>
<a name="ln1947"> </a>
<a name="ln1948">status_t</a>
<a name="ln1949">TeamWindow::_RetrieveMatchingSourceWorker(void* arg)</a>
<a name="ln1950">{</a>
<a name="ln1951">	TeamWindow* window = (TeamWindow*)arg;</a>
<a name="ln1952"> </a>
<a name="ln1953">	BStringList* entries = new(std::nothrow) BStringList();</a>
<a name="ln1954">	if (entries == NULL)</a>
<a name="ln1955">		return B_NO_MEMORY;</a>
<a name="ln1956">	ObjectDeleter&lt;BStringList&gt; stringListDeleter(entries);</a>
<a name="ln1957"> </a>
<a name="ln1958">	if (!window-&gt;Lock())</a>
<a name="ln1959">		return B_BAD_VALUE;</a>
<a name="ln1960"> </a>
<a name="ln1961">	BString path;</a>
<a name="ln1962">	window-&gt;fActiveFunction-&gt;GetFunctionDebugInfo()-&gt;SourceFile()</a>
<a name="ln1963">		-&gt;GetPath(path);</a>
<a name="ln1964">	window-&gt;Unlock();</a>
<a name="ln1965"> </a>
<a name="ln1966">	status_t error = window-&gt;_RetrieveMatchingSourceEntries(path, entries);</a>
<a name="ln1967"> </a>
<a name="ln1968">	entries-&gt;Sort();</a>
<a name="ln1969">	BMessenger messenger(window);</a>
<a name="ln1970">	if (messenger.IsValid() &amp;&amp; messenger.LockTarget()) {</a>
<a name="ln1971">		if (window-&gt;fActiveSourceWorker == find_thread(NULL)) {</a>
<a name="ln1972">			BMessage message(MSG_SOURCE_ENTRY_QUERY_COMPLETE);</a>
<a name="ln1973">			message.AddInt32(&quot;error&quot;, error);</a>
<a name="ln1974">			message.AddPointer(&quot;entries&quot;, entries);</a>
<a name="ln1975">			if (messenger.SendMessage(&amp;message) == B_OK)</a>
<a name="ln1976">				stringListDeleter.Detach();</a>
<a name="ln1977">		}</a>
<a name="ln1978">		window-&gt;Unlock();</a>
<a name="ln1979">	}</a>
<a name="ln1980"> </a>
<a name="ln1981">	return B_OK;</a>
<a name="ln1982">}</a>
<a name="ln1983"> </a>
<a name="ln1984"> </a>
<a name="ln1985">void</a>
<a name="ln1986">TeamWindow::_HandleResolveMissingSourceFile(entry_ref&amp; locatedPath)</a>
<a name="ln1987">{</a>
<a name="ln1988">	if (fActiveFunction != NULL) {</a>
<a name="ln1989">		LocatableFile* sourceFile = fActiveFunction-&gt;GetFunctionDebugInfo()</a>
<a name="ln1990">			-&gt;SourceFile();</a>
<a name="ln1991">		if (sourceFile != NULL) {</a>
<a name="ln1992">			BString sourcePath;</a>
<a name="ln1993">			sourceFile-&gt;GetPath(sourcePath);</a>
<a name="ln1994">			BString sourceFileName(sourcePath);</a>
<a name="ln1995">			int32 index = sourcePath.FindLast('/');</a>
<a name="ln1996">			if (index &gt;= 0)</a>
<a name="ln1997">				sourceFileName.Remove(0, index + 1);</a>
<a name="ln1998"> </a>
<a name="ln1999">			BPath targetFilePath(&amp;locatedPath);</a>
<a name="ln2000">			if (targetFilePath.InitCheck() != B_OK)</a>
<a name="ln2001">				return;</a>
<a name="ln2002"> </a>
<a name="ln2003">			if (strcmp(sourceFileName.String(), targetFilePath.Leaf()) != 0) {</a>
<a name="ln2004">				BString message;</a>
<a name="ln2005">				message.SetToFormat(&quot;The names of source file '%s' and located&quot;</a>
<a name="ln2006">					&quot; file '%s' differ. Use file anyway?&quot;,</a>
<a name="ln2007">					sourceFileName.String(), targetFilePath.Leaf());</a>
<a name="ln2008">				BAlert* alert = new(std::nothrow) BAlert(</a>
<a name="ln2009">					&quot;Source path mismatch&quot;, message.String(), &quot;Cancel&quot;, &quot;Use&quot;);</a>
<a name="ln2010">				if (alert == NULL)</a>
<a name="ln2011">					return;</a>
<a name="ln2012"> </a>
<a name="ln2013">				int32 choice = alert-&gt;Go();</a>
<a name="ln2014">				if (choice &lt;= 0)</a>
<a name="ln2015">					return;</a>
<a name="ln2016">			}</a>
<a name="ln2017"> </a>
<a name="ln2018">			LocatableFile* foundSourceFile = fActiveSourceCode</a>
<a name="ln2019">				-&gt;GetSourceFile();</a>
<a name="ln2020">			if (foundSourceFile != NULL)</a>
<a name="ln2021">				fListener-&gt;SourceEntryInvalidateRequested(foundSourceFile);</a>
<a name="ln2022">			fListener-&gt;SourceEntryLocateRequested(sourcePath,</a>
<a name="ln2023">				targetFilePath.Path());</a>
<a name="ln2024">			fListener-&gt;FunctionSourceCodeRequested(fActiveFunction);</a>
<a name="ln2025">		}</a>
<a name="ln2026">	}</a>
<a name="ln2027">}</a>
<a name="ln2028"> </a>
<a name="ln2029"> </a>
<a name="ln2030">void</a>
<a name="ln2031">TeamWindow::_HandleLocateSourceRequest(BStringList* entries)</a>
<a name="ln2032">{</a>
<a name="ln2033">	if (fActiveFunction == NULL)</a>
<a name="ln2034">		return;</a>
<a name="ln2035">	else if (fActiveFunction-&gt;GetFunctionDebugInfo()-&gt;SourceFile() == NULL)</a>
<a name="ln2036">		return;</a>
<a name="ln2037">	else if (fActiveSourceCode == NULL)</a>
<a name="ln2038">		return;</a>
<a name="ln2039">	else if (fActiveFunction-&gt;GetFunction()-&gt;SourceCodeState()</a>
<a name="ln2040">		== FUNCTION_SOURCE_NOT_LOADED) {</a>
<a name="ln2041">		return;</a>
<a name="ln2042">	}</a>
<a name="ln2043"> </a>
<a name="ln2044">	if (entries == NULL) {</a>
<a name="ln2045">		if (fActiveSourceWorker &lt; 0) {</a>
<a name="ln2046">			fActiveSourceWorker = spawn_thread(&amp;_RetrieveMatchingSourceWorker,</a>
<a name="ln2047">				&quot;source file query worker&quot;, B_NORMAL_PRIORITY, this);</a>
<a name="ln2048">			if (fActiveSourceWorker &gt; 0)</a>
<a name="ln2049">				resume_thread(fActiveSourceWorker);</a>
<a name="ln2050">		}</a>
<a name="ln2051">		return;</a>
<a name="ln2052">	}</a>
<a name="ln2053"> </a>
<a name="ln2054">	int32 count = entries-&gt;CountStrings();</a>
<a name="ln2055">	if (count &gt; 0) {</a>
<a name="ln2056">		BPopUpMenu* menu = new(std::nothrow) BPopUpMenu(&quot;&quot;);</a>
<a name="ln2057">		if (menu == NULL)</a>
<a name="ln2058">			return;</a>
<a name="ln2059"> </a>
<a name="ln2060">		BPrivate::ObjectDeleter&lt;BPopUpMenu&gt; menuDeleter(menu);</a>
<a name="ln2061">		BMenuItem* item = NULL;</a>
<a name="ln2062">		for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln2063">			item = new(std::nothrow) BMenuItem(entries-&gt;StringAt(i).String(),</a>
<a name="ln2064">				NULL);</a>
<a name="ln2065">			if (item == NULL || !menu-&gt;AddItem(item)) {</a>
<a name="ln2066">				delete item;</a>
<a name="ln2067">				return;</a>
<a name="ln2068">			}</a>
<a name="ln2069">		}</a>
<a name="ln2070"> </a>
<a name="ln2071">		menu-&gt;AddSeparatorItem();</a>
<a name="ln2072">		BMenuItem* manualItem = new(std::nothrow) BMenuItem(</a>
<a name="ln2073">			&quot;Locate manually&quot; B_UTF8_ELLIPSIS, NULL);</a>
<a name="ln2074">		if (manualItem == NULL || !menu-&gt;AddItem(manualItem)) {</a>
<a name="ln2075">			delete manualItem;</a>
<a name="ln2076">			return;</a>
<a name="ln2077">		}</a>
<a name="ln2078"> </a>
<a name="ln2079">		BPoint point;</a>
<a name="ln2080">		fSourcePathView-&gt;GetMouse(&amp;point, NULL, false);</a>
<a name="ln2081">		fSourcePathView-&gt;ConvertToScreen(&amp;point);</a>
<a name="ln2082">		item = menu-&gt;Go(point, false, true);</a>
<a name="ln2083">		if (item == NULL)</a>
<a name="ln2084">			return;</a>
<a name="ln2085">		else if (item != manualItem) {</a>
<a name="ln2086">			// if the user picks to locate the entry manually,</a>
<a name="ln2087">			// then fall through to the usual file panel logic</a>
<a name="ln2088">			// as if we'd found no matches at all.</a>
<a name="ln2089">			entry_ref ref;</a>
<a name="ln2090">			if (get_ref_for_path(item-&gt;Label(), &amp;ref) == B_OK) {</a>
<a name="ln2091">				_HandleResolveMissingSourceFile(ref);</a>
<a name="ln2092">				return;</a>
<a name="ln2093">			}</a>
<a name="ln2094">		}</a>
<a name="ln2095">	}</a>
<a name="ln2096"> </a>
<a name="ln2097">	try {</a>
<a name="ln2098">		if (fFilePanel == NULL) {</a>
<a name="ln2099">			fFilePanel = new BFilePanel(B_OPEN_PANEL,</a>
<a name="ln2100">				new BMessenger(this));</a>
<a name="ln2101">		}</a>
<a name="ln2102">		fFilePanel-&gt;Show();</a>
<a name="ln2103">	} catch (...) {</a>
<a name="ln2104">		delete fFilePanel;</a>
<a name="ln2105">		fFilePanel = NULL;</a>
<a name="ln2106">	}</a>
<a name="ln2107">}</a>
<a name="ln2108"> </a>
<a name="ln2109"> </a>
<a name="ln2110">status_t</a>
<a name="ln2111">TeamWindow::_RetrieveMatchingSourceEntries(const BString&amp; path,</a>
<a name="ln2112">	BStringList* _entries)</a>
<a name="ln2113">{</a>
<a name="ln2114">	BPath filePath(path);</a>
<a name="ln2115">	status_t error = filePath.InitCheck();</a>
<a name="ln2116">	if (error != B_OK)</a>
<a name="ln2117">		return error;</a>
<a name="ln2118"> </a>
<a name="ln2119">	_entries-&gt;MakeEmpty();</a>
<a name="ln2120"> </a>
<a name="ln2121">	BQuery query;</a>
<a name="ln2122">	BString predicate;</a>
<a name="ln2123">	query.PushAttr(&quot;name&quot;);</a>
<a name="ln2124">	query.PushString(filePath.Leaf());</a>
<a name="ln2125">	query.PushOp(B_EQ);</a>
<a name="ln2126"> </a>
<a name="ln2127">	error = query.GetPredicate(&amp;predicate);</a>
<a name="ln2128">	if (error != B_OK)</a>
<a name="ln2129">		return error;</a>
<a name="ln2130"> </a>
<a name="ln2131">	BVolumeRoster roster;</a>
<a name="ln2132">	BVolume volume;</a>
<a name="ln2133">	while (roster.GetNextVolume(&amp;volume) == B_OK) {</a>
<a name="ln2134">		if (!volume.KnowsQuery())</a>
<a name="ln2135">			continue;</a>
<a name="ln2136"> </a>
<a name="ln2137">		if (query.SetVolume(&amp;volume) != B_OK)</a>
<a name="ln2138">			continue;</a>
<a name="ln2139"> </a>
<a name="ln2140">		error = query.SetPredicate(predicate.String());</a>
<a name="ln2141">		if (error != B_OK)</a>
<a name="ln2142">			continue;</a>
<a name="ln2143"> </a>
<a name="ln2144">		if (query.Fetch() != B_OK)</a>
<a name="ln2145">			continue;</a>
<a name="ln2146"> </a>
<a name="ln2147">		entry_ref ref;</a>
<a name="ln2148">		while (query.GetNextRef(&amp;ref) == B_OK) {</a>
<a name="ln2149">			filePath.SetTo(&amp;ref);</a>
<a name="ln2150">			_entries-&gt;Add(filePath.Path());</a>
<a name="ln2151">		}</a>
<a name="ln2152"> </a>
<a name="ln2153">		query.Clear();</a>
<a name="ln2154">	}</a>
<a name="ln2155"> </a>
<a name="ln2156">	return B_OK;</a>
<a name="ln2157">}</a>
<a name="ln2158"> </a>
<a name="ln2159"> </a>
<a name="ln2160">status_t</a>
<a name="ln2161">TeamWindow::_SaveInspectorSettings(const BMessage* settings)</a>
<a name="ln2162">{</a>
<a name="ln2163">	if (fUiSettings.AddSettings(&quot;inspectorWindow&quot;, *settings) != B_OK)</a>
<a name="ln2164">		return B_NO_MEMORY;</a>
<a name="ln2165"> </a>
<a name="ln2166">	return B_OK;</a>
<a name="ln2167">}</a>
<a name="ln2168"> </a>
<a name="ln2169"> </a>
<a name="ln2170">status_t</a>
<a name="ln2171">TeamWindow::_GetActiveSourceLanguage(SourceLanguage*&amp; _language)</a>
<a name="ln2172">{</a>
<a name="ln2173">	AutoLocker&lt; ::Team&gt; locker(fTeam);</a>
<a name="ln2174"> </a>
<a name="ln2175">	if (!locker.IsLocked())</a>
<a name="ln2176">		return B_ERROR;</a>
<a name="ln2177"> </a>
<a name="ln2178">	if (fActiveSourceCode != NULL) {</a>
<a name="ln2179">		_language = fActiveSourceCode-&gt;GetSourceLanguage();</a>
<a name="ln2180">		_language-&gt;AcquireReference();</a>
<a name="ln2181">		return B_OK;</a>
<a name="ln2182">	}</a>
<a name="ln2183"> </a>
<a name="ln2184">	// if we made it this far, we were unable to acquire a source</a>
<a name="ln2185">	// language corresponding to the active function. As such,</a>
<a name="ln2186">	// try to fall back to the C++-style parser.</a>
<a name="ln2187">	_language = new(std::nothrow) CppLanguage();</a>
<a name="ln2188">	if (_language == NULL)</a>
<a name="ln2189">		return B_NO_MEMORY;</a>
<a name="ln2190"> </a>
<a name="ln2191">	return B_OK;</a>
<a name="ln2192">}</a>

</code></pre>
<div class="balloon" rel="125"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: next.</p></div>
<div class="balloon" rel="2015"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
