
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ApplicationTypeWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2006-2010, Axel DÃ¶rfler, axeld@pinc-software.de.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> */</a>
<a name="ln5"> </a>
<a name="ln6"> </a>
<a name="ln7">#include &quot;ApplicationTypeWindow.h&quot;</a>
<a name="ln8">#include &quot;DropTargetListView.h&quot;</a>
<a name="ln9">#include &quot;FileTypes.h&quot;</a>
<a name="ln10">#include &quot;IconView.h&quot;</a>
<a name="ln11">#include &quot;PreferredAppMenu.h&quot;</a>
<a name="ln12">#include &quot;StringView.h&quot;</a>
<a name="ln13">#include &quot;TypeListWindow.h&quot;</a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;Application.h&gt;</a>
<a name="ln16">#include &lt;Bitmap.h&gt;</a>
<a name="ln17">#include &lt;Box.h&gt;</a>
<a name="ln18">#include &lt;Button.h&gt;</a>
<a name="ln19">#include &lt;Catalog.h&gt;</a>
<a name="ln20">#include &lt;CheckBox.h&gt;</a>
<a name="ln21">#include &lt;ControlLook.h&gt;</a>
<a name="ln22">#include &lt;File.h&gt;</a>
<a name="ln23">#include &lt;GroupView.h&gt;</a>
<a name="ln24">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln25">#include &lt;ListView.h&gt;</a>
<a name="ln26">#include &lt;Locale.h&gt;</a>
<a name="ln27">#include &lt;MenuBar.h&gt;</a>
<a name="ln28">#include &lt;MenuField.h&gt;</a>
<a name="ln29">#include &lt;MenuItem.h&gt;</a>
<a name="ln30">#include &lt;Mime.h&gt;</a>
<a name="ln31">#include &lt;NodeInfo.h&gt;</a>
<a name="ln32">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln33">#include &lt;RadioButton.h&gt;</a>
<a name="ln34">#include &lt;Roster.h&gt;</a>
<a name="ln35">#include &lt;ScrollView.h&gt;</a>
<a name="ln36">#include &lt;StringView.h&gt;</a>
<a name="ln37">#include &lt;TextControl.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39">#include &lt;ctype.h&gt;</a>
<a name="ln40">#include &lt;stdio.h&gt;</a>
<a name="ln41">#include &lt;stdlib.h&gt;</a>
<a name="ln42">#include &lt;strings.h&gt;</a>
<a name="ln43"> </a>
<a name="ln44"> </a>
<a name="ln45">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln46">#define B_TRANSLATION_CONTEXT &quot;Application Type Window&quot;</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">const uint32 kMsgSave = 'save';</a>
<a name="ln50">const uint32 kMsgSignatureChanged = 'sgch';</a>
<a name="ln51">const uint32 kMsgToggleAppFlags = 'tglf';</a>
<a name="ln52">const uint32 kMsgAppFlagsChanged = 'afch';</a>
<a name="ln53"> </a>
<a name="ln54">const uint32 kMsgIconChanged = 'icch';</a>
<a name="ln55">const uint32 kMsgTypeIconsChanged = 'tich';</a>
<a name="ln56"> </a>
<a name="ln57">const uint32 kMsgVersionInfoChanged = 'tvch';</a>
<a name="ln58"> </a>
<a name="ln59">const uint32 kMsgTypeSelected = 'tpsl';</a>
<a name="ln60">const uint32 kMsgAddType = 'adtp';</a>
<a name="ln61">const uint32 kMsgTypeAdded = 'tpad';</a>
<a name="ln62">const uint32 kMsgRemoveType = 'rmtp';</a>
<a name="ln63">const uint32 kMsgTypeRemoved = 'tprm';</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">//! TextView that filters the tab key to be able to tab-navigate while editing</a>
<a name="ln67">class TabFilteringTextView : public BTextView {</a>
<a name="ln68">public:</a>
<a name="ln69">								TabFilteringTextView(const char* name,</a>
<a name="ln70">									uint32 changedMessageWhat = 0);</a>
<a name="ln71">	virtual						~TabFilteringTextView();</a>
<a name="ln72"> </a>
<a name="ln73">	virtual void				InsertText(const char* text, int32 length,</a>
<a name="ln74">									int32 offset, const text_run_array* runs);</a>
<a name="ln75">	virtual	void				DeleteText(int32 fromOffset, int32 toOffset);</a>
<a name="ln76">	virtual	void				KeyDown(const char* bytes, int32 count);</a>
<a name="ln77">	virtual	void				TargetedByScrollView(BScrollView* scroller);</a>
<a name="ln78">	virtual	void				MakeFocus(bool focused = true);</a>
<a name="ln79"> </a>
<a name="ln80">private:</a>
<a name="ln81">			BScrollView*		fScrollView;</a>
<a name="ln82">			uint32				fChangedMessageWhat;</a>
<a name="ln83">};</a>
<a name="ln84"> </a>
<a name="ln85"> </a>
<a name="ln86">class SupportedTypeItem : public BStringItem {</a>
<a name="ln87">public:</a>
<a name="ln88">								SupportedTypeItem(const char* type);</a>
<a name="ln89">	virtual						~SupportedTypeItem();</a>
<a name="ln90"> </a>
<a name="ln91">			const char*			Type() const { return fType.String(); }</a>
<a name="ln92">			::Icon&amp;				Icon() { return fIcon; }</a>
<a name="ln93"> </a>
<a name="ln94">			void				SetIcon(::Icon* icon);</a>
<a name="ln95">			void				SetIcon(entry_ref&amp; ref, const char* type);</a>
<a name="ln96"> </a>
<a name="ln97">	static	int					Compare(const void* _a, const void* _b);</a>
<a name="ln98"> </a>
<a name="ln99">private:</a>
<a name="ln100">			BString				fType;</a>
<a name="ln101">			::Icon				fIcon;</a>
<a name="ln102">};</a>
<a name="ln103"> </a>
<a name="ln104"> </a>
<a name="ln105">class SupportedTypeListView : public DropTargetListView {</a>
<a name="ln106">public:</a>
<a name="ln107">								SupportedTypeListView(const char* name,</a>
<a name="ln108">									list_view_type</a>
<a name="ln109">										type = B_SINGLE_SELECTION_LIST,</a>
<a name="ln110">									uint32 flags = B_WILL_DRAW</a>
<a name="ln111">										| B_FRAME_EVENTS | B_NAVIGABLE);</a>
<a name="ln112">	virtual						~SupportedTypeListView();</a>
<a name="ln113"> </a>
<a name="ln114">	virtual	void				MessageReceived(BMessage* message);</a>
<a name="ln115">	virtual	bool				AcceptsDrag(const BMessage* message);</a>
<a name="ln116">};</a>
<a name="ln117"> </a>
<a name="ln118"> </a>
<a name="ln119">// #pragma mark -</a>
<a name="ln120"> </a>
<a name="ln121"> </a>
<a name="ln122">TabFilteringTextView::TabFilteringTextView(const char* name,</a>
<a name="ln123">	uint32 changedMessageWhat)</a>
<a name="ln124">	:</a>
<a name="ln125">	BTextView(name, B_WILL_DRAW | B_PULSE_NEEDED | B_NAVIGABLE),</a>
<a name="ln126">	fScrollView(NULL),</a>
<a name="ln127">	fChangedMessageWhat(changedMessageWhat)</a>
<a name="ln128">{</a>
<a name="ln129">}</a>
<a name="ln130"> </a>
<a name="ln131"> </a>
<a name="ln132">TabFilteringTextView::~TabFilteringTextView()</a>
<a name="ln133">{</a>
<a name="ln134">}</a>
<a name="ln135"> </a>
<a name="ln136"> </a>
<a name="ln137">void</a>
<a name="ln138">TabFilteringTextView::InsertText(const char* text, int32 length, int32 offset,</a>
<a name="ln139">	const text_run_array* runs)</a>
<a name="ln140">{</a>
<a name="ln141">	BTextView::InsertText(text, length, offset, runs);</a>
<a name="ln142">	if (fChangedMessageWhat != 0)</a>
<a name="ln143">		Window()-&gt;PostMessage(fChangedMessageWhat);</a>
<a name="ln144">}</a>
<a name="ln145"> </a>
<a name="ln146"> </a>
<a name="ln147">void</a>
<a name="ln148">TabFilteringTextView::DeleteText(int32 fromOffset, int32 toOffset)</a>
<a name="ln149">{</a>
<a name="ln150">	BTextView::DeleteText(fromOffset, toOffset);</a>
<a name="ln151">	if (fChangedMessageWhat != 0)</a>
<a name="ln152">		Window()-&gt;PostMessage(fChangedMessageWhat);</a>
<a name="ln153">}</a>
<a name="ln154"> </a>
<a name="ln155"> </a>
<a name="ln156">void</a>
<a name="ln157">TabFilteringTextView::KeyDown(const char* bytes, int32 count)</a>
<a name="ln158">{</a>
<a name="ln159">	if (bytes[0] == B_TAB)</a>
<a name="ln160">		BView::KeyDown(bytes, count);</a>
<a name="ln161">	else</a>
<a name="ln162">		BTextView::KeyDown(bytes, count);</a>
<a name="ln163">}</a>
<a name="ln164"> </a>
<a name="ln165"> </a>
<a name="ln166">void</a>
<a name="ln167">TabFilteringTextView::TargetedByScrollView(BScrollView* scroller)</a>
<a name="ln168">{</a>
<a name="ln169">	fScrollView = scroller;</a>
<a name="ln170">}</a>
<a name="ln171"> </a>
<a name="ln172"> </a>
<a name="ln173">void</a>
<a name="ln174">TabFilteringTextView::MakeFocus(bool focused)</a>
<a name="ln175">{</a>
<a name="ln176">	BTextView::MakeFocus(focused);</a>
<a name="ln177"> </a>
<a name="ln178">	if (fScrollView)</a>
<a name="ln179">		fScrollView-&gt;SetBorderHighlighted(focused);</a>
<a name="ln180">}</a>
<a name="ln181"> </a>
<a name="ln182"> </a>
<a name="ln183">// #pragma mark -</a>
<a name="ln184"> </a>
<a name="ln185"> </a>
<a name="ln186">SupportedTypeItem::SupportedTypeItem(const char* type)</a>
<a name="ln187">	: BStringItem(type),</a>
<a name="ln188">	fType(type)</a>
<a name="ln189">{</a>
<a name="ln190">	BMimeType mimeType(type);</a>
<a name="ln191"> </a>
<a name="ln192">	char description[B_MIME_TYPE_LENGTH];</a>
<a name="ln193">	if (mimeType.GetShortDescription(description) == B_OK &amp;&amp; description[0])</a>
<a name="ln194">		SetText(description);</a>
<a name="ln195">}</a>
<a name="ln196"> </a>
<a name="ln197"> </a>
<a name="ln198">SupportedTypeItem::~SupportedTypeItem()</a>
<a name="ln199">{</a>
<a name="ln200">}</a>
<a name="ln201"> </a>
<a name="ln202"> </a>
<a name="ln203">void</a>
<a name="ln204">SupportedTypeItem::SetIcon(::Icon* icon)</a>
<a name="ln205">{</a>
<a name="ln206">	if (icon != NULL)</a>
<a name="ln207">		fIcon = *icon;</a>
<a name="ln208">	else</a>
<a name="ln209">		fIcon.Unset();</a>
<a name="ln210">}</a>
<a name="ln211"> </a>
<a name="ln212"> </a>
<a name="ln213">void</a>
<a name="ln214">SupportedTypeItem::SetIcon(entry_ref&amp; ref, const char* type)</a>
<a name="ln215">{</a>
<a name="ln216">	fIcon.SetTo(ref, type);</a>
<a name="ln217">}</a>
<a name="ln218"> </a>
<a name="ln219"> </a>
<a name="ln220">/*static*/</a>
<a name="ln221">int</a>
<a name="ln222">SupportedTypeItem::Compare(const void* _a, const void* _b)</a>
<a name="ln223">{</a>
<a name="ln224">	const SupportedTypeItem* a = *(const SupportedTypeItem**)_a;</a>
<a name="ln225">	const SupportedTypeItem* b = *(const SupportedTypeItem**)_b;</a>
<a name="ln226"> </a>
<a name="ln227">	int compare = strcasecmp(a-&gt;Text(), b-&gt;Text());</a>
<a name="ln228">	if (compare != 0)</a>
<a name="ln229">		return compare;</a>
<a name="ln230"> </a>
<a name="ln231">	return strcasecmp(a-&gt;Type(), b-&gt;Type());</a>
<a name="ln232">}</a>
<a name="ln233"> </a>
<a name="ln234"> </a>
<a name="ln235">//	#pragma mark -</a>
<a name="ln236"> </a>
<a name="ln237"> </a>
<a name="ln238">SupportedTypeListView::SupportedTypeListView(const char* name,</a>
<a name="ln239">	list_view_type type, uint32 flags)</a>
<a name="ln240">	:</a>
<a name="ln241">	DropTargetListView(name, type, flags)</a>
<a name="ln242">{</a>
<a name="ln243">}</a>
<a name="ln244"> </a>
<a name="ln245"> </a>
<a name="ln246">SupportedTypeListView::~SupportedTypeListView()</a>
<a name="ln247">{</a>
<a name="ln248">}</a>
<a name="ln249"> </a>
<a name="ln250"> </a>
<a name="ln251">void</a>
<a name="ln252">SupportedTypeListView::MessageReceived(BMessage* message)</a>
<a name="ln253">{</a>
<a name="ln254">	if (message-&gt;WasDropped() &amp;&amp; AcceptsDrag(message)) {</a>
<a name="ln255">		// Add unique types</a>
<a name="ln256">		entry_ref ref;</a>
<a name="ln257">		for (int32 index = 0; message-&gt;FindRef(&quot;refs&quot;, index++, &amp;ref) == B_OK; ) {</a>
<a name="ln258">			BNode node(&amp;ref);</a>
<a name="ln259">			BNodeInfo info(&amp;node);</a>
<a name="ln260">			if (node.InitCheck() != B_OK || info.InitCheck() != B_OK)</a>
<a name="ln261">				continue;</a>
<a name="ln262"> </a>
<a name="ln263">			// TODO: we could identify the file in case it doesn't have a type...</a>
<a name="ln264">			char type[B_MIME_TYPE_LENGTH];</a>
<a name="ln265">			if (info.GetType(type) != B_OK)</a>
<a name="ln266">				continue;</a>
<a name="ln267"> </a>
<a name="ln268">			// check if that type is already in our list</a>
<a name="ln269">			bool found = false;</a>
<a name="ln270">			for (int32 i = CountItems(); i-- &gt; 0;) {</a>
<a name="ln271">				SupportedTypeItem* item = (SupportedTypeItem*)ItemAt(i);</a>
<a name="ln272">				if (!strcmp(item-&gt;Text(), type)) {</a>
<a name="ln273">					found = true;</a>
<a name="ln274">					break;</a>
<a name="ln275">				}</a>
<a name="ln276">			}</a>
<a name="ln277"> </a>
<a name="ln278">			if (!found) {</a>
<a name="ln279">				// add type</a>
<a name="ln280">				AddItem(new SupportedTypeItem(type));</a>
<a name="ln281">			}</a>
<a name="ln282">		}</a>
<a name="ln283"> </a>
<a name="ln284">		SortItems(&amp;SupportedTypeItem::Compare);</a>
<a name="ln285">	} else</a>
<a name="ln286">		DropTargetListView::MessageReceived(message);</a>
<a name="ln287">}</a>
<a name="ln288"> </a>
<a name="ln289"> </a>
<a name="ln290">bool</a>
<a name="ln291">SupportedTypeListView::AcceptsDrag(const BMessage* message)</a>
<a name="ln292">{</a>
<a name="ln293">	type_code type;</a>
<a name="ln294">	return message-&gt;GetInfo(&quot;refs&quot;, &amp;type) == B_OK &amp;&amp; type == B_REF_TYPE;</a>
<a name="ln295">}</a>
<a name="ln296"> </a>
<a name="ln297"> </a>
<a name="ln298">//	#pragma mark -</a>
<a name="ln299"> </a>
<a name="ln300"> </a>
<a name="ln301">ApplicationTypeWindow::ApplicationTypeWindow(BPoint position,</a>
<a name="ln302">	const BEntry&amp; entry)</a>
<a name="ln303">	:</a>
<a name="ln304">	BWindow(BRect(0.0f, 0.0f, 250.0f, 340.0f).OffsetBySelf(position),</a>
<a name="ln305">		B_TRANSLATE(&quot;Application type&quot;), B_TITLED_WINDOW,</a>
<a name="ln306">		B_NOT_ZOOMABLE | B_ASYNCHRONOUS_CONTROLS |</a>
<a name="ln307">			B_FRAME_EVENTS | B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln308">	fChangedProperties(0)</a>
<a name="ln309">{</a>
<a name="ln310">	float padding = be_control_look-&gt;DefaultItemSpacing();</a>
<a name="ln311">	BAlignment labelAlignment = be_control_look-&gt;DefaultLabelAlignment();</a>
<a name="ln312"> </a>
<a name="ln313">	BMenuBar* menuBar = new BMenuBar((char*)NULL);</a>
<a name="ln314">	menuBar-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT, B_ALIGN_TOP));</a>
<a name="ln315"> </a>
<a name="ln316">	BMenu* menu = new BMenu(B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln317">	fSaveMenuItem = new BMenuItem(B_TRANSLATE(&quot;Save&quot;),</a>
<a name="ln318">		new BMessage(kMsgSave), 'S');</a>
<a name="ln319">	fSaveMenuItem-&gt;SetEnabled(false);</a>
<a name="ln320">	menu-&gt;AddItem(fSaveMenuItem);</a>
<a name="ln321">	BMenuItem* item;</a>
<a name="ln322">	menu-&gt;AddItem(item = new BMenuItem(</a>
<a name="ln323">		B_TRANSLATE(&quot;Save into resource file&quot; B_UTF8_ELLIPSIS), NULL));</a>
<a name="ln324">	item-&gt;SetEnabled(false);</a>
<a name="ln325"> </a>
<a name="ln326">	menu-&gt;AddSeparatorItem();</a>
<a name="ln327">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Close&quot;),</a>
<a name="ln328">		new BMessage(B_QUIT_REQUESTED), 'W', B_COMMAND_KEY));</a>
<a name="ln329">	menuBar-&gt;AddItem(menu);</a>
<a name="ln330"> </a>
<a name="ln331">	// Signature</a>
<a name="ln332"> </a>
<a name="ln333">	fSignatureControl = new BTextControl(&quot;signature&quot;,</a>
<a name="ln334">		B_TRANSLATE(&quot;Signature:&quot;), new BMessage(kMsgSignatureChanged));</a>
<a name="ln335">	fSignatureControl-&gt;SetModificationMessage(</a>
<a name="ln336">		new BMessage(kMsgSignatureChanged));</a>
<a name="ln337"> </a>
<a name="ln338">	// filter out invalid characters that can't be part of a MIME type name</a>
<a name="ln339">	BTextView* textView = fSignatureControl-&gt;TextView();</a>
<a name="ln340">	textView-&gt;SetMaxBytes(B_MIME_TYPE_LENGTH);</a>
<a name="ln341">	const char* disallowedCharacters = &quot;&lt;&gt;@,;:\&quot;()[]?= &quot;;</a>
<a name="ln342">	for (int32 i = 0; disallowedCharacters[i]; i++) {</a>
<a name="ln343">		textView-&gt;DisallowChar(disallowedCharacters[i]);</a>
<a name="ln344">	}</a>
<a name="ln345"> </a>
<a name="ln346">	// &quot;Application Flags&quot; group</a>
<a name="ln347"> </a>
<a name="ln348">	BBox* flagsBox = new BBox(&quot;flagsBox&quot;);</a>
<a name="ln349"> </a>
<a name="ln350">	fFlagsCheckBox = new BCheckBox(&quot;flags&quot;, B_TRANSLATE(&quot;Application flags&quot;),</a>
<a name="ln351">		new BMessage(kMsgToggleAppFlags));</a>
<a name="ln352">	fFlagsCheckBox-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln353"> </a>
<a name="ln354">	fSingleLaunchButton = new BRadioButton(&quot;single&quot;,</a>
<a name="ln355">		B_TRANSLATE(&quot;Single launch&quot;), new BMessage(kMsgAppFlagsChanged));</a>
<a name="ln356"> </a>
<a name="ln357">	fMultipleLaunchButton = new BRadioButton(&quot;multiple&quot;,</a>
<a name="ln358">		B_TRANSLATE(&quot;Multiple launch&quot;), new BMessage(kMsgAppFlagsChanged));</a>
<a name="ln359"> </a>
<a name="ln360">	fExclusiveLaunchButton = new BRadioButton(&quot;exclusive&quot;,</a>
<a name="ln361">		B_TRANSLATE(&quot;Exclusive launch&quot;), new BMessage(kMsgAppFlagsChanged));</a>
<a name="ln362"> </a>
<a name="ln363">	fArgsOnlyCheckBox = new BCheckBox(&quot;args only&quot;, B_TRANSLATE(&quot;Args only&quot;),</a>
<a name="ln364">		new BMessage(kMsgAppFlagsChanged));</a>
<a name="ln365"> </a>
<a name="ln366">	fBackgroundAppCheckBox = new BCheckBox(&quot;background&quot;,</a>
<a name="ln367">		B_TRANSLATE(&quot;Background app&quot;), new BMessage(kMsgAppFlagsChanged));</a>
<a name="ln368"> </a>
<a name="ln369">	BLayoutBuilder::Grid&lt;&gt;(flagsBox, 0, 0)</a>
<a name="ln370">		.SetInsets(padding, padding * 2, padding, padding)</a>
<a name="ln371">		.Add(fSingleLaunchButton, 0, 0).Add(fArgsOnlyCheckBox, 1, 0)</a>
<a name="ln372">		.Add(fMultipleLaunchButton, 0, 1).Add(fBackgroundAppCheckBox, 1, 1)</a>
<a name="ln373">		.Add(fExclusiveLaunchButton, 0, 2);</a>
<a name="ln374">	flagsBox-&gt;SetLabel(fFlagsCheckBox);</a>
<a name="ln375"> </a>
<a name="ln376">	// &quot;Icon&quot; group</a>
<a name="ln377"> </a>
<a name="ln378">	BBox* iconBox = new BBox(&quot;IconBox&quot;);</a>
<a name="ln379">	iconBox-&gt;SetLabel(B_TRANSLATE(&quot;Icon&quot;));</a>
<a name="ln380">	fIconView = new IconView(&quot;icon&quot;);</a>
<a name="ln381">	fIconView-&gt;SetModificationMessage(new BMessage(kMsgIconChanged));</a>
<a name="ln382">	BLayoutBuilder::Group&lt;&gt;(iconBox, B_HORIZONTAL)</a>
<a name="ln383">		.SetInsets(padding, padding * 2, padding, padding)</a>
<a name="ln384">		.Add(fIconView);</a>
<a name="ln385"> </a>
<a name="ln386">	// &quot;Supported Types&quot; group</a>
<a name="ln387"> </a>
<a name="ln388">	BBox* typeBox = new BBox(&quot;typesBox&quot;);</a>
<a name="ln389">	typeBox-&gt;SetLabel(B_TRANSLATE(&quot;Supported types&quot;));</a>
<a name="ln390"> </a>
<a name="ln391">	fTypeListView = new SupportedTypeListView(&quot;Suppported Types&quot;,</a>
<a name="ln392">		B_SINGLE_SELECTION_LIST);</a>
<a name="ln393">	fTypeListView-&gt;SetSelectionMessage(new BMessage(kMsgTypeSelected));</a>
<a name="ln394"> </a>
<a name="ln395">	BScrollView* scrollView = new BScrollView(&quot;type scrollview&quot;, fTypeListView,</a>
<a name="ln396">		B_FRAME_EVENTS | B_WILL_DRAW, false, true);</a>
<a name="ln397"> </a>
<a name="ln398">	fAddTypeButton = new BButton(&quot;add type&quot;,</a>
<a name="ln399">		B_TRANSLATE(&quot;Add&quot; B_UTF8_ELLIPSIS), new BMessage(kMsgAddType));</a>
<a name="ln400"> </a>
<a name="ln401">	fRemoveTypeButton = new BButton(&quot;remove type&quot;, B_TRANSLATE(&quot;Remove&quot;),</a>
<a name="ln402">		new BMessage(kMsgRemoveType));</a>
<a name="ln403"> </a>
<a name="ln404">	fTypeIconView = new IconView(&quot;type icon&quot;);</a>
<a name="ln405">	BGroupView* iconHolder = new BGroupView(B_HORIZONTAL);</a>
<a name="ln406">	iconHolder-&gt;AddChild(fTypeIconView);</a>
<a name="ln407">	fTypeIconView-&gt;SetModificationMessage(new BMessage(kMsgTypeIconsChanged));</a>
<a name="ln408"> </a>
<a name="ln409">	BLayoutBuilder::Grid&lt;&gt;(typeBox, padding, padding)</a>
<a name="ln410">		.SetInsets(padding, padding * 2, padding, padding)</a>
<a name="ln411">		.Add(scrollView, 0, 0, 1, 4)</a>
<a name="ln412">		.Add(fAddTypeButton, 1, 0, 1, 2)</a>
<a name="ln413">		.Add(fRemoveTypeButton, 1, 2, 1, 2)</a>
<a name="ln414">		.Add(iconHolder, 2, 1, 1, 2)</a>
<a name="ln415">		.SetColumnWeight(0, 3)</a>
<a name="ln416">		.SetColumnWeight(1, 2)</a>
<a name="ln417">		.SetColumnWeight(2, 1);</a>
<a name="ln418"> </a>
<a name="ln419">	iconHolder-&gt;SetExplicitAlignment(</a>
<a name="ln420">		BAlignment(B_ALIGN_CENTER, B_ALIGN_MIDDLE));</a>
<a name="ln421"> </a>
<a name="ln422">	// &quot;Version Info&quot; group</a>
<a name="ln423"> </a>
<a name="ln424">	BBox* versionBox = new BBox(&quot;versionBox&quot;);</a>
<a name="ln425">	versionBox-&gt;SetLabel(B_TRANSLATE(&quot;Version info&quot;));</a>
<a name="ln426"> </a>
<a name="ln427">	fMajorVersionControl = new BTextControl(&quot;version major&quot;,</a>
<a name="ln428">		B_TRANSLATE(&quot;Version:&quot;), NULL, new BMessage(kMsgVersionInfoChanged));</a>
<a name="ln429">	_MakeNumberTextControl(fMajorVersionControl);</a>
<a name="ln430"> </a>
<a name="ln431">	fMiddleVersionControl = new BTextControl(&quot;version middle&quot;, &quot;.&quot;, NULL,</a>
<a name="ln432">		new BMessage(kMsgVersionInfoChanged));</a>
<a name="ln433">	_MakeNumberTextControl(fMiddleVersionControl);</a>
<a name="ln434"> </a>
<a name="ln435">	fMinorVersionControl = new BTextControl(&quot;version minor&quot;, &quot;.&quot;, NULL,</a>
<a name="ln436">		new BMessage(kMsgVersionInfoChanged));</a>
<a name="ln437">	_MakeNumberTextControl(fMinorVersionControl);</a>
<a name="ln438"> </a>
<a name="ln439">	fVarietyMenu = new BPopUpMenu(&quot;variety&quot;, true, true);</a>
<a name="ln440">	fVarietyMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Development&quot;),</a>
<a name="ln441">		new BMessage(kMsgVersionInfoChanged)));</a>
<a name="ln442">	fVarietyMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Alpha&quot;),</a>
<a name="ln443">		new BMessage(kMsgVersionInfoChanged)));</a>
<a name="ln444">	fVarietyMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Beta&quot;),</a>
<a name="ln445">		new BMessage(kMsgVersionInfoChanged)));</a>
<a name="ln446">	fVarietyMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Gamma&quot;),</a>
<a name="ln447">		new BMessage(kMsgVersionInfoChanged)));</a>
<a name="ln448">	item = new BMenuItem(B_TRANSLATE(&quot;Golden master&quot;),</a>
<a name="ln449">		new BMessage(kMsgVersionInfoChanged));</a>
<a name="ln450">	fVarietyMenu-&gt;AddItem(item);</a>
<a name="ln451">	item-&gt;SetMarked(true);</a>
<a name="ln452">	fVarietyMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Final&quot;),</a>
<a name="ln453">		new BMessage(kMsgVersionInfoChanged)));</a>
<a name="ln454"> </a>
<a name="ln455">	BMenuField* varietyField = new BMenuField(&quot;&quot;, fVarietyMenu);</a>
<a name="ln456">	fInternalVersionControl = new BTextControl(&quot;version internal&quot;, &quot;/&quot;, NULL,</a>
<a name="ln457">		new BMessage(kMsgVersionInfoChanged));</a>
<a name="ln458">	fShortDescriptionControl = new BTextControl(&quot;short description&quot;,</a>
<a name="ln459">		B_TRANSLATE(&quot;Short description:&quot;), NULL,</a>
<a name="ln460">		new BMessage(kMsgVersionInfoChanged));</a>
<a name="ln461"> </a>
<a name="ln462">	// TODO: workaround for a GCC 4.1.0 bug? Or is that really what the standard says?</a>
<a name="ln463">	version_info versionInfo;</a>
<a name="ln464">	fShortDescriptionControl-&gt;TextView()-&gt;SetMaxBytes(</a>
<a name="ln465">		sizeof(versionInfo.short_info));</a>
<a name="ln466"> </a>
<a name="ln467">	BStringView* longLabel = new BStringView(NULL,</a>
<a name="ln468">		B_TRANSLATE(&quot;Long description:&quot;));</a>
<a name="ln469">	longLabel-&gt;SetExplicitAlignment(labelAlignment);</a>
<a name="ln470">	fLongDescriptionView = new TabFilteringTextView(&quot;long desc&quot;,</a>
<a name="ln471">		kMsgVersionInfoChanged);</a>
<a name="ln472">	fLongDescriptionView-&gt;SetMaxBytes(sizeof(versionInfo.long_info));</a>
<a name="ln473"> </a>
<a name="ln474">	scrollView = new BScrollView(&quot;desc scrollview&quot;, fLongDescriptionView,</a>
<a name="ln475">		B_FRAME_EVENTS | B_WILL_DRAW, false, true);</a>
<a name="ln476"> </a>
<a name="ln477">	// TODO: remove workaround (bug #5678)</a>
<a name="ln478">	BSize minScrollSize = scrollView-&gt;ScrollBar(B_VERTICAL)-&gt;MinSize();</a>
<a name="ln479">	minScrollSize.width += fLongDescriptionView-&gt;MinSize().width;</a>
<a name="ln480">	scrollView-&gt;SetExplicitMinSize(minScrollSize);</a>
<a name="ln481"> </a>
<a name="ln482">	// Manually set a minimum size for the version text controls</a>
<a name="ln483">	// TODO: the same does not work when applied to the layout items</a>
<a name="ln484">	float width = be_plain_font-&gt;StringWidth(&quot;99&quot;) + 16;</a>
<a name="ln485">	fMajorVersionControl-&gt;TextView()-&gt;SetExplicitMinSize(</a>
<a name="ln486">		BSize(width, fMajorVersionControl-&gt;MinSize().height));</a>
<a name="ln487">	fMiddleVersionControl-&gt;TextView()-&gt;SetExplicitMinSize(</a>
<a name="ln488">		BSize(width, fMiddleVersionControl-&gt;MinSize().height));</a>
<a name="ln489">	fMinorVersionControl-&gt;TextView()-&gt;SetExplicitMinSize(</a>
<a name="ln490">		BSize(width, fMinorVersionControl-&gt;MinSize().height));</a>
<a name="ln491">	fInternalVersionControl-&gt;TextView()-&gt;SetExplicitMinSize(</a>
<a name="ln492">		BSize(width, fInternalVersionControl-&gt;MinSize().height));</a>
<a name="ln493"> </a>
<a name="ln494">	BLayoutBuilder::Grid&lt;&gt;(versionBox, padding / 2, padding / 2)</a>
<a name="ln495">		.SetInsets(padding, padding * 2, padding, padding)</a>
<a name="ln496">		.Add(fMajorVersionControl-&gt;CreateLabelLayoutItem(), 0, 0)</a>
<a name="ln497">		.Add(fMajorVersionControl-&gt;CreateTextViewLayoutItem(), 1, 0)</a>
<a name="ln498">		.Add(fMiddleVersionControl, 2, 0, 2)</a>
<a name="ln499">		.Add(fMinorVersionControl, 4, 0, 2)</a>
<a name="ln500">		.Add(varietyField, 6, 0, 3)</a>
<a name="ln501">		.Add(fInternalVersionControl, 9, 0, 2)</a>
<a name="ln502">		.Add(fShortDescriptionControl-&gt;CreateLabelLayoutItem(), 0, 1)</a>
<a name="ln503">		.Add(fShortDescriptionControl-&gt;CreateTextViewLayoutItem(), 1, 1, 10)</a>
<a name="ln504">		.Add(longLabel, 0, 2)</a>
<a name="ln505">		.Add(scrollView, 1, 2, 10, 3)</a>
<a name="ln506">		.SetRowWeight(3, 3);</a>
<a name="ln507"> </a>
<a name="ln508">	// put it all together</a>
<a name="ln509">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln510">		.SetInsets(0, 0, 0, 0)</a>
<a name="ln511">		.Add(menuBar)</a>
<a name="ln512">		.AddGroup(B_VERTICAL, padding)</a>
<a name="ln513">			.SetInsets(padding, padding, padding, padding)</a>
<a name="ln514">			.Add(fSignatureControl)</a>
<a name="ln515">			.AddGroup(B_HORIZONTAL, padding)</a>
<a name="ln516">				.Add(flagsBox, 3)</a>
<a name="ln517">				.Add(iconBox, 1)</a>
<a name="ln518">				.End()</a>
<a name="ln519">			.Add(typeBox)</a>
<a name="ln520">			.Add(versionBox);</a>
<a name="ln521"> </a>
<a name="ln522">	SetKeyMenuBar(menuBar);</a>
<a name="ln523"> </a>
<a name="ln524">	fSignatureControl-&gt;MakeFocus(true);</a>
<a name="ln525">	BMimeType::StartWatching(this);</a>
<a name="ln526">	_SetTo(entry);</a>
<a name="ln527">}</a>
<a name="ln528"> </a>
<a name="ln529"> </a>
<a name="ln530">ApplicationTypeWindow::~ApplicationTypeWindow()</a>
<a name="ln531">{</a>
<a name="ln532">	BMimeType::StopWatching(this);</a>
<a name="ln533">}</a>
<a name="ln534"> </a>
<a name="ln535"> </a>
<a name="ln536">BString</a>
<a name="ln537">ApplicationTypeWindow::_Title(const BEntry&amp; entry)</a>
<a name="ln538">{</a>
<a name="ln539">	char name[B_FILE_NAME_LENGTH];</a>
<a name="ln540">	if (entry.GetName(name) != B_OK)</a>
<a name="ln541">		strcpy(name, &quot;\&quot;-\&quot;&quot;);</a>
<a name="ln542"> </a>
<a name="ln543">	BString title = B_TRANSLATE(&quot;%1 application type&quot;);</a>
<a name="ln544">	title.ReplaceFirst(&quot;%1&quot;, name);</a>
<a name="ln545">	return title;</a>
<a name="ln546">}</a>
<a name="ln547"> </a>
<a name="ln548"> </a>
<a name="ln549">void</a>
<a name="ln550">ApplicationTypeWindow::_SetTo(const BEntry&amp; entry)</a>
<a name="ln551">{</a>
<a name="ln552">	SetTitle(_Title(entry).String());</a>
<a name="ln553">	fEntry = entry;</a>
<a name="ln554"> </a>
<a name="ln555">	// Retrieve Info</a>
<a name="ln556"> </a>
<a name="ln557">	BFile file(&amp;entry, B_READ_ONLY);</a>
<a name="ln558">	if (file.InitCheck() != B_OK)</a>
<a name="ln559">		return;</a>
<a name="ln560"> </a>
<a name="ln561">	BAppFileInfo info(&amp;file);</a>
<a name="ln562">	if (info.InitCheck() != B_OK)</a>
<a name="ln563">		return;</a>
<a name="ln564"> </a>
<a name="ln565">	char signature[B_MIME_TYPE_LENGTH];</a>
<a name="ln566">	if (info.GetSignature(signature) != B_OK)</a>
<a name="ln567">		signature[0] = '\0';</a>
<a name="ln568"> </a>
<a name="ln569">	bool gotFlags = false;</a>
<a name="ln570">	uint32 flags;</a>
<a name="ln571">	if (info.GetAppFlags(&amp;flags) == B_OK)</a>
<a name="ln572">		gotFlags = true;</a>
<a name="ln573">	else</a>
<a name="ln574">		flags = B_MULTIPLE_LAUNCH;</a>
<a name="ln575"> </a>
<a name="ln576">	version_info versionInfo;</a>
<a name="ln577">	if (info.GetVersionInfo(&amp;versionInfo, B_APP_VERSION_KIND) != B_OK)</a>
<a name="ln578">		memset(&amp;versionInfo, 0, sizeof(version_info));</a>
<a name="ln579"> </a>
<a name="ln580">	// Set Controls</a>
<a name="ln581"> </a>
<a name="ln582">	fSignatureControl-&gt;SetModificationMessage(NULL);</a>
<a name="ln583">	fSignatureControl-&gt;SetText(signature);</a>
<a name="ln584">	fSignatureControl-&gt;SetModificationMessage(</a>
<a name="ln585">		new BMessage(kMsgSignatureChanged));</a>
<a name="ln586"> </a>
<a name="ln587">	// flags</a>
<a name="ln588"> </a>
<a name="ln589">	switch (flags &amp; (B_SINGLE_LAUNCH | B_MULTIPLE_LAUNCH | B_EXCLUSIVE_LAUNCH)) {</a>
<a name="ln590">		case B_SINGLE_LAUNCH:</a>
<a name="ln591">			fSingleLaunchButton-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln592">			break;</a>
<a name="ln593"> </a>
<a name="ln594">		case B_EXCLUSIVE_LAUNCH:</a>
<a name="ln595">			fExclusiveLaunchButton-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln596">			break;</a>
<a name="ln597"> </a>
<a name="ln598">		case B_MULTIPLE_LAUNCH:</a>
<a name="ln599">		default:</a>
<a name="ln600">			fMultipleLaunchButton-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln601">			break;</a>
<a name="ln602">	}</a>
<a name="ln603"> </a>
<a name="ln604">	fArgsOnlyCheckBox-&gt;SetValue((flags &amp; B_ARGV_ONLY) != 0);</a>
<a name="ln605">	fBackgroundAppCheckBox-&gt;SetValue((flags &amp; B_BACKGROUND_APP) != 0);</a>
<a name="ln606">	fFlagsCheckBox-&gt;SetValue(gotFlags);</a>
<a name="ln607"> </a>
<a name="ln608">	_UpdateAppFlagsEnabled();</a>
<a name="ln609"> </a>
<a name="ln610">	// icon</a>
<a name="ln611"> </a>
<a name="ln612">	entry_ref ref;</a>
<a name="ln613">	if (entry.GetRef(&amp;ref) == B_OK)</a>
<a name="ln614">		fIcon.SetTo(ref);</a>
<a name="ln615">	else</a>
<a name="ln616">		fIcon.Unset();</a>
<a name="ln617"> </a>
<a name="ln618">	fIconView-&gt;SetModificationMessage(NULL);</a>
<a name="ln619">	fIconView-&gt;SetTo(&amp;fIcon);</a>
<a name="ln620">	fIconView-&gt;SetModificationMessage(new BMessage(kMsgIconChanged));</a>
<a name="ln621"> </a>
<a name="ln622">	// supported types</a>
<a name="ln623"> </a>
<a name="ln624">	BMessage supportedTypes;</a>
<a name="ln625">	info.GetSupportedTypes(&amp;supportedTypes);</a>
<a name="ln626"> </a>
<a name="ln627">	for (int32 i = fTypeListView-&gt;CountItems(); i-- &gt; 0;) {</a>
<a name="ln628">		BListItem* item = fTypeListView-&gt;RemoveItem(i);</a>
<a name="ln629">		delete item;</a>
<a name="ln630">	}</a>
<a name="ln631"> </a>
<a name="ln632">	const char* type;</a>
<a name="ln633">	for (int32 i = 0; supportedTypes.FindString(&quot;types&quot;, i, &amp;type) == B_OK; i++) {</a>
<a name="ln634">		SupportedTypeItem* item = new SupportedTypeItem(type);</a>
<a name="ln635"> </a>
<a name="ln636">		entry_ref ref;</a>
<a name="ln637">		if (fEntry.GetRef(&amp;ref) == B_OK)</a>
<a name="ln638">			item-&gt;SetIcon(ref, type);</a>
<a name="ln639"> </a>
<a name="ln640">		fTypeListView-&gt;AddItem(item);</a>
<a name="ln641">	}</a>
<a name="ln642">	fTypeListView-&gt;SortItems(&amp;SupportedTypeItem::Compare);</a>
<a name="ln643">	fTypeIconView-&gt;SetModificationMessage(NULL);</a>
<a name="ln644">	fTypeIconView-&gt;SetTo(NULL);</a>
<a name="ln645">	fTypeIconView-&gt;SetModificationMessage(new BMessage(kMsgTypeIconsChanged));</a>
<a name="ln646">	fTypeIconView-&gt;SetEnabled(false);</a>
<a name="ln647">	fRemoveTypeButton-&gt;SetEnabled(false);</a>
<a name="ln648"> </a>
<a name="ln649">	// version info</a>
<a name="ln650"> </a>
<a name="ln651">	char text[256];</a>
<a name="ln652">	snprintf(text, sizeof(text), &quot;%&quot; B_PRId32, versionInfo.major);</a>
<a name="ln653">	fMajorVersionControl-&gt;SetText(text);</a>
<a name="ln654">	snprintf(text, sizeof(text), &quot;%&quot; B_PRId32, versionInfo.middle);</a>
<a name="ln655">	fMiddleVersionControl-&gt;SetText(text);</a>
<a name="ln656">	snprintf(text, sizeof(text), &quot;%&quot; B_PRId32, versionInfo.minor);</a>
<a name="ln657">	fMinorVersionControl-&gt;SetText(text);</a>
<a name="ln658"> </a>
<a name="ln659">	if (versionInfo.variety &gt;= (uint32)fVarietyMenu-&gt;CountItems())</a>
<a name="ln660">		versionInfo.variety = 0;</a>
<a name="ln661">	BMenuItem* item = fVarietyMenu-&gt;ItemAt(versionInfo.variety);</a>
<a name="ln662">	if (item != NULL)</a>
<a name="ln663">		item-&gt;SetMarked(true);</a>
<a name="ln664"> </a>
<a name="ln665">	snprintf(text, sizeof(text), &quot;%&quot; B_PRId32, versionInfo.internal);</a>
<a name="ln666">	fInternalVersionControl-&gt;SetText(text);</a>
<a name="ln667"> </a>
<a name="ln668">	fShortDescriptionControl-&gt;SetText(versionInfo.short_info);</a>
<a name="ln669">	fLongDescriptionView-&gt;SetText(versionInfo.long_info);</a>
<a name="ln670"> </a>
<a name="ln671">	// store original data</a>
<a name="ln672"> </a>
<a name="ln673">	fOriginalInfo.signature = signature;</a>
<a name="ln674">	fOriginalInfo.gotFlags = gotFlags;</a>
<a name="ln675">	fOriginalInfo.flags = gotFlags ? flags : 0;</a>
<a name="ln676">	fOriginalInfo.versionInfo = versionInfo;</a>
<a name="ln677">	fOriginalInfo.supportedTypes = _SupportedTypes();</a>
<a name="ln678">		// The list view has the types sorted possibly differently</a>
<a name="ln679">		// to the supportedTypes message, so don't use that here, but</a>
<a name="ln680">		// get the sorted message instead.</a>
<a name="ln681">	fOriginalInfo.iconChanged = false;</a>
<a name="ln682">	fOriginalInfo.typeIconsChanged = false;</a>
<a name="ln683"> </a>
<a name="ln684">	fChangedProperties = 0;</a>
<a name="ln685">	_CheckSaveMenuItem(0);</a>
<a name="ln686">}</a>
<a name="ln687"> </a>
<a name="ln688"> </a>
<a name="ln689">void</a>
<a name="ln690">ApplicationTypeWindow::_UpdateAppFlagsEnabled()</a>
<a name="ln691">{</a>
<a name="ln692">	bool enabled = fFlagsCheckBox-&gt;Value() != B_CONTROL_OFF;</a>
<a name="ln693"> </a>
<a name="ln694">	fSingleLaunchButton-&gt;SetEnabled(enabled);</a>
<a name="ln695">	fMultipleLaunchButton-&gt;SetEnabled(enabled);</a>
<a name="ln696">	fExclusiveLaunchButton-&gt;SetEnabled(enabled);</a>
<a name="ln697">	fArgsOnlyCheckBox-&gt;SetEnabled(enabled);</a>
<a name="ln698">	fBackgroundAppCheckBox-&gt;SetEnabled(enabled);</a>
<a name="ln699">}</a>
<a name="ln700"> </a>
<a name="ln701"> </a>
<a name="ln702">void</a>
<a name="ln703">ApplicationTypeWindow::_MakeNumberTextControl(BTextControl* control)</a>
<a name="ln704">{</a>
<a name="ln705">	// filter out invalid characters that can't be part of a MIME type name</a>
<a name="ln706">	BTextView* textView = control-&gt;TextView();</a>
<a name="ln707">	textView-&gt;SetMaxBytes(10);</a>
<a name="ln708"> </a>
<a name="ln709">	for (int32 i = 0; i &lt; 256; i++) {</a>
<a name="ln710">		if (!isdigit(i))</a>
<a name="ln711">			textView-&gt;DisallowChar(i);</a>
<a name="ln712">	}</a>
<a name="ln713">}</a>
<a name="ln714"> </a>
<a name="ln715"> </a>
<a name="ln716">void</a>
<a name="ln717">ApplicationTypeWindow::_Save()</a>
<a name="ln718">{</a>
<a name="ln719">	BFile file;</a>
<a name="ln720">	status_t status = file.SetTo(&amp;fEntry, B_READ_WRITE);</a>
<a name="ln721">	if (status != B_OK)</a>
<a name="ln722">		return;</a>
<a name="ln723"> </a>
<a name="ln724">	BAppFileInfo info(&amp;file);</a>
<a name="ln725">	status = info.InitCheck();</a>
<a name="ln726">	if (status != B_OK)</a>
<a name="ln727">		return;</a>
<a name="ln728"> </a>
<a name="ln729">	// Retrieve Info</a>
<a name="ln730"> </a>
<a name="ln731">	uint32 flags = 0;</a>
<a name="ln732">	bool gotFlags = _Flags(flags);</a>
<a name="ln733">	BMessage supportedTypes = _SupportedTypes();</a>
<a name="ln734">	version_info versionInfo = _VersionInfo();</a>
<a name="ln735"> </a>
<a name="ln736">	// Save</a>
<a name="ln737"> </a>
<a name="ln738">	status = info.SetSignature(fSignatureControl-&gt;Text());</a>
<a name="ln739">	if (status == B_OK) {</a>
<a name="ln740">		if (gotFlags)</a>
<a name="ln741">			status = info.SetAppFlags(flags);</a>
<a name="ln742">		else</a>
<a name="ln743">			status = info.RemoveAppFlags();</a>
<a name="ln744">	}</a>
<a name="ln745">	if (status == B_OK)</a>
<a name="ln746">		status = info.SetVersionInfo(&amp;versionInfo, B_APP_VERSION_KIND);</a>
<a name="ln747">	if (status == B_OK)</a>
<a name="ln748">		fIcon.CopyTo(info, NULL, true);</a>
<a name="ln749"> </a>
<a name="ln750">	// supported types and their icons</a>
<a name="ln751">	if (status == B_OK)</a>
<a name="ln752">		status = info.SetSupportedTypes(&amp;supportedTypes);</a>
<a name="ln753"> </a>
<a name="ln754">	for (int32 i = 0; i &lt; fTypeListView-&gt;CountItems(); i++) {</a>
<a name="ln755">		SupportedTypeItem* item = dynamic_cast&lt;SupportedTypeItem*&gt;(</a>
<a name="ln756">			fTypeListView-&gt;ItemAt(i));</a>
<a name="ln757"> </a>
<a name="ln758">		if (item != NULL)</a>
<a name="ln759">			item-&gt;Icon().CopyTo(info, item-&gt;Type(), true);</a>
<a name="ln760">	}</a>
<a name="ln761"> </a>
<a name="ln762">	// reset the saved info</a>
<a name="ln763">	fOriginalInfo.signature = fSignatureControl-&gt;Text();</a>
<a name="ln764">	fOriginalInfo.gotFlags = gotFlags;</a>
<a name="ln765">	fOriginalInfo.flags = flags;</a>
<a name="ln766">	fOriginalInfo.versionInfo = versionInfo;</a>
<a name="ln767">	fOriginalInfo.supportedTypes = supportedTypes;</a>
<a name="ln768">	fOriginalInfo.iconChanged = false;</a>
<a name="ln769">	fOriginalInfo.typeIconsChanged = false;</a>
<a name="ln770"> </a>
<a name="ln771">	fChangedProperties = 0;</a>
<a name="ln772">	_CheckSaveMenuItem(0);</a>
<a name="ln773">}</a>
<a name="ln774"> </a>
<a name="ln775"> </a>
<a name="ln776">void</a>
<a name="ln777">ApplicationTypeWindow::_CheckSaveMenuItem(uint32 flags)</a>
<a name="ln778">{</a>
<a name="ln779">	fChangedProperties = _NeedsSaving(flags);</a>
<a name="ln780">	fSaveMenuItem-&gt;SetEnabled(fChangedProperties != 0);</a>
<a name="ln781">}</a>
<a name="ln782"> </a>
<a name="ln783"> </a>
<a name="ln784">bool</a>
<a name="ln785">operator!=(const version_info&amp; a, const version_info&amp; b)</a>
<a name="ln786">{</a>
<a name="ln787">	return a.major != b.major || a.middle != b.middle || a.minor != b.minor</a>
<a name="ln788">		|| a.variety != b.variety || a.internal != b.internal</a>
<a name="ln789">		|| strcmp(a.short_info, b.short_info) != 0</a>
<a name="ln790">		|| strcmp(a.long_info, b.long_info) != 0;</a>
<a name="ln791">}</a>
<a name="ln792"> </a>
<a name="ln793"> </a>
<a name="ln794">uint32</a>
<a name="ln795">ApplicationTypeWindow::_NeedsSaving(uint32 _flags) const</a>
<a name="ln796">{</a>
<a name="ln797">	uint32 flags = fChangedProperties;</a>
<a name="ln798">	if (_flags &amp; CHECK_SIGNATUR) {</a>
<a name="ln799">		if (fOriginalInfo.signature != fSignatureControl-&gt;Text())</a>
<a name="ln800">			flags |= CHECK_SIGNATUR;</a>
<a name="ln801">		else</a>
<a name="ln802">			flags &amp;= ~CHECK_SIGNATUR;</a>
<a name="ln803">	}</a>
<a name="ln804"> </a>
<a name="ln805">	if (_flags &amp; CHECK_FLAGS) {</a>
<a name="ln806">		uint32 appFlags = 0;</a>
<a name="ln807">		bool gotFlags = _Flags(appFlags);</a>
<a name="ln808">		if (fOriginalInfo.gotFlags != gotFlags</a>
<a name="ln809">			|| fOriginalInfo.flags != appFlags) {</a>
<a name="ln810">			flags |= CHECK_FLAGS;</a>
<a name="ln811">		} else</a>
<a name="ln812">			flags &amp;= ~CHECK_FLAGS;</a>
<a name="ln813">	}</a>
<a name="ln814"> </a>
<a name="ln815">	if (_flags &amp; CHECK_VERSION) {</a>
<a name="ln816">		if (fOriginalInfo.versionInfo != _VersionInfo())</a>
<a name="ln817">			flags |= CHECK_VERSION;</a>
<a name="ln818">		else</a>
<a name="ln819">			flags &amp;= ~CHECK_VERSION;</a>
<a name="ln820">	}</a>
<a name="ln821"> </a>
<a name="ln822">	if (_flags &amp; CHECK_ICON) {</a>
<a name="ln823">		if (fOriginalInfo.iconChanged)</a>
<a name="ln824">			flags |= CHECK_ICON;</a>
<a name="ln825">		else</a>
<a name="ln826">			flags &amp;= ~CHECK_ICON;</a>
<a name="ln827">	}</a>
<a name="ln828"> </a>
<a name="ln829">	if (_flags &amp; CHECK_TYPES) {</a>
<a name="ln830">		if (!fOriginalInfo.supportedTypes.HasSameData(_SupportedTypes()))</a>
<a name="ln831">			flags |= CHECK_TYPES;</a>
<a name="ln832">		else</a>
<a name="ln833">			flags &amp;= ~CHECK_TYPES;</a>
<a name="ln834">	}</a>
<a name="ln835"> </a>
<a name="ln836">	if (_flags &amp; CHECK_TYPE_ICONS) {</a>
<a name="ln837">		if (fOriginalInfo.typeIconsChanged)</a>
<a name="ln838">			flags |= CHECK_TYPE_ICONS;</a>
<a name="ln839">		else</a>
<a name="ln840">			flags &amp;= ~CHECK_TYPE_ICONS;</a>
<a name="ln841">	}</a>
<a name="ln842"> </a>
<a name="ln843">	return flags;</a>
<a name="ln844">}</a>
<a name="ln845"> </a>
<a name="ln846"> </a>
<a name="ln847">// #pragma mark -</a>
<a name="ln848"> </a>
<a name="ln849"> </a>
<a name="ln850">bool</a>
<a name="ln851">ApplicationTypeWindow::_Flags(uint32&amp; flags) const</a>
<a name="ln852">{</a>
<a name="ln853">	flags = 0;</a>
<a name="ln854">	if (fFlagsCheckBox-&gt;Value() != B_CONTROL_OFF) {</a>
<a name="ln855">		if (fSingleLaunchButton-&gt;Value() != B_CONTROL_OFF)</a>
<a name="ln856">			flags |= B_SINGLE_LAUNCH;</a>
<a name="ln857">		else if (fMultipleLaunchButton-&gt;Value() != B_CONTROL_OFF)</a>
<a name="ln858">			flags |= B_MULTIPLE_LAUNCH;</a>
<a name="ln859">		else if (fExclusiveLaunchButton-&gt;Value() != B_CONTROL_OFF)</a>
<a name="ln860">			flags |= B_EXCLUSIVE_LAUNCH;</a>
<a name="ln861"> </a>
<a name="ln862">		if (fArgsOnlyCheckBox-&gt;Value() != B_CONTROL_OFF)</a>
<a name="ln863">			flags |= B_ARGV_ONLY;</a>
<a name="ln864">		if (fBackgroundAppCheckBox-&gt;Value() != B_CONTROL_OFF)</a>
<a name="ln865">			flags |= B_BACKGROUND_APP;</a>
<a name="ln866">		return true;</a>
<a name="ln867">	}</a>
<a name="ln868">	return false;</a>
<a name="ln869">}</a>
<a name="ln870"> </a>
<a name="ln871"> </a>
<a name="ln872">BMessage</a>
<a name="ln873">ApplicationTypeWindow::_SupportedTypes() const</a>
<a name="ln874">{</a>
<a name="ln875">	BMessage supportedTypes;</a>
<a name="ln876">	for (int32 i = 0; i &lt; fTypeListView-&gt;CountItems(); i++) {</a>
<a name="ln877">		SupportedTypeItem* item = dynamic_cast&lt;SupportedTypeItem*&gt;(</a>
<a name="ln878">			fTypeListView-&gt;ItemAt(i));</a>
<a name="ln879"> </a>
<a name="ln880">		if (item != NULL)</a>
<a name="ln881">			supportedTypes.AddString(&quot;types&quot;, item-&gt;Type());</a>
<a name="ln882">	}</a>
<a name="ln883">	return supportedTypes;</a>
<a name="ln884">}</a>
<a name="ln885"> </a>
<a name="ln886"> </a>
<a name="ln887">version_info</a>
<a name="ln888">ApplicationTypeWindow::_VersionInfo() const</a>
<a name="ln889">{</a>
<a name="ln890">	version_info versionInfo;</a>
<a name="ln891">	versionInfo.major = atol(fMajorVersionControl-&gt;Text());</a>
<a name="ln892">	versionInfo.middle = atol(fMiddleVersionControl-&gt;Text());</a>
<a name="ln893">	versionInfo.minor = atol(fMinorVersionControl-&gt;Text());</a>
<a name="ln894">	versionInfo.variety = fVarietyMenu-&gt;IndexOf(fVarietyMenu-&gt;FindMarked());</a>
<a name="ln895">	versionInfo.internal = atol(fInternalVersionControl-&gt;Text());</a>
<a name="ln896">	strlcpy(versionInfo.short_info, fShortDescriptionControl-&gt;Text(),</a>
<a name="ln897">		sizeof(versionInfo.short_info));</a>
<a name="ln898">	strlcpy(versionInfo.long_info, fLongDescriptionView-&gt;Text(),</a>
<a name="ln899">		sizeof(versionInfo.long_info));</a>
<a name="ln900">	return versionInfo;</a>
<a name="ln901">}</a>
<a name="ln902"> </a>
<a name="ln903"> </a>
<a name="ln904">// #pragma mark -</a>
<a name="ln905"> </a>
<a name="ln906"> </a>
<a name="ln907">void</a>
<a name="ln908">ApplicationTypeWindow::FrameResized(float width, float height)</a>
<a name="ln909">{</a>
<a name="ln910">	// This works around a flaw of BTextView</a>
<a name="ln911">	fLongDescriptionView-&gt;SetTextRect(fLongDescriptionView-&gt;Bounds());</a>
<a name="ln912">}</a>
<a name="ln913"> </a>
<a name="ln914"> </a>
<a name="ln915">void</a>
<a name="ln916">ApplicationTypeWindow::MessageReceived(BMessage* message)</a>
<a name="ln917">{</a>
<a name="ln918">	switch (message-&gt;what) {</a>
<a name="ln919">		case kMsgToggleAppFlags:</a>
<a name="ln920">			_UpdateAppFlagsEnabled();</a>
<a name="ln921">			_CheckSaveMenuItem(CHECK_FLAGS);</a>
<a name="ln922">			break;</a>
<a name="ln923"> </a>
<a name="ln924">		case kMsgSignatureChanged:</a>
<a name="ln925">			_CheckSaveMenuItem(CHECK_SIGNATUR);</a>
<a name="ln926">			break;</a>
<a name="ln927"> </a>
<a name="ln928">		case kMsgAppFlagsChanged:</a>
<a name="ln929">			_CheckSaveMenuItem(CHECK_FLAGS);</a>
<a name="ln930">			break;</a>
<a name="ln931"> </a>
<a name="ln932">		case kMsgIconChanged:</a>
<a name="ln933">			fOriginalInfo.iconChanged = true;</a>
<a name="ln934">			_CheckSaveMenuItem(CHECK_ICON);</a>
<a name="ln935">			break;</a>
<a name="ln936"> </a>
<a name="ln937">		case kMsgTypeIconsChanged:</a>
<a name="ln938">			fOriginalInfo.typeIconsChanged = true;</a>
<a name="ln939">			_CheckSaveMenuItem(CHECK_TYPE_ICONS);</a>
<a name="ln940">			break;</a>
<a name="ln941"> </a>
<a name="ln942">		case kMsgVersionInfoChanged:</a>
<a name="ln943">			_CheckSaveMenuItem(CHECK_VERSION);</a>
<a name="ln944">			break;</a>
<a name="ln945"> </a>
<a name="ln946">		case kMsgSave:</a>
<a name="ln947">			_Save();</a>
<a name="ln948">			break;</a>
<a name="ln949"> </a>
<a name="ln950">		case kMsgTypeSelected:</a>
<a name="ln951">		{</a>
<a name="ln952">			int32 index;</a>
<a name="ln953">			if (message-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK) {</a>
<a name="ln954">				SupportedTypeItem* item</a>
<a name="ln955">					= (SupportedTypeItem*)fTypeListView-&gt;ItemAt(index);</a>
<a name="ln956"> </a>
<a name="ln957">				fTypeIconView-&gt;SetModificationMessage(NULL);</a>
<a name="ln958">				fTypeIconView-&gt;SetTo(item != NULL ? &amp;item-&gt;Icon() : NULL);</a>
<a name="ln959">				fTypeIconView-&gt;SetModificationMessage(</a>
<a name="ln960">					new BMessage(kMsgTypeIconsChanged));</a>
<a name="ln961">				fTypeIconView-&gt;SetEnabled(item != NULL);</a>
<a name="ln962">				fRemoveTypeButton-&gt;SetEnabled(item != NULL);</a>
<a name="ln963"> </a>
<a name="ln964">				_CheckSaveMenuItem(CHECK_TYPES);</a>
<a name="ln965">			}</a>
<a name="ln966">			break;</a>
<a name="ln967">		}</a>
<a name="ln968"> </a>
<a name="ln969">		case kMsgAddType:</a>
<a name="ln970">		{</a>
<a name="ln971">			BWindow* window = new TypeListWindow(NULL,</a>
<a name="ln972">				kMsgTypeAdded, this);</a>
<a name="ln973">			window-&gt;Show();</a>
<a name="ln974">			break;</a>
<a name="ln975">		}</a>
<a name="ln976"> </a>
<a name="ln977">		case kMsgTypeAdded:</a>
<a name="ln978">		{</a>
<a name="ln979">			const char* type;</a>
<a name="ln980">			if (message-&gt;FindString(&quot;type&quot;, &amp;type) != B_OK)</a>
<a name="ln981">				break;</a>
<a name="ln982"> </a>
<a name="ln983">			// check if this type already exists</a>
<a name="ln984"> </a>
<a name="ln985">			SupportedTypeItem* newItem = new SupportedTypeItem(type);</a>
<a name="ln986">			int32 insertAt = 0;</a>
<a name="ln987"> </a>
<a name="ln988">			for (int32 i = fTypeListView-&gt;CountItems(); i-- &gt; 0;) {</a>
<a name="ln989">				SupportedTypeItem* item = dynamic_cast&lt;SupportedTypeItem*&gt;(</a>
<a name="ln990">					fTypeListView-&gt;ItemAt(i));</a>
<a name="ln991">				if (item == NULL)</a>
<a name="ln992">					continue;</a>
<a name="ln993"> </a>
<a name="ln994">				int compare = strcasecmp(item-&gt;Type(), type);</a>
<a name="ln995">				if (!compare) {</a>
<a name="ln996">					// type does already exist, select it and bail out</a>
<a name="ln997">					delete newItem;</a>
<a name="ln998">					newItem = NULL;</a>
<a name="ln999">					fTypeListView-&gt;Select(i);</a>
<a name="ln1000">					break;</a>
<a name="ln1001">				}</a>
<a name="ln1002">				if (compare &lt; 0)</a>
<a name="ln1003">					insertAt = i + 1;</a>
<a name="ln1004">			}</a>
<a name="ln1005"> </a>
<a name="ln1006">			if (newItem == NULL)</a>
<a name="ln1007">				break;</a>
<a name="ln1008"> </a>
<a name="ln1009">			fTypeListView-&gt;AddItem(newItem, insertAt);</a>
<a name="ln1010">			fTypeListView-&gt;Select(insertAt);</a>
<a name="ln1011"> </a>
<a name="ln1012">			_CheckSaveMenuItem(CHECK_TYPES);</a>
<a name="ln1013">			break;</a>
<a name="ln1014">		}</a>
<a name="ln1015"> </a>
<a name="ln1016">		case kMsgRemoveType:</a>
<a name="ln1017">		{</a>
<a name="ln1018">			int32 index = fTypeListView-&gt;CurrentSelection();</a>
<a name="ln1019">			if (index &lt; 0)</a>
<a name="ln1020">				break;</a>
<a name="ln1021"> </a>
<a name="ln1022">			delete fTypeListView-&gt;RemoveItem(index);</a>
<a name="ln1023">			fTypeIconView-&gt;SetModificationMessage(NULL);</a>
<a name="ln1024">			fTypeIconView-&gt;SetTo(NULL);</a>
<a name="ln1025">			fTypeIconView-&gt;SetModificationMessage(</a>
<a name="ln1026">				new BMessage(kMsgTypeIconsChanged));</a>
<a name="ln1027">			fTypeIconView-&gt;SetEnabled(false);</a>
<a name="ln1028">			fRemoveTypeButton-&gt;SetEnabled(false);</a>
<a name="ln1029"> </a>
<a name="ln1030">			_CheckSaveMenuItem(CHECK_TYPES);</a>
<a name="ln1031">			break;</a>
<a name="ln1032">		}</a>
<a name="ln1033"> </a>
<a name="ln1034">		case B_SIMPLE_DATA:</a>
<a name="ln1035">		{</a>
<a name="ln1036">			entry_ref ref;</a>
<a name="ln1037">			if (message-&gt;FindRef(&quot;refs&quot;, &amp;ref) != B_OK)</a>
<a name="ln1038">				break;</a>
<a name="ln1039"> </a>
<a name="ln1040">			// TODO: add to supported types</a>
<a name="ln1041">			break;</a>
<a name="ln1042">		}</a>
<a name="ln1043"> </a>
<a name="ln1044">		case B_META_MIME_CHANGED:</a>
<a name="ln1045">			const char* type;</a>
<a name="ln1046">			int32 which;</a>
<a name="ln1047">			if (message-&gt;FindString(&quot;be:type&quot;, &amp;type) != B_OK</a>
<a name="ln1048">				|| message-&gt;FindInt32(&quot;be:which&quot;, &amp;which) != B_OK)</a>
<a name="ln1049">				break;</a>
<a name="ln1050"> </a>
<a name="ln1051">			// TODO: update supported types names</a>
<a name="ln1052">//			if (which == B_MIME_TYPE_DELETED)</a>
<a name="ln1053"> </a>
<a name="ln1054">//			_CheckSaveMenuItem(...);</a>
<a name="ln1055">			break;</a>
<a name="ln1056"> </a>
<a name="ln1057">		default:</a>
<a name="ln1058">			BWindow::MessageReceived(message);</a>
<a name="ln1059">	}</a>
<a name="ln1060">}</a>
<a name="ln1061"> </a>
<a name="ln1062"> </a>
<a name="ln1063">bool</a>
<a name="ln1064">ApplicationTypeWindow::QuitRequested()</a>
<a name="ln1065">{</a>
<a name="ln1066">	if (_NeedsSaving(CHECK_ALL) != 0) {</a>
<a name="ln1067">		BAlert* alert = new BAlert(B_TRANSLATE(&quot;Save request&quot;),</a>
<a name="ln1068">			B_TRANSLATE(&quot;Save changes before closing?&quot;),</a>
<a name="ln1069">			B_TRANSLATE(&quot;Cancel&quot;), B_TRANSLATE(&quot;Don't save&quot;),</a>
<a name="ln1070">			B_TRANSLATE(&quot;Save&quot;), B_WIDTH_AS_USUAL, B_OFFSET_SPACING,</a>
<a name="ln1071">			B_WARNING_ALERT);</a>
<a name="ln1072">		alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln1073">		alert-&gt;SetShortcut(1, 'd');</a>
<a name="ln1074">		alert-&gt;SetShortcut(2, 's');</a>
<a name="ln1075"> </a>
<a name="ln1076">		int32 choice = alert-&gt;Go();</a>
<a name="ln1077">		switch (choice) {</a>
<a name="ln1078">			case 0:</a>
<a name="ln1079">				return false;</a>
<a name="ln1080">			case 1:</a>
<a name="ln1081">				break;</a>
<a name="ln1082">			case 2:</a>
<a name="ln1083">				_Save();</a>
<a name="ln1084">				break;</a>
<a name="ln1085">		}</a>
<a name="ln1086">	}</a>
<a name="ln1087"> </a>
<a name="ln1088">	be_app-&gt;PostMessage(kMsgTypeWindowClosed);</a>
<a name="ln1089">	return true;</a>
<a name="ln1090">}</a>
<a name="ln1091"> </a>

</code></pre>
<div class="balloon" rel="1079"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
