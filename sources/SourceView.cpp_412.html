
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>SourceView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2009-2012, Ingo Weinhold, ingo_weinhold@gmx.de.</a>
<a name="ln3"> * Copyright 2009-2016, Rene Gollent, rene@gollent.com.</a>
<a name="ln4"> * Distributed under the terms of the MIT License.</a>
<a name="ln5"> */</a>
<a name="ln6"> </a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;SourceView.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;algorithm&gt;</a>
<a name="ln11">#include &lt;new&gt;</a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;ctype.h&gt;</a>
<a name="ln14">#include &lt;stdio.h&gt;</a>
<a name="ln15"> </a>
<a name="ln16">#include &lt;Clipboard.h&gt;</a>
<a name="ln17">#include &lt;Entry.h&gt;</a>
<a name="ln18">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln19">#include &lt;Looper.h&gt;</a>
<a name="ln20">#include &lt;MenuItem.h&gt;</a>
<a name="ln21">#include &lt;Message.h&gt;</a>
<a name="ln22">#include &lt;MessageRunner.h&gt;</a>
<a name="ln23">#include &lt;Path.h&gt;</a>
<a name="ln24">#include &lt;Polygon.h&gt;</a>
<a name="ln25">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln26">#include &lt;Region.h&gt;</a>
<a name="ln27">#include &lt;ScrollBar.h&gt;</a>
<a name="ln28">#include &lt;ScrollView.h&gt;</a>
<a name="ln29">#include &lt;ToolTip.h&gt;</a>
<a name="ln30"> </a>
<a name="ln31">#include &lt;AutoLocker.h&gt;</a>
<a name="ln32">#include &lt;ObjectList.h&gt;</a>
<a name="ln33"> </a>
<a name="ln34">#include &quot;AppMessageCodes.h&quot;</a>
<a name="ln35">#include &quot;AutoDeleter.h&quot;</a>
<a name="ln36">#include &quot;Breakpoint.h&quot;</a>
<a name="ln37">#include &quot;DisassembledCode.h&quot;</a>
<a name="ln38">#include &quot;Function.h&quot;</a>
<a name="ln39">#include &quot;FileSourceCode.h&quot;</a>
<a name="ln40">#include &quot;LocatableFile.h&quot;</a>
<a name="ln41">#include &quot;MessageCodes.h&quot;</a>
<a name="ln42">#include &quot;SourceLanguage.h&quot;</a>
<a name="ln43">#include &quot;StackTrace.h&quot;</a>
<a name="ln44">#include &quot;Statement.h&quot;</a>
<a name="ln45">#include &quot;SyntaxHighlighter.h&quot;</a>
<a name="ln46">#include &quot;Team.h&quot;</a>
<a name="ln47">#include &quot;Tracing.h&quot;</a>
<a name="ln48"> </a>
<a name="ln49"> </a>
<a name="ln50">static const int32 kLeftTextMargin = 3;</a>
<a name="ln51">static const float kMinViewHeight = 80.0f;</a>
<a name="ln52">static const int32 kSpacesPerTab = 4;</a>
<a name="ln53">	// TODO: Should be settable!</a>
<a name="ln54"> </a>
<a name="ln55">static const int32 kMaxHighlightsPerLine = 64;</a>
<a name="ln56"> </a>
<a name="ln57">static const bigtime_t kScrollTimer = 10000LL;</a>
<a name="ln58"> </a>
<a name="ln59">static const char* kClearBreakpointMessage = &quot;Click to clear breakpoint at &quot;</a>
<a name="ln60">	&quot;line %&quot; B_PRId32 &quot;.&quot;;</a>
<a name="ln61">static const char* kDisableBreakpointMessage = &quot;Click to disable breakpoint at &quot;</a>
<a name="ln62">	&quot;line %&quot; B_PRId32 &quot;.&quot;;</a>
<a name="ln63">static const char* kEnableBreakpointMessage = &quot;Click to enable breakpoint at &quot;</a>
<a name="ln64">	&quot;line %&quot; B_PRId32 &quot;.&quot;;</a>
<a name="ln65"> </a>
<a name="ln66">static const uint32 MSG_OPEN_SOURCE_FILE = 'mosf';</a>
<a name="ln67">static const uint32 MSG_SWITCH_DISASSEMBLY_STATE = 'msds';</a>
<a name="ln68"> </a>
<a name="ln69">static const char* kTrackerSignature = &quot;application/x-vnd.Be-TRAK&quot;;</a>
<a name="ln70"> </a>
<a name="ln71"> </a>
<a name="ln72">// TODO: make configurable.</a>
<a name="ln73">// Current values taken from Pe's defaults.</a>
<a name="ln74">static rgb_color kSyntaxColors[] = {</a>
<a name="ln75">	{0, 0, 0, 255}, 			// SYNTAX_HIGHLIGHT_NONE</a>
<a name="ln76">	{0x39, 0x74, 0x79, 255},	// SYNTAX_HIGHLIGHT_KEYWORD</a>
<a name="ln77">	{0, 0x64, 0, 255},			// SYNTAX_HIGHLIGHT_PREPROCESSOR_KEYWORD</a>
<a name="ln78">	{0, 0, 0, 255},				// SYNTAX_HIGHLIGHT_IDENTIFIER</a>
<a name="ln79">	{0x44, 0x8a, 0, 255},		// SYNTAX_HIGHLIGHT_OPERATOR</a>
<a name="ln80">	{0x70, 0x70, 0x70, 255},	// SYNTAX_HIGHLIGHT_TYPE</a>
<a name="ln81">	{0x85, 0x19, 0x19, 255},	// SYNTAX_HIGHLIGHT_NUMERIC_LITERAL</a>
<a name="ln82">	{0x3f, 0x48, 0x84, 255},	// SYNTAX_HIGHLIGHT_STRING_LITERAL</a>
<a name="ln83">	{0xa1, 0x64, 0xe, 255},		// SYNTAX_HIGHLIGHT_COMMENT</a>
<a name="ln84">};</a>
<a name="ln85"> </a>
<a name="ln86"> </a>
<a name="ln87">class SourceView::BaseView : public BView {</a>
<a name="ln88">public:</a>
<a name="ln89">								BaseView(const char* name,</a>
<a name="ln90">									SourceView* sourceView, FontInfo* fontInfo);</a>
<a name="ln91"> </a>
<a name="ln92">	virtual	void				SetSourceCode(SourceCode* sourceCode);</a>
<a name="ln93"> </a>
<a name="ln94">	virtual	BSize				PreferredSize();</a>
<a name="ln95"> </a>
<a name="ln96">protected:</a>
<a name="ln97">	inline	int32				LineCount() const;</a>
<a name="ln98"> </a>
<a name="ln99">	inline	float				TotalHeight() const;</a>
<a name="ln100"> </a>
<a name="ln101">			int32				LineAtOffset(float yOffset) const;</a>
<a name="ln102">			void				GetLineRange(BRect rect, int32&amp; minLine,</a>
<a name="ln103">									int32&amp; maxLine) const;</a>
<a name="ln104">			BRect				LineRect(uint32 line) const;</a>
<a name="ln105"> </a>
<a name="ln106">protected:</a>
<a name="ln107">			SourceView*			fSourceView;</a>
<a name="ln108">			FontInfo*			fFontInfo;</a>
<a name="ln109">			SourceCode*			fSourceCode;</a>
<a name="ln110">};</a>
<a name="ln111"> </a>
<a name="ln112"> </a>
<a name="ln113">class SourceView::MarkerManager {</a>
<a name="ln114">public:</a>
<a name="ln115">								MarkerManager(SourceView* sourceView,</a>
<a name="ln116">									Team* team, Listener* listener);</a>
<a name="ln117"> </a>
<a name="ln118">			void				SetSourceCode(SourceCode* sourceCode);</a>
<a name="ln119"> </a>
<a name="ln120">			void				SetStackTrace(StackTrace* stackTrace);</a>
<a name="ln121">			void				SetStackFrame(StackFrame* stackFrame);</a>
<a name="ln122"> </a>
<a name="ln123">			void				UserBreakpointChanged(</a>
<a name="ln124">									UserBreakpoint* breakpoint);</a>
<a name="ln125"> </a>
<a name="ln126">			struct Marker;</a>
<a name="ln127">			struct InstructionPointerMarker;</a>
<a name="ln128">			struct BreakpointMarker;</a>
<a name="ln129"> </a>
<a name="ln130">			template&lt;typename MarkerType&gt; struct MarkerByLinePredicate;</a>
<a name="ln131"> </a>
<a name="ln132">			typedef BObjectList&lt;Marker&gt;	MarkerList;</a>
<a name="ln133">			typedef BObjectList&lt;BreakpointMarker&gt; BreakpointMarkerList;</a>
<a name="ln134"> </a>
<a name="ln135">			void				GetMarkers(uint32 minLine, uint32 maxLine,</a>
<a name="ln136">									MarkerList&amp; markers);</a>
<a name="ln137">			BreakpointMarker*	BreakpointMarkerAtLine(uint32 line);</a>
<a name="ln138"> </a>
<a name="ln139">private:</a>
<a name="ln140">			void				_InvalidateIPMarkers();</a>
<a name="ln141">			void				_InvalidateBreakpointMarkers();</a>
<a name="ln142">			void				_UpdateIPMarkers();</a>
<a name="ln143">			void				_UpdateBreakpointMarkers();</a>
<a name="ln144"> </a>
<a name="ln145">// TODO: &quot;public&quot; to workaround a GCC2 problem:</a>
<a name="ln146">public:</a>
<a name="ln147">	static	int					_CompareMarkers(const Marker* a,</a>
<a name="ln148">									const Marker* b);</a>
<a name="ln149">	static	int					_CompareBreakpointMarkers(</a>
<a name="ln150">									const BreakpointMarker* a,</a>
<a name="ln151">									const BreakpointMarker* b);</a>
<a name="ln152"> </a>
<a name="ln153">	template&lt;typename MarkerType&gt;</a>
<a name="ln154">	static	int					_CompareLineMarkerTemplate(const uint32* line,</a>
<a name="ln155">									const MarkerType* marker);</a>
<a name="ln156">	static	int					_CompareLineMarker(const uint32* line,</a>
<a name="ln157">									const Marker* marker);</a>
<a name="ln158">	static	int					_CompareLineBreakpointMarker(</a>
<a name="ln159">									const uint32* line,</a>
<a name="ln160">									const BreakpointMarker* marker);</a>
<a name="ln161"> </a>
<a name="ln162">private:</a>
<a name="ln163">			Team*				fTeam;</a>
<a name="ln164">			Listener*			fListener;</a>
<a name="ln165">			SourceCode*			fSourceCode;</a>
<a name="ln166">			StackTrace*			fStackTrace;</a>
<a name="ln167">			StackFrame*			fStackFrame;</a>
<a name="ln168">			MarkerList			fIPMarkers;</a>
<a name="ln169">			BreakpointMarkerList fBreakpointMarkers;</a>
<a name="ln170">			bool				fIPMarkersValid;</a>
<a name="ln171">			bool				fBreakpointMarkersValid;</a>
<a name="ln172"> </a>
<a name="ln173">};</a>
<a name="ln174"> </a>
<a name="ln175"> </a>
<a name="ln176">class SourceView::MarkerView : public BaseView {</a>
<a name="ln177">public:</a>
<a name="ln178">								MarkerView(SourceView* sourceView, Team* team,</a>
<a name="ln179">									Listener* listener, MarkerManager *manager,</a>
<a name="ln180">									FontInfo* fontInfo);</a>
<a name="ln181">								~MarkerView();</a>
<a name="ln182"> </a>
<a name="ln183">	virtual	void				SetSourceCode(SourceCode* sourceCode);</a>
<a name="ln184"> </a>
<a name="ln185">			void				SetStackTrace(StackTrace* stackTrace);</a>
<a name="ln186">			void				SetStackFrame(StackFrame* stackFrame);</a>
<a name="ln187"> </a>
<a name="ln188">			void				UserBreakpointChanged(</a>
<a name="ln189">									UserBreakpoint* breakpoint);</a>
<a name="ln190"> </a>
<a name="ln191">	virtual	BSize				MinSize();</a>
<a name="ln192">	virtual	BSize				MaxSize();</a>
<a name="ln193"> </a>
<a name="ln194">	virtual	void				Draw(BRect updateRect);</a>
<a name="ln195"> </a>
<a name="ln196">	virtual	void				MouseDown(BPoint where);</a>
<a name="ln197"> </a>
<a name="ln198">protected:</a>
<a name="ln199">	virtual bool				GetToolTipAt(BPoint point, BToolTip** _tip);</a>
<a name="ln200"> </a>
<a name="ln201">private:</a>
<a name="ln202">			Team*				fTeam;</a>
<a name="ln203">			Listener*			fListener;</a>
<a name="ln204">			MarkerManager*		fMarkerManager;</a>
<a name="ln205">			StackTrace*			fStackTrace;</a>
<a name="ln206">			StackFrame*			fStackFrame;</a>
<a name="ln207">			rgb_color			fBackgroundColor;</a>
<a name="ln208">			rgb_color			fBreakpointOptionMarker;</a>
<a name="ln209">};</a>
<a name="ln210"> </a>
<a name="ln211"> </a>
<a name="ln212">struct SourceView::MarkerManager::Marker {</a>
<a name="ln213">								Marker(uint32 line);</a>
<a name="ln214">	virtual						~Marker();</a>
<a name="ln215"> </a>
<a name="ln216">	inline	uint32				Line() const;</a>
<a name="ln217"> </a>
<a name="ln218">	virtual	void				Draw(BView* view, BRect rect) = 0;</a>
<a name="ln219"> </a>
<a name="ln220">private:</a>
<a name="ln221">	uint32	fLine;</a>
<a name="ln222">};</a>
<a name="ln223"> </a>
<a name="ln224"> </a>
<a name="ln225">struct SourceView::MarkerManager::InstructionPointerMarker : Marker {</a>
<a name="ln226">								InstructionPointerMarker(uint32 line,</a>
<a name="ln227">									bool topIP, bool currentIP);</a>
<a name="ln228"> </a>
<a name="ln229">	virtual	void				Draw(BView* view, BRect rect);</a>
<a name="ln230"> </a>
<a name="ln231">			bool				IsCurrentIP() const { return fIsCurrentIP; }</a>
<a name="ln232"> </a>
<a name="ln233">private:</a>
<a name="ln234">			void				_DrawArrow(BView* view, BPoint tip, BSize size,</a>
<a name="ln235">									BSize base, const rgb_color&amp; color,</a>
<a name="ln236">									bool fill);</a>
<a name="ln237"> </a>
<a name="ln238">private:</a>
<a name="ln239">			bool				fIsTopIP;</a>
<a name="ln240">			bool				fIsCurrentIP;</a>
<a name="ln241">};</a>
<a name="ln242"> </a>
<a name="ln243"> </a>
<a name="ln244">struct SourceView::MarkerManager::BreakpointMarker : Marker {</a>
<a name="ln245">								BreakpointMarker(uint32 line,</a>
<a name="ln246">									target_addr_t address,</a>
<a name="ln247">									UserBreakpoint* breakpoint);</a>
<a name="ln248">								~BreakpointMarker();</a>
<a name="ln249"> </a>
<a name="ln250">			target_addr_t		Address() const		{ return fAddress; }</a>
<a name="ln251">			bool				IsEnabled() const</a>
<a name="ln252">									{ return fBreakpoint-&gt;IsEnabled(); }</a>
<a name="ln253">			bool				HasCondition() const</a>
<a name="ln254">									{ return fBreakpoint-&gt;HasCondition(); }</a>
<a name="ln255">			UserBreakpoint*		Breakpoint() const</a>
<a name="ln256">									{ return fBreakpoint; }</a>
<a name="ln257"> </a>
<a name="ln258">	virtual	void				Draw(BView* view, BRect rect);</a>
<a name="ln259"> </a>
<a name="ln260">private:</a>
<a name="ln261">			target_addr_t		fAddress;</a>
<a name="ln262">			UserBreakpoint*		fBreakpoint;</a>
<a name="ln263">};</a>
<a name="ln264"> </a>
<a name="ln265"> </a>
<a name="ln266">template&lt;typename MarkerType&gt;</a>
<a name="ln267">struct SourceView::MarkerManager::MarkerByLinePredicate</a>
<a name="ln268">	: UnaryPredicate&lt;MarkerType&gt; {</a>
<a name="ln269">	MarkerByLinePredicate(uint32 line)</a>
<a name="ln270">		:</a>
<a name="ln271">		fLine(line)</a>
<a name="ln272">	{</a>
<a name="ln273">	}</a>
<a name="ln274"> </a>
<a name="ln275">	virtual int operator()(const MarkerType* marker) const</a>
<a name="ln276">	{</a>
<a name="ln277">		return -_CompareLineMarkerTemplate&lt;MarkerType&gt;(&amp;fLine, marker);</a>
<a name="ln278">	}</a>
<a name="ln279"> </a>
<a name="ln280">private:</a>
<a name="ln281">	uint32	fLine;</a>
<a name="ln282">};</a>
<a name="ln283"> </a>
<a name="ln284"> </a>
<a name="ln285">class SourceView::TextView : public BaseView {</a>
<a name="ln286">public:</a>
<a name="ln287">								TextView(SourceView* sourceView,</a>
<a name="ln288">									MarkerManager* manager,</a>
<a name="ln289">									FontInfo* fontInfo);</a>
<a name="ln290"> </a>
<a name="ln291">	virtual	void				SetSourceCode(SourceCode* sourceCode);</a>
<a name="ln292">			void				UserBreakpointChanged(</a>
<a name="ln293">									UserBreakpoint* breakpoint);</a>
<a name="ln294"> </a>
<a name="ln295">	virtual	BSize				MinSize();</a>
<a name="ln296">	virtual	BSize				MaxSize();</a>
<a name="ln297"> </a>
<a name="ln298">	virtual	void				Draw(BRect updateRect);</a>
<a name="ln299"> </a>
<a name="ln300">	virtual void				KeyDown(const char* bytes, int32 numBytes);</a>
<a name="ln301">	virtual void				MakeFocus(bool isFocused);</a>
<a name="ln302">	virtual void				MessageReceived(BMessage* message);</a>
<a name="ln303">	virtual void				MouseDown(BPoint where);</a>
<a name="ln304">	virtual void				MouseMoved(BPoint where, uint32 transit,</a>
<a name="ln305">									const BMessage* dragMessage);</a>
<a name="ln306">	virtual void				MouseUp(BPoint where);</a>
<a name="ln307"> </a>
<a name="ln308">private:</a>
<a name="ln309">			struct SelectionPoint</a>
<a name="ln310">			{</a>
<a name="ln311">				SelectionPoint(int32 _line, int32 _offset)</a>
<a name="ln312">				{</a>
<a name="ln313">					line = _line;</a>
<a name="ln314">					offset = _offset;</a>
<a name="ln315">				}</a>
<a name="ln316"> </a>
<a name="ln317">				bool operator==(const SelectionPoint&amp; other)</a>
<a name="ln318">				{</a>
<a name="ln319">					return line == other.line &amp;&amp; offset == other.offset;</a>
<a name="ln320">				}</a>
<a name="ln321"> </a>
<a name="ln322">				int32 line;</a>
<a name="ln323">				int32 offset;</a>
<a name="ln324">			};</a>
<a name="ln325"> </a>
<a name="ln326">			enum TrackingState</a>
<a name="ln327">			{</a>
<a name="ln328">				kNotTracking = 0,</a>
<a name="ln329">				kTracking = 1,</a>
<a name="ln330">				kDragging = 2</a>
<a name="ln331">			};</a>
<a name="ln332"> </a>
<a name="ln333">			float				_MaxLineWidth();</a>
<a name="ln334">	inline	float				_FormattedLineWidth(const char* line) const;</a>
<a name="ln335"> </a>
<a name="ln336">			void				_DrawLineSyntaxSection(const char* line,</a>
<a name="ln337">									int32 length, int32&amp; _column,</a>
<a name="ln338">									BPoint&amp; _offset);</a>
<a name="ln339">	inline	void				_DrawLineSegment(const char* line,</a>
<a name="ln340">									int32 length, BPoint&amp; _offset);</a>
<a name="ln341">	inline 	int32				_NextTabStop(int32 column) const;</a>
<a name="ln342">			float				_FormattedPosition(int32 line,</a>
<a name="ln343">									int32 offset) const;</a>
<a name="ln344">			SelectionPoint		_SelectionPointAt(BPoint where) const;</a>
<a name="ln345">			void				_GetSelectionRegion(BRegion&amp; region) const;</a>
<a name="ln346">			void				_GetSelectionText(BString&amp; text) const;</a>
<a name="ln347">			void				_CopySelectionToClipboard() const;</a>
<a name="ln348">			void				_SelectWordAt(const SelectionPoint&amp; point,</a>
<a name="ln349">									bool extend = false);</a>
<a name="ln350">			void				_SelectLineAt(const SelectionPoint&amp; point,</a>
<a name="ln351">									bool extend = false);</a>
<a name="ln352">			void				_HandleAutoScroll();</a>
<a name="ln353">			void				_ScrollHorizontal(int32 charCount);</a>
<a name="ln354">			void				_ScrollByLines(int32 lineCount);</a>
<a name="ln355">			void				_ScrollByPages(int32 pageCount);</a>
<a name="ln356">			void				_ScrollToTop();</a>
<a name="ln357">			void				_ScrollToBottom();</a>
<a name="ln358"> </a>
<a name="ln359">			bool				_AddGeneralActions(BPopUpMenu* menu,</a>
<a name="ln360">									int32 line);</a>
<a name="ln361">			bool				_AddFlowControlActions(BPopUpMenu* menu,</a>
<a name="ln362">									int32 line);</a>
<a name="ln363"> </a>
<a name="ln364">			bool				_AddGeneralActionItem(BPopUpMenu* menu,</a>
<a name="ln365">									const char* text, BMessage* message) const;</a>
<a name="ln366">										// takes ownership of message</a>
<a name="ln367">										// regardless of outcome</a>
<a name="ln368">			bool				_AddFlowControlActionItem(BPopUpMenu* menu,</a>
<a name="ln369">									const char* text, uint32 what,</a>
<a name="ln370">									target_addr_t address) const;</a>
<a name="ln371"> </a>
<a name="ln372">private:</a>
<a name="ln373"> </a>
<a name="ln374">			float				fMaxLineWidth;</a>
<a name="ln375">			float				fCharacterWidth;</a>
<a name="ln376">			SelectionPoint		fSelectionStart;</a>
<a name="ln377">			SelectionPoint		fSelectionEnd;</a>
<a name="ln378">			SelectionPoint		fSelectionBase;</a>
<a name="ln379">			SelectionPoint		fLastClickPoint;</a>
<a name="ln380">			bigtime_t			fLastClickTime;</a>
<a name="ln381">			int16				fClickCount;</a>
<a name="ln382">			rgb_color			fTextColor;</a>
<a name="ln383">			bool				fSelectionMode;</a>
<a name="ln384">			TrackingState		fTrackState;</a>
<a name="ln385">			BMessageRunner*		fScrollRunner;</a>
<a name="ln386">			MarkerManager*		fMarkerManager;</a>
<a name="ln387">};</a>
<a name="ln388"> </a>
<a name="ln389"> </a>
<a name="ln390">// #pragma mark - BaseView</a>
<a name="ln391"> </a>
<a name="ln392"> </a>
<a name="ln393">SourceView::BaseView::BaseView(const char* name, SourceView* sourceView,</a>
<a name="ln394">	FontInfo* fontInfo)</a>
<a name="ln395">	:</a>
<a name="ln396">	BView(name, B_WILL_DRAW | B_SUBPIXEL_PRECISE),</a>
<a name="ln397">	fSourceView(sourceView),</a>
<a name="ln398">	fFontInfo(fontInfo),</a>
<a name="ln399">	fSourceCode(NULL)</a>
<a name="ln400">{</a>
<a name="ln401">}</a>
<a name="ln402"> </a>
<a name="ln403"> </a>
<a name="ln404">void</a>
<a name="ln405">SourceView::BaseView::SetSourceCode(SourceCode* sourceCode)</a>
<a name="ln406">{</a>
<a name="ln407">	fSourceCode = sourceCode;</a>
<a name="ln408"> </a>
<a name="ln409">	InvalidateLayout();</a>
<a name="ln410">	Invalidate();</a>
<a name="ln411">}</a>
<a name="ln412"> </a>
<a name="ln413"> </a>
<a name="ln414">BSize</a>
<a name="ln415">SourceView::BaseView::PreferredSize()</a>
<a name="ln416">{</a>
<a name="ln417">	return MinSize();</a>
<a name="ln418">}</a>
<a name="ln419"> </a>
<a name="ln420"> </a>
<a name="ln421">int32</a>
<a name="ln422">SourceView::BaseView::LineCount() const</a>
<a name="ln423">{</a>
<a name="ln424">	return fSourceCode != NULL ? fSourceCode-&gt;CountLines() : 0;</a>
<a name="ln425">}</a>
<a name="ln426"> </a>
<a name="ln427"> </a>
<a name="ln428">float</a>
<a name="ln429">SourceView::BaseView::TotalHeight() const</a>
<a name="ln430">{</a>
<a name="ln431">	float height = LineCount() * fFontInfo-&gt;lineHeight - 1;</a>
<a name="ln432">	return std::max(height, kMinViewHeight);</a>
<a name="ln433">}</a>
<a name="ln434"> </a>
<a name="ln435"> </a>
<a name="ln436">int32</a>
<a name="ln437">SourceView::BaseView::LineAtOffset(float yOffset) const</a>
<a name="ln438">{</a>
<a name="ln439">	int32 lineCount = LineCount();</a>
<a name="ln440">	if (yOffset &lt; 0 || lineCount == 0)</a>
<a name="ln441">		return -1;</a>
<a name="ln442"> </a>
<a name="ln443">	int32 line = (int32)yOffset / (int32)fFontInfo-&gt;lineHeight;</a>
<a name="ln444">	return line &lt; lineCount ? line : -1;</a>
<a name="ln445">}</a>
<a name="ln446"> </a>
<a name="ln447"> </a>
<a name="ln448">void</a>
<a name="ln449">SourceView::BaseView::GetLineRange(BRect rect, int32&amp; minLine,</a>
<a name="ln450">	int32&amp; maxLine) const</a>
<a name="ln451">{</a>
<a name="ln452">	int32 lineHeight = (int32)fFontInfo-&gt;lineHeight;</a>
<a name="ln453">	minLine = (int32)rect.top / lineHeight;</a>
<a name="ln454">	maxLine = ((int32)ceilf(rect.bottom) + lineHeight - 1) / lineHeight;</a>
<a name="ln455">	minLine = std::max(minLine, (int32)0);</a>
<a name="ln456">	maxLine = std::min(maxLine, fSourceCode-&gt;CountLines() - 1);</a>
<a name="ln457">}</a>
<a name="ln458"> </a>
<a name="ln459"> </a>
<a name="ln460">BRect</a>
<a name="ln461">SourceView::BaseView::LineRect(uint32 line) const</a>
<a name="ln462">{</a>
<a name="ln463">	float y = (float)line * fFontInfo-&gt;lineHeight;</a>
<a name="ln464">	return BRect(0, y, Bounds().right, y + fFontInfo-&gt;lineHeight - 1);</a>
<a name="ln465">}</a>
<a name="ln466"> </a>
<a name="ln467"> </a>
<a name="ln468">// #pragma mark - MarkerView::Marker</a>
<a name="ln469"> </a>
<a name="ln470"> </a>
<a name="ln471">SourceView::MarkerManager::Marker::Marker(uint32 line)</a>
<a name="ln472">	:</a>
<a name="ln473">	fLine(line)</a>
<a name="ln474">{</a>
<a name="ln475">}</a>
<a name="ln476"> </a>
<a name="ln477"> </a>
<a name="ln478">SourceView::MarkerManager::Marker::~Marker()</a>
<a name="ln479">{</a>
<a name="ln480">}</a>
<a name="ln481"> </a>
<a name="ln482"> </a>
<a name="ln483">uint32</a>
<a name="ln484">SourceView::MarkerManager::Marker::Line() const</a>
<a name="ln485">{</a>
<a name="ln486">	return fLine;</a>
<a name="ln487">}</a>
<a name="ln488"> </a>
<a name="ln489"> </a>
<a name="ln490">// #pragma mark - MarkerManager::InstructionPointerMarker</a>
<a name="ln491"> </a>
<a name="ln492"> </a>
<a name="ln493">SourceView::MarkerManager::InstructionPointerMarker::InstructionPointerMarker(</a>
<a name="ln494">	uint32 line, bool topIP, bool currentIP)</a>
<a name="ln495">	:</a>
<a name="ln496">	Marker(line),</a>
<a name="ln497">	fIsTopIP(topIP),</a>
<a name="ln498">	fIsCurrentIP(currentIP)</a>
<a name="ln499">{</a>
<a name="ln500">}</a>
<a name="ln501"> </a>
<a name="ln502"> </a>
<a name="ln503">void</a>
<a name="ln504">SourceView::MarkerManager::InstructionPointerMarker::Draw(BView* view,</a>
<a name="ln505">	BRect rect)</a>
<a name="ln506">{</a>
<a name="ln507">	// Get the arrow color -- for the top IP, if current, we use blue,</a>
<a name="ln508">	// otherwise a gray.</a>
<a name="ln509">	rgb_color color;</a>
<a name="ln510">	if (fIsCurrentIP &amp;&amp; fIsTopIP) {</a>
<a name="ln511">		color.set_to(0, 0, 255, 255);</a>
<a name="ln512">	} else {</a>
<a name="ln513">		color = tint_color(ui_color(B_PANEL_BACKGROUND_COLOR),</a>
<a name="ln514">			B_DARKEN_3_TINT);</a>
<a name="ln515">	}</a>
<a name="ln516"> </a>
<a name="ln517">	// Draw a filled array for the current IP, otherwise just an</a>
<a name="ln518">	// outline.</a>
<a name="ln519">	BPoint tip(rect.right - 3.5f, floorf((rect.top + rect.bottom) / 2));</a>
<a name="ln520">	if (fIsCurrentIP) {</a>
<a name="ln521">		_DrawArrow(view, tip, BSize(10, 10), BSize(5, 5), color, true);</a>
<a name="ln522">	} else {</a>
<a name="ln523">		_DrawArrow(view, tip + BPoint(-0.5f, 0), BSize(9, 8),</a>
<a name="ln524">			BSize(5, 4), color, false);</a>
<a name="ln525">	}</a>
<a name="ln526">}</a>
<a name="ln527"> </a>
<a name="ln528"> </a>
<a name="ln529">void</a>
<a name="ln530">SourceView::MarkerManager::InstructionPointerMarker::_DrawArrow(BView* view,</a>
<a name="ln531">	BPoint tip, BSize size, BSize base, const rgb_color&amp; color, bool fill)</a>
<a name="ln532">{</a>
<a name="ln533">	view-&gt;SetHighColor(color);</a>
<a name="ln534"> </a>
<a name="ln535">	float baseTop = tip.y - base.height / 2;</a>
<a name="ln536">	float baseBottom = tip.y + base.height / 2;</a>
<a name="ln537">	float top = tip.y - size.height / 2;</a>
<a name="ln538">	float bottom = tip.y + size.height / 2;</a>
<a name="ln539">	float left = tip.x - size.width;</a>
<a name="ln540">	float middle = left + base.width;</a>
<a name="ln541"> </a>
<a name="ln542">	BPoint points[7];</a>
<a name="ln543">	points[0].Set(tip.x, tip.y);</a>
<a name="ln544">	points[1].Set(middle, top);</a>
<a name="ln545">	points[2].Set(middle, baseTop);</a>
<a name="ln546">	points[3].Set(left, baseTop);</a>
<a name="ln547">	points[4].Set(left, baseBottom);</a>
<a name="ln548">	points[5].Set(middle, baseBottom);</a>
<a name="ln549">	points[6].Set(middle, bottom);</a>
<a name="ln550"> </a>
<a name="ln551">	if (fill)</a>
<a name="ln552">		view-&gt;FillPolygon(points, 7);</a>
<a name="ln553">	else</a>
<a name="ln554">		view-&gt;StrokePolygon(points, 7);</a>
<a name="ln555">}</a>
<a name="ln556"> </a>
<a name="ln557"> </a>
<a name="ln558">// #pragma mark - MarkerManager::BreakpointMarker</a>
<a name="ln559"> </a>
<a name="ln560"> </a>
<a name="ln561">SourceView::MarkerManager::BreakpointMarker::BreakpointMarker(uint32 line,</a>
<a name="ln562">	target_addr_t address, UserBreakpoint* breakpoint)</a>
<a name="ln563">	:</a>
<a name="ln564">	Marker(line),</a>
<a name="ln565">	fAddress(address),</a>
<a name="ln566">	fBreakpoint(breakpoint)</a>
<a name="ln567">{</a>
<a name="ln568">	fBreakpoint-&gt;AcquireReference();</a>
<a name="ln569">}</a>
<a name="ln570"> </a>
<a name="ln571"> </a>
<a name="ln572">SourceView::MarkerManager::BreakpointMarker::~BreakpointMarker()</a>
<a name="ln573">{</a>
<a name="ln574">	fBreakpoint-&gt;ReleaseReference();</a>
<a name="ln575">}</a>
<a name="ln576"> </a>
<a name="ln577"> </a>
<a name="ln578">void</a>
<a name="ln579">SourceView::MarkerManager::BreakpointMarker::Draw(BView* view, BRect rect)</a>
<a name="ln580">{</a>
<a name="ln581">	float y = (rect.top + rect.bottom) / 2;</a>
<a name="ln582">	if (fBreakpoint-&gt;HasCondition())</a>
<a name="ln583">		view-&gt;SetHighColor((rgb_color){0, 192, 0, 255});</a>
<a name="ln584">	else</a>
<a name="ln585">		view-&gt;SetHighColor((rgb_color){255,0,0,255});</a>
<a name="ln586"> </a>
<a name="ln587">	if (fBreakpoint-&gt;IsEnabled())</a>
<a name="ln588">		view-&gt;FillEllipse(BPoint(rect.right - 8, y), 4, 4);</a>
<a name="ln589">	else</a>
<a name="ln590">		view-&gt;StrokeEllipse(BPoint(rect.right - 8, y), 3.5f, 3.5f);</a>
<a name="ln591">}</a>
<a name="ln592"> </a>
<a name="ln593"> </a>
<a name="ln594">// #pragma mark - MarkerManager</a>
<a name="ln595"> </a>
<a name="ln596"> </a>
<a name="ln597">SourceView::MarkerManager::MarkerManager(SourceView* sourceView, Team* team,</a>
<a name="ln598">	Listener* listener)</a>
<a name="ln599">	:</a>
<a name="ln600">	fTeam(team),</a>
<a name="ln601">	fListener(listener),</a>
<a name="ln602">	fStackTrace(NULL),</a>
<a name="ln603">	fStackFrame(NULL),</a>
<a name="ln604">	fIPMarkers(10, true),</a>
<a name="ln605">	fBreakpointMarkers(20, true),</a>
<a name="ln606">	fIPMarkersValid(false),</a>
<a name="ln607">	fBreakpointMarkersValid(false)</a>
<a name="ln608">{</a>
<a name="ln609">}</a>
<a name="ln610"> </a>
<a name="ln611"> </a>
<a name="ln612">void</a>
<a name="ln613">SourceView::MarkerManager::SetSourceCode(SourceCode* sourceCode)</a>
<a name="ln614">{</a>
<a name="ln615">	fSourceCode = sourceCode;</a>
<a name="ln616">	_InvalidateIPMarkers();</a>
<a name="ln617">	_InvalidateBreakpointMarkers();</a>
<a name="ln618">}</a>
<a name="ln619"> </a>
<a name="ln620"> </a>
<a name="ln621">void</a>
<a name="ln622">SourceView::MarkerManager::SetStackTrace(StackTrace* stackTrace)</a>
<a name="ln623">{</a>
<a name="ln624">	fStackTrace = stackTrace;</a>
<a name="ln625">	_InvalidateIPMarkers();</a>
<a name="ln626">}</a>
<a name="ln627"> </a>
<a name="ln628"> </a>
<a name="ln629">void</a>
<a name="ln630">SourceView::MarkerManager::SetStackFrame(StackFrame* stackFrame)</a>
<a name="ln631">{</a>
<a name="ln632">	fStackFrame = stackFrame;</a>
<a name="ln633">	_InvalidateIPMarkers();</a>
<a name="ln634">}</a>
<a name="ln635"> </a>
<a name="ln636"> </a>
<a name="ln637">void</a>
<a name="ln638">SourceView::MarkerManager::UserBreakpointChanged(UserBreakpoint* breakpoint)</a>
<a name="ln639">{</a>
<a name="ln640">	_InvalidateBreakpointMarkers();</a>
<a name="ln641">}</a>
<a name="ln642"> </a>
<a name="ln643"> </a>
<a name="ln644">void</a>
<a name="ln645">SourceView::MarkerManager::_InvalidateIPMarkers()</a>
<a name="ln646">{</a>
<a name="ln647">	fIPMarkersValid = false;</a>
<a name="ln648">	fIPMarkers.MakeEmpty();</a>
<a name="ln649">}</a>
<a name="ln650"> </a>
<a name="ln651"> </a>
<a name="ln652">void</a>
<a name="ln653">SourceView::MarkerManager::_InvalidateBreakpointMarkers()</a>
<a name="ln654">{</a>
<a name="ln655">	fBreakpointMarkersValid = false;</a>
<a name="ln656">	fBreakpointMarkers.MakeEmpty();</a>
<a name="ln657">}</a>
<a name="ln658"> </a>
<a name="ln659"> </a>
<a name="ln660">void</a>
<a name="ln661">SourceView::MarkerManager::_UpdateIPMarkers()</a>
<a name="ln662">{</a>
<a name="ln663">	if (fIPMarkersValid)</a>
<a name="ln664">		return;</a>
<a name="ln665"> </a>
<a name="ln666">	fIPMarkers.MakeEmpty();</a>
<a name="ln667"> </a>
<a name="ln668">	if (fSourceCode != NULL &amp;&amp; fStackTrace != NULL) {</a>
<a name="ln669">		LocatableFile* sourceFile = fSourceCode-&gt;GetSourceFile();</a>
<a name="ln670"> </a>
<a name="ln671">		AutoLocker&lt;Team&gt; locker(fTeam);</a>
<a name="ln672"> </a>
<a name="ln673">		for (int32 i = 0; StackFrame* frame = fStackTrace-&gt;FrameAt(i);</a>
<a name="ln674">				i++) {</a>
<a name="ln675">			target_addr_t ip = frame-&gt;InstructionPointer();</a>
<a name="ln676">			FunctionInstance* functionInstance;</a>
<a name="ln677">			Statement* statement;</a>
<a name="ln678">			if (fTeam-&gt;GetStatementAtAddress(ip,</a>
<a name="ln679">					functionInstance, statement) != B_OK) {</a>
<a name="ln680">				continue;</a>
<a name="ln681">			}</a>
<a name="ln682">			BReference&lt;Statement&gt; statementReference(statement, true);</a>
<a name="ln683"> </a>
<a name="ln684">			int32 line = statement-&gt;StartSourceLocation().Line();</a>
<a name="ln685">			if (line &lt; 0 || line &gt;= fSourceCode-&gt;CountLines())</a>
<a name="ln686">				continue;</a>
<a name="ln687"> </a>
<a name="ln688">			if (sourceFile != NULL) {</a>
<a name="ln689">				if (functionInstance-&gt;GetFunction()-&gt;SourceFile() != sourceFile)</a>
<a name="ln690">					continue;</a>
<a name="ln691">			} else {</a>
<a name="ln692">				if (functionInstance-&gt;GetSourceCode() != fSourceCode)</a>
<a name="ln693">					continue;</a>
<a name="ln694">			}</a>
<a name="ln695"> </a>
<a name="ln696">			bool isTopFrame = i == 0</a>
<a name="ln697">				&amp;&amp; frame-&gt;Type() != STACK_FRAME_TYPE_SYSCALL;</a>
<a name="ln698"> </a>
<a name="ln699">			Marker* marker = new(std::nothrow) InstructionPointerMarker(</a>
<a name="ln700">				line, isTopFrame, frame == fStackFrame);</a>
<a name="ln701">			if (marker == NULL || !fIPMarkers.AddItem(marker)) {</a>
<a name="ln702">				delete marker;</a>
<a name="ln703">				break;</a>
<a name="ln704">			}</a>
<a name="ln705">		}</a>
<a name="ln706"> </a>
<a name="ln707">		// sort by line</a>
<a name="ln708">		fIPMarkers.SortItems(&amp;_CompareMarkers);</a>
<a name="ln709"> </a>
<a name="ln710">		// TODO: Filter duplicate IP markers (recursive functions)!</a>
<a name="ln711">	}</a>
<a name="ln712"> </a>
<a name="ln713">	fIPMarkersValid = true;</a>
<a name="ln714">}</a>
<a name="ln715"> </a>
<a name="ln716"> </a>
<a name="ln717">void</a>
<a name="ln718">SourceView::MarkerManager::_UpdateBreakpointMarkers()</a>
<a name="ln719">{</a>
<a name="ln720">	if (fBreakpointMarkersValid)</a>
<a name="ln721">		return;</a>
<a name="ln722"> </a>
<a name="ln723">	fBreakpointMarkers.MakeEmpty();</a>
<a name="ln724"> </a>
<a name="ln725">	if (fSourceCode != NULL) {</a>
<a name="ln726">		LocatableFile* sourceFile = fSourceCode-&gt;GetSourceFile();</a>
<a name="ln727"> </a>
<a name="ln728">		AutoLocker&lt;Team&gt; locker(fTeam);</a>
<a name="ln729"> </a>
<a name="ln730">		// get the breakpoints in our source code range</a>
<a name="ln731">		BObjectList&lt;UserBreakpoint&gt; breakpoints;</a>
<a name="ln732">		fTeam-&gt;GetBreakpointsForSourceCode(fSourceCode, breakpoints);</a>
<a name="ln733"> </a>
<a name="ln734">		for (int32 i = 0; UserBreakpoint* breakpoint = breakpoints.ItemAt(i);</a>
<a name="ln735">				i++) {</a>
<a name="ln736">			if (breakpoint-&gt;IsHidden())</a>
<a name="ln737">				continue;</a>
<a name="ln738">			UserBreakpointInstance* breakpointInstance</a>
<a name="ln739">				= breakpoint-&gt;InstanceAt(0);</a>
<a name="ln740">			FunctionInstance* functionInstance;</a>
<a name="ln741">			Statement* statement;</a>
<a name="ln742">			if (fTeam-&gt;GetStatementAtAddress(</a>
<a name="ln743">					breakpointInstance-&gt;Address(), functionInstance,</a>
<a name="ln744">					statement) != B_OK) {</a>
<a name="ln745">				continue;</a>
<a name="ln746">			}</a>
<a name="ln747">			BReference&lt;Statement&gt; statementReference(statement, true);</a>
<a name="ln748"> </a>
<a name="ln749">			int32 line = statement-&gt;StartSourceLocation().Line();</a>
<a name="ln750">			if (line &lt; 0 || line &gt;= fSourceCode-&gt;CountLines())</a>
<a name="ln751">				continue;</a>
<a name="ln752"> </a>
<a name="ln753">			if (sourceFile != NULL) {</a>
<a name="ln754">				if (functionInstance-&gt;GetFunction()-&gt;SourceFile() != sourceFile)</a>
<a name="ln755">					continue;</a>
<a name="ln756">			} else {</a>
<a name="ln757">				if (functionInstance-&gt;GetSourceCode() != fSourceCode)</a>
<a name="ln758">					continue;</a>
<a name="ln759">			}</a>
<a name="ln760"> </a>
<a name="ln761">			BreakpointMarker* marker = new(std::nothrow) BreakpointMarker(</a>
<a name="ln762">				line, breakpointInstance-&gt;Address(), breakpoint);</a>
<a name="ln763">			if (marker == NULL || !fBreakpointMarkers.AddItem(marker)) {</a>
<a name="ln764">				delete marker;</a>
<a name="ln765">				break;</a>
<a name="ln766">			}</a>
<a name="ln767">		}</a>
<a name="ln768"> </a>
<a name="ln769">		// sort by line</a>
<a name="ln770">		fBreakpointMarkers.SortItems(&amp;_CompareBreakpointMarkers);</a>
<a name="ln771">	}</a>
<a name="ln772"> </a>
<a name="ln773">	fBreakpointMarkersValid = true;</a>
<a name="ln774">}</a>
<a name="ln775"> </a>
<a name="ln776"> </a>
<a name="ln777">void</a>
<a name="ln778">SourceView::MarkerManager::GetMarkers(uint32 minLine, uint32 maxLine,</a>
<a name="ln779">	MarkerList&amp; markers)</a>
<a name="ln780">{</a>
<a name="ln781">	_UpdateIPMarkers();</a>
<a name="ln782">	_UpdateBreakpointMarkers();</a>
<a name="ln783"> </a>
<a name="ln784">	int32 ipIndex = fIPMarkers.FindBinaryInsertionIndex(</a>
<a name="ln785">		MarkerByLinePredicate&lt;Marker&gt;(minLine));</a>
<a name="ln786">	int32 breakpointIndex = fBreakpointMarkers.FindBinaryInsertionIndex(</a>
<a name="ln787">		MarkerByLinePredicate&lt;BreakpointMarker&gt;(minLine));</a>
<a name="ln788"> </a>
<a name="ln789">	Marker* ipMarker = fIPMarkers.ItemAt(ipIndex);</a>
<a name="ln790">	Marker* breakpointMarker = fBreakpointMarkers.ItemAt(breakpointIndex);</a>
<a name="ln791"> </a>
<a name="ln792">	while (ipMarker != NULL &amp;&amp; breakpointMarker != NULL</a>
<a name="ln793">		&amp;&amp; ipMarker-&gt;Line() &lt;= maxLine &amp;&amp; breakpointMarker-&gt;Line() &lt;= maxLine) {</a>
<a name="ln794">		if (breakpointMarker-&gt;Line() &lt;= ipMarker-&gt;Line()) {</a>
<a name="ln795">			markers.AddItem(breakpointMarker);</a>
<a name="ln796">			breakpointMarker = fBreakpointMarkers.ItemAt(++breakpointIndex);</a>
<a name="ln797">		} else {</a>
<a name="ln798">			markers.AddItem(ipMarker);</a>
<a name="ln799">			ipMarker = fIPMarkers.ItemAt(++ipIndex);</a>
<a name="ln800">		}</a>
<a name="ln801">	}</a>
<a name="ln802"> </a>
<a name="ln803">	while (breakpointMarker != NULL &amp;&amp; breakpointMarker-&gt;Line() &lt;= maxLine) {</a>
<a name="ln804">		markers.AddItem(breakpointMarker);</a>
<a name="ln805">		breakpointMarker = fBreakpointMarkers.ItemAt(++breakpointIndex);</a>
<a name="ln806">	}</a>
<a name="ln807"> </a>
<a name="ln808">	while (ipMarker != NULL &amp;&amp; ipMarker-&gt;Line() &lt;= maxLine) {</a>
<a name="ln809">		markers.AddItem(ipMarker);</a>
<a name="ln810">		ipMarker = fIPMarkers.ItemAt(++ipIndex);</a>
<a name="ln811">	}</a>
<a name="ln812">}</a>
<a name="ln813"> </a>
<a name="ln814"> </a>
<a name="ln815">SourceView::MarkerManager::BreakpointMarker*</a>
<a name="ln816">SourceView::MarkerManager::BreakpointMarkerAtLine(uint32 line)</a>
<a name="ln817">{</a>
<a name="ln818">	return fBreakpointMarkers.BinarySearchByKey(line,</a>
<a name="ln819">		&amp;_CompareLineBreakpointMarker);</a>
<a name="ln820">}</a>
<a name="ln821"> </a>
<a name="ln822"> </a>
<a name="ln823">/*static*/ int</a>
<a name="ln824">SourceView::MarkerManager::_CompareMarkers(const Marker* a,</a>
<a name="ln825">	const Marker* b)</a>
<a name="ln826">{</a>
<a name="ln827">	if (a-&gt;Line() &lt; b-&gt;Line())</a>
<a name="ln828">		return -1;</a>
<a name="ln829">	return a-&gt;Line() == b-&gt;Line() ? 0 : 1;</a>
<a name="ln830">}</a>
<a name="ln831"> </a>
<a name="ln832"> </a>
<a name="ln833">/*static*/ int</a>
<a name="ln834">SourceView::MarkerManager::_CompareBreakpointMarkers(const BreakpointMarker* a,</a>
<a name="ln835">	const BreakpointMarker* b)</a>
<a name="ln836">{</a>
<a name="ln837">	if (a-&gt;Line() &lt; b-&gt;Line())</a>
<a name="ln838">		return -1;</a>
<a name="ln839">	return a-&gt;Line() == b-&gt;Line() ? 0 : 1;</a>
<a name="ln840">}</a>
<a name="ln841"> </a>
<a name="ln842"> </a>
<a name="ln843">template&lt;typename MarkerType&gt;</a>
<a name="ln844">/*static*/ int</a>
<a name="ln845">SourceView::MarkerManager::_CompareLineMarkerTemplate(const uint32* line,</a>
<a name="ln846">	const MarkerType* marker)</a>
<a name="ln847">{</a>
<a name="ln848">	if (*line &lt; marker-&gt;Line())</a>
<a name="ln849">		return -1;</a>
<a name="ln850">	return *line == marker-&gt;Line() ? 0 : 1;</a>
<a name="ln851">}</a>
<a name="ln852"> </a>
<a name="ln853"> </a>
<a name="ln854">/*static*/ int</a>
<a name="ln855">SourceView::MarkerManager::_CompareLineMarker(const uint32* line,</a>
<a name="ln856">	const Marker* marker)</a>
<a name="ln857">{</a>
<a name="ln858">	return _CompareLineMarkerTemplate&lt;Marker&gt;(line, marker);</a>
<a name="ln859">}</a>
<a name="ln860"> </a>
<a name="ln861"> </a>
<a name="ln862">/*static*/ int</a>
<a name="ln863">SourceView::MarkerManager::_CompareLineBreakpointMarker(const uint32* line,</a>
<a name="ln864">	const BreakpointMarker* marker)</a>
<a name="ln865">{</a>
<a name="ln866">	return _CompareLineMarkerTemplate&lt;BreakpointMarker&gt;(line, marker);</a>
<a name="ln867">}</a>
<a name="ln868"> </a>
<a name="ln869"> </a>
<a name="ln870">// #pragma mark - MarkerView</a>
<a name="ln871"> </a>
<a name="ln872"> </a>
<a name="ln873">SourceView::MarkerView::MarkerView(SourceView* sourceView, Team* team,</a>
<a name="ln874">	Listener* listener, MarkerManager* manager, FontInfo* fontInfo)</a>
<a name="ln875">	:</a>
<a name="ln876">	BaseView(&quot;source marker view&quot;, sourceView, fontInfo),</a>
<a name="ln877">	fTeam(team),</a>
<a name="ln878">	fListener(listener),</a>
<a name="ln879">	fMarkerManager(manager),</a>
<a name="ln880">	fStackTrace(NULL),</a>
<a name="ln881">	fStackFrame(NULL)</a>
<a name="ln882">{</a>
<a name="ln883">	rgb_color background = ui_color(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln884">	fBreakpointOptionMarker = tint_color(background, B_DARKEN_1_TINT);</a>
<a name="ln885">	fBackgroundColor = tint_color(background, B_LIGHTEN_2_TINT);</a>
<a name="ln886">	SetViewColor(B_TRANSPARENT_COLOR);</a>
<a name="ln887">}</a>
<a name="ln888"> </a>
<a name="ln889"> </a>
<a name="ln890">SourceView::MarkerView::~MarkerView()</a>
<a name="ln891">{</a>
<a name="ln892">}</a>
<a name="ln893"> </a>
<a name="ln894"> </a>
<a name="ln895">void</a>
<a name="ln896">SourceView::MarkerView::SetSourceCode(SourceCode* sourceCode)</a>
<a name="ln897">{</a>
<a name="ln898">	BaseView::SetSourceCode(sourceCode);</a>
<a name="ln899">}</a>
<a name="ln900"> </a>
<a name="ln901"> </a>
<a name="ln902">void</a>
<a name="ln903">SourceView::MarkerView::SetStackTrace(StackTrace* stackTrace)</a>
<a name="ln904">{</a>
<a name="ln905">	Invalidate();</a>
<a name="ln906">}</a>
<a name="ln907"> </a>
<a name="ln908"> </a>
<a name="ln909">void</a>
<a name="ln910">SourceView::MarkerView::SetStackFrame(StackFrame* stackFrame)</a>
<a name="ln911">{</a>
<a name="ln912">	Invalidate();</a>
<a name="ln913">}</a>
<a name="ln914"> </a>
<a name="ln915"> </a>
<a name="ln916">void</a>
<a name="ln917">SourceView::MarkerView::UserBreakpointChanged(UserBreakpoint* breakpoint)</a>
<a name="ln918">{</a>
<a name="ln919">	Invalidate();</a>
<a name="ln920">}</a>
<a name="ln921"> </a>
<a name="ln922"> </a>
<a name="ln923">BSize</a>
<a name="ln924">SourceView::MarkerView::MinSize()</a>
<a name="ln925">{</a>
<a name="ln926">	return BSize(40, TotalHeight());</a>
<a name="ln927">}</a>
<a name="ln928"> </a>
<a name="ln929"> </a>
<a name="ln930">BSize</a>
<a name="ln931">SourceView::MarkerView::MaxSize()</a>
<a name="ln932">{</a>
<a name="ln933">	return BSize(MinSize().width, B_SIZE_UNLIMITED);</a>
<a name="ln934">}</a>
<a name="ln935"> </a>
<a name="ln936">void</a>
<a name="ln937">SourceView::MarkerView::Draw(BRect updateRect)</a>
<a name="ln938">{</a>
<a name="ln939">	SetLowColor(fBackgroundColor);</a>
<a name="ln940">	if (fSourceCode == NULL) {</a>
<a name="ln941">		FillRect(updateRect, B_SOLID_LOW);</a>
<a name="ln942">		return;</a>
<a name="ln943">	}</a>
<a name="ln944"> </a>
<a name="ln945">	// get the lines intersecting with the update rect</a>
<a name="ln946">	int32 minLine, maxLine;</a>
<a name="ln947">	GetLineRange(updateRect, minLine, maxLine);</a>
<a name="ln948">	if (minLine &lt;= maxLine) {</a>
<a name="ln949">		// get the markers in that range</a>
<a name="ln950">		SourceView::MarkerManager::MarkerList markers;</a>
<a name="ln951">		fMarkerManager-&gt;GetMarkers(minLine, maxLine, markers);</a>
<a name="ln952"> </a>
<a name="ln953">		float width = Bounds().Width();</a>
<a name="ln954"> </a>
<a name="ln955">		AutoLocker&lt;SourceCode&gt; sourceLocker(fSourceCode);</a>
<a name="ln956"> </a>
<a name="ln957">		int32 markerIndex = 0;</a>
<a name="ln958">		for (int32 line = minLine; line &lt;= maxLine; line++) {</a>
<a name="ln959">			bool drawBreakpointOptionMarker = true;</a>
<a name="ln960"> </a>
<a name="ln961">			SourceView::MarkerManager::Marker* marker;</a>
<a name="ln962">			FillRect(LineRect(line), B_SOLID_LOW);</a>
<a name="ln963">			while ((marker = markers.ItemAt(markerIndex)) != NULL</a>
<a name="ln964">					&amp;&amp; marker-&gt;Line() == (uint32)line) {</a>
<a name="ln965">				marker-&gt;Draw(this, LineRect(line));</a>
<a name="ln966">				drawBreakpointOptionMarker = false;</a>
<a name="ln967">				markerIndex++;</a>
<a name="ln968">			}</a>
<a name="ln969"> </a>
<a name="ln970">			if (!drawBreakpointOptionMarker)</a>
<a name="ln971">				continue;</a>
<a name="ln972"> </a>
<a name="ln973">			SourceLocation statementStart, statementEnd;</a>
<a name="ln974">			if (!fSourceCode-&gt;GetStatementLocationRange(SourceLocation(line),</a>
<a name="ln975">					statementStart, statementEnd)</a>
<a name="ln976">				|| statementStart.Line() != line) {</a>
<a name="ln977">				continue;</a>
<a name="ln978">			}</a>
<a name="ln979"> </a>
<a name="ln980">			float y = ((float)line + 0.5f) * fFontInfo-&gt;lineHeight;</a>
<a name="ln981">			SetHighColor(fBreakpointOptionMarker);</a>
<a name="ln982">			FillEllipse(BPoint(width - 8, y), 2, 2);</a>
<a name="ln983">		}</a>
<a name="ln984">	}</a>
<a name="ln985"> </a>
<a name="ln986">	float y = (maxLine + 1) * fFontInfo-&gt;lineHeight;</a>
<a name="ln987">	if (y &lt; updateRect.bottom) {</a>
<a name="ln988">		FillRect(BRect(0.0, y, Bounds().right, updateRect.bottom),</a>
<a name="ln989">			B_SOLID_LOW);</a>
<a name="ln990">	}</a>
<a name="ln991"> </a>
<a name="ln992">}</a>
<a name="ln993"> </a>
<a name="ln994"> </a>
<a name="ln995">void</a>
<a name="ln996">SourceView::MarkerView::MouseDown(BPoint where)</a>
<a name="ln997">{</a>
<a name="ln998">	if (fSourceCode == NULL)</a>
<a name="ln999">		return;</a>
<a name="ln1000"> </a>
<a name="ln1001">	int32 line = LineAtOffset(where.y);</a>
<a name="ln1002"> </a>
<a name="ln1003">	Statement* statement;</a>
<a name="ln1004">	if (!fSourceView-&gt;GetStatementForLine(line, statement))</a>
<a name="ln1005">		return;</a>
<a name="ln1006">	BReference&lt;Statement&gt; statementReference(statement, true);</a>
<a name="ln1007"> </a>
<a name="ln1008">	int32 modifiers;</a>
<a name="ln1009">	int32 buttons;</a>
<a name="ln1010">	BMessage* message = Looper()-&gt;CurrentMessage();</a>
<a name="ln1011">	if (message-&gt;FindInt32(&quot;modifiers&quot;, &amp;modifiers) != B_OK)</a>
<a name="ln1012">		modifiers = 0;</a>
<a name="ln1013">	if (message-&gt;FindInt32(&quot;buttons&quot;, &amp;buttons) != B_OK)</a>
<a name="ln1014">		buttons = B_PRIMARY_MOUSE_BUTTON;</a>
<a name="ln1015"> </a>
<a name="ln1016">	SourceView::MarkerManager::BreakpointMarker* marker =</a>
<a name="ln1017">		fMarkerManager-&gt;BreakpointMarkerAtLine(line);</a>
<a name="ln1018">	target_addr_t address = marker != NULL</a>
<a name="ln1019">		? marker-&gt;Address() : statement-&gt;CoveringAddressRange().Start();</a>
<a name="ln1020"> </a>
<a name="ln1021">	if ((buttons &amp; B_PRIMARY_MOUSE_BUTTON) != 0) {</a>
<a name="ln1022">		if ((modifiers &amp; B_SHIFT_KEY) != 0) {</a>
<a name="ln1023">			if (marker != NULL &amp;&amp; !marker-&gt;IsEnabled())</a>
<a name="ln1024">				fListener-&gt;ClearBreakpointRequested(address);</a>
<a name="ln1025">			else</a>
<a name="ln1026">				fListener-&gt;SetBreakpointRequested(address, false);</a>
<a name="ln1027">		} else {</a>
<a name="ln1028">			if (marker != NULL &amp;&amp; marker-&gt;IsEnabled())</a>
<a name="ln1029">				fListener-&gt;ClearBreakpointRequested(address);</a>
<a name="ln1030">			else</a>
<a name="ln1031">				fListener-&gt;SetBreakpointRequested(address, true);</a>
<a name="ln1032">		}</a>
<a name="ln1033">	} else if (marker != NULL &amp;&amp; (buttons &amp; B_SECONDARY_MOUSE_BUTTON) != 0) {</a>
<a name="ln1034">		UserBreakpoint* breakpoint = marker-&gt;Breakpoint();</a>
<a name="ln1035">		BMessage message(MSG_SHOW_BREAKPOINT_EDIT_WINDOW);</a>
<a name="ln1036">		message.AddPointer(&quot;breakpoint&quot;, breakpoint);</a>
<a name="ln1037">		Looper()-&gt;PostMessage(&amp;message);</a>
<a name="ln1038">	}</a>
<a name="ln1039">}</a>
<a name="ln1040"> </a>
<a name="ln1041"> </a>
<a name="ln1042">bool</a>
<a name="ln1043">SourceView::MarkerView::GetToolTipAt(BPoint point, BToolTip** _tip)</a>
<a name="ln1044">{</a>
<a name="ln1045">	if (fSourceCode == NULL)</a>
<a name="ln1046">		return false;</a>
<a name="ln1047"> </a>
<a name="ln1048">	int32 line = LineAtOffset(point.y);</a>
<a name="ln1049">	if (line &lt; 0)</a>
<a name="ln1050">		return false;</a>
<a name="ln1051"> </a>
<a name="ln1052">	AutoLocker&lt;Team&gt; locker(fTeam);</a>
<a name="ln1053">	Statement* statement;</a>
<a name="ln1054">	if (fTeam-&gt;GetStatementAtSourceLocation(fSourceCode,</a>
<a name="ln1055">			SourceLocation(line), statement) != B_OK) {</a>
<a name="ln1056">		return false;</a>
<a name="ln1057">	}</a>
<a name="ln1058">	BReference&lt;Statement&gt; statementReference(statement, true);</a>
<a name="ln1059">	if (statement-&gt;StartSourceLocation().Line() != line)</a>
<a name="ln1060">		return false;</a>
<a name="ln1061"> </a>
<a name="ln1062">	SourceView::MarkerManager::BreakpointMarker* marker =</a>
<a name="ln1063">		fMarkerManager-&gt;BreakpointMarkerAtLine(line);</a>
<a name="ln1064"> </a>
<a name="ln1065">	BString text;</a>
<a name="ln1066">	if (marker == NULL) {</a>
<a name="ln1067">		text.SetToFormat(kEnableBreakpointMessage, line);</a>
<a name="ln1068">	} else if ((modifiers() &amp; B_SHIFT_KEY) != 0) {</a>
<a name="ln1069">		if (!marker-&gt;IsEnabled())</a>
<a name="ln1070">			text.SetToFormat(kClearBreakpointMessage, line);</a>
<a name="ln1071">		else</a>
<a name="ln1072">			text.SetToFormat(kDisableBreakpointMessage, line);</a>
<a name="ln1073">	} else {</a>
<a name="ln1074">		if (marker-&gt;IsEnabled())</a>
<a name="ln1075">			text.SetToFormat(kClearBreakpointMessage, line);</a>
<a name="ln1076">		else</a>
<a name="ln1077">			text.SetToFormat(kEnableBreakpointMessage, line);</a>
<a name="ln1078">	}</a>
<a name="ln1079"> </a>
<a name="ln1080">	if (text.Length() &gt; 0) {</a>
<a name="ln1081">		BTextToolTip* tip = new(std::nothrow) BTextToolTip(text);</a>
<a name="ln1082">		if (tip == NULL)</a>
<a name="ln1083">			return false;</a>
<a name="ln1084"> </a>
<a name="ln1085">		*_tip = tip;</a>
<a name="ln1086">		return true;</a>
<a name="ln1087">	}</a>
<a name="ln1088"> </a>
<a name="ln1089">	return false;</a>
<a name="ln1090">}</a>
<a name="ln1091"> </a>
<a name="ln1092"> </a>
<a name="ln1093">// #pragma mark - TextView</a>
<a name="ln1094"> </a>
<a name="ln1095"> </a>
<a name="ln1096">SourceView::TextView::TextView(SourceView* sourceView, MarkerManager* manager,</a>
<a name="ln1097">	FontInfo* fontInfo)</a>
<a name="ln1098">	:</a>
<a name="ln1099">	BaseView(&quot;source text view&quot;, sourceView, fontInfo),</a>
<a name="ln1100">	fMaxLineWidth(-1),</a>
<a name="ln1101">	fCharacterWidth(fontInfo-&gt;font.StringWidth(&quot;Q&quot;)),</a>
<a name="ln1102">	fSelectionStart(-1, -1),</a>
<a name="ln1103">	fSelectionEnd(-1, -1),</a>
<a name="ln1104">	fSelectionBase(-1, -1),</a>
<a name="ln1105">	fLastClickPoint(-1, -1),</a>
<a name="ln1106">	fLastClickTime(0),</a>
<a name="ln1107">	fClickCount(0),</a>
<a name="ln1108">	fSelectionMode(false),</a>
<a name="ln1109">	fTrackState(kNotTracking),</a>
<a name="ln1110">	fScrollRunner(NULL),</a>
<a name="ln1111">	fMarkerManager(manager)</a>
<a name="ln1112">{</a>
<a name="ln1113">	SetViewColor(B_TRANSPARENT_COLOR);</a>
<a name="ln1114">	fTextColor = ui_color(B_DOCUMENT_TEXT_COLOR);</a>
<a name="ln1115">	SetFlags(Flags() | B_NAVIGABLE);</a>
<a name="ln1116">}</a>
<a name="ln1117"> </a>
<a name="ln1118"> </a>
<a name="ln1119">void</a>
<a name="ln1120">SourceView::TextView::SetSourceCode(SourceCode* sourceCode)</a>
<a name="ln1121">{</a>
<a name="ln1122">	fMaxLineWidth = -1;</a>
<a name="ln1123">	fSelectionStart = fSelectionBase = fSelectionEnd = SelectionPoint(-1, -1);</a>
<a name="ln1124">	fClickCount = 0;</a>
<a name="ln1125">	BaseView::SetSourceCode(sourceCode);</a>
<a name="ln1126">}</a>
<a name="ln1127"> </a>
<a name="ln1128"> </a>
<a name="ln1129">void</a>
<a name="ln1130">SourceView::TextView::UserBreakpointChanged(UserBreakpoint* breakpoint)</a>
<a name="ln1131">{</a>
<a name="ln1132">	Invalidate();</a>
<a name="ln1133">}</a>
<a name="ln1134"> </a>
<a name="ln1135"> </a>
<a name="ln1136">BSize</a>
<a name="ln1137">SourceView::TextView::MinSize()</a>
<a name="ln1138">{</a>
<a name="ln1139">	return BSize(kLeftTextMargin + _MaxLineWidth() - 1, TotalHeight());</a>
<a name="ln1140">}</a>
<a name="ln1141"> </a>
<a name="ln1142"> </a>
<a name="ln1143">BSize</a>
<a name="ln1144">SourceView::TextView::MaxSize()</a>
<a name="ln1145">{</a>
<a name="ln1146">	return BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED);</a>
<a name="ln1147">}</a>
<a name="ln1148"> </a>
<a name="ln1149"> </a>
<a name="ln1150">void</a>
<a name="ln1151">SourceView::TextView::Draw(BRect updateRect)</a>
<a name="ln1152">{</a>
<a name="ln1153">	if (fSourceCode == NULL) {</a>
<a name="ln1154">		SetLowColor(ui_color(B_DOCUMENT_BACKGROUND_COLOR));</a>
<a name="ln1155">		FillRect(updateRect, B_SOLID_LOW);</a>
<a name="ln1156">		return;</a>
<a name="ln1157">	}</a>
<a name="ln1158"> </a>
<a name="ln1159">	// get the lines intersecting with the update rect</a>
<a name="ln1160">	int32 minLine, maxLine;</a>
<a name="ln1161">	GetLineRange(updateRect, minLine, maxLine);</a>
<a name="ln1162">	SourceView::MarkerManager::MarkerList markers;</a>
<a name="ln1163">	fMarkerManager-&gt;GetMarkers(minLine, maxLine, markers);</a>
<a name="ln1164"> </a>
<a name="ln1165">	// draw the affected lines</a>
<a name="ln1166">	SetHighColor(fTextColor);</a>
<a name="ln1167">	SetFont(&amp;fFontInfo-&gt;font);</a>
<a name="ln1168">	SourceView::MarkerManager::Marker* marker;</a>
<a name="ln1169">	SourceView::MarkerManager::InstructionPointerMarker* ipMarker;</a>
<a name="ln1170">	int32 markerIndex = 0;</a>
<a name="ln1171">	float y;</a>
<a name="ln1172"> </a>
<a name="ln1173">	// syntax line data</a>
<a name="ln1174">	int32 columns[kMaxHighlightsPerLine];</a>
<a name="ln1175">	syntax_highlight_type types[kMaxHighlightsPerLine];</a>
<a name="ln1176">	SyntaxHighlightInfo* info = fSourceView-&gt;fCurrentSyntaxInfo;</a>
<a name="ln1177"> </a>
<a name="ln1178">	for (int32 i = minLine; i &lt;= maxLine; i++) {</a>
<a name="ln1179">		int32 syntaxCount = 0;</a>
<a name="ln1180">		if (info != NULL) {</a>
<a name="ln1181">			syntaxCount = info-&gt;GetLineHighlightRanges(i, columns, types,</a>
<a name="ln1182">				kMaxHighlightsPerLine);</a>
<a name="ln1183">		}</a>
<a name="ln1184"> </a>
<a name="ln1185">		SetLowColor(ui_color(B_DOCUMENT_BACKGROUND_COLOR));</a>
<a name="ln1186">		y = i * fFontInfo-&gt;lineHeight;</a>
<a name="ln1187"> </a>
<a name="ln1188">		FillRect(BRect(0.0, y, kLeftTextMargin, y + fFontInfo-&gt;lineHeight),</a>
<a name="ln1189">			B_SOLID_LOW);</a>
<a name="ln1190">		for (int32 j = markerIndex; j &lt; markers.CountItems(); j++) {</a>
<a name="ln1191">			marker = markers.ItemAt(j);</a>
<a name="ln1192">			 if (marker-&gt;Line() &lt; (uint32)i) {</a>
<a name="ln1193">				++markerIndex;</a>
<a name="ln1194">			 	continue;</a>
<a name="ln1195">			 } else if (marker-&gt;Line() == (uint32)i) {</a>
<a name="ln1196">			 	++markerIndex;</a>
<a name="ln1197">			 	 ipMarker = dynamic_cast&lt;SourceView::MarkerManager</a>
<a name="ln1198">			 	 	::InstructionPointerMarker*&gt;(marker);</a>
<a name="ln1199">			 	if (ipMarker != NULL) {</a>
<a name="ln1200">			 		if (ipMarker-&gt;IsCurrentIP())</a>
<a name="ln1201">			 			SetLowColor(96, 216, 216, 255);</a>
<a name="ln1202">			 		else</a>
<a name="ln1203">			 			SetLowColor(216, 216, 216, 255);</a>
<a name="ln1204"> </a>
<a name="ln1205">			 	} else</a>
<a name="ln1206">					SetLowColor(255, 255, 0, 255);</a>
<a name="ln1207">				break;</a>
<a name="ln1208">			 } else</a>
<a name="ln1209">			 	break;</a>
<a name="ln1210">		}</a>
<a name="ln1211"> </a>
<a name="ln1212">		FillRect(BRect(kLeftTextMargin, y, Bounds().right,</a>
<a name="ln1213">			y + fFontInfo-&gt;lineHeight - 1), B_SOLID_LOW);</a>
<a name="ln1214"> </a>
<a name="ln1215">		syntax_highlight_type currentHighlight = SYNTAX_HIGHLIGHT_NONE;</a>
<a name="ln1216">		SetHighColor(kSyntaxColors[currentHighlight]);</a>
<a name="ln1217">		const char* lineData = fSourceCode-&gt;LineAt(i);</a>
<a name="ln1218">		int32 lineLength = fSourceCode-&gt;LineLengthAt(i);</a>
<a name="ln1219">		BPoint linePoint(kLeftTextMargin, y + fFontInfo-&gt;fontHeight.ascent);</a>
<a name="ln1220">		int32 lineOffset = 0;</a>
<a name="ln1221">		int32 currentColumn = 0;</a>
<a name="ln1222">		for (int32 j = 0; j &lt; syntaxCount; j++) {</a>
<a name="ln1223">			int32 length = columns[j] - lineOffset;</a>
<a name="ln1224">			if (length != 0) {</a>
<a name="ln1225">				_DrawLineSyntaxSection(lineData + lineOffset, length,</a>
<a name="ln1226">					currentColumn, linePoint);</a>
<a name="ln1227">				lineOffset += length;</a>
<a name="ln1228">			}</a>
<a name="ln1229">			currentHighlight = types[j];</a>
<a name="ln1230">			SetHighColor(kSyntaxColors[currentHighlight]);</a>
<a name="ln1231">		}</a>
<a name="ln1232"> </a>
<a name="ln1233">		// draw remainder, if any.</a>
<a name="ln1234">		if (lineOffset &lt; lineLength) {</a>
<a name="ln1235">			_DrawLineSyntaxSection(lineData + lineOffset,</a>
<a name="ln1236">				lineLength - lineOffset, currentColumn, linePoint);</a>
<a name="ln1237">		}</a>
<a name="ln1238">	}</a>
<a name="ln1239"> </a>
<a name="ln1240">	y = (maxLine + 1) * fFontInfo-&gt;lineHeight;</a>
<a name="ln1241">	if (y &lt; updateRect.bottom) {</a>
<a name="ln1242">		SetLowColor(ui_color(B_DOCUMENT_BACKGROUND_COLOR));</a>
<a name="ln1243">		FillRect(BRect(0.0, y, Bounds().right, updateRect.bottom),</a>
<a name="ln1244">			B_SOLID_LOW);</a>
<a name="ln1245">	}</a>
<a name="ln1246"> </a>
<a name="ln1247">	if (fSelectionStart.line != -1 &amp;&amp; fSelectionEnd.line != -1) {</a>
<a name="ln1248">		PushState();</a>
<a name="ln1249">		BRegion selectionRegion;</a>
<a name="ln1250">		_GetSelectionRegion(selectionRegion);</a>
<a name="ln1251">		SetDrawingMode(B_OP_INVERT);</a>
<a name="ln1252">		FillRegion(&amp;selectionRegion, B_SOLID_HIGH);</a>
<a name="ln1253">		PopState();</a>
<a name="ln1254">	}</a>
<a name="ln1255">}</a>
<a name="ln1256"> </a>
<a name="ln1257"> </a>
<a name="ln1258">void</a>
<a name="ln1259">SourceView::TextView::KeyDown(const char* bytes, int32 numBytes)</a>
<a name="ln1260">{</a>
<a name="ln1261">	switch(bytes[0]) {</a>
<a name="ln1262">		case B_UP_ARROW:</a>
<a name="ln1263">			_ScrollByLines(-1);</a>
<a name="ln1264">			break;</a>
<a name="ln1265"> </a>
<a name="ln1266">		case B_DOWN_ARROW:</a>
<a name="ln1267">			_ScrollByLines(1);</a>
<a name="ln1268">			break;</a>
<a name="ln1269"> </a>
<a name="ln1270">		case B_PAGE_UP:</a>
<a name="ln1271">			_ScrollByPages(-1);</a>
<a name="ln1272">			break;</a>
<a name="ln1273"> </a>
<a name="ln1274">		case B_PAGE_DOWN:</a>
<a name="ln1275">			_ScrollByPages(1);</a>
<a name="ln1276">			break;</a>
<a name="ln1277"> </a>
<a name="ln1278">		case B_HOME:</a>
<a name="ln1279">			_ScrollToTop();</a>
<a name="ln1280">			break;</a>
<a name="ln1281"> </a>
<a name="ln1282">		case B_END:</a>
<a name="ln1283">			_ScrollToBottom();</a>
<a name="ln1284">			break;</a>
<a name="ln1285">	}</a>
<a name="ln1286"> </a>
<a name="ln1287">	SourceView::BaseView::KeyDown(bytes, numBytes);</a>
<a name="ln1288">}</a>
<a name="ln1289"> </a>
<a name="ln1290"> </a>
<a name="ln1291">void</a>
<a name="ln1292">SourceView::TextView::MakeFocus(bool isFocused)</a>
<a name="ln1293">{</a>
<a name="ln1294">	fSourceView-&gt;HighlightBorder(isFocused);</a>
<a name="ln1295"> </a>
<a name="ln1296">	SourceView::BaseView::MakeFocus(isFocused);</a>
<a name="ln1297">}</a>
<a name="ln1298"> </a>
<a name="ln1299"> </a>
<a name="ln1300">void</a>
<a name="ln1301">SourceView::TextView::MessageReceived(BMessage* message)</a>
<a name="ln1302">{</a>
<a name="ln1303">	switch (message-&gt;what)</a>
<a name="ln1304">	{</a>
<a name="ln1305">		case B_COPY:</a>
<a name="ln1306">			_CopySelectionToClipboard();</a>
<a name="ln1307">			break;</a>
<a name="ln1308"> </a>
<a name="ln1309">		case B_SELECT_ALL:</a>
<a name="ln1310">			fSelectionStart.line = 0;</a>
<a name="ln1311">			fSelectionStart.offset = 0;</a>
<a name="ln1312">			fSelectionEnd.line = fSourceCode-&gt;CountLines() - 1;</a>
<a name="ln1313">			fSelectionEnd.offset = fSourceCode-&gt;LineLengthAt(</a>
<a name="ln1314">				fSelectionEnd.line);</a>
<a name="ln1315">			Invalidate();</a>
<a name="ln1316">			break;</a>
<a name="ln1317"> </a>
<a name="ln1318">		case MSG_TEXTVIEW_AUTOSCROLL:</a>
<a name="ln1319">			_HandleAutoScroll();</a>
<a name="ln1320">			break;</a>
<a name="ln1321"> </a>
<a name="ln1322">		default:</a>
<a name="ln1323">			SourceView::BaseView::MessageReceived(message);</a>
<a name="ln1324">			break;</a>
<a name="ln1325">	}</a>
<a name="ln1326">}</a>
<a name="ln1327"> </a>
<a name="ln1328"> </a>
<a name="ln1329">void</a>
<a name="ln1330">SourceView::TextView::MouseDown(BPoint where)</a>
<a name="ln1331">{</a>
<a name="ln1332">	if (fSourceCode == NULL)</a>
<a name="ln1333">		return;</a>
<a name="ln1334"> </a>
<a name="ln1335">	int32 buttons;</a>
<a name="ln1336">	if (Looper()-&gt;CurrentMessage()-&gt;FindInt32(&quot;buttons&quot;, &amp;buttons) != B_OK)</a>
<a name="ln1337">		buttons = B_PRIMARY_MOUSE_BUTTON;</a>
<a name="ln1338"> </a>
<a name="ln1339"> </a>
<a name="ln1340">	if (buttons == B_PRIMARY_MOUSE_BUTTON) {</a>
<a name="ln1341">		if (!IsFocus())</a>
<a name="ln1342">			MakeFocus(true);</a>
<a name="ln1343">		fTrackState = kTracking;</a>
<a name="ln1344"> </a>
<a name="ln1345">		// don't reset the selection if the user clicks within the</a>
<a name="ln1346">		// current selection range</a>
<a name="ln1347">		BRegion region;</a>
<a name="ln1348">		_GetSelectionRegion(region);</a>
<a name="ln1349">		bigtime_t clickTime = system_time();</a>
<a name="ln1350">		SelectionPoint point = _SelectionPointAt(where);</a>
<a name="ln1351">		fLastClickPoint = point;</a>
<a name="ln1352">		bigtime_t clickSpeed = 0;</a>
<a name="ln1353">		get_click_speed(&amp;clickSpeed);</a>
<a name="ln1354">		if (clickTime - fLastClickTime &lt; clickSpeed</a>
<a name="ln1355">				&amp;&amp; fSelectionBase == point) {</a>
<a name="ln1356">			if (fClickCount &gt; 3) {</a>
<a name="ln1357">				fClickCount = 0;</a>
<a name="ln1358">				fLastClickTime = 0;</a>
<a name="ln1359">			} else {</a>
<a name="ln1360">				fClickCount++;</a>
<a name="ln1361">				fLastClickTime = clickTime;</a>
<a name="ln1362">			}</a>
<a name="ln1363">		} else {</a>
<a name="ln1364">			fClickCount = 1;</a>
<a name="ln1365">			fLastClickTime = clickTime;</a>
<a name="ln1366">		}</a>
<a name="ln1367"> </a>
<a name="ln1368">		if (fClickCount == 2) {</a>
<a name="ln1369">			_SelectWordAt(point);</a>
<a name="ln1370">			fSelectionMode = true;</a>
<a name="ln1371">		} else if (fClickCount == 3) {</a>
<a name="ln1372">			_SelectLineAt(point);</a>
<a name="ln1373">			fSelectionMode = true;</a>
<a name="ln1374">		} else if (!region.Contains(where)) {</a>
<a name="ln1375">			fSelectionBase = fSelectionStart = fSelectionEnd = point;</a>
<a name="ln1376">			fSelectionMode = true;</a>
<a name="ln1377">			Invalidate();</a>
<a name="ln1378">			SetMouseEventMask(B_POINTER_EVENTS, B_NO_POINTER_HISTORY);</a>
<a name="ln1379">		}</a>
<a name="ln1380">	} else if (buttons == B_SECONDARY_MOUSE_BUTTON) {</a>
<a name="ln1381">		int32 line = LineAtOffset(where.y);</a>
<a name="ln1382">		if (line &lt; 0)</a>
<a name="ln1383">			return;</a>
<a name="ln1384"> </a>
<a name="ln1385">		::Team* team = fSourceView-&gt;fTeam;</a>
<a name="ln1386">		AutoLocker&lt;Team&gt; locker(team);</a>
<a name="ln1387">		::Thread* activeThread = fSourceView-&gt;fActiveThread;</a>
<a name="ln1388"> </a>
<a name="ln1389">		if (activeThread == NULL)</a>
<a name="ln1390">			return;</a>
<a name="ln1391">		else if (activeThread-&gt;State() != THREAD_STATE_STOPPED)</a>
<a name="ln1392">			return;</a>
<a name="ln1393"> </a>
<a name="ln1394">		BPopUpMenu* menu = new(std::nothrow) BPopUpMenu(&quot;&quot;);</a>
<a name="ln1395">		if (menu == NULL)</a>
<a name="ln1396">			return;</a>
<a name="ln1397">		ObjectDeleter&lt;BPopUpMenu&gt; menuDeleter(menu);</a>
<a name="ln1398"> </a>
<a name="ln1399">		if (!_AddGeneralActions(menu, line))</a>
<a name="ln1400">			return;</a>
<a name="ln1401"> </a>
<a name="ln1402">		if (!_AddFlowControlActions(menu, line))</a>
<a name="ln1403">			return;</a>
<a name="ln1404"> </a>
<a name="ln1405">		menuDeleter.Detach();</a>
<a name="ln1406"> </a>
<a name="ln1407">		BPoint screenWhere(where);</a>
<a name="ln1408">		ConvertToScreen(&amp;screenWhere);</a>
<a name="ln1409">		menu-&gt;SetTargetForItems(fSourceView);</a>
<a name="ln1410">		BRect mouseRect(screenWhere, screenWhere);</a>
<a name="ln1411">		mouseRect.InsetBy(-4.0, -4.0);</a>
<a name="ln1412">		menu-&gt;Go(screenWhere, true, false, mouseRect, true);</a>
<a name="ln1413">	}</a>
<a name="ln1414">}</a>
<a name="ln1415"> </a>
<a name="ln1416"> </a>
<a name="ln1417">void</a>
<a name="ln1418">SourceView::TextView::MouseMoved(BPoint where, uint32 transit,</a>
<a name="ln1419">	const BMessage* dragMessage)</a>
<a name="ln1420">{</a>
<a name="ln1421">	BRegion region;</a>
<a name="ln1422">	if (fSelectionMode) {</a>
<a name="ln1423">		BRegion oldRegion;</a>
<a name="ln1424">		_GetSelectionRegion(oldRegion);</a>
<a name="ln1425">		SelectionPoint point = _SelectionPointAt(where);</a>
<a name="ln1426">		if (point.line &lt; 0)</a>
<a name="ln1427">			return;</a>
<a name="ln1428"> </a>
<a name="ln1429">		switch (transit) {</a>
<a name="ln1430">			case B_INSIDE_VIEW:</a>
<a name="ln1431">			case B_OUTSIDE_VIEW:</a>
<a name="ln1432">				if (fClickCount == 2)</a>
<a name="ln1433">					_SelectWordAt(point, true);</a>
<a name="ln1434">				else if (fClickCount == 3)</a>
<a name="ln1435">					_SelectLineAt(point, true);</a>
<a name="ln1436">				else {</a>
<a name="ln1437">					if (point.line &gt; fSelectionBase.line) {</a>
<a name="ln1438">						fSelectionStart = fSelectionBase;</a>
<a name="ln1439">						fSelectionEnd = point;</a>
<a name="ln1440">					} else if (point.line &lt; fSelectionBase.line) {</a>
<a name="ln1441">						fSelectionEnd = fSelectionBase;</a>
<a name="ln1442">						fSelectionStart = point;</a>
<a name="ln1443">					} else if (point.offset &gt; fSelectionBase.offset) {</a>
<a name="ln1444">						fSelectionStart = fSelectionBase;</a>
<a name="ln1445">						fSelectionEnd = point;</a>
<a name="ln1446">					} else {</a>
<a name="ln1447">						fSelectionEnd = fSelectionBase;</a>
<a name="ln1448">						fSelectionStart = point;</a>
<a name="ln1449">					}</a>
<a name="ln1450">				}</a>
<a name="ln1451">				break;</a>
<a name="ln1452"> </a>
<a name="ln1453">			case B_EXITED_VIEW:</a>
<a name="ln1454">				fScrollRunner = new BMessageRunner(BMessenger(this),</a>
<a name="ln1455">					new BMessage(MSG_TEXTVIEW_AUTOSCROLL), kScrollTimer);</a>
<a name="ln1456">				break;</a>
<a name="ln1457"> </a>
<a name="ln1458">			case B_ENTERED_VIEW:</a>
<a name="ln1459">				delete fScrollRunner;</a>
<a name="ln1460">				fScrollRunner = NULL;</a>
<a name="ln1461">				break;</a>
<a name="ln1462">		}</a>
<a name="ln1463">		_GetSelectionRegion(region);</a>
<a name="ln1464">		region.Include(&amp;oldRegion);</a>
<a name="ln1465">		Invalidate(&amp;region);</a>
<a name="ln1466">	} else if (fTrackState == kTracking) {</a>
<a name="ln1467">		_GetSelectionRegion(region);</a>
<a name="ln1468">		if (region.CountRects() &gt; 0) {</a>
<a name="ln1469">			BString text;</a>
<a name="ln1470">			_GetSelectionText(text);</a>
<a name="ln1471">			BMessage message;</a>
<a name="ln1472">			message.AddData (&quot;text/plain&quot;, B_MIME_TYPE, text.String(),</a>
<a name="ln1473">				text.Length());</a>
<a name="ln1474">			BString clipName;</a>
<a name="ln1475">			if (fSourceCode-&gt;GetSourceFile() != NULL)</a>
<a name="ln1476">				clipName = fSourceCode-&gt;GetSourceFile()-&gt;Name();</a>
<a name="ln1477">			else if (fSourceCode-&gt;GetSourceLanguage() != NULL)</a>
<a name="ln1478">				clipName = fSourceCode-&gt;GetSourceLanguage()-&gt;Name();</a>
<a name="ln1479">			else</a>
<a name="ln1480">				clipName = &quot;Text&quot;;</a>
<a name="ln1481">			clipName &lt;&lt; &quot; clipping&quot;;</a>
<a name="ln1482">			message.AddString (&quot;be:clip_name&quot;, clipName.String());</a>
<a name="ln1483">			message.AddInt32 (&quot;be:actions&quot;, B_COPY_TARGET);</a>
<a name="ln1484">			BRect dragRect = region.Frame();</a>
<a name="ln1485">			BRect visibleRect = fSourceView-&gt;Bounds();</a>
<a name="ln1486">			if (dragRect.Height() &gt; visibleRect.Height()) {</a>
<a name="ln1487">				dragRect.top = 0;</a>
<a name="ln1488">				dragRect.bottom = visibleRect.Height();</a>
<a name="ln1489">			}</a>
<a name="ln1490">			if (dragRect.Width() &gt; visibleRect.Width()) {</a>
<a name="ln1491">				dragRect.left = 0;</a>
<a name="ln1492">				dragRect.right = visibleRect.Width();</a>
<a name="ln1493">			}</a>
<a name="ln1494">			DragMessage(&amp;message, dragRect);</a>
<a name="ln1495">			fTrackState = kDragging;</a>
<a name="ln1496">		}</a>
<a name="ln1497">	}</a>
<a name="ln1498">}</a>
<a name="ln1499"> </a>
<a name="ln1500"> </a>
<a name="ln1501">void</a>
<a name="ln1502">SourceView::TextView::MouseUp(BPoint where)</a>
<a name="ln1503">{</a>
<a name="ln1504">	fSelectionMode = false;</a>
<a name="ln1505">	if (fTrackState == kTracking &amp;&amp; fClickCount &lt; 2) {</a>
<a name="ln1506"> </a>
<a name="ln1507">		// if we clicked without dragging or double/triple clicking,</a>
<a name="ln1508">		// clear the current selection (if any)</a>
<a name="ln1509">		SelectionPoint point = _SelectionPointAt(where);</a>
<a name="ln1510">		if (fLastClickPoint == point) {</a>
<a name="ln1511">			fSelectionBase = fSelectionStart = fSelectionEnd;</a>
<a name="ln1512">			Invalidate();</a>
<a name="ln1513">		}</a>
<a name="ln1514">	}</a>
<a name="ln1515">	delete fScrollRunner;</a>
<a name="ln1516">	fScrollRunner = NULL;</a>
<a name="ln1517">	fTrackState = kNotTracking;</a>
<a name="ln1518">}</a>
<a name="ln1519"> </a>
<a name="ln1520"> </a>
<a name="ln1521">float</a>
<a name="ln1522">SourceView::TextView::_MaxLineWidth()</a>
<a name="ln1523">{</a>
<a name="ln1524">	if (fMaxLineWidth &gt;= 0)</a>
<a name="ln1525">		return fMaxLineWidth;</a>
<a name="ln1526"> </a>
<a name="ln1527">	fMaxLineWidth = 0;</a>
<a name="ln1528">	if (fSourceCode != NULL) {</a>
<a name="ln1529">		for (int32 i = 0; const char* line = fSourceCode-&gt;LineAt(i); i++)</a>
<a name="ln1530">			fMaxLineWidth = std::max(fMaxLineWidth, _FormattedLineWidth(line));</a>
<a name="ln1531">	}</a>
<a name="ln1532"> </a>
<a name="ln1533">	return fMaxLineWidth;</a>
<a name="ln1534">}</a>
<a name="ln1535"> </a>
<a name="ln1536"> </a>
<a name="ln1537">float</a>
<a name="ln1538">SourceView::TextView::_FormattedLineWidth(const char* line) const</a>
<a name="ln1539">{</a>
<a name="ln1540">	int32 column = 0;</a>
<a name="ln1541">	int32 i = 0;</a>
<a name="ln1542">	for (; line[i] != '\0'; i++) {</a>
<a name="ln1543">		if (line[i] == '\t')</a>
<a name="ln1544">			column = _NextTabStop(column);</a>
<a name="ln1545">		else</a>
<a name="ln1546">			++column;</a>
<a name="ln1547">	}</a>
<a name="ln1548"> </a>
<a name="ln1549">	return column * fCharacterWidth;</a>
<a name="ln1550">}</a>
<a name="ln1551"> </a>
<a name="ln1552"> </a>
<a name="ln1553">void</a>
<a name="ln1554">SourceView::TextView::_DrawLineSyntaxSection(const char* line, int32 length,</a>
<a name="ln1555">	int32&amp; _column, BPoint&amp; _offset)</a>
<a name="ln1556">{</a>
<a name="ln1557">	int32 start = 0;</a>
<a name="ln1558">	int32 currentLength = 0;</a>
<a name="ln1559">	for (int32 i = 0; i &lt; length; i++) {</a>
<a name="ln1560">		if (line[i] == '\t') {</a>
<a name="ln1561">			currentLength = i - start;</a>
<a name="ln1562">			if (currentLength != 0)</a>
<a name="ln1563">				_DrawLineSegment(line + start, currentLength, _offset);</a>
<a name="ln1564"> </a>
<a name="ln1565">			// set new starting offset to the position after this tab</a>
<a name="ln1566">			start = i + 1;</a>
<a name="ln1567">			int32 nextTabStop = _NextTabStop(_column);</a>
<a name="ln1568">			int32 diff = nextTabStop - _column;</a>
<a name="ln1569">			_column = nextTabStop;</a>
<a name="ln1570">			_offset.x += diff * fCharacterWidth;</a>
<a name="ln1571">		} else</a>
<a name="ln1572">			_column++;</a>
<a name="ln1573">	}</a>
<a name="ln1574"> </a>
<a name="ln1575">	// draw last segment</a>
<a name="ln1576">	currentLength = length - start;</a>
<a name="ln1577">	if (currentLength &gt; 0)</a>
<a name="ln1578">		_DrawLineSegment(line + start, currentLength, _offset);</a>
<a name="ln1579">}</a>
<a name="ln1580"> </a>
<a name="ln1581"> </a>
<a name="ln1582">void</a>
<a name="ln1583">SourceView::TextView::_DrawLineSegment(const char* line, int32 length,</a>
<a name="ln1584">	BPoint&amp; _offset)</a>
<a name="ln1585">{</a>
<a name="ln1586">	DrawString(line, length, _offset);</a>
<a name="ln1587">	_offset.x += fCharacterWidth * length;</a>
<a name="ln1588">}</a>
<a name="ln1589"> </a>
<a name="ln1590"> </a>
<a name="ln1591">int32</a>
<a name="ln1592">SourceView::TextView::_NextTabStop(int32 column) const</a>
<a name="ln1593">{</a>
<a name="ln1594">	return (column / kSpacesPerTab + 1) * kSpacesPerTab;</a>
<a name="ln1595">}</a>
<a name="ln1596"> </a>
<a name="ln1597"> </a>
<a name="ln1598">float</a>
<a name="ln1599">SourceView::TextView::_FormattedPosition(int32 line, int32 offset) const</a>
<a name="ln1600">{</a>
<a name="ln1601">	int32 column = 0;</a>
<a name="ln1602">	for (int32 i = 0; i &lt; offset; i++) {</a>
<a name="ln1603">		if (fSourceCode-&gt;LineAt(line)[i] == '\t')</a>
<a name="ln1604">			column = _NextTabStop(column);</a>
<a name="ln1605">		else</a>
<a name="ln1606">			++column;</a>
<a name="ln1607">	}</a>
<a name="ln1608"> </a>
<a name="ln1609">	return column * fCharacterWidth;</a>
<a name="ln1610">}</a>
<a name="ln1611"> </a>
<a name="ln1612"> </a>
<a name="ln1613">SourceView::TextView::SelectionPoint</a>
<a name="ln1614">SourceView::TextView::_SelectionPointAt(BPoint where) const</a>
<a name="ln1615">{</a>
<a name="ln1616">	int32 line = LineAtOffset(where.y);</a>
<a name="ln1617">	int32 offset = -1;</a>
<a name="ln1618">	if (line &gt;= 0) {</a>
<a name="ln1619">		int32 column = 0;</a>
<a name="ln1620">		int32 lineLength = fSourceCode-&gt;LineLengthAt(line);</a>
<a name="ln1621">		const char* sourceLine = fSourceCode-&gt;LineAt(line);</a>
<a name="ln1622"> </a>
<a name="ln1623">		for (int32 i = 0; i &lt; lineLength; i++) {</a>
<a name="ln1624">			if (sourceLine[i] == '\t')</a>
<a name="ln1625">				column = _NextTabStop(column);</a>
<a name="ln1626">			else</a>
<a name="ln1627">				++column;</a>
<a name="ln1628"> </a>
<a name="ln1629">			if (column * fCharacterWidth &gt; where.x) {</a>
<a name="ln1630">				offset = i;</a>
<a name="ln1631">				break;</a>
<a name="ln1632">			}</a>
<a name="ln1633">		}</a>
<a name="ln1634"> </a>
<a name="ln1635">		if (offset &lt; 0)</a>
<a name="ln1636">			offset = lineLength;</a>
<a name="ln1637">	}</a>
<a name="ln1638"> </a>
<a name="ln1639">	return SelectionPoint(line, offset);</a>
<a name="ln1640">}</a>
<a name="ln1641"> </a>
<a name="ln1642"> </a>
<a name="ln1643">void</a>
<a name="ln1644">SourceView::TextView::_GetSelectionRegion(BRegion &amp;region) const</a>
<a name="ln1645">{</a>
<a name="ln1646">	if (fSelectionStart.line == -1 &amp;&amp; fSelectionEnd.line == -1)</a>
<a name="ln1647">		return;</a>
<a name="ln1648"> </a>
<a name="ln1649">	BRect selectionRect;</a>
<a name="ln1650"> </a>
<a name="ln1651">	if (fSelectionStart.line == fSelectionEnd.line) {</a>
<a name="ln1652">		if (fSelectionStart.offset != fSelectionEnd.offset) {</a>
<a name="ln1653">			selectionRect.left = _FormattedPosition(fSelectionStart.line,</a>
<a name="ln1654">				fSelectionStart.offset);</a>
<a name="ln1655">			selectionRect.top = fSelectionStart.line * fFontInfo-&gt;lineHeight;</a>
<a name="ln1656">			selectionRect.right = _FormattedPosition(fSelectionEnd.line,</a>
<a name="ln1657">				fSelectionEnd.offset);</a>
<a name="ln1658">			selectionRect.bottom = selectionRect.top + fFontInfo-&gt;lineHeight;</a>
<a name="ln1659">			region.Include(selectionRect);</a>
<a name="ln1660">		}</a>
<a name="ln1661">	} else {</a>
<a name="ln1662">		// add rect for starting line</a>
<a name="ln1663">		selectionRect.left = _FormattedPosition(fSelectionStart.line,</a>
<a name="ln1664">			fSelectionStart.offset);</a>
<a name="ln1665">		selectionRect.top = fSelectionStart.line * fFontInfo-&gt;lineHeight;</a>
<a name="ln1666">		selectionRect.right = Bounds().right;</a>
<a name="ln1667">		selectionRect.bottom = selectionRect.top + fFontInfo-&gt;lineHeight;</a>
<a name="ln1668">		region.Include(selectionRect);</a>
<a name="ln1669"> </a>
<a name="ln1670">		// compute rect for all lines in middle of selection</a>
<a name="ln1671">		if (fSelectionEnd.line - fSelectionStart.line &gt; 1) {</a>
<a name="ln1672">			selectionRect.left = 0.0;</a>
<a name="ln1673">			selectionRect.top = (fSelectionStart.line + 1)</a>
<a name="ln1674">				* fFontInfo-&gt;lineHeight;</a>
<a name="ln1675">			selectionRect.right = Bounds().right;</a>
<a name="ln1676">			selectionRect.bottom = fSelectionEnd.line * fFontInfo-&gt;lineHeight;</a>
<a name="ln1677">			region.Include(selectionRect);</a>
<a name="ln1678">		}</a>
<a name="ln1679"> </a>
<a name="ln1680">		// add rect for last line (if needed)</a>
<a name="ln1681">		if (fSelectionEnd.offset &gt; 0) {</a>
<a name="ln1682">			selectionRect.left = 0.0;</a>
<a name="ln1683">			selectionRect.top = fSelectionEnd.line * fFontInfo-&gt;lineHeight;</a>
<a name="ln1684">			selectionRect.right = _FormattedPosition(fSelectionEnd.line,</a>
<a name="ln1685">				fSelectionEnd.offset);</a>
<a name="ln1686">			selectionRect.bottom = selectionRect.top + fFontInfo-&gt;lineHeight;</a>
<a name="ln1687">			region.Include(selectionRect);</a>
<a name="ln1688">		}</a>
<a name="ln1689">	}</a>
<a name="ln1690">	region.OffsetBy(kLeftTextMargin, 0.0);</a>
<a name="ln1691">}</a>
<a name="ln1692"> </a>
<a name="ln1693"> </a>
<a name="ln1694">void</a>
<a name="ln1695">SourceView::TextView::_GetSelectionText(BString&amp; text) const</a>
<a name="ln1696">{</a>
<a name="ln1697">	if (fSelectionStart.line == -1 || fSelectionEnd.line == -1)</a>
<a name="ln1698">		return;</a>
<a name="ln1699"> </a>
<a name="ln1700">	if (fSelectionStart.line == fSelectionEnd.line) {</a>
<a name="ln1701">		text.SetTo(fSourceCode-&gt;LineAt(fSelectionStart.line)</a>
<a name="ln1702">			+ fSelectionStart.offset, fSelectionEnd.offset</a>
<a name="ln1703">			- fSelectionStart.offset);</a>
<a name="ln1704">	} else {</a>
<a name="ln1705">		text.SetTo(fSourceCode-&gt;LineAt(fSelectionStart.line)</a>
<a name="ln1706">			+ fSelectionStart.offset);</a>
<a name="ln1707">		text &lt;&lt; &quot;\n&quot;;</a>
<a name="ln1708">		for (int32 i = fSelectionStart.line + 1; i &lt; fSelectionEnd.line; i++)</a>
<a name="ln1709">			text &lt;&lt; fSourceCode-&gt;LineAt(i) &lt;&lt; &quot;\n&quot;;</a>
<a name="ln1710">		text.Append(fSourceCode-&gt;LineAt(fSelectionEnd.line),</a>
<a name="ln1711">			fSelectionEnd.offset);</a>
<a name="ln1712">	}</a>
<a name="ln1713">}</a>
<a name="ln1714"> </a>
<a name="ln1715"> </a>
<a name="ln1716">void</a>
<a name="ln1717">SourceView::TextView::_CopySelectionToClipboard(void) const</a>
<a name="ln1718">{</a>
<a name="ln1719">	BString text;</a>
<a name="ln1720">	_GetSelectionText(text);</a>
<a name="ln1721"> </a>
<a name="ln1722">	if (text.Length() &gt; 0) {</a>
<a name="ln1723">		be_clipboard-&gt;Lock();</a>
<a name="ln1724">		be_clipboard-&gt;Data()-&gt;RemoveData(&quot;text/plain&quot;);</a>
<a name="ln1725">		be_clipboard-&gt;Data()-&gt;AddData (&quot;text/plain&quot;,</a>
<a name="ln1726">			B_MIME_TYPE, text.String(), text.Length());</a>
<a name="ln1727">		be_clipboard-&gt;Commit();</a>
<a name="ln1728">		be_clipboard-&gt;Unlock();</a>
<a name="ln1729">	}</a>
<a name="ln1730">}</a>
<a name="ln1731"> </a>
<a name="ln1732"> </a>
<a name="ln1733">void</a>
<a name="ln1734">SourceView::TextView::_SelectWordAt(const SelectionPoint&amp; point, bool extend)</a>
<a name="ln1735">{</a>
<a name="ln1736">	const char* line = fSourceCode-&gt;LineAt(point.line);</a>
<a name="ln1737">	int32 length = fSourceCode-&gt;LineLengthAt(point.line);</a>
<a name="ln1738">	int32 start = point.offset - 1;</a>
<a name="ln1739">	int32 end = point.offset + 1;</a>
<a name="ln1740">	while ((end) &lt; length) {</a>
<a name="ln1741">		if (!isalpha(line[end]) &amp;&amp; !isdigit(line[end]))</a>
<a name="ln1742">			break;</a>
<a name="ln1743">		++end;</a>
<a name="ln1744">	}</a>
<a name="ln1745">	while ((start - 1) &gt;= 0) {</a>
<a name="ln1746">		if (!isalpha(line[start - 1]) &amp;&amp; !isdigit(line[start - 1]))</a>
<a name="ln1747">			break;</a>
<a name="ln1748">		--start;</a>
<a name="ln1749">	}</a>
<a name="ln1750"> </a>
<a name="ln1751">	if (extend) {</a>
<a name="ln1752">		if (point.line &gt;= fSelectionBase.line</a>
<a name="ln1753">			|| (point.line == fSelectionBase.line</a>
<a name="ln1754">				&amp;&amp; point.offset &gt; fSelectionBase.offset)) {</a>
<a name="ln1755">			fSelectionStart.line = fSelectionBase.line;</a>
<a name="ln1756">			fSelectionStart.offset = fSelectionBase.offset;</a>
<a name="ln1757">			fSelectionEnd.line = point.line;</a>
<a name="ln1758">			fSelectionEnd.offset = end;</a>
<a name="ln1759">		} else if (point.line &lt; fSelectionBase.line) {</a>
<a name="ln1760">			fSelectionStart.line = point.line;</a>
<a name="ln1761">			fSelectionStart.offset = start;</a>
<a name="ln1762">			fSelectionEnd.line = fSelectionBase.line;</a>
<a name="ln1763">			fSelectionEnd.offset = fSelectionBase.offset;</a>
<a name="ln1764">		} else if (point.line == fSelectionBase.line) {</a>
<a name="ln1765">			// if we hit here, our offset is before the actual start.</a>
<a name="ln1766">			fSelectionStart.line = point.line;</a>
<a name="ln1767">			fSelectionStart.offset = start;</a>
<a name="ln1768">			fSelectionEnd.line = point.line;</a>
<a name="ln1769">			fSelectionEnd.offset = fSelectionBase.offset;</a>
<a name="ln1770">		}</a>
<a name="ln1771">	} else {</a>
<a name="ln1772">		fSelectionBase.line = fSelectionStart.line = point.line;</a>
<a name="ln1773">		fSelectionBase.offset = fSelectionStart.offset = start;</a>
<a name="ln1774">		fSelectionEnd.line = point.line;</a>
<a name="ln1775">		fSelectionEnd.offset = end;</a>
<a name="ln1776">	}</a>
<a name="ln1777">	BRegion region;</a>
<a name="ln1778">	_GetSelectionRegion(region);</a>
<a name="ln1779">	Invalidate(&amp;region);</a>
<a name="ln1780">}</a>
<a name="ln1781"> </a>
<a name="ln1782"> </a>
<a name="ln1783">void</a>
<a name="ln1784">SourceView::TextView::_SelectLineAt(const SelectionPoint&amp; point, bool extend)</a>
<a name="ln1785">{</a>
<a name="ln1786">	if (extend) {</a>
<a name="ln1787">		if (point.line &gt;= fSelectionBase.line) {</a>
<a name="ln1788">			fSelectionStart.line = fSelectionBase.line;</a>
<a name="ln1789">			fSelectionStart.offset = 0;</a>
<a name="ln1790">			fSelectionEnd.line = point.line;</a>
<a name="ln1791">			fSelectionEnd.offset = fSourceCode-&gt;LineLengthAt(point.line);</a>
<a name="ln1792">		} else {</a>
<a name="ln1793">			fSelectionStart.line = point.line;</a>
<a name="ln1794">			fSelectionStart.offset = 0;</a>
<a name="ln1795">			fSelectionEnd.line = fSelectionBase.line;</a>
<a name="ln1796">			fSelectionEnd.offset = fSourceCode-&gt;LineLengthAt(</a>
<a name="ln1797">				fSelectionBase.line);</a>
<a name="ln1798">		}</a>
<a name="ln1799">	} else {</a>
<a name="ln1800">		fSelectionStart.line = fSelectionEnd.line = point.line;</a>
<a name="ln1801">		fSelectionStart.offset = 0;</a>
<a name="ln1802">		fSelectionEnd.offset = fSourceCode-&gt;LineLengthAt(point.line);</a>
<a name="ln1803">	}</a>
<a name="ln1804">	BRegion region;</a>
<a name="ln1805">	_GetSelectionRegion(region);</a>
<a name="ln1806">	Invalidate(&amp;region);</a>
<a name="ln1807">}</a>
<a name="ln1808"> </a>
<a name="ln1809"> </a>
<a name="ln1810">void</a>
<a name="ln1811">SourceView::TextView::_HandleAutoScroll(void)</a>
<a name="ln1812">{</a>
<a name="ln1813">	BPoint point;</a>
<a name="ln1814">	uint32 buttons;</a>
<a name="ln1815">	GetMouse(&amp;point, &amp;buttons);</a>
<a name="ln1816">	float difference = 0.0;</a>
<a name="ln1817">	int factor = 0;</a>
<a name="ln1818">	BRect visibleRect = Frame() &amp; fSourceView-&gt;Bounds();</a>
<a name="ln1819">	if (point.y &lt; visibleRect.top)</a>
<a name="ln1820">		difference = point.y - visibleRect.top;</a>
<a name="ln1821">	else if (point.y &gt; visibleRect.bottom)</a>
<a name="ln1822">		difference = point.y - visibleRect.bottom;</a>
<a name="ln1823">	if (difference != 0.0) {</a>
<a name="ln1824">		factor = (int)(ceilf(difference / fFontInfo-&gt;lineHeight));</a>
<a name="ln1825">		_ScrollByLines(factor);</a>
<a name="ln1826">	}</a>
<a name="ln1827">	difference = 0.0;</a>
<a name="ln1828">	if (point.x &lt; visibleRect.left)</a>
<a name="ln1829">		difference = point.x - visibleRect.left;</a>
<a name="ln1830">	else if (point.x &gt; visibleRect.right)</a>
<a name="ln1831">		difference = point.x - visibleRect.right;</a>
<a name="ln1832">	if (difference != 0.0) {</a>
<a name="ln1833">		factor = (int)(ceilf(difference / fCharacterWidth));</a>
<a name="ln1834">		_ScrollHorizontal(factor);</a>
<a name="ln1835">	}</a>
<a name="ln1836"> </a>
<a name="ln1837">	MouseMoved(point, B_OUTSIDE_VIEW, NULL);</a>
<a name="ln1838">}</a>
<a name="ln1839"> </a>
<a name="ln1840"> </a>
<a name="ln1841">void</a>
<a name="ln1842">SourceView::TextView::_ScrollHorizontal(int32 charCount)</a>
<a name="ln1843">{</a>
<a name="ln1844">	BScrollBar* horizontal = fSourceView-&gt;ScrollBar(B_HORIZONTAL);</a>
<a name="ln1845">	if (horizontal == NULL)</a>
<a name="ln1846">		return;</a>
<a name="ln1847"> </a>
<a name="ln1848">	float value = horizontal-&gt;Value();</a>
<a name="ln1849">	horizontal-&gt;SetValue(value + fCharacterWidth * charCount);</a>
<a name="ln1850">}</a>
<a name="ln1851"> </a>
<a name="ln1852"> </a>
<a name="ln1853">void</a>
<a name="ln1854">SourceView::TextView::_ScrollByLines(int32 lineCount)</a>
<a name="ln1855">{</a>
<a name="ln1856">	BScrollBar* vertical = fSourceView-&gt;ScrollBar(B_VERTICAL);</a>
<a name="ln1857">	if (vertical == NULL)</a>
<a name="ln1858">		return;</a>
<a name="ln1859"> </a>
<a name="ln1860">	float value = vertical-&gt;Value();</a>
<a name="ln1861">	vertical-&gt;SetValue(value + fFontInfo-&gt;lineHeight * lineCount);</a>
<a name="ln1862">}</a>
<a name="ln1863"> </a>
<a name="ln1864"> </a>
<a name="ln1865">void</a>
<a name="ln1866">SourceView::TextView::_ScrollByPages(int32 pageCount)</a>
<a name="ln1867">{</a>
<a name="ln1868">	BScrollBar* vertical = fSourceView-&gt;ScrollBar(B_VERTICAL);</a>
<a name="ln1869">	if (vertical == NULL)</a>
<a name="ln1870">		return;</a>
<a name="ln1871"> </a>
<a name="ln1872">	float value = vertical-&gt;Value();</a>
<a name="ln1873">	vertical-&gt;SetValue(value</a>
<a name="ln1874">		+ fSourceView-&gt;Frame().Size().height * pageCount);</a>
<a name="ln1875">}</a>
<a name="ln1876"> </a>
<a name="ln1877"> </a>
<a name="ln1878">void</a>
<a name="ln1879">SourceView::TextView::_ScrollToTop(void)</a>
<a name="ln1880">{</a>
<a name="ln1881">	BScrollBar* vertical = fSourceView-&gt;ScrollBar(B_VERTICAL);</a>
<a name="ln1882">	if (vertical == NULL)</a>
<a name="ln1883">		return;</a>
<a name="ln1884"> </a>
<a name="ln1885">	vertical-&gt;SetValue(0.0);</a>
<a name="ln1886">}</a>
<a name="ln1887"> </a>
<a name="ln1888"> </a>
<a name="ln1889">void</a>
<a name="ln1890">SourceView::TextView::_ScrollToBottom(void)</a>
<a name="ln1891">{</a>
<a name="ln1892">	BScrollBar* vertical = fSourceView-&gt;ScrollBar(B_VERTICAL);</a>
<a name="ln1893">	if (vertical == NULL)</a>
<a name="ln1894">		return;</a>
<a name="ln1895"> </a>
<a name="ln1896">	float min, max;</a>
<a name="ln1897">	vertical-&gt;GetRange(&amp;min, &amp;max);</a>
<a name="ln1898">	vertical-&gt;SetValue(max);</a>
<a name="ln1899">}</a>
<a name="ln1900"> </a>
<a name="ln1901"> </a>
<a name="ln1902">bool</a>
<a name="ln1903">SourceView::TextView::_AddGeneralActions(BPopUpMenu* menu, int32 line)</a>
<a name="ln1904">{</a>
<a name="ln1905">	if (fSourceCode == NULL)</a>
<a name="ln1906">		return true;</a>
<a name="ln1907"> </a>
<a name="ln1908">	BMessage* message = NULL;</a>
<a name="ln1909">	if (fSourceCode-&gt;GetSourceFile() != NULL) {</a>
<a name="ln1910">		message = new(std::nothrow) BMessage(MSG_OPEN_SOURCE_FILE);</a>
<a name="ln1911">		if (message == NULL)</a>
<a name="ln1912">			return false;</a>
<a name="ln1913">		message-&gt;AddInt32(&quot;line&quot;, line);</a>
<a name="ln1914"> </a>
<a name="ln1915">		if (!_AddGeneralActionItem(menu, &quot;Open source file&quot;, message))</a>
<a name="ln1916">			return false;</a>
<a name="ln1917">	}</a>
<a name="ln1918"> </a>
<a name="ln1919">	if (fSourceView-&gt;fStackFrame == NULL)</a>
<a name="ln1920">		return true;</a>
<a name="ln1921"> </a>
<a name="ln1922">	FunctionInstance* instance = fSourceView-&gt;fStackFrame-&gt;Function();</a>
<a name="ln1923">	if (instance == NULL)</a>
<a name="ln1924">		return true;</a>
<a name="ln1925"> </a>
<a name="ln1926">	FileSourceCode* code = instance-&gt;GetFunction()-&gt;GetSourceCode();</a>
<a name="ln1927"> </a>
<a name="ln1928">	// if we only have disassembly, this option doesn't apply.</a>
<a name="ln1929">	if (code == NULL)</a>
<a name="ln1930">		return true;</a>
<a name="ln1931"> </a>
<a name="ln1932">	// verify that we do in fact know the source file of the function,</a>
<a name="ln1933">	// since we can't switch to it if it wasn't found and hasn't been</a>
<a name="ln1934">	// located.</a>
<a name="ln1935">	BString sourcePath;</a>
<a name="ln1936">	code-&gt;GetSourceFile()-&gt;GetLocatedPath(sourcePath);</a>
<a name="ln1937">	if (sourcePath.IsEmpty())</a>
<a name="ln1938">		return true;</a>
<a name="ln1939"> </a>
<a name="ln1940">	message = new(std::nothrow) BMessage(</a>
<a name="ln1941">		MSG_SWITCH_DISASSEMBLY_STATE);</a>
<a name="ln1942">	if (message == NULL)</a>
<a name="ln1943">		return false;</a>
<a name="ln1944"> </a>
<a name="ln1945">	if (!_AddGeneralActionItem(menu, dynamic_cast&lt;DisassembledCode*&gt;(</a>
<a name="ln1946">			fSourceCode) != NULL ? &quot;Show source&quot; : &quot;Show disassembly&quot;,</a>
<a name="ln1947">			message)) {</a>
<a name="ln1948">		return false;</a>
<a name="ln1949">	}</a>
<a name="ln1950"> </a>
<a name="ln1951">	return true;</a>
<a name="ln1952">}</a>
<a name="ln1953"> </a>
<a name="ln1954"> </a>
<a name="ln1955">bool</a>
<a name="ln1956">SourceView::TextView::_AddFlowControlActions(BPopUpMenu* menu, int32 line)</a>
<a name="ln1957">{</a>
<a name="ln1958">	Statement* statement;</a>
<a name="ln1959">	if (!fSourceView-&gt;GetStatementForLine(line, statement))</a>
<a name="ln1960">		return true;</a>
<a name="ln1961"> </a>
<a name="ln1962">	BReference&lt;Statement&gt; statementReference(statement, true);</a>
<a name="ln1963">	target_addr_t address = statement-&gt;CoveringAddressRange().Start();</a>
<a name="ln1964"> </a>
<a name="ln1965">	if (menu-&gt;CountItems() &gt; 0)</a>
<a name="ln1966">		menu-&gt;AddSeparatorItem();</a>
<a name="ln1967"> </a>
<a name="ln1968">	if (!_AddFlowControlActionItem(menu, &quot;Run to cursor&quot;, MSG_THREAD_RUN,</a>
<a name="ln1969">		address)) {</a>
<a name="ln1970">		return false;</a>
<a name="ln1971">	}</a>
<a name="ln1972"> </a>
<a name="ln1973">	if (!_AddFlowControlActionItem(menu, &quot;Set next statement&quot;,</a>
<a name="ln1974">			MSG_THREAD_SET_ADDRESS, address)) {</a>
<a name="ln1975">		return false;</a>
<a name="ln1976">	}</a>
<a name="ln1977"> </a>
<a name="ln1978">	return true;</a>
<a name="ln1979">}</a>
<a name="ln1980"> </a>
<a name="ln1981"> </a>
<a name="ln1982">bool</a>
<a name="ln1983">SourceView::TextView::_AddGeneralActionItem(BPopUpMenu* menu, const char* text,</a>
<a name="ln1984">	BMessage* message) const</a>
<a name="ln1985">{</a>
<a name="ln1986">	ObjectDeleter&lt;BMessage&gt; messageDeleter(message);</a>
<a name="ln1987"> </a>
<a name="ln1988">	BMenuItem* item = new(std::nothrow) BMenuItem(text, message);</a>
<a name="ln1989">	if (item == NULL)</a>
<a name="ln1990">		return false;</a>
<a name="ln1991">	ObjectDeleter&lt;BMenuItem&gt; itemDeleter(item);</a>
<a name="ln1992">	messageDeleter.Detach();</a>
<a name="ln1993"> </a>
<a name="ln1994">	if (!menu-&gt;AddItem(item))</a>
<a name="ln1995">		return false;</a>
<a name="ln1996"> </a>
<a name="ln1997">	itemDeleter.Detach();</a>
<a name="ln1998">	return true;</a>
<a name="ln1999">}</a>
<a name="ln2000"> </a>
<a name="ln2001"> </a>
<a name="ln2002">bool</a>
<a name="ln2003">SourceView::TextView::_AddFlowControlActionItem(BPopUpMenu* menu,</a>
<a name="ln2004">	const char* text, uint32 what, target_addr_t address) const</a>
<a name="ln2005">{</a>
<a name="ln2006">	BMessage* message = new(std::nothrow) BMessage(what);</a>
<a name="ln2007">	if (message == NULL)</a>
<a name="ln2008">		return false;</a>
<a name="ln2009">	ObjectDeleter&lt;BMessage&gt; messageDeleter(message);</a>
<a name="ln2010"> </a>
<a name="ln2011">	message-&gt;AddUInt64(&quot;address&quot;, address);</a>
<a name="ln2012">	BMenuItem* item = new(std::nothrow) BMenuItem(text, message);</a>
<a name="ln2013">	if (item == NULL)</a>
<a name="ln2014">		return false;</a>
<a name="ln2015">	ObjectDeleter&lt;BMenuItem&gt; itemDeleter(item);</a>
<a name="ln2016">	messageDeleter.Detach();</a>
<a name="ln2017"> </a>
<a name="ln2018">	if (!menu-&gt;AddItem(item))</a>
<a name="ln2019">		return false;</a>
<a name="ln2020"> </a>
<a name="ln2021">	itemDeleter.Detach();</a>
<a name="ln2022">	return true;</a>
<a name="ln2023">}</a>
<a name="ln2024"> </a>
<a name="ln2025"> </a>
<a name="ln2026">// #pragma mark - SourceView</a>
<a name="ln2027"> </a>
<a name="ln2028"> </a>
<a name="ln2029">SourceView::SourceView(Team* team, Listener* listener)</a>
<a name="ln2030">	:</a>
<a name="ln2031">	BView(&quot;source view&quot;, 0),</a>
<a name="ln2032">	fTeam(team),</a>
<a name="ln2033">	fActiveThread(NULL),</a>
<a name="ln2034">	fStackTrace(NULL),</a>
<a name="ln2035">	fStackFrame(NULL),</a>
<a name="ln2036">	fSourceCode(NULL),</a>
<a name="ln2037">	fMarkerManager(NULL),</a>
<a name="ln2038">	fMarkerView(NULL),</a>
<a name="ln2039">	fTextView(NULL),</a>
<a name="ln2040">	fListener(listener),</a>
<a name="ln2041">	fCurrentSyntaxInfo(NULL)</a>
<a name="ln2042">{</a>
<a name="ln2043">	// init font info</a>
<a name="ln2044">	fFontInfo.font = *be_fixed_font;</a>
<a name="ln2045">	fFontInfo.font.GetHeight(&amp;fFontInfo.fontHeight);</a>
<a name="ln2046">	fFontInfo.lineHeight = ceilf(fFontInfo.fontHeight.ascent)</a>
<a name="ln2047">		+ ceilf(fFontInfo.fontHeight.descent);</a>
<a name="ln2048">}</a>
<a name="ln2049"> </a>
<a name="ln2050"> </a>
<a name="ln2051">SourceView::~SourceView()</a>
<a name="ln2052">{</a>
<a name="ln2053">	SetStackFrame(NULL);</a>
<a name="ln2054">	SetStackTrace(NULL, NULL);</a>
<a name="ln2055">	SetSourceCode(NULL);</a>
<a name="ln2056"> </a>
<a name="ln2057">	delete fMarkerManager;</a>
<a name="ln2058">}</a>
<a name="ln2059"> </a>
<a name="ln2060"> </a>
<a name="ln2061">/*static*/ SourceView*</a>
<a name="ln2062">SourceView::Create(Team* team, Listener* listener)</a>
<a name="ln2063">{</a>
<a name="ln2064">	SourceView* self = new SourceView(team, listener);</a>
<a name="ln2065"> </a>
<a name="ln2066">	try {</a>
<a name="ln2067">		self-&gt;_Init();</a>
<a name="ln2068">	} catch (...) {</a>
<a name="ln2069">		delete self;</a>
<a name="ln2070">		throw;</a>
<a name="ln2071">	}</a>
<a name="ln2072"> </a>
<a name="ln2073">	return self;</a>
<a name="ln2074">}</a>
<a name="ln2075"> </a>
<a name="ln2076"> </a>
<a name="ln2077">void</a>
<a name="ln2078">SourceView::MessageReceived(BMessage* message)</a>
<a name="ln2079">{</a>
<a name="ln2080">	switch(message-&gt;what) {</a>
<a name="ln2081">		case MSG_THREAD_RUN:</a>
<a name="ln2082">		case MSG_THREAD_SET_ADDRESS:</a>
<a name="ln2083">		{</a>
<a name="ln2084">			target_addr_t address;</a>
<a name="ln2085">			if (message-&gt;FindUInt64(&quot;address&quot;, &amp;address) != B_OK)</a>
<a name="ln2086">				break;</a>
<a name="ln2087">			fListener-&gt;ThreadActionRequested(fActiveThread, message-&gt;what,</a>
<a name="ln2088">				address);</a>
<a name="ln2089">			break;</a>
<a name="ln2090">		}</a>
<a name="ln2091"> </a>
<a name="ln2092">		case MSG_OPEN_SOURCE_FILE:</a>
<a name="ln2093">		{</a>
<a name="ln2094">			int32 line;</a>
<a name="ln2095">			if (message-&gt;FindInt32(&quot;line&quot;, &amp;line) != B_OK)</a>
<a name="ln2096">				break;</a>
<a name="ln2097">			// be:line is 1-based.</a>
<a name="ln2098">			++line;</a>
<a name="ln2099">			if (fSourceCode == NULL)</a>
<a name="ln2100">				break;</a>
<a name="ln2101">			LocatableFile* file = fSourceCode-&gt;GetSourceFile();</a>
<a name="ln2102">			if (file == NULL)</a>
<a name="ln2103">				break;</a>
<a name="ln2104"> </a>
<a name="ln2105">			BString sourcePath;</a>
<a name="ln2106">			file-&gt;GetLocatedPath(sourcePath);</a>
<a name="ln2107">			if (sourcePath.IsEmpty())</a>
<a name="ln2108">				break;</a>
<a name="ln2109"> </a>
<a name="ln2110">			BPath path(sourcePath);</a>
<a name="ln2111">			entry_ref ref;</a>
<a name="ln2112">			if (path.InitCheck() != B_OK)</a>
<a name="ln2113">				break;</a>
<a name="ln2114"> </a>
<a name="ln2115">			if (get_ref_for_path(path.Path(), &amp;ref) != B_OK)</a>
<a name="ln2116">				break;</a>
<a name="ln2117"> </a>
<a name="ln2118">			BMessage trackerMessage(B_REFS_RECEIVED);</a>
<a name="ln2119">			trackerMessage.AddRef(&quot;refs&quot;, &amp;ref);</a>
<a name="ln2120">			trackerMessage.AddInt32(&quot;be:line&quot;, line);</a>
<a name="ln2121"> </a>
<a name="ln2122">			BMessenger messenger(kTrackerSignature);</a>
<a name="ln2123">			messenger.SendMessage(&amp;trackerMessage);</a>
<a name="ln2124">			break;</a>
<a name="ln2125">		}</a>
<a name="ln2126"> </a>
<a name="ln2127">		case MSG_SWITCH_DISASSEMBLY_STATE:</a>
<a name="ln2128">		{</a>
<a name="ln2129">			if (fStackFrame == NULL)</a>
<a name="ln2130">				break;</a>
<a name="ln2131"> </a>
<a name="ln2132">			FunctionInstance* instance = fStackFrame-&gt;Function();</a>
<a name="ln2133">			if (instance == NULL)</a>
<a name="ln2134">					break;</a>
<a name="ln2135"> </a>
<a name="ln2136">			SourceCode* code = NULL;</a>
<a name="ln2137">			if (dynamic_cast&lt;FileSourceCode*&gt;(fSourceCode) != NULL) {</a>
<a name="ln2138">				if (instance-&gt;SourceCodeState()</a>
<a name="ln2139">					== FUNCTION_SOURCE_NOT_LOADED) {</a>
<a name="ln2140">					fListener-&gt;FunctionSourceCodeRequested(instance, true);</a>
<a name="ln2141">					break;</a>
<a name="ln2142">				}</a>
<a name="ln2143"> </a>
<a name="ln2144">				code = instance-&gt;GetSourceCode();</a>
<a name="ln2145">			} else {</a>
<a name="ln2146">				Function* function = instance-&gt;GetFunction();</a>
<a name="ln2147">				if (function-&gt;SourceCodeState() == FUNCTION_SOURCE_NOT_LOADED</a>
<a name="ln2148">					|| function-&gt;SourceCodeState()</a>
<a name="ln2149">						== FUNCTION_SOURCE_SUPPRESSED) {</a>
<a name="ln2150">					fListener-&gt;FunctionSourceCodeRequested(instance, false);</a>
<a name="ln2151">					break;</a>
<a name="ln2152">				}</a>
<a name="ln2153"> </a>
<a name="ln2154">				code = function-&gt;GetSourceCode();</a>
<a name="ln2155">			}</a>
<a name="ln2156"> </a>
<a name="ln2157">			if (code != NULL)</a>
<a name="ln2158">				SetSourceCode(code);</a>
<a name="ln2159">			break;</a>
<a name="ln2160">		}</a>
<a name="ln2161"> </a>
<a name="ln2162">		default:</a>
<a name="ln2163">			BView::MessageReceived(message);</a>
<a name="ln2164">			break;</a>
<a name="ln2165">	}</a>
<a name="ln2166">}</a>
<a name="ln2167"> </a>
<a name="ln2168"> </a>
<a name="ln2169">void</a>
<a name="ln2170">SourceView::UnsetListener()</a>
<a name="ln2171">{</a>
<a name="ln2172">	fListener = NULL;</a>
<a name="ln2173">}</a>
<a name="ln2174"> </a>
<a name="ln2175"> </a>
<a name="ln2176">void</a>
<a name="ln2177">SourceView::SetStackTrace(StackTrace* stackTrace, Thread* activeThread)</a>
<a name="ln2178">{</a>
<a name="ln2179">	TRACE_GUI(&quot;SourceView::SetStackTrace(%p)\n&quot;, stackTrace);</a>
<a name="ln2180"> </a>
<a name="ln2181">	if (stackTrace == fStackTrace &amp;&amp; activeThread == fActiveThread)</a>
<a name="ln2182">		return;</a>
<a name="ln2183"> </a>
<a name="ln2184">	if (fActiveThread != NULL)</a>
<a name="ln2185">		fActiveThread-&gt;ReleaseReference();</a>
<a name="ln2186"> </a>
<a name="ln2187">	fActiveThread = activeThread;</a>
<a name="ln2188"> </a>
<a name="ln2189">	if (fActiveThread != NULL)</a>
<a name="ln2190">		fActiveThread-&gt;AcquireReference();</a>
<a name="ln2191"> </a>
<a name="ln2192">	if (fStackTrace != NULL) {</a>
<a name="ln2193">		fMarkerManager-&gt;SetStackTrace(NULL);</a>
<a name="ln2194">		fMarkerView-&gt;SetStackTrace(NULL);</a>
<a name="ln2195">		fStackTrace-&gt;ReleaseReference();</a>
<a name="ln2196">	}</a>
<a name="ln2197"> </a>
<a name="ln2198">	fStackTrace = stackTrace;</a>
<a name="ln2199"> </a>
<a name="ln2200">	if (fStackTrace != NULL)</a>
<a name="ln2201">		fStackTrace-&gt;AcquireReference();</a>
<a name="ln2202"> </a>
<a name="ln2203">	fMarkerManager-&gt;SetStackTrace(fStackTrace);</a>
<a name="ln2204">	fMarkerView-&gt;SetStackTrace(fStackTrace);</a>
<a name="ln2205">}</a>
<a name="ln2206"> </a>
<a name="ln2207"> </a>
<a name="ln2208">void</a>
<a name="ln2209">SourceView::SetStackFrame(StackFrame* stackFrame)</a>
<a name="ln2210">{</a>
<a name="ln2211">	TRACE_GUI(&quot;SourceView::SetStackFrame(%p)\n&quot;, stackFrame);</a>
<a name="ln2212">	if (stackFrame == fStackFrame)</a>
<a name="ln2213">		return;</a>
<a name="ln2214"> </a>
<a name="ln2215">	if (fStackFrame != NULL) {</a>
<a name="ln2216">		fMarkerManager-&gt;SetStackFrame(NULL);</a>
<a name="ln2217">		fMarkerView-&gt;SetStackFrame(NULL);</a>
<a name="ln2218">		fStackFrame-&gt;ReleaseReference();</a>
<a name="ln2219">	}</a>
<a name="ln2220"> </a>
<a name="ln2221">	fStackFrame = stackFrame;</a>
<a name="ln2222"> </a>
<a name="ln2223">	if (fStackFrame != NULL)</a>
<a name="ln2224">		fStackFrame-&gt;AcquireReference();</a>
<a name="ln2225"> </a>
<a name="ln2226">	fMarkerManager-&gt;SetStackFrame(fStackFrame);</a>
<a name="ln2227">	fMarkerView-&gt;SetStackFrame(fStackFrame);</a>
<a name="ln2228">	fTextView-&gt;Invalidate();</a>
<a name="ln2229"> </a>
<a name="ln2230">	if (fStackFrame != NULL)</a>
<a name="ln2231">		ScrollToAddress(fStackFrame-&gt;InstructionPointer());</a>
<a name="ln2232">}</a>
<a name="ln2233"> </a>
<a name="ln2234"> </a>
<a name="ln2235">void</a>
<a name="ln2236">SourceView::SetSourceCode(SourceCode* sourceCode)</a>
<a name="ln2237">{</a>
<a name="ln2238">	// set the source code, if it changed</a>
<a name="ln2239">	if (sourceCode == fSourceCode)</a>
<a name="ln2240">		return;</a>
<a name="ln2241"> </a>
<a name="ln2242">	if (fSourceCode != NULL) {</a>
<a name="ln2243">		fMarkerManager-&gt;SetSourceCode(NULL);</a>
<a name="ln2244">		fTextView-&gt;SetSourceCode(NULL);</a>
<a name="ln2245">		fMarkerView-&gt;SetSourceCode(NULL);</a>
<a name="ln2246">		fSourceCode-&gt;ReleaseReference();</a>
<a name="ln2247">		delete fCurrentSyntaxInfo;</a>
<a name="ln2248">		fCurrentSyntaxInfo = NULL;</a>
<a name="ln2249">	}</a>
<a name="ln2250"> </a>
<a name="ln2251">	fSourceCode = sourceCode;</a>
<a name="ln2252"> </a>
<a name="ln2253">	if (fSourceCode != NULL) {</a>
<a name="ln2254">		fSourceCode-&gt;AcquireReference();</a>
<a name="ln2255"> </a>
<a name="ln2256">		SourceLanguage* language = fSourceCode-&gt;GetSourceLanguage();</a>
<a name="ln2257">		if (language != NULL) {</a>
<a name="ln2258">			SyntaxHighlighter* highlighter = language-&gt;GetSyntaxHighlighter();</a>
<a name="ln2259">			if (highlighter != NULL) {</a>
<a name="ln2260">				BReference&lt;SyntaxHighlighter&gt; syntaxReference(highlighter,</a>
<a name="ln2261">					true);</a>
<a name="ln2262">				highlighter-&gt;ParseText(fSourceCode,</a>
<a name="ln2263">					fTeam-&gt;GetTeamTypeInformation(), fCurrentSyntaxInfo);</a>
<a name="ln2264">			}</a>
<a name="ln2265">		}</a>
<a name="ln2266">	}</a>
<a name="ln2267"> </a>
<a name="ln2268">	fMarkerManager-&gt;SetSourceCode(fSourceCode);</a>
<a name="ln2269">	fTextView-&gt;SetSourceCode(fSourceCode);</a>
<a name="ln2270">	fMarkerView-&gt;SetSourceCode(fSourceCode);</a>
<a name="ln2271">	_UpdateScrollBars();</a>
<a name="ln2272"> </a>
<a name="ln2273">	if (fStackFrame != NULL)</a>
<a name="ln2274">		ScrollToAddress(fStackFrame-&gt;InstructionPointer());</a>
<a name="ln2275">}</a>
<a name="ln2276"> </a>
<a name="ln2277"> </a>
<a name="ln2278">void</a>
<a name="ln2279">SourceView::UserBreakpointChanged(UserBreakpoint* breakpoint)</a>
<a name="ln2280">{</a>
<a name="ln2281">	fMarkerManager-&gt;UserBreakpointChanged(breakpoint);</a>
<a name="ln2282">	fMarkerView-&gt;UserBreakpointChanged(breakpoint);</a>
<a name="ln2283">	fTextView-&gt;UserBreakpointChanged(breakpoint);</a>
<a name="ln2284">}</a>
<a name="ln2285"> </a>
<a name="ln2286"> </a>
<a name="ln2287">bool</a>
<a name="ln2288">SourceView::ScrollToAddress(target_addr_t address)</a>
<a name="ln2289">{</a>
<a name="ln2290">	TRACE_GUI(&quot;SourceView::ScrollToAddress(%#&quot; B_PRIx64 &quot;)\n&quot;, address);</a>
<a name="ln2291"> </a>
<a name="ln2292">	if (fSourceCode == NULL)</a>
<a name="ln2293">		return false;</a>
<a name="ln2294"> </a>
<a name="ln2295">	AutoLocker&lt;Team&gt; locker(fTeam);</a>
<a name="ln2296"> </a>
<a name="ln2297">	FunctionInstance* functionInstance;</a>
<a name="ln2298">	Statement* statement;</a>
<a name="ln2299">	if (fTeam-&gt;GetStatementAtAddress(address, functionInstance,</a>
<a name="ln2300">			statement) != B_OK) {</a>
<a name="ln2301">		return false;</a>
<a name="ln2302">	}</a>
<a name="ln2303">	BReference&lt;Statement&gt; statementReference(statement, true);</a>
<a name="ln2304"> </a>
<a name="ln2305">	return ScrollToLine(statement-&gt;StartSourceLocation().Line());</a>
<a name="ln2306">}</a>
<a name="ln2307"> </a>
<a name="ln2308"> </a>
<a name="ln2309">bool</a>
<a name="ln2310">SourceView::ScrollToLine(uint32 line)</a>
<a name="ln2311">{</a>
<a name="ln2312">	TRACE_GUI(&quot;SourceView::ScrollToLine(%&quot; B_PRIu32 &quot;)\n&quot;, line);</a>
<a name="ln2313"> </a>
<a name="ln2314">	if (fSourceCode == NULL || line &gt;= (uint32)fSourceCode-&gt;CountLines())</a>
<a name="ln2315">		return false;</a>
<a name="ln2316"> </a>
<a name="ln2317">	float top = (float)line * fFontInfo.lineHeight;</a>
<a name="ln2318">	float bottom = top + fFontInfo.lineHeight - 1;</a>
<a name="ln2319"> </a>
<a name="ln2320">	BRect visible = Bounds();</a>
<a name="ln2321"> </a>
<a name="ln2322">	TRACE_GUI(&quot;SourceView::ScrollToLine(%&quot; B_PRId32 &quot;)\n&quot;, line);</a>
<a name="ln2323">	TRACE_GUI(&quot;  visible: (%f, %f) - (%f, %f), line: %f - %f\n&quot;, visible.left,</a>
<a name="ln2324">		visible.top, visible.right, visible.bottom, top, bottom);</a>
<a name="ln2325"> </a>
<a name="ln2326">	// If not visible at all, scroll to the center, otherwise scroll so that at</a>
<a name="ln2327">	// least one more line is visible.</a>
<a name="ln2328">	if (top &gt;= visible.bottom || bottom &lt;= visible.top) {</a>
<a name="ln2329">		TRACE_GUI(&quot;  -&gt; scrolling to (%f, %f)\n&quot;, visible.left,</a>
<a name="ln2330">			top - (visible.Height() + 1) / 2);</a>
<a name="ln2331">		ScrollTo(visible.left, top - (visible.Height() + 1) / 2);</a>
<a name="ln2332">	} else if (top - fFontInfo.lineHeight &lt; visible.top)</a>
<a name="ln2333">		ScrollBy(0, top - fFontInfo.lineHeight - visible.top);</a>
<a name="ln2334">	else if (bottom + fFontInfo.lineHeight &gt; visible.bottom)</a>
<a name="ln2335">		ScrollBy(0, bottom + fFontInfo.lineHeight - visible.bottom);</a>
<a name="ln2336"> </a>
<a name="ln2337">	return true;</a>
<a name="ln2338">}</a>
<a name="ln2339"> </a>
<a name="ln2340"> </a>
<a name="ln2341">void</a>
<a name="ln2342">SourceView::HighlightBorder(bool state)</a>
<a name="ln2343">{</a>
<a name="ln2344">	BScrollView* parent = dynamic_cast&lt;BScrollView*&gt;(Parent());</a>
<a name="ln2345">	if (parent != NULL)</a>
<a name="ln2346">		parent-&gt;SetBorderHighlighted(state);</a>
<a name="ln2347">}</a>
<a name="ln2348"> </a>
<a name="ln2349"> </a>
<a name="ln2350">void</a>
<a name="ln2351">SourceView::TargetedByScrollView(BScrollView* scrollView)</a>
<a name="ln2352">{</a>
<a name="ln2353">	_UpdateScrollBars();</a>
<a name="ln2354">}</a>
<a name="ln2355"> </a>
<a name="ln2356"> </a>
<a name="ln2357">BSize</a>
<a name="ln2358">SourceView::MinSize()</a>
<a name="ln2359">{</a>
<a name="ln2360">//	BSize markerSize(fMarkerView-&gt;MinSize());</a>
<a name="ln2361">//	BSize textSize(fTextView-&gt;MinSize());</a>
<a name="ln2362">//	return BSize(BLayoutUtils::AddDistances(markerSize.width, textSize.width),</a>
<a name="ln2363">//		std::max(markerSize.height, textSize.height));</a>
<a name="ln2364">	return BSize(10, 10);</a>
<a name="ln2365">}</a>
<a name="ln2366"> </a>
<a name="ln2367"> </a>
<a name="ln2368">BSize</a>
<a name="ln2369">SourceView::MaxSize()</a>
<a name="ln2370">{</a>
<a name="ln2371">//	BSize markerSize(fMarkerView-&gt;MaxSize());</a>
<a name="ln2372">//	BSize textSize(fTextView-&gt;MaxSize());</a>
<a name="ln2373">//	return BSize(BLayoutUtils::AddDistances(markerSize.width, textSize.width),</a>
<a name="ln2374">//		std::min(markerSize.height, textSize.height));</a>
<a name="ln2375">	return BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED);</a>
<a name="ln2376">}</a>
<a name="ln2377"> </a>
<a name="ln2378"> </a>
<a name="ln2379">BSize</a>
<a name="ln2380">SourceView::PreferredSize()</a>
<a name="ln2381">{</a>
<a name="ln2382">	BSize markerSize(fMarkerView-&gt;PreferredSize());</a>
<a name="ln2383">	BSize textSize(fTextView-&gt;PreferredSize());</a>
<a name="ln2384">	return BSize(BLayoutUtils::AddDistances(markerSize.width, textSize.width),</a>
<a name="ln2385">		std::max(markerSize.height, textSize.height));</a>
<a name="ln2386">//	return MinSize();</a>
<a name="ln2387">}</a>
<a name="ln2388"> </a>
<a name="ln2389"> </a>
<a name="ln2390">void</a>
<a name="ln2391">SourceView::DoLayout()</a>
<a name="ln2392">{</a>
<a name="ln2393">	BSize size = _DataRectSize();</a>
<a name="ln2394">	float markerWidth = fMarkerView-&gt;MinSize().width;</a>
<a name="ln2395"> </a>
<a name="ln2396">	fMarkerView-&gt;MoveTo(0, 0);</a>
<a name="ln2397">	fMarkerView-&gt;ResizeTo(markerWidth, size.height);</a>
<a name="ln2398"> </a>
<a name="ln2399">	fTextView-&gt;MoveTo(markerWidth + 1, 0);</a>
<a name="ln2400">	fTextView-&gt;ResizeTo(size.width - markerWidth - 1, size.height);</a>
<a name="ln2401"> </a>
<a name="ln2402">	_UpdateScrollBars();</a>
<a name="ln2403">}</a>
<a name="ln2404"> </a>
<a name="ln2405"> </a>
<a name="ln2406">bool</a>
<a name="ln2407">SourceView::GetStatementForLine(int32 line, Statement*&amp; _statement)</a>
<a name="ln2408">{</a>
<a name="ln2409">	if (line &lt; 0)</a>
<a name="ln2410">		return false;</a>
<a name="ln2411"> </a>
<a name="ln2412">	AutoLocker&lt;Team&gt; locker(fTeam);</a>
<a name="ln2413">	Statement* statement;</a>
<a name="ln2414">	if (fTeam-&gt;GetStatementAtSourceLocation(fSourceCode,	SourceLocation(line),</a>
<a name="ln2415">		statement) != B_OK) {</a>
<a name="ln2416">		return false;</a>
<a name="ln2417">	}</a>
<a name="ln2418">	BReference&lt;Statement&gt; statementReference(statement, true);</a>
<a name="ln2419">	if (statement-&gt;StartSourceLocation().Line() != line)</a>
<a name="ln2420">		return false;</a>
<a name="ln2421"> </a>
<a name="ln2422">	_statement = statement;</a>
<a name="ln2423">	statementReference.Detach();</a>
<a name="ln2424"> </a>
<a name="ln2425">	return true;</a>
<a name="ln2426">}</a>
<a name="ln2427"> </a>
<a name="ln2428"> </a>
<a name="ln2429">void</a>
<a name="ln2430">SourceView::_Init()</a>
<a name="ln2431">{</a>
<a name="ln2432">	fMarkerManager = new MarkerManager(this, fTeam, fListener);</a>
<a name="ln2433">	AddChild(fMarkerView = new MarkerView(this, fTeam, fListener,</a>
<a name="ln2434">		fMarkerManager, &amp;fFontInfo));</a>
<a name="ln2435">	AddChild(fTextView = new TextView(this, fMarkerManager, &amp;fFontInfo));</a>
<a name="ln2436">}</a>
<a name="ln2437"> </a>
<a name="ln2438"> </a>
<a name="ln2439">void</a>
<a name="ln2440">SourceView::_UpdateScrollBars()</a>
<a name="ln2441">{</a>
<a name="ln2442">	BSize dataRectSize = _DataRectSize();</a>
<a name="ln2443">	BSize size = Frame().Size();</a>
<a name="ln2444"> </a>
<a name="ln2445">	if (BScrollBar* scrollBar = ScrollBar(B_HORIZONTAL)) {</a>
<a name="ln2446">		float range = dataRectSize.width - size.width;</a>
<a name="ln2447">		if (range &gt; 0) {</a>
<a name="ln2448">			scrollBar-&gt;SetRange(0, range);</a>
<a name="ln2449">			scrollBar-&gt;SetProportion(</a>
<a name="ln2450">				(size.width + 1) / (dataRectSize.width + 1));</a>
<a name="ln2451">			scrollBar-&gt;SetSteps(fFontInfo.lineHeight, size.width + 1);</a>
<a name="ln2452">		} else {</a>
<a name="ln2453">			scrollBar-&gt;SetRange(0, 0);</a>
<a name="ln2454">			scrollBar-&gt;SetProportion(1);</a>
<a name="ln2455">		}</a>
<a name="ln2456">	}</a>
<a name="ln2457"> </a>
<a name="ln2458">	if (BScrollBar* scrollBar = ScrollBar(B_VERTICAL)) {</a>
<a name="ln2459">		float range = dataRectSize.height - size.height;</a>
<a name="ln2460">		if (range &gt; 0) {</a>
<a name="ln2461">			scrollBar-&gt;SetRange(0, range);</a>
<a name="ln2462">			scrollBar-&gt;SetProportion(</a>
<a name="ln2463">				(size.height + 1) / (dataRectSize.height + 1));</a>
<a name="ln2464">			scrollBar-&gt;SetSteps(fFontInfo.lineHeight, size.height + 1);</a>
<a name="ln2465">		} else {</a>
<a name="ln2466">			scrollBar-&gt;SetRange(0, 0);</a>
<a name="ln2467">			scrollBar-&gt;SetProportion(1);</a>
<a name="ln2468">		}</a>
<a name="ln2469">	}</a>
<a name="ln2470">}</a>
<a name="ln2471"> </a>
<a name="ln2472"> </a>
<a name="ln2473">BSize</a>
<a name="ln2474">SourceView::_DataRectSize() const</a>
<a name="ln2475">{</a>
<a name="ln2476">	float width = fMarkerView-&gt;MinSize().width + fTextView-&gt;MinSize().width + 1;</a>
<a name="ln2477">	float height = std::max(fMarkerView-&gt;MinSize().height,</a>
<a name="ln2478">		fTextView-&gt;MinSize().height);</a>
<a name="ln2479"> </a>
<a name="ln2480">	BSize size = Frame().Size();</a>
<a name="ln2481">	return BSize(std::max(size.width, width), std::max(size.height, height));</a>
<a name="ln2482">}</a>
<a name="ln2483"> </a>
<a name="ln2484"> </a>
<a name="ln2485">// #pragma mark - Listener</a>
<a name="ln2486"> </a>
<a name="ln2487"> </a>
<a name="ln2488">SourceView::Listener::~Listener()</a>
<a name="ln2489">{</a>
<a name="ln2490">}</a>

</code></pre>
<div class="balloon" rel="597"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: fSourceCode.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
