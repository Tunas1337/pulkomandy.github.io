
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>CodyCam.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;CodyCam.h&quot;</a>
<a name="ln2"> </a>
<a name="ln3">#include &lt;stdio.h&gt;</a>
<a name="ln4">#include &lt;string.h&gt;</a>
<a name="ln5">#include &lt;unistd.h&gt;</a>
<a name="ln6"> </a>
<a name="ln7">#include &lt;Alert.h&gt;</a>
<a name="ln8">#include &lt;Button.h&gt;</a>
<a name="ln9">#include &lt;Catalog.h&gt;</a>
<a name="ln10">#include &lt;FindDirectory.h&gt;</a>
<a name="ln11">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln12">#include &lt;MediaDefs.h&gt;</a>
<a name="ln13">#include &lt;MediaNode.h&gt;</a>
<a name="ln14">#include &lt;MediaRoster.h&gt;</a>
<a name="ln15">#include &lt;MediaTheme.h&gt;</a>
<a name="ln16">#include &lt;Menu.h&gt;</a>
<a name="ln17">#include &lt;MenuBar.h&gt;</a>
<a name="ln18">#include &lt;MenuItem.h&gt;</a>
<a name="ln19">#include &lt;Path.h&gt;</a>
<a name="ln20">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln21">#include &lt;scheduler.h&gt;</a>
<a name="ln22">#include &lt;TabView.h&gt;</a>
<a name="ln23">#include &lt;TextControl.h&gt;</a>
<a name="ln24">#include &lt;TimeSource.h&gt;</a>
<a name="ln25">#include &lt;TranslationUtils.h&gt;</a>
<a name="ln26"> </a>
<a name="ln27">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln28">#define B_TRANSLATION_CONTEXT &quot;CodyCam&quot;</a>
<a name="ln29"> </a>
<a name="ln30">#define VIDEO_SIZE_X 320</a>
<a name="ln31">#define VIDEO_SIZE_Y 240</a>
<a name="ln32"> </a>
<a name="ln33">#define WINDOW_SIZE_X (VIDEO_SIZE_X + 80)</a>
<a name="ln34">#define WINDOW_SIZE_Y (VIDEO_SIZE_Y + 230)</a>
<a name="ln35"> </a>
<a name="ln36">#define WINDOW_OFFSET_X 28</a>
<a name="ln37">#define WINDOW_OFFSET_Y 28</a>
<a name="ln38"> </a>
<a name="ln39">#define	CALL		printf</a>
<a name="ln40">#define ERROR		printf</a>
<a name="ln41">#define FTPINFO		printf</a>
<a name="ln42">#define	INFO		printf</a>
<a name="ln43"> </a>
<a name="ln44"> </a>
<a name="ln45">// Utility functions</a>
<a name="ln46"> </a>
<a name="ln47">namespace {</a>
<a name="ln48"> </a>
<a name="ln49">// functions for EnumeratedStringValueSettings</a>
<a name="ln50"> </a>
<a name="ln51">const char*</a>
<a name="ln52">CaptureRateAt(int32 i)</a>
<a name="ln53">{</a>
<a name="ln54">	return (i &gt;= 0 &amp;&amp; i &lt; kCaptureRatesCount) ? kCaptureRates[i].name : NULL;</a>
<a name="ln55">}</a>
<a name="ln56"> </a>
<a name="ln57"> </a>
<a name="ln58">const char*</a>
<a name="ln59">UploadClientAt(int32 i)</a>
<a name="ln60">{</a>
<a name="ln61">	return (i &gt;= 0 &amp;&amp; i &lt; kUploadClientsCount) ? kUploadClients[i] : NULL;</a>
<a name="ln62">}</a>
<a name="ln63"> </a>
<a name="ln64"> </a>
<a name="ln65">}; // end anonymous namespace</a>
<a name="ln66"> </a>
<a name="ln67"> </a>
<a name="ln68"> </a>
<a name="ln69">//	#pragma mark -</a>
<a name="ln70"> </a>
<a name="ln71"> </a>
<a name="ln72">CodyCam::CodyCam()</a>
<a name="ln73">	:</a>
<a name="ln74">	BApplication(&quot;application/x-vnd.Haiku-CodyCam&quot;),</a>
<a name="ln75">	fMediaRoster(NULL),</a>
<a name="ln76">	fVideoConsumer(NULL),</a>
<a name="ln77">	fWindow(NULL),</a>
<a name="ln78">	fPort(0),</a>
<a name="ln79">	fVideoControlWindow(NULL)</a>
<a name="ln80">{</a>
<a name="ln81">	int32 index = 0;</a>
<a name="ln82">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 15 seconds&quot;);</a>
<a name="ln83">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 30 seconds&quot;);</a>
<a name="ln84">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every minute&quot;);</a>
<a name="ln85">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 5 minutes&quot;);</a>
<a name="ln86">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 10 minutes&quot;);</a>
<a name="ln87">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 15 minutes&quot;);</a>
<a name="ln88">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 30 minutes&quot;);</a>
<a name="ln89">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every hour&quot;);</a>
<a name="ln90">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 2 hours&quot;);</a>
<a name="ln91">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 4 hours&quot;);</a>
<a name="ln92">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 8 hours&quot;);</a>
<a name="ln93">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Every 24 hours&quot;);</a>
<a name="ln94">	kCaptureRates[index++].name = B_TRANSLATE(&quot;Never&quot;);</a>
<a name="ln95"> </a>
<a name="ln96">	index = 0;</a>
<a name="ln97">	kUploadClients[index++] = B_TRANSLATE(&quot;FTP&quot;);</a>
<a name="ln98">	kUploadClients[index++] = B_TRANSLATE(&quot;SFTP&quot;);</a>
<a name="ln99">	kUploadClients[index++] = B_TRANSLATE(&quot;Local&quot;);</a>
<a name="ln100"> </a>
<a name="ln101">	BPath homeDir;</a>
<a name="ln102">	if (find_directory(B_USER_DIRECTORY, &amp;homeDir) != B_OK)</a>
<a name="ln103">		homeDir.SetTo(&quot;/boot/home&quot;);</a>
<a name="ln104"> </a>
<a name="ln105">	chdir(homeDir.Path());</a>
<a name="ln106">}</a>
<a name="ln107"> </a>
<a name="ln108"> </a>
<a name="ln109">CodyCam::~CodyCam()</a>
<a name="ln110">{</a>
<a name="ln111">	CALL(&quot;CodyCam::~CodyCam\n&quot;);</a>
<a name="ln112"> </a>
<a name="ln113">	// release the video consumer node</a>
<a name="ln114">	// the consumer node cleans up the window</a>
<a name="ln115">	if (fVideoConsumer) {</a>
<a name="ln116">		fVideoConsumer-&gt;Release();</a>
<a name="ln117">		fVideoConsumer = NULL;</a>
<a name="ln118">	}</a>
<a name="ln119"> </a>
<a name="ln120">	CALL(&quot;CodyCam::~CodyCam - EXIT\n&quot;);</a>
<a name="ln121">}</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">void</a>
<a name="ln125">CodyCam::ReadyToRun()</a>
<a name="ln126">{</a>
<a name="ln127">	fWindow = new VideoWindow(</a>
<a name="ln128">		(const char*) B_TRANSLATE_SYSTEM_NAME(&quot;CodyCam&quot;), B_TITLED_WINDOW,</a>
<a name="ln129">		B_NOT_ZOOMABLE | B_NOT_V_RESIZABLE</a>
<a name="ln130">		| B_AUTO_UPDATE_SIZE_LIMITS, &amp;fPort);</a>
<a name="ln131"> </a>
<a name="ln132">	if (_SetUpNodes() != B_OK)</a>
<a name="ln133">		fWindow-&gt;ToggleMenuOnOff();</a>
<a name="ln134"> </a>
<a name="ln135">	((VideoWindow*)fWindow)-&gt;ApplyControls();</a>
<a name="ln136">}</a>
<a name="ln137"> </a>
<a name="ln138"> </a>
<a name="ln139">bool</a>
<a name="ln140">CodyCam::QuitRequested()</a>
<a name="ln141">{</a>
<a name="ln142">	_TearDownNodes();</a>
<a name="ln143">	snooze(100000);</a>
<a name="ln144"> </a>
<a name="ln145">	return true;</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148"> </a>
<a name="ln149">void</a>
<a name="ln150">CodyCam::MessageReceived(BMessage *message)</a>
<a name="ln151">{</a>
<a name="ln152">	switch (message-&gt;what) {</a>
<a name="ln153">		case msg_start:</a>
<a name="ln154">		{</a>
<a name="ln155">			BTimeSource* timeSource = fMediaRoster-&gt;MakeTimeSourceFor(</a>
<a name="ln156">				fTimeSourceNode);</a>
<a name="ln157">			bigtime_t real = BTimeSource::RealTime();</a>
<a name="ln158">			bigtime_t perf = timeSource-&gt;PerformanceTimeFor(real) + 10000;</a>
<a name="ln159">			status_t status = fMediaRoster-&gt;StartNode(fProducerNode, perf);</a>
<a name="ln160">			if (status != B_OK)</a>
<a name="ln161">				ERROR(&quot;error starting producer!&quot;);</a>
<a name="ln162">			timeSource-&gt;Release();</a>
<a name="ln163">			break;</a>
<a name="ln164">		}</a>
<a name="ln165"> </a>
<a name="ln166">		case msg_stop:</a>
<a name="ln167">			fMediaRoster-&gt;StopNode(fProducerNode, 0, true);</a>
<a name="ln168">			break;</a>
<a name="ln169"> </a>
<a name="ln170">		case msg_video:</a>
<a name="ln171">		{</a>
<a name="ln172">			if (fVideoControlWindow) {</a>
<a name="ln173">				fVideoControlWindow-&gt;Activate();</a>
<a name="ln174">				break;</a>
<a name="ln175">			}</a>
<a name="ln176">			BParameterWeb* web = NULL;</a>
<a name="ln177">			BView* view = NULL;</a>
<a name="ln178">			media_node node = fProducerNode;</a>
<a name="ln179">			status_t err = fMediaRoster-&gt;GetParameterWebFor(node, &amp;web);</a>
<a name="ln180">			if (err &gt;= B_OK &amp;&amp; web != NULL) {</a>
<a name="ln181">				view = BMediaTheme::ViewFor(web);</a>
<a name="ln182">				fVideoControlWindow = new ControlWindow(view, node);</a>
<a name="ln183">				fMediaRoster-&gt;StartWatching(BMessenger(NULL,</a>
<a name="ln184">					fVideoControlWindow), node,	B_MEDIA_WEB_CHANGED);</a>
<a name="ln185">				fVideoControlWindow-&gt;Show();</a>
<a name="ln186">			}</a>
<a name="ln187">			break;</a>
<a name="ln188">		}</a>
<a name="ln189"> </a>
<a name="ln190">		case msg_control_win:</a>
<a name="ln191">			// our control window is being asked to go away</a>
<a name="ln192">			// set our pointer to NULL</a>
<a name="ln193">			fVideoControlWindow = NULL;</a>
<a name="ln194">			break;</a>
<a name="ln195"> </a>
<a name="ln196">		default:</a>
<a name="ln197">			BApplication::MessageReceived(message);</a>
<a name="ln198">			break;</a>
<a name="ln199">	}</a>
<a name="ln200">}</a>
<a name="ln201"> </a>
<a name="ln202"> </a>
<a name="ln203">status_t</a>
<a name="ln204">CodyCam::_SetUpNodes()</a>
<a name="ln205">{</a>
<a name="ln206">	status_t status = B_OK;</a>
<a name="ln207"> </a>
<a name="ln208">	/* find the media roster */</a>
<a name="ln209">	fMediaRoster = BMediaRoster::Roster(&amp;status);</a>
<a name="ln210">	if (status != B_OK) {</a>
<a name="ln211">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot find the media roster&quot;),</a>
<a name="ln212">			status);</a>
<a name="ln213">		return status;</a>
<a name="ln214">	}</a>
<a name="ln215"> </a>
<a name="ln216">	/* find the time source */</a>
<a name="ln217">	status = fMediaRoster-&gt;GetTimeSource(&amp;fTimeSourceNode);</a>
<a name="ln218">	if (status != B_OK) {</a>
<a name="ln219">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot get a time source&quot;), status);</a>
<a name="ln220">		return status;</a>
<a name="ln221">	}</a>
<a name="ln222"> </a>
<a name="ln223">	/* find a video producer node */</a>
<a name="ln224">	INFO(&quot;CodyCam acquiring VideoInput node\n&quot;);</a>
<a name="ln225">	status = fMediaRoster-&gt;GetVideoInput(&amp;fProducerNode);</a>
<a name="ln226">	if (status != B_OK) {</a>
<a name="ln227">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot find a video source.\n&quot;</a>
<a name="ln228">			&quot;You need a webcam to use CodyCam.&quot;), status);</a>
<a name="ln229">		return status;</a>
<a name="ln230">	}</a>
<a name="ln231"> </a>
<a name="ln232">	/* create the video consumer node */</a>
<a name="ln233">	fVideoConsumer = new VideoConsumer(&quot;CodyCam&quot;,</a>
<a name="ln234">		((VideoWindow*)fWindow)-&gt;VideoView(),</a>
<a name="ln235">		((VideoWindow*)fWindow)-&gt;StatusLine(), NULL, 0);</a>
<a name="ln236">	if (!fVideoConsumer) {</a>
<a name="ln237">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot create a video window&quot;),</a>
<a name="ln238">			B_ERROR);</a>
<a name="ln239">		return B_ERROR;</a>
<a name="ln240">	}</a>
<a name="ln241"> </a>
<a name="ln242">	/* register the node */</a>
<a name="ln243">	status = fMediaRoster-&gt;RegisterNode(fVideoConsumer);</a>
<a name="ln244">	if (status != B_OK) {</a>
<a name="ln245">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot register the video window&quot;),</a>
<a name="ln246">			status);</a>
<a name="ln247">		return status;</a>
<a name="ln248">	}</a>
<a name="ln249">	fPort = fVideoConsumer-&gt;ControlPort();</a>
<a name="ln250"> </a>
<a name="ln251">	/* find free producer output */</a>
<a name="ln252">	int32 cnt = 0;</a>
<a name="ln253">	status = fMediaRoster-&gt;GetFreeOutputsFor(fProducerNode, &amp;fProducerOut, 1,</a>
<a name="ln254">		&amp;cnt, B_MEDIA_RAW_VIDEO);</a>
<a name="ln255">	if (status != B_OK || cnt &lt; 1) {</a>
<a name="ln256">		status = B_RESOURCE_UNAVAILABLE;</a>
<a name="ln257">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot find an available video stream&quot;),</a>
<a name="ln258">			status);</a>
<a name="ln259">		return status;</a>
<a name="ln260">	}</a>
<a name="ln261"> </a>
<a name="ln262">	/* find free consumer input */</a>
<a name="ln263">	cnt = 0;</a>
<a name="ln264">	status = fMediaRoster-&gt;GetFreeInputsFor(fVideoConsumer-&gt;Node(),</a>
<a name="ln265">		&amp;fConsumerIn, 1, &amp;cnt, B_MEDIA_RAW_VIDEO);</a>
<a name="ln266">	if (status != B_OK || cnt &lt; 1) {</a>
<a name="ln267">		status = B_RESOURCE_UNAVAILABLE;</a>
<a name="ln268">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Can't find an available connection to &quot;</a>
<a name="ln269">			&quot;the video window&quot;), status);</a>
<a name="ln270">		return status;</a>
<a name="ln271">	}</a>
<a name="ln272"> </a>
<a name="ln273">	/* Connect The Nodes!!! */</a>
<a name="ln274">	media_format format;</a>
<a name="ln275">	format.type = B_MEDIA_RAW_VIDEO;</a>
<a name="ln276">	media_raw_video_format vid_format = {0, 1, 0, 239, B_VIDEO_TOP_LEFT_RIGHT,</a>
<a name="ln277">		1, 1, {B_RGB32, VIDEO_SIZE_X, VIDEO_SIZE_Y, VIDEO_SIZE_X * 4, 0, 0}};</a>
<a name="ln278">	format.u.raw_video = vid_format;</a>
<a name="ln279"> </a>
<a name="ln280">	/* connect producer to consumer */</a>
<a name="ln281">	status = fMediaRoster-&gt;Connect(fProducerOut.source,</a>
<a name="ln282">		fConsumerIn.destination, &amp;format, &amp;fProducerOut, &amp;fConsumerIn);</a>
<a name="ln283">	if (status != B_OK) {</a>
<a name="ln284">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot connect the video source to &quot;</a>
<a name="ln285">			&quot;the video window&quot;), status);</a>
<a name="ln286">		return status;</a>
<a name="ln287">	}</a>
<a name="ln288"> </a>
<a name="ln289"> </a>
<a name="ln290">	/* set time sources */</a>
<a name="ln291">	status = fMediaRoster-&gt;SetTimeSourceFor(fProducerNode.node,</a>
<a name="ln292">		fTimeSourceNode.node);</a>
<a name="ln293">	if (status != B_OK) {</a>
<a name="ln294">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot set the time source for the &quot;</a>
<a name="ln295">			&quot;video source&quot;), status);</a>
<a name="ln296">		return status;</a>
<a name="ln297">	}</a>
<a name="ln298"> </a>
<a name="ln299">	status = fMediaRoster-&gt;SetTimeSourceFor(fVideoConsumer-&gt;ID(),</a>
<a name="ln300">		fTimeSourceNode.node);</a>
<a name="ln301">	if (status != B_OK) {</a>
<a name="ln302">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot set the time source for the &quot;</a>
<a name="ln303">			&quot;video window&quot;), status);</a>
<a name="ln304">		return status;</a>
<a name="ln305">	}</a>
<a name="ln306"> </a>
<a name="ln307">	/* figure out what recording delay to use */</a>
<a name="ln308">	bigtime_t latency = 0;</a>
<a name="ln309">	status = fMediaRoster-&gt;GetLatencyFor(fProducerNode, &amp;latency);</a>
<a name="ln310">	status = fMediaRoster-&gt;SetProducerRunModeDelay(fProducerNode, latency);</a>
<a name="ln311"> </a>
<a name="ln312">	/* start the nodes */</a>
<a name="ln313">	bigtime_t initLatency = 0;</a>
<a name="ln314">	status = fMediaRoster-&gt;GetInitialLatencyFor(fProducerNode, &amp;initLatency);</a>
<a name="ln315">	if (status &lt; B_OK) {</a>
<a name="ln316">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Error getting initial latency for the &quot;</a>
<a name="ln317">			&quot;capture node&quot;), status);</a>
<a name="ln318">		return status;</a>
<a name="ln319">	}</a>
<a name="ln320"> </a>
<a name="ln321">	initLatency += estimate_max_scheduling_latency();</a>
<a name="ln322"> </a>
<a name="ln323">	BTimeSource* timeSource = fMediaRoster-&gt;MakeTimeSourceFor(fProducerNode);</a>
<a name="ln324">	bool running = timeSource-&gt;IsRunning();</a>
<a name="ln325"> </a>
<a name="ln326">	/* workaround for people without sound cards */</a>
<a name="ln327">	/* because the system time source won't be running */</a>
<a name="ln328">	bigtime_t real = BTimeSource::RealTime();</a>
<a name="ln329">	if (!running) {</a>
<a name="ln330">		status = fMediaRoster-&gt;StartTimeSource(fTimeSourceNode, real);</a>
<a name="ln331">		if (status != B_OK) {</a>
<a name="ln332">			timeSource-&gt;Release();</a>
<a name="ln333">			fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot start time source!&quot;),</a>
<a name="ln334">				status);</a>
<a name="ln335">			return status;</a>
<a name="ln336">		}</a>
<a name="ln337">		status = fMediaRoster-&gt;SeekTimeSource(fTimeSourceNode, 0, real);</a>
<a name="ln338">		if (status != B_OK) {</a>
<a name="ln339">			timeSource-&gt;Release();</a>
<a name="ln340">			fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot seek time source!&quot;),</a>
<a name="ln341">				status);</a>
<a name="ln342">			return status;</a>
<a name="ln343">		}</a>
<a name="ln344">	}</a>
<a name="ln345"> </a>
<a name="ln346">	bigtime_t perf = timeSource-&gt;PerformanceTimeFor(real + latency</a>
<a name="ln347">		+ initLatency);</a>
<a name="ln348">	timeSource-&gt;Release();</a>
<a name="ln349"> </a>
<a name="ln350">	/* start the nodes */</a>
<a name="ln351">	status = fMediaRoster-&gt;StartNode(fProducerNode, perf);</a>
<a name="ln352">	if (status != B_OK) {</a>
<a name="ln353">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot start the video source&quot;),</a>
<a name="ln354">			status);</a>
<a name="ln355">		return status;</a>
<a name="ln356">	}</a>
<a name="ln357">	status = fMediaRoster-&gt;StartNode(fVideoConsumer-&gt;Node(), perf);</a>
<a name="ln358">	if (status != B_OK) {</a>
<a name="ln359">		fWindow-&gt;ErrorAlert(B_TRANSLATE(&quot;Cannot start the video window&quot;),</a>
<a name="ln360">			status);</a>
<a name="ln361">		return status;</a>
<a name="ln362">	}</a>
<a name="ln363"> </a>
<a name="ln364">	return status;</a>
<a name="ln365">}</a>
<a name="ln366"> </a>
<a name="ln367"> </a>
<a name="ln368">void</a>
<a name="ln369">CodyCam::_TearDownNodes()</a>
<a name="ln370">{</a>
<a name="ln371">	CALL(&quot;CodyCam::_TearDownNodes\n&quot;);</a>
<a name="ln372">	if (!fMediaRoster)</a>
<a name="ln373">		return;</a>
<a name="ln374"> </a>
<a name="ln375">	if (fVideoConsumer) {</a>
<a name="ln376">		/* stop */</a>
<a name="ln377">		INFO(&quot;stopping nodes!\n&quot;);</a>
<a name="ln378">//		fMediaRoster-&gt;StopNode(fProducerNode, 0, true);</a>
<a name="ln379">		fMediaRoster-&gt;StopNode(fVideoConsumer-&gt;Node(), 0, true);</a>
<a name="ln380"> </a>
<a name="ln381">		/* disconnect */</a>
<a name="ln382">		fMediaRoster-&gt;Disconnect(fProducerOut.node.node, fProducerOut.source,</a>
<a name="ln383">			fConsumerIn.node.node, fConsumerIn.destination);</a>
<a name="ln384"> </a>
<a name="ln385">		if (fProducerNode != media_node::null) {</a>
<a name="ln386">			INFO(&quot;CodyCam releasing fProducerNode\n&quot;);</a>
<a name="ln387">			fMediaRoster-&gt;ReleaseNode(fProducerNode);</a>
<a name="ln388">			fProducerNode = media_node::null;</a>
<a name="ln389">		}</a>
<a name="ln390">		fMediaRoster-&gt;ReleaseNode(fVideoConsumer-&gt;Node());</a>
<a name="ln391">		fVideoConsumer = NULL;</a>
<a name="ln392">	}</a>
<a name="ln393">}</a>
<a name="ln394"> </a>
<a name="ln395"> </a>
<a name="ln396">//	#pragma mark - Video Window Class</a>
<a name="ln397"> </a>
<a name="ln398"> </a>
<a name="ln399">VideoWindow::VideoWindow(const char* title, window_type type,</a>
<a name="ln400">		uint32 flags, port_id* consumerPort)</a>
<a name="ln401">	:</a>
<a name="ln402">	BWindow(BRect(50, 50, 50, 50), title, type, flags),</a>
<a name="ln403">	fPortPtr(consumerPort),</a>
<a name="ln404">	fVideoView(NULL)</a>
<a name="ln405">{</a>
<a name="ln406">	fFtpInfo.port = 0;</a>
<a name="ln407">	fFtpInfo.rate = 0x7fffffff;</a>
<a name="ln408">	fFtpInfo.imageFormat = 0;</a>
<a name="ln409">	fFtpInfo.translator = 0;</a>
<a name="ln410">	fFtpInfo.passiveFtp = true;</a>
<a name="ln411">	fFtpInfo.uploadClient = 0;</a>
<a name="ln412">	strcpy(fFtpInfo.fileNameText, &quot;filename&quot;);</a>
<a name="ln413">	strcpy(fFtpInfo.serverText, &quot;server&quot;);</a>
<a name="ln414">	strcpy(fFtpInfo.loginText, &quot;login&quot;);</a>
<a name="ln415">	strcpy(fFtpInfo.passwordText, &quot;password&quot;);</a>
<a name="ln416">	strcpy(fFtpInfo.directoryText, &quot;directory&quot;);</a>
<a name="ln417"> </a>
<a name="ln418">	_SetUpSettings(&quot;codycam&quot;, &quot;&quot;);</a>
<a name="ln419"> </a>
<a name="ln420">	BMenuBar* menuBar = new BMenuBar(&quot;menu bar&quot;);</a>
<a name="ln421"> </a>
<a name="ln422">	BMenuItem* menuItem;</a>
<a name="ln423">	fMenu = new BMenu(B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln424"> </a>
<a name="ln425">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Video settings&quot;),</a>
<a name="ln426">		new BMessage(msg_video), 'P');</a>
<a name="ln427">	menuItem-&gt;SetTarget(be_app);</a>
<a name="ln428">	fMenu-&gt;AddItem(menuItem);</a>
<a name="ln429"> </a>
<a name="ln430">	fMenu-&gt;AddSeparatorItem();</a>
<a name="ln431"> </a>
<a name="ln432">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Start video&quot;),</a>
<a name="ln433">		new BMessage(msg_start), 'A');</a>
<a name="ln434">	menuItem-&gt;SetTarget(be_app);</a>
<a name="ln435">	fMenu-&gt;AddItem(menuItem);</a>
<a name="ln436"> </a>
<a name="ln437">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Stop video&quot;),</a>
<a name="ln438">		new BMessage(msg_stop), 'O');</a>
<a name="ln439">	menuItem-&gt;SetTarget(be_app);</a>
<a name="ln440">	fMenu-&gt;AddItem(menuItem);</a>
<a name="ln441"> </a>
<a name="ln442">	fMenu-&gt;AddSeparatorItem();</a>
<a name="ln443"> </a>
<a name="ln444">	menuItem = new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln445">		new BMessage(B_QUIT_REQUESTED), 'Q');</a>
<a name="ln446">	menuItem-&gt;SetTarget(be_app);</a>
<a name="ln447">	fMenu-&gt;AddItem(menuItem);</a>
<a name="ln448"> </a>
<a name="ln449">	menuBar-&gt;AddItem(fMenu);</a>
<a name="ln450"> </a>
<a name="ln451">	/* add some controls */</a>
<a name="ln452">	_BuildCaptureControls();</a>
<a name="ln453"> </a>
<a name="ln454">	BBox* box = new BBox(&quot;box&quot;);</a>
<a name="ln455">	BGroupLayout* layout = new BGroupLayout(B_VERTICAL);</a>
<a name="ln456">	box-&gt;SetLayout(layout);</a>
<a name="ln457">	layout-&gt;SetInsets(2, 2, 2, 2);</a>
<a name="ln458">	box-&gt;AddChild(fVideoView);</a>
<a name="ln459">	box-&gt;AddChild(fErrorView);</a>
<a name="ln460"> </a>
<a name="ln461">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln462">		.Add(menuBar)</a>
<a name="ln463">		.AddGroup(B_VERTICAL)</a>
<a name="ln464">			.SetInsets(B_USE_WINDOW_SPACING)</a>
<a name="ln465">			.AddGroup(B_HORIZONTAL)</a>
<a name="ln466">				.AddGlue()</a>
<a name="ln467">				.Add(box)</a>
<a name="ln468">				.AddGlue()</a>
<a name="ln469">			.End()</a>
<a name="ln470">			.AddGroup(B_HORIZONTAL, B_USE_DEFAULT_SPACING)</a>
<a name="ln471">				.Add(fCaptureSetupBox)</a>
<a name="ln472">				.Add(fFtpSetupBox)</a>
<a name="ln473">				.End()</a>
<a name="ln474">			.Add(fStatusLine)</a>
<a name="ln475">			.End()</a>
<a name="ln476">		.AddGlue();</a>
<a name="ln477"> </a>
<a name="ln478">	Show();</a>
<a name="ln479">}</a>
<a name="ln480"> </a>
<a name="ln481"> </a>
<a name="ln482">VideoWindow::~VideoWindow()</a>
<a name="ln483">{</a>
<a name="ln484">	_QuitSettings();</a>
<a name="ln485">}</a>
<a name="ln486"> </a>
<a name="ln487"> </a>
<a name="ln488">bool</a>
<a name="ln489">VideoWindow::QuitRequested()</a>
<a name="ln490">{</a>
<a name="ln491">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln492">	return false;</a>
<a name="ln493">}</a>
<a name="ln494"> </a>
<a name="ln495"> </a>
<a name="ln496">void</a>
<a name="ln497">VideoWindow::MessageReceived(BMessage* message)</a>
<a name="ln498">{</a>
<a name="ln499">	BControl* control = NULL;</a>
<a name="ln500">	message-&gt;FindPointer((const char*)&quot;source&quot;, (void **)&amp;control);</a>
<a name="ln501"> </a>
<a name="ln502">	switch (message-&gt;what) {</a>
<a name="ln503">		case msg_filename:</a>
<a name="ln504">			if (control != NULL) {</a>
<a name="ln505">				strlcpy(fFtpInfo.fileNameText,</a>
<a name="ln506">					((BTextControl*)control)-&gt;Text(), 64);</a>
<a name="ln507">				FTPINFO(&quot;file is '%s'\n&quot;, fFtpInfo.fileNameText);</a>
<a name="ln508">			}</a>
<a name="ln509">			break;</a>
<a name="ln510"> </a>
<a name="ln511">		case msg_rate_changed: {</a>
<a name="ln512">			int32 seconds;</a>
<a name="ln513">			message-&gt;FindInt32(&quot;seconds&quot;, &amp;seconds);</a>
<a name="ln514">			if (seconds == 0) {</a>
<a name="ln515">				FTPINFO(&quot;never\n&quot;);</a>
<a name="ln516">				fFtpInfo.rate = (bigtime_t)(B_INFINITE_TIMEOUT);</a>
<a name="ln517">			} else {</a>
<a name="ln518">				FTPINFO(&quot;%ld seconds\n&quot;, (long)seconds);</a>
<a name="ln519">				fFtpInfo.rate = (bigtime_t)(seconds * 1000000LL);</a>
<a name="ln520">			}</a>
<a name="ln521">			break;</a>
<a name="ln522">		}</a>
<a name="ln523"> </a>
<a name="ln524">		case msg_translate:</a>
<a name="ln525">			message-&gt;FindInt32(&quot;be:type&quot;, (int32*)&amp;(fFtpInfo.imageFormat));</a>
<a name="ln526">			message-&gt;FindInt32(&quot;be:translator&quot;, &amp;(fFtpInfo.translator));</a>
<a name="ln527">			break;</a>
<a name="ln528"> </a>
<a name="ln529">		case msg_upl_client:</a>
<a name="ln530">			message-&gt;FindInt32(&quot;client&quot;, &amp;(fFtpInfo.uploadClient));</a>
<a name="ln531">			FTPINFO(&quot;upl client = %&quot; B_PRId32 &quot;\n&quot;, fFtpInfo.uploadClient);</a>
<a name="ln532">			_UploadClientChanged();</a>
<a name="ln533">			break;</a>
<a name="ln534"> </a>
<a name="ln535">		case msg_server:</a>
<a name="ln536">			if (control != NULL) {</a>
<a name="ln537">				strlcpy(fFtpInfo.serverText,</a>
<a name="ln538">					((BTextControl*)control)-&gt;Text(), 64);</a>
<a name="ln539">				FTPINFO(&quot;server = '%s'\n&quot;, fFtpInfo.serverText);</a>
<a name="ln540">			}</a>
<a name="ln541">			break;</a>
<a name="ln542"> </a>
<a name="ln543">		case msg_login:</a>
<a name="ln544">			if (control != NULL) {</a>
<a name="ln545">				strlcpy(fFtpInfo.loginText,</a>
<a name="ln546">					((BTextControl*)control)-&gt;Text(), 64);</a>
<a name="ln547">				FTPINFO(&quot;login = '%s'\n&quot;, fFtpInfo.loginText);</a>
<a name="ln548">			}</a>
<a name="ln549">			break;</a>
<a name="ln550"> </a>
<a name="ln551">		case msg_password:</a>
<a name="ln552">			if (control != NULL) {</a>
<a name="ln553">				strlcpy(fFtpInfo.passwordText,</a>
<a name="ln554">					((BTextControl*)control)-&gt;Text(), 64);</a>
<a name="ln555">				FTPINFO(&quot;password = '%s'\n&quot;, fFtpInfo.passwordText);</a>
<a name="ln556">			}</a>
<a name="ln557">			break;</a>
<a name="ln558"> </a>
<a name="ln559">		case msg_directory:</a>
<a name="ln560">			if (control != NULL) {</a>
<a name="ln561">				strlcpy(fFtpInfo.directoryText,</a>
<a name="ln562">					((BTextControl*)control)-&gt;Text(), 64);</a>
<a name="ln563">				FTPINFO(&quot;directory = '%s'\n&quot;, fFtpInfo.directoryText);</a>
<a name="ln564">			}</a>
<a name="ln565">			break;</a>
<a name="ln566"> </a>
<a name="ln567">		case msg_passiveftp:</a>
<a name="ln568">			if (control != NULL) {</a>
<a name="ln569">				fFtpInfo.passiveFtp = ((BCheckBox*)control)-&gt;Value();</a>
<a name="ln570">				if (fFtpInfo.passiveFtp)</a>
<a name="ln571">					FTPINFO(&quot;using passive ftp\n&quot;);</a>
<a name="ln572">			}</a>
<a name="ln573">			break;</a>
<a name="ln574"> </a>
<a name="ln575">		default:</a>
<a name="ln576">			BWindow::MessageReceived(message);</a>
<a name="ln577">			return;</a>
<a name="ln578">	}</a>
<a name="ln579"> </a>
<a name="ln580">	if (*fPortPtr)</a>
<a name="ln581">		write_port(*fPortPtr, FTP_INFO, (void*)&amp;fFtpInfo, sizeof(ftp_msg_info));</a>
<a name="ln582"> </a>
<a name="ln583">}</a>
<a name="ln584"> </a>
<a name="ln585"> </a>
<a name="ln586">BView*</a>
<a name="ln587">VideoWindow::VideoView()</a>
<a name="ln588">{</a>
<a name="ln589">	return fVideoView;</a>
<a name="ln590">}</a>
<a name="ln591"> </a>
<a name="ln592"> </a>
<a name="ln593">BStringView*</a>
<a name="ln594">VideoWindow::StatusLine()</a>
<a name="ln595">{</a>
<a name="ln596">	return fStatusLine;</a>
<a name="ln597">}</a>
<a name="ln598"> </a>
<a name="ln599"> </a>
<a name="ln600">void</a>
<a name="ln601">VideoWindow::_BuildCaptureControls()</a>
<a name="ln602">{</a>
<a name="ln603">	// a view to hold the video image</a>
<a name="ln604">	fVideoView = new BView(&quot;Video preview&quot;, B_WILL_DRAW);</a>
<a name="ln605">	fVideoView-&gt;SetExplicitMinSize(BSize(VIDEO_SIZE_X, VIDEO_SIZE_Y));</a>
<a name="ln606">	fVideoView-&gt;SetExplicitMaxSize(BSize(VIDEO_SIZE_X, VIDEO_SIZE_Y));</a>
<a name="ln607"> </a>
<a name="ln608">	fErrorView = new BTextView(&quot;error&quot;);</a>
<a name="ln609">	fErrorView-&gt;SetViewColor(ui_color(B_PANEL_BACKGROUND_COLOR));</a>
<a name="ln610"> </a>
<a name="ln611">	// Capture controls</a>
<a name="ln612">	BGridLayout *controlsLayout = new BGridLayout(B_USE_DEFAULT_SPACING,</a>
<a name="ln613">		B_USE_SMALL_SPACING);</a>
<a name="ln614">	controlsLayout-&gt;SetInsets(B_USE_SMALL_SPACING);</a>
<a name="ln615"> </a>
<a name="ln616">	BView* controlView = new BView(&quot;Controls&quot;, B_SUPPORTS_LAYOUT, NULL);</a>
<a name="ln617">	controlView-&gt;SetLayout(controlsLayout);</a>
<a name="ln618"> </a>
<a name="ln619">	fCaptureSetupBox = new BBox(&quot;Capture Controls&quot;, B_WILL_DRAW);</a>
<a name="ln620">	fCaptureSetupBox-&gt;SetLabel(B_TRANSLATE(&quot;Capture controls&quot;));</a>
<a name="ln621">	fCaptureSetupBox-&gt;AddChild(controlView);</a>
<a name="ln622"> </a>
<a name="ln623">	// file name</a>
<a name="ln624">	fFileName = new BTextControl(&quot;File Name&quot;, B_TRANSLATE(&quot;File name:&quot;),</a>
<a name="ln625">		fFilenameSetting-&gt;Value(), new BMessage(msg_filename));</a>
<a name="ln626">	fFileName-&gt;SetTarget(BMessenger(NULL, this));</a>
<a name="ln627"> </a>
<a name="ln628">	// format menu</a>
<a name="ln629">	fImageFormatMenu = new BPopUpMenu(B_TRANSLATE(&quot;Image Format Menu&quot;));</a>
<a name="ln630">	BTranslationUtils::AddTranslationItems(fImageFormatMenu, B_TRANSLATOR_BITMAP);</a>
<a name="ln631">	fImageFormatMenu-&gt;SetTargetForItems(this);</a>
<a name="ln632"> </a>
<a name="ln633">	if (fImageFormatSettings-&gt;Value()</a>
<a name="ln634">		&amp;&amp; fImageFormatMenu-&gt;FindItem(fImageFormatSettings-&gt;Value()) != NULL) {</a>
<a name="ln635">		fImageFormatMenu-&gt;FindItem(</a>
<a name="ln636">			fImageFormatSettings-&gt;Value())-&gt;SetMarked(true);</a>
<a name="ln637">	} else if (fImageFormatMenu-&gt;FindItem(&quot;JPEG image&quot;) != NULL)</a>
<a name="ln638">		fImageFormatMenu-&gt;FindItem(&quot;JPEG image&quot;)-&gt;SetMarked(true);</a>
<a name="ln639">	else</a>
<a name="ln640">		fImageFormatMenu-&gt;ItemAt(0)-&gt;SetMarked(true);</a>
<a name="ln641"> </a>
<a name="ln642">	fImageFormatSelector = new BMenuField(&quot;Format&quot;, B_TRANSLATE(&quot;Format:&quot;),</a>
<a name="ln643">		fImageFormatMenu);</a>
<a name="ln644"> </a>
<a name="ln645">	// capture rate</a>
<a name="ln646">	fCaptureRateMenu = new BPopUpMenu(B_TRANSLATE(&quot;Capture Rate Menu&quot;));</a>
<a name="ln647">	for (int32 i = 0; i &lt; kCaptureRatesCount; i++) {</a>
<a name="ln648">		BMessage* itemMessage = new BMessage(msg_rate_changed);</a>
<a name="ln649">		itemMessage-&gt;AddInt32(&quot;seconds&quot;, kCaptureRates[i].seconds);</a>
<a name="ln650">		fCaptureRateMenu-&gt;AddItem(new BMenuItem(kCaptureRates[i].name,</a>
<a name="ln651">			itemMessage));</a>
<a name="ln652">	}</a>
<a name="ln653">	fCaptureRateMenu-&gt;SetTargetForItems(this);</a>
<a name="ln654">	fCaptureRateMenu-&gt;FindItem(fCaptureRateSetting-&gt;Value())-&gt;SetMarked(true);</a>
<a name="ln655">	fCaptureRateSelector = new BMenuField(&quot;Rate&quot;, B_TRANSLATE(&quot;Rate:&quot;),</a>
<a name="ln656">		fCaptureRateMenu);</a>
<a name="ln657"> </a>
<a name="ln658">	BLayoutBuilder::Grid&lt;&gt;(controlsLayout)</a>
<a name="ln659">		.AddTextControl(fFileName, 0, 0)</a>
<a name="ln660">		.AddMenuField(fImageFormatSelector, 0, 1)</a>
<a name="ln661">		.AddMenuField(fCaptureRateSelector, 0, 2)</a>
<a name="ln662">		.Add(BSpaceLayoutItem::CreateGlue(), 0, 3, 2, 1);</a>
<a name="ln663"> </a>
<a name="ln664">	// FTP setup box</a>
<a name="ln665">	BGridLayout* ftpLayout = new BGridLayout(B_USE_DEFAULT_SPACING,</a>
<a name="ln666">		B_USE_SMALL_SPACING);</a>
<a name="ln667">	ftpLayout-&gt;SetInsets(B_USE_SMALL_SPACING);</a>
<a name="ln668"> </a>
<a name="ln669">	BView* outputView = new BView(&quot;Output&quot;, B_SUPPORTS_LAYOUT, NULL);</a>
<a name="ln670">	outputView-&gt;SetLayout(ftpLayout);</a>
<a name="ln671"> </a>
<a name="ln672">	fFtpSetupBox = new BBox(&quot;FTP Setup&quot;, B_WILL_DRAW);</a>
<a name="ln673">	fFtpSetupBox-&gt;SetLabel(B_TRANSLATE(&quot;Output&quot;));</a>
<a name="ln674">	fFtpSetupBox-&gt;AddChild(outputView);</a>
<a name="ln675">	float minWidth = be_plain_font-&gt;StringWidth(</a>
<a name="ln676">		&quot;The server label plus ftp.reasonably.com&quot;);</a>
<a name="ln677">	fFtpSetupBox-&gt;SetExplicitMinSize(BSize(minWidth, B_SIZE_UNSET));</a>
<a name="ln678">	fFtpSetupBox-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln679"> </a>
<a name="ln680">	fUploadClientMenu = new BPopUpMenu(B_TRANSLATE(&quot;Send to&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln681">	for (int i = 0; i &lt; kUploadClientsCount; i++) {</a>
<a name="ln682">		BMessage *m = new BMessage(msg_upl_client);</a>
<a name="ln683">		m-&gt;AddInt32(&quot;client&quot;, i);</a>
<a name="ln684">		fUploadClientMenu-&gt;AddItem(new BMenuItem(kUploadClients[i], m));</a>
<a name="ln685">	}</a>
<a name="ln686"> </a>
<a name="ln687">	fUploadClientMenu-&gt;SetTargetForItems(this);</a>
<a name="ln688">	fUploadClientMenu-&gt;FindItem(fUploadClientSetting-&gt;Value())-&gt;SetMarked(true);</a>
<a name="ln689"> </a>
<a name="ln690">	fUploadClientSelector = new BMenuField(&quot;UploadClient&quot;, NULL,</a>
<a name="ln691">		fUploadClientMenu);</a>
<a name="ln692"> </a>
<a name="ln693">	fUploadClientSelector-&gt;SetLabel(B_TRANSLATE(&quot;Type:&quot;));</a>
<a name="ln694"> </a>
<a name="ln695">	fServerName = new BTextControl(&quot;Server&quot;, B_TRANSLATE(&quot;Server:&quot;),</a>
<a name="ln696">		fServerSetting-&gt;Value(), new BMessage(msg_server));</a>
<a name="ln697">	fServerName-&gt;SetTarget(this);</a>
<a name="ln698"> </a>
<a name="ln699">	fLoginId = new BTextControl(&quot;Login&quot;, B_TRANSLATE(&quot;Login:&quot;),</a>
<a name="ln700">		fLoginSetting-&gt;Value(), new BMessage(msg_login));</a>
<a name="ln701">	fLoginId-&gt;SetTarget(this);</a>
<a name="ln702"> </a>
<a name="ln703">	fPassword = new BTextControl(&quot;Password&quot;, B_TRANSLATE(&quot;Password:&quot;),</a>
<a name="ln704">		fPasswordSetting-&gt;Value(), new BMessage(msg_password));</a>
<a name="ln705">	fPassword-&gt;SetTarget(this);</a>
<a name="ln706">	fPassword-&gt;TextView()-&gt;HideTyping(true);</a>
<a name="ln707">	// BeOS HideTyping() seems broken, it empties the text</a>
<a name="ln708">	fPassword-&gt;SetText(fPasswordSetting-&gt;Value());</a>
<a name="ln709"> </a>
<a name="ln710">	fDirectory = new BTextControl(&quot;Directory&quot;, B_TRANSLATE(&quot;Directory:&quot;),</a>
<a name="ln711">		fDirectorySetting-&gt;Value(), new BMessage(msg_directory));</a>
<a name="ln712">	fDirectory-&gt;SetTarget(this);</a>
<a name="ln713"> </a>
<a name="ln714">	fPassiveFtp = new BCheckBox(&quot;Passive FTP&quot;, B_TRANSLATE(&quot;Passive FTP&quot;),</a>
<a name="ln715">		new BMessage(msg_passiveftp));</a>
<a name="ln716">	fPassiveFtp-&gt;SetTarget(this);</a>
<a name="ln717">	fPassiveFtp-&gt;SetValue(fPassiveFtpSetting-&gt;Value());</a>
<a name="ln718">	fPassiveFtp-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln719"> </a>
<a name="ln720">	BLayoutBuilder::Grid&lt;&gt;(ftpLayout)</a>
<a name="ln721">		.AddMenuField(fUploadClientSelector, 0, 0)</a>
<a name="ln722">		.AddTextControl(fServerName, 0, 1)</a>
<a name="ln723">		.AddTextControl(fLoginId, 0, 2)</a>
<a name="ln724">		.AddTextControl(fPassword, 0, 3)</a>
<a name="ln725">		.AddTextControl(fDirectory, 0, 4)</a>
<a name="ln726">		.Add(fPassiveFtp, 0, 5, 2, 1);</a>
<a name="ln727"> </a>
<a name="ln728">	fStatusLine = new BStringView(&quot;Status Line&quot;,</a>
<a name="ln729">		B_TRANSLATE(&quot;Waiting&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln730">	fStatusLine-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln731">}</a>
<a name="ln732"> </a>
<a name="ln733"> </a>
<a name="ln734">void</a>
<a name="ln735">VideoWindow::ApplyControls()</a>
<a name="ln736">{</a>
<a name="ln737">	if (!Lock())</a>
<a name="ln738">		return;</a>
<a name="ln739"> </a>
<a name="ln740">	// apply controls</a>
<a name="ln741">	fFileName-&gt;Invoke();</a>
<a name="ln742">	PostMessage(fImageFormatMenu-&gt;FindMarked()-&gt;Message());</a>
<a name="ln743">	PostMessage(fCaptureRateMenu-&gt;FindMarked()-&gt;Message());</a>
<a name="ln744">	PostMessage(fUploadClientMenu-&gt;FindMarked()-&gt;Message());</a>
<a name="ln745">	fServerName-&gt;Invoke();</a>
<a name="ln746">	fLoginId-&gt;Invoke();</a>
<a name="ln747">	fPassword-&gt;Invoke();</a>
<a name="ln748">	fDirectory-&gt;Invoke();</a>
<a name="ln749">	fPassiveFtp-&gt;Invoke();</a>
<a name="ln750"> </a>
<a name="ln751">	Unlock();</a>
<a name="ln752">}</a>
<a name="ln753"> </a>
<a name="ln754"> </a>
<a name="ln755">void</a>
<a name="ln756">VideoWindow::ErrorAlert(const char* message, status_t err)</a>
<a name="ln757">{</a>
<a name="ln758">	Lock();</a>
<a name="ln759">	fErrorView-&gt;SetText(message);</a>
<a name="ln760">	fErrorView-&gt;MakeEditable(false);</a>
<a name="ln761">	fErrorView-&gt;MakeSelectable(false);</a>
<a name="ln762">	fErrorView-&gt;SetWordWrap(true);</a>
<a name="ln763">	fErrorView-&gt;SetAlignment(B_ALIGN_CENTER);</a>
<a name="ln764">	fErrorView-&gt;SetExplicitMinSize(BSize(VIDEO_SIZE_X, VIDEO_SIZE_Y));</a>
<a name="ln765">	fErrorView-&gt;SetExplicitMaxSize(BSize(VIDEO_SIZE_X, VIDEO_SIZE_Y));</a>
<a name="ln766">	fErrorView-&gt;Show();</a>
<a name="ln767">	fVideoView-&gt;Hide();</a>
<a name="ln768">	Unlock();</a>
<a name="ln769"> </a>
<a name="ln770">	printf(&quot;%s\n%s [%&quot; B_PRIx32 &quot;]&quot;, message, strerror(err), err);</a>
<a name="ln771">}</a>
<a name="ln772"> </a>
<a name="ln773"> </a>
<a name="ln774">void</a>
<a name="ln775">VideoWindow::_SetUpSettings(const char* filename, const char* dirname)</a>
<a name="ln776">{</a>
<a name="ln777">	fSettings = new Settings(filename, dirname);</a>
<a name="ln778"> </a>
<a name="ln779">	fServerSetting = new StringValueSetting(&quot;Server&quot;, &quot;ftp.my.server&quot;,</a>
<a name="ln780">		B_TRANSLATE(&quot;server address expected&quot;));</a>
<a name="ln781"> </a>
<a name="ln782">	fLoginSetting = new StringValueSetting(&quot;Login&quot;, &quot;loginID&quot;,</a>
<a name="ln783">		B_TRANSLATE(&quot;login ID expected&quot;));</a>
<a name="ln784"> </a>
<a name="ln785">	fPasswordSetting = new StringValueSetting(&quot;Password&quot;,</a>
<a name="ln786">		B_TRANSLATE(&quot;password&quot;), B_TRANSLATE(&quot;password expected&quot;));</a>
<a name="ln787"> </a>
<a name="ln788">	fDirectorySetting = new StringValueSetting(&quot;Directory&quot;, &quot;web/images&quot;,</a>
<a name="ln789">		B_TRANSLATE(&quot;destination directory expected&quot;));</a>
<a name="ln790"> </a>
<a name="ln791">	fPassiveFtpSetting = new BooleanValueSetting(&quot;PassiveFtp&quot;, 1);</a>
<a name="ln792"> </a>
<a name="ln793">	fFilenameSetting = new StringValueSetting(&quot;StillImageFilename&quot;,</a>
<a name="ln794">		&quot;codycam.jpg&quot;, B_TRANSLATE(&quot;still image filename expected&quot;));</a>
<a name="ln795"> </a>
<a name="ln796">	fImageFormatSettings = new StringValueSetting(&quot;ImageFileFormat&quot;,</a>
<a name="ln797">		B_TRANSLATE(&quot;JPEG image&quot;), B_TRANSLATE(&quot;image file format expected&quot;));</a>
<a name="ln798"> </a>
<a name="ln799">	fCaptureRateSetting = new EnumeratedStringValueSetting(&quot;CaptureRate&quot;,</a>
<a name="ln800">		kCaptureRates[3].name, &amp;CaptureRateAt,</a>
<a name="ln801">		B_TRANSLATE(&quot;capture rate expected&quot;),</a>
<a name="ln802">		&quot;unrecognized capture rate specified&quot;);</a>
<a name="ln803"> </a>
<a name="ln804">	fUploadClientSetting = new EnumeratedStringValueSetting(&quot;UploadClient&quot;,</a>
<a name="ln805">		B_TRANSLATE(&quot;FTP&quot;), &amp;UploadClientAt,</a>
<a name="ln806">		B_TRANSLATE(&quot;upload client name expected&quot;),</a>
<a name="ln807">		B_TRANSLATE(&quot;unrecognized upload client specified&quot;));</a>
<a name="ln808"> </a>
<a name="ln809">	fSettings-&gt;Add(fServerSetting);</a>
<a name="ln810">	fSettings-&gt;Add(fLoginSetting);</a>
<a name="ln811">	fSettings-&gt;Add(fPasswordSetting);</a>
<a name="ln812">	fSettings-&gt;Add(fDirectorySetting);</a>
<a name="ln813">	fSettings-&gt;Add(fPassiveFtpSetting);</a>
<a name="ln814">	fSettings-&gt;Add(fFilenameSetting);</a>
<a name="ln815">	fSettings-&gt;Add(fImageFormatSettings);</a>
<a name="ln816">	fSettings-&gt;Add(fCaptureRateSetting);</a>
<a name="ln817">	fSettings-&gt;Add(fUploadClientSetting);</a>
<a name="ln818"> </a>
<a name="ln819">	fSettings-&gt;TryReadingSettings();</a>
<a name="ln820">}</a>
<a name="ln821"> </a>
<a name="ln822"> </a>
<a name="ln823">void</a>
<a name="ln824">VideoWindow::_UploadClientChanged()</a>
<a name="ln825">{</a>
<a name="ln826">	bool enableServerControls = fFtpInfo.uploadClient &lt; 2;</a>
<a name="ln827">	fServerName-&gt;SetEnabled(enableServerControls);</a>
<a name="ln828">	fLoginId-&gt;SetEnabled(enableServerControls);</a>
<a name="ln829">	fPassword-&gt;SetEnabled(enableServerControls);</a>
<a name="ln830">	fDirectory-&gt;SetEnabled(enableServerControls);</a>
<a name="ln831">	fPassiveFtp-&gt;SetEnabled(enableServerControls);</a>
<a name="ln832">}</a>
<a name="ln833"> </a>
<a name="ln834"> </a>
<a name="ln835">void</a>
<a name="ln836">VideoWindow::_QuitSettings()</a>
<a name="ln837">{</a>
<a name="ln838">	fServerSetting-&gt;ValueChanged(fServerName-&gt;Text());</a>
<a name="ln839">	fLoginSetting-&gt;ValueChanged(fLoginId-&gt;Text());</a>
<a name="ln840">	fPasswordSetting-&gt;ValueChanged(fFtpInfo.passwordText);</a>
<a name="ln841">	fDirectorySetting-&gt;ValueChanged(fDirectory-&gt;Text());</a>
<a name="ln842">	fPassiveFtpSetting-&gt;ValueChanged(fPassiveFtp-&gt;Value());</a>
<a name="ln843">	fFilenameSetting-&gt;ValueChanged(fFileName-&gt;Text());</a>
<a name="ln844">	fImageFormatSettings-&gt;ValueChanged(fImageFormatMenu-&gt;FindMarked()-&gt;Label());</a>
<a name="ln845">	fCaptureRateSetting-&gt;ValueChanged(fCaptureRateMenu-&gt;FindMarked()-&gt;Label());</a>
<a name="ln846">	fUploadClientSetting-&gt;ValueChanged(fUploadClientMenu-&gt;FindMarked()-&gt;Label());</a>
<a name="ln847"> </a>
<a name="ln848">	fSettings-&gt;SaveSettings();</a>
<a name="ln849">	delete fSettings;</a>
<a name="ln850">}</a>
<a name="ln851"> </a>
<a name="ln852"> </a>
<a name="ln853">void</a>
<a name="ln854">VideoWindow::ToggleMenuOnOff()</a>
<a name="ln855">{</a>
<a name="ln856">	BMenuItem* item = fMenu-&gt;FindItem(msg_video);</a>
<a name="ln857">	item-&gt;SetEnabled(!item-&gt;IsEnabled());</a>
<a name="ln858"> </a>
<a name="ln859">	item = fMenu-&gt;FindItem(msg_start);</a>
<a name="ln860">	item-&gt;SetEnabled(!item-&gt;IsEnabled());</a>
<a name="ln861"> </a>
<a name="ln862">	item = fMenu-&gt;FindItem(msg_stop);</a>
<a name="ln863">	item-&gt;SetEnabled(!item-&gt;IsEnabled());</a>
<a name="ln864">}</a>
<a name="ln865"> </a>
<a name="ln866"> </a>
<a name="ln867">//	#pragma mark -</a>
<a name="ln868"> </a>
<a name="ln869"> </a>
<a name="ln870">ControlWindow::ControlWindow(BView* controls,</a>
<a name="ln871">	media_node node)</a>
<a name="ln872">	:</a>
<a name="ln873">	BWindow(BRect(), B_TRANSLATE(&quot;Video settings&quot;), B_TITLED_WINDOW,</a>
<a name="ln874">		B_ASYNCHRONOUS_CONTROLS)</a>
<a name="ln875">{</a>
<a name="ln876">	fView = controls;</a>
<a name="ln877">	fNode = node;</a>
<a name="ln878"> </a>
<a name="ln879">	AddChild(fView);</a>
<a name="ln880">}</a>
<a name="ln881"> </a>
<a name="ln882"> </a>
<a name="ln883">void</a>
<a name="ln884">ControlWindow::MessageReceived(BMessage* message)</a>
<a name="ln885">{</a>
<a name="ln886">	BParameterWeb* web = NULL;</a>
<a name="ln887">	status_t err;</a>
<a name="ln888"> </a>
<a name="ln889">	switch (message-&gt;what) {</a>
<a name="ln890">		case B_MEDIA_WEB_CHANGED:</a>
<a name="ln891">		{</a>
<a name="ln892">			// If this is a tab view, find out which tab</a>
<a name="ln893">			// is selected</a>
<a name="ln894">			BTabView* tabView = dynamic_cast&lt;BTabView*&gt;(fView);</a>
<a name="ln895">			int32 tabNum = -1;</a>
<a name="ln896">			if (tabView)</a>
<a name="ln897">				tabNum = tabView-&gt;Selection();</a>
<a name="ln898"> </a>
<a name="ln899">			RemoveChild(fView);</a>
<a name="ln900">			delete fView;</a>
<a name="ln901"> </a>
<a name="ln902">			err = BMediaRoster::Roster()-&gt;GetParameterWebFor(fNode, &amp;web);</a>
<a name="ln903"> </a>
<a name="ln904">			if (err &gt;= B_OK &amp;&amp; web != NULL) {</a>
<a name="ln905">				fView = BMediaTheme::ViewFor(web);</a>
<a name="ln906">				AddChild(fView);</a>
<a name="ln907"> </a>
<a name="ln908">				// Another tab view?  Restore previous selection</a>
<a name="ln909">				if (tabNum &gt; 0) {</a>
<a name="ln910">					BTabView* newTabView = dynamic_cast&lt;BTabView*&gt;(fView);</a>
<a name="ln911">					if (newTabView)</a>
<a name="ln912">						newTabView-&gt;Select(tabNum);</a>
<a name="ln913">				}</a>
<a name="ln914">			}</a>
<a name="ln915">			break;</a>
<a name="ln916">		}</a>
<a name="ln917"> </a>
<a name="ln918">		default:</a>
<a name="ln919">			BWindow::MessageReceived(message);</a>
<a name="ln920">			break;</a>
<a name="ln921">	}</a>
<a name="ln922">}</a>
<a name="ln923"> </a>
<a name="ln924"> </a>
<a name="ln925">bool</a>
<a name="ln926">ControlWindow::QuitRequested()</a>
<a name="ln927">{</a>
<a name="ln928">	be_app-&gt;PostMessage(msg_control_win);</a>
<a name="ln929">	return true;</a>
<a name="ln930">}</a>
<a name="ln931"> </a>
<a name="ln932"> </a>
<a name="ln933">//	#pragma mark -</a>
<a name="ln934"> </a>
<a name="ln935"> </a>
<a name="ln936">int main() {</a>
<a name="ln937">	CodyCam app;</a>
<a name="ln938">	app.Run();</a>
<a name="ln939">	return 0;</a>
<a name="ln940">}</a>
<a name="ln941"> </a>

</code></pre>
<div class="balloon" rel="128"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v542/" target="_blank">V542</a> Consider inspecting an odd type cast: 'bool' to 'char *'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
