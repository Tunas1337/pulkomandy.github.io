
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>KeyboardLayoutView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2009-2010, Axel Dörfler, axeld@pinc-software.de.</a>
<a name="ln3"> * Copyright 2013-2014 Haiku, Inc. All rights reserved.</a>
<a name="ln4"> * Distributed under the terms of the MIT License.</a>
<a name="ln5"> *</a>
<a name="ln6"> * Authors:</a>
<a name="ln7"> *		Axel Dörfler, axeld@pinc-software.de</a>
<a name="ln8"> *		John Scipione, jscipione@gmail.com</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;KeyboardLayoutView.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;stdio.h&gt;</a>
<a name="ln15">#include &lt;stdlib.h&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;Beep.h&gt;</a>
<a name="ln18">#include &lt;Bitmap.h&gt;</a>
<a name="ln19">#include &lt;ControlLook.h&gt;</a>
<a name="ln20">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln21">#include &lt;MenuItem.h&gt;</a>
<a name="ln22">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln23">#include &lt;Region.h&gt;</a>
<a name="ln24">#include &lt;Window.h&gt;</a>
<a name="ln25"> </a>
<a name="ln26">#include &quot;Keymap.h&quot;</a>
<a name="ln27">#include &quot;KeymapApplication.h&quot;</a>
<a name="ln28"> </a>
<a name="ln29"> </a>
<a name="ln30">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln31">#define B_TRANSLATION_CONTEXT &quot;Keyboard Layout View&quot;</a>
<a name="ln32"> </a>
<a name="ln33"> </a>
<a name="ln34">static const rgb_color kBrightColor = {230, 230, 230, 255};</a>
<a name="ln35">static const rgb_color kDarkColor = {200, 200, 200, 255};</a>
<a name="ln36">static const rgb_color kSecondDeadKeyColor = {240, 240, 150, 255};</a>
<a name="ln37">static const rgb_color kDeadKeyColor = {152, 203, 255, 255};</a>
<a name="ln38">static const rgb_color kLitIndicatorColor = {116, 212, 83, 255};</a>
<a name="ln39"> </a>
<a name="ln40"> </a>
<a name="ln41">static bool</a>
<a name="ln42">is_left_modifier_key(uint32 keyCode)</a>
<a name="ln43">{</a>
<a name="ln44">	return keyCode == 0x4b	// left shift</a>
<a name="ln45">		|| keyCode == 0x5d	// left command</a>
<a name="ln46">		|| keyCode == 0x5c	// left control</a>
<a name="ln47">		|| keyCode == 0x66;	// left option</a>
<a name="ln48">}</a>
<a name="ln49"> </a>
<a name="ln50"> </a>
<a name="ln51">static bool</a>
<a name="ln52">is_right_modifier_key(uint32 keyCode)</a>
<a name="ln53">{</a>
<a name="ln54">	return keyCode == 0x56	// right shift</a>
<a name="ln55">		|| keyCode == 0x5f	// right command</a>
<a name="ln56">		|| keyCode == 0x60	// right control</a>
<a name="ln57">		|| keyCode == 0x67	// right option</a>
<a name="ln58">		|| keyCode == 0x68;	// menu</a>
<a name="ln59">}</a>
<a name="ln60"> </a>
<a name="ln61"> </a>
<a name="ln62">static bool</a>
<a name="ln63">is_lock_key(uint32 keyCode)</a>
<a name="ln64">{</a>
<a name="ln65">	return keyCode == 0x3b	// caps lock</a>
<a name="ln66">		|| keyCode == 0x22	// num lock</a>
<a name="ln67">		|| keyCode == 0x0f;	// scroll lock</a>
<a name="ln68">}</a>
<a name="ln69"> </a>
<a name="ln70"> </a>
<a name="ln71">static bool</a>
<a name="ln72">is_mappable_to_modifier(uint32 keyCode)</a>
<a name="ln73">{</a>
<a name="ln74">	return is_left_modifier_key(keyCode)</a>
<a name="ln75">		|| is_right_modifier_key(keyCode)</a>
<a name="ln76">		|| is_lock_key(keyCode);</a>
<a name="ln77">}</a>
<a name="ln78"> </a>
<a name="ln79"> </a>
<a name="ln80">//	#pragma mark - KeyboardLayoutView</a>
<a name="ln81"> </a>
<a name="ln82"> </a>
<a name="ln83">KeyboardLayoutView::KeyboardLayoutView(const char* name)</a>
<a name="ln84">	:</a>
<a name="ln85">	BView(name, B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE | B_FRAME_EVENTS),</a>
<a name="ln86">	fOffscreenBitmap(NULL),</a>
<a name="ln87">	fKeymap(NULL),</a>
<a name="ln88">	fEditable(true),</a>
<a name="ln89">	fModifiers(0),</a>
<a name="ln90">	fDeadKey(0),</a>
<a name="ln91">	fButtons(0),</a>
<a name="ln92">	fDragKey(NULL),</a>
<a name="ln93">	fDropTarget(NULL),</a>
<a name="ln94">	fOldSize(0, 0)</a>
<a name="ln95">{</a>
<a name="ln96">	fLayout = new KeyboardLayout;</a>
<a name="ln97">	memset(fKeyState, 0, sizeof(fKeyState));</a>
<a name="ln98"> </a>
<a name="ln99">	SetEventMask(B_KEYBOARD_EVENTS);</a>
<a name="ln100">}</a>
<a name="ln101"> </a>
<a name="ln102"> </a>
<a name="ln103">KeyboardLayoutView::~KeyboardLayoutView()</a>
<a name="ln104">{</a>
<a name="ln105">	delete fOffscreenBitmap;</a>
<a name="ln106">}</a>
<a name="ln107"> </a>
<a name="ln108"> </a>
<a name="ln109">void</a>
<a name="ln110">KeyboardLayoutView::SetKeyboardLayout(KeyboardLayout* layout)</a>
<a name="ln111">{</a>
<a name="ln112">	fLayout = layout;</a>
<a name="ln113">	_InitOffscreen();</a>
<a name="ln114">	_LayoutKeyboard();</a>
<a name="ln115">	Invalidate();</a>
<a name="ln116">}</a>
<a name="ln117"> </a>
<a name="ln118"> </a>
<a name="ln119">void</a>
<a name="ln120">KeyboardLayoutView::SetKeymap(Keymap* keymap)</a>
<a name="ln121">{</a>
<a name="ln122">	fKeymap = keymap;</a>
<a name="ln123">	Invalidate();</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126"> </a>
<a name="ln127">void</a>
<a name="ln128">KeyboardLayoutView::SetTarget(BMessenger target)</a>
<a name="ln129">{</a>
<a name="ln130">	fTarget = target;</a>
<a name="ln131">}</a>
<a name="ln132"> </a>
<a name="ln133"> </a>
<a name="ln134">void</a>
<a name="ln135">KeyboardLayoutView::SetBaseFont(const BFont&amp; font)</a>
<a name="ln136">{</a>
<a name="ln137">	fBaseFont = font;</a>
<a name="ln138"> </a>
<a name="ln139">	font_height fontHeight;</a>
<a name="ln140">	fBaseFont.GetHeight(&amp;fontHeight);</a>
<a name="ln141">	fBaseFontHeight = fontHeight.ascent + fontHeight.descent;</a>
<a name="ln142">	fBaseFontSize = fBaseFont.Size();</a>
<a name="ln143"> </a>
<a name="ln144">	Invalidate();</a>
<a name="ln145">}</a>
<a name="ln146"> </a>
<a name="ln147"> </a>
<a name="ln148">void</a>
<a name="ln149">KeyboardLayoutView::AttachedToWindow()</a>
<a name="ln150">{</a>
<a name="ln151">	SetViewColor(B_TRANSPARENT_COLOR);</a>
<a name="ln152"> </a>
<a name="ln153">	SetBaseFont(*be_plain_font);</a>
<a name="ln154">	fSpecialFont = *be_fixed_font;</a>
<a name="ln155">	fModifiers = modifiers();</a>
<a name="ln156">}</a>
<a name="ln157"> </a>
<a name="ln158"> </a>
<a name="ln159">void</a>
<a name="ln160">KeyboardLayoutView::FrameResized(float width, float height)</a>
<a name="ln161">{</a>
<a name="ln162">	_InitOffscreen();</a>
<a name="ln163">	_LayoutKeyboard();</a>
<a name="ln164">}</a>
<a name="ln165"> </a>
<a name="ln166"> </a>
<a name="ln167">void</a>
<a name="ln168">KeyboardLayoutView::WindowActivated(bool active)</a>
<a name="ln169">{</a>
<a name="ln170">	if (active)</a>
<a name="ln171">		Invalidate();</a>
<a name="ln172">}</a>
<a name="ln173"> </a>
<a name="ln174"> </a>
<a name="ln175">BSize</a>
<a name="ln176">KeyboardLayoutView::MinSize()</a>
<a name="ln177">{</a>
<a name="ln178">	return BLayoutUtils::ComposeSize(ExplicitMinSize(), BSize(100, 50));</a>
<a name="ln179">}</a>
<a name="ln180"> </a>
<a name="ln181"> </a>
<a name="ln182">void</a>
<a name="ln183">KeyboardLayoutView::KeyDown(const char* bytes, int32 numBytes)</a>
<a name="ln184">{</a>
<a name="ln185">	_KeyChanged(Window()-&gt;CurrentMessage());</a>
<a name="ln186">}</a>
<a name="ln187"> </a>
<a name="ln188"> </a>
<a name="ln189">void</a>
<a name="ln190">KeyboardLayoutView::KeyUp(const char* bytes, int32 numBytes)</a>
<a name="ln191">{</a>
<a name="ln192">	_KeyChanged(Window()-&gt;CurrentMessage());</a>
<a name="ln193">}</a>
<a name="ln194"> </a>
<a name="ln195"> </a>
<a name="ln196">void</a>
<a name="ln197">KeyboardLayoutView::MouseDown(BPoint point)</a>
<a name="ln198">{</a>
<a name="ln199">	fClickPoint = point;</a>
<a name="ln200">	fDragKey = NULL;</a>
<a name="ln201">	fDropPoint.x = -1;</a>
<a name="ln202"> </a>
<a name="ln203">	int32 buttons = 0;</a>
<a name="ln204">	if (Looper() != NULL &amp;&amp; Looper()-&gt;CurrentMessage() != NULL)</a>
<a name="ln205">		Looper()-&gt;CurrentMessage()-&gt;FindInt32(&quot;buttons&quot;, &amp;buttons);</a>
<a name="ln206"> </a>
<a name="ln207">	Key* key = _KeyAt(point);</a>
<a name="ln208">	if (fKeymap == NULL || key == NULL) {</a>
<a name="ln209">		fButtons = buttons;</a>
<a name="ln210">		return;</a>
<a name="ln211">	}</a>
<a name="ln212"> </a>
<a name="ln213">	if ((buttons &amp; B_SECONDARY_MOUSE_BUTTON) != 0</a>
<a name="ln214">			|| ((buttons &amp; B_PRIMARY_MOUSE_BUTTON) != 0</a>
<a name="ln215">		&amp;&amp; (modifiers() &amp; B_CONTROL_KEY) != 0)) {</a>
<a name="ln216">		// secondary mouse button, pop up a swap context menu</a>
<a name="ln217">		if (!is_mappable_to_modifier(key-&gt;code)) {</a>
<a name="ln218">			// ToDo: Pop up a list of alternative characters to map</a>
<a name="ln219">			// the key to. Currently we only add an option to remove the</a>
<a name="ln220">			// current key mapping.</a>
<a name="ln221">			BPopUpMenu* alternativesPopUp = new BPopUpMenu(</a>
<a name="ln222">				&quot;Alternatives pop up&quot;, true, true, B_ITEMS_IN_COLUMN);</a>
<a name="ln223">			BMessage* message = new BMessage(kMsgUpdateNormalKeys);</a>
<a name="ln224">			message-&gt;AddUInt32(&quot;keyCode&quot;, key-&gt;code);</a>
<a name="ln225">			message-&gt;AddBool(&quot;unset&quot;, true);</a>
<a name="ln226">			alternativesPopUp-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Remove&quot;),</a>
<a name="ln227">				message));</a>
<a name="ln228">			alternativesPopUp-&gt;SetAsyncAutoDestruct(true);</a>
<a name="ln229">			if (alternativesPopUp-&gt;SetTargetForItems(Window()) == B_OK)</a>
<a name="ln230">				alternativesPopUp-&gt;Go(ConvertToScreen(point), true);</a>
<a name="ln231">		} else {</a>
<a name="ln232">			// pop up the modifier keys menu</a>
<a name="ln233">			BPopUpMenu* modifiersPopUp = new BPopUpMenu(&quot;Modifiers pop up&quot;,</a>
<a name="ln234">				true, true, B_ITEMS_IN_COLUMN);</a>
<a name="ln235">			const key_map&amp; map = fKeymap-&gt;Map();</a>
<a name="ln236">			bool isLockKey = is_lock_key(key-&gt;code);</a>
<a name="ln237">			BMenuItem* item = NULL;</a>
<a name="ln238"> </a>
<a name="ln239">			if (is_left_modifier_key(key-&gt;code) || isLockKey) {</a>
<a name="ln240">				item = _CreateSwapModifiersMenuItem(B_LEFT_SHIFT_KEY,</a>
<a name="ln241">					isLockKey ? B_LEFT_SHIFT_KEY : B_SHIFT_KEY,</a>
<a name="ln242">					map.left_shift_key, key-&gt;code);</a>
<a name="ln243">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln244">				if (key-&gt;code == map.left_shift_key)</a>
<a name="ln245">					item-&gt;SetMarked(true);</a>
<a name="ln246"> </a>
<a name="ln247">				item = _CreateSwapModifiersMenuItem(B_LEFT_CONTROL_KEY,</a>
<a name="ln248">					isLockKey ? B_LEFT_CONTROL_KEY : B_CONTROL_KEY,</a>
<a name="ln249">					map.left_control_key, key-&gt;code);</a>
<a name="ln250">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln251">				if (key-&gt;code == map.left_control_key)</a>
<a name="ln252">					item-&gt;SetMarked(true);</a>
<a name="ln253"> </a>
<a name="ln254">				item = _CreateSwapModifiersMenuItem(B_LEFT_OPTION_KEY,</a>
<a name="ln255">					isLockKey ? B_LEFT_OPTION_KEY : B_OPTION_KEY,</a>
<a name="ln256">					map.left_option_key, key-&gt;code);</a>
<a name="ln257">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln258">				if (key-&gt;code == map.left_option_key)</a>
<a name="ln259">					item-&gt;SetMarked(true);</a>
<a name="ln260"> </a>
<a name="ln261">				item = _CreateSwapModifiersMenuItem(B_LEFT_COMMAND_KEY,</a>
<a name="ln262">					isLockKey ? B_LEFT_COMMAND_KEY : B_COMMAND_KEY,</a>
<a name="ln263">					map.left_command_key, key-&gt;code);</a>
<a name="ln264">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln265">				if (key-&gt;code == map.left_command_key)</a>
<a name="ln266">					item-&gt;SetMarked(true);</a>
<a name="ln267">			}</a>
<a name="ln268"> </a>
<a name="ln269">			if (is_right_modifier_key(key-&gt;code) || isLockKey) {</a>
<a name="ln270">				if (isLockKey)</a>
<a name="ln271">					modifiersPopUp-&gt;AddSeparatorItem();</a>
<a name="ln272"> </a>
<a name="ln273">				item = _CreateSwapModifiersMenuItem(B_RIGHT_SHIFT_KEY,</a>
<a name="ln274">					isLockKey ? B_RIGHT_SHIFT_KEY : B_SHIFT_KEY,</a>
<a name="ln275">					map.right_shift_key, key-&gt;code);</a>
<a name="ln276">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln277">				if (key-&gt;code == map.right_shift_key)</a>
<a name="ln278">					item-&gt;SetMarked(true);</a>
<a name="ln279"> </a>
<a name="ln280">				item = _CreateSwapModifiersMenuItem(B_RIGHT_CONTROL_KEY,</a>
<a name="ln281">					isLockKey ? B_RIGHT_CONTROL_KEY : B_CONTROL_KEY,</a>
<a name="ln282">					map.right_control_key, key-&gt;code);</a>
<a name="ln283">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln284">				if (key-&gt;code == map.right_control_key)</a>
<a name="ln285">					item-&gt;SetMarked(true);</a>
<a name="ln286">			}</a>
<a name="ln287"> </a>
<a name="ln288">			item = _CreateSwapModifiersMenuItem(B_MENU_KEY, B_MENU_KEY,</a>
<a name="ln289">				map.menu_key, key-&gt;code);</a>
<a name="ln290">			modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln291">			if (key-&gt;code == map.menu_key)</a>
<a name="ln292">				item-&gt;SetMarked(true);</a>
<a name="ln293"> </a>
<a name="ln294">			if (is_right_modifier_key(key-&gt;code) || isLockKey) {</a>
<a name="ln295">				item = _CreateSwapModifiersMenuItem(B_RIGHT_OPTION_KEY,</a>
<a name="ln296">					isLockKey ? B_RIGHT_OPTION_KEY : B_OPTION_KEY,</a>
<a name="ln297">					map.right_option_key, key-&gt;code);</a>
<a name="ln298">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln299">				if (key-&gt;code == map.right_option_key)</a>
<a name="ln300">					item-&gt;SetMarked(true);</a>
<a name="ln301"> </a>
<a name="ln302">				item = _CreateSwapModifiersMenuItem(B_RIGHT_COMMAND_KEY,</a>
<a name="ln303">					isLockKey ? B_RIGHT_COMMAND_KEY : B_COMMAND_KEY,</a>
<a name="ln304">					map.right_command_key, key-&gt;code);</a>
<a name="ln305">				modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln306">				if (key-&gt;code == map.right_command_key)</a>
<a name="ln307">					item-&gt;SetMarked(true);</a>
<a name="ln308">			}</a>
<a name="ln309"> </a>
<a name="ln310">			modifiersPopUp-&gt;AddSeparatorItem();</a>
<a name="ln311"> </a>
<a name="ln312">			item = _CreateSwapModifiersMenuItem(B_CAPS_LOCK, B_CAPS_LOCK,</a>
<a name="ln313">				map.caps_key, key-&gt;code);</a>
<a name="ln314">			modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln315">			if (key-&gt;code == map.caps_key)</a>
<a name="ln316">				item-&gt;SetMarked(true);</a>
<a name="ln317"> </a>
<a name="ln318">			item = _CreateSwapModifiersMenuItem(B_NUM_LOCK, B_NUM_LOCK,</a>
<a name="ln319">				map.num_key, key-&gt;code);</a>
<a name="ln320">			modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln321">			if (key-&gt;code == map.num_key)</a>
<a name="ln322">				item-&gt;SetMarked(true);</a>
<a name="ln323"> </a>
<a name="ln324">			item = _CreateSwapModifiersMenuItem(B_SCROLL_LOCK, B_SCROLL_LOCK,</a>
<a name="ln325">				map.scroll_key, key-&gt;code);</a>
<a name="ln326">			modifiersPopUp-&gt;AddItem(item);</a>
<a name="ln327">			if (key-&gt;code == map.scroll_key)</a>
<a name="ln328">				item-&gt;SetMarked(true);</a>
<a name="ln329"> </a>
<a name="ln330">			modifiersPopUp-&gt;SetAsyncAutoDestruct(true);</a>
<a name="ln331">			if (modifiersPopUp-&gt;SetTargetForItems(Window()) == B_OK)</a>
<a name="ln332">				modifiersPopUp-&gt;Go(ConvertToScreen(point), true);</a>
<a name="ln333">		}</a>
<a name="ln334">	} else if ((buttons &amp; B_TERTIARY_MOUSE_BUTTON) != 0</a>
<a name="ln335">		&amp;&amp; (fButtons &amp; B_TERTIARY_MOUSE_BUTTON) == 0) {</a>
<a name="ln336">		// tertiary mouse button, toggle the &quot;deadness&quot; of dead keys</a>
<a name="ln337">		bool isEnabled = false;</a>
<a name="ln338">		uint8 deadKey = fKeymap-&gt;DeadKey(key-&gt;code, fModifiers, &amp;isEnabled);</a>
<a name="ln339">		if (deadKey &gt; 0) {</a>
<a name="ln340">			fKeymap-&gt;SetDeadKeyEnabled(key-&gt;code, fModifiers, !isEnabled);</a>
<a name="ln341">			_InvalidateKey(key);</a>
<a name="ln342">		}</a>
<a name="ln343">	} else {</a>
<a name="ln344">		// primary mouse button</a>
<a name="ln345">		if (fKeymap-&gt;IsModifierKey(key-&gt;code)) {</a>
<a name="ln346">			if (_KeyState(key-&gt;code)) {</a>
<a name="ln347">				uint32 modifier = fKeymap-&gt;Modifier(key-&gt;code);</a>
<a name="ln348">				if ((modifier &amp; modifiers()) == 0) {</a>
<a name="ln349">					_SetKeyState(key-&gt;code, false);</a>
<a name="ln350">					fModifiers &amp;= ~modifier;</a>
<a name="ln351">					Invalidate();</a>
<a name="ln352">				}</a>
<a name="ln353">			} else {</a>
<a name="ln354">				_SetKeyState(key-&gt;code, true);</a>
<a name="ln355">				fModifiers |= fKeymap-&gt;Modifier(key-&gt;code);</a>
<a name="ln356">				Invalidate();</a>
<a name="ln357">			}</a>
<a name="ln358"> </a>
<a name="ln359">			// TODO: if possible, we could handle the lock keys for real</a>
<a name="ln360">		} else {</a>
<a name="ln361">			_SetKeyState(key-&gt;code, true);</a>
<a name="ln362">			_InvalidateKey(key);</a>
<a name="ln363">		}</a>
<a name="ln364">	}</a>
<a name="ln365"> </a>
<a name="ln366">	fButtons = buttons;</a>
<a name="ln367">}</a>
<a name="ln368"> </a>
<a name="ln369"> </a>
<a name="ln370">void</a>
<a name="ln371">KeyboardLayoutView::MouseUp(BPoint point)</a>
<a name="ln372">{</a>
<a name="ln373">	Key* key = _KeyAt(fClickPoint);</a>
<a name="ln374"> </a>
<a name="ln375">	int32 buttons = 0;</a>
<a name="ln376">	if (Looper() != NULL &amp;&amp; Looper()-&gt;CurrentMessage() != NULL)</a>
<a name="ln377">		Looper()-&gt;CurrentMessage()-&gt;FindInt32(&quot;buttons&quot;, &amp;buttons);</a>
<a name="ln378"> </a>
<a name="ln379">	if (fKeymap == NULL || key == NULL) {</a>
<a name="ln380">		fDragKey = NULL;</a>
<a name="ln381">		return;</a>
<a name="ln382">	}</a>
<a name="ln383"> </a>
<a name="ln384">	if ((buttons &amp; B_SECONDARY_MOUSE_BUTTON) != 0</a>
<a name="ln385">		|| ((buttons &amp; B_PRIMARY_MOUSE_BUTTON) != 0</a>
<a name="ln386">			&amp;&amp; (modifiers() &amp; B_CONTROL_KEY) != 0)) {</a>
<a name="ln387">		; // do nothing</a>
<a name="ln388">	} else if ((buttons &amp; B_TERTIARY_MOUSE_BUTTON) != 0</a>
<a name="ln389">		&amp;&amp; (fButtons &amp; B_TERTIARY_MOUSE_BUTTON) == 0) {</a>
<a name="ln390">		// toggle the &quot;deadness&quot; of dead keys via middle mouse button</a>
<a name="ln391">		_SetKeyState(key-&gt;code, false);</a>
<a name="ln392">		_InvalidateKey(key);</a>
<a name="ln393">		fButtons = buttons;</a>
<a name="ln394">	} else {</a>
<a name="ln395">		// primary mouse button</a>
<a name="ln396">		fButtons = buttons;</a>
<a name="ln397"> </a>
<a name="ln398">		// modifier keys are sticky when used with the mouse</a>
<a name="ln399">		if (fKeymap-&gt;IsModifierKey(key-&gt;code))</a>
<a name="ln400">			return;</a>
<a name="ln401"> </a>
<a name="ln402">		_SetKeyState(key-&gt;code, false);</a>
<a name="ln403"> </a>
<a name="ln404">		if (_HandleDeadKey(key-&gt;code, fModifiers) &amp;&amp; fDeadKey != 0)</a>
<a name="ln405">			return;</a>
<a name="ln406"> </a>
<a name="ln407">		_InvalidateKey(key);</a>
<a name="ln408"> </a>
<a name="ln409">		if (fDragKey == NULL)</a>
<a name="ln410">			_SendFakeKeyDown(key);</a>
<a name="ln411">	}</a>
<a name="ln412"> </a>
<a name="ln413">	fDragKey = NULL;</a>
<a name="ln414">}</a>
<a name="ln415"> </a>
<a name="ln416"> </a>
<a name="ln417">void</a>
<a name="ln418">KeyboardLayoutView::MouseMoved(BPoint point, uint32 transit,</a>
<a name="ln419">	const BMessage* dragMessage)</a>
<a name="ln420">{</a>
<a name="ln421">	if (fKeymap == NULL)</a>
<a name="ln422">		return;</a>
<a name="ln423"> </a>
<a name="ln424">	// prevent dragging for tertiary mouse button</a>
<a name="ln425">	if ((fButtons &amp; B_TERTIARY_MOUSE_BUTTON) != 0)</a>
<a name="ln426">		return;</a>
<a name="ln427"> </a>
<a name="ln428">	if (dragMessage != NULL) {</a>
<a name="ln429">		if (fEditable) {</a>
<a name="ln430">			_InvalidateKey(fDropTarget);</a>
<a name="ln431">			fDropPoint = point;</a>
<a name="ln432"> </a>
<a name="ln433">			_EvaluateDropTarget(point);</a>
<a name="ln434">		}</a>
<a name="ln435"> </a>
<a name="ln436">		return;</a>
<a name="ln437">	}</a>
<a name="ln438"> </a>
<a name="ln439">	int32 buttons;</a>
<a name="ln440">	if (Window()-&gt;CurrentMessage() == NULL</a>
<a name="ln441">		|| Window()-&gt;CurrentMessage()-&gt;FindInt32(&quot;buttons&quot;, &amp;buttons) != B_OK</a>
<a name="ln442">		|| buttons == 0) {</a>
<a name="ln443">		return;</a>
<a name="ln444">	}</a>
<a name="ln445"> </a>
<a name="ln446">	if (fDragKey != NULL || !(fabs(point.x - fClickPoint.x) &gt; 4</a>
<a name="ln447">		|| fabs(point.y - fClickPoint.y) &gt; 4)) {</a>
<a name="ln448">		return;</a>
<a name="ln449">	}</a>
<a name="ln450"> </a>
<a name="ln451">	// start dragging</a>
<a name="ln452">	Key* key = _KeyAt(fClickPoint);</a>
<a name="ln453">	if (key == NULL)</a>
<a name="ln454">		return;</a>
<a name="ln455"> </a>
<a name="ln456">	BRect frame = _FrameFor(key);</a>
<a name="ln457">	BPoint offset = fClickPoint - frame.LeftTop();</a>
<a name="ln458">	frame.OffsetTo(B_ORIGIN);</a>
<a name="ln459"> </a>
<a name="ln460">	BRect rect = frame;</a>
<a name="ln461">	rect.right--;</a>
<a name="ln462">	rect.bottom--;</a>
<a name="ln463">	BBitmap* bitmap = new BBitmap(rect, B_RGBA32, true);</a>
<a name="ln464">	bitmap-&gt;Lock();</a>
<a name="ln465"> </a>
<a name="ln466">	BView* view = new BView(rect, &quot;drag&quot;, B_FOLLOW_NONE, 0);</a>
<a name="ln467">	bitmap-&gt;AddChild(view);</a>
<a name="ln468"> </a>
<a name="ln469">	view-&gt;SetHighColor(0, 0, 0, 0);</a>
<a name="ln470">	view-&gt;FillRect(view-&gt;Bounds());</a>
<a name="ln471">	view-&gt;SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln472">	view-&gt;SetHighColor(0, 0, 0, 128);</a>
<a name="ln473">	// set the level of transparency by value</a>
<a name="ln474">	view-&gt;SetBlendingMode(B_CONSTANT_ALPHA, B_ALPHA_COMPOSITE);</a>
<a name="ln475">	_DrawKey(view, frame, key, frame, false);</a>
<a name="ln476"> </a>
<a name="ln477">	view-&gt;Sync();</a>
<a name="ln478">	bitmap-&gt;Unlock();</a>
<a name="ln479"> </a>
<a name="ln480">	BMessage drag(B_MIME_DATA);</a>
<a name="ln481">	drag.AddInt32(&quot;key&quot;, key-&gt;code);</a>
<a name="ln482"> </a>
<a name="ln483">	char* string;</a>
<a name="ln484">	int32 numBytes;</a>
<a name="ln485">	fKeymap-&gt;GetChars(key-&gt;code, fModifiers, fDeadKey, &amp;string,</a>
<a name="ln486">		&amp;numBytes);</a>
<a name="ln487">	if (string != NULL) {</a>
<a name="ln488">		drag.AddData(&quot;text/plain&quot;, B_MIME_DATA, string, numBytes);</a>
<a name="ln489">		delete[] string;</a>
<a name="ln490">	}</a>
<a name="ln491"> </a>
<a name="ln492">	DragMessage(&amp;drag, bitmap, B_OP_ALPHA, offset);</a>
<a name="ln493">	fDragKey = key;</a>
<a name="ln494">	fDragModifiers = fModifiers;</a>
<a name="ln495"> </a>
<a name="ln496">	fKeyState[key-&gt;code / 8] &amp;= ~(1 &lt;&lt; (7 - (key-&gt;code &amp; 7)));</a>
<a name="ln497">	_InvalidateKey(key);</a>
<a name="ln498">}</a>
<a name="ln499"> </a>
<a name="ln500"> </a>
<a name="ln501">void</a>
<a name="ln502">KeyboardLayoutView::Draw(BRect updateRect)</a>
<a name="ln503">{</a>
<a name="ln504">	if (fOldSize != BSize(Bounds().Width(), Bounds().Height())) {</a>
<a name="ln505">		_InitOffscreen();</a>
<a name="ln506">		_LayoutKeyboard();</a>
<a name="ln507">	}</a>
<a name="ln508"> </a>
<a name="ln509">	BView* view;</a>
<a name="ln510">	if (fOffscreenBitmap != NULL) {</a>
<a name="ln511">		view = fOffscreenView;</a>
<a name="ln512">		view-&gt;LockLooper();</a>
<a name="ln513">	} else</a>
<a name="ln514">		view = this;</a>
<a name="ln515"> </a>
<a name="ln516">	// Draw background</a>
<a name="ln517"> </a>
<a name="ln518">	if (Parent())</a>
<a name="ln519">		view-&gt;SetLowColor(Parent()-&gt;ViewColor());</a>
<a name="ln520">	else</a>
<a name="ln521">		view-&gt;SetLowColor(ui_color(B_PANEL_BACKGROUND_COLOR));</a>
<a name="ln522"> </a>
<a name="ln523">	view-&gt;FillRect(updateRect, B_SOLID_LOW);</a>
<a name="ln524"> </a>
<a name="ln525">	// Draw keys</a>
<a name="ln526"> </a>
<a name="ln527">	for (int32 i = 0; i &lt; fLayout-&gt;CountKeys(); i++) {</a>
<a name="ln528">		Key* key = fLayout-&gt;KeyAt(i);</a>
<a name="ln529"> </a>
<a name="ln530">		_DrawKey(view, updateRect, key, _FrameFor(key),</a>
<a name="ln531">			_IsKeyPressed(key-&gt;code));</a>
<a name="ln532">	}</a>
<a name="ln533"> </a>
<a name="ln534">	// Draw LED indicators</a>
<a name="ln535"> </a>
<a name="ln536">	for (int32 i = 0; i &lt; fLayout-&gt;CountIndicators(); i++) {</a>
<a name="ln537">		Indicator* indicator = fLayout-&gt;IndicatorAt(i);</a>
<a name="ln538"> </a>
<a name="ln539">		_DrawIndicator(view, updateRect, indicator, _FrameFor(indicator-&gt;frame),</a>
<a name="ln540">			(fModifiers &amp; indicator-&gt;modifier) != 0);</a>
<a name="ln541">	}</a>
<a name="ln542"> </a>
<a name="ln543">	if (fOffscreenBitmap != NULL) {</a>
<a name="ln544">		view-&gt;Sync();</a>
<a name="ln545">		view-&gt;UnlockLooper();</a>
<a name="ln546"> </a>
<a name="ln547">		DrawBitmapAsync(fOffscreenBitmap, BPoint(0, 0));</a>
<a name="ln548">	}</a>
<a name="ln549">}</a>
<a name="ln550"> </a>
<a name="ln551"> </a>
<a name="ln552">void</a>
<a name="ln553">KeyboardLayoutView::MessageReceived(BMessage* message)</a>
<a name="ln554">{</a>
<a name="ln555">	if (message-&gt;WasDropped() &amp;&amp; fEditable &amp;&amp; fDropTarget != NULL</a>
<a name="ln556">		&amp;&amp; fKeymap != NULL) {</a>
<a name="ln557">		int32 keyCode;</a>
<a name="ln558">		const char* data;</a>
<a name="ln559">		ssize_t size;</a>
<a name="ln560">		if (message-&gt;FindData(&quot;text/plain&quot;, B_MIME_DATA,</a>
<a name="ln561">				(const void**)&amp;data, &amp;size) == B_OK) {</a>
<a name="ln562">			// Automatically convert UTF-8 escaped strings (for example from</a>
<a name="ln563">			// CharacterMap)</a>
<a name="ln564">			int32 dataSize = 0;</a>
<a name="ln565">			uint8 buffer[16];</a>
<a name="ln566">			if (size &gt; 3 &amp;&amp; data[0] == '\\' &amp;&amp; data[1] == 'x') {</a>
<a name="ln567">				char tempBuffer[16];</a>
<a name="ln568">				if (size &gt; 15)</a>
<a name="ln569">					size = 15;</a>
<a name="ln570">				memcpy(tempBuffer, data, size);</a>
<a name="ln571">				tempBuffer[size] = '\0';</a>
<a name="ln572">				data = tempBuffer;</a>
<a name="ln573"> </a>
<a name="ln574">				while (size &gt; 3 &amp;&amp; data[0] == '\\' &amp;&amp; data[1] == 'x') {</a>
<a name="ln575">					buffer[dataSize++] = strtoul(&amp;data[2], NULL, 16);</a>
<a name="ln576">					if ((buffer[dataSize - 1] &amp; 0x80) == 0)</a>
<a name="ln577">						break;</a>
<a name="ln578"> </a>
<a name="ln579">					size -= 4;</a>
<a name="ln580">					data += 4;</a>
<a name="ln581">				}</a>
<a name="ln582">				data = (const char*)buffer;</a>
<a name="ln583">			} else if ((data[0] &amp; 0xc0) != 0x80 &amp;&amp; (data[0] &amp; 0x80) != 0) {</a>
<a name="ln584">				// only accept the first character UTF-8 character</a>
<a name="ln585">				while (dataSize &lt; size &amp;&amp; (data[dataSize] &amp; 0x80) != 0) {</a>
<a name="ln586">					dataSize++;</a>
<a name="ln587">				}</a>
<a name="ln588">			} else if ((data[0] &amp; 0x80) == 0) {</a>
<a name="ln589">				// an ASCII character</a>
<a name="ln590">				dataSize = 1;</a>
<a name="ln591">			} else {</a>
<a name="ln592">				// no valid character</a>
<a name="ln593">				beep();</a>
<a name="ln594">				return;</a>
<a name="ln595">			}</a>
<a name="ln596"> </a>
<a name="ln597">			int32 buttons;</a>
<a name="ln598">			if (!message-&gt;IsSourceRemote()</a>
<a name="ln599">				&amp;&amp; message-&gt;FindInt32(&quot;buttons&quot;, &amp;buttons) == B_OK</a>
<a name="ln600">				&amp;&amp; (buttons &amp; B_PRIMARY_MOUSE_BUTTON) != 0</a>
<a name="ln601">				&amp;&amp; message-&gt;FindInt32(&quot;key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln602">				// switch keys if the dropped object came from us</a>
<a name="ln603">				Key* key = _KeyForCode(keyCode);</a>
<a name="ln604">				if (key == NULL</a>
<a name="ln605">					|| (key == fDropTarget &amp;&amp; fDragModifiers == fModifiers)) {</a>
<a name="ln606">					return;</a>
<a name="ln607">				}</a>
<a name="ln608"> </a>
<a name="ln609">				char* string;</a>
<a name="ln610">				int32 numBytes;</a>
<a name="ln611">				fKeymap-&gt;GetChars(fDropTarget-&gt;code, fModifiers, fDeadKey,</a>
<a name="ln612">					&amp;string, &amp;numBytes);</a>
<a name="ln613">				if (string != NULL) {</a>
<a name="ln614">					// switch keys</a>
<a name="ln615">					fKeymap-&gt;SetKey(fDropTarget-&gt;code, fModifiers, fDeadKey,</a>
<a name="ln616">						(const char*)data, dataSize);</a>
<a name="ln617">					fKeymap-&gt;SetKey(key-&gt;code, fDragModifiers, fDeadKey,</a>
<a name="ln618">						string, numBytes);</a>
<a name="ln619">					delete[] string;</a>
<a name="ln620">				} else if (fKeymap-&gt;IsModifierKey(fDropTarget-&gt;code)) {</a>
<a name="ln621">					// switch key with modifier</a>
<a name="ln622">					fKeymap-&gt;SetModifier(key-&gt;code,</a>
<a name="ln623">						fKeymap-&gt;Modifier(fDropTarget-&gt;code));</a>
<a name="ln624">					fKeymap-&gt;SetKey(fDropTarget-&gt;code, fModifiers, fDeadKey,</a>
<a name="ln625">						(const char*)data, dataSize);</a>
<a name="ln626">				}</a>
<a name="ln627">			} else {</a>
<a name="ln628">				// Send the old key to the target, so it's not lost entirely</a>
<a name="ln629">				_SendFakeKeyDown(fDropTarget);</a>
<a name="ln630"> </a>
<a name="ln631">				fKeymap-&gt;SetKey(fDropTarget-&gt;code, fModifiers, fDeadKey,</a>
<a name="ln632">					(const char*)data, dataSize);</a>
<a name="ln633">			}</a>
<a name="ln634">		} else if (!message-&gt;IsSourceRemote()</a>
<a name="ln635">			&amp;&amp; message-&gt;FindInt32(&quot;key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln636">			// Switch an unmapped key</a>
<a name="ln637"> </a>
<a name="ln638">			Key* key = _KeyForCode(keyCode);</a>
<a name="ln639">			if (key != NULL &amp;&amp; key == fDropTarget)</a>
<a name="ln640">				return;</a>
<a name="ln641"> </a>
<a name="ln642">			uint32 modifier = fKeymap-&gt;Modifier(keyCode);</a>
<a name="ln643"> </a>
<a name="ln644">			char* string;</a>
<a name="ln645">			int32 numBytes;</a>
<a name="ln646">			fKeymap-&gt;GetChars(fDropTarget-&gt;code, fModifiers, fDeadKey,</a>
<a name="ln647">				&amp;string, &amp;numBytes);</a>
<a name="ln648">			if (string != NULL) {</a>
<a name="ln649">				// switch key with modifier</a>
<a name="ln650">				fKeymap-&gt;SetModifier(fDropTarget-&gt;code, modifier);</a>
<a name="ln651">				fKeymap-&gt;SetKey(keyCode, fDragModifiers, fDeadKey,</a>
<a name="ln652">					string, numBytes);</a>
<a name="ln653">				delete[] string;</a>
<a name="ln654">			} else {</a>
<a name="ln655">				// switch modifier keys</a>
<a name="ln656">				fKeymap-&gt;SetModifier(keyCode,</a>
<a name="ln657">					fKeymap-&gt;Modifier(fDropTarget-&gt;code));</a>
<a name="ln658">				fKeymap-&gt;SetModifier(fDropTarget-&gt;code, modifier);</a>
<a name="ln659">			}</a>
<a name="ln660"> </a>
<a name="ln661">			_InvalidateKey(fDragKey);</a>
<a name="ln662">		}</a>
<a name="ln663"> </a>
<a name="ln664">		_InvalidateKey(fDropTarget);</a>
<a name="ln665">		fDropTarget = NULL;</a>
<a name="ln666">		fDropPoint.x = -1;</a>
<a name="ln667">		return;</a>
<a name="ln668">	}</a>
<a name="ln669"> </a>
<a name="ln670">	switch (message-&gt;what) {</a>
<a name="ln671">		case B_UNMAPPED_KEY_DOWN:</a>
<a name="ln672">		case B_UNMAPPED_KEY_UP:</a>
<a name="ln673">			_KeyChanged(message);</a>
<a name="ln674">			break;</a>
<a name="ln675"> </a>
<a name="ln676">		case B_MODIFIERS_CHANGED:</a>
<a name="ln677">		{</a>
<a name="ln678">			int32 newModifiers;</a>
<a name="ln679">			if (message-&gt;FindInt32(&quot;modifiers&quot;, &amp;newModifiers) == B_OK</a>
<a name="ln680">				&amp;&amp; fModifiers != newModifiers) {</a>
<a name="ln681">				fModifiers = newModifiers;</a>
<a name="ln682">				_EvaluateDropTarget(fDropPoint);</a>
<a name="ln683">				if (Window()-&gt;IsActive())</a>
<a name="ln684">					Invalidate();</a>
<a name="ln685">			}</a>
<a name="ln686">			break;</a>
<a name="ln687">		}</a>
<a name="ln688"> </a>
<a name="ln689">		default:</a>
<a name="ln690">			BView::MessageReceived(message);</a>
<a name="ln691">			break;</a>
<a name="ln692">	}</a>
<a name="ln693">}</a>
<a name="ln694"> </a>
<a name="ln695"> </a>
<a name="ln696">void</a>
<a name="ln697">KeyboardLayoutView::_InitOffscreen()</a>
<a name="ln698">{</a>
<a name="ln699">	delete fOffscreenBitmap;</a>
<a name="ln700">	fOffscreenView = NULL;</a>
<a name="ln701"> </a>
<a name="ln702">	fOffscreenBitmap = new(std::nothrow) BBitmap(Bounds(),</a>
<a name="ln703">		B_BITMAP_ACCEPTS_VIEWS, B_RGB32);</a>
<a name="ln704">	if (fOffscreenBitmap != NULL &amp;&amp; fOffscreenBitmap-&gt;IsValid()) {</a>
<a name="ln705">		fOffscreenBitmap-&gt;Lock();</a>
<a name="ln706">		fOffscreenView = new(std::nothrow) BView(Bounds(), &quot;offscreen view&quot;,</a>
<a name="ln707">			0, 0);</a>
<a name="ln708">		if (fOffscreenView != NULL) {</a>
<a name="ln709">			if (Parent() != NULL) {</a>
<a name="ln710">				fOffscreenView-&gt;SetViewColor(Parent()-&gt;ViewColor());</a>
<a name="ln711">			} else {</a>
<a name="ln712">				fOffscreenView-&gt;SetViewColor(</a>
<a name="ln713">					ui_color(B_PANEL_BACKGROUND_COLOR));</a>
<a name="ln714">			}</a>
<a name="ln715"> </a>
<a name="ln716">			fOffscreenView-&gt;SetLowColor(fOffscreenView-&gt;ViewColor());</a>
<a name="ln717">			fOffscreenBitmap-&gt;AddChild(fOffscreenView);</a>
<a name="ln718">		}</a>
<a name="ln719">		fOffscreenBitmap-&gt;Unlock();</a>
<a name="ln720">	}</a>
<a name="ln721"> </a>
<a name="ln722">	if (fOffscreenView == NULL) {</a>
<a name="ln723">		// something went wrong</a>
<a name="ln724">		delete fOffscreenBitmap;</a>
<a name="ln725">		fOffscreenBitmap = NULL;</a>
<a name="ln726">	}</a>
<a name="ln727">}</a>
<a name="ln728"> </a>
<a name="ln729"> </a>
<a name="ln730">void</a>
<a name="ln731">KeyboardLayoutView::_LayoutKeyboard()</a>
<a name="ln732">{</a>
<a name="ln733">	float factorX = Bounds().Width() / fLayout-&gt;Bounds().Width();</a>
<a name="ln734">	float factorY = Bounds().Height() / fLayout-&gt;Bounds().Height();</a>
<a name="ln735"> </a>
<a name="ln736">	fFactor = min_c(factorX, factorY);</a>
<a name="ln737">	fOffset = BPoint((Bounds().Width() - fLayout-&gt;Bounds().Width()</a>
<a name="ln738">			* fFactor) / 2,</a>
<a name="ln739">		(Bounds().Height() - fLayout-&gt;Bounds().Height() * fFactor) / 2);</a>
<a name="ln740"> </a>
<a name="ln741">	if (fLayout-&gt;DefaultKeySize().width &lt; 11)</a>
<a name="ln742">		fGap = 1;</a>
<a name="ln743">	else</a>
<a name="ln744">		fGap = 2;</a>
<a name="ln745"> </a>
<a name="ln746">	fOldSize.width = Bounds().Width();</a>
<a name="ln747">	fOldSize.height = Bounds().Height();</a>
<a name="ln748">}</a>
<a name="ln749"> </a>
<a name="ln750"> </a>
<a name="ln751">void</a>
<a name="ln752">KeyboardLayoutView::_DrawKeyButton(BView* view, BRect&amp; rect, BRect updateRect,</a>
<a name="ln753">	rgb_color base, rgb_color background, bool pressed)</a>
<a name="ln754">{</a>
<a name="ln755">	be_control_look-&gt;DrawButtonFrame(view, rect, updateRect, 4.0f, base,</a>
<a name="ln756">		background, pressed ? BControlLook::B_ACTIVATED : 0);</a>
<a name="ln757">	be_control_look-&gt;DrawButtonBackground(view, rect, updateRect, 4.0f,</a>
<a name="ln758">		base, pressed ? BControlLook::B_ACTIVATED : 0);</a>
<a name="ln759">}</a>
<a name="ln760"> </a>
<a name="ln761"> </a>
<a name="ln762">void</a>
<a name="ln763">KeyboardLayoutView::_DrawKey(BView* view, BRect updateRect, const Key* key,</a>
<a name="ln764">	BRect rect, bool pressed)</a>
<a name="ln765">{</a>
<a name="ln766">	rgb_color base = key-&gt;dark ? kDarkColor : kBrightColor;</a>
<a name="ln767">	rgb_color background = ui_color(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln768">	rgb_color keyLabelColor = make_color(0, 0, 0, 255);</a>
<a name="ln769">	key_kind keyKind = kNormalKey;</a>
<a name="ln770">	int32 deadKey = 0;</a>
<a name="ln771">	bool secondDeadKey = false;</a>
<a name="ln772">	bool isDeadKeyEnabled = true;</a>
<a name="ln773"> </a>
<a name="ln774">	char text[32];</a>
<a name="ln775">	if (fKeymap != NULL) {</a>
<a name="ln776">		_GetKeyLabel(key, text, sizeof(text), keyKind);</a>
<a name="ln777">		deadKey = fKeymap-&gt;DeadKey(key-&gt;code, fModifiers, &amp;isDeadKeyEnabled);</a>
<a name="ln778">		secondDeadKey = fKeymap-&gt;IsDeadSecondKey(key-&gt;code, fModifiers,</a>
<a name="ln779">			fDeadKey);</a>
<a name="ln780">	} else {</a>
<a name="ln781">		// Show the key code if there is no keymap</a>
<a name="ln782">		snprintf(text, sizeof(text), &quot;%02&quot; B_PRIx32, key-&gt;code);</a>
<a name="ln783">	}</a>
<a name="ln784"> </a>
<a name="ln785">	_SetFontSize(view, keyKind);</a>
<a name="ln786"> </a>
<a name="ln787">	if (secondDeadKey)</a>
<a name="ln788">		base = kSecondDeadKeyColor;</a>
<a name="ln789">	else if (deadKey &gt; 0 &amp;&amp; isDeadKeyEnabled)</a>
<a name="ln790">		base = kDeadKeyColor;</a>
<a name="ln791"> </a>
<a name="ln792">	if (key-&gt;shape == kRectangleKeyShape) {</a>
<a name="ln793">		_DrawKeyButton(view, rect, updateRect, base, background, pressed);</a>
<a name="ln794"> </a>
<a name="ln795">		rect.InsetBy(1, 1);</a>
<a name="ln796"> </a>
<a name="ln797">		_GetAbbreviatedKeyLabelIfNeeded(view, rect, key, text, sizeof(text));</a>
<a name="ln798">		be_control_look-&gt;DrawLabel(view, text, rect, updateRect,</a>
<a name="ln799">			base, 0, BAlignment(B_ALIGN_CENTER, B_ALIGN_MIDDLE), &amp;keyLabelColor);</a>
<a name="ln800">	} else if (key-&gt;shape == kEnterKeyShape) {</a>
<a name="ln801">		BRect topLeft = rect;</a>
<a name="ln802">		BRect topRight = rect;</a>
<a name="ln803">		BRect bottomLeft = rect;</a>
<a name="ln804">		BRect bottomRight = rect;</a>
<a name="ln805"> </a>
<a name="ln806">		// TODO: for some reason, this does not always equal the bottom of</a>
<a name="ln807">		// the other keys...</a>
<a name="ln808">		bottomLeft.top = floorf(rect.top</a>
<a name="ln809">			+ fLayout-&gt;DefaultKeySize().height * fFactor - fGap - 1);</a>
<a name="ln810">		bottomLeft.right = floorf(rect.left</a>
<a name="ln811">			+ (key-&gt;frame.Width() - key-&gt;second_row) * fFactor - fGap - 2);</a>
<a name="ln812"> </a>
<a name="ln813">		topLeft.bottom = bottomLeft.top;</a>
<a name="ln814">		topLeft.right = bottomLeft.right + 1;</a>
<a name="ln815">			// add one to make the borders meet</a>
<a name="ln816"> </a>
<a name="ln817">		topRight.bottom = topLeft.bottom;</a>
<a name="ln818">		topRight.left = topLeft.right;</a>
<a name="ln819"> </a>
<a name="ln820">		bottomRight.top = bottomLeft.top;</a>
<a name="ln821">		bottomRight.left = bottomLeft.right;</a>
<a name="ln822"> </a>
<a name="ln823">		// draw top left corner</a>
<a name="ln824">		be_control_look-&gt;DrawButtonFrame(view, topLeft, updateRect,</a>
<a name="ln825">			4.0f, 0.0f, 4.0f, 0.0f, base, background,</a>
<a name="ln826">			pressed ? BControlLook::B_ACTIVATED : 0,</a>
<a name="ln827">			BControlLook::B_LEFT_BORDER | BControlLook::B_TOP_BORDER</a>
<a name="ln828">				| BControlLook::B_BOTTOM_BORDER);</a>
<a name="ln829">		be_control_look-&gt;DrawButtonBackground(view, topLeft, updateRect,</a>
<a name="ln830">			4.0f, 0.0f, 4.0f, 0.0f, base,</a>
<a name="ln831">			pressed ? BControlLook::B_ACTIVATED : 0,</a>
<a name="ln832">			BControlLook::B_LEFT_BORDER | BControlLook::B_TOP_BORDER</a>
<a name="ln833">				| BControlLook::B_BOTTOM_BORDER);</a>
<a name="ln834"> </a>
<a name="ln835">		// draw top right corner</a>
<a name="ln836">		be_control_look-&gt;DrawButtonFrame(view, topRight, updateRect,</a>
<a name="ln837">			0.0f, 4.0f, 0.0f, 0.0f, base, background,</a>
<a name="ln838">			pressed ? BControlLook::B_ACTIVATED : 0,</a>
<a name="ln839">			BControlLook::B_TOP_BORDER | BControlLook::B_RIGHT_BORDER);</a>
<a name="ln840">		be_control_look-&gt;DrawButtonBackground(view, topRight, updateRect,</a>
<a name="ln841">			0.0f, 4.0f, 0.0f, 0.0f, base,</a>
<a name="ln842">			pressed ? BControlLook::B_ACTIVATED : 0,</a>
<a name="ln843">			BControlLook::B_TOP_BORDER | BControlLook::B_RIGHT_BORDER);</a>
<a name="ln844"> </a>
<a name="ln845">		// draw bottom right corner</a>
<a name="ln846">		be_control_look-&gt;DrawButtonFrame(view, bottomRight, updateRect,</a>
<a name="ln847">			0.0f, 0.0f, 4.0f, 4.0f, base, background,</a>
<a name="ln848">			pressed ? BControlLook::B_ACTIVATED : 0,</a>
<a name="ln849">			BControlLook::B_LEFT_BORDER | BControlLook::B_RIGHT_BORDER</a>
<a name="ln850">				| BControlLook::B_BOTTOM_BORDER);</a>
<a name="ln851">		be_control_look-&gt;DrawButtonBackground(view, bottomRight, updateRect,</a>
<a name="ln852">			0.0f, 0.0f, 4.0f, 4.0f, base,</a>
<a name="ln853">			pressed ? BControlLook::B_ACTIVATED : 0,</a>
<a name="ln854">			BControlLook::B_LEFT_BORDER | BControlLook::B_RIGHT_BORDER</a>
<a name="ln855">				| BControlLook::B_BOTTOM_BORDER);</a>
<a name="ln856"> </a>
<a name="ln857">		// clip out the bottom left corner</a>
<a name="ln858">		bottomLeft.right += 1;</a>
<a name="ln859">		bottomLeft.top -= 2;</a>
<a name="ln860">		BRegion region(rect);</a>
<a name="ln861">		region.Exclude(bottomLeft);</a>
<a name="ln862">		view-&gt;ConstrainClippingRegion(&amp;region);</a>
<a name="ln863"> </a>
<a name="ln864">		// Fill in the rect with the background color</a>
<a name="ln865">		SetHighColor(background);</a>
<a name="ln866">		FillRect(rect);</a>
<a name="ln867"> </a>
<a name="ln868">		// draw the button background</a>
<a name="ln869">		BRect bgRect = rect.InsetByCopy(2, 2);</a>
<a name="ln870">		be_control_look-&gt;DrawButtonBackground(view, bgRect, updateRect,</a>
<a name="ln871">			4.0f, 4.0f, 0.0f, 4.0f, base,</a>
<a name="ln872">			pressed ? BControlLook::B_ACTIVATED : 0);</a>
<a name="ln873"> </a>
<a name="ln874">		rect.left = bottomLeft.right;</a>
<a name="ln875">		_GetAbbreviatedKeyLabelIfNeeded(view, rect, key, text, sizeof(text));</a>
<a name="ln876"> </a>
<a name="ln877">		// draw the button label</a>
<a name="ln878">		be_control_look-&gt;DrawLabel(view, text, rect, updateRect,</a>
<a name="ln879">			base, 0, BAlignment(B_ALIGN_CENTER, B_ALIGN_MIDDLE), &amp;keyLabelColor);</a>
<a name="ln880"> </a>
<a name="ln881">		// reset the clipping region</a>
<a name="ln882">		view-&gt;ConstrainClippingRegion(NULL);</a>
<a name="ln883">	}</a>
<a name="ln884">}</a>
<a name="ln885"> </a>
<a name="ln886"> </a>
<a name="ln887">void</a>
<a name="ln888">KeyboardLayoutView::_DrawIndicator(BView* view, BRect updateRect,</a>
<a name="ln889">	const Indicator* indicator, BRect rect, bool lit)</a>
<a name="ln890">{</a>
<a name="ln891">	float rectTop = rect.top;</a>
<a name="ln892">	rect.top += 2 * rect.Height() / 3;</a>
<a name="ln893"> </a>
<a name="ln894">	const char* label = NULL;</a>
<a name="ln895">	if (indicator-&gt;modifier == B_CAPS_LOCK)</a>
<a name="ln896">		label = &quot;caps&quot;;</a>
<a name="ln897">	else if (indicator-&gt;modifier == B_NUM_LOCK)</a>
<a name="ln898">		label = &quot;num&quot;;</a>
<a name="ln899">	else if (indicator-&gt;modifier == B_SCROLL_LOCK)</a>
<a name="ln900">		label = &quot;scroll&quot;;</a>
<a name="ln901">	if (label != NULL) {</a>
<a name="ln902">		_SetFontSize(view, kIndicator);</a>
<a name="ln903"> </a>
<a name="ln904">		font_height fontHeight;</a>
<a name="ln905">		GetFontHeight(&amp;fontHeight);</a>
<a name="ln906">		if (ceilf(rect.top - fontHeight.ascent + fontHeight.descent - 2)</a>
<a name="ln907">				&gt;= rectTop) {</a>
<a name="ln908">			view-&gt;SetHighColor(0, 0, 0);</a>
<a name="ln909">			view-&gt;SetLowColor(ViewColor());</a>
<a name="ln910"> </a>
<a name="ln911">			BString text(label);</a>
<a name="ln912">			view-&gt;TruncateString(&amp;text, B_TRUNCATE_END, rect.Width());</a>
<a name="ln913">			view-&gt;DrawString(text.String(),</a>
<a name="ln914">				BPoint(ceilf(rect.left + (rect.Width()</a>
<a name="ln915">						- StringWidth(text.String())) / 2),</a>
<a name="ln916">					ceilf(rect.top - fontHeight.descent - 2)));</a>
<a name="ln917">		}</a>
<a name="ln918">	}</a>
<a name="ln919"> </a>
<a name="ln920">	rect.left += rect.Width() / 4;</a>
<a name="ln921">	rect.right -= rect.Width() / 3;</a>
<a name="ln922"> </a>
<a name="ln923">	rgb_color background = ui_color(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln924">	rgb_color base = lit ? kLitIndicatorColor : kDarkColor;</a>
<a name="ln925"> </a>
<a name="ln926">	be_control_look-&gt;DrawButtonFrame(view, rect, updateRect, base,</a>
<a name="ln927">		background, BControlLook::B_DISABLED);</a>
<a name="ln928">	be_control_look-&gt;DrawButtonBackground(view, rect, updateRect,</a>
<a name="ln929">		base, BControlLook::B_DISABLED);</a>
<a name="ln930">}</a>
<a name="ln931"> </a>
<a name="ln932"> </a>
<a name="ln933">const char*</a>
<a name="ln934">KeyboardLayoutView::_SpecialKeyLabel(const key_map&amp; map, uint32 code,</a>
<a name="ln935">	bool abbreviated)</a>
<a name="ln936">{</a>
<a name="ln937">	if (code == map.caps_key) {</a>
<a name="ln938">		return abbreviated</a>
<a name="ln939">			? B_TRANSLATE_COMMENT(&quot;CAPS&quot;, &quot;Very short for 'caps lock'&quot;)</a>
<a name="ln940">			: B_TRANSLATE(&quot;CAPS LOCK&quot;);</a>
<a name="ln941">	}</a>
<a name="ln942">	if (code == map.scroll_key)</a>
<a name="ln943">		return B_TRANSLATE(&quot;SCROLL&quot;);</a>
<a name="ln944">	if (code == map.num_key) {</a>
<a name="ln945">		return abbreviated</a>
<a name="ln946">			? B_TRANSLATE_COMMENT(&quot;NUM&quot;, &quot;Very short for 'num lock'&quot;)</a>
<a name="ln947">			: B_TRANSLATE(&quot;NUM LOCK&quot;);</a>
<a name="ln948">	}</a>
<a name="ln949">	if (code == map.left_shift_key || code == map.right_shift_key)</a>
<a name="ln950">		return B_TRANSLATE(&quot;SHIFT&quot;);</a>
<a name="ln951">	if (code == map.left_command_key || code == map.right_command_key) {</a>
<a name="ln952">		return abbreviated</a>
<a name="ln953">			? B_TRANSLATE_COMMENT(&quot;CMD&quot;, &quot;Very short for 'command'&quot;)</a>
<a name="ln954">			: B_TRANSLATE(&quot;COMMAND&quot;);</a>
<a name="ln955">	}</a>
<a name="ln956">	if (code == map.left_control_key || code == map.right_control_key) {</a>
<a name="ln957">		return abbreviated</a>
<a name="ln958">			? B_TRANSLATE_COMMENT(&quot;CTRL&quot;, &quot;Very short for 'control'&quot;)</a>
<a name="ln959">			: B_TRANSLATE(&quot;CONTROL&quot;);</a>
<a name="ln960">	}</a>
<a name="ln961">	if (code == map.left_option_key || code == map.right_option_key) {</a>
<a name="ln962">		return abbreviated</a>
<a name="ln963">			? B_TRANSLATE_COMMENT(&quot;OPT&quot;, &quot;Very short for 'option'&quot;)</a>
<a name="ln964">			: B_TRANSLATE(&quot;OPTION&quot;);</a>
<a name="ln965">	}</a>
<a name="ln966">	if (code == map.menu_key)</a>
<a name="ln967">		return B_TRANSLATE(&quot;MENU&quot;);</a>
<a name="ln968">	if (code == B_PRINT_KEY)</a>
<a name="ln969">		return B_TRANSLATE(&quot;PRINT&quot;);</a>
<a name="ln970">	if (code == B_PAUSE_KEY)</a>
<a name="ln971">		return B_TRANSLATE(&quot;PAUSE&quot;);</a>
<a name="ln972"> </a>
<a name="ln973">	return NULL;</a>
<a name="ln974">}</a>
<a name="ln975"> </a>
<a name="ln976"> </a>
<a name="ln977">const char*</a>
<a name="ln978">KeyboardLayoutView::_SpecialMappedKeySymbol(const char* bytes, size_t numBytes)</a>
<a name="ln979">{</a>
<a name="ln980">	if (numBytes != 1)</a>
<a name="ln981">		return NULL;</a>
<a name="ln982"> </a>
<a name="ln983">	if (bytes[0] == B_TAB)</a>
<a name="ln984">		return &quot;\xe2\x86\xb9&quot;;</a>
<a name="ln985">	if (bytes[0] == B_ENTER)</a>
<a name="ln986">		return &quot;\xe2\x86\xb5&quot;;</a>
<a name="ln987">	if (bytes[0] == B_BACKSPACE)</a>
<a name="ln988">		return &quot;\xe2\x8c\xab&quot;;</a>
<a name="ln989"> </a>
<a name="ln990">	if (bytes[0] == B_UP_ARROW)</a>
<a name="ln991">		return &quot;\xe2\x86\x91&quot;;</a>
<a name="ln992">	if (bytes[0] == B_LEFT_ARROW)</a>
<a name="ln993">		return &quot;\xe2\x86\x90&quot;;</a>
<a name="ln994">	if (bytes[0] == B_DOWN_ARROW)</a>
<a name="ln995">		return &quot;\xe2\x86\x93&quot;;</a>
<a name="ln996">	if (bytes[0] == B_RIGHT_ARROW)</a>
<a name="ln997">		return &quot;\xe2\x86\x92&quot;;</a>
<a name="ln998"> </a>
<a name="ln999">	return NULL;</a>
<a name="ln1000">}</a>
<a name="ln1001"> </a>
<a name="ln1002"> </a>
<a name="ln1003">const char*</a>
<a name="ln1004">KeyboardLayoutView::_SpecialMappedKeyLabel(const char* bytes, size_t numBytes,</a>
<a name="ln1005">	bool abbreviated)</a>
<a name="ln1006">{</a>
<a name="ln1007">	if (numBytes != 1)</a>
<a name="ln1008">		return NULL;</a>
<a name="ln1009">	if (bytes[0] == B_ESCAPE)</a>
<a name="ln1010">		return B_TRANSLATE(&quot;ESC&quot;);</a>
<a name="ln1011">	if (bytes[0] == B_INSERT)</a>
<a name="ln1012">		return B_TRANSLATE(&quot;INS&quot;);</a>
<a name="ln1013">	if (bytes[0] == B_DELETE)</a>
<a name="ln1014">		return B_TRANSLATE(&quot;DEL&quot;);</a>
<a name="ln1015">	if (bytes[0] == B_HOME)</a>
<a name="ln1016">		return B_TRANSLATE(&quot;HOME&quot;);</a>
<a name="ln1017">	if (bytes[0] == B_END)</a>
<a name="ln1018">		return B_TRANSLATE(&quot;END&quot;);</a>
<a name="ln1019">	if (bytes[0] == B_PAGE_UP) {</a>
<a name="ln1020">		return abbreviated</a>
<a name="ln1021">			? B_TRANSLATE_COMMENT(&quot;PG \xe2\x86\x91&quot;,</a>
<a name="ln1022">				&quot;Very short for 'page up'&quot;)</a>
<a name="ln1023">			: B_TRANSLATE(&quot;PAGE \xe2\x86\x91&quot;);</a>
<a name="ln1024">	}</a>
<a name="ln1025">	if (bytes[0] == B_PAGE_DOWN) {</a>
<a name="ln1026">		return abbreviated</a>
<a name="ln1027">			? B_TRANSLATE_COMMENT(&quot;PG \xe2\x86\x93&quot;,</a>
<a name="ln1028">				&quot;Very short for 'page down'&quot;)</a>
<a name="ln1029">			: B_TRANSLATE(&quot;PAGE \xe2\x86\x93&quot;);</a>
<a name="ln1030">	}</a>
<a name="ln1031"> </a>
<a name="ln1032">	return NULL;</a>
<a name="ln1033">}</a>
<a name="ln1034"> </a>
<a name="ln1035"> </a>
<a name="ln1036">bool</a>
<a name="ln1037">KeyboardLayoutView::_FunctionKeyLabel(uint32 code, char* text, size_t textSize)</a>
<a name="ln1038">{</a>
<a name="ln1039">	if (code &gt;= B_F1_KEY &amp;&amp; code &lt;= B_F12_KEY) {</a>
<a name="ln1040">		snprintf(text, textSize, &quot;F%&quot; B_PRId32, code + 1 - B_F1_KEY);</a>
<a name="ln1041">		return true;</a>
<a name="ln1042">	}</a>
<a name="ln1043"> </a>
<a name="ln1044">	return false;</a>
<a name="ln1045">}</a>
<a name="ln1046"> </a>
<a name="ln1047"> </a>
<a name="ln1048">void</a>
<a name="ln1049">KeyboardLayoutView::_GetAbbreviatedKeyLabelIfNeeded(BView* view, BRect rect,</a>
<a name="ln1050">	const Key* key, char* text, size_t textSize)</a>
<a name="ln1051">{</a>
<a name="ln1052">	if (floorf(rect.Width()) &gt; ceilf(view-&gt;StringWidth(text)))</a>
<a name="ln1053">		return;</a>
<a name="ln1054"> </a>
<a name="ln1055">	// Check if we have a shorter version of this key</a>
<a name="ln1056"> </a>
<a name="ln1057">	const key_map&amp; map = fKeymap-&gt;Map();</a>
<a name="ln1058"> </a>
<a name="ln1059">	const char* special = _SpecialKeyLabel(map, key-&gt;code, true);</a>
<a name="ln1060">	if (special != NULL) {</a>
<a name="ln1061">		strlcpy(text, special, textSize);</a>
<a name="ln1062">		return;</a>
<a name="ln1063">	}</a>
<a name="ln1064"> </a>
<a name="ln1065">	char* bytes = NULL;</a>
<a name="ln1066">	int32 numBytes;</a>
<a name="ln1067">	fKeymap-&gt;GetChars(key-&gt;code, fModifiers, fDeadKey, &amp;bytes, &amp;numBytes);</a>
<a name="ln1068">	if (bytes != NULL) {</a>
<a name="ln1069">		special = _SpecialMappedKeyLabel(bytes, numBytes, true);</a>
<a name="ln1070">		if (special != NULL)</a>
<a name="ln1071">			strlcpy(text, special, textSize);</a>
<a name="ln1072"> </a>
<a name="ln1073">		delete[] bytes;</a>
<a name="ln1074">	}</a>
<a name="ln1075">}</a>
<a name="ln1076"> </a>
<a name="ln1077"> </a>
<a name="ln1078">void</a>
<a name="ln1079">KeyboardLayoutView::_GetKeyLabel(const Key* key, char* text, size_t textSize,</a>
<a name="ln1080">	key_kind&amp; keyKind)</a>
<a name="ln1081">{</a>
<a name="ln1082">	const key_map&amp; map = fKeymap-&gt;Map();</a>
<a name="ln1083">	keyKind = kNormalKey;</a>
<a name="ln1084">	text[0] = '\0';</a>
<a name="ln1085"> </a>
<a name="ln1086">	const char* special = _SpecialKeyLabel(map, key-&gt;code);</a>
<a name="ln1087">	if (special != NULL) {</a>
<a name="ln1088">		strlcpy(text, special, textSize);</a>
<a name="ln1089">		keyKind = kSpecialKey;</a>
<a name="ln1090">		return;</a>
<a name="ln1091">	}</a>
<a name="ln1092"> </a>
<a name="ln1093">	if (_FunctionKeyLabel(key-&gt;code, text, textSize)) {</a>
<a name="ln1094">		keyKind = kSpecialKey;</a>
<a name="ln1095">		return;</a>
<a name="ln1096">	}</a>
<a name="ln1097"> </a>
<a name="ln1098">	char* bytes = NULL;</a>
<a name="ln1099">	int32 numBytes;</a>
<a name="ln1100">	fKeymap-&gt;GetChars(key-&gt;code, fModifiers, fDeadKey, &amp;bytes, &amp;numBytes);</a>
<a name="ln1101">	if (bytes != NULL) {</a>
<a name="ln1102">		special = _SpecialMappedKeyLabel(bytes, numBytes);</a>
<a name="ln1103">		if (special != NULL) {</a>
<a name="ln1104">			strlcpy(text, special, textSize);</a>
<a name="ln1105">			keyKind = kSpecialKey;</a>
<a name="ln1106">		} else {</a>
<a name="ln1107">			special = _SpecialMappedKeySymbol(bytes, numBytes);</a>
<a name="ln1108">			if (special != NULL) {</a>
<a name="ln1109">				strlcpy(text, special, textSize);</a>
<a name="ln1110">				keyKind = kSymbolKey;</a>
<a name="ln1111">			} else {</a>
<a name="ln1112">				bool hasGlyphs;</a>
<a name="ln1113">				fBaseFont.GetHasGlyphs(bytes, 1, &amp;hasGlyphs);</a>
<a name="ln1114">				if (hasGlyphs)</a>
<a name="ln1115">					strlcpy(text, bytes, textSize);</a>
<a name="ln1116">			}</a>
<a name="ln1117">		}</a>
<a name="ln1118"> </a>
<a name="ln1119">		delete[] bytes;</a>
<a name="ln1120">	}</a>
<a name="ln1121">}</a>
<a name="ln1122"> </a>
<a name="ln1123"> </a>
<a name="ln1124">bool</a>
<a name="ln1125">KeyboardLayoutView::_IsKeyPressed(uint32 code)</a>
<a name="ln1126">{</a>
<a name="ln1127">	if (fDropTarget != NULL &amp;&amp; fDropTarget-&gt;code == code)</a>
<a name="ln1128">		return true;</a>
<a name="ln1129"> </a>
<a name="ln1130">	return _KeyState(code);</a>
<a name="ln1131">}</a>
<a name="ln1132"> </a>
<a name="ln1133"> </a>
<a name="ln1134">bool</a>
<a name="ln1135">KeyboardLayoutView::_KeyState(uint32 code) const</a>
<a name="ln1136">{</a>
<a name="ln1137">	if (code &gt;= 16 * 8)</a>
<a name="ln1138">		return false;</a>
<a name="ln1139"> </a>
<a name="ln1140">	return (fKeyState[code / 8] &amp; (1 &lt;&lt; (7 - (code &amp; 7)))) != 0;</a>
<a name="ln1141">}</a>
<a name="ln1142"> </a>
<a name="ln1143"> </a>
<a name="ln1144">void</a>
<a name="ln1145">KeyboardLayoutView::_SetKeyState(uint32 code, bool pressed)</a>
<a name="ln1146">{</a>
<a name="ln1147">	if (code &gt;= 16 * 8)</a>
<a name="ln1148">		return;</a>
<a name="ln1149"> </a>
<a name="ln1150">	if (pressed)</a>
<a name="ln1151">		fKeyState[code / 8] |= (1 &lt;&lt; (7 - (code &amp; 7)));</a>
<a name="ln1152">	else</a>
<a name="ln1153">		fKeyState[code / 8] &amp;= ~(1 &lt;&lt; (7 - (code &amp; 7)));</a>
<a name="ln1154">}</a>
<a name="ln1155"> </a>
<a name="ln1156"> </a>
<a name="ln1157">Key*</a>
<a name="ln1158">KeyboardLayoutView::_KeyForCode(uint32 code)</a>
<a name="ln1159">{</a>
<a name="ln1160">	// TODO: have a lookup array</a>
<a name="ln1161"> </a>
<a name="ln1162">	for (int32 i = 0; i &lt; fLayout-&gt;CountKeys(); i++) {</a>
<a name="ln1163">		Key* key = fLayout-&gt;KeyAt(i);</a>
<a name="ln1164">		if (key-&gt;code == code)</a>
<a name="ln1165">			return key;</a>
<a name="ln1166">	}</a>
<a name="ln1167"> </a>
<a name="ln1168">	return NULL;</a>
<a name="ln1169">}</a>
<a name="ln1170"> </a>
<a name="ln1171"> </a>
<a name="ln1172">void</a>
<a name="ln1173">KeyboardLayoutView::_InvalidateKey(uint32 code)</a>
<a name="ln1174">{</a>
<a name="ln1175">	_InvalidateKey(_KeyForCode(code));</a>
<a name="ln1176">}</a>
<a name="ln1177"> </a>
<a name="ln1178"> </a>
<a name="ln1179">void</a>
<a name="ln1180">KeyboardLayoutView::_InvalidateKey(const Key* key)</a>
<a name="ln1181">{</a>
<a name="ln1182">	if (key != NULL)</a>
<a name="ln1183">		Invalidate(_FrameFor(key));</a>
<a name="ln1184">}</a>
<a name="ln1185"> </a>
<a name="ln1186"> </a>
<a name="ln1187">/*!	Updates the fDeadKey member, and invalidates the view if needed.</a>
<a name="ln1188"> </a>
<a name="ln1189">	\return true if the view has been invalidated.</a>
<a name="ln1190">*/</a>
<a name="ln1191">bool</a>
<a name="ln1192">KeyboardLayoutView::_HandleDeadKey(uint32 key, int32 modifiers)</a>
<a name="ln1193">{</a>
<a name="ln1194">	if (fKeymap == NULL || fKeymap-&gt;IsModifierKey(key))</a>
<a name="ln1195">		return false;</a>
<a name="ln1196"> </a>
<a name="ln1197">	bool isEnabled = false;</a>
<a name="ln1198">	int32 deadKey = fKeymap-&gt;DeadKey(key, modifiers, &amp;isEnabled);</a>
<a name="ln1199">	if (fDeadKey != deadKey &amp;&amp; isEnabled) {</a>
<a name="ln1200">		fDeadKey = deadKey;</a>
<a name="ln1201">		Invalidate();</a>
<a name="ln1202">		return true;</a>
<a name="ln1203">	} else if (fDeadKey != 0) {</a>
<a name="ln1204">		fDeadKey = 0;</a>
<a name="ln1205">		Invalidate();</a>
<a name="ln1206">		return true;</a>
<a name="ln1207">	}</a>
<a name="ln1208"> </a>
<a name="ln1209">	return false;</a>
<a name="ln1210">}</a>
<a name="ln1211"> </a>
<a name="ln1212"> </a>
<a name="ln1213">void</a>
<a name="ln1214">KeyboardLayoutView::_KeyChanged(const BMessage* message)</a>
<a name="ln1215">{</a>
<a name="ln1216">	const uint8* state;</a>
<a name="ln1217">	ssize_t size;</a>
<a name="ln1218">	int32 key;</a>
<a name="ln1219">	if (message-&gt;FindInt32(&quot;key&quot;, &amp;key) != B_OK</a>
<a name="ln1220">		|| message-&gt;FindData(&quot;states&quot;, B_UINT8_TYPE,</a>
<a name="ln1221">			(const void**)&amp;state, &amp;size) != B_OK) {</a>
<a name="ln1222">		return;</a>
<a name="ln1223">	}</a>
<a name="ln1224"> </a>
<a name="ln1225">	// Update key state, and invalidate change keys</a>
<a name="ln1226"> </a>
<a name="ln1227">	bool checkSingle = true;</a>
<a name="ln1228"> </a>
<a name="ln1229">	if (message-&gt;what == B_KEY_UP || message-&gt;what == B_UNMAPPED_KEY_UP) {</a>
<a name="ln1230">		if (_HandleDeadKey(key, fModifiers))</a>
<a name="ln1231">			checkSingle = false;</a>
<a name="ln1232"> </a>
<a name="ln1233">		if (_KeyForCode(key) == NULL)</a>
<a name="ln1234">			printf(&quot;no key for code %&quot; B_PRId32 &quot;\n&quot;, key);</a>
<a name="ln1235">	}</a>
<a name="ln1236"> </a>
<a name="ln1237">	for (int32 i = 0; i &lt; 16; i++) {</a>
<a name="ln1238">		if (fKeyState[i] != state[i]) {</a>
<a name="ln1239">			uint8 diff = fKeyState[i] ^ state[i];</a>
<a name="ln1240">			fKeyState[i] = state[i];</a>
<a name="ln1241"> </a>
<a name="ln1242">			if (!checkSingle || !Window()-&gt;IsActive())</a>
<a name="ln1243">				continue;</a>
<a name="ln1244"> </a>
<a name="ln1245">			for (int32 j = 7; diff != 0; j--, diff &gt;&gt;= 1) {</a>
<a name="ln1246">				if (diff &amp; 1) {</a>
<a name="ln1247">					_InvalidateKey(i * 8 + j);</a>
<a name="ln1248">				}</a>
<a name="ln1249">			}</a>
<a name="ln1250">		}</a>
<a name="ln1251">	}</a>
<a name="ln1252">}</a>
<a name="ln1253"> </a>
<a name="ln1254"> </a>
<a name="ln1255">Key*</a>
<a name="ln1256">KeyboardLayoutView::_KeyAt(BPoint point)</a>
<a name="ln1257">{</a>
<a name="ln1258">	// Find key candidate</a>
<a name="ln1259"> </a>
<a name="ln1260">	BPoint keyPoint = point;</a>
<a name="ln1261">	keyPoint -= fOffset;</a>
<a name="ln1262">	keyPoint.x /= fFactor;</a>
<a name="ln1263">	keyPoint.y /= fFactor;</a>
<a name="ln1264"> </a>
<a name="ln1265">	for (int32 i = fLayout-&gt;CountKeys() - 1; i &gt;= 0; i--) {</a>
<a name="ln1266">		Key* key = fLayout-&gt;KeyAt(i);</a>
<a name="ln1267">		if (key-&gt;frame.Contains(keyPoint)) {</a>
<a name="ln1268">			BRect frame = _FrameFor(key);</a>
<a name="ln1269">			if (frame.Contains(point))</a>
<a name="ln1270">				return key;</a>
<a name="ln1271"> </a>
<a name="ln1272">			return NULL;</a>
<a name="ln1273">		}</a>
<a name="ln1274">	}</a>
<a name="ln1275"> </a>
<a name="ln1276">	return NULL;</a>
<a name="ln1277">}</a>
<a name="ln1278"> </a>
<a name="ln1279"> </a>
<a name="ln1280">BRect</a>
<a name="ln1281">KeyboardLayoutView::_FrameFor(BRect keyFrame)</a>
<a name="ln1282">{</a>
<a name="ln1283">	BRect rect;</a>
<a name="ln1284">	rect.left	= ceilf(keyFrame.left * fFactor);</a>
<a name="ln1285">	rect.top	= ceilf(keyFrame.top * fFactor);</a>
<a name="ln1286">	rect.right	= floorf((keyFrame.Width()) * fFactor + rect.left - fGap - 1);</a>
<a name="ln1287">	rect.bottom	= floorf((keyFrame.Height()) * fFactor + rect.top - fGap - 1);</a>
<a name="ln1288">	rect.OffsetBy(fOffset);</a>
<a name="ln1289"> </a>
<a name="ln1290">	return rect;</a>
<a name="ln1291">}</a>
<a name="ln1292"> </a>
<a name="ln1293"> </a>
<a name="ln1294">BRect</a>
<a name="ln1295">KeyboardLayoutView::_FrameFor(const Key* key)</a>
<a name="ln1296">{</a>
<a name="ln1297">	return _FrameFor(key-&gt;frame);</a>
<a name="ln1298">}</a>
<a name="ln1299"> </a>
<a name="ln1300"> </a>
<a name="ln1301">void</a>
<a name="ln1302">KeyboardLayoutView::_SetFontSize(BView* view, key_kind keyKind)</a>
<a name="ln1303">{</a>
<a name="ln1304">	BSize size = fLayout-&gt;DefaultKeySize();</a>
<a name="ln1305">	float fontSize = fBaseFontSize;</a>
<a name="ln1306">	if (fBaseFontHeight &gt;= size.height * fFactor * 0.5) {</a>
<a name="ln1307">		fontSize *= (size.height * fFactor * 0.5) / fBaseFontHeight;</a>
<a name="ln1308">		if (fontSize &lt; 8)</a>
<a name="ln1309">			fontSize = 8;</a>
<a name="ln1310">	}</a>
<a name="ln1311"> </a>
<a name="ln1312">	switch (keyKind) {</a>
<a name="ln1313">		case kNormalKey:</a>
<a name="ln1314">			fBaseFont.SetSize(fontSize);</a>
<a name="ln1315">			view-&gt;SetFont(&amp;fBaseFont);</a>
<a name="ln1316">			break;</a>
<a name="ln1317">		case kSpecialKey:</a>
<a name="ln1318">			fSpecialFont.SetSize(fontSize * 0.7);</a>
<a name="ln1319">			view-&gt;SetFont(&amp;fSpecialFont);</a>
<a name="ln1320">			break;</a>
<a name="ln1321">		case kSymbolKey:</a>
<a name="ln1322">			fSpecialFont.SetSize(fontSize * 1.6);</a>
<a name="ln1323">			view-&gt;SetFont(&amp;fSpecialFont);</a>
<a name="ln1324">			break;</a>
<a name="ln1325"> </a>
<a name="ln1326">		case kIndicator:</a>
<a name="ln1327">		{</a>
<a name="ln1328">			BFont font;</a>
<a name="ln1329">			font.SetSize(fontSize * 0.8);</a>
<a name="ln1330">			view-&gt;SetFont(&amp;font);</a>
<a name="ln1331">			break;</a>
<a name="ln1332">		}</a>
<a name="ln1333">	}</a>
<a name="ln1334">}</a>
<a name="ln1335"> </a>
<a name="ln1336"> </a>
<a name="ln1337">void</a>
<a name="ln1338">KeyboardLayoutView::_EvaluateDropTarget(BPoint point)</a>
<a name="ln1339">{</a>
<a name="ln1340">	fDropTarget = _KeyAt(point);</a>
<a name="ln1341">	if (fDropTarget != NULL) {</a>
<a name="ln1342">		if (fDropTarget == fDragKey &amp;&amp; fModifiers == fDragModifiers)</a>
<a name="ln1343">			fDropTarget = NULL;</a>
<a name="ln1344">		else</a>
<a name="ln1345">			_InvalidateKey(fDropTarget);</a>
<a name="ln1346">	}</a>
<a name="ln1347">}</a>
<a name="ln1348"> </a>
<a name="ln1349"> </a>
<a name="ln1350">void</a>
<a name="ln1351">KeyboardLayoutView::_SendFakeKeyDown(const Key* key)</a>
<a name="ln1352">{</a>
<a name="ln1353">	BMessage message(B_KEY_DOWN);</a>
<a name="ln1354">	message.AddInt64(&quot;when&quot;, system_time());</a>
<a name="ln1355">	message.AddData(&quot;states&quot;, B_UINT8_TYPE, &amp;fKeyState,</a>
<a name="ln1356">		sizeof(fKeyState));</a>
<a name="ln1357">	message.AddInt32(&quot;key&quot;, key-&gt;code);</a>
<a name="ln1358">	message.AddInt32(&quot;modifiers&quot;, fModifiers);</a>
<a name="ln1359">	message.AddPointer(&quot;keymap&quot;, fKeymap);</a>
<a name="ln1360"> </a>
<a name="ln1361">	char* string;</a>
<a name="ln1362">	int32 numBytes;</a>
<a name="ln1363">	fKeymap-&gt;GetChars(key-&gt;code, fModifiers, fDeadKey, &amp;string,</a>
<a name="ln1364">		&amp;numBytes);</a>
<a name="ln1365">	if (string != NULL) {</a>
<a name="ln1366">		message.AddString(&quot;bytes&quot;, string);</a>
<a name="ln1367">		delete[] string;</a>
<a name="ln1368">	}</a>
<a name="ln1369"> </a>
<a name="ln1370">	fKeymap-&gt;GetChars(key-&gt;code, 0, 0, &amp;string, &amp;numBytes);</a>
<a name="ln1371">	if (string != NULL) {</a>
<a name="ln1372">		message.AddInt32(&quot;raw_char&quot;, string[0]);</a>
<a name="ln1373">		message.AddInt8(&quot;byte&quot;, string[0]);</a>
<a name="ln1374">		delete[] string;</a>
<a name="ln1375">	}</a>
<a name="ln1376"> </a>
<a name="ln1377">	fTarget.SendMessage(&amp;message);</a>
<a name="ln1378">}</a>
<a name="ln1379"> </a>
<a name="ln1380"> </a>
<a name="ln1381">BMenuItem*</a>
<a name="ln1382">KeyboardLayoutView::_CreateSwapModifiersMenuItem(uint32 modifier,</a>
<a name="ln1383">	uint32 displayModifier, uint32 oldCode, uint32 newCode)</a>
<a name="ln1384">{</a>
<a name="ln1385">	int32 mask = B_SHIFT_KEY | B_COMMAND_KEY | B_CONTROL_KEY | B_OPTION_KEY;</a>
<a name="ln1386">	const char* oldName = _NameForModifier(oldCode == 0x00 ? modifier</a>
<a name="ln1387">		: fKeymap-&gt;Modifier(oldCode) &amp; ~mask, false);</a>
<a name="ln1388">	const char* newName = _NameForModifier(newCode == 0x00 ? modifier</a>
<a name="ln1389">		: fKeymap-&gt;Modifier(newCode) &amp; ~mask, false);</a>
<a name="ln1390"> </a>
<a name="ln1391">	BMessage* message = new BMessage(kMsgUpdateModifierKeys);</a>
<a name="ln1392">	if (newName != NULL)</a>
<a name="ln1393">		message-&gt;AddUInt32(newName, oldCode);</a>
<a name="ln1394"> </a>
<a name="ln1395">	if (oldName != NULL)</a>
<a name="ln1396">		message-&gt;AddUInt32(oldName, newCode);</a>
<a name="ln1397"> </a>
<a name="ln1398">	if (oldCode == newCode)</a>
<a name="ln1399">		message-&gt;AddBool(&quot;unset&quot;, true);</a>
<a name="ln1400"> </a>
<a name="ln1401">	return new BMenuItem(_NameForModifier(displayModifier, true), message);</a>
<a name="ln1402">}</a>
<a name="ln1403"> </a>
<a name="ln1404"> </a>
<a name="ln1405">const char*</a>
<a name="ln1406">KeyboardLayoutView::_NameForModifier(uint32 modifier, bool pretty)</a>
<a name="ln1407">{</a>
<a name="ln1408">	if (modifier == B_CAPS_LOCK)</a>
<a name="ln1409">		return pretty ? B_TRANSLATE(&quot;Caps lock&quot;) : &quot;caps_key&quot;;</a>
<a name="ln1410">	else if (modifier == B_NUM_LOCK)</a>
<a name="ln1411">		return pretty ? B_TRANSLATE(&quot;Num lock&quot;) : &quot;num_key&quot;;</a>
<a name="ln1412">	else if (modifier == B_SCROLL_LOCK)</a>
<a name="ln1413">		return pretty ? B_TRANSLATE(&quot;Scroll lock&quot;) : &quot;scroll_key&quot;;</a>
<a name="ln1414">	else if (modifier == B_SHIFT_KEY) {</a>
<a name="ln1415">		return pretty ? B_TRANSLATE_COMMENT(&quot;Shift&quot;, &quot;Shift key&quot;)</a>
<a name="ln1416">			: &quot;shift_key&quot;;</a>
<a name="ln1417">	} else if (modifier == B_LEFT_SHIFT_KEY)</a>
<a name="ln1418">		return pretty ? B_TRANSLATE(&quot;Left shift&quot;) : &quot;left_shift_key&quot;;</a>
<a name="ln1419">	else if (modifier == B_RIGHT_SHIFT_KEY)</a>
<a name="ln1420">		return pretty ? B_TRANSLATE(&quot;Right shift&quot;) : &quot;right_shift_key&quot;;</a>
<a name="ln1421">	else if (modifier == B_COMMAND_KEY) {</a>
<a name="ln1422">		return pretty ? B_TRANSLATE_COMMENT(&quot;Command&quot;, &quot;Command key&quot;)</a>
<a name="ln1423">			: &quot;command_key&quot;;</a>
<a name="ln1424">	} else if (modifier == B_LEFT_COMMAND_KEY)</a>
<a name="ln1425">		return pretty ? B_TRANSLATE(&quot;Left command&quot;) : &quot;left_command_key&quot;;</a>
<a name="ln1426">	else if (modifier == B_RIGHT_COMMAND_KEY)</a>
<a name="ln1427">		return pretty ? B_TRANSLATE(&quot;Right command&quot;) : &quot;right_command_key&quot;;</a>
<a name="ln1428">	else if (modifier == B_CONTROL_KEY) {</a>
<a name="ln1429">		return pretty ? B_TRANSLATE_COMMENT(&quot;Control&quot;, &quot;Control key&quot;)</a>
<a name="ln1430">			: &quot;control_key&quot;;</a>
<a name="ln1431">	} else if (modifier == B_LEFT_CONTROL_KEY)</a>
<a name="ln1432">		return pretty ? B_TRANSLATE(&quot;Left control&quot;) : &quot;left_control_key&quot;;</a>
<a name="ln1433">	else if (modifier == B_RIGHT_CONTROL_KEY)</a>
<a name="ln1434">		return pretty ? B_TRANSLATE(&quot;Right control&quot;) : &quot;right_control_key&quot;;</a>
<a name="ln1435">	else if (modifier == B_OPTION_KEY) {</a>
<a name="ln1436">		return pretty ? B_TRANSLATE_COMMENT(&quot;Option&quot;, &quot;Option key&quot;)</a>
<a name="ln1437">			: &quot;option_key&quot;;</a>
<a name="ln1438">	} else if (modifier == B_LEFT_OPTION_KEY)</a>
<a name="ln1439">		return pretty ? B_TRANSLATE(&quot;Left option&quot;) : &quot;left_option_key&quot;;</a>
<a name="ln1440">	else if (modifier == B_RIGHT_OPTION_KEY)</a>
<a name="ln1441">		return pretty ? B_TRANSLATE(&quot;Right option&quot;) : &quot;right_option_key&quot;;</a>
<a name="ln1442">	else if (modifier == B_MENU_KEY)</a>
<a name="ln1443">		return pretty ? B_TRANSLATE_COMMENT(&quot;Menu&quot;, &quot;Menu key&quot;) : &quot;menu_key&quot;;</a>
<a name="ln1444"> </a>
<a name="ln1445">	return NULL;</a>
<a name="ln1446">}</a>

</code></pre>
<div class="balloon" rel="83"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: fOffscreenView, fDragModifiers, fBaseFontHeight, fBaseFontSize, fFactor, fGap.</p></div>
<div class="balloon" rel="231"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alternativesPopUp' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="333"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'modifiersPopUp' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
