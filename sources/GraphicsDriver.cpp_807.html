
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>GraphicsDriver.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * GraphicsDriver.cpp</a>
<a name="ln3"> * Copyright 1999-2000 Y.Takagi. All Rights Reserved.</a>
<a name="ln4"> */</a>
<a name="ln5"> </a>
<a name="ln6">#include &lt;algorithm&gt;</a>
<a name="ln7">#include &lt;cstdio&gt;</a>
<a name="ln8">#include &lt;cstdarg&gt;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;Alert.h&gt;</a>
<a name="ln11">#include &lt;Bitmap.h&gt;</a>
<a name="ln12">#include &lt;Debug.h&gt;</a>
<a name="ln13">#include &lt;Message.h&gt;</a>
<a name="ln14">#include &lt;PrintJob.h&gt;</a>
<a name="ln15">#include &lt;Region.h&gt;</a>
<a name="ln16">#include &lt;TextControl.h&gt;</a>
<a name="ln17">#include &lt;TextControl.h&gt;</a>
<a name="ln18">#include &lt;StopWatch.h&gt;</a>
<a name="ln19">#include &lt;View.h&gt;</a>
<a name="ln20">#include &lt;Directory.h&gt;</a>
<a name="ln21">#include &lt;File.h&gt;</a>
<a name="ln22"> </a>
<a name="ln23">#include &quot;GraphicsDriver.h&quot;</a>
<a name="ln24">#include &quot;PrintProcess.h&quot;</a>
<a name="ln25">#include &quot;JobData.h&quot;</a>
<a name="ln26">#include &quot;PrinterData.h&quot;</a>
<a name="ln27">#include &quot;PrinterCap.h&quot;</a>
<a name="ln28">#include &quot;Preview.h&quot;</a>
<a name="ln29">#include &quot;Transport.h&quot;</a>
<a name="ln30">#include &quot;ValidRect.h&quot;</a>
<a name="ln31">#include &quot;DbgMsg.h&quot;</a>
<a name="ln32"> </a>
<a name="ln33"> </a>
<a name="ln34">using namespace std;</a>
<a name="ln35"> </a>
<a name="ln36"> </a>
<a name="ln37">// Measure printJob() time. Either true or false.</a>
<a name="ln38">#define MEASURE_PRINT_JOB_TIME false</a>
<a name="ln39"> </a>
<a name="ln40"> </a>
<a name="ln41">enum {</a>
<a name="ln42">	kMaxMemorySize = 4 * 1024 * 1024</a>
<a name="ln43">};</a>
<a name="ln44"> </a>
<a name="ln45"> </a>
<a name="ln46">GraphicsDriver::GraphicsDriver(BMessage* message, PrinterData* printerData,</a>
<a name="ln47">	const PrinterCap* printerCap)</a>
<a name="ln48">	:</a>
<a name="ln49">	fMessage(message),</a>
<a name="ln50">	fView(NULL),</a>
<a name="ln51">	fBitmap(NULL),</a>
<a name="ln52">	fRotatedBitmap(NULL),</a>
<a name="ln53">	fTransport(NULL),</a>
<a name="ln54">	fOrgJobData(NULL),</a>
<a name="ln55">	fRealJobData(NULL),</a>
<a name="ln56">	fPrinterData(printerData),</a>
<a name="ln57">	fPrinterCap(printerCap),</a>
<a name="ln58">	fSpoolMetaData(NULL),</a>
<a name="ln59">	fPageWidth(0),</a>
<a name="ln60">	fPageHeight(0),</a>
<a name="ln61">	fBandWidth(0),</a>
<a name="ln62">	fBandHeight(0),</a>
<a name="ln63">	fPixelDepth(0),</a>
<a name="ln64">	fBandCount(0),</a>
<a name="ln65">	fInternalCopies(0),</a>
<a name="ln66">	fPageCount(0),</a>
<a name="ln67">	fStatusWindow(NULL)</a>
<a name="ln68">{</a>
<a name="ln69">}</a>
<a name="ln70"> </a>
<a name="ln71"> </a>
<a name="ln72">GraphicsDriver::~GraphicsDriver()</a>
<a name="ln73">{</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76"> </a>
<a name="ln77">static BRect</a>
<a name="ln78">RotateRect(BRect rect)</a>
<a name="ln79">{</a>
<a name="ln80">	BRect rotated(rect.top, rect.left, rect.bottom, rect.right);</a>
<a name="ln81">	return rotated;</a>
<a name="ln82">}</a>
<a name="ln83"> </a>
<a name="ln84"> </a>
<a name="ln85">bool </a>
<a name="ln86">GraphicsDriver::_SetupData(BFile* spoolFile)</a>
<a name="ln87">{</a>
<a name="ln88">	if (fOrgJobData != NULL) {</a>
<a name="ln89">		// already initialized</a>
<a name="ln90">		return true;</a>
<a name="ln91">	}</a>
<a name="ln92"> </a>
<a name="ln93">	print_file_header pfh;</a>
<a name="ln94">	spoolFile-&gt;Seek(0, SEEK_SET);</a>
<a name="ln95">	spoolFile-&gt;Read(&amp;pfh, sizeof(pfh));</a>
<a name="ln96"> </a>
<a name="ln97">	DBGMSG((&quot;print_file_header::version = 0x%x\n&quot;,  pfh.version));</a>
<a name="ln98">	DBGMSG((&quot;print_file_header::page_count = %d\n&quot;, pfh.page_count));</a>
<a name="ln99">	DBGMSG((&quot;print_file_header::first_page = 0x%x\n&quot;, (int)pfh.first_page));</a>
<a name="ln100"> </a>
<a name="ln101">	if (pfh.page_count &lt;= 0) {</a>
<a name="ln102">		// nothing to print</a>
<a name="ln103">		return false;</a>
<a name="ln104">	}</a>
<a name="ln105"> </a>
<a name="ln106">	fPageCount = (uint32) pfh.page_count;</a>
<a name="ln107">	BMessage *msg = new BMessage();</a>
<a name="ln108">	msg-&gt;Unflatten(spoolFile);</a>
<a name="ln109">	fOrgJobData = new JobData(msg, fPrinterCap, JobData::kJobSettings);</a>
<a name="ln110">	DUMP_BMESSAGE(msg);</a>
<a name="ln111">	delete msg;</a>
<a name="ln112"> </a>
<a name="ln113">	fRealJobData = new JobData(*fOrgJobData);</a>
<a name="ln114"> </a>
<a name="ln115">	switch (fOrgJobData-&gt;GetNup()) {</a>
<a name="ln116">	case 2:</a>
<a name="ln117">	case 8:</a>
<a name="ln118">	case 32:</a>
<a name="ln119">	case 128:</a>
<a name="ln120">		fRealJobData-&gt;SetPrintableRect(</a>
<a name="ln121">			RotateRect(fOrgJobData-&gt;GetPrintableRect()));</a>
<a name="ln122">		fRealJobData-&gt;SetScaledPrintableRect(</a>
<a name="ln123">			RotateRect(fOrgJobData-&gt;GetScaledPrintableRect()));</a>
<a name="ln124">		fRealJobData-&gt;SetPhysicalRect(</a>
<a name="ln125">			RotateRect(fOrgJobData-&gt;GetPhysicalRect()));</a>
<a name="ln126">		fRealJobData-&gt;SetScaledPhysicalRect(</a>
<a name="ln127">			RotateRect(fOrgJobData-&gt;GetScaledPhysicalRect()));</a>
<a name="ln128"> </a>
<a name="ln129">		if (JobData::kPortrait == fOrgJobData-&gt;GetOrientation())</a>
<a name="ln130">			fRealJobData-&gt;SetOrientation(JobData::kLandscape);</a>
<a name="ln131">		else</a>
<a name="ln132">			fRealJobData-&gt;SetOrientation(JobData::kPortrait);</a>
<a name="ln133">		break;</a>
<a name="ln134">	}</a>
<a name="ln135"> </a>
<a name="ln136">	if (fOrgJobData-&gt;GetCollate() &amp;&amp; fPageCount &gt; 1) {</a>
<a name="ln137">		fRealJobData-&gt;SetCopies(1);</a>
<a name="ln138">		fInternalCopies = fOrgJobData-&gt;GetCopies();</a>
<a name="ln139">	} else {</a>
<a name="ln140">		fInternalCopies = 1;</a>
<a name="ln141">	}</a>
<a name="ln142">	</a>
<a name="ln143">	fSpoolMetaData = new SpoolMetaData(spoolFile);</a>
<a name="ln144">	return true;</a>
<a name="ln145">}</a>
<a name="ln146"> </a>
<a name="ln147"> </a>
<a name="ln148">void </a>
<a name="ln149">GraphicsDriver::_CleanupData()</a>
<a name="ln150">{</a>
<a name="ln151">	delete fRealJobData;</a>
<a name="ln152">	delete fOrgJobData;</a>
<a name="ln153">	delete fSpoolMetaData;</a>
<a name="ln154">	fRealJobData   = NULL;</a>
<a name="ln155">	fOrgJobData    = NULL;</a>
<a name="ln156">	fSpoolMetaData = NULL;</a>
<a name="ln157">}</a>
<a name="ln158"> </a>
<a name="ln159"> </a>
<a name="ln160">void </a>
<a name="ln161">GraphicsDriver::_SetupBitmap()</a>
<a name="ln162">{</a>
<a name="ln163">	fPixelDepth = color_space2pixel_depth(fOrgJobData-&gt;GetSurfaceType());</a>
<a name="ln164"> </a>
<a name="ln165">	fPageWidth  = (fRealJobData-&gt;GetPhysicalRect().IntegerWidth()</a>
<a name="ln166">		* fOrgJobData-&gt;GetXres() + 71) / 72;</a>
<a name="ln167">	fPageHeight = (fRealJobData-&gt;GetPhysicalRect().IntegerHeight()</a>
<a name="ln168">		* fOrgJobData-&gt;GetYres() + 71) / 72;</a>
<a name="ln169"> </a>
<a name="ln170">	int widthByte = (fPageWidth * fPixelDepth + 7) / 8;</a>
<a name="ln171">	int size = widthByte * fPageHeight;</a>
<a name="ln172">#ifdef USE_PREVIEW_FOR_DEBUG</a>
<a name="ln173">	size = 0;</a>
<a name="ln174">#endif</a>
<a name="ln175"> </a>
<a name="ln176">	if (size &lt; kMaxMemorySize) {</a>
<a name="ln177">		fBandCount  = 0;</a>
<a name="ln178">		fBandWidth  = fPageWidth;</a>
<a name="ln179">		fBandHeight = fPageHeight;</a>
<a name="ln180">	} else {</a>
<a name="ln181">		fBandCount  = (size + kMaxMemorySize - 1) / kMaxMemorySize;</a>
<a name="ln182">		if (_NeedRotateBitmapBand()) {</a>
<a name="ln183">			fBandWidth  = (fPageWidth + fBandCount - 1) / fBandCount;</a>
<a name="ln184">			fBandHeight = fPageHeight;</a>
<a name="ln185">		} else {</a>
<a name="ln186">			fBandWidth  = fPageWidth;</a>
<a name="ln187">			fBandHeight = (fPageHeight + fBandCount - 1) / fBandCount;</a>
<a name="ln188">		}</a>
<a name="ln189">	}</a>
<a name="ln190"> </a>
<a name="ln191">	DBGMSG((&quot;****************\n&quot;));</a>
<a name="ln192">	DBGMSG((&quot;page_width  = %d\n&quot;, fPageWidth));</a>
<a name="ln193">	DBGMSG((&quot;page_height = %d\n&quot;, fPageHeight));</a>
<a name="ln194">	DBGMSG((&quot;band_count  = %d\n&quot;, fBandCount));</a>
<a name="ln195">	DBGMSG((&quot;band_height = %d\n&quot;, fBandHeight));</a>
<a name="ln196">	DBGMSG((&quot;****************\n&quot;));</a>
<a name="ln197"> </a>
<a name="ln198">	BRect rect;</a>
<a name="ln199">	rect.Set(0, 0, fBandWidth - 1, fBandHeight - 1);</a>
<a name="ln200">	fBitmap = new BBitmap(rect, fOrgJobData-&gt;GetSurfaceType(), true);</a>
<a name="ln201">	fView   = new BView(rect, &quot;&quot;, B_FOLLOW_ALL, B_WILL_DRAW);</a>
<a name="ln202">	fBitmap-&gt;AddChild(fView);</a>
<a name="ln203"> </a>
<a name="ln204">	if (_NeedRotateBitmapBand()) {</a>
<a name="ln205">		BRect rotatedRect(0, 0, rect.bottom, rect.right);</a>
<a name="ln206">		fRotatedBitmap = new BBitmap(rotatedRect, fOrgJobData-&gt;GetSurfaceType(),</a>
<a name="ln207">			false);</a>
<a name="ln208">	}</a>
<a name="ln209">}</a>
<a name="ln210"> </a>
<a name="ln211"> </a>
<a name="ln212">void </a>
<a name="ln213">GraphicsDriver::_CleanupBitmap()</a>
<a name="ln214">{</a>
<a name="ln215">	delete fBitmap;</a>
<a name="ln216">	fBitmap = NULL;</a>
<a name="ln217">	fView   = NULL;</a>
<a name="ln218"> </a>
<a name="ln219">	delete fRotatedBitmap;</a>
<a name="ln220">	fRotatedBitmap = NULL;</a>
<a name="ln221">}</a>
<a name="ln222"> </a>
<a name="ln223"> </a>
<a name="ln224">BPoint </a>
<a name="ln225">GraphicsDriver::GetScale(int32 nup, BRect physicalRect, float scaling)</a>
<a name="ln226">{</a>
<a name="ln227">	float width;</a>
<a name="ln228">	float height;</a>
<a name="ln229">	BPoint scale;</a>
<a name="ln230"> </a>
<a name="ln231">	scale.x = scale.y = 1.0f;</a>
<a name="ln232"> </a>
<a name="ln233">	switch (nup) {</a>
<a name="ln234">	case 1:</a>
<a name="ln235">		scale.x = scale.y = 1.0f;</a>
<a name="ln236">		break;</a>
<a name="ln237">	case 2:	/* 1x2 or 2x1 */</a>
<a name="ln238">		width  = physicalRect.Width();</a>
<a name="ln239">		height = physicalRect.Height();</a>
<a name="ln240">		if (width &lt; height) {	// portrait</a>
<a name="ln241">			scale.x = height / 2.0f / width;</a>
<a name="ln242">			scale.y = width / height;</a>
<a name="ln243">		} else {	// landscape</a>
<a name="ln244">			scale.x = height / width;</a>
<a name="ln245">			scale.y = width / 2.0f / height;</a>
<a name="ln246">		}</a>
<a name="ln247">		break;</a>
<a name="ln248">	case 8:	/* 2x4 or 4x2 */</a>
<a name="ln249">		width  = physicalRect.Width();</a>
<a name="ln250">		height = physicalRect.Height();</a>
<a name="ln251">		if (width &lt; height) {</a>
<a name="ln252">			scale.x = height / 4.0f / width;</a>
<a name="ln253">			scale.y = width / height / 2.0f;</a>
<a name="ln254">		} else {</a>
<a name="ln255">			scale.x = height / width / 2.0f;</a>
<a name="ln256">			scale.y = width / 4.0f / height;</a>
<a name="ln257">		}</a>
<a name="ln258">		break;</a>
<a name="ln259">	case 32:	/* 4x8 or 8x4 */</a>
<a name="ln260">		width  = physicalRect.Width();</a>
<a name="ln261">		height = physicalRect.Height();</a>
<a name="ln262">		if (width &lt; height) {</a>
<a name="ln263">			scale.x = height / 8.0f / width;</a>
<a name="ln264">			scale.y = width / height / 4.0f;</a>
<a name="ln265">		} else {</a>
<a name="ln266">			scale.x = height / width / 4.0f;</a>
<a name="ln267">			scale.y = width / 8.0f / height;</a>
<a name="ln268">		}</a>
<a name="ln269">		break;</a>
<a name="ln270">	case 4:		/* 2x2 */</a>
<a name="ln271">		scale.x = scale.y = 1.0f / 2.0f;</a>
<a name="ln272">		break;</a>
<a name="ln273">	case 9:		/* 3x3 */</a>
<a name="ln274">		scale.x = scale.y = 1.0f / 3.0f;</a>
<a name="ln275">		break;</a>
<a name="ln276">	case 16:	/* 4x4 */</a>
<a name="ln277">		scale.x = scale.y = 1.0f / 4.0f;</a>
<a name="ln278">		break;</a>
<a name="ln279">	case 25:	/* 5x5 */</a>
<a name="ln280">		scale.x = scale.y = 1.0f / 5.0f;</a>
<a name="ln281">		break;</a>
<a name="ln282">	case 36:	/* 6x6 */</a>
<a name="ln283">		scale.x = scale.y = 1.0f / 6.0f;</a>
<a name="ln284">		break;</a>
<a name="ln285">	case 49:	/* 7x7 */</a>
<a name="ln286">		scale.x = scale.y = 1.0f / 7.0f;</a>
<a name="ln287">		break;</a>
<a name="ln288">	case 64:	/* 8x8 */</a>
<a name="ln289">		scale.x = scale.y = 1.0f / 8.0f;</a>
<a name="ln290">		break;</a>
<a name="ln291">	case 81:	/* 9x9 */</a>
<a name="ln292">		scale.x = scale.y = 1.0f / 9.0f;</a>
<a name="ln293">		break;</a>
<a name="ln294">	case 100:	/* 10x10 */</a>
<a name="ln295">		scale.x = scale.y = 1.0f / 10.0f;</a>
<a name="ln296">		break;</a>
<a name="ln297">	case 121:	/* 11x11 */</a>
<a name="ln298">		scale.x = scale.y = 1.0f / 11.0f;</a>
<a name="ln299">		break;</a>
<a name="ln300">	}</a>
<a name="ln301"> </a>
<a name="ln302">	scale.x = scale.x * scaling / 100.0;</a>
<a name="ln303">	scale.y = scale.y * scaling / 100.0;</a>
<a name="ln304"> </a>
<a name="ln305">	return scale;</a>
<a name="ln306">}</a>
<a name="ln307"> </a>
<a name="ln308"> </a>
<a name="ln309">BPoint </a>
<a name="ln310">GraphicsDriver::GetOffset(int32 nup, int index,</a>
<a name="ln311">	JobData::Orientation orientation, const BPoint* scale,</a>
<a name="ln312">	BRect scaledPhysicalRect, BRect scaledPrintableRect,</a>
<a name="ln313">	BRect physicalRect)</a>
<a name="ln314">{</a>
<a name="ln315">	BPoint offset;</a>
<a name="ln316">	offset.x = 0;</a>
<a name="ln317">	offset.y = 0;</a>
<a name="ln318"> </a>
<a name="ln319">	float width  = scaledPhysicalRect.Width();</a>
<a name="ln320">	float height = scaledPhysicalRect.Height();</a>
<a name="ln321"> </a>
<a name="ln322">	switch (nup) {</a>
<a name="ln323">	case 1:</a>
<a name="ln324">		break;</a>
<a name="ln325">	case 2:</a>
<a name="ln326">		if (index == 1) {</a>
<a name="ln327">			if (JobData::kPortrait == orientation) {</a>
<a name="ln328">				offset.x = width;</a>
<a name="ln329">			} else {</a>
<a name="ln330">				offset.y = height;</a>
<a name="ln331">			}</a>
<a name="ln332">		}</a>
<a name="ln333">		break;</a>
<a name="ln334">	case 8:</a>
<a name="ln335">		if (JobData::kPortrait == orientation) {</a>
<a name="ln336">			offset.x = width  * (index / 2);</a>
<a name="ln337">			offset.y = height * (index % 2);</a>
<a name="ln338">		} else {</a>
<a name="ln339">			offset.x = width  * (index % 2);</a>
<a name="ln340">			offset.y = height * (index / 2);</a>
<a name="ln341">		}</a>
<a name="ln342">		break;</a>
<a name="ln343">	case 32:</a>
<a name="ln344">		if (JobData::kPortrait == orientation) {</a>
<a name="ln345">			offset.x = width  * (index / 4);</a>
<a name="ln346">			offset.y = height * (index % 4);</a>
<a name="ln347">		} else {</a>
<a name="ln348">			offset.x = width  * (index % 4);</a>
<a name="ln349">			offset.y = height * (index / 4);</a>
<a name="ln350">		}</a>
<a name="ln351">		break;</a>
<a name="ln352">	case 4:</a>
<a name="ln353">		offset.x = width  * (index / 2);</a>
<a name="ln354">		offset.y = height * (index % 2);</a>
<a name="ln355">		break;</a>
<a name="ln356">	case 9:</a>
<a name="ln357">		offset.x = width  * (index / 3);</a>
<a name="ln358">		offset.y = height * (index % 3);</a>
<a name="ln359">		break;</a>
<a name="ln360">	case 16:</a>
<a name="ln361">		offset.x = width  * (index / 4);</a>
<a name="ln362">		offset.y = height * (index % 4);</a>
<a name="ln363">		break;</a>
<a name="ln364">	case 25:</a>
<a name="ln365">		offset.x = width  * (index / 5);</a>
<a name="ln366">		offset.y = height * (index % 5);</a>
<a name="ln367">		break;</a>
<a name="ln368">	case 36:</a>
<a name="ln369">		offset.x = width  * (index / 6);</a>
<a name="ln370">		offset.y = height * (index % 6);</a>
<a name="ln371">		break;</a>
<a name="ln372">	case 49:</a>
<a name="ln373">		offset.x = width  * (index / 7);</a>
<a name="ln374">		offset.y = height * (index % 7);</a>
<a name="ln375">		break;</a>
<a name="ln376">	case 64:</a>
<a name="ln377">		offset.x = width  * (index / 8);</a>
<a name="ln378">		offset.y = height * (index % 8);</a>
<a name="ln379">		break;</a>
<a name="ln380">	case 81:</a>
<a name="ln381">		offset.x = width  * (index / 9);</a>
<a name="ln382">		offset.y = height * (index % 9);</a>
<a name="ln383">		break;</a>
<a name="ln384">	case 100:</a>
<a name="ln385">		offset.x = width  * (index / 10);</a>
<a name="ln386">		offset.y = height * (index % 10);</a>
<a name="ln387">		break;</a>
<a name="ln388">	case 121:</a>
<a name="ln389">		offset.x = width  * (index / 11);</a>
<a name="ln390">		offset.y = height * (index % 11);</a>
<a name="ln391">		break;</a>
<a name="ln392">	}</a>
<a name="ln393"> </a>
<a name="ln394">	// adjust margin</a>
<a name="ln395">	offset.x += scaledPrintableRect.left - physicalRect.left;</a>
<a name="ln396">	offset.y += scaledPrintableRect.top - physicalRect.top;</a>
<a name="ln397"> </a>
<a name="ln398">	float real_scale = min(scale-&gt;x, scale-&gt;y);</a>
<a name="ln399">	if (real_scale != scale-&gt;x)</a>
<a name="ln400">		offset.x *= scale-&gt;x / real_scale;</a>
<a name="ln401">	else</a>
<a name="ln402">		offset.y *= scale-&gt;y / real_scale;</a>
<a name="ln403"> </a>
<a name="ln404">	return offset;</a>
<a name="ln405">}</a>
<a name="ln406"> </a>
<a name="ln407"> </a>
<a name="ln408">// print the specified pages on a physical page</a>
<a name="ln409">bool </a>
<a name="ln410">GraphicsDriver::_PrintPage(PageDataList* pages)</a>
<a name="ln411">{</a>
<a name="ln412">	BPoint offset;</a>
<a name="ln413">	offset.x = 0.0f;</a>
<a name="ln414">	offset.y = 0.0f;</a>
<a name="ln415"> </a>
<a name="ln416">	if (pages == NULL) {</a>
<a name="ln417">		return true;</a>
<a name="ln418">	}</a>
<a name="ln419"> </a>
<a name="ln420">	do {</a>
<a name="ln421">		// clear the physical page</a>
<a name="ln422">		fView-&gt;SetScale(1.0);</a>
<a name="ln423">		fView-&gt;SetHighColor(255, 255, 255);</a>
<a name="ln424">		fView-&gt;ConstrainClippingRegion(NULL);</a>
<a name="ln425">		fView-&gt;FillRect(fView-&gt;Bounds());</a>
<a name="ln426"> </a>
<a name="ln427">		BPoint scale = GetScale(fOrgJobData-&gt;GetNup(),</a>
<a name="ln428">			fOrgJobData-&gt;GetPhysicalRect(), fOrgJobData-&gt;GetScaling());</a>
<a name="ln429">		float real_scale = min(scale.x, scale.y) * fOrgJobData-&gt;GetXres()</a>
<a name="ln430">			/ 72.0f;</a>
<a name="ln431">		fView-&gt;SetScale(real_scale);</a>
<a name="ln432">		float x = offset.x / real_scale;</a>
<a name="ln433">		float y = offset.y / real_scale;</a>
<a name="ln434">		int page_index = 0;</a>
<a name="ln435"> </a>
<a name="ln436">		for (PageDataList::iterator it = pages-&gt;begin(); it != pages-&gt;end();</a>
<a name="ln437">			it++) {</a>
<a name="ln438">			BPoint left_top(GetOffset(fOrgJobData-&gt;GetNup(), page_index++,</a>
<a name="ln439">				fOrgJobData-&gt;GetOrientation(), &amp;scale,</a>
<a name="ln440">				fOrgJobData-&gt;GetScaledPhysicalRect(),</a>
<a name="ln441">				fOrgJobData-&gt;GetScaledPrintableRect(),</a>
<a name="ln442">				fOrgJobData-&gt;GetPhysicalRect()));</a>
<a name="ln443"> </a>
<a name="ln444">			left_top.x -= x;</a>
<a name="ln445">			left_top.y -= y;</a>
<a name="ln446"> </a>
<a name="ln447">			BRect clip(fOrgJobData-&gt;GetScaledPrintableRect());</a>
<a name="ln448">			clip.OffsetTo(left_top);</a>
<a name="ln449"> </a>
<a name="ln450">			BRegion *region = new BRegion();</a>
<a name="ln451">			region-&gt;Set(clip);</a>
<a name="ln452">			fView-&gt;ConstrainClippingRegion(region);</a>
<a name="ln453">			delete region;</a>
<a name="ln454"> </a>
<a name="ln455">			if ((*it)-&gt;startEnum()) {</a>
<a name="ln456">				bool more;</a>
<a name="ln457">				do {</a>
<a name="ln458">					PictureData	*picture_data;</a>
<a name="ln459">					more = (*it)-&gt;enumObject(&amp;picture_data);</a>
<a name="ln460">					BPoint real_offset = left_top + picture_data-&gt;point;</a>
<a name="ln461">					fView-&gt;DrawPicture(picture_data-&gt;picture, real_offset);</a>
<a name="ln462">					fView-&gt;Sync();</a>
<a name="ln463">					delete picture_data;</a>
<a name="ln464">				} while (more);</a>
<a name="ln465">			}</a>
<a name="ln466">		}</a>
<a name="ln467"> </a>
<a name="ln468">		if (!_PrintBand(fBitmap, &amp;offset))</a>
<a name="ln469">			return false;</a>
<a name="ln470"> </a>
<a name="ln471">	} while (offset.x &gt;= 0.0f &amp;&amp; offset.y &gt;= 0.0f);</a>
<a name="ln472">	</a>
<a name="ln473">	return true;</a>
<a name="ln474">}</a>
<a name="ln475"> </a>
<a name="ln476"> </a>
<a name="ln477">bool</a>
<a name="ln478">GraphicsDriver::_PrintBand(BBitmap* band, BPoint* offset)</a>
<a name="ln479">{</a>
<a name="ln480">	if (!_NeedRotateBitmapBand())</a>
<a name="ln481">		return NextBand(band, offset);</a>
<a name="ln482"> </a>
<a name="ln483">	_RotateInto(fRotatedBitmap, band);</a>
<a name="ln484"> </a>
<a name="ln485">	BPoint rotatedOffset(offset-&gt;y, offset-&gt;x);</a>
<a name="ln486">	bool success = NextBand(fRotatedBitmap, &amp;rotatedOffset);</a>
<a name="ln487">	offset-&gt;x = rotatedOffset.y;</a>
<a name="ln488">	offset-&gt;y = rotatedOffset.x;</a>
<a name="ln489"> </a>
<a name="ln490">	return success;</a>
<a name="ln491">}</a>
<a name="ln492"> </a>
<a name="ln493"> </a>
<a name="ln494">void</a>
<a name="ln495">GraphicsDriver::_RotateInto(BBitmap* target, const BBitmap* source)</a>
<a name="ln496">{</a>
<a name="ln497">	ASSERT(target-&gt;ColorSpace() == B_RGB32);</a>
<a name="ln498">	ASSERT(source-&gt;ColorSpace() == B_RGB32);</a>
<a name="ln499">	ASSERT(target-&gt;Bounds().IntegerWidth() == source-&gt;Bounds().IntegerHeight());</a>
<a name="ln500">	ASSERT(target-&gt;Bounds().IntegerHeight() == source-&gt;Bounds().IntegerWidth());</a>
<a name="ln501"> </a>
<a name="ln502">	const int32 width = source-&gt;Bounds().IntegerWidth() + 1;</a>
<a name="ln503">	const int32 height = source-&gt;Bounds().IntegerHeight() + 1;</a>
<a name="ln504"> </a>
<a name="ln505">	const int32 sourceBPR = source-&gt;BytesPerRow();</a>
<a name="ln506">	const int32 targetBPR = target-&gt;BytesPerRow();</a>
<a name="ln507"> </a>
<a name="ln508">	const uint8_t* sourceBits =</a>
<a name="ln509">		reinterpret_cast&lt;const uint8_t*&gt;(source-&gt;Bits());</a>
<a name="ln510">	uint8_t* targetBits = static_cast&lt;uint8_t*&gt;(target-&gt;Bits());</a>
<a name="ln511"> </a>
<a name="ln512">	for (int32 y = 0; y &lt; height; y ++) {</a>
<a name="ln513">		for (int32 x = 0; x &lt; width; x ++) {</a>
<a name="ln514">			const uint32_t* sourcePixel =</a>
<a name="ln515">				reinterpret_cast&lt;const uint32_t*&gt;(sourceBits + sourceBPR * y</a>
<a name="ln516">					+ sizeof(uint32_t) * x);</a>
<a name="ln517"> </a>
<a name="ln518">			int32 targetX = (height - y - 1);</a>
<a name="ln519">			int32 targetY = x;</a>
<a name="ln520">			uint32_t* targetPixel =</a>
<a name="ln521">				reinterpret_cast&lt;uint32_t*&gt;(targetBits + targetBPR * targetY</a>
<a name="ln522">					+ sizeof(uint32_t) * targetX);</a>
<a name="ln523">			*targetPixel = *sourcePixel;</a>
<a name="ln524">		}</a>
<a name="ln525">	}</a>
<a name="ln526">}</a>
<a name="ln527"> </a>
<a name="ln528">bool </a>
<a name="ln529">GraphicsDriver::_CollectPages(SpoolData* spoolData, PageDataList* pages)</a>
<a name="ln530">{</a>
<a name="ln531">	// collect the pages to be printed on the physical page</a>
<a name="ln532">	PageData *page_data;</a>
<a name="ln533">	int nup = fOrgJobData-&gt;GetNup();</a>
<a name="ln534">	bool more;</a>
<a name="ln535">	do {</a>
<a name="ln536">		more = spoolData-&gt;enumObject(&amp;page_data);</a>
<a name="ln537">		if (pages != NULL)</a>
<a name="ln538">			pages-&gt;push_back(page_data);</a>
<a name="ln539">	} while (more &amp;&amp; --nup);</a>
<a name="ln540">	</a>
<a name="ln541">	return more;</a>
<a name="ln542">}</a>
<a name="ln543"> </a>
<a name="ln544"> </a>
<a name="ln545">bool </a>
<a name="ln546">GraphicsDriver::_SkipPages(SpoolData* spoolData)</a>
<a name="ln547">{</a>
<a name="ln548">	return _CollectPages(spoolData, NULL);</a>
<a name="ln549">}</a>
<a name="ln550"> </a>
<a name="ln551"> </a>
<a name="ln552">bool </a>
<a name="ln553">GraphicsDriver::_PrintDocument(SpoolData* spoolData)</a>
<a name="ln554">{</a>
<a name="ln555">	bool more;</a>
<a name="ln556">	bool success;</a>
<a name="ln557">	int page_index;</a>
<a name="ln558">	int copy;</a>
<a name="ln559">	int copies;</a>
<a name="ln560"> </a>
<a name="ln561">	more = true;</a>
<a name="ln562">	success = true;</a>
<a name="ln563">	page_index = 0;</a>
<a name="ln564">	</a>
<a name="ln565">	if (fPrinterCap-&gt;Supports(PrinterCap::kCopyCommand))</a>
<a name="ln566">		// let the printer perform the copy operation</a>
<a name="ln567">		copies = 1;</a>
<a name="ln568">	else</a>
<a name="ln569">		// send the page multiple times to the printer</a>
<a name="ln570">		copies = fRealJobData-&gt;GetCopies();</a>
<a name="ln571"> </a>
<a name="ln572">	fStatusWindow -&gt; SetPageCopies(copies);</a>
<a name="ln573">		// inform fStatusWindow about number of copies</a>
<a name="ln574">	</a>
<a name="ln575">	// printing of even/odd numbered pages only is valid in simplex mode</a>
<a name="ln576">	bool simplex = fRealJobData-&gt;GetPrintStyle() == JobData::kSimplex;</a>
<a name="ln577">	</a>
<a name="ln578">	if (spoolData-&gt;startEnum()) {</a>
<a name="ln579">		do {</a>
<a name="ln580">			DBGMSG((&quot;page index = %d\n&quot;, page_index));</a>
<a name="ln581"> </a>
<a name="ln582">			if (simplex</a>
<a name="ln583">				&amp;&amp; fRealJobData-&gt;GetPageSelection()</a>
<a name="ln584">					== JobData::kEvenNumberedPages)</a>
<a name="ln585">				// skip odd numbered page</a>
<a name="ln586">				more = _SkipPages(spoolData);</a>
<a name="ln587"> </a>
<a name="ln588">			if (!more)</a>
<a name="ln589">				// end reached</a>
<a name="ln590">				break;</a>
<a name="ln591">			</a>
<a name="ln592">			PageDataList pages;</a>
<a name="ln593">			more = _CollectPages(spoolData, &amp;pages);</a>
<a name="ln594">			</a>
<a name="ln595">			if (more &amp;&amp; simplex</a>
<a name="ln596">				&amp;&amp; fRealJobData-&gt;GetPageSelection()</a>
<a name="ln597">					== JobData::kOddNumberedPages)</a>
<a name="ln598">				// skip even numbered page</a>
<a name="ln599">				more = _SkipPages(spoolData);</a>
<a name="ln600"> </a>
<a name="ln601">			// print each physical page &quot;copies&quot; of times</a>
<a name="ln602">			for (copy = 0; success &amp;&amp; copy &lt; copies; copy ++) {</a>
<a name="ln603"> </a>
<a name="ln604">				// Update the status / cancel job</a>
<a name="ln605">				if (fStatusWindow-&gt;UpdateStatusBar(page_index, copy))		</a>
<a name="ln606">					return false;	</a>
<a name="ln607"> </a>
<a name="ln608">				success = StartPage(page_index);</a>
<a name="ln609">				if (!success)</a>
<a name="ln610">					break;</a>
<a name="ln611">				</a>
<a name="ln612">				// print the pages on the physical page</a>
<a name="ln613">				fView-&gt;Window()-&gt;Lock();</a>
<a name="ln614">				success = _PrintPage(&amp;pages);</a>
<a name="ln615">				fView-&gt;Window()-&gt;Unlock();</a>
<a name="ln616"> </a>
<a name="ln617">				if (success) {</a>
<a name="ln618">					success = EndPage(page_index);</a>
<a name="ln619">				}</a>
<a name="ln620">			}</a>
<a name="ln621">				</a>
<a name="ln622">			page_index++;</a>
<a name="ln623">		} while (success &amp;&amp; more);</a>
<a name="ln624">	}</a>
<a name="ln625"> </a>
<a name="ln626">#ifndef USE_PREVIEW_FOR_DEBUG</a>
<a name="ln627">	if (success</a>
<a name="ln628">		&amp;&amp; fPrinterCap-&gt;Supports(PrinterCap::kPrintStyle)</a>
<a name="ln629">		&amp;&amp; (fOrgJobData-&gt;GetPrintStyle() != JobData::kSimplex)</a>
<a name="ln630">		&amp;&amp; (((page_index + fOrgJobData-&gt;GetNup() - 1) / fOrgJobData-&gt;GetNup())</a>
<a name="ln631">			% 2)) {</a>
<a name="ln632">		// append an empty page on the back side of the page in duplex or</a>
<a name="ln633">		// booklet mode</a>
<a name="ln634">		success = </a>
<a name="ln635">			StartPage(page_index) &amp;&amp;</a>
<a name="ln636">			_PrintPage(NULL) &amp;&amp;</a>
<a name="ln637">			EndPage(page_index);</a>
<a name="ln638">	}</a>
<a name="ln639">#endif</a>
<a name="ln640"> </a>
<a name="ln641">	return success;</a>
<a name="ln642">}</a>
<a name="ln643"> </a>
<a name="ln644"> </a>
<a name="ln645">const JobData*</a>
<a name="ln646">GraphicsDriver::GetJobData(BFile* spoolFile)</a>
<a name="ln647">{</a>
<a name="ln648">	_SetupData(spoolFile);</a>
<a name="ln649">	return fOrgJobData;</a>
<a name="ln650">}</a>
<a name="ln651"> </a>
<a name="ln652"> </a>
<a name="ln653">bool </a>
<a name="ln654">GraphicsDriver::_PrintJob(BFile* spoolFile)</a>
<a name="ln655">{</a>
<a name="ln656">	bool success = true;</a>
<a name="ln657">	if (!_SetupData(spoolFile)) {</a>
<a name="ln658">		// silently exit if there is nothing to print</a>
<a name="ln659">		return true;</a>
<a name="ln660">	}</a>
<a name="ln661"> </a>
<a name="ln662">	fTransport = new Transport(fPrinterData);</a>
<a name="ln663"> </a>
<a name="ln664">	if (fTransport-&gt;CheckAbort()) {</a>
<a name="ln665">		success = false;</a>
<a name="ln666">	} else if (!fTransport-&gt;IsPrintToFileCanceled()) {</a>
<a name="ln667">		BStopWatch stopWatch(&quot;printJob&quot;, !MEASURE_PRINT_JOB_TIME);</a>
<a name="ln668">		_SetupBitmap();</a>
<a name="ln669">		SpoolData spoolData(spoolFile, fPageCount, fOrgJobData-&gt;GetNup(),</a>
<a name="ln670">			fOrgJobData-&gt;GetReverse());</a>
<a name="ln671">		success = StartDocument();</a>
<a name="ln672">		if (success) {</a>
<a name="ln673">			fStatusWindow = new StatusWindow(</a>
<a name="ln674">				fRealJobData-&gt;GetPageSelection() == JobData::kOddNumberedPages,</a>
<a name="ln675">				fRealJobData-&gt;GetPageSelection() == JobData::kEvenNumberedPages,</a>
<a name="ln676">				fRealJobData-&gt;GetFirstPage(),</a>
<a name="ln677">				fPageCount, </a>
<a name="ln678">				fInternalCopies,fRealJobData-&gt;GetNup());</a>
<a name="ln679">				</a>
<a name="ln680">			while (fInternalCopies--) {</a>
<a name="ln681">				success = _PrintDocument(&amp;spoolData);</a>
<a name="ln682">				if (success == false) {</a>
<a name="ln683">					break;</a>
<a name="ln684">				}</a>
<a name="ln685">			}</a>
<a name="ln686">			EndDocument(success);</a>
<a name="ln687">		</a>
<a name="ln688">			fStatusWindow-&gt;Lock();</a>
<a name="ln689">			fStatusWindow-&gt;Quit();</a>
<a name="ln690">		}</a>
<a name="ln691">		_CleanupBitmap();</a>
<a name="ln692">		_CleanupData();</a>
<a name="ln693">	}</a>
<a name="ln694"> </a>
<a name="ln695">	if (success == false) {</a>
<a name="ln696">		BAlert *alert;</a>
<a name="ln697">		if (fTransport-&gt;CheckAbort())</a>
<a name="ln698">			alert = new BAlert(&quot;&quot;, fTransport-&gt;LastError().c_str(), &quot;OK&quot;);</a>
<a name="ln699">		else</a>
<a name="ln700">			alert = new BAlert(&quot;&quot;, &quot;Printer not responding.&quot;, &quot;OK&quot;);</a>
<a name="ln701">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln702">		alert-&gt;Go();</a>
<a name="ln703">	}</a>
<a name="ln704"> </a>
<a name="ln705">	delete fTransport;</a>
<a name="ln706">	fTransport = NULL;</a>
<a name="ln707"> </a>
<a name="ln708">	return success;</a>
<a name="ln709">}</a>
<a name="ln710"> </a>
<a name="ln711"> </a>
<a name="ln712">BMessage*</a>
<a name="ln713">GraphicsDriver::TakeJob(BFile* spoolFile)</a>
<a name="ln714">{</a>
<a name="ln715">	BMessage *msg;</a>
<a name="ln716">	if (_PrintJob(spoolFile))</a>
<a name="ln717">		msg = new BMessage('okok');</a>
<a name="ln718">	else</a>
<a name="ln719">		msg = new BMessage('baad');</a>
<a name="ln720">	return msg;</a>
<a name="ln721">}</a>
<a name="ln722"> </a>
<a name="ln723"> </a>
<a name="ln724">bool </a>
<a name="ln725">GraphicsDriver::StartDocument()</a>
<a name="ln726">{</a>
<a name="ln727">	return true;</a>
<a name="ln728">}</a>
<a name="ln729"> </a>
<a name="ln730"> </a>
<a name="ln731">bool </a>
<a name="ln732">GraphicsDriver::StartPage(int)</a>
<a name="ln733">{</a>
<a name="ln734">	return true;</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737"> </a>
<a name="ln738">bool </a>
<a name="ln739">GraphicsDriver::NextBand(BBitmap*, BPoint*)</a>
<a name="ln740">{</a>
<a name="ln741">	return true;</a>
<a name="ln742">}</a>
<a name="ln743"> </a>
<a name="ln744"> </a>
<a name="ln745">bool </a>
<a name="ln746">GraphicsDriver::EndPage(int)</a>
<a name="ln747">{</a>
<a name="ln748">	return true;</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751"> </a>
<a name="ln752">bool </a>
<a name="ln753">GraphicsDriver::EndDocument(bool)</a>
<a name="ln754">{</a>
<a name="ln755">	return true;</a>
<a name="ln756">}</a>
<a name="ln757"> </a>
<a name="ln758"> </a>
<a name="ln759">void</a>
<a name="ln760">GraphicsDriver::WriteSpoolData(const void* buffer, size_t size)</a>
<a name="ln761">{</a>
<a name="ln762">	if (fTransport == NULL)</a>
<a name="ln763">		return;</a>
<a name="ln764">	fTransport-&gt;Write(buffer, size);</a>
<a name="ln765">}</a>
<a name="ln766"> </a>
<a name="ln767"> </a>
<a name="ln768">void</a>
<a name="ln769">GraphicsDriver::WriteSpoolString(const char* format, ...)</a>
<a name="ln770">{</a>
<a name="ln771">	if (fTransport == NULL)</a>
<a name="ln772">		return;</a>
<a name="ln773"> </a>
<a name="ln774">	char buffer[256];</a>
<a name="ln775">	va_list	ap;</a>
<a name="ln776">	va_start(ap, format);</a>
<a name="ln777">	vsprintf(buffer, format, ap);</a>
<a name="ln778">	fTransport-&gt;Write(buffer, strlen(buffer));</a>
<a name="ln779">	va_end(ap);</a>
<a name="ln780">}</a>
<a name="ln781"> </a>
<a name="ln782"> </a>
<a name="ln783">void</a>
<a name="ln784">GraphicsDriver::WriteSpoolChar(char c)</a>
<a name="ln785">{</a>
<a name="ln786">	if (fTransport == NULL)</a>
<a name="ln787">		return;</a>
<a name="ln788"> </a>
<a name="ln789">	fTransport-&gt;Write(&amp;c, 1);</a>
<a name="ln790">}</a>
<a name="ln791"> </a>
<a name="ln792"> </a>
<a name="ln793">void</a>
<a name="ln794">GraphicsDriver::ReadSpoolData(void* buffer, size_t size)</a>
<a name="ln795">{</a>
<a name="ln796">	if (fTransport == NULL)</a>
<a name="ln797">		return;</a>
<a name="ln798">	fTransport-&gt;Read(buffer, size);</a>
<a name="ln799">}</a>
<a name="ln800"> </a>
<a name="ln801"> </a>
<a name="ln802">int</a>
<a name="ln803">GraphicsDriver::ReadSpoolChar()</a>
<a name="ln804">{</a>
<a name="ln805">	if (fTransport == NULL)</a>
<a name="ln806">		return -1;</a>
<a name="ln807"> </a>
<a name="ln808">	char c;</a>
<a name="ln809">	fTransport-&gt;Read(&amp;c, 1);</a>
<a name="ln810">	return c;</a>
<a name="ln811">}</a>
<a name="ln812"> </a>
<a name="ln813"> </a>
<a name="ln814">bool</a>
<a name="ln815">GraphicsDriver::_NeedRotateBitmapBand() const</a>
<a name="ln816">{</a>
<a name="ln817">	return JobData::kLandscape == fRealJobData-&gt;GetOrientation()</a>
<a name="ln818">		&amp;&amp; !fPrinterCap-&gt;Supports(PrinterCap::kCanRotatePageInLandscape);</a>
<a name="ln819">}</a>
<a name="ln820"> </a>
<a name="ln821"> </a>
<a name="ln822">void </a>
<a name="ln823">GraphicsDriver::_ConvertRGB32ToRGB24(const void* src, void* dst, int width) {</a>
<a name="ln824">	uint8* d = (uint8*)dst;</a>
<a name="ln825">	const rgb_color* s = static_cast&lt;const rgb_color*&gt;(src);</a>
<a name="ln826">	for (int i = width; i &gt; 0; i --) {</a>
<a name="ln827">		*d ++ = s-&gt;red;</a>
<a name="ln828">		*d ++ = s-&gt;green;</a>
<a name="ln829">		*d ++ = s-&gt;blue;</a>
<a name="ln830">		s++;</a>
<a name="ln831">	}</a>
<a name="ln832">}</a>
<a name="ln833"> </a>
<a name="ln834"> </a>
<a name="ln835">void </a>
<a name="ln836">GraphicsDriver::_ConvertCMAP8ToRGB24(const void* src, void* dst, int width) {</a>
<a name="ln837">	uint8* d = (uint8*)dst;</a>
<a name="ln838">	const uint8* s = static_cast&lt;const uint8*&gt;(src);</a>
<a name="ln839">	const color_map* cmap = system_colors();</a>
<a name="ln840">	for (int i = width; i &gt; 0; i --) {</a>
<a name="ln841">		const rgb_color* rgb = &amp;cmap-&gt;color_list[*s];</a>
<a name="ln842">		*d ++ = rgb-&gt;red;</a>
<a name="ln843">		*d ++ = rgb-&gt;green;</a>
<a name="ln844">		*d ++ = rgb-&gt;blue;</a>
<a name="ln845">		s ++;		</a>
<a name="ln846">	}</a>
<a name="ln847">}</a>
<a name="ln848"> </a>
<a name="ln849"> </a>
<a name="ln850">void </a>
<a name="ln851">GraphicsDriver::ConvertToRGB24(const void* src, void* dst, int width,</a>
<a name="ln852">	color_space cs) {</a>
<a name="ln853">	if (cs == B_RGB32)</a>
<a name="ln854">		_ConvertRGB32ToRGB24(src, dst, width);</a>
<a name="ln855">	else if (cs == B_CMAP8)</a>
<a name="ln856">		_ConvertCMAP8ToRGB24(src, dst, width);</a>
<a name="ln857">	else {</a>
<a name="ln858">		DBGMSG((&quot;color_space %d not supported&quot;, cs));</a>
<a name="ln859">	}</a>
<a name="ln860">}</a>
<a name="ln861"> </a>
<a name="ln862"> </a>
<a name="ln863">uint8 </a>
<a name="ln864">GraphicsDriver::_ConvertToGray(uint8 r, uint8 g, uint8 b) {</a>
<a name="ln865">	if (r == g &amp;&amp; g == b)</a>
<a name="ln866">		return r;</a>
<a name="ln867">	else</a>
<a name="ln868">		return (r * 3 + g * 6 + b) / 10;</a>
<a name="ln869">}</a>
<a name="ln870"> </a>
<a name="ln871"> </a>
<a name="ln872">void </a>
<a name="ln873">GraphicsDriver::_ConvertRGB32ToGray(const void* src, void* dst, int width) {</a>
<a name="ln874">	uint8* d = (uint8*)dst;</a>
<a name="ln875">	const rgb_color* s = static_cast&lt;const rgb_color*&gt;(src);</a>
<a name="ln876">	for (int i = width; i &gt; 0; i--, s++, d++)</a>
<a name="ln877">		*d = _ConvertToGray(s-&gt;red, s-&gt;green, s-&gt;blue);</a>
<a name="ln878">}</a>
<a name="ln879"> </a>
<a name="ln880"> </a>
<a name="ln881">void </a>
<a name="ln882">GraphicsDriver::_ConvertCMAP8ToGray(const void* src, void* dst, int width) {</a>
<a name="ln883">	uint8* d = (uint8*)dst;</a>
<a name="ln884">	const uint8* s = static_cast&lt;const uint8*&gt;(src);</a>
<a name="ln885">	const color_map* cmap = system_colors();</a>
<a name="ln886">	for (int i = width; i &gt; 0; i--, s++, d++) {</a>
<a name="ln887">		const rgb_color* rgb = &amp;cmap-&gt;color_list[*s];</a>
<a name="ln888">		*d = _ConvertToGray(rgb-&gt;red, rgb-&gt;green, rgb-&gt;blue);</a>
<a name="ln889">	}</a>
<a name="ln890">}</a>
<a name="ln891"> </a>
<a name="ln892"> </a>
<a name="ln893">void </a>
<a name="ln894">GraphicsDriver::ConvertToGray(const void* src, void* dst, int width,</a>
<a name="ln895">	color_space cs) {</a>
<a name="ln896">	if (cs == B_RGB32)</a>
<a name="ln897">		_ConvertRGB32ToGray(src, dst, width);</a>
<a name="ln898">	else if (cs == B_CMAP8)</a>
<a name="ln899">		_ConvertCMAP8ToGray(src, dst, width);</a>
<a name="ln900">	else {</a>
<a name="ln901">		DBGMSG((&quot;color_space %d not supported&quot;, cs));</a>
<a name="ln902">	}</a>
<a name="ln903">}</a>
<a name="ln904"> </a>

</code></pre>
<div class="balloon" rel="703"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
