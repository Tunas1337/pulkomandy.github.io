
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ac97.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * AC97 interface</a>
<a name="ln3"> *</a>
<a name="ln4"> * Copyright (c) 2002, Marcus Overhagen &lt;marcus@overhagen.de&gt;</a>
<a name="ln5"> * Copyright (c) 2008-2013, Jérôme Duval</a>
<a name="ln6"> *</a>
<a name="ln7"> * All rights reserved.</a>
<a name="ln8"> * Redistribution and use in source and binary forms, with or without modification,</a>
<a name="ln9"> * are permitted provided that the following conditions are met:</a>
<a name="ln10"> *</a>
<a name="ln11"> * - Redistributions of source code must retain the above copyright notice,</a>
<a name="ln12"> *   this list of conditions and the following disclaimer.</a>
<a name="ln13"> * - Redistributions in binary form must reproduce the above copyright notice,</a>
<a name="ln14"> *   this list of conditions and the following disclaimer in the documentation</a>
<a name="ln15"> *   and/or other materials provided with the distribution.</a>
<a name="ln16"> *</a>
<a name="ln17"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</a>
<a name="ln18"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</a>
<a name="ln19"> * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</a>
<a name="ln20"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR</a>
<a name="ln21"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</a>
<a name="ln22"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</a>
<a name="ln23"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</a>
<a name="ln24"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</a>
<a name="ln25"> * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,</a>
<a name="ln26"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</a>
<a name="ln27"> *</a>
<a name="ln28"> */</a>
<a name="ln29"> </a>
<a name="ln30"> </a>
<a name="ln31">#include &lt;KernelExport.h&gt;</a>
<a name="ln32">#include &lt;OS.h&gt;</a>
<a name="ln33">#include &lt;stdio.h&gt;</a>
<a name="ln34">#include &lt;stdlib.h&gt;</a>
<a name="ln35">#include &lt;string.h&gt;</a>
<a name="ln36">#include &lt;MediaDefs.h&gt;</a>
<a name="ln37">#include &quot;ac97.h&quot;</a>
<a name="ln38"> </a>
<a name="ln39">#define LOG(x)	dprintf x</a>
<a name="ln40"> </a>
<a name="ln41">#define B_UTF8_REGISTERED	&quot;\xC2\xAE&quot;</a>
<a name="ln42"> </a>
<a name="ln43">bool ac97_reg_is_valid(ac97_dev *dev, uint8 reg);</a>
<a name="ln44">void ac97_amp_enable(ac97_dev *dev, bool onoff);</a>
<a name="ln45">void ac97_dump_capabilities(ac97_dev *dev);</a>
<a name="ln46">void ac97_detect_capabilities(ac97_dev *dev);</a>
<a name="ln47">void ac97_detect_rates(ac97_dev *dev);</a>
<a name="ln48">void ac97_update_register_cache(ac97_dev *dev);</a>
<a name="ln49"> </a>
<a name="ln50"> </a>
<a name="ln51">const char * stereo_enhancement_technique[] =</a>
<a name="ln52">{</a>
<a name="ln53">	&quot;No 3D Stereo Enhancement&quot;,</a>
<a name="ln54">	&quot;Analog Devices&quot;,</a>
<a name="ln55">	&quot;Creative Technology&quot;,</a>
<a name="ln56">	&quot;National Semiconductor&quot;,</a>
<a name="ln57">	&quot;Yamaha&quot;,</a>
<a name="ln58">	&quot;BBE Sound&quot;,</a>
<a name="ln59">	&quot;Crystal Semiconductor&quot;,</a>
<a name="ln60">	&quot;Qsound Labs&quot;,</a>
<a name="ln61">	&quot;Spatializer Audio Laboratories&quot;,</a>
<a name="ln62">	&quot;SRS Labs&quot;,</a>
<a name="ln63">	&quot;Platform Tech&quot;,</a>
<a name="ln64">	&quot;AKM Semiconductor&quot;,</a>
<a name="ln65">	&quot;Aureal&quot;,</a>
<a name="ln66">	&quot;Aztech Labs&quot;,</a>
<a name="ln67">	&quot;Binaura&quot;,</a>
<a name="ln68">	&quot;ESS Technology&quot;,</a>
<a name="ln69">	&quot;Harman International&quot;,</a>
<a name="ln70">	&quot;Nvidea&quot;,</a>
<a name="ln71">	&quot;Philips&quot;,</a>
<a name="ln72">	&quot;Texas Instruments&quot;,</a>
<a name="ln73">	&quot;VLSI Technology&quot;,</a>
<a name="ln74">	&quot;TriTech&quot;,</a>
<a name="ln75">	&quot;Realtek&quot;,</a>
<a name="ln76">	&quot;Samsung&quot;,</a>
<a name="ln77">	&quot;Wolfson Microelectronics&quot;,</a>
<a name="ln78">	&quot;Delta Integration&quot;,</a>
<a name="ln79">	&quot;SigmaTel&quot;,</a>
<a name="ln80">	&quot;KS Waves&quot;,</a>
<a name="ln81">	&quot;Rockwell&quot;,</a>
<a name="ln82">	&quot;Unknown (29)&quot;,</a>
<a name="ln83">	&quot;Unknown (30)&quot;,</a>
<a name="ln84">	&quot;Unknown (31)&quot;</a>
<a name="ln85">};</a>
<a name="ln86"> </a>
<a name="ln87"> </a>
<a name="ln88">static void default_init(ac97_dev *dev);</a>
<a name="ln89">static void ad1819_init(ac97_dev *dev);</a>
<a name="ln90">static void ad1881_init(ac97_dev *dev);</a>
<a name="ln91">static void ad1885_init(ac97_dev *dev);</a>
<a name="ln92">static void ad1886_init(ac97_dev *dev);</a>
<a name="ln93">static void ad1980_init(ac97_dev *dev);</a>
<a name="ln94">static void ad1981b_init(ac97_dev *dev);</a>
<a name="ln95">static void alc203_init(ac97_dev *dev);</a>
<a name="ln96">static void alc650_init(ac97_dev *dev);</a>
<a name="ln97">static void alc655_init(ac97_dev *dev);</a>
<a name="ln98">static void alc850_init(ac97_dev *dev);</a>
<a name="ln99">static void stac9708_init(ac97_dev *dev);</a>
<a name="ln100">static void stac9721_init(ac97_dev *dev);</a>
<a name="ln101">static void stac9744_init(ac97_dev *dev);</a>
<a name="ln102">static void stac9756_init(ac97_dev *dev);</a>
<a name="ln103">static void stac9758_init(ac97_dev *dev);</a>
<a name="ln104">static void tr28028_init(ac97_dev *dev);</a>
<a name="ln105">static void wm9701_init(ac97_dev *dev);</a>
<a name="ln106">static void wm9703_init(ac97_dev *dev);</a>
<a name="ln107">static void wm9704_init(ac97_dev *dev);</a>
<a name="ln108"> </a>
<a name="ln109">bool ad1819_set_rate(ac97_dev *dev, uint8 reg, uint32 rate);</a>
<a name="ln110">bool ad1819_get_rate(ac97_dev *dev, uint8 reg, uint32 *rate);</a>
<a name="ln111"> </a>
<a name="ln112"> </a>
<a name="ln113">typedef struct</a>
<a name="ln114">{</a>
<a name="ln115">	uint32 id;</a>
<a name="ln116">	uint32 mask;</a>
<a name="ln117">	codec_init init;</a>
<a name="ln118">	const char *info;</a>
<a name="ln119">} codec_table;</a>
<a name="ln120"> </a>
<a name="ln121"> </a>
<a name="ln122">codec_table codecs[] =</a>
<a name="ln123">{</a>
<a name="ln124">	{ CODEC_ID_AD1819,	0xffffffff, ad1819_init,	&quot;Analog Devices AD1819A, AD1819B SoundPort&quot; B_UTF8_REGISTERED },</a>
<a name="ln125">	{ CODEC_ID_AD1881,	0xffffffff, ad1881_init,	&quot;Analog Devices AD1881 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln126">	{ CODEC_ID_AD1881A,	0xffffffff, ad1881_init,	&quot;Analog Devices AD1881A SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln127">	{ CODEC_ID_AD1885,	0xffffffff, ad1885_init,	&quot;Analog Devices AD1885 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln128">	{ CODEC_ID_AD1886,	0xffffffff, ad1886_init,	&quot;Analog Devices AD1886 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln129">	{ CODEC_ID_AD1886A,	0xffffffff, ad1881_init,	&quot;Analog Devices AD1886A SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln130">	{ CODEC_ID_AD1887,	0xffffffff, ad1881_init,	&quot;Analog Devices AD1887 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln131">	{ CODEC_ID_AD1888,	0xffffffff, ad1881_init,	&quot;Analog Devices AD1888 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln132">	{ CODEC_ID_AD1980,	0xffffffff, ad1980_init,	&quot;Analog Devices AD1980 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln133">	{ 0x41445371,		0xffffffff, default_init,	&quot;Analog Devices 0x41445371 (???)&quot; },</a>
<a name="ln134">	{ 0x41445372,		0xffffffff, default_init,	&quot;Analog Devices AD1981A SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln135">	{ CODEC_ID_AD1981B,	0xffffffff, ad1981b_init,	&quot;Analog Devices AD1981B SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln136">	{ CODEC_ID_AD1985,	0xffffffff, default_init,	&quot;Analog Devices AD1985 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln137">	{ CODEC_ID_AD1986,	0xffffffff, default_init,	&quot;Analog Devices AD1986 SoundMAX&quot; B_UTF8_REGISTERED },</a>
<a name="ln138">	{ CODEC_ID_AK4540,	0xffffffff, default_init,	&quot;Asahi Kasei AK4540&quot; },</a>
<a name="ln139">	{ CODEC_ID_AK4542,	0xffffffff, default_init,	&quot;Asahi Kasei AK4542&quot; },</a>
<a name="ln140">	{ CODEC_ID_AK4543,	0xffffffff, default_init,	&quot;Asahi Kasei AK4543&quot; },</a>
<a name="ln141">	{ 0x414b4d06,		0xffffffff, default_init,	&quot;Asahi Kasei AK4544A&quot; },</a>
<a name="ln142">	{ 0x414b4d07,		0xffffffff, default_init,	&quot;Asahi Kasei AK4545&quot; },</a>
<a name="ln143">	{ 0x414c4300, 		0xffffff00, default_init,	&quot;Avance Logic (Realtek) ALC100&quot; }, /* 0x4300 = ALC100 */</a>
<a name="ln144">	{ 0x414c4320,		0xfffffff0, default_init,	&quot;Avance Logic (Realtek) ALC100/ALC100P, RL5383/RL5522&quot; },</a>
<a name="ln145">	{ CODEC_ID_ALC201A, 0xfffffff0, default_init,	&quot;Avance Logic (Realtek) ALC200/ALC200A, ALC201/ALC201A&quot; }, /* 0x4710 = ALC201A */</a>
<a name="ln146">	{ 0x414c4720,		0xffffffff, alc650_init,	&quot;Avance Logic (Realtek) ALC650&quot; }, /* 0x4720 = ALC650 */</a>
<a name="ln147">	{ 0x414c4730, 		0xffffffff, default_init,	&quot;Avance Logic (Realtek) ALC101&quot; },</a>
<a name="ln148">	{ 0x414c4740,		0xfffffff0, default_init,	&quot;Avance Logic (Realtek) ALC202/ALC202A&quot; },</a>
<a name="ln149">	{ 0x414c4750,		0xfffffff0, default_init,	&quot;Avance Logic (Realtek) ALC250&quot; },</a>
<a name="ln150">	{ 0x414c4760,		0xfffffff0, alc655_init,	&quot;Avance Logic (Realtek) ALC655&quot; }, /* 0x4760 = ALC655 */</a>
<a name="ln151">	{ 0x414c4770,		0xfffffff0, alc203_init,	&quot;Avance Logic (Realtek) ALC203&quot; },</a>
<a name="ln152">	{ 0x414c4780,		0xffffffff, alc655_init,	&quot;Avance Logic (Realtek) ALC658&quot; },</a>
<a name="ln153">	{ 0x414c4790,		0xfffffff0, alc850_init,	&quot;Avance Logic (Realtek) ALC850&quot; },</a>
<a name="ln154">	{ 0x434d4941,		0xffffffff, default_init,	&quot;C-Media CMI9738&quot; },</a>
<a name="ln155">	{ 0x434d4961,		0xffffffff, default_init,	&quot;C-Media CMI9739&quot; },</a>
<a name="ln156">	{ 0x43525900,		0xffffffff, default_init,	&quot;Cirrus Logic CS4297&quot; },</a>
<a name="ln157">	{ 0x43525903,		0xffffffff, default_init,	&quot;Cirrus Logic CS4297&quot; },</a>
<a name="ln158">	{ 0x43525913,		0xffffffff, default_init,	&quot;Cirrus Logic CS4297A&quot; },</a>
<a name="ln159">	{ 0x43525914,		0xffffffff, default_init,	&quot;Cirrus Logic CS4297B&quot; },</a>
<a name="ln160">	{ 0x43525923,		0xffffffff, default_init,	&quot;Cirrus Logic CS4294C&quot; },</a>
<a name="ln161">	{ 0x4352592b,		0xffffffff, default_init,	&quot;Cirrus Logic CS4298C&quot; },</a>
<a name="ln162">	{ CODEC_ID_CS4299A,	0xffffffff, default_init,	&quot;Cirrus Logic CS4299A&quot; },</a>
<a name="ln163">	{ CODEC_ID_CS4299C,	0xffffffff, default_init,	&quot;Cirrus Logic CS4299C&quot; },</a>
<a name="ln164">	{ CODEC_ID_CS4299D,	0xffffffff, default_init,	&quot;Cirrus Logic CS4299D&quot; },</a>
<a name="ln165">	{ 0x43525941,		0xffffffff, default_init,	&quot;Cirrus Logic CS4201A&quot; },</a>
<a name="ln166">	{ 0x43525951,		0xffffffff, default_init,	&quot;Cirrus Logic CS4205A&quot; },</a>
<a name="ln167">	{ 0x43525961,		0xffffffff, default_init,	&quot;Cirrus Logic CS4291A&quot; },</a>
<a name="ln168">	{ 0x43585421,		0xffffffff, default_init,	&quot;HSD11246&quot; },</a>
<a name="ln169">	{ 0x44543031,		0xffffffff, default_init,	&quot;DT0398&quot; },</a>
<a name="ln170">	{ 0x454d4328,		0xffffffff, default_init,	&quot;EM28028&quot; },</a>
<a name="ln171">	{ 0x45838308,		0xffffffff, default_init,	&quot;ESS Technology ES1921&quot; },</a>
<a name="ln172">	{ 0x49434501,		0xffffffff, default_init,	&quot;ICEnsemble ICE1230&quot; },</a>
<a name="ln173">	{ 0x49434511,		0xffffffff, default_init,	&quot;ICEnsemble ICE1232&quot; },</a>
<a name="ln174">	{ 0x49434514,		0xffffffff, default_init,	&quot;ICEnsemble ICE1232A&quot; },</a>
<a name="ln175">	{ 0x49434551,		0xffffffff, default_init,	&quot;Via Technologies VT1616&quot; }, /* rebranded from ICEnsemble */</a>
<a name="ln176">	{ 0x49544520,		0xffffffff, default_init,	&quot;Integrated Technology Express ITE2226E&quot; },</a>
<a name="ln177">	{ 0x49544560,		0xffffffff, default_init,	&quot;Integrated Technology Express ITE2646E&quot; },</a>
<a name="ln178">	{ 0x4e534331,		0xffffffff, default_init,	&quot;National Semiconductor LM4549&quot; },</a>
<a name="ln179">	{ CODEC_ID_STAC9700,0xffffffff, default_init,	&quot;SigmaTel STAC9700/9783/9784&quot; },</a>
<a name="ln180">	{ CODEC_ID_STAC9704,0xffffffff, default_init,	&quot;SigmaTel STAC9701/03, STAC9704/07, STAC9705 (???)&quot; },</a>
<a name="ln181">	{ CODEC_ID_STAC9705,0xffffffff, default_init,	&quot;SigmaTel STAC9704 (???)&quot; },</a>
<a name="ln182">	{ CODEC_ID_STAC9708,0xffffffff, stac9708_init,	&quot;SigmaTel STAC9708/9711&quot; },</a>
<a name="ln183">	{ CODEC_ID_STAC9721,0xffffffff, stac9721_init,	&quot;SigmaTel STAC9721/9723&quot; },</a>
<a name="ln184">	{ CODEC_ID_STAC9744,0xffffffff, stac9744_init,	&quot;SigmaTel STAC9744&quot; },</a>
<a name="ln185">	{ CODEC_ID_STAC9750,0xffffffff, default_init,	&quot;SigmaTel STAC9750/51&quot; },</a>
<a name="ln186">	{ CODEC_ID_STAC9752,0xffffffff, default_init,	&quot;SigmaTel STAC9752/53&quot; },</a>
<a name="ln187">	{ CODEC_ID_STAC9756,0xffffffff, stac9756_init,	&quot;SigmaTel STAC9756/9757&quot; },</a>
<a name="ln188">	{ CODEC_ID_STAC9758,0xffffffff, stac9758_init,	&quot;SigmaTel STAC9758/59&quot; },</a>
<a name="ln189">	{ CODEC_ID_STAC9766,0xffffffff, default_init,	&quot;SigmaTel STAC9766/67&quot; },</a>
<a name="ln190">	{ 0x53494c22,		0xffffffff, default_init,	&quot;Silicon Laboratory Si3036&quot; },</a>
<a name="ln191">	{ 0x53494c23,		0xffffffff, default_init,	&quot;Silicon Laboratory Si3038&quot; },</a>
<a name="ln192">	{ 0x53544d02,		0xffffffff, default_init,	&quot;ST7597&quot; },</a>
<a name="ln193">	{ 0x54524103,		0xffffffff, default_init,	&quot;TriTech TR28023&quot; },</a>
<a name="ln194">	{ 0x54524106,		0xffffffff, default_init,	&quot;TriTech TR28026&quot; },</a>
<a name="ln195">	{ 0x54524108,		0xffffffff, tr28028_init,	&quot;TriTech TR28028&quot; },</a>
<a name="ln196">	{ 0x54524123,		0xffffffff, default_init,	&quot;TriTech TR28602&quot; },</a>
<a name="ln197">	{ 0x56494161,		0xffffffff, default_init,	&quot;Via Technologies VIA1612A&quot; },</a>
<a name="ln198">	{ 0x56494170,		0xffffffff, default_init,	&quot;Via Technologies VIA1617A&quot; },</a>
<a name="ln199">	{ 0x574d4c00,		0xffffffff, wm9701_init,	&quot;Wolfson WM9701A&quot; },</a>
<a name="ln200">	{ 0x574d4c03,		0xffffffff, wm9703_init,	&quot;Wolfson WM9703/9704&quot; },</a>
<a name="ln201">	{ 0x574d4c04,		0xffffffff, wm9704_init,	&quot;Wolfson WM9704 (quad)&quot; },</a>
<a name="ln202">	{ 0x574d4c05,		0xffffffff, wm9703_init,	&quot;Wolfson WM9705/WM9710&quot; },</a>
<a name="ln203">	{ 0x574d4d09,		0xffffffff, default_init,	&quot;Wolfson WM9709&quot; },</a>
<a name="ln204">	{ 0x574d4c12,		0xffffffff, default_init,	&quot;Wolfson WM9711/12&quot; },</a>
<a name="ln205">	{ 0x574d4c13,		0xffffffff, default_init,	&quot;Wolfson WM9713/14&quot; },</a>
<a name="ln206">	{ 0x57454301,		0xffffffff, default_init,	&quot;Wolfson W83971D&quot; },</a>
<a name="ln207">	/* Vendors only: */</a>
<a name="ln208">	{ 0x41445300,		0xffffff00, default_init,	&quot;Analog Devices&quot; },</a>
<a name="ln209">	{ 0x414b4d00,		0xffffff00, default_init,	&quot;Asahi Kasei&quot; },</a>
<a name="ln210">	{ 0x414c4700,		0xffffff00, default_init,	&quot;Avance Logic (Realtek)&quot; },</a>
<a name="ln211">	{ 0x434d4900,		0xffffff00, default_init,	&quot;C-Media&quot; },</a>
<a name="ln212">	{ 0x43525900,		0xffffff00, default_init,	&quot;Cirrus Logic&quot; },</a>
<a name="ln213">	{ 0x45838300,		0xffffff00, default_init,	&quot;ESS Technology&quot; },</a>
<a name="ln214">	{ 0x49434500,		0xffffff00, default_init,	&quot;ICEnsemble&quot; },</a>
<a name="ln215">	{ 0x49544500,		0xffffff00, default_init,	&quot;ITE, Inc.&quot; },</a>
<a name="ln216">	{ 0x4e534300,		0xffffff00, default_init,	&quot;National Semiconductor&quot; },</a>
<a name="ln217">	{ 0x83847600,		0xffffff00, default_init,	&quot;SigmaTel&quot; },</a>
<a name="ln218">	{ 0x53494c00,		0xffffff00, default_init,	&quot;Silicon Laboratory&quot; },</a>
<a name="ln219">	{ 0x54524100,		0xffffff00, default_init,	&quot;TriTech&quot; },</a>
<a name="ln220">	{ 0x54584e00,		0xffffff00, default_init,	&quot;Texas Instruments&quot; },</a>
<a name="ln221">	{ 0x56494100,		0xffffff00, default_init,	&quot;VIA Technologies&quot; },</a>
<a name="ln222">	{ 0x574d4c00,		0xffffff00, default_init,	&quot;Wolfson&quot; },</a>
<a name="ln223">	{ 0x594d4800,		0xffffff00, default_init,	&quot;Yamaha&quot; },</a>
<a name="ln224">	{ 0x00000000,		0x00000000, default_init,	&quot;Unknown&quot; } /* must be last one, matches every codec */</a>
<a name="ln225">};</a>
<a name="ln226"> </a>
<a name="ln227"> </a>
<a name="ln228">static codec_table *</a>
<a name="ln229">find_codec_table(uint32 codecid)</a>
<a name="ln230">{</a>
<a name="ln231">	codec_table *codec;</a>
<a name="ln232">	for (codec = codecs; codec-&gt;id; codec++)</a>
<a name="ln233">		if ((codec-&gt;id &amp; codec-&gt;mask) == (codecid &amp; codec-&gt;mask))</a>
<a name="ln234">			break;</a>
<a name="ln235">	return codec;</a>
<a name="ln236">}</a>
<a name="ln237"> </a>
<a name="ln238"> </a>
<a name="ln239">void</a>
<a name="ln240">ac97_attach(ac97_dev **_dev, codec_reg_read reg_read, codec_reg_write reg_write, void *cookie,</a>
<a name="ln241">	ushort subvendor_id, ushort subsystem_id)</a>
<a name="ln242">{</a>
<a name="ln243">	ac97_dev *dev;</a>
<a name="ln244">	codec_table *codec;</a>
<a name="ln245">	int i;</a>
<a name="ln246"> </a>
<a name="ln247">	*_dev = dev = (ac97_dev *) malloc(sizeof(ac97_dev));</a>
<a name="ln248">	memset(dev-&gt;reg_cache, 0, sizeof(dev-&gt;reg_cache));</a>
<a name="ln249">	dev-&gt;cookie = cookie;</a>
<a name="ln250">	dev-&gt;reg_read = reg_read;</a>
<a name="ln251">	dev-&gt;reg_write = reg_write;</a>
<a name="ln252">	dev-&gt;set_rate = 0;</a>
<a name="ln253">	dev-&gt;get_rate = 0;</a>
<a name="ln254">	dev-&gt;clock = 48000; /* default clock on non-broken motherboards */</a>
<a name="ln255">	dev-&gt;min_vsr = 0x0001;</a>
<a name="ln256">	dev-&gt;max_vsr = 0xffff;</a>
<a name="ln257">	dev-&gt;reversed_eamp_polarity = false;</a>
<a name="ln258">	dev-&gt;capabilities = 0;</a>
<a name="ln259"> </a>
<a name="ln260">	dev-&gt;subsystem = (subvendor_id &lt;&lt; 16) | subsystem_id;</a>
<a name="ln261"> </a>
<a name="ln262">	if (dev-&gt;subsystem == 0x161f202f</a>
<a name="ln263">		|| dev-&gt;subsystem == 0x161f203a</a>
<a name="ln264">		|| dev-&gt;subsystem == 0x161f203e</a>
<a name="ln265">		|| dev-&gt;subsystem == 0x161f204c</a>
<a name="ln266">		|| dev-&gt;subsystem == 0x104d8144</a>
<a name="ln267">		|| dev-&gt;subsystem == 0x104d8197</a>
<a name="ln268">		|| dev-&gt;subsystem == 0x104d81c0</a>
<a name="ln269">		|| dev-&gt;subsystem == 0x104d81c5</a>
<a name="ln270">		|| dev-&gt;subsystem == 0x103c3089</a>
<a name="ln271">		|| dev-&gt;subsystem == 0x103c309a</a>
<a name="ln272">		|| dev-&gt;subsystem == 0x10338213</a>
<a name="ln273">		|| dev-&gt;subsystem == 0x103382be) {</a>
<a name="ln274">		dev-&gt;reversed_eamp_polarity = true;</a>
<a name="ln275">	}</a>
<a name="ln276"> </a>
<a name="ln277">	/* reset the codec */</a>
<a name="ln278">	LOG((&quot;codec reset\n&quot;));</a>
<a name="ln279">	ac97_reg_uncached_write(dev, AC97_RESET, 0x0000);</a>
<a name="ln280">	for (i = 0; i &lt; 500; i++) {</a>
<a name="ln281">		if ((ac97_reg_uncached_read(dev, AC97_POWERDOWN) &amp; 0xf) == 0xf)</a>
<a name="ln282">			break;</a>
<a name="ln283">		snooze(1000);</a>
<a name="ln284">	}</a>
<a name="ln285"> </a>
<a name="ln286">	dev-&gt;codec_id = ((uint32)reg_read(cookie, AC97_VENDOR_ID1) &lt;&lt; 16) | reg_read(cookie, AC97_VENDOR_ID2);</a>
<a name="ln287">	codec = find_codec_table(dev-&gt;codec_id);</a>
<a name="ln288">	dev-&gt;codec_info = codec-&gt;info;</a>
<a name="ln289">	dev-&gt;init = codec-&gt;init;</a>
<a name="ln290"> </a>
<a name="ln291">	dev-&gt;codec_3d_stereo_enhancement = stereo_enhancement_technique[(ac97_reg_cached_read(dev, AC97_RESET) &gt;&gt; 10) &amp; 31];</a>
<a name="ln292"> </a>
<a name="ln293">	/* setup register cache */</a>
<a name="ln294">	ac97_update_register_cache(dev);</a>
<a name="ln295"> </a>
<a name="ln296">	ac97_reg_update_bits(dev, AC97_EXTENDED_STAT_CTRL, 1, 1); // enable variable rate audio</a>
<a name="ln297"> </a>
<a name="ln298">	ac97_detect_capabilities(dev);</a>
<a name="ln299"> </a>
<a name="ln300">	dev-&gt;init(dev);</a>
<a name="ln301">	ac97_amp_enable(dev, true);</a>
<a name="ln302"> </a>
<a name="ln303">	/* set mixer defaults, enabled Line-out sources are PCM-out, CD-in, Line-in */</a>
<a name="ln304">	ac97_reg_update(dev, AC97_CENTER_LFE_VOLUME, 0x0000);	/* set LFE &amp; center volume 0dB */</a>
<a name="ln305">	ac97_reg_update(dev, AC97_SURR_VOLUME, 0x0000);			/* set surround volume 0dB */</a>
<a name="ln306">	ac97_reg_update(dev, AC97_MASTER_VOLUME, 0x0000);		/* set master output 0dB */</a>
<a name="ln307">	ac97_reg_update(dev, AC97_AUX_OUT_VOLUME, 0x0000);		/* set aux output 0dB */</a>
<a name="ln308">	ac97_reg_update(dev, AC97_MONO_VOLUME, 0x0000);			/* set mono output 0dB */</a>
<a name="ln309">	ac97_reg_update(dev, AC97_PCM_OUT_VOLUME, 0x0808);		/* enable pcm-out */</a>
<a name="ln310">	ac97_reg_update(dev, AC97_CD_VOLUME, 0x0808);			/* enable cd-in */</a>
<a name="ln311">	ac97_reg_update(dev, AC97_LINE_IN_VOLUME, 0x0808);		/* enable line-in */</a>
<a name="ln312"> </a>
<a name="ln313">	/* set record line in */</a>
<a name="ln314">	ac97_reg_update(dev, AC97_RECORD_SELECT, 0x0404);</a>
<a name="ln315"> </a>
<a name="ln316">	LOG((&quot;codec vendor id      = %#08lx\n&quot;, dev-&gt;codec_id));</a>
<a name="ln317">	LOG((&quot;codec description     = %s\n&quot;, dev-&gt;codec_info));</a>
<a name="ln318">	LOG((&quot;codec 3d enhancement = %s\n&quot;, dev-&gt;codec_3d_stereo_enhancement));</a>
<a name="ln319"> </a>
<a name="ln320">	ac97_dump_capabilities(dev);</a>
<a name="ln321">}</a>
<a name="ln322"> </a>
<a name="ln323"> </a>
<a name="ln324">void</a>
<a name="ln325">ac97_detach(ac97_dev *dev)</a>
<a name="ln326">{</a>
<a name="ln327">	/* Mute everything */</a>
<a name="ln328">	ac97_reg_update_bits(dev, AC97_CENTER_LFE_VOLUME, 0x8000, 0x8000);</a>
<a name="ln329">	ac97_reg_update_bits(dev, AC97_SURR_VOLUME, 0x8000, 0x8000);</a>
<a name="ln330">	ac97_reg_update_bits(dev, AC97_MASTER_VOLUME, 0x8000, 0x8000);</a>
<a name="ln331">	ac97_reg_update_bits(dev, AC97_AUX_OUT_VOLUME, 0x8000, 0x8000);</a>
<a name="ln332">	ac97_reg_update_bits(dev, AC97_MONO_VOLUME, 0x8000, 0x8000);</a>
<a name="ln333">	ac97_reg_update_bits(dev, AC97_PCM_OUT_VOLUME, 0x8000, 0x8000);</a>
<a name="ln334">	ac97_reg_update_bits(dev, AC97_CD_VOLUME, 0x8000, 0x8000);</a>
<a name="ln335">	ac97_reg_update_bits(dev, AC97_LINE_IN_VOLUME, 0x8000, 0x8000);</a>
<a name="ln336"> </a>
<a name="ln337">	ac97_amp_enable(dev, false);</a>
<a name="ln338"> </a>
<a name="ln339">	free(dev);</a>
<a name="ln340">}</a>
<a name="ln341"> </a>
<a name="ln342"> </a>
<a name="ln343">void</a>
<a name="ln344">ac97_suspend(ac97_dev *dev)</a>
<a name="ln345">{</a>
<a name="ln346">	ac97_amp_enable(dev, false);</a>
<a name="ln347">}</a>
<a name="ln348"> </a>
<a name="ln349"> </a>
<a name="ln350">void</a>
<a name="ln351">ac97_resume(ac97_dev *dev)</a>
<a name="ln352">{</a>
<a name="ln353">	ac97_amp_enable(dev, true);</a>
<a name="ln354">}</a>
<a name="ln355"> </a>
<a name="ln356"> </a>
<a name="ln357">void</a>
<a name="ln358">ac97_reg_cached_write(ac97_dev *dev, uint8 reg, uint16 value)</a>
<a name="ln359">{</a>
<a name="ln360">	if (!ac97_reg_is_valid(dev, reg))</a>
<a name="ln361">		return;</a>
<a name="ln362">	dev-&gt;reg_write(dev-&gt;cookie, reg, value);</a>
<a name="ln363">	dev-&gt;reg_cache[reg] = value;</a>
<a name="ln364">}</a>
<a name="ln365"> </a>
<a name="ln366"> </a>
<a name="ln367">uint16</a>
<a name="ln368">ac97_reg_cached_read(ac97_dev *dev, uint8 reg)</a>
<a name="ln369">{</a>
<a name="ln370">	if (!ac97_reg_is_valid(dev, reg))</a>
<a name="ln371">		return 0;</a>
<a name="ln372">	return dev-&gt;reg_cache[reg];</a>
<a name="ln373">}</a>
<a name="ln374"> </a>
<a name="ln375">void</a>
<a name="ln376">ac97_reg_uncached_write(ac97_dev *dev, uint8 reg, uint16 value)</a>
<a name="ln377">{</a>
<a name="ln378">	if (!ac97_reg_is_valid(dev, reg))</a>
<a name="ln379">		return;</a>
<a name="ln380">	dev-&gt;reg_write(dev-&gt;cookie, reg, value);</a>
<a name="ln381">}</a>
<a name="ln382"> </a>
<a name="ln383"> </a>
<a name="ln384">uint16</a>
<a name="ln385">ac97_reg_uncached_read(ac97_dev *dev, uint8 reg)</a>
<a name="ln386">{</a>
<a name="ln387">	if (!ac97_reg_is_valid(dev, reg))</a>
<a name="ln388">		return 0;</a>
<a name="ln389">	return dev-&gt;reg_read(dev-&gt;cookie, reg);</a>
<a name="ln390">}</a>
<a name="ln391"> </a>
<a name="ln392"> </a>
<a name="ln393">bool</a>
<a name="ln394">ac97_reg_update(ac97_dev *dev, uint8 reg, uint16 value)</a>
<a name="ln395">{</a>
<a name="ln396">	if (!ac97_reg_is_valid(dev, reg))</a>
<a name="ln397">		return false;</a>
<a name="ln398">	if (ac97_reg_cached_read(dev, reg) == value)</a>
<a name="ln399">		return false;</a>
<a name="ln400">	ac97_reg_cached_write(dev, reg, value);</a>
<a name="ln401">	return true;</a>
<a name="ln402">}</a>
<a name="ln403"> </a>
<a name="ln404"> </a>
<a name="ln405">bool</a>
<a name="ln406">ac97_reg_update_bits(ac97_dev *dev, uint8 reg, uint16 mask, uint16 value)</a>
<a name="ln407">{</a>
<a name="ln408">	uint16 old;</a>
<a name="ln409">	if (!ac97_reg_is_valid(dev, reg))</a>
<a name="ln410">		return false;</a>
<a name="ln411">	old = ac97_reg_cached_read(dev, reg);</a>
<a name="ln412">	value &amp;= mask;</a>
<a name="ln413">	value |= (old &amp; ~mask);</a>
<a name="ln414">	if (old == value)</a>
<a name="ln415">		return false;</a>
<a name="ln416">	ac97_reg_cached_write(dev, reg, value);</a>
<a name="ln417">	return true;</a>
<a name="ln418">}</a>
<a name="ln419"> </a>
<a name="ln420"> </a>
<a name="ln421">void</a>
<a name="ln422">ac97_update_register_cache(ac97_dev *dev)</a>
<a name="ln423">{</a>
<a name="ln424">	int reg;</a>
<a name="ln425">	for (reg = 0; reg &lt;= 0x7e; reg += 2)</a>
<a name="ln426">		dev-&gt;reg_cache[reg] = ac97_reg_uncached_read(dev, reg);</a>
<a name="ln427">}</a>
<a name="ln428"> </a>
<a name="ln429"> </a>
<a name="ln430">bool</a>
<a name="ln431">ac97_set_rate(ac97_dev *dev, uint8 reg, uint32 rate)</a>
<a name="ln432">{</a>
<a name="ln433">	uint32 value;</a>
<a name="ln434">	uint32 old;</a>
<a name="ln435"> </a>
<a name="ln436">	if (dev-&gt;set_rate)</a>
<a name="ln437">		return dev-&gt;set_rate(dev, reg, rate);</a>
<a name="ln438"> </a>
<a name="ln439">	value = (uint32)((rate * 48000ULL) / dev-&gt;clock); /* need 64 bit calculation for rates 96000 or higher */</a>
<a name="ln440"> </a>
<a name="ln441">	LOG((&quot;ac97_set_rate: clock = %ld, rate = %ld, value = %ld\n&quot;, dev-&gt;clock, rate, value));</a>
<a name="ln442"> </a>
<a name="ln443">	/* if double rate audio is currently enabled, divide value by 2 */</a>
<a name="ln444">	if (ac97_reg_cached_read(dev, AC97_EXTENDED_STAT_CTRL) &amp; 0x0002)</a>
<a name="ln445">		value /= 2;</a>
<a name="ln446"> </a>
<a name="ln447">	if (value &lt; dev-&gt;min_vsr || value &gt; dev-&gt;max_vsr)</a>
<a name="ln448">		return false;</a>
<a name="ln449"> </a>
<a name="ln450">	old = ac97_reg_cached_read(dev, reg);</a>
<a name="ln451">	ac97_reg_cached_write(dev, reg, value);</a>
<a name="ln452">	if (value != ac97_reg_uncached_read(dev, reg)) {</a>
<a name="ln453">		LOG((&quot;ac97_set_rate failed, new rate %d\n&quot;, ac97_reg_uncached_read(dev, reg)));</a>
<a name="ln454">		ac97_reg_cached_write(dev, reg, old);</a>
<a name="ln455">		return false;</a>
<a name="ln456">	}</a>
<a name="ln457">	LOG((&quot;ac97_set_rate done\n&quot;));</a>
<a name="ln458">	return true;</a>
<a name="ln459">}</a>
<a name="ln460"> </a>
<a name="ln461"> </a>
<a name="ln462">bool</a>
<a name="ln463">ac97_get_rate(ac97_dev *dev, uint8 reg, uint32 *rate)</a>
<a name="ln464">{</a>
<a name="ln465">	uint32 value;</a>
<a name="ln466"> </a>
<a name="ln467">	if (dev-&gt;get_rate)</a>
<a name="ln468">		return dev-&gt;get_rate(dev, reg, rate);</a>
<a name="ln469"> </a>
<a name="ln470">	value = ac97_reg_cached_read(dev, reg);</a>
<a name="ln471">	if (value == 0)</a>
<a name="ln472">		return false;</a>
<a name="ln473"> </a>
<a name="ln474">	/* if double rate audio is currently enabled, multiply value by 2 */</a>
<a name="ln475">	if (ac97_reg_cached_read(dev, AC97_EXTENDED_STAT_CTRL) &amp; 0x0002)</a>
<a name="ln476">		value *= 2;</a>
<a name="ln477"> </a>
<a name="ln478">	*rate = (uint32)((value * (uint64)dev-&gt;clock) / 48000); /* need 64 bit calculation to avoid overflow*/</a>
<a name="ln479">	return true;</a>
<a name="ln480">}</a>
<a name="ln481"> </a>
<a name="ln482"> </a>
<a name="ln483">void</a>
<a name="ln484">ac97_set_clock(ac97_dev *dev, uint32 clock)</a>
<a name="ln485">{</a>
<a name="ln486">	LOG((&quot;ac97_set_clock: clock = %ld\n&quot;, clock));</a>
<a name="ln487">	dev-&gt;clock = clock;</a>
<a name="ln488">	ac97_detect_rates(dev);</a>
<a name="ln489">	ac97_dump_capabilities(dev);</a>
<a name="ln490">}</a>
<a name="ln491"> </a>
<a name="ln492"> </a>
<a name="ln493">void</a>
<a name="ln494">ac97_detect_capabilities(ac97_dev *dev)</a>
<a name="ln495">{</a>
<a name="ln496">	uint16 val;</a>
<a name="ln497"> </a>
<a name="ln498">	val = ac97_reg_cached_read(dev, AC97_RESET);</a>
<a name="ln499">	if (val &amp; 0x0001)</a>
<a name="ln500">		dev-&gt;capabilities |= CAP_PCM_MIC;</a>
<a name="ln501">	if (val &amp; 0x0004)</a>
<a name="ln502">		dev-&gt;capabilities |= CAP_BASS_TREBLE_CTRL;</a>
<a name="ln503">	if (val &amp; 0x0008)</a>
<a name="ln504">		dev-&gt;capabilities |= CAP_SIMULATED_STEREO;</a>
<a name="ln505">	if (val &amp; 0x0010)</a>
<a name="ln506">		dev-&gt;capabilities |= CAP_HEADPHONE_OUT;</a>
<a name="ln507">	if (val &amp; 0x0020)</a>
<a name="ln508">		dev-&gt;capabilities |= CAP_LAUDNESS;</a>
<a name="ln509">	if (val &amp; 0x0040)</a>
<a name="ln510">		dev-&gt;capabilities |= CAP_DAC_18BIT;</a>
<a name="ln511">	if (val &amp; 0x0080)</a>
<a name="ln512">		dev-&gt;capabilities |= CAP_DAC_20BIT;</a>
<a name="ln513">	if (val &amp; 0x0100)</a>
<a name="ln514">		dev-&gt;capabilities |= CAP_ADC_18BIT;</a>
<a name="ln515">	if (val &amp; 0x0200)</a>
<a name="ln516">		dev-&gt;capabilities |= CAP_ADC_20BIT;</a>
<a name="ln517">	if (val &amp; 0x7C00)</a>
<a name="ln518">		dev-&gt;capabilities |= CAP_3D_ENHANCEMENT;</a>
<a name="ln519"> </a>
<a name="ln520">	val = ac97_reg_cached_read(dev, AC97_EXTENDED_ID);</a>
<a name="ln521">	if (val &amp; EXID_VRA)</a>
<a name="ln522">		dev-&gt;capabilities |= CAP_VARIABLE_PCM;</a>
<a name="ln523">	if (val &amp; EXID_DRA)</a>
<a name="ln524">		dev-&gt;capabilities |= CAP_DOUBLE_PCM;</a>
<a name="ln525">	if (val &amp; EXID_SPDIF)</a>
<a name="ln526">		dev-&gt;capabilities |= CAP_SPDIF;</a>
<a name="ln527">	if (val &amp; EXID_VRM)</a>
<a name="ln528">		dev-&gt;capabilities |= CAP_VARIABLE_MIC;</a>
<a name="ln529">	if (val &amp; EXID_CDAC)</a>
<a name="ln530">		dev-&gt;capabilities |= CAP_CENTER_DAC;</a>
<a name="ln531">	if (val &amp; EXID_SDAC)</a>
<a name="ln532">		dev-&gt;capabilities |= CAP_SURR_DAC;</a>
<a name="ln533">	if (val &amp; EXID_LDAC)</a>
<a name="ln534">		dev-&gt;capabilities |= CAP_LFE_DAC;</a>
<a name="ln535">	if (val &amp; EXID_AMAP)</a>
<a name="ln536">		dev-&gt;capabilities |= CAP_AMAP;</a>
<a name="ln537">	if ((val &amp; (EXID_REV0 | EXID_REV1)) == 0)</a>
<a name="ln538">		dev-&gt;capabilities |= CAP_REV21;</a>
<a name="ln539">	if ((val &amp; (EXID_REV0 | EXID_REV1)) == EXID_REV0)</a>
<a name="ln540">		dev-&gt;capabilities |= CAP_REV22;</a>
<a name="ln541">	if ((val &amp; (EXID_REV0 | EXID_REV1)) == EXID_REV1)</a>
<a name="ln542">		dev-&gt;capabilities |= CAP_REV23;</a>
<a name="ln543"> </a>
<a name="ln544">	ac97_detect_rates(dev);</a>
<a name="ln545">}</a>
<a name="ln546"> </a>
<a name="ln547">void</a>
<a name="ln548">ac97_detect_rates(ac97_dev *dev)</a>
<a name="ln549">{</a>
<a name="ln550">	uint32 oldrate;</a>
<a name="ln551"> </a>
<a name="ln552">	dev-&gt;capabilities &amp;= ~CAP_PCM_RATE_MASK;</a>
<a name="ln553"> </a>
<a name="ln554">	if (!ac97_get_rate(dev, AC97_PCM_FRONT_DAC_RATE, &amp;oldrate))</a>
<a name="ln555">		oldrate = 48000;</a>
<a name="ln556"> </a>
<a name="ln557">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 20000))</a>
<a name="ln558">		dev-&gt;capabilities |= CAP_PCM_RATE_CONTINUOUS;</a>
<a name="ln559">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 8000))</a>
<a name="ln560">		dev-&gt;capabilities |= CAP_PCM_RATE_8000;</a>
<a name="ln561">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 11025))</a>
<a name="ln562">		dev-&gt;capabilities |= CAP_PCM_RATE_11025;</a>
<a name="ln563">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 12000))</a>
<a name="ln564">		dev-&gt;capabilities |= CAP_PCM_RATE_12000;</a>
<a name="ln565">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 16000))</a>
<a name="ln566">		dev-&gt;capabilities |= CAP_PCM_RATE_16000;</a>
<a name="ln567">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 22050))</a>
<a name="ln568">		dev-&gt;capabilities |= CAP_PCM_RATE_22050;</a>
<a name="ln569">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 24000))</a>
<a name="ln570">		dev-&gt;capabilities |= CAP_PCM_RATE_24000;</a>
<a name="ln571">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 32000))</a>
<a name="ln572">		dev-&gt;capabilities |= CAP_PCM_RATE_32000;</a>
<a name="ln573">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 44100))</a>
<a name="ln574">		dev-&gt;capabilities |= CAP_PCM_RATE_44100;</a>
<a name="ln575">	if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 48000))</a>
<a name="ln576">		dev-&gt;capabilities |= CAP_PCM_RATE_48000;</a>
<a name="ln577"> </a>
<a name="ln578">	if (dev-&gt;capabilities &amp; CAP_DOUBLE_PCM) {</a>
<a name="ln579">		// enable double rate mode</a>
<a name="ln580">		if (ac97_reg_update_bits(dev, AC97_EXTENDED_STAT_CTRL, 0x0002, 0x0002)) {</a>
<a name="ln581">			if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 88200))</a>
<a name="ln582">				dev-&gt;capabilities |= CAP_PCM_RATE_88200;</a>
<a name="ln583">			if (ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 96000))</a>
<a name="ln584">				dev-&gt;capabilities |= CAP_PCM_RATE_96000;</a>
<a name="ln585">			// disable double rate mode</a>
<a name="ln586">			ac97_reg_update_bits(dev, AC97_EXTENDED_STAT_CTRL, 0x0002, 0x0000);</a>
<a name="ln587">		}</a>
<a name="ln588">	}</a>
<a name="ln589"> </a>
<a name="ln590">	ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, oldrate);</a>
<a name="ln591">}</a>
<a name="ln592"> </a>
<a name="ln593"> </a>
<a name="ln594">void</a>
<a name="ln595">ac97_dump_capabilities(ac97_dev *dev)</a>
<a name="ln596">{</a>
<a name="ln597">	LOG((&quot;AC97 capabilities:\n&quot;));</a>
<a name="ln598">	if (ac97_has_capability(dev, CAP_PCM_MIC))</a>
<a name="ln599">		LOG((&quot;CAP_PCM_MIC\n&quot;));</a>
<a name="ln600">	if (ac97_has_capability(dev, CAP_BASS_TREBLE_CTRL))</a>
<a name="ln601">		LOG((&quot;CAP_BASS_TREBLE_CTRL\n&quot;));</a>
<a name="ln602">	if (ac97_has_capability(dev, CAP_SIMULATED_STEREO))</a>
<a name="ln603">		LOG((&quot;CAP_SIMULATED_STEREO\n&quot;));</a>
<a name="ln604">	if (ac97_has_capability(dev, CAP_HEADPHONE_OUT))</a>
<a name="ln605">		LOG((&quot;CAP_HEADPHONE_OUT\n&quot;));</a>
<a name="ln606">	if (ac97_has_capability(dev, CAP_LAUDNESS))</a>
<a name="ln607">		LOG((&quot;CAP_LAUDNESS\n&quot;));</a>
<a name="ln608">	if (ac97_has_capability(dev, CAP_DAC_18BIT))</a>
<a name="ln609">		LOG((&quot;CAP_DAC_18BIT\n&quot;));</a>
<a name="ln610">	if (ac97_has_capability(dev, CAP_DAC_20BIT))</a>
<a name="ln611">		LOG((&quot;CAP_DAC_20BIT\n&quot;));</a>
<a name="ln612">	if (ac97_has_capability(dev, CAP_ADC_18BIT))</a>
<a name="ln613">		LOG((&quot;CAP_ADC_18BIT\n&quot;));</a>
<a name="ln614">	if (ac97_has_capability(dev, CAP_ADC_20BIT))</a>
<a name="ln615">		LOG((&quot;CAP_ADC_20BIT\n&quot;));</a>
<a name="ln616">	if (ac97_has_capability(dev, CAP_3D_ENHANCEMENT))</a>
<a name="ln617">		LOG((&quot;CAP_3D_ENHANCEMENT\n&quot;));</a>
<a name="ln618">	if (ac97_has_capability(dev, CAP_VARIABLE_PCM))</a>
<a name="ln619">		LOG((&quot;CAP_VARIABLE_PCM\n&quot;));</a>
<a name="ln620">	if (ac97_has_capability(dev, CAP_DOUBLE_PCM))</a>
<a name="ln621">		LOG((&quot;CAP_DOUBLE_PCM\n&quot;));</a>
<a name="ln622">	if (ac97_has_capability(dev, CAP_VARIABLE_MIC))</a>
<a name="ln623">		LOG((&quot;CAP_VARIABLE_MIC\n&quot;));</a>
<a name="ln624">	if (ac97_has_capability(dev, CAP_CENTER_DAC))</a>
<a name="ln625">		LOG((&quot;CAP_CENTER_DAC\n&quot;));</a>
<a name="ln626">	if (ac97_has_capability(dev, CAP_SURR_DAC))</a>
<a name="ln627">		LOG((&quot;CAP_SURR_DAC\n&quot;));</a>
<a name="ln628">	if (ac97_has_capability(dev, CAP_LFE_DAC))</a>
<a name="ln629">		LOG((&quot;CAP_LFE_DAC\n&quot;));</a>
<a name="ln630">	if (ac97_has_capability(dev, CAP_AMAP))</a>
<a name="ln631">		LOG((&quot;CAP_AMAP\n&quot;));</a>
<a name="ln632">	if (ac97_has_capability(dev, CAP_REV21))</a>
<a name="ln633">		LOG((&quot;CAP_REV21\n&quot;));</a>
<a name="ln634">	if (ac97_has_capability(dev, CAP_REV22))</a>
<a name="ln635">		LOG((&quot;CAP_REV22\n&quot;));</a>
<a name="ln636">	if (ac97_has_capability(dev, CAP_REV23))</a>
<a name="ln637">		LOG((&quot;CAP_REV23\n&quot;));</a>
<a name="ln638">	if (ac97_has_capability(dev, CAP_PCM_RATE_CONTINUOUS))</a>
<a name="ln639">		LOG((&quot;CAP_PCM_RATE_CONTINUOUS\n&quot;));</a>
<a name="ln640">	if (ac97_has_capability(dev, CAP_PCM_RATE_8000))</a>
<a name="ln641">		LOG((&quot;CAP_PCM_RATE_8000\n&quot;));</a>
<a name="ln642">	if (ac97_has_capability(dev, CAP_PCM_RATE_11025))</a>
<a name="ln643">		LOG((&quot;CAP_PCM_RATE_11025\n&quot;));</a>
<a name="ln644">	if (ac97_has_capability(dev, CAP_PCM_RATE_12000))</a>
<a name="ln645">		LOG((&quot;CAP_PCM_RATE_12000\n&quot;));</a>
<a name="ln646">	if (ac97_has_capability(dev, CAP_PCM_RATE_16000))</a>
<a name="ln647">		LOG((&quot;CAP_PCM_RATE_16000\n&quot;));</a>
<a name="ln648">	if (ac97_has_capability(dev, CAP_PCM_RATE_22050))</a>
<a name="ln649">		LOG((&quot;CAP_PCM_RATE_22050\n&quot;));</a>
<a name="ln650">	if (ac97_has_capability(dev, CAP_PCM_RATE_24000))</a>
<a name="ln651">		LOG((&quot;CAP_PCM_RATE_24000\n&quot;));</a>
<a name="ln652">	if (ac97_has_capability(dev, CAP_PCM_RATE_32000))</a>
<a name="ln653">		LOG((&quot;CAP_PCM_RATE_32000\n&quot;));</a>
<a name="ln654">	if (ac97_has_capability(dev, CAP_PCM_RATE_44100))</a>
<a name="ln655">		LOG((&quot;CAP_PCM_RATE_44100\n&quot;));</a>
<a name="ln656">	if (ac97_has_capability(dev, CAP_PCM_RATE_48000))</a>
<a name="ln657">		LOG((&quot;CAP_PCM_RATE_48000\n&quot;));</a>
<a name="ln658">	if (ac97_has_capability(dev, CAP_PCM_RATE_88200))</a>
<a name="ln659">		LOG((&quot;CAP_PCM_RATE_88200\n&quot;));</a>
<a name="ln660">	if (ac97_has_capability(dev, CAP_PCM_RATE_96000))</a>
<a name="ln661">		LOG((&quot;CAP_PCM_RATE_96000\n&quot;));</a>
<a name="ln662">}</a>
<a name="ln663"> </a>
<a name="ln664"> </a>
<a name="ln665">bool</a>
<a name="ln666">ac97_has_capability(ac97_dev *dev, uint64 cap)</a>
<a name="ln667">{</a>
<a name="ln668">	// return (dev-&gt;capabilities &amp; cap); // does not work because of 64 bit to integer trucation</a>
<a name="ln669">	return (dev-&gt;capabilities &amp; cap) != 0;</a>
<a name="ln670">}</a>
<a name="ln671"> </a>
<a name="ln672">/*************************************************</a>
<a name="ln673"> * Codec specific initialization, etc.</a>
<a name="ln674"> */</a>
<a name="ln675"> </a>
<a name="ln676">bool</a>
<a name="ln677">ac97_reg_is_valid(ac97_dev *dev, uint8 reg)</a>
<a name="ln678">{</a>
<a name="ln679">	if (reg &amp; 1)</a>
<a name="ln680">		return false;</a>
<a name="ln681">	if (reg &gt; 0x7e)</a>
<a name="ln682">		return false;</a>
<a name="ln683"> </a>
<a name="ln684">	switch (dev-&gt;codec_id) {</a>
<a name="ln685">		case CODEC_ID_AK4540:</a>
<a name="ln686">		case CODEC_ID_AK4542:</a>
<a name="ln687">			if (reg &lt; 0x1e || reg == 0x20 || reg == 0x26 || reg &gt; 0x7a)</a>
<a name="ln688">				return true;</a>
<a name="ln689">			return false;</a>
<a name="ln690"> </a>
<a name="ln691">		case CODEC_ID_AD1819:</a>
<a name="ln692">		case CODEC_ID_AD1881:</a>
<a name="ln693">		case CODEC_ID_AD1881A:</a>
<a name="ln694">			if (reg &lt; 0x3a || reg &gt; 0x6e)</a>
<a name="ln695">				return true;</a>
<a name="ln696">			return false;</a>
<a name="ln697"> </a>
<a name="ln698">		case CODEC_ID_AD1885:</a>
<a name="ln699">		case CODEC_ID_AD1886:</a>
<a name="ln700">		case CODEC_ID_AD1886A:</a>
<a name="ln701">		case CODEC_ID_AD1887:</a>
<a name="ln702">			if (reg &lt; 0x3c || reg == 0x5a || reg &gt; 0x6e)</a>
<a name="ln703">				return true;</a>
<a name="ln704">			return false;</a>
<a name="ln705"> </a>
<a name="ln706">		case CODEC_ID_STAC9700:</a>
<a name="ln707">		case CODEC_ID_STAC9704:</a>
<a name="ln708">		case CODEC_ID_STAC9705:</a>
<a name="ln709">		case CODEC_ID_STAC9708:</a>
<a name="ln710">		case CODEC_ID_STAC9721:</a>
<a name="ln711">		case CODEC_ID_STAC9744:</a>
<a name="ln712">		case CODEC_ID_STAC9756:</a>
<a name="ln713">			if (reg &lt; 0x3c || reg &gt; 0x58)</a>
<a name="ln714">				return true;</a>
<a name="ln715">			return false;</a>
<a name="ln716"> </a>
<a name="ln717">		default:</a>
<a name="ln718">			return true;</a>
<a name="ln719">	}</a>
<a name="ln720">}</a>
<a name="ln721"> </a>
<a name="ln722"> </a>
<a name="ln723">void</a>
<a name="ln724">ac97_amp_enable(ac97_dev *dev, bool yesno)</a>
<a name="ln725">{</a>
<a name="ln726">	switch (dev-&gt;codec_id) {</a>
<a name="ln727">		case CODEC_ID_CS4299A:</a>
<a name="ln728">		case CODEC_ID_CS4299C:</a>
<a name="ln729">		case CODEC_ID_CS4299D:</a>
<a name="ln730">			LOG((&quot;cs4299_amp_enable\n&quot;));</a>
<a name="ln731">			if (yesno)</a>
<a name="ln732">				ac97_reg_cached_write(dev, 0x68, 0x8004);</a>
<a name="ln733">			else</a>
<a name="ln734">				ac97_reg_cached_write(dev, 0x68, 0);</a>
<a name="ln735">			break;</a>
<a name="ln736"> </a>
<a name="ln737">		default:</a>
<a name="ln738">			LOG((&quot;ac97_amp_enable, reverse eamp = %d\n&quot;, dev-&gt;reversed_eamp_polarity));</a>
<a name="ln739">			LOG((&quot;powerdown register was = %#04x\n&quot;, ac97_reg_uncached_read(dev, AC97_POWERDOWN)));</a>
<a name="ln740">			if (dev-&gt;reversed_eamp_polarity)</a>
<a name="ln741">				yesno = !yesno;</a>
<a name="ln742">			if (yesno)</a>
<a name="ln743">				ac97_reg_cached_write(dev, AC97_POWERDOWN, ac97_reg_uncached_read(dev, AC97_POWERDOWN) &amp; ~0x8000); /* switch on (low active) */</a>
<a name="ln744">			else</a>
<a name="ln745">				ac97_reg_cached_write(dev, AC97_POWERDOWN, ac97_reg_uncached_read(dev, AC97_POWERDOWN) | 0x8000); /* switch off */</a>
<a name="ln746">			LOG((&quot;powerdown register is = %#04x\n&quot;, ac97_reg_uncached_read(dev, AC97_POWERDOWN)));</a>
<a name="ln747">		break;</a>
<a name="ln748">	}</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751"> </a>
<a name="ln752">bool</a>
<a name="ln753">ad1819_set_rate(ac97_dev *dev, uint8 reg, uint32 rate)</a>
<a name="ln754">{</a>
<a name="ln755">	uint32 value;</a>
<a name="ln756"> </a>
<a name="ln757">	value = (uint32)((rate * 48000ULL) / dev-&gt;clock); /* need 64 bit calculation for rates 96000 or higher */</a>
<a name="ln758"> </a>
<a name="ln759">	LOG((&quot;ad1819_set_rate: clock = %ld, rate = %ld, value = %ld\n&quot;, dev-&gt;clock, rate, value));</a>
<a name="ln760"> </a>
<a name="ln761">	if (value &lt; 0x1B58 || value &gt; 0xBB80)</a>
<a name="ln762">		return false;</a>
<a name="ln763"> </a>
<a name="ln764">	switch (reg) {</a>
<a name="ln765">		case AC97_PCM_FRONT_DAC_RATE:</a>
<a name="ln766">			ac97_reg_cached_write(dev, AC97_AD_SAMPLE_RATE_0, value);</a>
<a name="ln767">			return true;</a>
<a name="ln768"> </a>
<a name="ln769">		case AC97_PCM_L_R_ADC_RATE:</a>
<a name="ln770">			ac97_reg_cached_write(dev, AC97_AD_SAMPLE_RATE_1, value);</a>
<a name="ln771">			return true;</a>
<a name="ln772"> </a>
<a name="ln773">		default:</a>
<a name="ln774">			return false;</a>
<a name="ln775">	}</a>
<a name="ln776">}</a>
<a name="ln777"> </a>
<a name="ln778"> </a>
<a name="ln779">bool</a>
<a name="ln780">ad1819_get_rate(ac97_dev *dev, uint8 reg, uint32 *rate)</a>
<a name="ln781">{</a>
<a name="ln782">	uint32 value;</a>
<a name="ln783"> </a>
<a name="ln784">	switch (reg) {</a>
<a name="ln785">		case AC97_PCM_FRONT_DAC_RATE:</a>
<a name="ln786">			value = ac97_reg_cached_read(dev, AC97_AD_SAMPLE_RATE_0);</a>
<a name="ln787">			break;</a>
<a name="ln788"> </a>
<a name="ln789">		case AC97_PCM_L_R_ADC_RATE:</a>
<a name="ln790">			value = ac97_reg_cached_read(dev, AC97_AD_SAMPLE_RATE_1);</a>
<a name="ln791">			break;</a>
<a name="ln792"> </a>
<a name="ln793">		default:</a>
<a name="ln794">			return false;</a>
<a name="ln795">	}</a>
<a name="ln796"> </a>
<a name="ln797">	*rate = (uint32)((value * (uint64)dev-&gt;clock) / 48000); /* need 64 bit calculation to avoid overflow*/</a>
<a name="ln798">	return true;</a>
<a name="ln799">}</a>
<a name="ln800"> </a>
<a name="ln801"> </a>
<a name="ln802">void</a>
<a name="ln803">default_init(ac97_dev *dev)</a>
<a name="ln804">{</a>
<a name="ln805">	LOG((&quot;default_init\n&quot;));</a>
<a name="ln806">}</a>
<a name="ln807"> </a>
<a name="ln808"> </a>
<a name="ln809">void</a>
<a name="ln810">ad1819_init(ac97_dev *dev)</a>
<a name="ln811">{</a>
<a name="ln812">	LOG((&quot;ad1819_init\n&quot;));</a>
<a name="ln813"> </a>
<a name="ln814">	/* Default config for system with single AD1819 codec */</a>
<a name="ln815">	ac97_reg_cached_write(dev, AC97_AD_SERIAL_CONFIG, 0x7000);</a>
<a name="ln816">	ac97_update_register_cache(dev);</a>
<a name="ln817"> </a>
<a name="ln818">	/* The AD1819 chip has proprietary  sample rate controls</a>
<a name="ln819">	 * Setup sample rate 0 generator for DAC,</a>
<a name="ln820">	 * Setup sample rate 1 generator for ADC,</a>
<a name="ln821">	 * ARSR=1, DRSR=0, ALSR=1, DLSR=0</a>
<a name="ln822">	 */</a>
<a name="ln823">	ac97_reg_cached_write(dev, AC97_AD_MISC_CONTROL, 0x0101);</a>
<a name="ln824">	/* connect special rate set/get functions */</a>
<a name="ln825">	dev-&gt;set_rate = ad1819_set_rate;</a>
<a name="ln826">	dev-&gt;get_rate = ad1819_get_rate;</a>
<a name="ln827">	ac97_detect_rates(dev);</a>
<a name="ln828">	ac97_set_rate(dev, AC97_PCM_FRONT_DAC_RATE, 48000);</a>
<a name="ln829">	ac97_set_rate(dev, AC97_PCM_L_R_ADC_RATE, 48000);</a>
<a name="ln830">}</a>
<a name="ln831"> </a>
<a name="ln832"> </a>
<a name="ln833">void</a>
<a name="ln834">ad1881_init(ac97_dev *dev)</a>
<a name="ln835">{</a>
<a name="ln836">	LOG((&quot;ad1881_init\n&quot;));</a>
<a name="ln837"> </a>
<a name="ln838">	/* Default config for system with single AD1819 codec,</a>
<a name="ln839">	 * BROKEN on systems with master &amp; slave codecs */</a>
<a name="ln840">	ac97_reg_cached_write(dev, AC97_AD_SERIAL_CONFIG, 0x7000);</a>
<a name="ln841">	ac97_update_register_cache(dev);</a>
<a name="ln842"> </a>
<a name="ln843">	/* Setup DAC and ADC rate generator assignments compatible with AC97 */</a>
<a name="ln844">	ac97_reg_cached_write(dev, AC97_AD_MISC_CONTROL, 0x0404);</a>
<a name="ln845"> </a>
<a name="ln846">	/* Setup variable frame rate limits */</a>
<a name="ln847">	dev-&gt;min_vsr = 0x1B58;	/*  7kHz */</a>
<a name="ln848">	dev-&gt;max_vsr = 0xBB80;	/* 48kHz */</a>
<a name="ln849">}</a>
<a name="ln850"> </a>
<a name="ln851"> </a>
<a name="ln852">void</a>
<a name="ln853">ad1885_init(ac97_dev *dev)</a>
<a name="ln854">{</a>
<a name="ln855">	LOG((&quot;ad1885_init\n&quot;));</a>
<a name="ln856">	ad1881_init(dev);</a>
<a name="ln857"> </a>
<a name="ln858">	/* disable jack sense 0 and 1 (JS0, JS1) to turn off automatic mute */</a>
<a name="ln859">	ac97_reg_cached_write(dev, AC97_AD_JACK_SENSE, ac97_reg_cached_read(dev, AC97_AD_JACK_SENSE) | 0x0300);</a>
<a name="ln860">}</a>
<a name="ln861"> </a>
<a name="ln862"> </a>
<a name="ln863">void</a>
<a name="ln864">ad1886_init(ac97_dev *dev)</a>
<a name="ln865">{</a>
<a name="ln866">	LOG((&quot;ad1886_init\n&quot;));</a>
<a name="ln867">	ad1881_init(dev);</a>
<a name="ln868"> </a>
<a name="ln869">	/* change jack sense to always activate outputs*/</a>
<a name="ln870">	ac97_reg_cached_write(dev, AC97_AD_JACK_SENSE, 0x0010);</a>
<a name="ln871">	/* change SPDIF to a valid value */</a>
<a name="ln872">	ac97_reg_cached_write(dev, AC97_SPDIF_CONTROL, 0x2a20);</a>
<a name="ln873">}</a>
<a name="ln874"> </a>
<a name="ln875"> </a>
<a name="ln876">void</a>
<a name="ln877">ad1980_init(ac97_dev *dev)</a>
<a name="ln878">{</a>
<a name="ln879">	LOG((&quot;ad1980_init\n&quot;));</a>
<a name="ln880"> </a>
<a name="ln881">	/* Select only master codec,</a>
<a name="ln882">	 * SPDIF and DAC are linked</a>
<a name="ln883">	 */</a>
<a name="ln884">	ac97_reg_cached_write(dev, AC97_AD_SERIAL_CONFIG, 0x1001);</a>
<a name="ln885">	ac97_update_register_cache(dev);</a>
<a name="ln886"> </a>
<a name="ln887">	/* Select Line-out driven with mixer data (not surround data)</a>
<a name="ln888">	 * Select Headphone-out driven with mixer data (not surround data),</a>
<a name="ln889">	 * LOSEL = 0, HPSEL = 1</a>
<a name="ln890">	 * XXX this one needs to be changed to support surround	out</a>
<a name="ln891">	 */</a>
<a name="ln892">	ac97_reg_cached_write(dev, AC97_AD_MISC_CONTROL, 0x0400);</a>
<a name="ln893">}</a>
<a name="ln894"> </a>
<a name="ln895"> </a>
<a name="ln896">void</a>
<a name="ln897">ad1981b_init(ac97_dev *dev)</a>
<a name="ln898">{</a>
<a name="ln899">	LOG((&quot;ad1981b_init\n&quot;));</a>
<a name="ln900">	if (dev-&gt;subsystem == 0x0e11005a</a>
<a name="ln901">		|| dev-&gt;subsystem == 0x103c006d</a>
<a name="ln902">		|| dev-&gt;subsystem == 0x103c088c</a>
<a name="ln903">		|| dev-&gt;subsystem == 0x103c0890</a>
<a name="ln904">		|| dev-&gt;subsystem == 0x103c0934</a>
<a name="ln905">		|| dev-&gt;subsystem == 0x103c0938</a>
<a name="ln906">		|| dev-&gt;subsystem == 0x103c0944</a>
<a name="ln907">		|| dev-&gt;subsystem == 0x103c099c</a>
<a name="ln908">		|| dev-&gt;subsystem == 0x101402d9) {</a>
<a name="ln909">		ac97_reg_cached_write(dev, AC97_AD_JACK_SENSE,</a>
<a name="ln910">				ac97_reg_cached_read(dev, AC97_AD_JACK_SENSE) | 0x0800);</a>
<a name="ln911">	}</a>
<a name="ln912">}</a>
<a name="ln913"> </a>
<a name="ln914"> </a>
<a name="ln915">void</a>
<a name="ln916">alc203_init(ac97_dev *dev)</a>
<a name="ln917">{</a>
<a name="ln918">	LOG((&quot;alc203_init\n&quot;));</a>
<a name="ln919"> </a>
<a name="ln920">	ac97_reg_update_bits(dev, AC97_ALC650_CLOCK_SOURCE, 0x400, 0x400);</a>
<a name="ln921">}</a>
<a name="ln922"> </a>
<a name="ln923"> </a>
<a name="ln924">void</a>
<a name="ln925">alc650_init(ac97_dev *dev)</a>
<a name="ln926">{</a>
<a name="ln927">	LOG((&quot;alc650_init\n&quot;));</a>
<a name="ln928"> </a>
<a name="ln929">	/* Enable Surround, LFE and Center downmix into Line-out,</a>
<a name="ln930">	 * Set Surround-out as duplicated Line-out.</a>
<a name="ln931">	 */</a>
<a name="ln932">	ac97_reg_cached_write(dev, AC97_ALC650_MULTI_CHAN_CTRL, 0x0007);</a>
<a name="ln933"> </a>
<a name="ln934">	/* Set Surround DAC Volume to 0dB</a>
<a name="ln935">	 * Set Center/LFE DAC Volume to 0dB</a>
<a name="ln936">	 * (but both should already be set, as these are hardware reset defaults)</a>
<a name="ln937">	 */</a>
<a name="ln938">	ac97_reg_cached_write(dev, AC97_ALC650_SURR_VOLUME, 0x0808);</a>
<a name="ln939">	ac97_reg_cached_write(dev, AC97_ALC650_CEN_LFE_VOLUME, 0x0808);</a>
<a name="ln940">}</a>
<a name="ln941"> </a>
<a name="ln942"> </a>
<a name="ln943">void</a>
<a name="ln944">alc655_init(ac97_dev *dev)</a>
<a name="ln945">{</a>
<a name="ln946">	uint16 val;</a>
<a name="ln947">	LOG((&quot;alc655_init\n&quot;));</a>
<a name="ln948"> </a>
<a name="ln949">	ac97_reg_update_bits(dev, AC97_PAGING, 0xf, 0);</a>
<a name="ln950"> </a>
<a name="ln951">	val = ac97_reg_cached_read(dev, AC97_ALC650_CLOCK_SOURCE);</a>
<a name="ln952">	// TODO update bits for specific devices</a>
<a name="ln953">	val &amp;= ~0x1000;</a>
<a name="ln954">	ac97_reg_cached_write(dev, AC97_ALC650_CLOCK_SOURCE, val);</a>
<a name="ln955"> </a>
<a name="ln956">	ac97_reg_cached_write(dev, AC97_ALC650_MULTI_CHAN_CTRL, 0x8000);</a>
<a name="ln957">	ac97_reg_cached_write(dev, AC97_ALC650_SURR_VOLUME, 0x808);</a>
<a name="ln958">	ac97_reg_cached_write(dev, AC97_ALC650_CEN_LFE_VOLUME, 0x808);</a>
<a name="ln959"> </a>
<a name="ln960">	if (dev-&gt;codec_id == 0x414c4781)</a>
<a name="ln961">		ac97_reg_update_bits(dev, AC97_ALC650_MISC_CONTROL, 0x800, 0x800);</a>
<a name="ln962">}</a>
<a name="ln963"> </a>
<a name="ln964"> </a>
<a name="ln965">void</a>
<a name="ln966">alc850_init(ac97_dev *dev)</a>
<a name="ln967">{</a>
<a name="ln968">	LOG((&quot;alc850_init\n&quot;));</a>
<a name="ln969"> </a>
<a name="ln970">	ac97_reg_update_bits(dev, AC97_PAGING, 0xf, 0);</a>
<a name="ln971"> </a>
<a name="ln972">	ac97_reg_cached_write(dev, AC97_ALC650_MULTI_CHAN_CTRL, 0x8000);</a>
<a name="ln973">	ac97_reg_cached_write(dev, AC97_ALC650_CLOCK_SOURCE, 0x20d2);</a>
<a name="ln974">	ac97_reg_cached_write(dev, AC97_ALC650_GPIO_SETUP, 0x8a90);</a>
<a name="ln975">	ac97_reg_cached_write(dev, AC97_ALC650_SURR_VOLUME, 0x808);</a>
<a name="ln976">	ac97_reg_cached_write(dev, AC97_ALC650_CEN_LFE_VOLUME, 0x808);</a>
<a name="ln977">}</a>
<a name="ln978"> </a>
<a name="ln979"> </a>
<a name="ln980">void</a>
<a name="ln981">stac9708_init(ac97_dev *dev)</a>
<a name="ln982">{</a>
<a name="ln983">	LOG((&quot;stac9708_init\n&quot;));</a>
<a name="ln984">	/* ALSA initializes some registers that according to the</a>
<a name="ln985">	 * documentation for this codec do not exist. If the</a>
<a name="ln986">	 * following doesn't work, we may need to do that, too.</a>
<a name="ln987">	 */</a>
<a name="ln988">	/* The Analog Special reg is at 0x6C, other codecs have it at 0x6E */</a>
<a name="ln989">	/* Set Analog Special to default (DAC/ADC -6dB disabled) */</a>
<a name="ln990">	ac97_reg_cached_write(dev, 0x6C, 0x0000);</a>
<a name="ln991">	/* Set Multi Channel to default */</a>
<a name="ln992">	ac97_reg_cached_write(dev, 0x74, 0x0000);</a>
<a name="ln993">}</a>
<a name="ln994"> </a>
<a name="ln995"> </a>
<a name="ln996">void</a>
<a name="ln997">stac9721_init(ac97_dev *dev)</a>
<a name="ln998">{</a>
<a name="ln999">	LOG((&quot;stac9721_init\n&quot;));</a>
<a name="ln1000">	/* Set Analog Special to default (DAC/ADC -6dB disabled) */</a>
<a name="ln1001">	ac97_reg_cached_write(dev, 0x6E, 0x0000);</a>
<a name="ln1002">	/* Enable register 0x72 */</a>
<a name="ln1003">	ac97_reg_cached_write(dev, 0x70, 0xabba);</a>
<a name="ln1004">	/* Set Analog Current to -50% */</a>
<a name="ln1005">	ac97_reg_cached_write(dev, 0x72, 0x0002);</a>
<a name="ln1006">	/* Set Multi Channel to default */</a>
<a name="ln1007">	ac97_reg_cached_write(dev, 0x74, 0x0000);</a>
<a name="ln1008">	/* Enable register 0x78 */</a>
<a name="ln1009">	ac97_reg_cached_write(dev, 0x76, 0xabba);</a>
<a name="ln1010">	/* Set Clock Access to default */</a>
<a name="ln1011">	ac97_reg_cached_write(dev, 0x78, 0x0000);</a>
<a name="ln1012">}</a>
<a name="ln1013"> </a>
<a name="ln1014"> </a>
<a name="ln1015">void</a>
<a name="ln1016">stac9744_init(ac97_dev *dev)</a>
<a name="ln1017">{</a>
<a name="ln1018">	LOG((&quot;stac9744_init\n&quot;));</a>
<a name="ln1019">	/* Set Analog Special to default (DAC/ADC -6dB disabled) */</a>
<a name="ln1020">	ac97_reg_cached_write(dev, 0x6E, 0x0000);</a>
<a name="ln1021">	/* Enable register 0x72 */</a>
<a name="ln1022">	ac97_reg_cached_write(dev, 0x70, 0xabba);</a>
<a name="ln1023">	/* Set Analog Current to -50% */</a>
<a name="ln1024">	ac97_reg_cached_write(dev, 0x72, 0x0002);</a>
<a name="ln1025">	/* Set Multi Channel to default */</a>
<a name="ln1026">	ac97_reg_cached_write(dev, 0x74, 0x0000);</a>
<a name="ln1027">	/* Enable register 0x78 */</a>
<a name="ln1028">	ac97_reg_cached_write(dev, 0x76, 0xabba);</a>
<a name="ln1029">	/* Set Clock Access to default */</a>
<a name="ln1030">	ac97_reg_cached_write(dev, 0x78, 0x0000);</a>
<a name="ln1031">}</a>
<a name="ln1032"> </a>
<a name="ln1033"> </a>
<a name="ln1034">void</a>
<a name="ln1035">stac9756_init(ac97_dev *dev)</a>
<a name="ln1036">{</a>
<a name="ln1037">	LOG((&quot;stac9756_init\n&quot;));</a>
<a name="ln1038">	/* Set Analog Special to default (AC97 all-mix, DAC/ADC -6dB disabled) */</a>
<a name="ln1039">	ac97_reg_cached_write(dev, 0x6E, 0x1000);</a>
<a name="ln1040">	/* Enable register 0x72 */</a>
<a name="ln1041">	ac97_reg_cached_write(dev, 0x70, 0xabba);</a>
<a name="ln1042">	/* Set Analog Current to -50% */</a>
<a name="ln1043">	ac97_reg_cached_write(dev, 0x72, 0x0002);</a>
<a name="ln1044">	/* Set Multi Channel to default */</a>
<a name="ln1045">	ac97_reg_cached_write(dev, 0x74, 0x0000);</a>
<a name="ln1046">	/* Enable register 0x78 */</a>
<a name="ln1047">	ac97_reg_cached_write(dev, 0x76, 0xabba);</a>
<a name="ln1048">	/* Set Clock Access to default */</a>
<a name="ln1049">	ac97_reg_cached_write(dev, 0x78, 0x0000);</a>
<a name="ln1050">}</a>
<a name="ln1051"> </a>
<a name="ln1052"> </a>
<a name="ln1053"> </a>
<a name="ln1054">void</a>
<a name="ln1055">stac9758_init(ac97_dev *dev)</a>
<a name="ln1056">{</a>
<a name="ln1057">	LOG((&quot;stac9758_init\n&quot;));</a>
<a name="ln1058"> </a>
<a name="ln1059">	ac97_reg_update_bits(dev, AC97_PAGING, 0xf, 0);</a>
<a name="ln1060"> </a>
<a name="ln1061">	if (dev-&gt;subsystem == 0x107b0601) {</a>
<a name="ln1062">		ac97_reg_cached_write(dev, 0x64, 0xfc70);</a>
<a name="ln1063">		ac97_reg_cached_write(dev, 0x68, 0x2102);</a>
<a name="ln1064">		ac97_reg_cached_write(dev, 0x66, 0x0203);</a>
<a name="ln1065">		ac97_reg_cached_write(dev, 0x72, 0x0041);</a>
<a name="ln1066">	} else {</a>
<a name="ln1067">		ac97_reg_cached_write(dev, 0x64, 0xd794);</a>
<a name="ln1068">		ac97_reg_cached_write(dev, 0x68, 0x2001);</a>
<a name="ln1069">		ac97_reg_cached_write(dev, 0x66, 0x0201);</a>
<a name="ln1070">		ac97_reg_cached_write(dev, 0x72, 0x0040);</a>
<a name="ln1071">	}</a>
<a name="ln1072">}</a>
<a name="ln1073"> </a>
<a name="ln1074"> </a>
<a name="ln1075">void</a>
<a name="ln1076">tr28028_init(ac97_dev *dev)</a>
<a name="ln1077">{</a>
<a name="ln1078">	LOG((&quot;tr28028_init\n&quot;));</a>
<a name="ln1079">	ac97_reg_cached_write(dev, AC97_POWERDOWN, 0x0300);</a>
<a name="ln1080">	ac97_reg_cached_write(dev, AC97_POWERDOWN, 0x0000);</a>
<a name="ln1081">	ac97_reg_cached_write(dev, AC97_SURR_VOLUME, 0x0000);</a>
<a name="ln1082">	ac97_reg_cached_write(dev, AC97_SPDIF_CONTROL, 0x0000);</a>
<a name="ln1083">}</a>
<a name="ln1084"> </a>
<a name="ln1085"> </a>
<a name="ln1086">void</a>
<a name="ln1087">wm9701_init(ac97_dev *dev)</a>
<a name="ln1088">{</a>
<a name="ln1089">	LOG((&quot;wm9701_init\n&quot;));</a>
<a name="ln1090">	/* ALSA writes some of these registers, but the codec</a>
<a name="ln1091">	 * documentation states explicitly that 0x38 and 0x70 to 0x74</a>
<a name="ln1092">	 * are not used in the WM9701A</a>
<a name="ln1093">	 */</a>
<a name="ln1094"> </a>
<a name="ln1095">	/* DVD noise patch (?) */</a>
<a name="ln1096">	ac97_reg_cached_write(dev, 0x5a, 0x0200);</a>
<a name="ln1097">}</a>
<a name="ln1098"> </a>
<a name="ln1099"> </a>
<a name="ln1100">void</a>
<a name="ln1101">wm9703_init(ac97_dev *dev)</a>
<a name="ln1102">{</a>
<a name="ln1103">	LOG((&quot;wm9703_init\n&quot;));</a>
<a name="ln1104">	/* Set front mixer value to unmuted */</a>
<a name="ln1105">	ac97_reg_cached_write(dev, 0x72, 0x0808);</a>
<a name="ln1106">	/* Disable loopback, etc */</a>
<a name="ln1107">	ac97_reg_cached_write(dev, AC97_GENERAL_PURPOSE, 0x8000);</a>
<a name="ln1108">}</a>
<a name="ln1109"> </a>
<a name="ln1110"> </a>
<a name="ln1111">void</a>
<a name="ln1112">wm9704_init(ac97_dev *dev)</a>
<a name="ln1113">{</a>
<a name="ln1114">	LOG((&quot;wm9704_init\n&quot;));</a>
<a name="ln1115">	/* Set read DAC value to unmuted */</a>
<a name="ln1116">	ac97_reg_cached_write(dev, 0x70, 0x0808);</a>
<a name="ln1117">	/* Set front mixer value to unmuted */</a>
<a name="ln1118">	ac97_reg_cached_write(dev, 0x72, 0x0808);</a>
<a name="ln1119">	/* Set rear mixer value to unmuted */</a>
<a name="ln1120">	ac97_reg_cached_write(dev, 0x74, 0x0808);</a>
<a name="ln1121">	/* DVD noise patch (?) */</a>
<a name="ln1122">	ac97_reg_cached_write(dev, 0x5a, 0x0200);</a>
<a name="ln1123">}</a>
<a name="ln1124"> </a>
<a name="ln1125"> </a>
<a name="ln1126">const ac97_source_info source_info[] = {</a>
<a name="ln1127">	{ &quot;Recording&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO|B_MIX_RECORDMUX, 100, AC97_RECORD_GAIN, 0x8000, 4, 0, 1, 0, 0.0, 22.5, 1.5 },</a>
<a name="ln1128">	{ &quot;Master&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 101, AC97_MASTER_VOLUME, 0x8000, 5, 0, 1, 1,-46.5, 0.0, 1.5 },</a>
<a name="ln1129">	//{ &quot;Bass/Treble&quot;, B_MIX_GAIN|B_MIX_STEREO, 102, AC97_MASTER_TONE, 0x0f0f, 4, 0, 1, 1,-12.0, 10.5, 1.5 },</a>
<a name="ln1130">	//{ &quot;Aux out&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 103, AC97_AUX_OUT_VOLUME, 0x8000, 5, 0, 1, 1,-46.5, 0.0, 1.5 },</a>
<a name="ln1131">	{ &quot;PCM out&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 104, AC97_PCM_OUT_VOLUME, 0x8808, 5, 0, 1, 1,-34.5, 12.0, 1.5 },</a>
<a name="ln1132">	{ &quot;CD&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 105, AC97_CD_VOLUME, 0x8808, 5, 0, 1, 1,-34.5, 12.0, 1.5 },</a>
<a name="ln1133">	{ &quot;Aux In&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 106, AC97_AUX_IN_VOLUME, 0x8808, 5, 0, 1, 1,-34.5, 12.0, 1.5 },</a>
<a name="ln1134">	{ &quot;TAD&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_MONO, 107, AC97_PHONE_VOLUME, 0x8008, 5, 0, 1, 1,-34.5, 12.0, 1.5 },</a>
<a name="ln1135">	{ &quot;Mic&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_MONO|B_MIX_MICBOOST, 108, AC97_MIC_VOLUME, 0x8008, 5, 0, 1, 1,-34.5, 12.0, 1.5 },</a>
<a name="ln1136">	{ &quot;Line in&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 109, AC97_LINE_IN_VOLUME, 0x8808, 5, 0, 1, 1,-34.5, 12.0, 1.5 },</a>
<a name="ln1137">	//{ &quot;Center/Lfe&quot;, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 111, AC97_CENTER_LFE_VOLUME, 0x8080, 5, 0, 1, 1,-46.5, 0.0, 1.5 },</a>
<a name="ln1138">	{ &quot;Center/Lfe&quot; /* should be &quot;Surround&quot; but no */, B_MIX_GAIN|B_MIX_MUTE|B_MIX_STEREO, 110, AC97_SURR_VOLUME, 0x8080, 5, 0, 1, 1,-46.5, 0.0, 1.5 }</a>
<a name="ln1139">};</a>
<a name="ln1140"> </a>
<a name="ln1141">const int32 source_info_size = (sizeof(source_info)/sizeof(source_info[0]));</a>

</code></pre>
<div class="balloon" rel="486"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="759"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="759"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the third actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="759"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the fourth actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="441"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the fourth actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="441"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the third actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="441"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="316"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'dprintf' function. The memsize type argument is expected.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
