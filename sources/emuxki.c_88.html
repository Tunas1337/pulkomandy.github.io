
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>emuxki.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Emuxki BeOS Driver for Creative Labs SBLive!/Audigy series</a>
<a name="ln3"> *</a>
<a name="ln4"> * Copyright (c) 2002, Jerome Duval (jerome.duval@free.fr)</a>
<a name="ln5"> *</a>
<a name="ln6"> * Authors:</a>
<a name="ln7"> *		Alexander Coers		Alexander.Coers@gmx.de</a>
<a name="ln8"> *		Fredrik Mod√©en 		fredrik@modeen.se</a>
<a name="ln9"> *</a>
<a name="ln10">*/</a>
<a name="ln11">/* This code is derived from the NetBSD driver for Creative Labs SBLive! series</a>
<a name="ln12"> *</a>
<a name="ln13"> * Copyright (c) 2001 The NetBSD Foundation, Inc.</a>
<a name="ln14"> * All rights reserved.</a>
<a name="ln15"> *</a>
<a name="ln16"> * This code is derived from software contributed to The NetBSD Foundation</a>
<a name="ln17"> * by Yannick Montulet.</a>
<a name="ln18"> *</a>
<a name="ln19"> * Redistribution and use in source and binary forms, with or without</a>
<a name="ln20"> * modification, are permitted provided that the following conditions</a>
<a name="ln21"> * are met:</a>
<a name="ln22"> * 1. Redistributions of source code must retain the above copyright</a>
<a name="ln23"> *    notice, this list of conditions and the following disclaimer.</a>
<a name="ln24"> * 2. Redistributions in binary form must reproduce the above copyright</a>
<a name="ln25"> *    notice, this list of conditions and the following disclaimer in the</a>
<a name="ln26"> *    documentation and/or other materials provided with the distribution.</a>
<a name="ln27"> * 3. All advertising materials mentioning features or use of this software</a>
<a name="ln28"> *    must display the following acknowledgement:</a>
<a name="ln29"> *	This product includes software developed by the NetBSD</a>
<a name="ln30"> *	Foundation, Inc. and its contributors.</a>
<a name="ln31"> * 4. Neither the name of The NetBSD Foundation nor the names of its</a>
<a name="ln32"> *    contributors may be used to endorse or promote products derived</a>
<a name="ln33"> *    from this software without specific prior written permission.</a>
<a name="ln34"> *</a>
<a name="ln35"> * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS</a>
<a name="ln36"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</a>
<a name="ln37"> * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</a>
<a name="ln38"> * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS</a>
<a name="ln39"> * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</a>
<a name="ln40"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</a>
<a name="ln41"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</a>
<a name="ln42"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</a>
<a name="ln43"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</a>
<a name="ln44"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</a>
<a name="ln45"> * POSSIBILITY OF SUCH DAMAGE.</a>
<a name="ln46"> */</a>
<a name="ln47"> </a>
<a name="ln48">#include &lt;ByteOrder.h&gt;</a>
<a name="ln49">#include &lt;KernelExport.h&gt;</a>
<a name="ln50">#include &lt;PCI.h&gt;</a>
<a name="ln51">#include &lt;driver_settings.h&gt;</a>
<a name="ln52">#include &lt;fcntl.h&gt;</a>
<a name="ln53">#include &lt;math.h&gt;</a>
<a name="ln54">#include &lt;midi_driver.h&gt;</a>
<a name="ln55">#include &lt;stdio.h&gt;</a>
<a name="ln56">#include &lt;stdlib.h&gt;</a>
<a name="ln57">#include &lt;string.h&gt;</a>
<a name="ln58">#include &lt;unistd.h&gt;</a>
<a name="ln59">#include &quot;emuxki.h&quot;</a>
<a name="ln60">#include &quot;debug.h&quot;</a>
<a name="ln61">#include &quot;config.h&quot;</a>
<a name="ln62">#include &quot;util.h&quot;</a>
<a name="ln63">#include &quot;io.h&quot;</a>
<a name="ln64">#include &quot;multi.h&quot;</a>
<a name="ln65">#include &quot;ac97.h&quot;</a>
<a name="ln66"> </a>
<a name="ln67">status_t init_hardware(void);</a>
<a name="ln68">status_t init_driver(void);</a>
<a name="ln69">void uninit_driver(void);</a>
<a name="ln70">const char ** publish_devices(void);</a>
<a name="ln71">device_hooks * find_device(const char *);</a>
<a name="ln72"> </a>
<a name="ln73">pci_module_info	*pci;</a>
<a name="ln74">generic_mpu401_module * mpu401;</a>
<a name="ln75">//static char gameport_name[] = &quot;generic/gameport/v2&quot;;</a>
<a name="ln76">//generic_gameport_module * gameport;</a>
<a name="ln77"> </a>
<a name="ln78">int32 num_cards;</a>
<a name="ln79">emuxki_dev cards[NUM_CARDS];</a>
<a name="ln80">int32 num_names;</a>
<a name="ln81">char * names[NUM_CARDS*20+1];</a>
<a name="ln82"> </a>
<a name="ln83">emuxki_settings current_settings = {</a>
<a name="ln84">		2,      // channels</a>
<a name="ln85">		16,     // bits per sample</a>
<a name="ln86">		48000,  // sample rate</a>
<a name="ln87">		512,    // buffer frames</a>
<a name="ln88">		2       // buffer count</a>
<a name="ln89">};</a>
<a name="ln90"> </a>
<a name="ln91">status_t emuxki_init(emuxki_dev *card);</a>
<a name="ln92">void emuxki_shutdown(emuxki_dev *card);</a>
<a name="ln93"> </a>
<a name="ln94">extern device_hooks multi_hooks;</a>
<a name="ln95">extern device_hooks midi_hooks;</a>
<a name="ln96">//extern device_hooks joy_hooks;</a>
<a name="ln97"> </a>
<a name="ln98">/* Hardware Dump */</a>
<a name="ln99"> </a>
<a name="ln100">static void</a>
<a name="ln101">dump_hardware_regs(device_config *config)</a>
<a name="ln102">{</a>
<a name="ln103">	LOG((&quot;EMU_IPR = %#08x\n&quot;,emuxki_reg_read_32(config, EMU_IPR)));</a>
<a name="ln104">	LOG((&quot;EMU_INTE = %#08x\n&quot;,emuxki_reg_read_32(config, EMU_INTE)));</a>
<a name="ln105">	LOG((&quot;EMU_HCFG = %#08x\n&quot;,emuxki_reg_read_32(config, EMU_HCFG)));</a>
<a name="ln106">	snooze(1000);</a>
<a name="ln107">	/*emuxki_reg_write_8(config, EMU_AC97ADDRESS, EMU_AC97ADDRESS_READY);</a>
<a name="ln108">	LOG((&quot;EMU_AC97ADDRESS_READY = %#08x\n&quot;, emuxki_reg_read_16(config, EMU_AC97DATA)));*/</a>
<a name="ln109"> </a>
<a name="ln110">	/*emuxki_reg_write_8(config, EMU_AC97ADDRESS, EMU_AC97ADDRESS_ADDRESS);</a>
<a name="ln111">	LOG((&quot;EMU_AC97ADDRESS_ADDRESS = %#08x\n&quot;, emuxki_reg_read_16(config, EMU_AC97DATA)));*/</a>
<a name="ln112"> </a>
<a name="ln113">	/*LOG((&quot;EMU_CHAN_CPF_STEREO = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_CPF_STEREO)));</a>
<a name="ln114">	LOG((&quot;EMU_CHAN_FXRT = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_FXRT)));</a>
<a name="ln115">	LOG((&quot;EMU_CHAN_PTRX = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_PTRX)));</a>
<a name="ln116">	LOG((&quot;EMU_CHAN_DSL = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_DSL)));</a>
<a name="ln117">	LOG((&quot;EMU_CHAN_PSST = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_PSST)));</a>
<a name="ln118">	LOG((&quot;EMU_CHAN_CCCA = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_CCCA)));</a>
<a name="ln119">	LOG((&quot;EMU_CHAN_Z1 = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_Z1)));</a>
<a name="ln120">	LOG((&quot;EMU_CHAN_Z2 = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_Z2)));</a>
<a name="ln121">	LOG((&quot;EMU_CHAN_MAPA = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_MAPA)));</a>
<a name="ln122">	LOG((&quot;EMU_CHAN_MAPB = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_MAPB)));</a>
<a name="ln123">	LOG((&quot;EMU_CHAN_CVCF_CURRENTFILTER = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_CVCF_CURRENTFILTER)));</a>
<a name="ln124">	LOG((&quot;EMU_CHAN_VTFT_FILTERTARGET = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_VTFT_FILTERTARGET)));</a>
<a name="ln125">	LOG((&quot;EMU_CHAN_ATKHLDM = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_ATKHLDM)));</a>
<a name="ln126">	LOG((&quot;EMU_CHAN_DCYSUSM = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_DCYSUSM)));</a>
<a name="ln127">	LOG((&quot;EMU_CHAN_LFOVAL1 = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_LFOVAL1)));</a>
<a name="ln128">	LOG((&quot;EMU_CHAN_LFOVAL2 = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_LFOVAL2)));</a>
<a name="ln129">	LOG((&quot;EMU_CHAN_FMMOD = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_FMMOD)));</a>
<a name="ln130">	LOG((&quot;EMU_CHAN_TREMFRQ = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_TREMFRQ)));</a>
<a name="ln131">	LOG((&quot;EMU_CHAN_FM2FRQ2 = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_FM2FRQ2)));</a>
<a name="ln132">	LOG((&quot;EMU_CHAN_ENVVAL = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_ENVVAL)));</a>
<a name="ln133">	LOG((&quot;EMU_CHAN_ATKHLDV = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_ATKHLDV)));</a>
<a name="ln134">	LOG((&quot;EMU_CHAN_ENVVOL = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_ENVVOL)));</a>
<a name="ln135">	LOG((&quot;EMU_CHAN_PEFE = %#08x\n&quot;,emuxki_chan_read(config, 0, EMU_CHAN_PEFE)));*/</a>
<a name="ln136"> </a>
<a name="ln137">}</a>
<a name="ln138"> </a>
<a name="ln139"> </a>
<a name="ln140">/*static void</a>
<a name="ln141">trace_hardware_regs(device_config *config)</a>
<a name="ln142">{</a>
<a name="ln143">	TRACE((&quot;EMU_IPR = %#08x\n&quot;,emuxki_reg_read_32(config, EMU_IPR)));</a>
<a name="ln144">	TRACE((&quot;EMU_INTE = %#08x\n&quot;,emuxki_reg_read_32(config, EMU_INTE)));</a>
<a name="ln145">	TRACE((&quot;EMU_HCFG = %#08x\n&quot;,emuxki_reg_read_32(config, EMU_HCFG)));</a>
<a name="ln146">}*/</a>
<a name="ln147"> </a>
<a name="ln148">/* Misc stuff relative to Emuxki */</a>
<a name="ln149"> </a>
<a name="ln150">int             emu10k1_recbuf_sizes[] = {</a>
<a name="ln151">	0, 384, 448, 512, 640, 768, 896, 1024, 1280, 1536, 1792,</a>
<a name="ln152">	2048, 2560, 3072, 3584, 4096, 5120, 6144, 7168, 8192, 10240, 12288,</a>
<a name="ln153">	14366, 16384, 20480, 24576, 28672, 32768, 40960, 49152, 57344, 65536</a>
<a name="ln154">};</a>
<a name="ln155"> </a>
<a name="ln156"> </a>
<a name="ln157">static uint32</a>
<a name="ln158">emuxki_rate_to_pitch(uint32 rate)</a>
<a name="ln159">{</a>
<a name="ln160">	static uint32 logMagTable[128] = {</a>
<a name="ln161">		0x00000, 0x02dfc, 0x05b9e, 0x088e6, 0x0b5d6, 0x0e26f, 0x10eb3,</a>
<a name="ln162">		0x13aa2, 0x1663f, 0x1918a, 0x1bc84, 0x1e72e, 0x2118b, 0x23b9a,</a>
<a name="ln163">		0x2655d, 0x28ed5, 0x2b803, 0x2e0e8, 0x30985, 0x331db, 0x359eb,</a>
<a name="ln164">		0x381b6, 0x3a93d, 0x3d081, 0x3f782, 0x41e42, 0x444c1, 0x46b01,</a>
<a name="ln165">		0x49101, 0x4b6c4, 0x4dc49, 0x50191, 0x5269e, 0x54b6f, 0x57006,</a>
<a name="ln166">		0x59463, 0x5b888, 0x5dc74, 0x60029, 0x623a7, 0x646ee, 0x66a00,</a>
<a name="ln167">		0x68cdd, 0x6af86, 0x6d1fa, 0x6f43c, 0x7164b, 0x73829, 0x759d4,</a>
<a name="ln168">		0x77b4f, 0x79c9a, 0x7bdb5, 0x7dea1, 0x7ff5e, 0x81fed, 0x8404e,</a>
<a name="ln169">		0x86082, 0x88089, 0x8a064, 0x8c014, 0x8df98, 0x8fef1, 0x91e20,</a>
<a name="ln170">		0x93d26, 0x95c01, 0x97ab4, 0x9993e, 0x9b79f, 0x9d5d9, 0x9f3ec,</a>
<a name="ln171">		0xa11d8, 0xa2f9d, 0xa4d3c, 0xa6ab5, 0xa8808, 0xaa537, 0xac241,</a>
<a name="ln172">		0xadf26, 0xafbe7, 0xb1885, 0xb3500, 0xb5157, 0xb6d8c, 0xb899f,</a>
<a name="ln173">		0xba58f, 0xbc15e, 0xbdd0c, 0xbf899, 0xc1404, 0xc2f50, 0xc4a7b,</a>
<a name="ln174">		0xc6587, 0xc8073, 0xc9b3f, 0xcb5ed, 0xcd07c, 0xceaec, 0xd053f,</a>
<a name="ln175">		0xd1f73, 0xd398a, 0xd5384, 0xd6d60, 0xd8720, 0xda0c3, 0xdba4a,</a>
<a name="ln176">		0xdd3b4, 0xded03, 0xe0636, 0xe1f4e, 0xe384a, 0xe512c, 0xe69f3,</a>
<a name="ln177">		0xe829f, 0xe9b31, 0xeb3a9, 0xecc08, 0xee44c, 0xefc78, 0xf148a,</a>
<a name="ln178">		0xf2c83, 0xf4463, 0xf5c2a, 0xf73da, 0xf8b71, 0xfa2f0, 0xfba57,</a>
<a name="ln179">		0xfd1a7, 0xfe8df</a>
<a name="ln180">	};</a>
<a name="ln181">	static uint8 logSlopeTable[128] = {</a>
<a name="ln182">		0x5c, 0x5c, 0x5b, 0x5a, 0x5a, 0x59, 0x58, 0x58,</a>
<a name="ln183">		0x57, 0x56, 0x56, 0x55, 0x55, 0x54, 0x53, 0x53,</a>
<a name="ln184">		0x52, 0x52, 0x51, 0x51, 0x50, 0x50, 0x4f, 0x4f,</a>
<a name="ln185">		0x4e, 0x4d, 0x4d, 0x4d, 0x4c, 0x4c, 0x4b, 0x4b,</a>
<a name="ln186">		0x4a, 0x4a, 0x49, 0x49, 0x48, 0x48, 0x47, 0x47,</a>
<a name="ln187">		0x47, 0x46, 0x46, 0x45, 0x45, 0x45, 0x44, 0x44,</a>
<a name="ln188">		0x43, 0x43, 0x43, 0x42, 0x42, 0x42, 0x41, 0x41,</a>
<a name="ln189">		0x41, 0x40, 0x40, 0x40, 0x3f, 0x3f, 0x3f, 0x3e,</a>
<a name="ln190">		0x3e, 0x3e, 0x3d, 0x3d, 0x3d, 0x3c, 0x3c, 0x3c,</a>
<a name="ln191">		0x3b, 0x3b, 0x3b, 0x3b, 0x3a, 0x3a, 0x3a, 0x39,</a>
<a name="ln192">		0x39, 0x39, 0x39, 0x38, 0x38, 0x38, 0x38, 0x37,</a>
<a name="ln193">		0x37, 0x37, 0x37, 0x36, 0x36, 0x36, 0x36, 0x35,</a>
<a name="ln194">		0x35, 0x35, 0x35, 0x34, 0x34, 0x34, 0x34, 0x34,</a>
<a name="ln195">		0x33, 0x33, 0x33, 0x33, 0x32, 0x32, 0x32, 0x32,</a>
<a name="ln196">		0x32, 0x31, 0x31, 0x31, 0x31, 0x31, 0x30, 0x30,</a>
<a name="ln197">		0x30, 0x30, 0x30, 0x2f, 0x2f, 0x2f, 0x2f, 0x2f</a>
<a name="ln198">	};</a>
<a name="ln199">	int8          i;</a>
<a name="ln200"> </a>
<a name="ln201">	if (rate == 0)</a>
<a name="ln202">		return 0;	/* Bail out if no leading &quot;1&quot; */</a>
<a name="ln203">	rate *= 11185;		/* Scale 48000 to 0x20002380 */</a>
<a name="ln204">	for (i = 31; i &gt; 0; i--) {</a>
<a name="ln205">		if (rate &amp; 0x80000000) {	/* Detect leading &quot;1&quot; */</a>
<a name="ln206">			return (((uint32) (i - 15) &lt;&lt; 20) +</a>
<a name="ln207">				logMagTable[0x7f &amp; (rate &gt;&gt; 24)] +</a>
<a name="ln208">				(0x7f &amp; (rate &gt;&gt; 17)) *</a>
<a name="ln209">				logSlopeTable[0x7f &amp; (rate &gt;&gt; 24)]);</a>
<a name="ln210">		}</a>
<a name="ln211">		rate &lt;&lt;= 1;</a>
<a name="ln212">	}</a>
<a name="ln213">	return 0;		/* Should never reach this point */</a>
<a name="ln214">}</a>
<a name="ln215"> </a>
<a name="ln216">/* Emuxki Memory management */</a>
<a name="ln217"> </a>
<a name="ln218">static emuxki_mem *</a>
<a name="ln219">emuxki_mem_new(emuxki_dev *card, int ptbidx, size_t size)</a>
<a name="ln220">{</a>
<a name="ln221">	emuxki_mem *mem;</a>
<a name="ln222"> </a>
<a name="ln223">	if ((mem = malloc(sizeof(*mem))) == NULL)</a>
<a name="ln224">		return (NULL);</a>
<a name="ln225"> </a>
<a name="ln226">	mem-&gt;ptbidx = ptbidx;</a>
<a name="ln227">	mem-&gt;area = alloc_mem(&amp;mem-&gt;phy_base, &amp;mem-&gt;log_base, size, &quot;emuxki buffer&quot;);</a>
<a name="ln228">	mem-&gt;size = size;</a>
<a name="ln229">	if (mem-&gt;area &lt; B_OK) {</a>
<a name="ln230">		free(mem);</a>
<a name="ln231">		return NULL;</a>
<a name="ln232">	}</a>
<a name="ln233">	return mem;</a>
<a name="ln234">}</a>
<a name="ln235"> </a>
<a name="ln236"> </a>
<a name="ln237">static void</a>
<a name="ln238">emuxki_mem_delete(emuxki_mem *mem)</a>
<a name="ln239">{</a>
<a name="ln240">	if (mem-&gt;area &gt; B_OK)</a>
<a name="ln241">		delete_area(mem-&gt;area);</a>
<a name="ln242">	free(mem);</a>
<a name="ln243">}</a>
<a name="ln244"> </a>
<a name="ln245"> </a>
<a name="ln246">void *</a>
<a name="ln247">emuxki_pmem_alloc(emuxki_dev *card, size_t size)</a>
<a name="ln248">{</a>
<a name="ln249">	int             i;//, s;</a>
<a name="ln250">	size_t          numblocks;</a>
<a name="ln251">	emuxki_mem *mem;</a>
<a name="ln252">	uint32      j, *ptb, silentpage;</a>
<a name="ln253"> </a>
<a name="ln254">	ptb = card-&gt;ptb_log_base;</a>
<a name="ln255">	silentpage = ((uint32)card-&gt;silentpage_phy_base) &lt;&lt; 1;</a>
<a name="ln256">	numblocks = size / EMU_PTESIZE;</a>
<a name="ln257">	if (size % EMU_PTESIZE)</a>
<a name="ln258">		numblocks++;</a>
<a name="ln259"> </a>
<a name="ln260">	PRINT((&quot;emuxki_pmem_alloc : numblocks : %ld\n&quot;, numblocks));</a>
<a name="ln261"> </a>
<a name="ln262">	for (i = 0; i &lt; EMU_MAXPTE; i++) {</a>
<a name="ln263">		PRINT((&quot;emuxki_pmem_alloc : %d\n&quot;, i));</a>
<a name="ln264">		if ((B_LENDIAN_TO_HOST_INT32(ptb[i]) &amp; EMU_CHAN_MAP_PTE_MASK) == silentpage) {</a>
<a name="ln265">			/* We look for a free PTE */</a>
<a name="ln266">			//s = splaudio();</a>
<a name="ln267">			for (j = 0; j &lt; numblocks; j++)</a>
<a name="ln268">				if ((B_LENDIAN_TO_HOST_INT32(ptb[i + j]) &amp; EMU_CHAN_MAP_PTE_MASK)</a>
<a name="ln269">				    != silentpage)</a>
<a name="ln270">					break;</a>
<a name="ln271">			if (j == numblocks) {</a>
<a name="ln272">				PRINT((&quot;emuxki_pmem_alloc : j == numblocks %ld\n&quot;, j));</a>
<a name="ln273">				if ((mem = emuxki_mem_new(card, i, size)) == NULL) {</a>
<a name="ln274">					//splx(s);</a>
<a name="ln275">					return (NULL);</a>
<a name="ln276">				}</a>
<a name="ln277">				PRINT((&quot;emuxki_pmem_alloc : j == numblocks emuxki_mem_new ok\n&quot;));</a>
<a name="ln278">				for (j = 0; j &lt; numblocks; j++)</a>
<a name="ln279">					ptb[i + j] = B_HOST_TO_LENDIAN_INT32((uint32) (</a>
<a name="ln280">						(( ((uint32)mem-&gt;phy_base) +</a>
<a name="ln281">						 j * EMU_PTESIZE) &lt;&lt; 1)</a>
<a name="ln282">						| (i + j)));</a>
<a name="ln283">				LIST_INSERT_HEAD(&amp;(card-&gt;mem), mem, next);</a>
<a name="ln284">				PRINT((&quot;emuxki_pmem_alloc : j == numblocks returning\n&quot;));</a>
<a name="ln285"> </a>
<a name="ln286">				//splx(s);</a>
<a name="ln287">				return mem-&gt;log_base;</a>
<a name="ln288">			} else {</a>
<a name="ln289">				PRINT((&quot;emuxki_pmem_alloc : j != numblocks %ld\n&quot;, j));</a>
<a name="ln290">				i += j;</a>
<a name="ln291">			}</a>
<a name="ln292">			//splx(s);</a>
<a name="ln293">		}</a>
<a name="ln294">	}</a>
<a name="ln295">	return NULL;</a>
<a name="ln296">}</a>
<a name="ln297"> </a>
<a name="ln298"> </a>
<a name="ln299">void *</a>
<a name="ln300">emuxki_rmem_alloc(emuxki_dev *card, size_t size)</a>
<a name="ln301">{</a>
<a name="ln302">	emuxki_mem *mem;</a>
<a name="ln303">	//int             s;</a>
<a name="ln304"> </a>
<a name="ln305">	mem = emuxki_mem_new(card, EMU_RMEM, size);</a>
<a name="ln306">	if (mem == NULL)</a>
<a name="ln307">		return (NULL);</a>
<a name="ln308"> </a>
<a name="ln309">	//s = splaudio();</a>
<a name="ln310">	LIST_INSERT_HEAD(&amp;(card-&gt;mem), mem, next);</a>
<a name="ln311">	//splx(s);</a>
<a name="ln312"> </a>
<a name="ln313">	return mem-&gt;log_base;</a>
<a name="ln314">}</a>
<a name="ln315"> </a>
<a name="ln316"> </a>
<a name="ln317">void</a>
<a name="ln318">emuxki_mem_free(emuxki_dev *card, void *ptr)</a>
<a name="ln319">{</a>
<a name="ln320">	emuxki_mem 		*mem;</a>
<a name="ln321">	size_t          numblocks;</a>
<a name="ln322">	uint32      	i, *ptb, silentpage;</a>
<a name="ln323"> </a>
<a name="ln324">	ptb = card-&gt;ptb_log_base;</a>
<a name="ln325">	silentpage = ((uint32)card-&gt;silentpage_phy_base) &lt;&lt; 1;</a>
<a name="ln326">	LOG((&quot;emuxki_mem_free 1\n&quot;));</a>
<a name="ln327">	LIST_FOREACH(mem, &amp;card-&gt;mem, next) {</a>
<a name="ln328">		LOG((&quot;emuxki_mem_free 2\n&quot;));</a>
<a name="ln329">		if (mem-&gt;log_base != ptr)</a>
<a name="ln330">			continue;</a>
<a name="ln331">		LOG((&quot;emuxki_mem_free 3\n&quot;));</a>
<a name="ln332">		//s = splaudio();</a>
<a name="ln333">		if (mem-&gt;ptbidx != EMU_RMEM) {</a>
<a name="ln334">			LOG((&quot;mem_size : %i\n&quot;, mem-&gt;size));</a>
<a name="ln335">			numblocks = mem-&gt;size / EMU_PTESIZE;</a>
<a name="ln336">			if (mem-&gt;size % EMU_PTESIZE)</a>
<a name="ln337">				numblocks++;</a>
<a name="ln338">			for (i = 0; i &lt; numblocks; i++)</a>
<a name="ln339">				ptb[mem-&gt;ptbidx + i] =</a>
<a name="ln340">					B_HOST_TO_LENDIAN_INT32(silentpage | (mem-&gt;ptbidx + i));</a>
<a name="ln341">		}</a>
<a name="ln342">		LIST_REMOVE(mem, next);</a>
<a name="ln343">		//splx(s);</a>
<a name="ln344"> </a>
<a name="ln345">		LOG((&quot;freeing mem\n&quot;));</a>
<a name="ln346">		emuxki_mem_delete(mem);</a>
<a name="ln347">		break;</a>
<a name="ln348">	}</a>
<a name="ln349">}</a>
<a name="ln350"> </a>
<a name="ln351">/* Emuxki channel functions */</a>
<a name="ln352"> </a>
<a name="ln353">static void</a>
<a name="ln354">emuxki_chanparms_set_defaults(emuxki_channel *chan)</a>
<a name="ln355">{</a>
<a name="ln356">	chan-&gt;fxsend.a.level = chan-&gt;fxsend.b.level</a>
<a name="ln357">		= chan-&gt;fxsend.c.level = chan-&gt;fxsend.d.level</a>
<a name="ln358">	/* for audigy */</a>
<a name="ln359">		= chan-&gt;fxsend.e.level = chan-&gt;fxsend.f.level</a>
<a name="ln360">		= chan-&gt;fxsend.g.level = chan-&gt;fxsend.h.level</a>
<a name="ln361">		= IS_AUDIGY(&amp;chan-&gt;voice-&gt;stream-&gt;card-&gt;config) ? 0xc0 : 0xff;	/* not max */</a>
<a name="ln362"> </a>
<a name="ln363">	chan-&gt;fxsend.a.dest = 0x0;</a>
<a name="ln364">	chan-&gt;fxsend.b.dest = 0x1;</a>
<a name="ln365">	chan-&gt;fxsend.c.dest = 0x2;</a>
<a name="ln366">	chan-&gt;fxsend.d.dest = 0x3;</a>
<a name="ln367">	/* for audigy */</a>
<a name="ln368">	chan-&gt;fxsend.e.dest = 0x4;</a>
<a name="ln369">	chan-&gt;fxsend.f.dest = 0x5;</a>
<a name="ln370">	chan-&gt;fxsend.g.dest = 0x6;</a>
<a name="ln371">	chan-&gt;fxsend.h.dest = 0x7;</a>
<a name="ln372"> </a>
<a name="ln373">	chan-&gt;pitch.intial = 0x0000;	/* shouldn't it be 0xE000 ? */</a>
<a name="ln374">	chan-&gt;pitch.current = 0x0000;	/* should it be 0x0400 */</a>
<a name="ln375">	chan-&gt;pitch.target = 0x0000;	/* the unity pitch shift ? */</a>
<a name="ln376">	chan-&gt;pitch.envelope_amount = 0x00;	/* none */</a>
<a name="ln377"> </a>
<a name="ln378">	chan-&gt;initial_attenuation = 0x00;	/* no attenuation */</a>
<a name="ln379">	chan-&gt;volume.current = 0x0000;	/* no volume */</a>
<a name="ln380">	chan-&gt;volume.target = 0xffff;</a>
<a name="ln381">	chan-&gt;volume.envelope.current_state = 0x8000;	/* 0 msec delay */</a>
<a name="ln382">	chan-&gt;volume.envelope.hold_time = 0x7f;	/* 0 msec */</a>
<a name="ln383">	chan-&gt;volume.envelope.attack_time = 0x7f;	/* 5.5msec */</a>
<a name="ln384">	chan-&gt;volume.envelope.sustain_level = 0x7f;	/* full  */</a>
<a name="ln385">	chan-&gt;volume.envelope.decay_time = 0x7f;	/* 22msec  */</a>
<a name="ln386"> </a>
<a name="ln387">	chan-&gt;filter.initial_cutoff_frequency = 0xff;	/* no filter */</a>
<a name="ln388">	chan-&gt;filter.current_cutoff_frequency = 0xffff;	/* no filtering */</a>
<a name="ln389">	chan-&gt;filter.target_cutoff_frequency = 0xffff;	/* no filtering */</a>
<a name="ln390">	chan-&gt;filter.lowpass_resonance_height = 0x0;</a>
<a name="ln391">	chan-&gt;filter.interpolation_ROM = 0x1;	/* full band */</a>
<a name="ln392">	chan-&gt;filter.envelope_amount = 0x7f;	/* none */</a>
<a name="ln393">	chan-&gt;filter.LFO_modulation_depth = 0x00;	/* none */</a>
<a name="ln394"> </a>
<a name="ln395">	chan-&gt;loop.start = 0x000000;</a>
<a name="ln396">	chan-&gt;loop.end = 0x000010;	/* Why ? */</a>
<a name="ln397"> </a>
<a name="ln398">	chan-&gt;modulation.envelope.current_state = 0x8000;</a>
<a name="ln399">	chan-&gt;modulation.envelope.hold_time = 0x00;	/* 127 better ? */</a>
<a name="ln400">	chan-&gt;modulation.envelope.attack_time = 0x00;	/* infinite */</a>
<a name="ln401">	chan-&gt;modulation.envelope.sustain_level = 0x00;	/* off */</a>
<a name="ln402">	chan-&gt;modulation.envelope.decay_time = 0x7f;	/* 22 msec */</a>
<a name="ln403">	chan-&gt;modulation.LFO_state = 0x8000;</a>
<a name="ln404"> </a>
<a name="ln405">	chan-&gt;vibrato_LFO.state = 0x8000;</a>
<a name="ln406">	chan-&gt;vibrato_LFO.modulation_depth = 0x00;	/* none */</a>
<a name="ln407">	chan-&gt;vibrato_LFO.vibrato_depth = 0x00;</a>
<a name="ln408">	chan-&gt;vibrato_LFO.frequency = 0x00;	/* Why set to 24 when</a>
<a name="ln409">						 * initialized ? */</a>
<a name="ln410"> </a>
<a name="ln411">	chan-&gt;tremolo_depth = 0x00;</a>
<a name="ln412">}</a>
<a name="ln413"> </a>
<a name="ln414"> </a>
<a name="ln415">static emuxki_channel *</a>
<a name="ln416">emuxki_channel_new(emuxki_voice *voice, uint8 num)</a>
<a name="ln417">{</a>
<a name="ln418">	emuxki_channel *chan;</a>
<a name="ln419"> </a>
<a name="ln420">	chan = (emuxki_channel *) malloc(sizeof(emuxki_channel));</a>
<a name="ln421">	if (chan == NULL)</a>
<a name="ln422">		return NULL;</a>
<a name="ln423">	chan-&gt;voice = voice;</a>
<a name="ln424">	chan-&gt;num = num;</a>
<a name="ln425">	emuxki_chanparms_set_defaults(chan);</a>
<a name="ln426">	chan-&gt;voice-&gt;stream-&gt;card-&gt;channel[num] = chan;</a>
<a name="ln427">	return chan;</a>
<a name="ln428">}</a>
<a name="ln429"> </a>
<a name="ln430"> </a>
<a name="ln431">static void</a>
<a name="ln432">emuxki_channel_delete(emuxki_channel *chan)</a>
<a name="ln433">{</a>
<a name="ln434">	chan-&gt;voice-&gt;stream-&gt;card-&gt;channel[chan-&gt;num] = NULL;</a>
<a name="ln435">	free(chan);</a>
<a name="ln436">}</a>
<a name="ln437"> </a>
<a name="ln438"> </a>
<a name="ln439">static void</a>
<a name="ln440">emuxki_channel_set_fxsend(emuxki_channel *chan,</a>
<a name="ln441">			   emuxki_chanparms_fxsend *fxsend)</a>
<a name="ln442">{</a>
<a name="ln443">	/* Could do a memcpy ...*/</a>
<a name="ln444">	chan-&gt;fxsend.a.level = fxsend-&gt;a.level;</a>
<a name="ln445">	chan-&gt;fxsend.b.level = fxsend-&gt;b.level;</a>
<a name="ln446">	chan-&gt;fxsend.c.level = fxsend-&gt;c.level;</a>
<a name="ln447">	chan-&gt;fxsend.d.level = fxsend-&gt;d.level;</a>
<a name="ln448">	chan-&gt;fxsend.a.dest = fxsend-&gt;a.dest;</a>
<a name="ln449">	chan-&gt;fxsend.b.dest = fxsend-&gt;b.dest;</a>
<a name="ln450">	chan-&gt;fxsend.c.dest = fxsend-&gt;c.dest;</a>
<a name="ln451">	chan-&gt;fxsend.d.dest = fxsend-&gt;d.dest;</a>
<a name="ln452"> </a>
<a name="ln453">	/* for audigy */</a>
<a name="ln454">	chan-&gt;fxsend.e.level = fxsend-&gt;e.level;</a>
<a name="ln455">	chan-&gt;fxsend.f.level = fxsend-&gt;f.level;</a>
<a name="ln456">	chan-&gt;fxsend.g.level = fxsend-&gt;g.level;</a>
<a name="ln457">	chan-&gt;fxsend.h.level = fxsend-&gt;h.level;</a>
<a name="ln458">	chan-&gt;fxsend.e.dest = fxsend-&gt;e.dest;</a>
<a name="ln459">	chan-&gt;fxsend.f.dest = fxsend-&gt;f.dest;</a>
<a name="ln460">	chan-&gt;fxsend.g.dest = fxsend-&gt;g.dest;</a>
<a name="ln461">	chan-&gt;fxsend.h.dest = fxsend-&gt;h.dest;</a>
<a name="ln462">}</a>
<a name="ln463"> </a>
<a name="ln464"> </a>
<a name="ln465">static void</a>
<a name="ln466">emuxki_channel_set_srate(emuxki_channel *chan, uint32 srate)</a>
<a name="ln467">{</a>
<a name="ln468">	chan-&gt;pitch.target = (srate &lt;&lt; 8) / 375;</a>
<a name="ln469">	chan-&gt;pitch.target = (chan-&gt;pitch.target &gt;&gt; 1) +</a>
<a name="ln470">		(chan-&gt;pitch.target &amp; 1);</a>
<a name="ln471">	chan-&gt;pitch.target &amp;= 0xffff;</a>
<a name="ln472">	chan-&gt;pitch.current = chan-&gt;pitch.target;</a>
<a name="ln473">	chan-&gt;pitch.intial =</a>
<a name="ln474">		(emuxki_rate_to_pitch(srate) &gt;&gt; 8) &amp; EMU_CHAN_IP_MASK;</a>
<a name="ln475">}</a>
<a name="ln476"> </a>
<a name="ln477"> </a>
<a name="ln478">/* voice params must be set before calling this */</a>
<a name="ln479">static void</a>
<a name="ln480">emuxki_channel_set_bufparms(emuxki_channel *chan,</a>
<a name="ln481">			     uint32 start, uint32 end)</a>
<a name="ln482">{</a>
<a name="ln483">	chan-&gt;loop.start = start &amp; EMU_CHAN_PSST_LOOPSTARTADDR_MASK;</a>
<a name="ln484">	chan-&gt;loop.end = end &amp; EMU_CHAN_DSL_LOOPENDADDR_MASK;</a>
<a name="ln485">}</a>
<a name="ln486"> </a>
<a name="ln487"> </a>
<a name="ln488">static void</a>
<a name="ln489">emuxki_channel_commit_fx(emuxki_channel *chan)</a>
<a name="ln490">{</a>
<a name="ln491">	emuxki_dev   	*card = chan-&gt;voice-&gt;stream-&gt;card;</a>
<a name="ln492">	uint8			chano = chan-&gt;num;</a>
<a name="ln493"> </a>
<a name="ln494">	if (IS_AUDIGY(&amp;card-&gt;config)) {</a>
<a name="ln495">		emuxki_chan_write(&amp;card-&gt;config, chano, 0x4c, 0);</a>
<a name="ln496">		emuxki_chan_write(&amp;card-&gt;config, chano, 0x4d, 0);</a>
<a name="ln497">		emuxki_chan_write(&amp;card-&gt;config, chano, 0x4e, 0);</a>
<a name="ln498">		emuxki_chan_write(&amp;card-&gt;config, chano, 0x4f, 0);</a>
<a name="ln499"> </a>
<a name="ln500">		emuxki_chan_write(&amp;card-&gt;config, chano, EMU_A_CHAN_FXRT1,</a>
<a name="ln501">			      (chan-&gt;fxsend.d.dest &lt;&lt; 24) |</a>
<a name="ln502">			      (chan-&gt;fxsend.c.dest &lt;&lt; 16) |</a>
<a name="ln503">			      (chan-&gt;fxsend.b.dest &lt;&lt; 8) |</a>
<a name="ln504">			      (chan-&gt;fxsend.a.dest));</a>
<a name="ln505">		emuxki_chan_write(&amp;card-&gt;config, chano, EMU_A_CHAN_FXRT2,</a>
<a name="ln506">			      (chan-&gt;fxsend.h.dest &lt;&lt; 24) |</a>
<a name="ln507">			      (chan-&gt;fxsend.g.dest &lt;&lt; 16) |</a>
<a name="ln508">			      (chan-&gt;fxsend.f.dest &lt;&lt; 8) |</a>
<a name="ln509">			      (chan-&gt;fxsend.e.dest));</a>
<a name="ln510">		emuxki_chan_write(&amp;card-&gt;config, chano, EMU_A_CHAN_SENDAMOUNTS,</a>
<a name="ln511">			      (chan-&gt;fxsend.e.level &lt;&lt; 24) |</a>
<a name="ln512">			      (chan-&gt;fxsend.f.level &lt;&lt; 16) |</a>
<a name="ln513">			      (chan-&gt;fxsend.g.level &lt;&lt; 8) |</a>
<a name="ln514">			      (chan-&gt;fxsend.h.level));</a>
<a name="ln515">	} else {</a>
<a name="ln516">		emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_FXRT,</a>
<a name="ln517">			      (chan-&gt;fxsend.d.dest &lt;&lt; 28) |</a>
<a name="ln518">			      (chan-&gt;fxsend.c.dest &lt;&lt; 24) |</a>
<a name="ln519">			      (chan-&gt;fxsend.b.dest &lt;&lt; 20) |</a>
<a name="ln520">			      (chan-&gt;fxsend.a.dest &lt;&lt; 16));</a>
<a name="ln521">	}</a>
<a name="ln522"> </a>
<a name="ln523">	emuxki_chan_write(&amp;card-&gt;config, chano, 0x10000000 | EMU_CHAN_PTRX,</a>
<a name="ln524">		      (chan-&gt;fxsend.a.level &lt;&lt; 8) | chan-&gt;fxsend.b.level);</a>
<a name="ln525">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_DSL,</a>
<a name="ln526">		      (chan-&gt;fxsend.d.level &lt;&lt; 24) | chan-&gt;loop.end);</a>
<a name="ln527">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_PSST,</a>
<a name="ln528">		      (chan-&gt;fxsend.c.level &lt;&lt; 24) | chan-&gt;loop.start);</a>
<a name="ln529">}</a>
<a name="ln530"> </a>
<a name="ln531"> </a>
<a name="ln532">static void</a>
<a name="ln533">emuxki_channel_commit_parms(emuxki_channel *chan)</a>
<a name="ln534">{</a>
<a name="ln535">	emuxki_voice *voice = chan-&gt;voice;</a>
<a name="ln536">	emuxki_dev   	*card = chan-&gt;voice-&gt;stream-&gt;card;</a>
<a name="ln537">	uint32			start, mapval;</a>
<a name="ln538">	uint8			chano = chan-&gt;num;</a>
<a name="ln539">	//int             s;</a>
<a name="ln540"> </a>
<a name="ln541">	start = chan-&gt;loop.start +</a>
<a name="ln542">		(voice-&gt;stereo ? 28 : 30) * (voice-&gt;b16 + 1);</a>
<a name="ln543">	mapval = ((uint32)card-&gt;silentpage_phy_base) &lt;&lt; 1 | EMU_CHAN_MAP_PTI_MASK;</a>
<a name="ln544"> </a>
<a name="ln545">	//s = splaudio();</a>
<a name="ln546">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CPF_STEREO, voice-&gt;stereo);</a>
<a name="ln547"> </a>
<a name="ln548">	emuxki_channel_commit_fx(chan);</a>
<a name="ln549"> </a>
<a name="ln550">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CCCA,</a>
<a name="ln551">		      (chan-&gt;filter.lowpass_resonance_height &lt;&lt; 28) |</a>
<a name="ln552">		      (chan-&gt;filter.interpolation_ROM &lt;&lt; 25) |</a>
<a name="ln553">		   (voice-&gt;b16 ? 0 : EMU_CHAN_CCCA_8BITSELECT) | start);</a>
<a name="ln554">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_Z1, 0);</a>
<a name="ln555">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_Z2, 0);</a>
<a name="ln556">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_MAPA, mapval);</a>
<a name="ln557">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_MAPB, mapval);</a>
<a name="ln558">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CVCF_CURRFILTER,</a>
<a name="ln559">		      chan-&gt;filter.current_cutoff_frequency);</a>
<a name="ln560">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_VTFT_FILTERTARGET,</a>
<a name="ln561">		      chan-&gt;filter.target_cutoff_frequency);</a>
<a name="ln562">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_ATKHLDM,</a>
<a name="ln563">		      (chan-&gt;modulation.envelope.hold_time &lt;&lt; 8) |</a>
<a name="ln564">		      chan-&gt;modulation.envelope.attack_time);</a>
<a name="ln565">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_DCYSUSM,</a>
<a name="ln566">		      (chan-&gt;modulation.envelope.sustain_level &lt;&lt; 8) |</a>
<a name="ln567">		      chan-&gt;modulation.envelope.decay_time);</a>
<a name="ln568">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_LFOVAL1,</a>
<a name="ln569">		      chan-&gt;modulation.LFO_state);</a>
<a name="ln570">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_LFOVAL2,</a>
<a name="ln571">		      chan-&gt;vibrato_LFO.state);</a>
<a name="ln572">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_FMMOD,</a>
<a name="ln573">		      (chan-&gt;vibrato_LFO.modulation_depth &lt;&lt; 8) |</a>
<a name="ln574">		      chan-&gt;filter.LFO_modulation_depth);</a>
<a name="ln575">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_TREMFRQ,</a>
<a name="ln576">		      (chan-&gt;tremolo_depth &lt;&lt; 8));</a>
<a name="ln577">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_FM2FRQ2,</a>
<a name="ln578">		      (chan-&gt;vibrato_LFO.vibrato_depth &lt;&lt; 8) |</a>
<a name="ln579">		      chan-&gt;vibrato_LFO.frequency);</a>
<a name="ln580">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_ENVVAL,</a>
<a name="ln581">		      chan-&gt;modulation.envelope.current_state);</a>
<a name="ln582">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_ATKHLDV,</a>
<a name="ln583">		      (chan-&gt;volume.envelope.hold_time &lt;&lt; 8) |</a>
<a name="ln584">		      chan-&gt;volume.envelope.attack_time);</a>
<a name="ln585">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_ENVVOL,</a>
<a name="ln586">		      chan-&gt;volume.envelope.current_state);</a>
<a name="ln587">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_PEFE,</a>
<a name="ln588">		      (chan-&gt;pitch.envelope_amount &lt;&lt; 8) |</a>
<a name="ln589">		      chan-&gt;filter.envelope_amount);</a>
<a name="ln590">	//splx(s);</a>
<a name="ln591">}</a>
<a name="ln592"> </a>
<a name="ln593"> </a>
<a name="ln594">static void</a>
<a name="ln595">emuxki_channel_start(emuxki_channel *chan)</a>
<a name="ln596">{</a>
<a name="ln597">	emuxki_voice *voice = chan-&gt;voice;</a>
<a name="ln598">	emuxki_dev   *card = chan-&gt;voice-&gt;stream-&gt;card;</a>
<a name="ln599">	uint8        cache_sample, cache_invalid_size, chano = chan-&gt;num;</a>
<a name="ln600">	uint32       sample;</a>
<a name="ln601">	//int             s;</a>
<a name="ln602"> </a>
<a name="ln603">	cache_sample = voice-&gt;stereo ? 4 : 2;</a>
<a name="ln604">	sample = voice-&gt;b16 ? 0x00000000 : 0x80808080;</a>
<a name="ln605">	cache_invalid_size = (voice-&gt;stereo ? 28 : 30) * (voice-&gt;b16 + 1);</a>
<a name="ln606"> </a>
<a name="ln607">	//s = splaudio();</a>
<a name="ln608">	while (cache_sample--)</a>
<a name="ln609">		emuxki_chan_write(&amp;card-&gt;config, chano,</a>
<a name="ln610">			      EMU_CHAN_CD0 + cache_sample, sample);</a>
<a name="ln611">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CCR_CACHEINVALIDSIZE, 0);</a>
<a name="ln612">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CCR_READADDRESS, 64);</a>
<a name="ln613">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CCR_CACHEINVALIDSIZE,</a>
<a name="ln614">		      cache_invalid_size);</a>
<a name="ln615">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_IFATN,</a>
<a name="ln616">		      (chan-&gt;filter.target_cutoff_frequency &lt;&lt; 8) |</a>
<a name="ln617">		      chan-&gt;initial_attenuation);</a>
<a name="ln618">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_VTFT_VOLUMETARGET,</a>
<a name="ln619">		      chan-&gt;volume.target);</a>
<a name="ln620">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CVCF_CURRVOL,</a>
<a name="ln621">		      chan-&gt;volume.current);</a>
<a name="ln622">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_MKSUBREG(1, chano,</a>
<a name="ln623">					       EMU_SOLEL + (chano &gt;&gt; 5)),</a>
<a name="ln624">		      0);	/* Clear stop on loop */</a>
<a name="ln625">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_MKSUBREG(1, chano,</a>
<a name="ln626">					       EMU_CLIEL + (chano &gt;&gt; 5)),</a>
<a name="ln627">		      0);	/* Clear loop interrupt */</a>
<a name="ln628">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_DCYSUSV,</a>
<a name="ln629">		      (chan-&gt;volume.envelope.sustain_level &lt;&lt; 8) |</a>
<a name="ln630">		      chan-&gt;volume.envelope.decay_time);</a>
<a name="ln631">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_PTRX_PITCHTARGET,</a>
<a name="ln632">		      chan-&gt;pitch.target);</a>
<a name="ln633">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CPF_PITCH,</a>
<a name="ln634">		      chan-&gt;pitch.current);</a>
<a name="ln635">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_IP, chan-&gt;pitch.intial);</a>
<a name="ln636"> </a>
<a name="ln637">	//splx(s);</a>
<a name="ln638">}</a>
<a name="ln639"> </a>
<a name="ln640"> </a>
<a name="ln641">static void</a>
<a name="ln642">emuxki_channel_stop(emuxki_channel *chan)</a>
<a name="ln643">{</a>
<a name="ln644">	emuxki_dev   	*card = chan-&gt;voice-&gt;stream-&gt;card;</a>
<a name="ln645">	//int             s;</a>
<a name="ln646">	uint8           chano = chan-&gt;num;</a>
<a name="ln647"> </a>
<a name="ln648">	//s = splaudio();</a>
<a name="ln649"> </a>
<a name="ln650">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_PTRX_PITCHTARGET, 0);</a>
<a name="ln651">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CPF_PITCH, 0);</a>
<a name="ln652">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_IFATN_ATTENUATION, 0xff);</a>
<a name="ln653">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_VTFT_VOLUMETARGET, 0);</a>
<a name="ln654">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_CVCF_CURRVOL, 0);</a>
<a name="ln655">	emuxki_chan_write(&amp;card-&gt;config, chano, EMU_CHAN_IP, 0);</a>
<a name="ln656"> </a>
<a name="ln657">	//splx(s);</a>
<a name="ln658">}</a>
<a name="ln659"> </a>
<a name="ln660"> </a>
<a name="ln661">/*	Emuxki voice functions */</a>
<a name="ln662">/*static void</a>
<a name="ln663">emuxki_dump_voice(emuxki_voice *voice)</a>
<a name="ln664">{</a>
<a name="ln665">	LOG((&quot;voice-&gt;use = %#u\n&quot;, voice-&gt;use));</a>
<a name="ln666">	LOG((&quot;voice-&gt;state = %#u\n&quot;, voice-&gt;state));</a>
<a name="ln667">	LOG((&quot;voice-&gt;stereo = %#u\n&quot;, voice-&gt;stereo));</a>
<a name="ln668">	LOG((&quot;voice-&gt;b16 = %#u\n&quot;, voice-&gt;b16));</a>
<a name="ln669">	LOG((&quot;voice-&gt;sample_rate = %#lu\n&quot;, voice-&gt;sample_rate));</a>
<a name="ln670">	LOG((&quot;voice-&gt;buffer = %#08x\n&quot;, voice-&gt;buffer));</a>
<a name="ln671">	if (voice-&gt;buffer) {</a>
<a name="ln672">		LOG((&quot;voice-&gt;buffer-&gt;ptbidx = %#u\n&quot;, voice-&gt;buffer-&gt;ptbidx));</a>
<a name="ln673">		LOG((&quot;voice-&gt;buffer-&gt;log_base = %#08x\n&quot;, voice-&gt;buffer-&gt;log_base));</a>
<a name="ln674">		LOG((&quot;voice-&gt;buffer-&gt;phy_base = %#08x\n&quot;, voice-&gt;buffer-&gt;phy_base));</a>
<a name="ln675">		LOG((&quot;voice-&gt;buffer-&gt;size = %#08x\n&quot;, voice-&gt;buffer-&gt;size));</a>
<a name="ln676">		LOG((&quot;voice-&gt;buffer-&gt;area = %#08x\n&quot;, voice-&gt;buffer-&gt;area));</a>
<a name="ln677">	}</a>
<a name="ln678">	LOG((&quot;voice-&gt;blksize = %#u\n&quot;, voice-&gt;blksize));</a>
<a name="ln679">	LOG((&quot;voice-&gt;trigblk = %#u\n&quot;, voice-&gt;trigblk));</a>
<a name="ln680">	LOG((&quot;voice-&gt;blkmod = %#u\n&quot;, voice-&gt;blkmod));</a>
<a name="ln681">	LOG((&quot;voice-&gt;timerate = %#u\n&quot;, voice-&gt;timerate));</a>
<a name="ln682">}*/</a>
<a name="ln683"> </a>
<a name="ln684"> </a>
<a name="ln685">/* Allocate channels for voice in case of play voice */</a>
<a name="ln686">static status_t</a>
<a name="ln687">emuxki_voice_channel_create(emuxki_voice *voice)</a>
<a name="ln688">{</a>
<a name="ln689">	emuxki_channel **channel = voice-&gt;stream-&gt;card-&gt;channel;</a>
<a name="ln690">	uint8	        i, stereo = voice-&gt;stereo;</a>
<a name="ln691">	//int             s;</a>
<a name="ln692"> </a>
<a name="ln693">	for (i = 0; i &lt; EMU_NUMCHAN - stereo; i += stereo + 1) {</a>
<a name="ln694">		if ((stereo &amp;&amp; (channel[i + 1] != NULL)) ||</a>
<a name="ln695">		    (channel[i] != NULL))	/* Looking for free channels */</a>
<a name="ln696">			continue;</a>
<a name="ln697">		//s = splaudio();</a>
<a name="ln698">		if (stereo) {</a>
<a name="ln699">			voice-&gt;dataloc.chan[1] =</a>
<a name="ln700">				emuxki_channel_new(voice, i + 1);</a>
<a name="ln701">			if (voice-&gt;dataloc.chan[1] == NULL) {</a>
<a name="ln702">				//splx(s);</a>
<a name="ln703">				return ENOMEM;</a>
<a name="ln704">			}</a>
<a name="ln705">		}</a>
<a name="ln706">		voice-&gt;dataloc.chan[0] = emuxki_channel_new(voice, i);</a>
<a name="ln707">		if (voice-&gt;dataloc.chan[0] == NULL) {</a>
<a name="ln708">			if (stereo) {</a>
<a name="ln709">				emuxki_channel_delete(voice-&gt;dataloc.chan[1]);</a>
<a name="ln710">				voice-&gt;dataloc.chan[1] = NULL;</a>
<a name="ln711">			}</a>
<a name="ln712">			//splx(s);</a>
<a name="ln713">			return ENOMEM;</a>
<a name="ln714">		}</a>
<a name="ln715">		//splx(s);</a>
<a name="ln716">		return B_OK;</a>
<a name="ln717">	}</a>
<a name="ln718">	return EAGAIN;</a>
<a name="ln719">}</a>
<a name="ln720"> </a>
<a name="ln721"> </a>
<a name="ln722">/* When calling this function we assume no one can access the voice */</a>
<a name="ln723">static void</a>
<a name="ln724">emuxki_voice_channel_destroy(emuxki_voice *voice)</a>
<a name="ln725">{</a>
<a name="ln726">	emuxki_channel_delete(voice-&gt;dataloc.chan[0]);</a>
<a name="ln727">	voice-&gt;dataloc.chan[0] = NULL;</a>
<a name="ln728">	if (voice-&gt;stereo)</a>
<a name="ln729">		emuxki_channel_delete(voice-&gt;dataloc.chan[1]);</a>
<a name="ln730">	voice-&gt;dataloc.chan[1] = NULL;</a>
<a name="ln731">}</a>
<a name="ln732"> </a>
<a name="ln733"> </a>
<a name="ln734">static status_t</a>
<a name="ln735">emuxki_voice_dataloc_create(emuxki_voice *voice)</a>
<a name="ln736">{</a>
<a name="ln737">	status_t	error;</a>
<a name="ln738"> </a>
<a name="ln739">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln740">		if ((error = emuxki_voice_channel_create(voice)))</a>
<a name="ln741">			return (error);</a>
<a name="ln742">	} else {</a>
<a name="ln743"> </a>
<a name="ln744">	}</a>
<a name="ln745">	return B_OK;</a>
<a name="ln746">}</a>
<a name="ln747"> </a>
<a name="ln748"> </a>
<a name="ln749">static void</a>
<a name="ln750">emuxki_voice_dataloc_destroy(emuxki_voice *voice)</a>
<a name="ln751">{</a>
<a name="ln752">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln753">		if (voice-&gt;dataloc.chan[0] != NULL)</a>
<a name="ln754">			emuxki_voice_channel_destroy(voice);</a>
<a name="ln755">	} else {</a>
<a name="ln756">		uint32 buffaddr_reg, buffsize_reg;</a>
<a name="ln757">		switch (voice-&gt;dataloc.source) {</a>
<a name="ln758">			case EMU_RECSRC_MIC:</a>
<a name="ln759">				buffaddr_reg = EMU_MICBA;</a>
<a name="ln760">				buffsize_reg = EMU_MICBS;</a>
<a name="ln761">				break;</a>
<a name="ln762">			case EMU_RECSRC_ADC:</a>
<a name="ln763">				buffaddr_reg = EMU_ADCBA;</a>
<a name="ln764">				buffsize_reg = EMU_ADCBS;</a>
<a name="ln765">				break;</a>
<a name="ln766">			case EMU_RECSRC_FX:</a>
<a name="ln767">				buffaddr_reg = EMU_FXBA;</a>
<a name="ln768">				buffsize_reg = EMU_FXBS;</a>
<a name="ln769">				break;</a>
<a name="ln770">			default:</a>
<a name="ln771">				return;</a>
<a name="ln772">		}</a>
<a name="ln773">		emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, buffaddr_reg, 0);</a>
<a name="ln774">		emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, buffsize_reg,</a>
<a name="ln775">			EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln776">	}</a>
<a name="ln777">}</a>
<a name="ln778"> </a>
<a name="ln779"> </a>
<a name="ln780">static void</a>
<a name="ln781">emuxki_voice_fxupdate(emuxki_voice *voice)</a>
<a name="ln782">{</a>
<a name="ln783">	emuxki_chanparms_fxsend fxsend;</a>
<a name="ln784"> </a>
<a name="ln785">	uint8 maxlevel =</a>
<a name="ln786">		IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config) ? 0xc0 : 0xff;	/* not max */</a>
<a name="ln787"> </a>
<a name="ln788">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln789">		fxsend.a.dest = 0x3f;</a>
<a name="ln790">		fxsend.b.dest = 0x3f;</a>
<a name="ln791">		fxsend.c.dest = 0x3f;</a>
<a name="ln792">		fxsend.d.dest = 0x3f;</a>
<a name="ln793">		/* for audigy */</a>
<a name="ln794">		fxsend.e.dest = 0x3f;</a>
<a name="ln795">		fxsend.f.dest = 0x3f;</a>
<a name="ln796">		fxsend.g.dest = 0x3f;</a>
<a name="ln797">		fxsend.h.dest = 0x3f;</a>
<a name="ln798"> </a>
<a name="ln799">		fxsend.a.level = fxsend.b.level = fxsend.c.level = fxsend.d.level =</a>
<a name="ln800">		fxsend.e.level = fxsend.g.level = fxsend.f.level = fxsend.h.level = 0x00;</a>
<a name="ln801"> </a>
<a name="ln802">		if (voice-&gt;stereo) {</a>
<a name="ln803">			switch(voice-&gt;stream-&gt;card-&gt;play_mode) {</a>
<a name="ln804">				case 2:</a>
<a name="ln805">					if (voice-&gt;stream-&gt;nstereo == 1) {</a>
<a name="ln806">						fxsend.a.dest = voice-&gt;voicenum * 2;</a>
<a name="ln807">						fxsend.a.level = maxlevel;</a>
<a name="ln808">					} else if ((voice-&gt;stream-&gt;nstereo == 2) ||</a>
<a name="ln809">						((voice-&gt;stream-&gt;nstereo == 3)&amp;&amp;(voice-&gt;voicenum &lt; 2))) {</a>
<a name="ln810">						fxsend.a.dest = voice-&gt;voicenum * 2;</a>
<a name="ln811">						fxsend.a.level = maxlevel;</a>
<a name="ln812">						if (voice-&gt;voicenum &gt; 1 - 1)</a>
<a name="ln813">							fxsend.a.dest-=2;</a>
<a name="ln814">					} else if (voice-&gt;stream-&gt;nstereo == 3 &amp;&amp; voice-&gt;voicenum &gt; 1) {</a>
<a name="ln815">							fxsend.a.dest = 0x0;</a>
<a name="ln816">							fxsend.a.level = maxlevel / 2;</a>
<a name="ln817">							fxsend.b.dest = 0x1;</a>
<a name="ln818">							fxsend.b.level = maxlevel / 2;</a>
<a name="ln819">					} else {</a>
<a name="ln820">						LOG((&quot;emuxki_voice_set_stereo case 2 badly managed\n&quot;));</a>
<a name="ln821">					}</a>
<a name="ln822">					break;</a>
<a name="ln823">				case 4:</a>
<a name="ln824">					if (voice-&gt;stream-&gt;nstereo == 1) {</a>
<a name="ln825">						fxsend.a.dest = voice-&gt;voicenum * 2;</a>
<a name="ln826">						fxsend.a.level = maxlevel;</a>
<a name="ln827">						fxsend.b.dest = voice-&gt;voicenum * 2 + 2;</a>
<a name="ln828">						fxsend.b.level = maxlevel;</a>
<a name="ln829">					} else if ((voice-&gt;stream-&gt;nstereo == 2) ||</a>
<a name="ln830">						((voice-&gt;stream-&gt;nstereo == 3)&amp;&amp;(voice-&gt;voicenum &lt; 2))) {</a>
<a name="ln831">						fxsend.a.dest = voice-&gt;voicenum * 2;</a>
<a name="ln832">						fxsend.a.level = maxlevel;</a>
<a name="ln833">					} else if (voice-&gt;stream-&gt;nstereo == 3 &amp;&amp; voice-&gt;voicenum &gt; 1) {</a>
<a name="ln834">						fxsend.a.dest = 0x0;</a>
<a name="ln835">						fxsend.a.level = maxlevel / 2;</a>
<a name="ln836">						fxsend.b.dest = 0x1;</a>
<a name="ln837">						fxsend.b.level = maxlevel / 2;</a>
<a name="ln838">					} else {</a>
<a name="ln839">						LOG((&quot;emuxki_voice_set_stereo case 4 badly managed\n&quot;));</a>
<a name="ln840">					}</a>
<a name="ln841">					break;</a>
<a name="ln842">				case 6: // only on audigy</a>
<a name="ln843">					if (voice-&gt;stream-&gt;nstereo == 1) {</a>
<a name="ln844">						fxsend.a.dest = voice-&gt;voicenum * 2;</a>
<a name="ln845">						fxsend.a.level = maxlevel;</a>
<a name="ln846">						fxsend.b.dest = voice-&gt;voicenum * 2 + 2;</a>
<a name="ln847">						fxsend.b.level = maxlevel;</a>
<a name="ln848">						fxsend.c.dest = 0x4;</a>
<a name="ln849">						fxsend.c.level = maxlevel / 2;</a>
<a name="ln850">						fxsend.d.dest = 0x5;</a>
<a name="ln851">						fxsend.d.level = maxlevel / 2;</a>
<a name="ln852">					} else if (voice-&gt;stream-&gt;nstereo == 2) {</a>
<a name="ln853">						fxsend.a.dest = voice-&gt;voicenum * 2;</a>
<a name="ln854">						fxsend.a.level = maxlevel;</a>
<a name="ln855">						if (voice-&gt;voicenum &lt; 1) {</a>
<a name="ln856">							fxsend.b.dest = 0x4;</a>
<a name="ln857">							fxsend.b.level = maxlevel / 2;</a>
<a name="ln858">							fxsend.c.dest = 0x5;</a>
<a name="ln859">							fxsend.c.level = maxlevel / 2;</a>
<a name="ln860">						}</a>
<a name="ln861">					} else if (voice-&gt;stream-&gt;nstereo == 3) {</a>
<a name="ln862">						fxsend.a.dest = voice-&gt;voicenum * 2;</a>
<a name="ln863">						fxsend.a.level = maxlevel;</a>
<a name="ln864">					} else {</a>
<a name="ln865">						LOG((&quot;emuxki_voice_set_stereo case 6 badly managed\n&quot;));</a>
<a name="ln866">					}</a>
<a name="ln867">					break;</a>
<a name="ln868">			}</a>
<a name="ln869"> </a>
<a name="ln870">			emuxki_channel_set_fxsend(voice-&gt;dataloc.chan[0],</a>
<a name="ln871">						   &amp;fxsend);</a>
<a name="ln872"> </a>
<a name="ln873">			switch(voice-&gt;stream-&gt;card-&gt;play_mode) {</a>
<a name="ln874">				case 2:</a>
<a name="ln875">					if (voice-&gt;stream-&gt;nstereo == 1) {</a>
<a name="ln876">						fxsend.a.dest = voice-&gt;voicenum * 2 + 1;</a>
<a name="ln877">						fxsend.a.level = maxlevel;</a>
<a name="ln878">					} else if ((voice-&gt;stream-&gt;nstereo == 2) ||</a>
<a name="ln879">						((voice-&gt;stream-&gt;nstereo == 3)&amp;&amp;(voice-&gt;voicenum &lt; 2))) {</a>
<a name="ln880">						fxsend.a.dest = voice-&gt;voicenum * 2 + 1;</a>
<a name="ln881">						fxsend.a.level = maxlevel;</a>
<a name="ln882">						if (voice-&gt;voicenum &gt; 1 - 1)</a>
<a name="ln883">							fxsend.a.dest-=2;</a>
<a name="ln884">					} else if (voice-&gt;stream-&gt;nstereo == 3 &amp;&amp; voice-&gt;voicenum &gt; 1) {</a>
<a name="ln885">							fxsend.a.dest = 0x0;</a>
<a name="ln886">							fxsend.a.level = maxlevel / 2;</a>
<a name="ln887">							fxsend.b.dest = 0x1;</a>
<a name="ln888">							fxsend.b.level = maxlevel / 2;</a>
<a name="ln889">					} else {</a>
<a name="ln890">						LOG((&quot;emuxki_voice_set_stereo case 2 badly managed\n&quot;));</a>
<a name="ln891">					}</a>
<a name="ln892">					break;</a>
<a name="ln893">				case 4:</a>
<a name="ln894">					if (voice-&gt;stream-&gt;nstereo == 1) {</a>
<a name="ln895">						fxsend.a.dest = voice-&gt;voicenum * 2 + 1;</a>
<a name="ln896">						fxsend.a.level = maxlevel;</a>
<a name="ln897">						fxsend.b.dest = voice-&gt;voicenum * 2 + 3;</a>
<a name="ln898">						fxsend.b.level = maxlevel;</a>
<a name="ln899">					} else if ((voice-&gt;stream-&gt;nstereo == 2) ||</a>
<a name="ln900">						((voice-&gt;stream-&gt;nstereo == 3)&amp;&amp;(voice-&gt;voicenum &lt; 2))) {</a>
<a name="ln901">						fxsend.a.dest = voice-&gt;voicenum * 2 + 1;</a>
<a name="ln902">						fxsend.a.level = maxlevel;</a>
<a name="ln903">					} else if (voice-&gt;stream-&gt;nstereo == 3 &amp;&amp; voice-&gt;voicenum &gt; 1) {</a>
<a name="ln904">						fxsend.a.dest = 0x0;</a>
<a name="ln905">						fxsend.a.level = maxlevel / 2;</a>
<a name="ln906">						fxsend.b.dest = 0x1;</a>
<a name="ln907">						fxsend.b.level = maxlevel / 2;</a>
<a name="ln908">					} else {</a>
<a name="ln909">						LOG((&quot;emuxki_voice_set_stereo case 4 badly managed\n&quot;));</a>
<a name="ln910">					}</a>
<a name="ln911">					break;</a>
<a name="ln912">				case 6: // only on audigy</a>
<a name="ln913">					if (voice-&gt;stream-&gt;nstereo == 1) {</a>
<a name="ln914">						fxsend.a.dest = voice-&gt;voicenum * 2 + 1;</a>
<a name="ln915">						fxsend.a.level = maxlevel;</a>
<a name="ln916">						fxsend.b.dest = voice-&gt;voicenum * 2 + 3;</a>
<a name="ln917">						fxsend.b.level = maxlevel;</a>
<a name="ln918">						fxsend.c.dest = 0x4;</a>
<a name="ln919">						fxsend.c.level = maxlevel / 2;</a>
<a name="ln920">						fxsend.d.dest = 0x5;</a>
<a name="ln921">						fxsend.d.level = maxlevel / 2;</a>
<a name="ln922">					} else if (voice-&gt;stream-&gt;nstereo == 2) {</a>
<a name="ln923">						fxsend.a.dest = voice-&gt;voicenum * 2 + 1;</a>
<a name="ln924">						fxsend.a.level = maxlevel;</a>
<a name="ln925">						if (voice-&gt;voicenum &lt; 1) {</a>
<a name="ln926">							fxsend.b.dest = 0x4;</a>
<a name="ln927">							fxsend.b.level = maxlevel / 2;</a>
<a name="ln928">							fxsend.c.dest = 0x5;</a>
<a name="ln929">							fxsend.c.level = maxlevel / 2;</a>
<a name="ln930">						}</a>
<a name="ln931">					} else if (voice-&gt;stream-&gt;nstereo == 3) {</a>
<a name="ln932">						fxsend.a.dest = voice-&gt;voicenum * 2 + 1;</a>
<a name="ln933">						fxsend.a.level = maxlevel;</a>
<a name="ln934">					} else {</a>
<a name="ln935">						LOG((&quot;emuxki_voice_set_stereo case 6 badly managed\n&quot;));</a>
<a name="ln936">					}</a>
<a name="ln937">					break;</a>
<a name="ln938">			}</a>
<a name="ln939"> </a>
<a name="ln940">			emuxki_channel_set_fxsend(voice-&gt;dataloc.chan[1],</a>
<a name="ln941">						   &amp;fxsend);</a>
<a name="ln942">		} else {</a>
<a name="ln943">			switch(voice-&gt;stream-&gt;card-&gt;play_mode) {</a>
<a name="ln944">				case 2:</a>
<a name="ln945">					if (voice-&gt;stream-&gt;nmono == 1) {</a>
<a name="ln946">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln947">						fxsend.a.level = maxlevel;</a>
<a name="ln948">						fxsend.b.dest = voice-&gt;voicenum + 1;</a>
<a name="ln949">						fxsend.b.level = maxlevel;</a>
<a name="ln950">					} else if (voice-&gt;stream-&gt;nmono == 2) {</a>
<a name="ln951">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln952">						fxsend.a.level = maxlevel;</a>
<a name="ln953">					} else if ((voice-&gt;stream-&gt;nmono == 4) ||</a>
<a name="ln954">						((voice-&gt;stream-&gt;nmono == 6)&amp;&amp;(voice-&gt;voicenum &lt; 4))) {</a>
<a name="ln955">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln956">						fxsend.a.level = maxlevel;</a>
<a name="ln957">						if (voice-&gt;voicenum &gt; 2 - 1)</a>
<a name="ln958">							fxsend.a.dest-=2;</a>
<a name="ln959">					} else if (voice-&gt;stream-&gt;nmono == 6 &amp;&amp; voice-&gt;voicenum &gt; 3) {</a>
<a name="ln960">							fxsend.a.dest = 0x0;</a>
<a name="ln961">							fxsend.a.level = maxlevel / 2;</a>
<a name="ln962">							fxsend.b.dest = 0x1;</a>
<a name="ln963">							fxsend.b.level = maxlevel / 2;</a>
<a name="ln964">					} else {</a>
<a name="ln965">						LOG((&quot;emuxki_voice_set_stereo case 2 badly managed\n&quot;));</a>
<a name="ln966">					}</a>
<a name="ln967">					break;</a>
<a name="ln968">				case 4:</a>
<a name="ln969">					if (voice-&gt;stream-&gt;nmono == 1) {</a>
<a name="ln970">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln971">						fxsend.a.level = maxlevel;</a>
<a name="ln972">						fxsend.b.dest = voice-&gt;voicenum + 1;</a>
<a name="ln973">						fxsend.b.level = maxlevel;</a>
<a name="ln974">						fxsend.c.dest = voice-&gt;voicenum + 2;</a>
<a name="ln975">						fxsend.c.level = maxlevel;</a>
<a name="ln976">						fxsend.d.dest = voice-&gt;voicenum + 3;</a>
<a name="ln977">						fxsend.d.level = maxlevel;</a>
<a name="ln978">					} else if (voice-&gt;stream-&gt;nmono == 2) {</a>
<a name="ln979">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln980">						fxsend.a.level = maxlevel;</a>
<a name="ln981">						fxsend.b.dest = voice-&gt;voicenum + 2;</a>
<a name="ln982">						fxsend.b.level = maxlevel;</a>
<a name="ln983">					} else if ((voice-&gt;stream-&gt;nmono == 4) ||</a>
<a name="ln984">						((voice-&gt;stream-&gt;nmono == 6)&amp;&amp;(voice-&gt;voicenum &lt; 4))) {</a>
<a name="ln985">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln986">						fxsend.a.level = maxlevel;</a>
<a name="ln987">					} else if (voice-&gt;stream-&gt;nmono == 6 &amp;&amp; voice-&gt;voicenum &gt; 3) {</a>
<a name="ln988">							fxsend.a.dest = 0x0;</a>
<a name="ln989">							fxsend.a.level = maxlevel / 2;</a>
<a name="ln990">							fxsend.b.dest = 0x1;</a>
<a name="ln991">							fxsend.b.level = maxlevel / 2;</a>
<a name="ln992">					} else {</a>
<a name="ln993">						LOG((&quot;emuxki_voice_set_stereo case 4 badly managed\n&quot;));</a>
<a name="ln994">					}</a>
<a name="ln995">					break;</a>
<a name="ln996">				case 6: // only on audigy</a>
<a name="ln997">					if (voice-&gt;stream-&gt;nmono == 1) {</a>
<a name="ln998">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln999">						fxsend.a.level = maxlevel;</a>
<a name="ln1000">						fxsend.b.dest = voice-&gt;voicenum + 1;</a>
<a name="ln1001">						fxsend.b.level = maxlevel;</a>
<a name="ln1002">						fxsend.c.dest = voice-&gt;voicenum + 2;</a>
<a name="ln1003">						fxsend.c.level = maxlevel;</a>
<a name="ln1004">						fxsend.d.dest = voice-&gt;voicenum + 3;</a>
<a name="ln1005">						fxsend.d.level = maxlevel;</a>
<a name="ln1006">						fxsend.e.dest = voice-&gt;voicenum + 4;</a>
<a name="ln1007">						fxsend.e.level = maxlevel;</a>
<a name="ln1008">						fxsend.f.dest = voice-&gt;voicenum + 5;</a>
<a name="ln1009">						fxsend.f.level = maxlevel;</a>
<a name="ln1010">					} else if (voice-&gt;stream-&gt;nmono == 2) {</a>
<a name="ln1011">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln1012">						fxsend.a.level = maxlevel;</a>
<a name="ln1013">						fxsend.b.dest = voice-&gt;voicenum + 2;</a>
<a name="ln1014">						fxsend.b.level = maxlevel;</a>
<a name="ln1015">						fxsend.c.dest = 0x4;</a>
<a name="ln1016">						fxsend.c.level = maxlevel / 2;</a>
<a name="ln1017">						fxsend.d.dest = 0x5;</a>
<a name="ln1018">						fxsend.d.level = maxlevel / 2;</a>
<a name="ln1019">					} else if (voice-&gt;stream-&gt;nmono == 4) {</a>
<a name="ln1020">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln1021">						fxsend.a.level = maxlevel;</a>
<a name="ln1022">						if (voice-&gt;voicenum &lt; 2) {</a>
<a name="ln1023">							fxsend.b.dest = 0x4;</a>
<a name="ln1024">							fxsend.b.level = maxlevel / 2;</a>
<a name="ln1025">							fxsend.c.dest = 0x5;</a>
<a name="ln1026">							fxsend.c.level = maxlevel / 2;</a>
<a name="ln1027">						}</a>
<a name="ln1028">					} else if (voice-&gt;stream-&gt;nmono == 6) {</a>
<a name="ln1029">						fxsend.a.dest = voice-&gt;voicenum;</a>
<a name="ln1030">						fxsend.a.level = maxlevel;</a>
<a name="ln1031">					} else {</a>
<a name="ln1032">						LOG((&quot;emuxki_voice_set_stereo case 6 badly managed\n&quot;));</a>
<a name="ln1033">					}</a>
<a name="ln1034">					break;</a>
<a name="ln1035">			}</a>
<a name="ln1036"> </a>
<a name="ln1037">			emuxki_channel_set_fxsend(voice-&gt;dataloc.chan[0],</a>
<a name="ln1038">						   &amp;fxsend);</a>
<a name="ln1039">		}</a>
<a name="ln1040">	}</a>
<a name="ln1041">}</a>
<a name="ln1042"> </a>
<a name="ln1043"> </a>
<a name="ln1044">static status_t</a>
<a name="ln1045">emuxki_voice_set_stereo(emuxki_voice *voice, uint8 stereo)</a>
<a name="ln1046">{</a>
<a name="ln1047">	status_t	error;</a>
<a name="ln1048"> </a>
<a name="ln1049">	emuxki_voice_dataloc_destroy(voice);</a>
<a name="ln1050">	voice-&gt;stereo = stereo;</a>
<a name="ln1051">	if ((error = emuxki_voice_dataloc_create(voice)))</a>
<a name="ln1052">	  return error;</a>
<a name="ln1053">	emuxki_voice_fxupdate(voice);</a>
<a name="ln1054">	return B_OK;</a>
<a name="ln1055">}</a>
<a name="ln1056"> </a>
<a name="ln1057"> </a>
<a name="ln1058">static status_t</a>
<a name="ln1059">emuxki_voice_set_srate(emuxki_voice *voice, uint32 srate)</a>
<a name="ln1060">{</a>
<a name="ln1061">	voice-&gt;sample_rate = srate;</a>
<a name="ln1062">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln1063">		if ((srate &lt; 4000) || (srate &gt; 48000))</a>
<a name="ln1064">			return (EINVAL);</a>
<a name="ln1065">		emuxki_channel_set_srate(voice-&gt;dataloc.chan[0], srate);</a>
<a name="ln1066">		if (voice-&gt;stereo)</a>
<a name="ln1067">			emuxki_channel_set_srate(voice-&gt;dataloc.chan[1],</a>
<a name="ln1068">						  srate);</a>
<a name="ln1069">	}</a>
<a name="ln1070">	return B_OK;</a>
<a name="ln1071">}</a>
<a name="ln1072"> </a>
<a name="ln1073"> </a>
<a name="ln1074">status_t</a>
<a name="ln1075">emuxki_voice_set_audioparms(emuxki_voice *voice, uint8 stereo,</a>
<a name="ln1076">			     uint8 b16, uint32 srate)</a>
<a name="ln1077">{</a>
<a name="ln1078">	status_t             error;</a>
<a name="ln1079"> </a>
<a name="ln1080">	if (voice-&gt;stereo == stereo &amp;&amp; voice-&gt;b16 == b16 &amp;&amp;</a>
<a name="ln1081">	    voice-&gt;sample_rate == srate)</a>
<a name="ln1082">		return B_OK;</a>
<a name="ln1083"> </a>
<a name="ln1084">	if (voice-&gt;stereo != stereo) {</a>
<a name="ln1085">		if ((error = emuxki_voice_set_stereo(voice, stereo)))</a>
<a name="ln1086">			return error;</a>
<a name="ln1087">	}</a>
<a name="ln1088">	voice-&gt;b16 = b16;</a>
<a name="ln1089">	if (voice-&gt;sample_rate != srate)</a>
<a name="ln1090">		emuxki_voice_set_srate(voice, srate);</a>
<a name="ln1091">	return B_OK;</a>
<a name="ln1092">}</a>
<a name="ln1093"> </a>
<a name="ln1094"> </a>
<a name="ln1095">status_t</a>
<a name="ln1096">emuxki_voice_set_recparms(emuxki_voice *voice, emuxki_recsrc_t recsrc,</a>
<a name="ln1097">			     	emuxki_recparams *recparams)</a>
<a name="ln1098">{</a>
<a name="ln1099">	if (voice-&gt;use &amp; EMU_USE_RECORD) {</a>
<a name="ln1100">		switch(recsrc) {</a>
<a name="ln1101">			case EMU_RECSRC_MIC:</a>
<a name="ln1102">				break;</a>
<a name="ln1103">			case EMU_RECSRC_ADC:</a>
<a name="ln1104">				break;</a>
<a name="ln1105">			case EMU_RECSRC_FX:</a>
<a name="ln1106">				if (!recparams)</a>
<a name="ln1107">					return B_ERROR;</a>
<a name="ln1108">				voice-&gt;recparams.efx_voices[0] = recparams-&gt;efx_voices[0];</a>
<a name="ln1109">				voice-&gt;recparams.efx_voices[1] = recparams-&gt;efx_voices[1];</a>
<a name="ln1110">				break;</a>
<a name="ln1111">			default:</a>
<a name="ln1112">				return B_ERROR;</a>
<a name="ln1113">				break;</a>
<a name="ln1114">		}</a>
<a name="ln1115">		voice-&gt;dataloc.source = recsrc;</a>
<a name="ln1116">	}</a>
<a name="ln1117">	return B_OK;</a>
<a name="ln1118">}</a>
<a name="ln1119"> </a>
<a name="ln1120"> </a>
<a name="ln1121">/* voice audio parms (see just before) must be set prior to this */</a>
<a name="ln1122">status_t</a>
<a name="ln1123">emuxki_voice_set_bufparms(emuxki_voice *voice, void *ptr,</a>
<a name="ln1124">			   uint32 bufsize, uint16 blksize)</a>
<a name="ln1125">{</a>
<a name="ln1126">	emuxki_mem *mem;</a>
<a name="ln1127">	emuxki_channel **chan;</a>
<a name="ln1128">	uint32 start, end;</a>
<a name="ln1129">	uint8 sample_size;</a>
<a name="ln1130">	status_t error = EFAULT;</a>
<a name="ln1131"> </a>
<a name="ln1132">	LIST_FOREACH(mem, &amp;voice-&gt;stream-&gt;card-&gt;mem, next) {</a>
<a name="ln1133">		if (mem-&gt;log_base != ptr)</a>
<a name="ln1134">			continue;</a>
<a name="ln1135"> </a>
<a name="ln1136">		voice-&gt;buffer = mem;</a>
<a name="ln1137">		sample_size = (voice-&gt;b16 + 1) * (voice-&gt;stereo + 1);</a>
<a name="ln1138">		voice-&gt;trigblk = 0;	/* This shouldn't be needed */</a>
<a name="ln1139">		voice-&gt;blkmod = bufsize / blksize;</a>
<a name="ln1140">		if (bufsize % blksize) 	  /* This should not happen */</a>
<a name="ln1141">			voice-&gt;blkmod++;</a>
<a name="ln1142">		error = 0;</a>
<a name="ln1143"> </a>
<a name="ln1144">		if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln1145">			voice-&gt;blksize = blksize / sample_size;</a>
<a name="ln1146">			chan = voice-&gt;dataloc.chan;</a>
<a name="ln1147">			start = (mem-&gt;ptbidx &lt;&lt; 12) / sample_size;</a>
<a name="ln1148">			end = start + bufsize / sample_size;</a>
<a name="ln1149">			emuxki_channel_set_bufparms(chan[0],</a>
<a name="ln1150">						     start, end);</a>
<a name="ln1151">			if (voice-&gt;stereo)</a>
<a name="ln1152">				emuxki_channel_set_bufparms(chan[1],</a>
<a name="ln1153">				     start, end);</a>
<a name="ln1154">			voice-&gt;timerate = (uint32) 48000 *</a>
<a name="ln1155">			                voice-&gt;blksize / voice-&gt;sample_rate / 2;</a>
<a name="ln1156">			if (voice-&gt;timerate &lt; 5)</a>
<a name="ln1157">				error = EINVAL;</a>
<a name="ln1158">		} else {</a>
<a name="ln1159">			voice-&gt;blksize = blksize;</a>
<a name="ln1160">		}</a>
<a name="ln1161"> </a>
<a name="ln1162">		break;</a>
<a name="ln1163">	}</a>
<a name="ln1164"> </a>
<a name="ln1165">	return error;</a>
<a name="ln1166">}</a>
<a name="ln1167"> </a>
<a name="ln1168"> </a>
<a name="ln1169">status_t</a>
<a name="ln1170">emuxki_voice_commit_parms(emuxki_voice *voice)</a>
<a name="ln1171">{</a>
<a name="ln1172">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln1173">		emuxki_channel_commit_parms(voice-&gt;dataloc.chan[0]);</a>
<a name="ln1174">		if (voice-&gt;stereo)</a>
<a name="ln1175">			emuxki_channel_commit_parms(voice-&gt;dataloc.chan[1]);</a>
<a name="ln1176">	} else {</a>
<a name="ln1177">		uint32 buffaddr_reg, buffsize_reg, idx_reg;</a>
<a name="ln1178">		switch (voice-&gt;dataloc.source) {</a>
<a name="ln1179">			case EMU_RECSRC_MIC:</a>
<a name="ln1180">				buffaddr_reg = EMU_MICBA;</a>
<a name="ln1181">				buffsize_reg = EMU_MICBS;</a>
<a name="ln1182">				idx_reg = EMU_MICIDX;</a>
<a name="ln1183">				break;</a>
<a name="ln1184">			case EMU_RECSRC_ADC:</a>
<a name="ln1185">				buffaddr_reg = EMU_ADCBA;</a>
<a name="ln1186">				buffsize_reg = EMU_ADCBS;</a>
<a name="ln1187">				idx_reg = EMU_ADCIDX;</a>
<a name="ln1188">				break;</a>
<a name="ln1189">			case EMU_RECSRC_FX:</a>
<a name="ln1190">				buffaddr_reg = EMU_FXBA;</a>
<a name="ln1191">				buffsize_reg = EMU_FXBS;</a>
<a name="ln1192">				idx_reg = EMU_FXIDX;</a>
<a name="ln1193">				break;</a>
<a name="ln1194">			default:</a>
<a name="ln1195">				return B_ERROR;</a>
<a name="ln1196">		}</a>
<a name="ln1197">		emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, buffaddr_reg, (uint32)voice-&gt;buffer-&gt;phy_base);</a>
<a name="ln1198">		emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, buffsize_reg, EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln1199">		emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, buffsize_reg, EMU_RECBS_BUFSIZE_4096);</a>
<a name="ln1200"> </a>
<a name="ln1201">		LOG((&quot;emuxki_voice_commit_parms idx_reg : %u\n&quot;, idx_reg));</a>
<a name="ln1202"> </a>
<a name="ln1203">		idx_reg = EMU_RECIDX(idx_reg);</a>
<a name="ln1204">		while (emuxki_chan_read(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, idx_reg))</a>
<a name="ln1205">			snooze(5);</a>
<a name="ln1206">	}</a>
<a name="ln1207">	return B_OK;</a>
<a name="ln1208">}</a>
<a name="ln1209"> </a>
<a name="ln1210"> </a>
<a name="ln1211">static uint32</a>
<a name="ln1212">emuxki_voice_curaddr(emuxki_voice *voice)</a>
<a name="ln1213">{</a>
<a name="ln1214">	if (voice-&gt;use &amp; EMU_USE_PLAY)</a>
<a name="ln1215">		return (emuxki_chan_read(&amp;voice-&gt;stream-&gt;card-&gt;config,</a>
<a name="ln1216">				     voice-&gt;dataloc.chan[0]-&gt;num,</a>
<a name="ln1217">				     EMU_CHAN_CCCA_CURRADDR) -</a>
<a name="ln1218">			voice-&gt;dataloc.chan[0]-&gt;loop.start);</a>
<a name="ln1219">	else {</a>
<a name="ln1220">		uint32 idx_reg = 0;</a>
<a name="ln1221">		switch (voice-&gt;dataloc.source) {</a>
<a name="ln1222">			case EMU_RECSRC_MIC:</a>
<a name="ln1223">				idx_reg = IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config) ? EMU_A_MICIDX : EMU_MICIDX;</a>
<a name="ln1224">				break;</a>
<a name="ln1225">			case EMU_RECSRC_ADC:</a>
<a name="ln1226">				idx_reg = IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config) ? EMU_A_ADCIDX : EMU_ADCIDX;</a>
<a name="ln1227">				break;</a>
<a name="ln1228">			case EMU_RECSRC_FX:</a>
<a name="ln1229">				idx_reg = EMU_FXIDX;</a>
<a name="ln1230">				break;</a>
<a name="ln1231">			default:</a>
<a name="ln1232">				TRACE((&quot;emuxki_voice_curaddr : BUG!!\n&quot;));</a>
<a name="ln1233">		}</a>
<a name="ln1234">		//TRACE((&quot;emuxki_voice_curaddr idx_reg : %u\n&quot;, idx_reg));</a>
<a name="ln1235">		//TRACE((&quot;emuxki_voice_curaddr : %lu\n&quot;, emuxki_chan_read(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, idx_reg)));</a>
<a name="ln1236">		return emuxki_chan_read(&amp;voice-&gt;stream-&gt;card-&gt;config,</a>
<a name="ln1237">				     0,</a>
<a name="ln1238">				     idx_reg);</a>
<a name="ln1239">	}</a>
<a name="ln1240">}</a>
<a name="ln1241"> </a>
<a name="ln1242"> </a>
<a name="ln1243">static void</a>
<a name="ln1244">emuxki_resched_timer(emuxki_dev *card)</a>
<a name="ln1245">{</a>
<a name="ln1246">	emuxki_voice 	*voice;</a>
<a name="ln1247">	emuxki_stream 	*stream;</a>
<a name="ln1248">	uint16			timerate = 1024;</a>
<a name="ln1249">	uint8			active = 0;</a>
<a name="ln1250">	//int             s = splaudio();</a>
<a name="ln1251"> </a>
<a name="ln1252">	LOG((&quot;emuxki_resched_timer begin\n&quot;));</a>
<a name="ln1253"> </a>
<a name="ln1254">	LIST_FOREACH(stream, &amp;card-&gt;streams, next) {</a>
<a name="ln1255">		LIST_FOREACH(voice, &amp;stream-&gt;voices, next) {</a>
<a name="ln1256">			if ((voice-&gt;use &amp; EMU_USE_PLAY) == 0 ||</a>
<a name="ln1257">				(voice-&gt;state &amp; EMU_STATE_STARTED) == 0)</a>
<a name="ln1258">				continue;</a>
<a name="ln1259">			active = 1;</a>
<a name="ln1260">			if (voice-&gt;timerate &lt; timerate)</a>
<a name="ln1261">				timerate = voice-&gt;timerate;</a>
<a name="ln1262">		}</a>
<a name="ln1263">	}</a>
<a name="ln1264">	if (timerate &amp; ~EMU_TIMER_RATE_MASK)</a>
<a name="ln1265">		timerate = 0;</a>
<a name="ln1266"> </a>
<a name="ln1267">	if (card-&gt;timerate &gt; timerate) {</a>
<a name="ln1268">		LOG((&quot;emuxki_resched_timer written (old %u, new %u)\n&quot;, card-&gt;timerate, timerate));</a>
<a name="ln1269">		card-&gt;timerate = timerate;</a>
<a name="ln1270">		emuxki_reg_write_16(&amp;card-&gt;config, EMU_TIMER, timerate);</a>
<a name="ln1271">	}</a>
<a name="ln1272">	if (!active &amp;&amp; (card-&gt;timerstate &amp; EMU_TIMER_STATE_ENABLED)) {</a>
<a name="ln1273">		emuxki_inte_disable(&amp;card-&gt;config, EMU_INTE_INTERTIMERENB);</a>
<a name="ln1274">		card-&gt;timerstate &amp;= ~EMU_TIMER_STATE_ENABLED;</a>
<a name="ln1275">		LOG((&quot;emuxki_resched_timer : timer disabled\n&quot;));</a>
<a name="ln1276">	} else</a>
<a name="ln1277">	  if (active &amp;&amp; !(card-&gt;timerstate &amp; EMU_TIMER_STATE_ENABLED)) {</a>
<a name="ln1278">	  	emuxki_inte_enable(&amp;card-&gt;config, EMU_INTE_INTERTIMERENB);</a>
<a name="ln1279">		card-&gt;timerstate |= EMU_TIMER_STATE_ENABLED;</a>
<a name="ln1280">		LOG((&quot;emuxki_resched_timer : timer enabled\n&quot;));</a>
<a name="ln1281">	  }</a>
<a name="ln1282">	LOG((&quot;emuxki_resched_timer state : %x\n&quot;, card-&gt;timerstate));</a>
<a name="ln1283">	//splx(s);</a>
<a name="ln1284">}</a>
<a name="ln1285"> </a>
<a name="ln1286"> </a>
<a name="ln1287">static uint32</a>
<a name="ln1288">emuxki_voice_adc_rate(emuxki_voice *voice)</a>
<a name="ln1289">{</a>
<a name="ln1290">	switch(voice-&gt;sample_rate) {</a>
<a name="ln1291">		case 48000:</a>
<a name="ln1292">			return EMU_ADCCR_SAMPLERATE_48;</a>
<a name="ln1293">			break;</a>
<a name="ln1294">		case 44100:</a>
<a name="ln1295">			return EMU_ADCCR_SAMPLERATE_44;</a>
<a name="ln1296">			break;</a>
<a name="ln1297">		case 32000:</a>
<a name="ln1298">			return EMU_ADCCR_SAMPLERATE_32;</a>
<a name="ln1299">			break;</a>
<a name="ln1300">		case 24000:</a>
<a name="ln1301">			return EMU_ADCCR_SAMPLERATE_24;</a>
<a name="ln1302">			break;</a>
<a name="ln1303">		case 22050:</a>
<a name="ln1304">			return EMU_ADCCR_SAMPLERATE_22;</a>
<a name="ln1305">			break;</a>
<a name="ln1306">		case 16000:</a>
<a name="ln1307">			return EMU_ADCCR_SAMPLERATE_16;</a>
<a name="ln1308">			break;</a>
<a name="ln1309">		case 12000:</a>
<a name="ln1310">			if (IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config))</a>
<a name="ln1311">				return EMU_A_ADCCR_SAMPLERATE_12;</a>
<a name="ln1312">			else</a>
<a name="ln1313">				PRINT((&quot;recording sample_rate not supported : %lu\n&quot;, voice-&gt;sample_rate));</a>
<a name="ln1314">			break;</a>
<a name="ln1315">		case 11000:</a>
<a name="ln1316">			if (IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config))</a>
<a name="ln1317">				return EMU_A_ADCCR_SAMPLERATE_11;</a>
<a name="ln1318">			else</a>
<a name="ln1319">				return EMU_ADCCR_SAMPLERATE_11;</a>
<a name="ln1320">			break;</a>
<a name="ln1321">		case 8000:</a>
<a name="ln1322">			if (IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config))</a>
<a name="ln1323">				return EMU_A_ADCCR_SAMPLERATE_8;</a>
<a name="ln1324">			else</a>
<a name="ln1325">				return EMU_ADCCR_SAMPLERATE_8;</a>
<a name="ln1326">			break;</a>
<a name="ln1327">		default:</a>
<a name="ln1328">			PRINT((&quot;recording sample_rate not supported : %lu\n&quot;, voice-&gt;sample_rate));</a>
<a name="ln1329">	}</a>
<a name="ln1330">	return 0;</a>
<a name="ln1331">}</a>
<a name="ln1332"> </a>
<a name="ln1333"> </a>
<a name="ln1334">void</a>
<a name="ln1335">emuxki_voice_start(emuxki_voice *voice)</a>
<a name="ln1336">{</a>
<a name="ln1337">	LOG((&quot;emuxki_voice_start\n&quot;));</a>
<a name="ln1338"> </a>
<a name="ln1339">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln1340">		voice-&gt;trigblk = 1;</a>
<a name="ln1341">		emuxki_channel_start(voice-&gt;dataloc.chan[0]);</a>
<a name="ln1342">		if (voice-&gt;stereo)</a>
<a name="ln1343">			emuxki_channel_start(voice-&gt;dataloc.chan[1]);</a>
<a name="ln1344">	} else {</a>
<a name="ln1345"> </a>
<a name="ln1346">		switch (voice-&gt;dataloc.source) {</a>
<a name="ln1347">			case EMU_RECSRC_MIC:</a>
<a name="ln1348">				emuxki_inte_enable(&amp;voice-&gt;stream-&gt;card-&gt;config, EMU_INTE_MICBUFENABLE);</a>
<a name="ln1349">				break;</a>
<a name="ln1350">			case EMU_RECSRC_ADC: {</a>
<a name="ln1351">				uint32 adccr_value = 0;</a>
<a name="ln1352">				adccr_value = emuxki_voice_adc_rate(voice);</a>
<a name="ln1353">				LOG((&quot;emuxki_voice_start adccr_value : %u\n&quot;, adccr_value));</a>
<a name="ln1354">				if (voice-&gt;stereo)</a>
<a name="ln1355">					adccr_value |= ( (IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config) ? EMU_A_ADCCR_LCHANENABLE : EMU_ADCCR_LCHANENABLE )</a>
<a name="ln1356">						| ( IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config) ? EMU_A_ADCCR_RCHANENABLE : EMU_ADCCR_RCHANENABLE ));</a>
<a name="ln1357">				else</a>
<a name="ln1358">					adccr_value |= IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config) ? EMU_A_ADCCR_LCHANENABLE : EMU_ADCCR_LCHANENABLE;</a>
<a name="ln1359"> </a>
<a name="ln1360">				LOG((&quot;emuxki_voice_start adccr_value : %u, %u\n&quot;, adccr_value, EMU_ADCCR_LCHANENABLE | EMU_ADCCR_RCHANENABLE));</a>
<a name="ln1361">				emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_ADCCR, adccr_value);</a>
<a name="ln1362"> </a>
<a name="ln1363">				emuxki_inte_enable(&amp;voice-&gt;stream-&gt;card-&gt;config, EMU_INTE_ADCBUFENABLE);</a>
<a name="ln1364">				}</a>
<a name="ln1365">				break;</a>
<a name="ln1366">			case EMU_RECSRC_FX:</a>
<a name="ln1367">				if (IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config)) {</a>
<a name="ln1368">					emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_A_FXWC1,</a>
<a name="ln1369">						voice-&gt;recparams.efx_voices[0]);</a>
<a name="ln1370">					emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_A_FXWC2,</a>
<a name="ln1371">						voice-&gt;recparams.efx_voices[1]);</a>
<a name="ln1372">				} else {</a>
<a name="ln1373">					emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_FXWC,</a>
<a name="ln1374">						voice-&gt;recparams.efx_voices[0]);</a>
<a name="ln1375">				}</a>
<a name="ln1376">				emuxki_inte_enable(&amp;voice-&gt;stream-&gt;card-&gt;config, EMU_INTE_EFXBUFENABLE);</a>
<a name="ln1377">				break;</a>
<a name="ln1378">			default:</a>
<a name="ln1379">				PRINT((&quot;emuxki_voice_start BUG\n&quot;));</a>
<a name="ln1380">		}</a>
<a name="ln1381">	}</a>
<a name="ln1382">	voice-&gt;state |= EMU_STATE_STARTED;</a>
<a name="ln1383">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln1384">		emuxki_resched_timer(voice-&gt;stream-&gt;card);</a>
<a name="ln1385">	}</a>
<a name="ln1386">}</a>
<a name="ln1387"> </a>
<a name="ln1388"> </a>
<a name="ln1389">void</a>
<a name="ln1390">emuxki_voice_halt(emuxki_voice *voice)</a>
<a name="ln1391">{</a>
<a name="ln1392">	LOG((&quot;emuxki_voice_halt\n&quot;));</a>
<a name="ln1393"> </a>
<a name="ln1394">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln1395">		emuxki_channel_stop(voice-&gt;dataloc.chan[0]);</a>
<a name="ln1396">		if (voice-&gt;stereo)</a>
<a name="ln1397">			emuxki_channel_stop(voice-&gt;dataloc.chan[1]);</a>
<a name="ln1398">	} else {</a>
<a name="ln1399"> </a>
<a name="ln1400">		switch (voice-&gt;dataloc.source) {</a>
<a name="ln1401">			case EMU_RECSRC_MIC:</a>
<a name="ln1402">				emuxki_inte_disable(&amp;voice-&gt;stream-&gt;card-&gt;config, EMU_INTE_MICBUFENABLE);</a>
<a name="ln1403">				break;</a>
<a name="ln1404">			case EMU_RECSRC_ADC:</a>
<a name="ln1405">				emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_ADCCR, 0);</a>
<a name="ln1406">				emuxki_inte_disable(&amp;voice-&gt;stream-&gt;card-&gt;config, EMU_INTE_ADCBUFENABLE);</a>
<a name="ln1407">				break;</a>
<a name="ln1408">			case EMU_RECSRC_FX:</a>
<a name="ln1409">				if (IS_AUDIGY(&amp;voice-&gt;stream-&gt;card-&gt;config)) {</a>
<a name="ln1410">					emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_A_FXWC1, 0);</a>
<a name="ln1411">					emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_A_FXWC2, 0);</a>
<a name="ln1412">				} else</a>
<a name="ln1413">					emuxki_chan_write(&amp;voice-&gt;stream-&gt;card-&gt;config, 0, EMU_FXWC, 0);</a>
<a name="ln1414">				emuxki_inte_disable(&amp;voice-&gt;stream-&gt;card-&gt;config, EMU_INTE_EFXBUFENABLE);</a>
<a name="ln1415">				break;</a>
<a name="ln1416">			default:</a>
<a name="ln1417">				PRINT((&quot;emuxki_voice_halt BUG\n&quot;));</a>
<a name="ln1418">		}</a>
<a name="ln1419">	}</a>
<a name="ln1420">	voice-&gt;state &amp;= ~EMU_STATE_STARTED;</a>
<a name="ln1421">	if (voice-&gt;use &amp; EMU_USE_PLAY) {</a>
<a name="ln1422">		emuxki_resched_timer(voice-&gt;stream-&gt;card);</a>
<a name="ln1423">	}</a>
<a name="ln1424">}</a>
<a name="ln1425"> </a>
<a name="ln1426"> </a>
<a name="ln1427">emuxki_voice *</a>
<a name="ln1428">emuxki_voice_new(emuxki_stream *stream, uint8 use, uint8 voicenum)</a>
<a name="ln1429">{</a>
<a name="ln1430">	emuxki_voice *voice;</a>
<a name="ln1431">	//int             s;</a>
<a name="ln1432"> </a>
<a name="ln1433">	LOG((&quot;emuxki_voice_new\n&quot;));</a>
<a name="ln1434"> </a>
<a name="ln1435">	voice = malloc(sizeof(emuxki_voice));</a>
<a name="ln1436">	if (voice == NULL)</a>
<a name="ln1437">		return (NULL);</a>
<a name="ln1438">	voice-&gt;stream = stream;</a>
<a name="ln1439">	voice-&gt;use = use;</a>
<a name="ln1440">	voice-&gt;state = !EMU_STATE_STARTED;</a>
<a name="ln1441">	voice-&gt;stereo = EMU_STEREO_NOTSET;</a>
<a name="ln1442">	voice-&gt;b16 = 0;</a>
<a name="ln1443">	voice-&gt;sample_rate = 0;</a>
<a name="ln1444">	if (use &amp; EMU_USE_PLAY)</a>
<a name="ln1445">		voice-&gt;dataloc.chan[0] = voice-&gt;dataloc.chan[1] = NULL;</a>
<a name="ln1446">	else</a>
<a name="ln1447">		voice-&gt;dataloc.source = EMU_RECSRC_NOTSET;</a>
<a name="ln1448">	voice-&gt;buffer = NULL;</a>
<a name="ln1449">	voice-&gt;blksize = 0;</a>
<a name="ln1450">	voice-&gt;trigblk = 0;</a>
<a name="ln1451">	voice-&gt;blkmod = 0;</a>
<a name="ln1452">	voice-&gt;timerate = 0;</a>
<a name="ln1453">	voice-&gt;voicenum = voicenum;</a>
<a name="ln1454">	return voice;</a>
<a name="ln1455">}</a>
<a name="ln1456"> </a>
<a name="ln1457"> </a>
<a name="ln1458">void</a>
<a name="ln1459">emuxki_voice_delete(emuxki_voice *voice)</a>
<a name="ln1460">{</a>
<a name="ln1461">	if (voice-&gt;state &amp; EMU_STATE_STARTED)</a>
<a name="ln1462">		emuxki_voice_halt(voice);</a>
<a name="ln1463">	emuxki_voice_dataloc_destroy(voice);</a>
<a name="ln1464">	free(voice);</a>
<a name="ln1465">}</a>
<a name="ln1466"> </a>
<a name="ln1467">/*	Emuxki stream functions */</a>
<a name="ln1468"> </a>
<a name="ln1469">status_t</a>
<a name="ln1470">emuxki_stream_set_audioparms(emuxki_stream *stream, bool stereo, uint8 channels,</a>
<a name="ln1471">     uint8 b16, uint32 sample_rate)</a>
<a name="ln1472">{</a>
<a name="ln1473">	status_t 		error;</a>
<a name="ln1474">	emuxki_voice 	*voice;</a>
<a name="ln1475">	uint8			i, nvoices;</a>
<a name="ln1476">	char 			*buffer;</a>
<a name="ln1477">	uint8 			sample_size, frame_size;</a>
<a name="ln1478">	LOG((&quot;emuxki_stream_set_audioparms\n&quot;));</a>
<a name="ln1479"> </a>
<a name="ln1480">	if (stream-&gt;stereo == stereo &amp;&amp;</a>
<a name="ln1481">		((stream-&gt;nmono + 2*stream-&gt;nstereo) == channels) &amp;&amp;</a>
<a name="ln1482">		(stream-&gt;b16 == b16) &amp;&amp;</a>
<a name="ln1483">		(stream-&gt;sample_rate == sample_rate))</a>
<a name="ln1484">		return B_OK;</a>
<a name="ln1485"> </a>
<a name="ln1486">	LIST_FOREACH(voice, &amp;stream-&gt;voices, next) {</a>
<a name="ln1487">		if (voice-&gt;buffer)</a>
<a name="ln1488">			emuxki_mem_free(stream-&gt;card, voice-&gt;buffer-&gt;log_base);</a>
<a name="ln1489">		emuxki_voice_delete(voice);</a>
<a name="ln1490">	}</a>
<a name="ln1491">	stream-&gt;first_voice = NULL;</a>
<a name="ln1492">	LIST_INIT(&amp;(stream-&gt;voices));</a>
<a name="ln1493"> </a>
<a name="ln1494">	stream-&gt;b16 = b16;</a>
<a name="ln1495">	stream-&gt;sample_rate = sample_rate;</a>
<a name="ln1496"> </a>
<a name="ln1497">	if (stereo &amp;&amp; (channels % 2 == 0)) {</a>
<a name="ln1498">		stream-&gt;stereo = true;</a>
<a name="ln1499">		stream-&gt;nstereo = channels / 2;</a>
<a name="ln1500">		stream-&gt;nmono = 0;</a>
<a name="ln1501">		nvoices = stream-&gt;nstereo;</a>
<a name="ln1502">	} else {</a>
<a name="ln1503">		stream-&gt;stereo = false;</a>
<a name="ln1504">		stream-&gt;nstereo = 0;</a>
<a name="ln1505">		stream-&gt;nmono = channels;</a>
<a name="ln1506">		nvoices = stream-&gt;nmono;</a>
<a name="ln1507">	}</a>
<a name="ln1508"> </a>
<a name="ln1509">	sample_size = stream-&gt;b16 + 1;</a>
<a name="ln1510">	frame_size = sample_size * (stream-&gt;stereo ? 2 : 1);</a>
<a name="ln1511"> </a>
<a name="ln1512">	for (i = 0; i &lt; nvoices; i++) {</a>
<a name="ln1513">		voice = emuxki_voice_new(stream, stream-&gt;use, i);</a>
<a name="ln1514">		if (voice) {</a>
<a name="ln1515">			if (!stream-&gt;first_voice)</a>
<a name="ln1516">				stream-&gt;first_voice = voice;</a>
<a name="ln1517">			LIST_INSERT_HEAD((&amp;stream-&gt;voices), voice, next);</a>
<a name="ln1518">			if ((error = emuxki_voice_set_audioparms(voice, stream-&gt;stereo,</a>
<a name="ln1519">				stream-&gt;b16, stream-&gt;sample_rate)))</a>
<a name="ln1520">				return error;</a>
<a name="ln1521"> </a>
<a name="ln1522">			if (stream-&gt;use &amp; EMU_USE_PLAY)</a>
<a name="ln1523">				buffer = emuxki_pmem_alloc(stream-&gt;card, stream-&gt;bufframes</a>
<a name="ln1524">					* frame_size * stream-&gt;bufcount);</a>
<a name="ln1525">			else</a>
<a name="ln1526">				buffer = emuxki_rmem_alloc(stream-&gt;card, stream-&gt;bufframes</a>
<a name="ln1527">					* frame_size * stream-&gt;bufcount);</a>
<a name="ln1528"> </a>
<a name="ln1529">			emuxki_voice_set_bufparms(voice, buffer,</a>
<a name="ln1530">				stream-&gt;bufframes * frame_size * stream-&gt;bufcount,</a>
<a name="ln1531">				stream-&gt;bufframes * frame_size);</a>
<a name="ln1532">		}</a>
<a name="ln1533">	}</a>
<a name="ln1534"> </a>
<a name="ln1535">	return B_OK;</a>
<a name="ln1536">}</a>
<a name="ln1537"> </a>
<a name="ln1538"> </a>
<a name="ln1539">status_t</a>
<a name="ln1540">emuxki_stream_set_recparms(emuxki_stream *stream, emuxki_recsrc_t recsrc,</a>
<a name="ln1541">			     	emuxki_recparams *recparams)</a>
<a name="ln1542">{</a>
<a name="ln1543">	emuxki_voice *voice;</a>
<a name="ln1544">	LOG((&quot;emuxki_stream_set_recparms\n&quot;));</a>
<a name="ln1545"> </a>
<a name="ln1546">	if (stream-&gt;use &amp; EMU_USE_RECORD) {</a>
<a name="ln1547">		switch(recsrc) {</a>
<a name="ln1548">			case EMU_RECSRC_MIC:</a>
<a name="ln1549">				break;</a>
<a name="ln1550">			case EMU_RECSRC_ADC:</a>
<a name="ln1551">				break;</a>
<a name="ln1552">			case EMU_RECSRC_FX:</a>
<a name="ln1553">				if (!recparams)</a>
<a name="ln1554">					return B_ERROR;</a>
<a name="ln1555">				LIST_FOREACH(voice, &amp;stream-&gt;voices, next) {</a>
<a name="ln1556">					voice-&gt;recparams.efx_voices[0] = recparams-&gt;efx_voices[0];</a>
<a name="ln1557">					voice-&gt;recparams.efx_voices[1] = recparams-&gt;efx_voices[1];</a>
<a name="ln1558">				}</a>
<a name="ln1559">				break;</a>
<a name="ln1560">			default:</a>
<a name="ln1561">				return B_ERROR;</a>
<a name="ln1562">				break;</a>
<a name="ln1563">		}</a>
<a name="ln1564">		LIST_FOREACH(voice, &amp;stream-&gt;voices, next)</a>
<a name="ln1565">			voice-&gt;dataloc.source = recsrc;</a>
<a name="ln1566">	}</a>
<a name="ln1567">	return B_OK;</a>
<a name="ln1568">}</a>
<a name="ln1569"> </a>
<a name="ln1570"> </a>
<a name="ln1571">status_t</a>
<a name="ln1572">emuxki_stream_commit_parms(emuxki_stream *stream)</a>
<a name="ln1573">{</a>
<a name="ln1574">	emuxki_voice 	*voice;</a>
<a name="ln1575">	status_t 		error;</a>
<a name="ln1576">	LOG((&quot;emuxki_stream_commit_parms\n&quot;));</a>
<a name="ln1577"> </a>
<a name="ln1578">	LIST_FOREACH(voice, &amp;stream-&gt;voices, next)</a>
<a name="ln1579">		if ((error = emuxki_voice_commit_parms(voice)))</a>
<a name="ln1580">			return error;</a>
<a name="ln1581"> </a>
<a name="ln1582">	return B_OK;</a>
<a name="ln1583">}</a>
<a name="ln1584"> </a>
<a name="ln1585"> </a>
<a name="ln1586">status_t</a>
<a name="ln1587">emuxki_stream_get_nth_buffer(emuxki_stream *stream, uint8 chan, uint8 buf,</a>
<a name="ln1588">					char** buffer, size_t *stride)</a>
<a name="ln1589">{</a>
<a name="ln1590">	emuxki_voice *voice = NULL;</a>
<a name="ln1591">	uint8 i, sample_size;</a>
<a name="ln1592">	LOG((&quot;emuxki_stream_get_nth_buffer\n&quot;));</a>
<a name="ln1593"> </a>
<a name="ln1594">	sample_size = stream-&gt;b16 + 1;</a>
<a name="ln1595">	if (buf &gt;= stream-&gt;bufcount)</a>
<a name="ln1596">		return B_BAD_INDEX;</a>
<a name="ln1597"> </a>
<a name="ln1598">	if (stream-&gt;stereo) {</a>
<a name="ln1599">		i = stream-&gt;nstereo - 1;</a>
<a name="ln1600">		if (chan/2 &gt; i)</a>
<a name="ln1601">			return B_BAD_INDEX;</a>
<a name="ln1602">		LIST_FOREACH(voice, &amp;stream-&gt;voices, next)</a>
<a name="ln1603">			if (i != chan/2)</a>
<a name="ln1604">				i--;</a>
<a name="ln1605">			else</a>
<a name="ln1606">				break;</a>
<a name="ln1607">		if (voice) {</a>
<a name="ln1608">			*buffer = (char*)voice-&gt;buffer-&gt;log_base</a>
<a name="ln1609">				+ (buf * stream-&gt;bufframes * sample_size * 2);</a>
<a name="ln1610">			if (chan % 2 == 1)</a>
<a name="ln1611">				*buffer += sample_size;</a>
<a name="ln1612">			*stride = sample_size * 2;</a>
<a name="ln1613">		} else</a>
<a name="ln1614">			return B_ERROR;</a>
<a name="ln1615">	} else {</a>
<a name="ln1616">		i = stream-&gt;nmono - 1;</a>
<a name="ln1617">		if (chan &gt; i)</a>
<a name="ln1618">			return B_BAD_INDEX;</a>
<a name="ln1619">		LIST_FOREACH(voice, &amp;stream-&gt;voices, next)</a>
<a name="ln1620">			if (i != chan)</a>
<a name="ln1621">				i--;</a>
<a name="ln1622">			else</a>
<a name="ln1623">				break;</a>
<a name="ln1624">		if (voice) {</a>
<a name="ln1625">			*buffer = (char*)voice-&gt;buffer-&gt;log_base</a>
<a name="ln1626">				+ (buf * stream-&gt;bufframes * sample_size);</a>
<a name="ln1627">			*stride = sample_size;</a>
<a name="ln1628">		} else</a>
<a name="ln1629">			return B_ERROR;</a>
<a name="ln1630">	}</a>
<a name="ln1631"> </a>
<a name="ln1632">	return B_OK;</a>
<a name="ln1633">}</a>
<a name="ln1634"> </a>
<a name="ln1635"> </a>
<a name="ln1636">void</a>
<a name="ln1637">emuxki_stream_start(emuxki_stream *stream, void (*inth) (void *), void *inthparam)</a>
<a name="ln1638">{</a>
<a name="ln1639">	emuxki_voice *voice;</a>
<a name="ln1640">	LOG((&quot;emuxki_stream_start\n&quot;));</a>
<a name="ln1641"> </a>
<a name="ln1642">	stream-&gt;inth = inth;</a>
<a name="ln1643">	stream-&gt;inthparam = inthparam;</a>
<a name="ln1644"> </a>
<a name="ln1645">	LIST_FOREACH(voice, &amp;stream-&gt;voices, next) {</a>
<a name="ln1646">		emuxki_voice_start(voice);</a>
<a name="ln1647">	}</a>
<a name="ln1648">	stream-&gt;state |= EMU_STATE_STARTED;</a>
<a name="ln1649">}</a>
<a name="ln1650"> </a>
<a name="ln1651"> </a>
<a name="ln1652">void</a>
<a name="ln1653">emuxki_stream_halt(emuxki_stream *stream)</a>
<a name="ln1654">{</a>
<a name="ln1655">	emuxki_voice *voice;</a>
<a name="ln1656">	LOG((&quot;emuxki_stream_halt\n&quot;));</a>
<a name="ln1657"> </a>
<a name="ln1658">	LIST_FOREACH(voice, &amp;stream-&gt;voices, next) {</a>
<a name="ln1659">		emuxki_voice_halt(voice);</a>
<a name="ln1660">	}</a>
<a name="ln1661">	stream-&gt;state &amp;= ~EMU_STATE_STARTED;</a>
<a name="ln1662">}</a>
<a name="ln1663"> </a>
<a name="ln1664"> </a>
<a name="ln1665">emuxki_stream *</a>
<a name="ln1666">emuxki_stream_new(emuxki_dev *card, uint8 use, uint32 bufframes, uint8 bufcount)</a>
<a name="ln1667">{</a>
<a name="ln1668">	emuxki_stream *stream;</a>
<a name="ln1669">	cpu_status status;</a>
<a name="ln1670">	LOG((&quot;emuxki_stream_new\n&quot;));</a>
<a name="ln1671"> </a>
<a name="ln1672">	stream = malloc(sizeof(emuxki_stream));</a>
<a name="ln1673">	if (stream == NULL)</a>
<a name="ln1674">		return (NULL);</a>
<a name="ln1675">	stream-&gt;card = card;</a>
<a name="ln1676">	stream-&gt;use = use;</a>
<a name="ln1677">	stream-&gt;state = !EMU_STATE_STARTED;</a>
<a name="ln1678">	stream-&gt;stereo = EMU_STEREO_NOTSET;</a>
<a name="ln1679">	stream-&gt;b16 = 0;</a>
<a name="ln1680">	stream-&gt;sample_rate = 0;</a>
<a name="ln1681">	stream-&gt;nmono = 0;</a>
<a name="ln1682">	stream-&gt;nstereo = 0;</a>
<a name="ln1683">	stream-&gt;bufframes = bufframes;</a>
<a name="ln1684">	stream-&gt;bufcount = bufcount;</a>
<a name="ln1685">	stream-&gt;first_voice = NULL;</a>
<a name="ln1686">	stream-&gt;inth = NULL;</a>
<a name="ln1687">	stream-&gt;inthparam = NULL;</a>
<a name="ln1688"> </a>
<a name="ln1689">	stream-&gt;frames_count = 0;</a>
<a name="ln1690">	stream-&gt;real_time = 0;</a>
<a name="ln1691">	stream-&gt;buffer_cycle = 0;</a>
<a name="ln1692">	stream-&gt;update_needed = false;</a>
<a name="ln1693"> </a>
<a name="ln1694">	/* Init voices list */</a>
<a name="ln1695">	LIST_INIT(&amp;(stream-&gt;voices));</a>
<a name="ln1696"> </a>
<a name="ln1697">	status = lock();</a>
<a name="ln1698">	LIST_INSERT_HEAD((&amp;card-&gt;streams), stream, next);</a>
<a name="ln1699">	unlock(status);</a>
<a name="ln1700"> </a>
<a name="ln1701">	return stream;</a>
<a name="ln1702">}</a>
<a name="ln1703"> </a>
<a name="ln1704"> </a>
<a name="ln1705">void</a>
<a name="ln1706">emuxki_stream_delete(emuxki_stream *stream)</a>
<a name="ln1707">{</a>
<a name="ln1708">	emuxki_voice *voice;</a>
<a name="ln1709">	cpu_status status;</a>
<a name="ln1710">	LOG((&quot;emuxki_stream_delete\n&quot;));</a>
<a name="ln1711"> </a>
<a name="ln1712">	emuxki_stream_halt(stream);</a>
<a name="ln1713"> </a>
<a name="ln1714">	status = lock();</a>
<a name="ln1715">	LIST_REMOVE(stream, next);</a>
<a name="ln1716">	unlock(status);</a>
<a name="ln1717"> </a>
<a name="ln1718">	while (!LIST_EMPTY(&amp;stream-&gt;voices)) {</a>
<a name="ln1719">		voice = LIST_FIRST(&amp;stream-&gt;voices);</a>
<a name="ln1720">		LIST_REMOVE(voice, next);</a>
<a name="ln1721">		if (voice-&gt;buffer)</a>
<a name="ln1722">			emuxki_mem_free(stream-&gt;card, voice-&gt;buffer-&gt;log_base);</a>
<a name="ln1723">		emuxki_voice_delete(voice);</a>
<a name="ln1724">	}</a>
<a name="ln1725"> </a>
<a name="ln1726">	free(stream);</a>
<a name="ln1727">}</a>
<a name="ln1728"> </a>
<a name="ln1729"> </a>
<a name="ln1730">/* Emuxki gprs */</a>
<a name="ln1731">// 87 values from 0.0dB to -xdB (-0.75dB each)</a>
<a name="ln1732">static uint32 db_table[] = {</a>
<a name="ln1733">	2147483647,	1969835071,	1806882308,	1657409659,	1520301995,	1394536435,	1279174712,</a>
<a name="ln1734">	1173356181,	1076291388,	987256190,	905586345,	830672562,	761955951,	698923858,</a>
<a name="ln1735">	641106035,	588071138,	539423503,	494800198,	453868315,	416322483,	381882595,</a>
<a name="ln1736">	350291714,	321314160,	294733747,	270352173,	247987542,	227473005,	208655513,</a>
<a name="ln1737">	191394681,	175561735,	161038555,	147716791,	135497057,	124288190,	114006566,</a>
<a name="ln1738">	104575479,	95924570,	87989300,	80710468,	74033770,	67909395,	62291654,</a>
<a name="ln1739">	57138635,	52411895,	48076170,	44099114,	40451056,	37104780,	34035322,</a>
<a name="ln1740">	31219781,	28637154,	26268172,	24095162,	22101913,	20273552,	18596442,</a>
<a name="ln1741">	17058068,	15646956,	14352576,	13165272,	12076188,	11077196,	10160845,</a>
<a name="ln1742">	9320299,	8549286,	7842054,	7193328,	6598266,	6052431,	5551749,</a>
<a name="ln1743">	5092486,	4671215,	4284793,	3930337,	3605204,	3306967,	3033401,</a>
<a name="ln1744">	2782465,	2552289,	2341153,	2147483,	1969835,	1806882,	1657409,</a>
<a name="ln1745">	1520301,	1394536,	1279174</a>
<a name="ln1746">};</a>
<a name="ln1747"> </a>
<a name="ln1748"> </a>
<a name="ln1749">void</a>
<a name="ln1750">emuxki_gpr_set(emuxki_dev *card, emuxki_gpr *gpr, int32 type, float *values)</a>
<a name="ln1751">{</a>
<a name="ln1752">	uint8 count = gpr-&gt;type &amp; EMU_MIX_STEREO ? 2 : 1;</a>
<a name="ln1753">	uint8 i;</a>
<a name="ln1754">	uint32 index;</a>
<a name="ln1755"> </a>
<a name="ln1756">	LOG((&quot;emuxki_set_gpr\n&quot;));</a>
<a name="ln1757"> </a>
<a name="ln1758">	switch(type) {</a>
<a name="ln1759">		case EMU_MIX_MUTE:</a>
<a name="ln1760">			gpr-&gt;mute = (values[0] == 1.0);</a>
<a name="ln1761">			if (gpr-&gt;mute) {</a>
<a name="ln1762">				for (i = 0; i &lt; count; i++)</a>
<a name="ln1763">					emuxki_write_gpr(&amp;card-&gt;config, gpr-&gt;gpr + i, 0);</a>
<a name="ln1764">				break;</a>
<a name="ln1765">			}</a>
<a name="ln1766">			for (i = 0; i &lt; count; i++) {</a>
<a name="ln1767">				values[i] = gpr-&gt;current[i];</a>
<a name="ln1768">			}</a>
<a name="ln1769">		case EMU_MIX_GAIN:</a>
<a name="ln1770">			for (i = 0; i &lt; count; i++) {</a>
<a name="ln1771">				if (values[i]&gt;gpr-&gt;max_gain || values[i]&lt;gpr-&gt;min_gain)</a>
<a name="ln1772">					return;</a>
<a name="ln1773">				index = (int32)(values[i] / gpr-&gt;granularity);</a>
<a name="ln1774">				if (index &gt; sizeof(db_table)/sizeof(db_table[0]))</a>
<a name="ln1775">					index = sizeof(db_table)/sizeof(db_table[0]);</a>
<a name="ln1776">				else if (index &lt; 0)</a>
<a name="ln1777">					index = 0;</a>
<a name="ln1778">				LOG((&quot;emuxki_set_gpr gpr: %d \n&quot;, gpr-&gt;gpr + i));</a>
<a name="ln1779">				LOG((&quot;emuxki_set_gpr values[i]: %g \n&quot;, values[i]));</a>
<a name="ln1780">				LOG((&quot;emuxki_set_gpr index: %u \n&quot;, index));</a>
<a name="ln1781">				if (!gpr-&gt;mute)</a>
<a name="ln1782">					emuxki_write_gpr(&amp;card-&gt;config, gpr-&gt;gpr + i, db_table[index]);</a>
<a name="ln1783">				gpr-&gt;current[i] = index * gpr-&gt;granularity;</a>
<a name="ln1784">			}</a>
<a name="ln1785">			break;</a>
<a name="ln1786">	}</a>
<a name="ln1787">}</a>
<a name="ln1788"> </a>
<a name="ln1789"> </a>
<a name="ln1790">void</a>
<a name="ln1791">emuxki_gpr_get(emuxki_dev *card, emuxki_gpr *gpr, int32 type, float *values)</a>
<a name="ln1792">{</a>
<a name="ln1793">	uint8 count = gpr-&gt;type &amp; EMU_MIX_STEREO ? 2 : 1;</a>
<a name="ln1794">	uint16 i;</a>
<a name="ln1795"> </a>
<a name="ln1796">	LOG((&quot;emuxki_get_gpr\n&quot;));</a>
<a name="ln1797"> </a>
<a name="ln1798">	switch(type) {</a>
<a name="ln1799">		case EMU_MIX_GAIN:</a>
<a name="ln1800">			for (i = 0; i &lt; count; i++) {</a>
<a name="ln1801">				values[i] = gpr-&gt;current[i];</a>
<a name="ln1802">			}</a>
<a name="ln1803">			break;</a>
<a name="ln1804">		case EMU_MIX_MUTE:</a>
<a name="ln1805">			values[0] = (gpr-&gt;mute ? 1.0 : 0.0);</a>
<a name="ln1806">			break;</a>
<a name="ln1807">	}</a>
<a name="ln1808">}</a>
<a name="ln1809"> </a>
<a name="ln1810"> </a>
<a name="ln1811">void</a>
<a name="ln1812">emuxki_gpr_dump(emuxki_dev * card, uint16 count)</a>
<a name="ln1813">{</a>
<a name="ln1814">	uint16      pc;</a>
<a name="ln1815">	uint32		value;</a>
<a name="ln1816"> </a>
<a name="ln1817">	LOG((&quot;emuxki_dump_gprs\n&quot;));</a>
<a name="ln1818"> </a>
<a name="ln1819">	for (pc = 0; pc &lt; count; pc++) {</a>
<a name="ln1820">		value = emuxki_read_gpr(&amp;card-&gt;config, pc);</a>
<a name="ln1821">		LOG((&quot;dsp_gpr pc=%x, value=%x\n&quot;, pc, value));</a>
<a name="ln1822">	}</a>
<a name="ln1823">}</a>
<a name="ln1824"> </a>
<a name="ln1825"> </a>
<a name="ln1826">static emuxki_gpr *</a>
<a name="ln1827">emuxki_gpr_new(emuxki_dev *card, const char *name, emuxki_gpr_type type, uint16 *gpr_num,</a>
<a name="ln1828">			float default_value, float default_mute, float min_gain, float max_gain, float granularity)</a>
<a name="ln1829">{</a>
<a name="ln1830">	emuxki_gpr *gpr;</a>
<a name="ln1831">	float	values[2];</a>
<a name="ln1832"> </a>
<a name="ln1833">	LOG((&quot;emuxki_gpr_new\n&quot;));</a>
<a name="ln1834"> </a>
<a name="ln1835">	gpr = &amp;card-&gt;gpr[*gpr_num];</a>
<a name="ln1836">	strncpy(gpr-&gt;name, name, 32);</a>
<a name="ln1837">	gpr-&gt;type = type;</a>
<a name="ln1838">	gpr-&gt;gpr = *gpr_num;</a>
<a name="ln1839">	gpr-&gt;default_value = default_value;</a>
<a name="ln1840">	gpr-&gt;min_gain = min_gain;</a>
<a name="ln1841">	gpr-&gt;max_gain = max_gain;</a>
<a name="ln1842">	gpr-&gt;granularity = granularity;</a>
<a name="ln1843">	gpr-&gt;mute = false;</a>
<a name="ln1844">	(*gpr_num)++;</a>
<a name="ln1845">	if (gpr-&gt;type &amp; EMU_MIX_STEREO)</a>
<a name="ln1846">		(*gpr_num)++;</a>
<a name="ln1847"> </a>
<a name="ln1848">	if (default_mute == 1.0) {</a>
<a name="ln1849">		values[0] = default_mute;</a>
<a name="ln1850">		emuxki_gpr_set(card, gpr, EMU_MIX_MUTE, values);</a>
<a name="ln1851">	}</a>
<a name="ln1852"> </a>
<a name="ln1853">	values[0] = gpr-&gt;default_value;</a>
<a name="ln1854">	if (gpr-&gt;type &amp; EMU_MIX_STEREO)</a>
<a name="ln1855">		values[1] = gpr-&gt;default_value;</a>
<a name="ln1856">	emuxki_gpr_set(card, gpr, EMU_MIX_GAIN, values);</a>
<a name="ln1857"> </a>
<a name="ln1858"> </a>
<a name="ln1859">	return gpr;</a>
<a name="ln1860">}</a>
<a name="ln1861"> </a>
<a name="ln1862">/* Emuxki parameter */</a>
<a name="ln1863"> </a>
<a name="ln1864">void</a>
<a name="ln1865">emuxki_parameter_set(emuxki_dev *card, const void* cookie, int32 type, int32 *value)</a>
<a name="ln1866">{</a>
<a name="ln1867">	emuxki_stream *stream;</a>
<a name="ln1868">	emuxki_voice *voice;</a>
<a name="ln1869">	LOG((&quot;emuxki_parameter_set\n&quot;));</a>
<a name="ln1870"> </a>
<a name="ln1871">	switch(type) {</a>
<a name="ln1872">		case EMU_DIGITAL_MODE:</a>
<a name="ln1873">			card-&gt;digital_enabled = *value == 1;</a>
<a name="ln1874">			if (IS_AUDIGY(&amp;card-&gt;config))</a>
<a name="ln1875">				if (IS_AUDIGY2(&amp;card-&gt;config)) {</a>
<a name="ln1876">					// this disables analog, not enough</a>
<a name="ln1877">					emuxki_reg_write_32(&amp;card-&gt;config, EMU_A_IOCFG,</a>
<a name="ln1878">						(card-&gt;digital_enabled ? 0 : EMU_A_IOCFG_GPOUT0) |</a>
<a name="ln1879">							(emuxki_reg_read_32(&amp;card-&gt;config, EMU_A_IOCFG)</a>
<a name="ln1880">							&amp; ~(EMU_A_IOCFG_GPOUT0 | EMU_A_IOCFG_GPOUT1) ) );</a>
<a name="ln1881">				} else {</a>
<a name="ln1882">					// this disables analog, and enables digital</a>
<a name="ln1883">					emuxki_reg_write_32(&amp;card-&gt;config, EMU_A_IOCFG,</a>
<a name="ln1884">						(card-&gt;digital_enabled ? EMU_A_IOCFG_GPOUT0 | EMU_A_IOCFG_GPOUT1 : 0) |</a>
<a name="ln1885">							(emuxki_reg_read_32(&amp;card-&gt;config, EMU_A_IOCFG)</a>
<a name="ln1886">							&amp; ~(EMU_A_IOCFG_GPOUT0 | EMU_A_IOCFG_GPOUT1) ) );</a>
<a name="ln1887">				}</a>
<a name="ln1888">			else {</a>
<a name="ln1889">				// this enables digital, not enough</a>
<a name="ln1890">				emuxki_reg_write_32(&amp;card-&gt;config, EMU_HCFG,</a>
<a name="ln1891">					(card-&gt;digital_enabled ? EMU_HCFG_GPOUTPUT0 : 0) |</a>
<a name="ln1892">					(emuxki_reg_read_32(&amp;card-&gt;config, EMU_HCFG) &amp; ~EMU_HCFG_GPOUTPUT0));</a>
<a name="ln1893">			}</a>
<a name="ln1894"> </a>
<a name="ln1895">			break;</a>
<a name="ln1896">		case EMU_AUDIO_MODE:</a>
<a name="ln1897">			if (*value!=0 &amp;&amp; *value!=1 &amp;&amp; *value!=2) {</a>
<a name="ln1898">				PRINT((&quot;emuxki_parameter_set error value unexpected\n&quot;));</a>
<a name="ln1899">				return;</a>
<a name="ln1900">			}</a>
<a name="ln1901">			card-&gt;play_mode = (*value + 1) * 2;</a>
<a name="ln1902">			LIST_FOREACH(stream, &amp;card-&gt;streams, next) {</a>
<a name="ln1903">				if ((stream-&gt;use &amp; EMU_USE_PLAY) == 0 ||</a>
<a name="ln1904">					(stream-&gt;state &amp; EMU_STATE_STARTED) == 0)</a>
<a name="ln1905">						continue;</a>
<a name="ln1906">				LIST_FOREACH(voice, &amp;stream-&gt;voices, next) {</a>
<a name="ln1907">					emuxki_voice_fxupdate(voice);</a>
<a name="ln1908">					emuxki_channel_commit_fx(voice-&gt;dataloc.chan[0]);</a>
<a name="ln1909">					if (voice-&gt;stereo)</a>
<a name="ln1910">						emuxki_channel_commit_fx(voice-&gt;dataloc.chan[1]);</a>
<a name="ln1911">				}</a>
<a name="ln1912">			}</a>
<a name="ln1913">			break;</a>
<a name="ln1914">	}</a>
<a name="ln1915">}</a>
<a name="ln1916"> </a>
<a name="ln1917"> </a>
<a name="ln1918">void</a>
<a name="ln1919">emuxki_parameter_get(emuxki_dev *card, const void* cookie, int32 type, int32 *value)</a>
<a name="ln1920">{</a>
<a name="ln1921">	LOG((&quot;emuxki_parameter_get\n&quot;));</a>
<a name="ln1922"> </a>
<a name="ln1923">	switch(type) {</a>
<a name="ln1924">		case EMU_DIGITAL_MODE:</a>
<a name="ln1925">			*value = card-&gt;digital_enabled ? 1 : 0;</a>
<a name="ln1926">			break;</a>
<a name="ln1927">		case EMU_AUDIO_MODE:</a>
<a name="ln1928">			*value = card-&gt;play_mode / 2 - 1;</a>
<a name="ln1929">			break;</a>
<a name="ln1930">	}</a>
<a name="ln1931">}</a>
<a name="ln1932"> </a>
<a name="ln1933"> </a>
<a name="ln1934">/* Emuxki interrupt */</a>
<a name="ln1935">static int32</a>
<a name="ln1936">emuxki_int(void *arg)</a>
<a name="ln1937">{</a>
<a name="ln1938">	emuxki_dev	 *card = arg;</a>
<a name="ln1939">	uint32       ipr, curblk;</a>
<a name="ln1940">	bool gotone = false;</a>
<a name="ln1941">	emuxki_voice *voice;</a>
<a name="ln1942">	emuxki_stream *stream;</a>
<a name="ln1943"> </a>
<a name="ln1944">	while ((ipr = emuxki_reg_read_32(&amp;card-&gt;config, EMU_IPR))) {</a>
<a name="ln1945">		gotone = true;</a>
<a name="ln1946">		if (ipr &amp; EMU_IPR_INTERVALTIMER) {</a>
<a name="ln1947">			//TRACE((&quot;EMU_IPR_INTERVALTIMER\n&quot;));</a>
<a name="ln1948">			LIST_FOREACH(stream, &amp;card-&gt;streams, next) {</a>
<a name="ln1949">				if ((stream-&gt;use &amp; EMU_USE_PLAY) == 0 ||</a>
<a name="ln1950">					(stream-&gt;state &amp; EMU_STATE_STARTED) == 0 ||</a>
<a name="ln1951">					(stream-&gt;inth == NULL))</a>
<a name="ln1952">						continue;</a>
<a name="ln1953"> </a>
<a name="ln1954">				voice = stream-&gt;first_voice;</a>
<a name="ln1955">				//TRACE((&quot;voice %p\n&quot;, voice));</a>
<a name="ln1956">				curblk = emuxki_voice_curaddr(voice) /</a>
<a name="ln1957">				       voice-&gt;blksize;</a>
<a name="ln1958">				//TRACE((&quot;EMU_IPR_INTERVALTIMER at trigblk %lu\n&quot;, curblk));</a>
<a name="ln1959">				//TRACE((&quot;EMU_IPR_INTERVALTIMER at voice-&gt;trigblk %lu\n&quot;, voice-&gt;trigblk));</a>
<a name="ln1960">				if (curblk == voice-&gt;trigblk) {</a>
<a name="ln1961">					//TRACE((&quot;EMU_IPR_INTERVALTIMER at trigblk %lu\n&quot;, curblk));</a>
<a name="ln1962">					//dump_voice(voice);</a>
<a name="ln1963">					//trace_hardware_regs(&amp;card-&gt;config);</a>
<a name="ln1964">					//TRACE((&quot;voice pointer %p\n&quot;, voice));</a>
<a name="ln1965"> </a>
<a name="ln1966">					if (stream-&gt;inth)</a>
<a name="ln1967">						stream-&gt;inth(stream-&gt;inthparam);</a>
<a name="ln1968"> </a>
<a name="ln1969">					voice-&gt;trigblk++;</a>
<a name="ln1970">					voice-&gt;trigblk %= voice-&gt;blkmod;</a>
<a name="ln1971">				}</a>
<a name="ln1972">			}</a>
<a name="ln1973">		}</a>
<a name="ln1974">#if MIDI</a>
<a name="ln1975">		if (ipr &amp; (EMU_IPR_MIDIRECVBUFE)) {</a>
<a name="ln1976">			midi_interrupt(card);          /* Gameport */</a>
<a name="ln1977">		}</a>
<a name="ln1978"> </a>
<a name="ln1979">		if (ipr &amp; (EMU_IPR_MIDITRANSBUFE)) {</a>
<a name="ln1980">			if (!midi_interrupt(card)) {</a>
<a name="ln1981">				emuxki_inte_disable(&amp;card-&gt;config, EMU_INTE_MIDITXENABLE);</a>
<a name="ln1982">				TRACE((&quot;EMU_INTE_MIDITXENABLE disabled\n&quot;));</a>
<a name="ln1983">			}</a>
<a name="ln1984">		}</a>
<a name="ln1985">#endif</a>
<a name="ln1986">		if (ipr &amp; (EMU_IPR_ADCBUFHALFFULL | EMU_IPR_ADCBUFFULL</a>
<a name="ln1987">			| EMU_IPR_MICBUFHALFFULL | EMU_IPR_MICBUFFULL</a>
<a name="ln1988">			| EMU_IPR_EFXBUFHALFFULL | EMU_IPR_EFXBUFFULL)) {</a>
<a name="ln1989">			//TRACE((&quot;EMU_IPR_ADCBUF\n&quot;));</a>
<a name="ln1990">			LIST_FOREACH(stream, &amp;card-&gt;streams, next) {</a>
<a name="ln1991">				if ((stream-&gt;use &amp; EMU_USE_RECORD) == 0 ||</a>
<a name="ln1992">					(stream-&gt;state &amp; EMU_STATE_STARTED) == 0 ||</a>
<a name="ln1993">					(stream-&gt;inth == NULL) ||</a>
<a name="ln1994">					(stream-&gt;first_voice == NULL))</a>
<a name="ln1995">						continue;</a>
<a name="ln1996">				voice = stream-&gt;first_voice;</a>
<a name="ln1997">				curblk = emuxki_voice_curaddr(voice) /</a>
<a name="ln1998">				       voice-&gt;blksize;</a>
<a name="ln1999">				//TRACE((&quot;EMU_IPR_ADCBUF at trigblk %lu\n&quot;, curblk));</a>
<a name="ln2000">				//TRACE((&quot;EMU_IPR_ADCBUF at voice-&gt;trigblk %lu\n&quot;, voice-&gt;trigblk));</a>
<a name="ln2001">				if (curblk == voice-&gt;trigblk) {</a>
<a name="ln2002">					//TRACE((&quot;EMU_IPR_ADCBUF at trigblk %lu\n&quot;, curblk));</a>
<a name="ln2003">					//dump_voice(voice);</a>
<a name="ln2004">					//trace_hardware_regs(&amp;card-&gt;config);</a>
<a name="ln2005"> </a>
<a name="ln2006">					if (stream-&gt;inth)</a>
<a name="ln2007">						stream-&gt;inth(stream-&gt;inthparam);</a>
<a name="ln2008"> </a>
<a name="ln2009">					voice-&gt;trigblk++;</a>
<a name="ln2010">					voice-&gt;trigblk %= voice-&gt;blkmod;</a>
<a name="ln2011">				}</a>
<a name="ln2012">			}</a>
<a name="ln2013">		}</a>
<a name="ln2014"> </a>
<a name="ln2015">		/*if (ipr &amp; (EMU_IPR_CHANNELLOOP)) {</a>
<a name="ln2016">			TRACE((&quot;EMU_IPR_CHANNELLOOP pending channel : %u\n&quot;, ipr &amp; EMU_IPR_CHNOMASK));</a>
<a name="ln2017">			LIST_FOREACH(stream, &amp;card-&gt;streams, next)</a>
<a name="ln2018">			LIST_FOREACH(voice, &amp;stream-&gt;voices, next) {</a>
<a name="ln2019">				if ((voice-&gt;use &amp; EMU_USE_PLAY) == 0 ||</a>
<a name="ln2020">					(voice-&gt;state &amp; EMU_STATE_STARTED) == 0)</a>
<a name="ln2021">						continue;</a>
<a name="ln2022">				TRACE((&quot;EMU_IPR_CHANNELLOOP at trigblk %lu\n&quot;, emuxki_voice_curaddr(voice)));</a>
<a name="ln2023">				TRACE((&quot;EMU_IPR_CHANNELLOOP read %x\n&quot;, emuxki_chan_read(&amp;voice-&gt;card-&gt;config, 0, EMU_CLIPL)));</a>
<a name="ln2024">				emuxki_chan_write(&amp;voice-&gt;card-&gt;config, 0, EMU_CLIPL, emuxki_chan_read(&amp;voice-&gt;card-&gt;config, 0, EMU_CLIPL));</a>
<a name="ln2025">			}</a>
<a name="ln2026">		}*/</a>
<a name="ln2027"> </a>
<a name="ln2028">		if (ipr &amp; ~(EMU_IPR_RATETRCHANGE | EMU_IPR_INTERVALTIMER</a>
<a name="ln2029">				| EMU_IPR_MIDITRANSBUFE | EMU_IPR_MIDIRECVBUFE</a>
<a name="ln2030">				| EMU_IPR_ADCBUFHALFFULL | EMU_IPR_ADCBUFFULL</a>
<a name="ln2031">				| EMU_IPR_MICBUFHALFFULL | EMU_IPR_MICBUFFULL</a>
<a name="ln2032">				| EMU_IPR_EFXBUFHALFFULL | EMU_IPR_EFXBUFFULL))</a>
<a name="ln2033">			TRACE((&quot;Got interrupt 0x%08x !!!\n&quot;,</a>
<a name="ln2034">			       ipr &amp; ~(EMU_IPR_RATETRCHANGE |</a>
<a name="ln2035">				       EMU_IPR_INTERVALTIMER)));</a>
<a name="ln2036"> </a>
<a name="ln2037">		emuxki_reg_write_32(&amp;card-&gt;config, EMU_IPR, ipr);</a>
<a name="ln2038">	}</a>
<a name="ln2039"> </a>
<a name="ln2040">	if (IS_AUDIGY2(&amp;card-&gt;config)) {</a>
<a name="ln2041">		while ((ipr = emuxki_reg_read_32(&amp;card-&gt;config, EMU_A2_IPR2))) {</a>
<a name="ln2042">			emuxki_reg_write_32(&amp;card-&gt;config, EMU_A2_IPR2, ipr);</a>
<a name="ln2043">			break;	// avoid loop</a>
<a name="ln2044">		}</a>
<a name="ln2045"> </a>
<a name="ln2046">		if (!IS_AUDIGY2_VALUE(&amp;card-&gt;config)) {</a>
<a name="ln2047">			while ((ipr = emuxki_reg_read_32(&amp;card-&gt;config, EMU_A2_IPR3))) {</a>
<a name="ln2048">				emuxki_reg_write_32(&amp;card-&gt;config, EMU_A2_IPR3, ipr);</a>
<a name="ln2049">				break; // avoid loop</a>
<a name="ln2050">			}</a>
<a name="ln2051">		}</a>
<a name="ln2052">	}</a>
<a name="ln2053"> </a>
<a name="ln2054">	if (gotone)</a>
<a name="ln2055">		return B_INVOKE_SCHEDULER;</a>
<a name="ln2056"> </a>
<a name="ln2057">	TRACE((&quot;Got unhandled interrupt\n&quot;));</a>
<a name="ln2058">	return B_UNHANDLED_INTERRUPT;</a>
<a name="ln2059">}</a>
<a name="ln2060"> </a>
<a name="ln2061"> </a>
<a name="ln2062"> </a>
<a name="ln2063">/*	Emu10k1 driver functions */</a>
<a name="ln2064"> </a>
<a name="ln2065"> </a>
<a name="ln2066">/* detect presence of our hardware */</a>
<a name="ln2067">status_t</a>
<a name="ln2068">init_hardware(void)</a>
<a name="ln2069">{</a>
<a name="ln2070">	int ix = 0;</a>
<a name="ln2071">	pci_info info;</a>
<a name="ln2072">//	uint32 buffer;</a>
<a name="ln2073">	status_t err = ENODEV;</a>
<a name="ln2074"> </a>
<a name="ln2075">	LOG_CREATE();</a>
<a name="ln2076"> </a>
<a name="ln2077">	PRINT((&quot;init_hardware()\n&quot;));</a>
<a name="ln2078"> </a>
<a name="ln2079">	if (get_module(B_PCI_MODULE_NAME, (module_info **)&amp;pci))</a>
<a name="ln2080">		return ENOSYS;</a>
<a name="ln2081"> </a>
<a name="ln2082">	while ((*pci-&gt;get_nth_pci_info)(ix, &amp;info) == B_OK) {</a>
<a name="ln2083">		if (info.vendor_id == CREATIVELABS_VENDOR_ID &amp;&amp;</a>
<a name="ln2084">			(info.device_id == CREATIVELABS_SBLIVE_DEVICE_ID</a>
<a name="ln2085">#if AUDIGY</a>
<a name="ln2086">			|| info.device_id == CREATIVELABS_AUDIGY_DEVICE_ID</a>
<a name="ln2087">			|| info.device_id == CREATIVELABS_AUDIGY2_VALUE_DEVICE_ID</a>
<a name="ln2088">#endif</a>
<a name="ln2089">			)) {</a>
<a name="ln2090">			err = B_OK;</a>
<a name="ln2091"> </a>
<a name="ln2092">/*</a>
<a name="ln2093">			Joystick suport</a>
<a name="ln2094">			if (!(info.u.h0.subsystem_id == 0x20 ||</a>
<a name="ln2095">					info.u.h0.subsystem_id == 0xc400 ||</a>
<a name="ln2096"> 					(info.u.h0.subsystem_id == 0x21 &amp;&amp; info.revision &lt; 6))) {</a>
<a name="ln2097">	    		buffer = (*pci-&gt;read_io_32)(info.u.h0.base_registers[0] + HCFG);</a>
<a name="ln2098">	    		buffer |= HCFG_JOYENABLE;</a>
<a name="ln2099">	    		(*pci-&gt;write_io_32)(info.u.h0.base_registers[0] + HCFG, buffer);</a>
<a name="ln2100">	   		}*/</a>
<a name="ln2101">		}</a>
<a name="ln2102">		ix++;</a>
<a name="ln2103">	}</a>
<a name="ln2104"> </a>
<a name="ln2105">	put_module(B_PCI_MODULE_NAME);</a>
<a name="ln2106"> </a>
<a name="ln2107">	return err;</a>
<a name="ln2108">}</a>
<a name="ln2109"> </a>
<a name="ln2110"> </a>
<a name="ln2111">static void</a>
<a name="ln2112">make_device_names(</a>
<a name="ln2113">	emuxki_dev * card)</a>
<a name="ln2114">{</a>
<a name="ln2115">#if MIDI</a>
<a name="ln2116">	sprintf(card-&gt;midi.name, &quot;midi/emuxki/%ld&quot;, card-cards+1);</a>
<a name="ln2117">	names[num_names++] = card-&gt;midi.name;</a>
<a name="ln2118">#endif</a>
<a name="ln2119"> </a>
<a name="ln2120">//	sprintf(card-&gt;joy.name1, &quot;joystick/&quot;DRIVER_NAME &quot;/%x&quot;, card-cards+1);</a>
<a name="ln2121">//	names[num_names++] = card-&gt;joy.name1;</a>
<a name="ln2122"> </a>
<a name="ln2123">	sprintf(card-&gt;name, &quot;audio/hmulti/emuxki/%ld&quot;, card-cards+1);</a>
<a name="ln2124">	names[num_names++] = card-&gt;name;</a>
<a name="ln2125"> </a>
<a name="ln2126">	names[num_names] = NULL;</a>
<a name="ln2127">}</a>
<a name="ln2128"> </a>
<a name="ln2129"> </a>
<a name="ln2130">static status_t</a>
<a name="ln2131">emuxki_setup(emuxki_dev * card)</a>
<a name="ln2132">{</a>
<a name="ln2133">	status_t err = B_OK;</a>
<a name="ln2134">	unsigned char cmd;</a>
<a name="ln2135">	//int32 base;</a>
<a name="ln2136"> </a>
<a name="ln2137">	PRINT((&quot;setup_emuxki(%p)\n&quot;, card));</a>
<a name="ln2138"> </a>
<a name="ln2139">	make_device_names(card);</a>
<a name="ln2140">	card-&gt;config.nabmbar = card-&gt;info.u.h0.base_registers[0];</a>
<a name="ln2141">	card-&gt;config.irq = card-&gt;info.u.h0.interrupt_line;</a>
<a name="ln2142">	card-&gt;config.type = 0;</a>
<a name="ln2143">	if (card-&gt;info.device_id == CREATIVELABS_AUDIGY_DEVICE_ID) {</a>
<a name="ln2144">		card-&gt;config.type |= TYPE_AUDIGY;</a>
<a name="ln2145">		if (card-&gt;info.revision == 4)</a>
<a name="ln2146">			card-&gt;config.type |= TYPE_AUDIGY2;</a>
<a name="ln2147">	} else if (card-&gt;info.device_id == CREATIVELABS_AUDIGY2_VALUE_DEVICE_ID)</a>
<a name="ln2148">		card-&gt;config.type |= TYPE_AUDIGY | TYPE_AUDIGY2 | TYPE_AUDIGY2_VALUE;</a>
<a name="ln2149"> </a>
<a name="ln2150">	PRINT((&quot;%s deviceid = %#04x chiprev = %x model = %x enhanced at %lx\n&quot;, card-&gt;name, card-&gt;info.device_id,</a>
<a name="ln2151">		card-&gt;info.revision, card-&gt;info.u.h0.subsystem_id, card-&gt;config.nabmbar));</a>
<a name="ln2152"> </a>
<a name="ln2153">	cmd = (*pci-&gt;read_pci_config)(card-&gt;info.bus, card-&gt;info.device, card-&gt;info.function, PCI_command, 2);</a>
<a name="ln2154">	PRINT((&quot;PCI command before: %x\n&quot;, cmd));</a>
<a name="ln2155">	(*pci-&gt;write_pci_config)(card-&gt;info.bus, card-&gt;info.device, card-&gt;info.function, PCI_command, 2, cmd | PCI_command_io);</a>
<a name="ln2156">	cmd = (*pci-&gt;read_pci_config)(card-&gt;info.bus, card-&gt;info.device, card-&gt;info.function, PCI_command, 2);</a>
<a name="ln2157">	PRINT((&quot;PCI command after: %x\n&quot;, cmd));</a>
<a name="ln2158"> </a>
<a name="ln2159">	dump_hardware_regs(&amp;card-&gt;config);</a>
<a name="ln2160"> </a>
<a name="ln2161">	emuxki_reg_write_32(&amp;card-&gt;config, EMU_HCFG, EMU_HCFG_LOCKSOUNDCACHE | EMU_HCFG_LOCKTANKCACHE_MASK|</a>
<a name="ln2162">		EMU_HCFG_MUTEBUTTONENABLE);</a>
<a name="ln2163"> </a>
<a name="ln2164">	dump_hardware_regs(&amp;card-&gt;config);</a>
<a name="ln2165"> </a>
<a name="ln2166">#if MIDI</a>
<a name="ln2167">	//SBLIVE : EMU_MUDATA, workaround 0, AUDIGY, AUDIGY2: 0, workaround 0x11020004</a>
<a name="ln2168">	if ((err = (*mpu401-&gt;create_device)((card-&gt;config.nabmbar + !IS_AUDIGY(&amp;card-&gt;config) ? EMU_MUDATA : 0),</a>
<a name="ln2169">		&amp;card-&gt;midi.driver, !IS_AUDIGY(&amp;card-&gt;config) ? 0 : 0x11020004, midi_interrupt_op, &amp;card-&gt;midi)) &lt; B_OK)</a>
<a name="ln2170">		return (err);</a>
<a name="ln2171"> </a>
<a name="ln2172">	card-&gt;midi.card = card;</a>
<a name="ln2173">#endif</a>
<a name="ln2174"> </a>
<a name="ln2175">	// begin Joystick part</a>
<a name="ln2176">/*	base = card-&gt;info.u.h0.base_registers[0];</a>
<a name="ln2177">	(*pci-&gt;write_pci_config) (card-&gt;info.bus,card-&gt;info.device,</a>
<a name="ln2178">			card-&gt;info.function, 0x10, 2, base);</a>
<a name="ln2179"> </a>
<a name="ln2180">	if ((*gameport-&gt;create_device)(base, &amp;card-&gt;joy.driver) &lt; B_OK) {</a>
<a name="ln2181">		dprintf(&quot;Audigy joystick - Error creating device\n&quot;);</a>
<a name="ln2182">		(*gameport-&gt;delete_device)(card-&gt;joy.driver);</a>
<a name="ln2183">	}*/</a>
<a name="ln2184">	// end Joystick part</a>
<a name="ln2185"> </a>
<a name="ln2186">	/* reset the codec */</a>
<a name="ln2187">	PRINT((&quot;codec reset\n&quot;));</a>
<a name="ln2188">	emuxki_codec_write(&amp;card-&gt;config, 0x00, 0x0000);</a>
<a name="ln2189">	snooze(50000); // 50 ms</a>
<a name="ln2190"> </a>
<a name="ln2191">	ac97_init(&amp;card-&gt;config);</a>
<a name="ln2192">	ac97_amp_enable(&amp;card-&gt;config, true);</a>
<a name="ln2193"> </a>
<a name="ln2194">	PRINT((&quot;codec vendor id      = %#08lx\n&quot;,ac97_get_vendor_id(&amp;card-&gt;config)));</a>
<a name="ln2195">	PRINT((&quot;codec description     = %s\n&quot;,ac97_get_vendor_id_description(&amp;card-&gt;config)));</a>
<a name="ln2196">	PRINT((&quot;codec 3d enhancement = %s\n&quot;,ac97_get_3d_stereo_enhancement(&amp;card-&gt;config)));</a>
<a name="ln2197"> </a>
<a name="ln2198">	if (IS_AUDIGY2(&amp;card-&gt;config)) {</a>
<a name="ln2199">		emuxki_reg_write_32(&amp;card-&gt;config, EMU_A_IOCFG,</a>
<a name="ln2200">			EMU_A_IOCFG_GPOUT0 | emuxki_reg_read_32(&amp;card-&gt;config, EMU_A_IOCFG));</a>
<a name="ln2201">	}</a>
<a name="ln2202"> </a>
<a name="ln2203">	dump_hardware_regs(&amp;card-&gt;config);</a>
<a name="ln2204"> </a>
<a name="ln2205">	/*PRINT((&quot;codec master output = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, 0x02)));</a>
<a name="ln2206">	PRINT((&quot;codec aux output    = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, 0x04)));</a>
<a name="ln2207">	PRINT((&quot;codec mono output   = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, 0x06)));</a>
<a name="ln2208">	PRINT((&quot;codec pcm output    = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, 0x18)));</a>
<a name="ln2209">	PRINT((&quot;codec line in	    = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, 0x10)));</a>
<a name="ln2210">	PRINT((&quot;codec record line in= %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, 0x1a)));</a>
<a name="ln2211">	PRINT((&quot;codec record gain   = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, 0x1c)));*/</a>
<a name="ln2212"> </a>
<a name="ln2213">	/*PRINT((&quot;adc index	    = %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_ADCIDX, 0)));</a>
<a name="ln2214">	PRINT((&quot;micro index 	= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_MICIDX, 0)));</a>
<a name="ln2215">	PRINT((&quot;fx index   		= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_FXIDX, 0)));</a>
<a name="ln2216">	PRINT((&quot;adc addr	    = %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_ADCBA, 0)));</a>
<a name="ln2217">	PRINT((&quot;micro addr 		= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_MICBA, 0)));</a>
<a name="ln2218">	PRINT((&quot;fx addr   		= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_FXBA, 0)));</a>
<a name="ln2219">	PRINT((&quot;adc size	    = %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_ADCBS, 0)));</a>
<a name="ln2220">	PRINT((&quot;micro size 		= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_MICBS, 0)));</a>
<a name="ln2221">	PRINT((&quot;fx size   		= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_FXBS, 0)));</a>
<a name="ln2222"> </a>
<a name="ln2223">	PRINT((&quot;EMU_ADCCR   		= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_ADCCR, 0)));</a>
<a name="ln2224">	PRINT((&quot;EMU_FXWC   		= %#08x\n&quot;,emuxki_chan_read(&amp;card-&gt;config, EMU_FXWC, 0)));</a>
<a name="ln2225">	PRINT((&quot;EMU_FXWC   		= %#08x\n&quot;,emuxki_reg_read_32(&amp;card-&gt;config, EMU_FXWC)));*/</a>
<a name="ln2226"> </a>
<a name="ln2227">	PRINT((&quot;writing codec registers\n&quot;));</a>
<a name="ln2228">	// TODO : to move with AC97</a>
<a name="ln2229">	/* enable master output */</a>
<a name="ln2230">	emuxki_codec_write(&amp;card-&gt;config, AC97_MASTER_VOLUME, 0x0000);</a>
<a name="ln2231">	/* enable aux output */</a>
<a name="ln2232">	emuxki_codec_write(&amp;card-&gt;config, AC97_AUX_OUT_VOLUME, 0x0000);</a>
<a name="ln2233">	/* enable mono output */</a>
<a name="ln2234">	//emuxki_codec_write(&amp;card-&gt;config, AC97_MONO_VOLUME, 0x0004);</a>
<a name="ln2235">	/* enable pcm output */</a>
<a name="ln2236">	emuxki_codec_write(&amp;card-&gt;config, AC97_PCM_OUT_VOLUME, 0x0808);</a>
<a name="ln2237">	/* enable line in */</a>
<a name="ln2238">	//emuxki_codec_write(&amp;card-&gt;config, AC97_LINE_IN_VOLUME, 0x8808);</a>
<a name="ln2239">	/* set record line in */</a>
<a name="ln2240">	emuxki_codec_write(&amp;card-&gt;config, AC97_RECORD_SELECT, 0x0404);</a>
<a name="ln2241">	/* set record gain */</a>
<a name="ln2242">	//emuxki_codec_write(&amp;card-&gt;config, AC97_RECORD_GAIN, 0x0000);</a>
<a name="ln2243"> </a>
<a name="ln2244">	PRINT((&quot;codec master output = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, AC97_MASTER_VOLUME)));</a>
<a name="ln2245">	PRINT((&quot;codec aux output    = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, AC97_AUX_OUT_VOLUME)));</a>
<a name="ln2246">	PRINT((&quot;codec mono output   = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, AC97_MONO_VOLUME)));</a>
<a name="ln2247">	PRINT((&quot;codec pcm output    = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, AC97_PCM_OUT_VOLUME)));</a>
<a name="ln2248">	PRINT((&quot;codec line in	    = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, AC97_LINE_IN_VOLUME)));</a>
<a name="ln2249">	PRINT((&quot;codec record line in= %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, AC97_RECORD_SELECT)));</a>
<a name="ln2250">	PRINT((&quot;codec record gain   = %#04x\n&quot;,emuxki_codec_read(&amp;card-&gt;config, AC97_RECORD_GAIN)));</a>
<a name="ln2251"> </a>
<a name="ln2252">	if (emuxki_codec_read(&amp;card-&gt;config, AC97_EXTENDED_AUDIO_ID) &amp; 0x0080) {</a>
<a name="ln2253">		card-&gt;config.type |= TYPE_LIVE_5_1;</a>
<a name="ln2254">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_AC97SLOT, EMU_AC97SLOT_CENTER | EMU_AC97SLOT_LFE);</a>
<a name="ln2255">		emuxki_codec_write(&amp;card-&gt;config, AC97_SURROUND_VOLUME, 0x0000);</a>
<a name="ln2256">	}</a>
<a name="ln2257"> </a>
<a name="ln2258">	if ((err = emuxki_init(card)))</a>
<a name="ln2259">		return (err);</a>
<a name="ln2260"> </a>
<a name="ln2261">	if (IS_AUDIGY(&amp;card-&gt;config) || IS_LIVE_5_1(&amp;card-&gt;config)) {</a>
<a name="ln2262">		card-&gt;play_mode = 6;	// mode 5.1</a>
<a name="ln2263">	} else {</a>
<a name="ln2264">		card-&gt;play_mode = 4;	// mode 4.0</a>
<a name="ln2265">	}</a>
<a name="ln2266"> </a>
<a name="ln2267">	emuxki_reg_write_32(&amp;card-&gt;config, EMU_INTE, EMU_INTE_SAMPLERATER | EMU_INTE_PCIERRENABLE);</a>
<a name="ln2268">	if (IS_AUDIGY2(&amp;card-&gt;config)) {</a>
<a name="ln2269">		emuxki_reg_write_32(&amp;card-&gt;config, EMU_A2_INTE2, 0);</a>
<a name="ln2270">		if (!IS_AUDIGY2_VALUE(&amp;card-&gt;config)) {</a>
<a name="ln2271">			emuxki_reg_write_32(&amp;card-&gt;config, EMU_A2_INTE3, 0);</a>
<a name="ln2272">		}</a>
<a name="ln2273">	}</a>
<a name="ln2274"> </a>
<a name="ln2275">	PRINT((&quot;installing interrupt : %lx\n&quot;, card-&gt;config.irq));</a>
<a name="ln2276">	err = install_io_interrupt_handler(card-&gt;config.irq, emuxki_int, card, 0);</a>
<a name="ln2277">	if (err != B_OK) {</a>
<a name="ln2278">		PRINT((&quot;failed to install interrupt\n&quot;));</a>
<a name="ln2279">		emuxki_shutdown(card);</a>
<a name="ln2280">		return err;</a>
<a name="ln2281">	}</a>
<a name="ln2282"> </a>
<a name="ln2283">	emuxki_inte_enable(&amp;card-&gt;config, EMU_INTE_VOLINCRENABLE | EMU_INTE_VOLDECRENABLE</a>
<a name="ln2284">		| EMU_INTE_MUTEENABLE | EMU_INTE_FXDSPENABLE);</a>
<a name="ln2285">	if (IS_AUDIGY2(&amp;card-&gt;config)) {</a>
<a name="ln2286">		emuxki_reg_write_32(&amp;card-&gt;config, EMU_HCFG, EMU_HCFG_AUDIOENABLE |</a>
<a name="ln2287">			EMU_HCFG_AC3ENABLE_CDSPDIF | EMU_HCFG_AC3ENABLE_GPSPDIF|</a>
<a name="ln2288">			EMU_HCFG_JOYENABLE | EMU_HCFG_AUTOMUTE);</a>
<a name="ln2289">	} else if (IS_AUDIGY(&amp;card-&gt;config)) {</a>
<a name="ln2290">		emuxki_reg_write_32(&amp;card-&gt;config, EMU_HCFG, EMU_HCFG_AUDIOENABLE |</a>
<a name="ln2291">			EMU_HCFG_JOYENABLE | EMU_HCFG_AUTOMUTE);</a>
<a name="ln2292">	} else {</a>
<a name="ln2293">		emuxki_reg_write_32(&amp;card-&gt;config, EMU_HCFG, EMU_HCFG_AUDIOENABLE |</a>
<a name="ln2294">			EMU_HCFG_LOCKTANKCACHE_MASK | EMU_HCFG_JOYENABLE | EMU_HCFG_AUTOMUTE);</a>
<a name="ln2295">	}</a>
<a name="ln2296"> </a>
<a name="ln2297">	PRINT((&quot;setup_emuxki done\n&quot;));</a>
<a name="ln2298"> </a>
<a name="ln2299">	return err;</a>
<a name="ln2300">}</a>
<a name="ln2301"> </a>
<a name="ln2302"> </a>
<a name="ln2303">void</a>
<a name="ln2304">emuxki_dump_fx(emuxki_dev * card)</a>
<a name="ln2305">{</a>
<a name="ln2306">	uint16      pc = 0;</a>
<a name="ln2307">	uint8		op;</a>
<a name="ln2308">	uint16		r,a,x,y,zero;</a>
<a name="ln2309"> </a>
<a name="ln2310">	LOG((&quot;emuxki_dump_fx\n&quot;));</a>
<a name="ln2311"> </a>
<a name="ln2312">	zero = IS_AUDIGY(&amp;card-&gt;config) ? EMU_A_DSP_CST(0) : EMU_DSP_CST(0);</a>
<a name="ln2313"> </a>
<a name="ln2314">	while (pc &lt; 512) {</a>
<a name="ln2315">		emuxki_dsp_getop(&amp;card-&gt;config, &amp;pc, &amp;op, &amp;r, &amp;a, &amp;x, &amp;y);</a>
<a name="ln2316">		if (op!=EMU_DSP_OP_ACC3 || r!=zero || a!=zero || x!=zero || y!=zero) {</a>
<a name="ln2317">			LOG((&quot;dsp_op pc=%u, op=%x, r=%x, a=%x, x=%x, y=%x\n&quot;,</a>
<a name="ln2318">				pc, op, r, a, x, y));</a>
<a name="ln2319">		}</a>
<a name="ln2320">	}</a>
<a name="ln2321">}</a>
<a name="ln2322"> </a>
<a name="ln2323"> </a>
<a name="ln2324">static void</a>
<a name="ln2325">emuxki_initfx(emuxki_dev * card)</a>
<a name="ln2326">{</a>
<a name="ln2327">	uint16       pc, gpr;</a>
<a name="ln2328">	emuxki_gpr *a_front_gpr, *a_rear_gpr, *a_center_sub_gpr = NULL;</a>
<a name="ln2329">	emuxki_gpr *p_ac97_in_gpr, *p_cd_in_gpr, *r_ac97_in_gpr, *r_cd_in_gpr, *r_fx_out_gpr;</a>
<a name="ln2330">	emuxki_gpr *d_front_gpr, *d_rear_gpr, *d_center_sub_gpr;</a>
<a name="ln2331"> </a>
<a name="ln2332">	/* Set all GPRs to 0 */</a>
<a name="ln2333">	for (pc = 0; pc &lt; 256; pc++) {</a>
<a name="ln2334">		emuxki_write_gpr(&amp;card-&gt;config, pc, 0);</a>
<a name="ln2335">		card-&gt;gpr[pc].gpr = -1;</a>
<a name="ln2336">	}</a>
<a name="ln2337"> </a>
<a name="ln2338">	for (pc = 0; pc &lt; 160; pc++) {</a>
<a name="ln2339">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_TANKMEMDATAREGBASE + pc, 0);</a>
<a name="ln2340">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_TANKMEMADDRREGBASE + pc, 0);</a>
<a name="ln2341">	}</a>
<a name="ln2342">	pc = 0;</a>
<a name="ln2343">	gpr = EMU_GPR_FIRST_MIX;	// we reserve 16 gprs for processing</a>
<a name="ln2344">#define EMU_DSP_TMPGPR_FRONT_LEFT 0</a>
<a name="ln2345">#define EMU_DSP_TMPGPR_FRONT_RIGHT 1</a>
<a name="ln2346">#define EMU_DSP_TMPGPR_REAR_LEFT 2</a>
<a name="ln2347">#define EMU_DSP_TMPGPR_REAR_RIGHT 3</a>
<a name="ln2348">#define EMU_DSP_TMPGPR_CENTER 4</a>
<a name="ln2349">#define EMU_DSP_TMPGPR_SUB 5</a>
<a name="ln2350">#define EMU_DSP_TMPGPR_DSP_IN_L	6</a>
<a name="ln2351">#define EMU_DSP_TMPGPR_DSP_IN_R	7</a>
<a name="ln2352"> </a>
<a name="ln2353">	a_front_gpr = emuxki_gpr_new(card, &quot;Analog Front&quot;,</a>
<a name="ln2354">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2355">	a_rear_gpr = emuxki_gpr_new(card, &quot;Analog Rear&quot;,</a>
<a name="ln2356">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2357">	if (IS_AUDIGY(&amp;card-&gt;config) || IS_LIVE_5_1(&amp;card-&gt;config))</a>
<a name="ln2358">		a_center_sub_gpr = emuxki_gpr_new(card, &quot;Analog Center/Sub&quot;,</a>
<a name="ln2359">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2360"> </a>
<a name="ln2361">	d_front_gpr = emuxki_gpr_new(card, &quot;Digital Front&quot;,</a>
<a name="ln2362">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2363">	d_rear_gpr = emuxki_gpr_new(card, &quot;Digital Rear&quot;,</a>
<a name="ln2364">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2365">	d_center_sub_gpr = emuxki_gpr_new(card, &quot;Digital Center/Sub&quot;,</a>
<a name="ln2366">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2367"> </a>
<a name="ln2368">	/* playback in gprs */</a>
<a name="ln2369">	p_ac97_in_gpr = emuxki_gpr_new(card, &quot;AC97 Record In&quot;,</a>
<a name="ln2370">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 1.0, -46.5, 0.0, -0.75);</a>
<a name="ln2371">	p_cd_in_gpr = emuxki_gpr_new(card, &quot;CD Spdif In&quot;,</a>
<a name="ln2372">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_PLAYBACK, &amp;gpr, 0.0, 1.0, -46.5, 0.0, -0.75);</a>
<a name="ln2373"> </a>
<a name="ln2374">	/* record in gprs */</a>
<a name="ln2375">	r_ac97_in_gpr = emuxki_gpr_new(card, &quot;AC97 Record In&quot;,</a>
<a name="ln2376">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_RECORD, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2377">	r_cd_in_gpr = emuxki_gpr_new(card, &quot;CD Spdif In&quot;,</a>
<a name="ln2378">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_RECORD, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2379">	r_fx_out_gpr = emuxki_gpr_new(card, &quot;FX 0/1&quot;,</a>
<a name="ln2380">			EMU_MIX_GAIN|EMU_MIX_STEREO|EMU_MIX_MUTE|EMU_MIX_RECORD, &amp;gpr, 0.0, 0.0, -46.5, 0.0, -0.75);</a>
<a name="ln2381"> </a>
<a name="ln2382">	card-&gt;gpr_count = gpr;</a>
<a name="ln2383"> </a>
<a name="ln2384">	if (IS_AUDIGY(&amp;card-&gt;config)) {</a>
<a name="ln2385">		/* DSP_IN_GPR(l/r) = 0 + AC97In(l/r) * P_AC97_IN_GPR(l/r) */</a>
<a name="ln2386">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2387">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2388">				  EMU_A_DSP_CST(0),</a>
<a name="ln2389">				  EMU_A_DSP_INL(EMU_DSP_IN_AC97), EMU_A_DSP_GPR(p_ac97_in_gpr-&gt;gpr));</a>
<a name="ln2390">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2391">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2392">				  EMU_A_DSP_CST(0),</a>
<a name="ln2393">				  EMU_A_DSP_INR(EMU_DSP_IN_AC97), EMU_A_DSP_GPR(p_ac97_in_gpr-&gt;gpr + 1));</a>
<a name="ln2394"> </a>
<a name="ln2395">		/* DSP_IN_GPR(l/r) = DSP_IN_GPR(l/r) + CDIn(l/r) * P_CD_IN_GPR(l/r) */</a>
<a name="ln2396">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2397">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2398">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2399">				  EMU_A_DSP_INL(EMU_DSP_IN_CDSPDIF), EMU_A_DSP_GPR(p_cd_in_gpr-&gt;gpr));</a>
<a name="ln2400">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2401">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2402">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2403">				  EMU_A_DSP_INR(EMU_DSP_IN_CDSPDIF), EMU_A_DSP_GPR(p_cd_in_gpr-&gt;gpr + 1));</a>
<a name="ln2404"> </a>
<a name="ln2405">		/* Front GPR(l/r) = DSP_IN_GPR(l/r) + FX(0/1) * 4 */</a>
<a name="ln2406">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2407">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_FRONT_LEFT),</a>
<a name="ln2408">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2409">				  EMU_DSP_FX(0), EMU_A_DSP_CST(4));</a>
<a name="ln2410">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2411">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_FRONT_RIGHT),</a>
<a name="ln2412">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2413">				  EMU_DSP_FX(1), EMU_A_DSP_CST(4));</a>
<a name="ln2414"> </a>
<a name="ln2415">		/* Rear GPR(l/r) = DSP_IN_GPR(l/r) + FX(2/3) * 4 */</a>
<a name="ln2416">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2417">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_REAR_LEFT),</a>
<a name="ln2418">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2419">				  EMU_DSP_FX(2), EMU_A_DSP_CST(4));</a>
<a name="ln2420">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2421">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_REAR_RIGHT),</a>
<a name="ln2422">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2423">				  EMU_DSP_FX(3), EMU_A_DSP_CST(4));</a>
<a name="ln2424"> </a>
<a name="ln2425">		/* Center/Sub GPR = 0 + FX(4/5) * 4 */</a>
<a name="ln2426">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2427">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_CENTER),</a>
<a name="ln2428">				  EMU_A_DSP_CST(0),</a>
<a name="ln2429">				  EMU_DSP_FX(4), EMU_A_DSP_CST(4));</a>
<a name="ln2430">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2431">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_SUB),</a>
<a name="ln2432">				  EMU_A_DSP_CST(0),</a>
<a name="ln2433">				  EMU_DSP_FX(5), EMU_A_DSP_CST(4));</a>
<a name="ln2434"> </a>
<a name="ln2435">		/* Analog Front Output l/r = 0 + Front GPR(l/r) * A_FRONT_GPR(l/r) */</a>
<a name="ln2436">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2437">				  EMU_A_DSP_OUTL(EMU_A_DSP_OUT_A_FRONT),</a>
<a name="ln2438">				  EMU_A_DSP_CST(0),</a>
<a name="ln2439">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_FRONT_LEFT), EMU_A_DSP_GPR(a_front_gpr-&gt;gpr));</a>
<a name="ln2440">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2441">				  EMU_A_DSP_OUTR(EMU_A_DSP_OUT_A_FRONT),</a>
<a name="ln2442">				  EMU_A_DSP_CST(0),</a>
<a name="ln2443">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_FRONT_RIGHT), EMU_A_DSP_GPR(a_front_gpr-&gt;gpr+1));</a>
<a name="ln2444"> </a>
<a name="ln2445">		/* Analog Rear Output l/r = 0 + Rear GPR(l/r) * A_REAR_GPR(l/r) */</a>
<a name="ln2446">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2447">				  EMU_A_DSP_OUTL(EMU_A_DSP_OUT_A_REAR),</a>
<a name="ln2448">				  EMU_A_DSP_CST(0),</a>
<a name="ln2449">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_REAR_LEFT), EMU_A_DSP_GPR(a_rear_gpr-&gt;gpr));</a>
<a name="ln2450">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2451">				  EMU_A_DSP_OUTR(EMU_A_DSP_OUT_A_REAR),</a>
<a name="ln2452">				  EMU_A_DSP_CST(0),</a>
<a name="ln2453">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_REAR_RIGHT), EMU_A_DSP_GPR(a_rear_gpr-&gt;gpr+1));</a>
<a name="ln2454"> </a>
<a name="ln2455">		/* Analog Center/Sub = 0 + Center/Sub GPR(l/r) * A_CENTER_GPR(l/r) */</a>
<a name="ln2456">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2457">				  EMU_A_DSP_OUTL(EMU_A_DSP_OUT_A_CENTER),</a>
<a name="ln2458">				  EMU_A_DSP_CST(0),</a>
<a name="ln2459">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_CENTER), EMU_A_DSP_GPR(a_center_sub_gpr-&gt;gpr));</a>
<a name="ln2460">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2461">				  EMU_A_DSP_OUTR(EMU_A_DSP_OUT_A_CENTER),</a>
<a name="ln2462">				  EMU_A_DSP_CST(0),</a>
<a name="ln2463">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_SUB), EMU_A_DSP_GPR(a_center_sub_gpr-&gt;gpr+1));</a>
<a name="ln2464"> </a>
<a name="ln2465">		/* Digital Front Output l/r = 0 + Front GPR(l/r) * D_FRONT_GPR(l/r) */</a>
<a name="ln2466">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2467">				  EMU_A_DSP_OUTL(EMU_A_DSP_OUT_D_FRONT),</a>
<a name="ln2468">				  EMU_A_DSP_CST(0),</a>
<a name="ln2469">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_FRONT_LEFT), EMU_A_DSP_GPR(d_front_gpr-&gt;gpr));</a>
<a name="ln2470">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2471">				  EMU_A_DSP_OUTR(EMU_A_DSP_OUT_D_FRONT),</a>
<a name="ln2472">				  EMU_A_DSP_CST(0),</a>
<a name="ln2473">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_FRONT_RIGHT), EMU_A_DSP_GPR(d_front_gpr-&gt;gpr+1));</a>
<a name="ln2474"> </a>
<a name="ln2475">		/* Digital Rear Output l/r = 0 + Rear GPR(l/r) * D_REAR_GPR(l/r) */</a>
<a name="ln2476">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2477">				  EMU_A_DSP_OUTL(EMU_A_DSP_OUT_D_REAR),</a>
<a name="ln2478">				  EMU_A_DSP_CST(0),</a>
<a name="ln2479">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_REAR_LEFT), EMU_A_DSP_GPR(d_rear_gpr-&gt;gpr));</a>
<a name="ln2480">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2481">				  EMU_A_DSP_OUTR(EMU_A_DSP_OUT_D_REAR),</a>
<a name="ln2482">				  EMU_A_DSP_CST(0),</a>
<a name="ln2483">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_REAR_RIGHT), EMU_A_DSP_GPR(d_rear_gpr-&gt;gpr+1));</a>
<a name="ln2484"> </a>
<a name="ln2485">		/* Digital Center/Sub = 0 + Center/Sub GPR(l/r) * D_CENTER_GPR(l/r) */</a>
<a name="ln2486">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2487">				  EMU_A_DSP_OUTL(EMU_A_DSP_OUT_D_CENTER),</a>
<a name="ln2488">				  EMU_A_DSP_CST(0),</a>
<a name="ln2489">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_CENTER), EMU_A_DSP_GPR(d_center_sub_gpr-&gt;gpr));</a>
<a name="ln2490">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2491">				  EMU_A_DSP_OUTR(EMU_A_DSP_OUT_D_CENTER),</a>
<a name="ln2492">				  EMU_A_DSP_CST(0),</a>
<a name="ln2493">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_SUB), EMU_A_DSP_GPR(d_center_sub_gpr-&gt;gpr+1));</a>
<a name="ln2494"> </a>
<a name="ln2495">		/* DSP_IN_GPR(l/r) = 0 + AC97In(l/r) * R_AC97_IN_GPR(l/r) */</a>
<a name="ln2496">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2497">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2498">				  EMU_A_DSP_CST(0),</a>
<a name="ln2499">				  EMU_A_DSP_INL(EMU_DSP_IN_AC97), EMU_A_DSP_GPR(r_ac97_in_gpr-&gt;gpr));</a>
<a name="ln2500">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2501">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2502">				  EMU_A_DSP_CST(0),</a>
<a name="ln2503">				  EMU_A_DSP_INR(EMU_DSP_IN_AC97), EMU_A_DSP_GPR(r_ac97_in_gpr-&gt;gpr + 1));</a>
<a name="ln2504"> </a>
<a name="ln2505">		/* DSP_IN_GPR (l/r) = DSP_IN_GPR(l/r) + FX(0/1) * R_FX_OUT_GPR(l/r) */</a>
<a name="ln2506">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2507">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2508">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2509">				  EMU_DSP_FX(0), EMU_A_DSP_GPR(r_fx_out_gpr-&gt;gpr));</a>
<a name="ln2510">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2511">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2512">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2513">				  EMU_DSP_FX(1), EMU_A_DSP_GPR(r_fx_out_gpr-&gt;gpr + 1));</a>
<a name="ln2514"> </a>
<a name="ln2515">		/* DSP_IN_GPR(l/r) = 0 + DSP_IN_GPR(l/r) * 4 */</a>
<a name="ln2516">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2517">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2518">				  EMU_A_DSP_CST(0),</a>
<a name="ln2519">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L), EMU_A_DSP_CST(4));</a>
<a name="ln2520">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2521">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2522">				  EMU_A_DSP_CST(0),</a>
<a name="ln2523">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R), EMU_A_DSP_CST(4));</a>
<a name="ln2524"> </a>
<a name="ln2525">		/* ADC recording buffer (l/r) = DSP_IN_GPR(l/r) + CDIn(l/r) * R_CD_IN_GPR(l/r) */</a>
<a name="ln2526">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2527">				  EMU_A_DSP_OUTL(EMU_A_DSP_OUT_ADC),</a>
<a name="ln2528">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2529">				  EMU_A_DSP_INL(EMU_DSP_IN_CDSPDIF), EMU_A_DSP_GPR(r_cd_in_gpr-&gt;gpr));</a>
<a name="ln2530">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2531">				  EMU_A_DSP_OUTR(EMU_A_DSP_OUT_ADC),</a>
<a name="ln2532">				  EMU_A_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2533">				  EMU_A_DSP_INR(EMU_DSP_IN_CDSPDIF), EMU_A_DSP_GPR(r_cd_in_gpr-&gt;gpr + 1));</a>
<a name="ln2534"> </a>
<a name="ln2535"> </a>
<a name="ln2536"> </a>
<a name="ln2537">		/* zero out the rest of the microcode */</a>
<a name="ln2538">		while (pc &lt; 512)</a>
<a name="ln2539">			emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_ACC3,</a>
<a name="ln2540">				  EMU_A_DSP_CST(0), EMU_A_DSP_CST(0),</a>
<a name="ln2541">				  EMU_A_DSP_CST(0), EMU_A_DSP_CST(0));</a>
<a name="ln2542"> </a>
<a name="ln2543">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_A_DBG, 0);	/* Is it really necessary ? */</a>
<a name="ln2544"> </a>
<a name="ln2545">	} else {</a>
<a name="ln2546">		/* DSP_IN_GPR(l/r) = 0 + AC97In(l/r) * P_AC97_IN_GPR(l/r) */</a>
<a name="ln2547">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2548">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2549">				  EMU_DSP_CST(0),</a>
<a name="ln2550">				  EMU_DSP_INL(EMU_DSP_IN_AC97), EMU_DSP_GPR(p_ac97_in_gpr-&gt;gpr));</a>
<a name="ln2551">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2552">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2553">				  EMU_DSP_CST(0),</a>
<a name="ln2554">				  EMU_DSP_INR(EMU_DSP_IN_AC97), EMU_DSP_GPR(p_ac97_in_gpr-&gt;gpr + 1));</a>
<a name="ln2555"> </a>
<a name="ln2556">		/* DSP_IN_GPR(l/r) = DSP_IN_GPR(l/r) + CDIn(l/r) * P_CD_IN_GPR(l/r) */</a>
<a name="ln2557">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2558">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2559">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2560">				  EMU_DSP_INL(EMU_DSP_IN_CDSPDIF), EMU_DSP_GPR(p_cd_in_gpr-&gt;gpr));</a>
<a name="ln2561">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2562">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2563">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2564">				  EMU_DSP_INR(EMU_DSP_IN_CDSPDIF), EMU_DSP_GPR(p_cd_in_gpr-&gt;gpr + 1));</a>
<a name="ln2565"> </a>
<a name="ln2566">		/* Front GPR(l/r) = DSP_IN_GPR(l/r) + FX(0/1) * 4 */</a>
<a name="ln2567">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2568">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_FRONT_LEFT),</a>
<a name="ln2569">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2570">				  EMU_DSP_FX(0), EMU_DSP_CST(4));</a>
<a name="ln2571">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2572">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_FRONT_RIGHT),</a>
<a name="ln2573">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2574">				  EMU_DSP_FX(1), EMU_DSP_CST(4));</a>
<a name="ln2575"> </a>
<a name="ln2576">		/* Rear GPR(l/r) = DSP_IN_GPR(l/r) + FX(2/3) * 4 */</a>
<a name="ln2577">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2578">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_REAR_LEFT),</a>
<a name="ln2579">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2580">				  EMU_DSP_FX(2), EMU_DSP_CST(4));</a>
<a name="ln2581">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2582">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_REAR_RIGHT),</a>
<a name="ln2583">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2584">				  EMU_DSP_FX(3), EMU_DSP_CST(4));</a>
<a name="ln2585"> </a>
<a name="ln2586">		/* Center/Sub GPR = 0 + FX(4/5) * 4 */</a>
<a name="ln2587">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2588">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_CENTER),</a>
<a name="ln2589">				  EMU_DSP_CST(0),</a>
<a name="ln2590">				  EMU_DSP_FX(4), EMU_DSP_CST(4));</a>
<a name="ln2591">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2592">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_SUB),</a>
<a name="ln2593">				  EMU_DSP_CST(0),</a>
<a name="ln2594">				  EMU_DSP_FX(5), EMU_DSP_CST(4));</a>
<a name="ln2595"> </a>
<a name="ln2596">		/* Analog Front Output l/r = 0 + Front GPR(l/r) * A_FRONT_GPR(l/r) */</a>
<a name="ln2597">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2598">				  EMU_DSP_OUTL(EMU_DSP_OUT_A_FRONT),</a>
<a name="ln2599">				  EMU_DSP_CST(0),</a>
<a name="ln2600">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_FRONT_LEFT), EMU_DSP_GPR(a_front_gpr-&gt;gpr));</a>
<a name="ln2601">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2602">				  EMU_DSP_OUTR(EMU_DSP_OUT_A_FRONT),</a>
<a name="ln2603">				  EMU_DSP_CST(0),</a>
<a name="ln2604">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_FRONT_RIGHT), EMU_DSP_GPR(a_front_gpr-&gt;gpr+1));</a>
<a name="ln2605"> </a>
<a name="ln2606">		/* Analog Rear Output l/r = 0 + Rear GPR(l/r) * A_REAR_GPR(l/r) */</a>
<a name="ln2607">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2608">				  EMU_DSP_OUTL(EMU_DSP_OUT_AD_REAR),</a>
<a name="ln2609">				  EMU_DSP_CST(0),</a>
<a name="ln2610">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_REAR_LEFT), EMU_DSP_GPR(a_rear_gpr-&gt;gpr));</a>
<a name="ln2611">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2612">				  EMU_DSP_OUTR(EMU_DSP_OUT_AD_REAR),</a>
<a name="ln2613">				  EMU_DSP_CST(0),</a>
<a name="ln2614">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_REAR_RIGHT), EMU_DSP_GPR(a_rear_gpr-&gt;gpr+1));</a>
<a name="ln2615"> </a>
<a name="ln2616">		/* Analog Center/Sub = 0 + Center/Sub GPR(l/r) * A_CENTER_GPR(l/r) */</a>
<a name="ln2617">		if (IS_LIVE_5_1(&amp;card-&gt;config)) {</a>
<a name="ln2618">			emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2619">					  EMU_DSP_OUT_A_CENTER,</a>
<a name="ln2620">					  EMU_DSP_CST(0),</a>
<a name="ln2621">					  EMU_DSP_GPR(EMU_DSP_TMPGPR_CENTER), EMU_DSP_GPR(a_center_sub_gpr-&gt;gpr));</a>
<a name="ln2622">			emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2623">					  EMU_DSP_OUT_A_SUB,</a>
<a name="ln2624">					  EMU_DSP_CST(0),</a>
<a name="ln2625">					  EMU_DSP_GPR(EMU_DSP_TMPGPR_SUB), EMU_DSP_GPR(a_center_sub_gpr-&gt;gpr+1));</a>
<a name="ln2626">		}</a>
<a name="ln2627"> </a>
<a name="ln2628">		/* Digital Front Output l/r = 0 + Front GPR(l/r) * D_FRONT_GPR(l/r) */</a>
<a name="ln2629">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2630">				  EMU_DSP_OUTL(EMU_DSP_OUT_D_FRONT),</a>
<a name="ln2631">				  EMU_DSP_CST(0),</a>
<a name="ln2632">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_FRONT_LEFT), EMU_DSP_GPR(d_front_gpr-&gt;gpr));</a>
<a name="ln2633">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2634">				  EMU_DSP_OUTR(EMU_DSP_OUT_D_FRONT),</a>
<a name="ln2635">				  EMU_DSP_CST(0),</a>
<a name="ln2636">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_FRONT_RIGHT), EMU_DSP_GPR(d_front_gpr-&gt;gpr+1));</a>
<a name="ln2637"> </a>
<a name="ln2638">		/* Digital Rear Output l/r = 0 + Rear GPR(l/r) * D_REAR_GPR(l/r) */</a>
<a name="ln2639">		/*emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2640">				  EMU_DSP_OUTL(EMU_DSP_OUT_D_REAR),</a>
<a name="ln2641">				  EMU_DSP_CST(0),</a>
<a name="ln2642">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_REAR_LEFT), EMU_DSP_GPR(d_rear_gpr-&gt;gpr));</a>
<a name="ln2643">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2644">				  EMU_DSP_OUTR(EMU_DSP_OUT_D_REAR),</a>
<a name="ln2645">				  EMU_DSP_CST(0),</a>
<a name="ln2646">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_REAR_RIGHT), EMU_DSP_GPR(d_rear_gpr-&gt;gpr+1));*/</a>
<a name="ln2647"> </a>
<a name="ln2648">		/* Digital Center/Sub = 0 + Center/Sub GPR(l/r) * D_CENTER_GPR(l/r) */</a>
<a name="ln2649">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2650">				  EMU_DSP_OUTL(EMU_DSP_OUT_D_CENTER),</a>
<a name="ln2651">				  EMU_DSP_CST(0),</a>
<a name="ln2652">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_CENTER), EMU_DSP_GPR(d_center_sub_gpr-&gt;gpr));</a>
<a name="ln2653">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2654">				  EMU_DSP_OUTR(EMU_DSP_OUT_D_CENTER),</a>
<a name="ln2655">				  EMU_DSP_CST(0),</a>
<a name="ln2656">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_SUB), EMU_DSP_GPR(d_center_sub_gpr-&gt;gpr+1));</a>
<a name="ln2657"> </a>
<a name="ln2658">		/* DSP_IN_GPR(l/r) = 0 + AC97In(l/r) * R_AC97_IN_GPR(l/r) */</a>
<a name="ln2659">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2660">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2661">				  EMU_DSP_CST(0),</a>
<a name="ln2662">				  EMU_DSP_INL(EMU_DSP_IN_AC97), EMU_DSP_GPR(r_ac97_in_gpr-&gt;gpr));</a>
<a name="ln2663">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2664">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2665">				  EMU_DSP_CST(0),</a>
<a name="ln2666">				  EMU_DSP_INR(EMU_DSP_IN_AC97), EMU_DSP_GPR(r_ac97_in_gpr-&gt;gpr + 1));</a>
<a name="ln2667"> </a>
<a name="ln2668">		/* DSP_IN_GPR (l/r) = DSP_IN_GPR(l/r) + FX(0/1) * R_FX_OUT_GPR(l/r) */</a>
<a name="ln2669">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2670">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2671">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2672">				  EMU_DSP_FX(0), EMU_DSP_GPR(r_fx_out_gpr-&gt;gpr));</a>
<a name="ln2673">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2674">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2675">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2676">				  EMU_DSP_FX(1), EMU_DSP_GPR(r_fx_out_gpr-&gt;gpr + 1));</a>
<a name="ln2677"> </a>
<a name="ln2678">		/* DSP_IN_GPR(l/r) = 0 + DSP_IN_GPR(l/r) * 4 */</a>
<a name="ln2679">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2680">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2681">				  EMU_DSP_CST(0),</a>
<a name="ln2682">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L), EMU_DSP_CST(4));</a>
<a name="ln2683">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACINTS,</a>
<a name="ln2684">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2685">				  EMU_DSP_CST(0),</a>
<a name="ln2686">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R), EMU_DSP_CST(4));</a>
<a name="ln2687"> </a>
<a name="ln2688">		/* ADC recording buffer (l/r) = DSP_IN_GPR(l/r) + CDIn(l/r) * R_CD_IN_GPR(l/r) */</a>
<a name="ln2689">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2690">				  EMU_DSP_OUTL(EMU_DSP_OUT_ADC),</a>
<a name="ln2691">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_L),</a>
<a name="ln2692">				  EMU_DSP_INL(EMU_DSP_IN_CDSPDIF), EMU_DSP_GPR(r_cd_in_gpr-&gt;gpr));</a>
<a name="ln2693">		emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_MACS,</a>
<a name="ln2694">				  EMU_DSP_OUTR(EMU_DSP_OUT_ADC),</a>
<a name="ln2695">				  EMU_DSP_GPR(EMU_DSP_TMPGPR_DSP_IN_R),</a>
<a name="ln2696">				  EMU_DSP_INR(EMU_DSP_IN_CDSPDIF), EMU_DSP_GPR(r_cd_in_gpr-&gt;gpr + 1));</a>
<a name="ln2697"> </a>
<a name="ln2698">		/* zero out the rest of the microcode */</a>
<a name="ln2699">		while (pc &lt; 512)</a>
<a name="ln2700">			emuxki_dsp_addop(&amp;card-&gt;config, &amp;pc, EMU_DSP_OP_ACC3,</a>
<a name="ln2701">				  EMU_DSP_CST(0), EMU_DSP_CST(0),</a>
<a name="ln2702">				  EMU_DSP_CST(0), EMU_DSP_CST(0));</a>
<a name="ln2703"> </a>
<a name="ln2704">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_DBG, 0);	/* Is it really necessary ? */</a>
<a name="ln2705">	}</a>
<a name="ln2706"> </a>
<a name="ln2707">	emuxki_dump_fx(card);</a>
<a name="ln2708">}</a>
<a name="ln2709"> </a>
<a name="ln2710"> </a>
<a name="ln2711">status_t</a>
<a name="ln2712">emuxki_init(emuxki_dev * card)</a>
<a name="ln2713">{</a>
<a name="ln2714">	uint16       i;</a>
<a name="ln2715">	uint32       spcs, *ptb;</a>
<a name="ln2716">	uint32	 	 silentpage;</a>
<a name="ln2717"> </a>
<a name="ln2718">	/* disable any channel interrupt */</a>
<a name="ln2719">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_CLIEL, 0);</a>
<a name="ln2720">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_CLIEH, 0);</a>
<a name="ln2721">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SOLEL, 0);</a>
<a name="ln2722">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SOLEH, 0);</a>
<a name="ln2723"> </a>
<a name="ln2724">	/* Set recording buffers sizes to zero */</a>
<a name="ln2725">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_MICBS, EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln2726">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_MICBA, 0);</a>
<a name="ln2727">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_FXBS, EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln2728">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_FXBA, 0);</a>
<a name="ln2729">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_ADCBS, EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln2730">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_ADCBA, 0);</a>
<a name="ln2731"> </a>
<a name="ln2732">	if (IS_AUDIGY(&amp;card-&gt;config)) {</a>
<a name="ln2733">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SPBYPASS, EMU_SPBYPASS_24_BITS);</a>
<a name="ln2734">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_AC97SLOT, EMU_AC97SLOT_CENTER | EMU_AC97SLOT_LFE);</a>
<a name="ln2735">	}</a>
<a name="ln2736"> </a>
<a name="ln2737">	/* Initialize all channels to stopped and no effects */</a>
<a name="ln2738">	for (i = 0; i &lt; EMU_NUMCHAN; i++) {</a>
<a name="ln2739">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_DCYSUSV, 0);</a>
<a name="ln2740">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_IP, 0);</a>
<a name="ln2741">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_VTFT, 0xffff);</a>
<a name="ln2742">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_CVCF, 0xffff);</a>
<a name="ln2743">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_PTRX, 0);</a>
<a name="ln2744">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_CPF, 0);</a>
<a name="ln2745">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_CCR, 0);</a>
<a name="ln2746">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_PSST, 0);</a>
<a name="ln2747">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_DSL, 0x10);	/* Why 16 ? */</a>
<a name="ln2748">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_CCCA, 0);</a>
<a name="ln2749">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_Z1, 0);</a>
<a name="ln2750">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_Z2, 0);</a>
<a name="ln2751">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_FXRT, 0x32100000);</a>
<a name="ln2752">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_ATKHLDM, 0);</a>
<a name="ln2753">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_DCYSUSM, 0);</a>
<a name="ln2754">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_IFATN, 0xffff);</a>
<a name="ln2755">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_PEFE, 0);</a>
<a name="ln2756">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_FMMOD, 0);</a>
<a name="ln2757">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_TREMFRQ, 24);</a>
<a name="ln2758">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_FM2FRQ2, 24);</a>
<a name="ln2759">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_TEMPENV, 0);</a>
<a name="ln2760">		/*** these are last so OFF prevents writing ***/</a>
<a name="ln2761">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_LFOVAL2, 0);</a>
<a name="ln2762">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_LFOVAL1, 0);</a>
<a name="ln2763">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_ATKHLDV, 0);</a>
<a name="ln2764">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_ENVVOL, 0);</a>
<a name="ln2765">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_ENVVAL, 0);</a>
<a name="ln2766">	}</a>
<a name="ln2767"> </a>
<a name="ln2768">	/* set digital outputs format */</a>
<a name="ln2769">	spcs = (EMU_SPCS_CLKACCY_1000PPM | EMU_SPCS_SAMPLERATE_48 |</a>
<a name="ln2770">	      EMU_SPCS_CHANNELNUM_LEFT | EMU_SPCS_SOURCENUM_UNSPEC |</a>
<a name="ln2771">		EMU_SPCS_GENERATIONSTATUS | 0x00001200 /* Cat code. */ |</a>
<a name="ln2772">		0x00000000 /* IEC-958 Mode */ | EMU_SPCS_EMPHASIS_NONE |</a>
<a name="ln2773">		EMU_SPCS_COPYRIGHT);</a>
<a name="ln2774">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SPCS0, spcs);</a>
<a name="ln2775">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SPCS1, spcs);</a>
<a name="ln2776">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SPCS2, spcs);</a>
<a name="ln2777"> </a>
<a name="ln2778">	if (IS_AUDIGY2(&amp;card-&gt;config)) {</a>
<a name="ln2779">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_A2_SPDIF_SAMPLERATE, EMU_A2_SPDIF_UNKNOWN);</a>
<a name="ln2780"> </a>
<a name="ln2781">		emuxki_p16v_write(&amp;card-&gt;config, 0, EMU_A2_SRCSEL,</a>
<a name="ln2782">			EMU_A2_SRCSEL_ENABLE_SPDIF | EMU_A2_SRCSEL_ENABLE_SRCMULTI);</a>
<a name="ln2783"> </a>
<a name="ln2784">		if (IS_AUDIGY2_VALUE(&amp;card-&gt;config)) {</a>
<a name="ln2785">			emuxki_p16v_write(&amp;card-&gt;config, 0, EMU_A2_P17V_I2S, EMU_A2_P17V_I2S_ENABLE);</a>
<a name="ln2786">			emuxki_p16v_write(&amp;card-&gt;config, 0, EMU_A2_P17V_SPDIF, EMU_A2_P17V_SPDIF_ENABLE);</a>
<a name="ln2787"> </a>
<a name="ln2788">			emuxki_reg_write_32(&amp;card-&gt;config, EMU_A_IOCFG,</a>
<a name="ln2789">				emuxki_reg_read_32(&amp;card-&gt;config, EMU_A_IOCFG) &amp; ~0x8);</a>
<a name="ln2790">		} else {</a>
<a name="ln2791">			emuxki_p16v_write(&amp;card-&gt;config, 0, EMU_A2_SRCMULTI, EMU_A2_SRCMULTI_ENABLE_INPUT);</a>
<a name="ln2792">		}</a>
<a name="ln2793">	}</a>
<a name="ln2794"> </a>
<a name="ln2795">	/* Let's play with sound processor */</a>
<a name="ln2796">	emuxki_initfx(card);</a>
<a name="ln2797"> </a>
<a name="ln2798">	/* allocate memory for our Page Table */</a>
<a name="ln2799">	card-&gt;ptb_area = alloc_mem(&amp;card-&gt;ptb_phy_base, &amp;card-&gt;ptb_log_base,</a>
<a name="ln2800">		EMU_MAXPTE * sizeof(uint32), &quot;emuxki ptb&quot;);</a>
<a name="ln2801"> </a>
<a name="ln2802">	/* This is necessary unless you like Metallic noise... */</a>
<a name="ln2803">	card-&gt;silentpage_area = alloc_mem(&amp;card-&gt;silentpage_phy_base, &amp;card-&gt;silentpage_log_base,</a>
<a name="ln2804">		EMU_PTESIZE, &quot;emuxki sp&quot;);</a>
<a name="ln2805"> </a>
<a name="ln2806">	if (card-&gt;ptb_area &lt; B_OK || card-&gt;silentpage_area &lt; B_OK) {</a>
<a name="ln2807">		PRINT((&quot;couldn't allocate memory\n&quot;));</a>
<a name="ln2808">		if (card-&gt;ptb_area &gt; B_OK)</a>
<a name="ln2809">			delete_area(card-&gt;ptb_area);</a>
<a name="ln2810">		if (card-&gt;silentpage_area &gt; B_OK)</a>
<a name="ln2811">			delete_area(card-&gt;silentpage_area);</a>
<a name="ln2812">		return B_ERROR;</a>
<a name="ln2813">	}</a>
<a name="ln2814"> </a>
<a name="ln2815">	/* Zero out the silent page */</a>
<a name="ln2816">	/* This might not be always true, it might be 128 for 8bit channels */</a>
<a name="ln2817">	memset(card-&gt;ptb_log_base, 0, EMU_PTESIZE);</a>
<a name="ln2818"> </a>
<a name="ln2819">	/*</a>
<a name="ln2820">	 * Set all the PTB Entries to the silent page We shift the physical</a>
<a name="ln2821">	 * address by one and OR it with the page number. I don't know what</a>
<a name="ln2822">	 * the ORed index is for, might be a very useful unused feature...</a>
<a name="ln2823">	 */</a>
<a name="ln2824">	silentpage = ((uint32)card-&gt;silentpage_phy_base) &lt;&lt; 1;</a>
<a name="ln2825">	ptb = card-&gt;ptb_log_base;</a>
<a name="ln2826">	for (i = 0; i &lt; EMU_MAXPTE; i++)</a>
<a name="ln2827">		ptb[i] = B_HOST_TO_LENDIAN_INT32(silentpage | i);</a>
<a name="ln2828"> </a>
<a name="ln2829">	/* Write PTB address and set TCB to none */</a>
<a name="ln2830">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_PTB, (uint32)card-&gt;ptb_phy_base);</a>
<a name="ln2831">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_TCBS, 0);	/* This means 16K TCB */</a>
<a name="ln2832">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_TCB, 0);	/* No TCB use for now */</a>
<a name="ln2833"> </a>
<a name="ln2834">	/*</a>
<a name="ln2835">	 * Set channels MAPs to the silent page.</a>
<a name="ln2836">	 * I don't know what MAPs are for.</a>
<a name="ln2837">	 */</a>
<a name="ln2838">	silentpage |= EMU_CHAN_MAP_PTI_MASK;</a>
<a name="ln2839">	for (i = 0; i &lt; EMU_NUMCHAN; i++) {</a>
<a name="ln2840">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_MAPA, silentpage);</a>
<a name="ln2841">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_MAPB, silentpage);</a>
<a name="ln2842">		card-&gt;channel[i] = NULL;</a>
<a name="ln2843">	}</a>
<a name="ln2844"> </a>
<a name="ln2845">	/* Init streams list */</a>
<a name="ln2846">	LIST_INIT(&amp;(card-&gt;streams));</a>
<a name="ln2847"> </a>
<a name="ln2848">	/* Init mems list */</a>
<a name="ln2849">	LIST_INIT(&amp;(card-&gt;mem));</a>
<a name="ln2850"> </a>
<a name="ln2851">	/* Timer is stopped */</a>
<a name="ln2852">	card-&gt;timerstate &amp;= ~EMU_TIMER_STATE_ENABLED;</a>
<a name="ln2853">	card-&gt;timerate = 0xffff;</a>
<a name="ln2854"> </a>
<a name="ln2855">	return B_OK;</a>
<a name="ln2856">}</a>
<a name="ln2857"> </a>
<a name="ln2858"> </a>
<a name="ln2859">status_t</a>
<a name="ln2860">init_driver(void)</a>
<a name="ln2861">{</a>
<a name="ln2862">	void *settings_handle;</a>
<a name="ln2863">	pci_info info;</a>
<a name="ln2864">	status_t err;</a>
<a name="ln2865">	int ix = 0;</a>
<a name="ln2866">	num_cards = 0;</a>
<a name="ln2867"> </a>
<a name="ln2868">	PRINT((&quot;init_driver()\n&quot;));</a>
<a name="ln2869"> </a>
<a name="ln2870">	// get driver settings</a>
<a name="ln2871">	settings_handle = load_driver_settings(&quot;emuxki.settings&quot;);</a>
<a name="ln2872">	if (settings_handle != NULL) {</a>
<a name="ln2873">		const char *item;</a>
<a name="ln2874">		char       *end;</a>
<a name="ln2875">		uint32      value;</a>
<a name="ln2876"> </a>
<a name="ln2877">		item = get_driver_parameter (settings_handle, &quot;channels&quot;, NULL, NULL);</a>
<a name="ln2878">		if (item) {</a>
<a name="ln2879">			value = strtoul (item, &amp;end, 0);</a>
<a name="ln2880">			if (*end == '\0') current_settings.channels = value;</a>
<a name="ln2881">		}</a>
<a name="ln2882"> </a>
<a name="ln2883">		item = get_driver_parameter (settings_handle, &quot;bitsPerSample&quot;, NULL, NULL);</a>
<a name="ln2884">		if (item) {</a>
<a name="ln2885">			value = strtoul (item, &amp;end, 0);</a>
<a name="ln2886">			if (*end == '\0') current_settings.bitsPerSample = value;</a>
<a name="ln2887">		}</a>
<a name="ln2888"> </a>
<a name="ln2889">		item = get_driver_parameter (settings_handle, &quot;sample_rate&quot;, NULL, NULL);</a>
<a name="ln2890">		if (item) {</a>
<a name="ln2891">			value = strtoul (item, &amp;end, 0);</a>
<a name="ln2892">			if (*end == '\0') current_settings.sample_rate = value;</a>
<a name="ln2893">		}</a>
<a name="ln2894"> </a>
<a name="ln2895">		item = get_driver_parameter (settings_handle, &quot;buffer_frames&quot;, NULL, NULL);</a>
<a name="ln2896">		if (item) {</a>
<a name="ln2897">			value = strtoul (item, &amp;end, 0);</a>
<a name="ln2898">			if (*end == '\0') current_settings.buffer_frames = value;</a>
<a name="ln2899">		}</a>
<a name="ln2900"> </a>
<a name="ln2901">		item = get_driver_parameter (settings_handle, &quot;buffer_count&quot;, NULL, NULL);</a>
<a name="ln2902">		if (item) {</a>
<a name="ln2903">			value = strtoul (item, &amp;end, 0);</a>
<a name="ln2904">			if (*end == '\0') current_settings.buffer_count = value;</a>
<a name="ln2905">		}</a>
<a name="ln2906"> </a>
<a name="ln2907">		unload_driver_settings (settings_handle);</a>
<a name="ln2908">	}</a>
<a name="ln2909"> </a>
<a name="ln2910">	if (get_module(B_PCI_MODULE_NAME, (module_info **) &amp;pci))</a>
<a name="ln2911">		return ENOSYS;</a>
<a name="ln2912"> </a>
<a name="ln2913">//	if (get_module (gameport_name, (module_info **)&amp;gameport)) {</a>
<a name="ln2914">//		put_module (B_PCI_MODULE_NAME);</a>
<a name="ln2915">//		return ENOSYS;</a>
<a name="ln2916">//	}</a>
<a name="ln2917"> </a>
<a name="ln2918">	if (get_module(B_MPU_401_MODULE_NAME, (module_info **) &amp;mpu401)) {</a>
<a name="ln2919">		//put_module(gameport_name);</a>
<a name="ln2920">		put_module(B_PCI_MODULE_NAME);</a>
<a name="ln2921">		return ENOSYS;</a>
<a name="ln2922">	}</a>
<a name="ln2923"> </a>
<a name="ln2924">	while ((*pci-&gt;get_nth_pci_info)(ix++, &amp;info) == B_OK) {</a>
<a name="ln2925">		if (info.vendor_id == CREATIVELABS_VENDOR_ID &amp;&amp;</a>
<a name="ln2926">			(info.device_id == CREATIVELABS_SBLIVE_DEVICE_ID</a>
<a name="ln2927">#if AUDIGY</a>
<a name="ln2928">			|| info.device_id == CREATIVELABS_AUDIGY_DEVICE_ID</a>
<a name="ln2929">			|| info.device_id == CREATIVELABS_AUDIGY2_VALUE_DEVICE_ID</a>
<a name="ln2930">#endif</a>
<a name="ln2931">			)) {</a>
<a name="ln2932">			if (num_cards == NUM_CARDS) {</a>
<a name="ln2933">				PRINT((&quot;Too many emuxki cards installed!\n&quot;));</a>
<a name="ln2934">				break;</a>
<a name="ln2935">			}</a>
<a name="ln2936">			memset(&amp;cards[num_cards], 0, sizeof(emuxki_dev));</a>
<a name="ln2937">			cards[num_cards].info = info;</a>
<a name="ln2938">#ifdef __HAIKU__</a>
<a name="ln2939">			if ((err = (*pci-&gt;reserve_device)(info.bus, info.device, info.function,</a>
<a name="ln2940">				DRIVER_NAME, &amp;cards[num_cards])) &lt; B_OK) {</a>
<a name="ln2941">				dprintf(&quot;%s: failed to reserve_device(%d, %d, %d,): %s\n&quot;,</a>
<a name="ln2942">					DRIVER_NAME, info.bus, info.device, info.function,</a>
<a name="ln2943">					strerror(err));</a>
<a name="ln2944">				continue;</a>
<a name="ln2945">			}</a>
<a name="ln2946">#endif</a>
<a name="ln2947">			if (emuxki_setup(&amp;cards[num_cards])) {</a>
<a name="ln2948">				PRINT((&quot;Setup of emuxki %ld failed\n&quot;, num_cards+1));</a>
<a name="ln2949">#ifdef __HAIKU__</a>
<a name="ln2950">				(*pci-&gt;unreserve_device)(info.bus, info.device, info.function,</a>
<a name="ln2951">					DRIVER_NAME, &amp;cards[num_cards]);</a>
<a name="ln2952">#endif</a>
<a name="ln2953">			} else {</a>
<a name="ln2954">				num_cards++;</a>
<a name="ln2955">			}</a>
<a name="ln2956">		}</a>
<a name="ln2957">	}</a>
<a name="ln2958">	if (!num_cards) {</a>
<a name="ln2959">		put_module(B_MPU_401_MODULE_NAME);</a>
<a name="ln2960">//		put_module(gameport_name);</a>
<a name="ln2961">		put_module(B_PCI_MODULE_NAME);</a>
<a name="ln2962">		PRINT((&quot;emuxki: no suitable cards found\n&quot;));</a>
<a name="ln2963">		return ENODEV;</a>
<a name="ln2964">	}</a>
<a name="ln2965"> </a>
<a name="ln2966">	return B_OK;</a>
<a name="ln2967">}</a>
<a name="ln2968"> </a>
<a name="ln2969"> </a>
<a name="ln2970">void</a>
<a name="ln2971">emuxki_shutdown(emuxki_dev *card)</a>
<a name="ln2972">{</a>
<a name="ln2973">	uint32       i;</a>
<a name="ln2974"> </a>
<a name="ln2975">	PRINT((&quot;shutdown(%p)\n&quot;, card));</a>
<a name="ln2976"> </a>
<a name="ln2977">	emuxki_reg_write_32(&amp;card-&gt;config, EMU_HCFG, EMU_HCFG_LOCKSOUNDCACHE |</a>
<a name="ln2978">		  EMU_HCFG_LOCKTANKCACHE_MASK | EMU_HCFG_MUTEBUTTONENABLE);</a>
<a name="ln2979">	emuxki_reg_write_32(&amp;card-&gt;config, EMU_INTE, 0);</a>
<a name="ln2980"> </a>
<a name="ln2981">	dump_hardware_regs(&amp;card-&gt;config);</a>
<a name="ln2982"> </a>
<a name="ln2983">	/* Disable any Channels interrupts */</a>
<a name="ln2984">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_CLIEL, 0);</a>
<a name="ln2985">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_CLIEH, 0);</a>
<a name="ln2986">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SOLEL, 0);</a>
<a name="ln2987">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_SOLEH, 0);</a>
<a name="ln2988"> </a>
<a name="ln2989">	/* Stop all channels */</a>
<a name="ln2990">	/* This shouldn't be necessary, i'll remove once everything works */</a>
<a name="ln2991">	for (i = 0; i &lt; EMU_NUMCHAN; i++)</a>
<a name="ln2992">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_DCYSUSV, 0);</a>
<a name="ln2993">	for (i = 0; i &lt; EMU_NUMCHAN; i++) {</a>
<a name="ln2994">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_VTFT, 0);</a>
<a name="ln2995">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_CVCF, 0);</a>
<a name="ln2996">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_PTRX, 0);</a>
<a name="ln2997">		emuxki_chan_write(&amp;card-&gt;config, i, EMU_CHAN_CPF, 0);</a>
<a name="ln2998">	}</a>
<a name="ln2999"> </a>
<a name="ln3000">	remove_io_interrupt_handler(card-&gt;config.irq, emuxki_int, card);</a>
<a name="ln3001"> </a>
<a name="ln3002">	/*</a>
<a name="ln3003">	 * deallocate Emu10k1 caches and recording buffers Again it will be</a>
<a name="ln3004">	 * removed because it will be done in voice shutdown.</a>
<a name="ln3005">	 */</a>
<a name="ln3006">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_MICBS, EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln3007">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_MICBA, 0);</a>
<a name="ln3008">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_FXBS, EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln3009">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_FXBA, 0);</a>
<a name="ln3010">	if (IS_AUDIGY(&amp;card-&gt;config)) {</a>
<a name="ln3011">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_A_FXWC1, 0);</a>
<a name="ln3012">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_A_FXWC2, 0);</a>
<a name="ln3013">	} else {</a>
<a name="ln3014">		emuxki_chan_write(&amp;card-&gt;config, 0, EMU_FXWC, 0);</a>
<a name="ln3015">	}</a>
<a name="ln3016">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_ADCBS, EMU_RECBS_BUFSIZE_NONE);</a>
<a name="ln3017">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_ADCBA, 0);</a>
<a name="ln3018"> </a>
<a name="ln3019">	/*</a>
<a name="ln3020">	 * I don't know yet how i will handle tank cache buffer,</a>
<a name="ln3021">	 * I don't even clearly  know what it is for</a>
<a name="ln3022">	 */</a>
<a name="ln3023">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_TCB, 0);	/* 16K again */</a>
<a name="ln3024">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_TCBS, 0);</a>
<a name="ln3025"> </a>
<a name="ln3026">	emuxki_chan_write(&amp;card-&gt;config, 0, EMU_DBG, 0x8000);	/* necessary ? */</a>
<a name="ln3027"> </a>
<a name="ln3028">	PRINT((&quot;freeing ptb_area\n&quot;));</a>
<a name="ln3029">	if (card-&gt;ptb_area &gt; B_OK)</a>
<a name="ln3030">		delete_area(card-&gt;ptb_area);</a>
<a name="ln3031">	PRINT((&quot;freeing silentpage_area\n&quot;));</a>
<a name="ln3032">	if (card-&gt;silentpage_area &gt; B_OK)</a>
<a name="ln3033">		delete_area(card-&gt;silentpage_area);</a>
<a name="ln3034"> </a>
<a name="ln3035">//	(*gameport-&gt;delete_device)(card-&gt;joy.driver);</a>
<a name="ln3036">}</a>
<a name="ln3037"> </a>
<a name="ln3038"> </a>
<a name="ln3039">void</a>
<a name="ln3040">uninit_driver(void)</a>
<a name="ln3041">{</a>
<a name="ln3042">	int ix, cnt = num_cards;</a>
<a name="ln3043"> </a>
<a name="ln3044">	PRINT((&quot;uninit_driver()\n&quot;));</a>
<a name="ln3045"> </a>
<a name="ln3046">	for (ix=0; ix&lt;cnt; ix++) {</a>
<a name="ln3047">		emuxki_shutdown(&amp;cards[ix]);</a>
<a name="ln3048">#ifdef __HAIKU__</a>
<a name="ln3049">		(*pci-&gt;unreserve_device)(cards[ix].info.bus,</a>
<a name="ln3050">			cards[ix].info.device, cards[ix].info.function,</a>
<a name="ln3051">			DRIVER_NAME, &amp;cards[ix]);</a>
<a name="ln3052">#endif</a>
<a name="ln3053">	}</a>
<a name="ln3054">	memset(&amp;cards, 0, sizeof(cards));</a>
<a name="ln3055">	put_module(B_MPU_401_MODULE_NAME);</a>
<a name="ln3056">//	put_module(gameport_name);</a>
<a name="ln3057">	put_module(B_PCI_MODULE_NAME);</a>
<a name="ln3058">	num_cards = 0;</a>
<a name="ln3059">}</a>
<a name="ln3060"> </a>
<a name="ln3061"> </a>
<a name="ln3062">const char **</a>
<a name="ln3063">publish_devices(void)</a>
<a name="ln3064">{</a>
<a name="ln3065">	int ix = 0;</a>
<a name="ln3066">	PRINT((&quot;publish_devices()\n&quot;));</a>
<a name="ln3067"> </a>
<a name="ln3068">	for (ix=0; names[ix]; ix++) {</a>
<a name="ln3069">		PRINT((&quot;publish %s\n&quot;, names[ix]));</a>
<a name="ln3070">	}</a>
<a name="ln3071">	return (const char **)names;</a>
<a name="ln3072">}</a>
<a name="ln3073"> </a>
<a name="ln3074"> </a>
<a name="ln3075">device_hooks *</a>
<a name="ln3076">find_device(const char * name)</a>
<a name="ln3077">{</a>
<a name="ln3078">	int ix;</a>
<a name="ln3079"> </a>
<a name="ln3080">	PRINT((&quot;emuxki: find_device(%s)\n&quot;, name));</a>
<a name="ln3081"> </a>
<a name="ln3082">	for (ix=0; ix&lt;num_cards; ix++) {</a>
<a name="ln3083">#if MIDI</a>
<a name="ln3084">		if (!strcmp(cards[ix].midi.name, name)) {</a>
<a name="ln3085">			return &amp;midi_hooks;</a>
<a name="ln3086">		}</a>
<a name="ln3087">#endif</a>
<a name="ln3088">//		if (!strcmp(cards[ix].joy.name1, name)) {</a>
<a name="ln3089">//			return &amp;joy_hooks;</a>
<a name="ln3090">//		}</a>
<a name="ln3091"> </a>
<a name="ln3092">		if (!strcmp(cards[ix].name, name)) {</a>
<a name="ln3093">			return &amp;multi_hooks;</a>
<a name="ln3094">		}</a>
<a name="ln3095">	}</a>
<a name="ln3096">	PRINT((&quot;emuxki: find_device(%s) failed\n&quot;, name));</a>
<a name="ln3097">	return NULL;</a>
<a name="ln3098">}</a>
<a name="ln3099"> </a>
<a name="ln3100">int32	api_version = B_CUR_DRIVER_API_VERSION;</a>

</code></pre>
<div class="balloon" rel="2168"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v502/" target="_blank">V502</a> Perhaps the '?:' operator works in a different way than it was expected. The '?:' operator has a lower priority than the '+' operator.</p></div>
<div class="balloon" rel="2948"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="2275"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="272"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="2194"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="2150"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the sixth actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="1776"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'index < 0' is always false. Unsigned type value is never < 0.</p></div>
<div class="balloon" rel="1313"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="289"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="1328"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'debug_printf' function. The memsize type argument is expected.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
