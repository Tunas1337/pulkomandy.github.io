
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>MainWin.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright (c) 2004-2007 Marcus Overhagen &lt;marcus@overhagen.de&gt;</a>
<a name="ln3"> *</a>
<a name="ln4"> * Permission is hereby granted, free of charge, to any person</a>
<a name="ln5"> * obtaining a copy of this software and associated documentation</a>
<a name="ln6"> * files (the &quot;Software&quot;), to deal in the Software without restriction,</a>
<a name="ln7"> * including without limitation the rights to use, copy, modify,</a>
<a name="ln8"> * merge, publish, distribute, sublicense, and/or sell copies of</a>
<a name="ln9"> * the Software, and to permit persons to whom the Software is</a>
<a name="ln10"> * furnished to do so, subject to the following conditions:</a>
<a name="ln11"> *</a>
<a name="ln12"> * The above copyright notice and this permission notice shall be</a>
<a name="ln13"> * included in all copies or substantial portions of the Software.</a>
<a name="ln14"> *</a>
<a name="ln15"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</a>
<a name="ln16"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES</a>
<a name="ln17"> * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</a>
<a name="ln18"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</a>
<a name="ln19"> * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</a>
<a name="ln20"> * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</a>
<a name="ln21"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</a>
<a name="ln22"> * OTHER DEALINGS IN THE SOFTWARE.</a>
<a name="ln23"> */</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;MainWin.h&quot;</a>
<a name="ln26">#include &quot;MainApp.h&quot;</a>
<a name="ln27">#include &quot;Controller.h&quot;</a>
<a name="ln28">#include &quot;config.h&quot;</a>
<a name="ln29">#include &quot;DeviceRoster.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">#include &lt;stdio.h&gt;</a>
<a name="ln32">#include &lt;string.h&gt;</a>
<a name="ln33"> </a>
<a name="ln34">#include &lt;Application.h&gt;</a>
<a name="ln35">#include &lt;Alert.h&gt;</a>
<a name="ln36">#include &lt;Menu.h&gt;</a>
<a name="ln37">#include &lt;MenuBar.h&gt;</a>
<a name="ln38">#include &lt;MenuItem.h&gt;</a>
<a name="ln39">#include &lt;Messenger.h&gt;</a>
<a name="ln40">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln41">#include &lt;Screen.h&gt;</a>
<a name="ln42">#include &lt;String.h&gt;</a>
<a name="ln43">#include &lt;View.h&gt;</a>
<a name="ln44"> </a>
<a name="ln45"> </a>
<a name="ln46">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln47">#define B_TRANSLATION_CONTEXT &quot;MainWin&quot;</a>
<a name="ln48"> </a>
<a name="ln49">B_TRANSLATE_MARK_VOID(&quot;TV&quot;);</a>
<a name="ln50">B_TRANSLATE_MARK_VOID(&quot;unknown&quot;);</a>
<a name="ln51">B_TRANSLATE_MARK_VOID(&quot;DVB - Digital Video Broadcasting TV&quot;);</a>
<a name="ln52"> </a>
<a name="ln53">enum</a>
<a name="ln54">{</a>
<a name="ln55">	M_DUMMY = 0x100,</a>
<a name="ln56">	M_FILE_QUIT,</a>
<a name="ln57">	M_SCALE_TO_NATIVE_SIZE,</a>
<a name="ln58">	M_TOGGLE_FULLSCREEN,</a>
<a name="ln59">	M_TOGGLE_NO_BORDER,</a>
<a name="ln60">	M_TOGGLE_NO_MENU,</a>
<a name="ln61">	M_TOGGLE_NO_BORDER_NO_MENU,</a>
<a name="ln62">	M_TOGGLE_ALWAYS_ON_TOP,</a>
<a name="ln63">	M_TOGGLE_KEEP_ASPECT_RATIO,</a>
<a name="ln64">	M_PREFERENCES,</a>
<a name="ln65">	M_CHANNEL_NEXT,</a>
<a name="ln66">	M_CHANNEL_PREV,</a>
<a name="ln67">	M_VOLUME_UP,</a>
<a name="ln68">	M_VOLUME_DOWN,</a>
<a name="ln69">	M_ASPECT_100000_1,</a>
<a name="ln70">	M_ASPECT_106666_1,</a>
<a name="ln71">	M_ASPECT_109091_1,</a>
<a name="ln72">	M_ASPECT_141176_1,</a>
<a name="ln73">	M_ASPECT_720_576,</a>
<a name="ln74">	M_ASPECT_704_576,</a>
<a name="ln75">	M_ASPECT_544_576,</a>
<a name="ln76">	M_SELECT_INTERFACE		= 0x00000800,</a>
<a name="ln77">	M_SELECT_INTERFACE_END	= 0x00000fff,</a>
<a name="ln78">	M_SELECT_CHANNEL		= 0x00010000,</a>
<a name="ln79">	M_SELECT_CHANNEL_END	= 0x000fffff,</a>
<a name="ln80">		// this limits possible channel count to 0xeffff = 983039</a>
<a name="ln81">};</a>
<a name="ln82"> </a>
<a name="ln83">//#define printf(a...)</a>
<a name="ln84"> </a>
<a name="ln85"> </a>
<a name="ln86">MainWin::MainWin(BRect frame_rect)</a>
<a name="ln87">	:</a>
<a name="ln88">	BWindow(frame_rect, B_TRANSLATE_SYSTEM_NAME(NAME), B_TITLED_WINDOW,</a>
<a name="ln89"> 	B_ASYNCHRONOUS_CONTROLS /* | B_WILL_ACCEPT_FIRST_CLICK */)</a>
<a name="ln90"> ,	fController(new Controller)</a>
<a name="ln91"> ,	fIsFullscreen(false)</a>
<a name="ln92"> ,	fKeepAspectRatio(true)</a>
<a name="ln93"> ,	fAlwaysOnTop(false)</a>
<a name="ln94"> ,	fNoMenu(false)</a>
<a name="ln95"> ,	fNoBorder(false)</a>
<a name="ln96"> ,	fSourceWidth(720)</a>
<a name="ln97"> ,	fSourceHeight(576)</a>
<a name="ln98"> ,	fWidthScale(1.0)</a>
<a name="ln99"> ,	fHeightScale(1.0)</a>
<a name="ln100"> ,	fMouseDownTracking(false)</a>
<a name="ln101"> ,	fFrameResizedTriggeredAutomatically(false)</a>
<a name="ln102"> ,	fIgnoreFrameResized(false)</a>
<a name="ln103"> ,	fFrameResizedCalled(true)</a>
<a name="ln104">{</a>
<a name="ln105">	BRect rect = Bounds();</a>
<a name="ln106"> </a>
<a name="ln107">	// background</a>
<a name="ln108">	fBackground = new BView(rect, &quot;background&quot;, B_FOLLOW_ALL,</a>
<a name="ln109">		B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE);</a>
<a name="ln110">	fBackground-&gt;SetViewColor(0,0,0);</a>
<a name="ln111">	AddChild(fBackground);</a>
<a name="ln112"> </a>
<a name="ln113">	// menu</a>
<a name="ln114">	fMenuBar = new BMenuBar(fBackground-&gt;Bounds(), &quot;menu&quot;);</a>
<a name="ln115">	CreateMenu();</a>
<a name="ln116">	fBackground-&gt;AddChild(fMenuBar);</a>
<a name="ln117">	fMenuBar-&gt;ResizeToPreferred();</a>
<a name="ln118">	fMenuBarHeight = (int)fMenuBar-&gt;Frame().Height() + 1;</a>
<a name="ln119">	fMenuBar-&gt;SetResizingMode(B_FOLLOW_TOP | B_FOLLOW_LEFT_RIGHT);</a>
<a name="ln120"> </a>
<a name="ln121">	// video view</a>
<a name="ln122">	BRect video_rect = BRect(0, fMenuBarHeight, rect.right, rect.bottom);</a>
<a name="ln123">	fVideoView = new VideoView(video_rect, &quot;video display&quot;, B_FOLLOW_ALL,</a>
<a name="ln124">		B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE);</a>
<a name="ln125">	fBackground-&gt;AddChild(fVideoView);</a>
<a name="ln126"> </a>
<a name="ln127">	fVideoView-&gt;MakeFocus();</a>
<a name="ln128"> </a>
<a name="ln129">//	SetSizeLimits(fControlViewMinWidth - 1, 32767,</a>
<a name="ln130">//		fMenuBarHeight + fControlViewHeight - 1, fMenuBarHeight</a>
<a name="ln131">//		+ fControlViewHeight - 1);</a>
<a name="ln132"> </a>
<a name="ln133">//	SetSizeLimits(320 - 1, 32767, 240 + fMenuBarHeight - 1, 32767);</a>
<a name="ln134"> </a>
<a name="ln135">	SetSizeLimits(0, 32767, fMenuBarHeight - 1, 32767);</a>
<a name="ln136"> </a>
<a name="ln137">	fController-&gt;SetVideoView(fVideoView);</a>
<a name="ln138">	fController-&gt;SetVideoNode(fVideoView-&gt;Node());</a>
<a name="ln139"> </a>
<a name="ln140">	fVideoView-&gt;IsOverlaySupported();</a>
<a name="ln141"> </a>
<a name="ln142">	SetupInterfaceMenu();</a>
<a name="ln143">	SelectInitialInterface();</a>
<a name="ln144">	SetInterfaceMenuMarker();</a>
<a name="ln145">	SetupChannelMenu();</a>
<a name="ln146">	SetChannelMenuMarker();</a>
<a name="ln147"> </a>
<a name="ln148">	VideoFormatChange(fSourceWidth, fSourceHeight, fWidthScale, fHeightScale);</a>
<a name="ln149"> </a>
<a name="ln150">	CenterOnScreen();</a>
<a name="ln151">}</a>
<a name="ln152"> </a>
<a name="ln153"> </a>
<a name="ln154">MainWin::~MainWin()</a>
<a name="ln155">{</a>
<a name="ln156">	printf(&quot;MainWin::~MainWin\n&quot;);</a>
<a name="ln157">	fController-&gt;DisconnectInterface();</a>
<a name="ln158">	delete fController;</a>
<a name="ln159">}</a>
<a name="ln160"> </a>
<a name="ln161"> </a>
<a name="ln162">void</a>
<a name="ln163">MainWin::CreateMenu()</a>
<a name="ln164">{</a>
<a name="ln165">	fFileMenu = new BMenu(B_TRANSLATE(NAME));</a>
<a name="ln166">	fChannelMenu = new BMenu(B_TRANSLATE(&quot;Channel&quot;));</a>
<a name="ln167">	fInterfaceMenu = new BMenu(B_TRANSLATE(&quot;Interface&quot;));</a>
<a name="ln168">	fSettingsMenu = new BMenu(B_TRANSLATE(&quot;Settings&quot;));</a>
<a name="ln169">	fDebugMenu = new BMenu(B_TRANSLATE(&quot;Debug&quot;));</a>
<a name="ln170"> </a>
<a name="ln171">	fMenuBar-&gt;AddItem(fFileMenu);</a>
<a name="ln172">	fMenuBar-&gt;AddItem(fChannelMenu);</a>
<a name="ln173">	fMenuBar-&gt;AddItem(fInterfaceMenu);</a>
<a name="ln174">	fMenuBar-&gt;AddItem(fSettingsMenu);</a>
<a name="ln175">	fMenuBar-&gt;AddItem(fDebugMenu);</a>
<a name="ln176"> </a>
<a name="ln177">	fFileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln178">		new BMessage(M_FILE_QUIT), 'Q', B_COMMAND_KEY));</a>
<a name="ln179"> </a>
<a name="ln180">/*</a>
<a name="ln181">	fChannelMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Next channel&quot;),</a>
<a name="ln182">		new BMessage(M_CHANNEL_NEXT), '+', B_COMMAND_KEY));</a>
<a name="ln183">	fChannelMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Previous channel&quot;),</a>
<a name="ln184">		new BMessage(M_CHANNEL_PREV), '-', B_COMMAND_KEY));</a>
<a name="ln185">	fChannelMenu-&gt;AddSeparatorItem();</a>
<a name="ln186">	fChannelMenu-&gt;AddItem(new BMenuItem(&quot;RTL&quot;, new BMessage(M_DUMMY), '0',</a>
<a name="ln187">		B_COMMAND_KEY));</a>
<a name="ln188">	fChannelMenu-&gt;AddItem(new BMenuItem(&quot;Pro7&quot;, new BMessage(M_DUMMY), '1',</a>
<a name="ln189">		B_COMMAND_KEY));</a>
<a name="ln190"> </a>
<a name="ln191">	fInterfaceMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;none&quot;),</a>
<a name="ln192">		new BMessage(M_DUMMY)));</a>
<a name="ln193">	fInterfaceMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;none 1&quot;),</a>
<a name="ln194">		new BMessage(M_DUMMY)));</a>
<a name="ln195">	fInterfaceMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;none 2&quot;),</a>
<a name="ln196">		new BMessage(M_DUMMY)));</a>
<a name="ln197">*/</a>
<a name="ln198"> </a>
<a name="ln199">	fSettingsMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Scale to native size&quot;),</a>
<a name="ln200">		new BMessage(M_SCALE_TO_NATIVE_SIZE), 'N', B_COMMAND_KEY));</a>
<a name="ln201">	fSettingsMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Full screen&quot;),</a>
<a name="ln202">		new BMessage(M_TOGGLE_FULLSCREEN), 'F', B_COMMAND_KEY));</a>
<a name="ln203">	fSettingsMenu-&gt;AddSeparatorItem();</a>
<a name="ln204">	fSettingsMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;No menu&quot;),</a>
<a name="ln205">		new BMessage(M_TOGGLE_NO_MENU), 'M', B_COMMAND_KEY));</a>
<a name="ln206">	fSettingsMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;No border&quot;),</a>
<a name="ln207">		new BMessage(M_TOGGLE_NO_BORDER), 'B', B_COMMAND_KEY));</a>
<a name="ln208">	fSettingsMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Always on top&quot;),</a>
<a name="ln209">		new BMessage(M_TOGGLE_ALWAYS_ON_TOP), 'T', B_COMMAND_KEY));</a>
<a name="ln210">	fSettingsMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Keep aspect ratio&quot;),</a>
<a name="ln211">		new BMessage(M_TOGGLE_KEEP_ASPECT_RATIO), 'K', B_COMMAND_KEY));</a>
<a name="ln212">	fSettingsMenu-&gt;AddSeparatorItem();</a>
<a name="ln213">	fSettingsMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Settings&quot; B_UTF8_ELLIPSIS)</a>
<a name="ln214">		, new BMessage(M_PREFERENCES), 'P', B_COMMAND_KEY));</a>
<a name="ln215"> </a>
<a name="ln216">	const char* pixel_ratio = B_TRANSLATE(&quot;pixel aspect ratio&quot;);</a>
<a name="ln217">	BString str1 = pixel_ratio;</a>
<a name="ln218">	str1 &lt;&lt; &quot; 1.00000:1&quot;;</a>
<a name="ln219">	fDebugMenu-&gt;AddItem(new BMenuItem(str1.String(),</a>
<a name="ln220">		new BMessage(M_ASPECT_100000_1)));</a>
<a name="ln221">	BString str2 = pixel_ratio;</a>
<a name="ln222">	str2 &lt;&lt; &quot; 1.06666:1&quot;;</a>
<a name="ln223">	fDebugMenu-&gt;AddItem(new BMenuItem(str2.String(),</a>
<a name="ln224">		new BMessage(M_ASPECT_106666_1)));</a>
<a name="ln225">	BString str3 = pixel_ratio;</a>
<a name="ln226">	str3 &lt;&lt; &quot; 1.09091:1&quot;;</a>
<a name="ln227">	fDebugMenu-&gt;AddItem(new BMenuItem(str3.String(),</a>
<a name="ln228">		new BMessage(M_ASPECT_109091_1)));</a>
<a name="ln229">	BString str4 = pixel_ratio;</a>
<a name="ln230">	str4 &lt;&lt; &quot; 1.41176:1&quot;;</a>
<a name="ln231">	fDebugMenu-&gt;AddItem(new BMenuItem(str4.String(),</a>
<a name="ln232">		new BMessage(M_ASPECT_141176_1)));</a>
<a name="ln233">	fDebugMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(</a>
<a name="ln234">		&quot;force 720 x 576, display aspect 4:3&quot;),</a>
<a name="ln235">		new BMessage(M_ASPECT_720_576)));</a>
<a name="ln236">	fDebugMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(</a>
<a name="ln237">		&quot;force 704 x 576, display aspect 4:3&quot;),</a>
<a name="ln238">		new BMessage(M_ASPECT_704_576)));</a>
<a name="ln239">	fDebugMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(</a>
<a name="ln240">		&quot;force 544 x 576, display aspect 4:3&quot;),</a>
<a name="ln241">		new BMessage(M_ASPECT_544_576)));</a>
<a name="ln242"> </a>
<a name="ln243">	fSettingsMenu-&gt;ItemAt(1)-&gt;SetMarked(fIsFullscreen);</a>
<a name="ln244">	fSettingsMenu-&gt;ItemAt(3)-&gt;SetMarked(fNoMenu);</a>
<a name="ln245">	fSettingsMenu-&gt;ItemAt(4)-&gt;SetMarked(fNoBorder);</a>
<a name="ln246">	fSettingsMenu-&gt;ItemAt(5)-&gt;SetMarked(fAlwaysOnTop);</a>
<a name="ln247">	fSettingsMenu-&gt;ItemAt(6)-&gt;SetMarked(fKeepAspectRatio);</a>
<a name="ln248">	fSettingsMenu-&gt;ItemAt(8)-&gt;SetEnabled(false);</a>
<a name="ln249">		// XXX disable unused preference menu</a>
<a name="ln250">}</a>
<a name="ln251"> </a>
<a name="ln252"> </a>
<a name="ln253">void</a>
<a name="ln254">MainWin::SetupInterfaceMenu()</a>
<a name="ln255">{</a>
<a name="ln256">	fInterfaceMenu-&gt;RemoveItems(0, fInterfaceMenu-&gt;CountItems(), true);</a>
<a name="ln257"> </a>
<a name="ln258">	fInterfaceMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;None&quot;),</a>
<a name="ln259">		new BMessage(M_SELECT_INTERFACE)));</a>
<a name="ln260"> </a>
<a name="ln261">	int count = gDeviceRoster-&gt;DeviceCount();</a>
<a name="ln262"> </a>
<a name="ln263">	if (count &gt; 0)</a>
<a name="ln264">		fInterfaceMenu-&gt;AddSeparatorItem();</a>
<a name="ln265"> </a>
<a name="ln266">	for (int i = 0; i &lt; count; i++) {</a>
<a name="ln267">		// 1 gets subtracted in MessageReceived, so -1 is Interface None,</a>
<a name="ln268">		// and 0 == Interface 0 in SelectInterface()</a>
<a name="ln269">		fInterfaceMenu-&gt;AddItem(new BMenuItem(gDeviceRoster-&gt;DeviceName(i),</a>
<a name="ln270">			new BMessage(M_SELECT_INTERFACE + i + 1)));</a>
<a name="ln271">	}</a>
<a name="ln272">}</a>
<a name="ln273"> </a>
<a name="ln274"> </a>
<a name="ln275">void</a>
<a name="ln276">MainWin::SetupChannelMenu()</a>
<a name="ln277">{</a>
<a name="ln278">	fChannelMenu-&gt;RemoveItems(0, fChannelMenu-&gt;CountItems(), true);</a>
<a name="ln279"> </a>
<a name="ln280">	int interface = fController-&gt;CurrentInterface();</a>
<a name="ln281">	printf(&quot;MainWin::SetupChannelMenu: interface %d\n&quot;, interface);</a>
<a name="ln282"> </a>
<a name="ln283">	int channels = fController-&gt;ChannelCount();</a>
<a name="ln284"> </a>
<a name="ln285">	if (channels == 0) {</a>
<a name="ln286">		fChannelMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;None&quot;),</a>
<a name="ln287">			new BMessage(M_DUMMY)));</a>
<a name="ln288">	} else {</a>
<a name="ln289">		fChannelMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Next channel&quot;),</a>
<a name="ln290">			new BMessage(M_CHANNEL_NEXT), '+', B_COMMAND_KEY));</a>
<a name="ln291">		fChannelMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Previous channel&quot;),</a>
<a name="ln292">			new BMessage(M_CHANNEL_PREV), '-', B_COMMAND_KEY));</a>
<a name="ln293">		fChannelMenu-&gt;AddSeparatorItem();</a>
<a name="ln294">	}</a>
<a name="ln295"> </a>
<a name="ln296">	for (int i = 0; i &lt; channels; i++) {</a>
<a name="ln297">		BString string;</a>
<a name="ln298">		string.SetToFormat(&quot;%s%d %s&quot;, (i &lt; 9) ? &quot;  &quot; : &quot;&quot;, i + 1,</a>
<a name="ln299">			fController-&gt;ChannelName(i));</a>
<a name="ln300">		fChannelMenu-&gt;AddItem(new BMenuItem(string,</a>
<a name="ln301">			new BMessage(M_SELECT_CHANNEL + i)));</a>
<a name="ln302">	}</a>
<a name="ln303">}</a>
<a name="ln304"> </a>
<a name="ln305"> </a>
<a name="ln306">void</a>
<a name="ln307">MainWin::SetInterfaceMenuMarker()</a>
<a name="ln308">{</a>
<a name="ln309">	BMenuItem *item;</a>
<a name="ln310"> </a>
<a name="ln311">	int interface = fController-&gt;CurrentInterface();</a>
<a name="ln312">	printf(&quot;MainWin::SetInterfaceMenuMarker: interface %d\n&quot;, interface);</a>
<a name="ln313"> </a>
<a name="ln314">	// remove old marker</a>
<a name="ln315">	item = fInterfaceMenu-&gt;FindMarked();</a>
<a name="ln316">	if (item)</a>
<a name="ln317">		item-&gt;SetMarked(false);</a>
<a name="ln318"> </a>
<a name="ln319">	// set new marker</a>
<a name="ln320">	int index = (interface &lt; 0) ? 0 : interface + 2;</a>
<a name="ln321">	item = fInterfaceMenu-&gt;ItemAt(index);</a>
<a name="ln322">	if (item)</a>
<a name="ln323">		item-&gt;SetMarked(true);</a>
<a name="ln324">}</a>
<a name="ln325"> </a>
<a name="ln326"> </a>
<a name="ln327">void</a>
<a name="ln328">MainWin::SetChannelMenuMarker()</a>
<a name="ln329">{</a>
<a name="ln330">	BMenuItem *item;</a>
<a name="ln331"> </a>
<a name="ln332">	int channel = fController-&gt;CurrentChannel();</a>
<a name="ln333">	printf(&quot;MainWin::SetChannelMenuMarker: channel %d\n&quot;, channel);</a>
<a name="ln334"> </a>
<a name="ln335">	// remove old marker</a>
<a name="ln336">	item = fChannelMenu-&gt;FindMarked();</a>
<a name="ln337">	if (item)</a>
<a name="ln338">		item-&gt;SetMarked(false);</a>
<a name="ln339"> </a>
<a name="ln340">	// set new marker</a>
<a name="ln341">	int index = (channel &lt; 0) ? 0 : channel + 3;</a>
<a name="ln342">	item = fChannelMenu-&gt;ItemAt(index);</a>
<a name="ln343">	if (item)</a>
<a name="ln344">		item-&gt;SetMarked(true);</a>
<a name="ln345">}</a>
<a name="ln346"> </a>
<a name="ln347"> </a>
<a name="ln348">void</a>
<a name="ln349">MainWin::SelectChannel(int i)</a>
<a name="ln350">{</a>
<a name="ln351">	printf(&quot;MainWin::SelectChannel %d\n&quot;, i);</a>
<a name="ln352"> </a>
<a name="ln353">	if (B_OK != fController-&gt;SelectChannel(i))</a>
<a name="ln354">		return;</a>
<a name="ln355"> </a>
<a name="ln356">	SetChannelMenuMarker();</a>
<a name="ln357">}</a>
<a name="ln358"> </a>
<a name="ln359"> </a>
<a name="ln360">void</a>
<a name="ln361">MainWin::SelectInterface(int i)</a>
<a name="ln362">{</a>
<a name="ln363">	printf(&quot;MainWin::SelectInterface %d\n&quot;, i);</a>
<a name="ln364">	printf(&quot;  CurrentInterface %d\n&quot;, fController-&gt;CurrentInterface());</a>
<a name="ln365">	printf(&quot;  CurrentChannel %d\n&quot;, fController-&gt;CurrentChannel());</a>
<a name="ln366"> </a>
<a name="ln367">	// i = -1 means &quot;None&quot;</a>
<a name="ln368"> </a>
<a name="ln369">	if (i &lt; 0) {</a>
<a name="ln370">		fController-&gt;DisconnectInterface();</a>
<a name="ln371">		goto done;</a>
<a name="ln372">	}</a>
<a name="ln373"> </a>
<a name="ln374">	if (!fController-&gt;IsInterfaceAvailable(i)) {</a>
<a name="ln375">		BString s;</a>
<a name="ln376">		s &lt;&lt; B_TRANSLATE(&quot;Error, interface is busy:\n\n&quot;);</a>
<a name="ln377">		s &lt;&lt; gDeviceRoster-&gt;DeviceName(i);</a>
<a name="ln378">		BAlert* alert = new BAlert(&quot;error&quot;, s.String(), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln379">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln380">		alert-&gt;Go();</a>
<a name="ln381">		return;</a>
<a name="ln382">	}</a>
<a name="ln383"> </a>
<a name="ln384">	fController-&gt;DisconnectInterface();</a>
<a name="ln385">	if (fController-&gt;ConnectInterface(i) != B_OK) {</a>
<a name="ln386">		BString s;</a>
<a name="ln387">		s &lt;&lt; B_TRANSLATE(&quot;Error, connecting to interface failed:\n\n&quot;);</a>
<a name="ln388">		s &lt;&lt; gDeviceRoster-&gt;DeviceName(i);</a>
<a name="ln389">		BAlert* alert = new BAlert(&quot;error&quot;, s.String(), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln390">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln391">		alert-&gt;Go();</a>
<a name="ln392">	}</a>
<a name="ln393"> </a>
<a name="ln394">done:</a>
<a name="ln395">	printf(&quot;MainWin::SelectInterface done:\n&quot;);</a>
<a name="ln396">	printf(&quot;  CurrentInterface %d\n&quot;, fController-&gt;CurrentInterface());</a>
<a name="ln397">	printf(&quot;  CurrentChannel %d\n&quot;, fController-&gt;CurrentChannel());</a>
<a name="ln398"> </a>
<a name="ln399">	SetInterfaceMenuMarker();</a>
<a name="ln400">	SetupChannelMenu();</a>
<a name="ln401">	SetChannelMenuMarker();</a>
<a name="ln402">}</a>
<a name="ln403"> </a>
<a name="ln404"> </a>
<a name="ln405">void</a>
<a name="ln406">MainWin::SelectInitialInterface()</a>
<a name="ln407">{</a>
<a name="ln408">	printf(&quot;MainWin::SelectInitialInterface enter\n&quot;);</a>
<a name="ln409"> </a>
<a name="ln410">	int count = gDeviceRoster-&gt;DeviceCount();</a>
<a name="ln411">	for (int i = 0; i &lt; count; i++) {</a>
<a name="ln412">		if (fController-&gt;IsInterfaceAvailable(i)</a>
<a name="ln413">			&amp;&amp; B_OK == fController-&gt;ConnectInterface(i)) {</a>
<a name="ln414">			printf(&quot;MainWin::SelectInitialInterface connected to interface &quot;</a>
<a name="ln415">				&quot;%d\n&quot;, i);</a>
<a name="ln416">			break;</a>
<a name="ln417">		}</a>
<a name="ln418">	}</a>
<a name="ln419"> </a>
<a name="ln420">	printf(&quot;MainWin::SelectInitialInterface leave\n&quot;);</a>
<a name="ln421">}</a>
<a name="ln422"> </a>
<a name="ln423"> </a>
<a name="ln424">bool</a>
<a name="ln425">MainWin::QuitRequested()</a>
<a name="ln426">{</a>
<a name="ln427">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln428">	return true;</a>
<a name="ln429">}</a>
<a name="ln430"> </a>
<a name="ln431"> </a>
<a name="ln432">void</a>
<a name="ln433">MainWin::MouseDown(BMessage *msg)</a>
<a name="ln434">{</a>
<a name="ln435">	BPoint screen_where;</a>
<a name="ln436">	uint32 buttons = msg-&gt;FindInt32(&quot;buttons&quot;);</a>
<a name="ln437"> </a>
<a name="ln438">	// On Zeta, only &quot;screen_where&quot; is relyable, &quot;where&quot; and &quot;be:view_where&quot;</a>
<a name="ln439">	// seem to be broken</a>
<a name="ln440">	if (B_OK != msg-&gt;FindPoint(&quot;screen_where&quot;, &amp;screen_where)) {</a>
<a name="ln441">		// Workaround for BeOS R5, it has no &quot;screen_where&quot;</a>
<a name="ln442">		fVideoView-&gt;GetMouse(&amp;screen_where, &amp;buttons, false);</a>
<a name="ln443">		fVideoView-&gt;ConvertToScreen(&amp;screen_where);</a>
<a name="ln444">	}</a>
<a name="ln445"> </a>
<a name="ln446">//	msg-&gt;PrintToStream();</a>
<a name="ln447"> </a>
<a name="ln448">//	if (1 == msg-&gt;FindInt32(&quot;buttons&quot;) &amp;&amp; msg-&gt;FindInt32(&quot;clicks&quot;) == 1) {</a>
<a name="ln449"> </a>
<a name="ln450">	if (1 == buttons &amp;&amp; msg-&gt;FindInt32(&quot;clicks&quot;) % 2 == 0) {</a>
<a name="ln451">		BRect r(screen_where.x - 1, screen_where.y - 1, screen_where.x + 1,</a>
<a name="ln452">			screen_where.y + 1);</a>
<a name="ln453">		if (r.Contains(fMouseDownMousePos)) {</a>
<a name="ln454">			PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln455">			return;</a>
<a name="ln456">		}</a>
<a name="ln457">	}</a>
<a name="ln458"> </a>
<a name="ln459">	if (2 == buttons &amp;&amp; msg-&gt;FindInt32(&quot;clicks&quot;) % 2 == 0) {</a>
<a name="ln460">		BRect r(screen_where.x - 1, screen_where.y - 1, screen_where.x + 1,</a>
<a name="ln461">			screen_where.y + 1);</a>
<a name="ln462">		if (r.Contains(fMouseDownMousePos)) {</a>
<a name="ln463">			PostMessage(M_TOGGLE_NO_BORDER_NO_MENU);</a>
<a name="ln464">			return;</a>
<a name="ln465">		}</a>
<a name="ln466">	}</a>
<a name="ln467"> </a>
<a name="ln468">/*</a>
<a name="ln469">		// very broken in Zeta:</a>
<a name="ln470">		fMouseDownMousePos = fVideoView-&gt;ConvertToScreen(</a>
<a name="ln471">			msg-&gt;FindPoint(&quot;where&quot;));</a>
<a name="ln472">*/</a>
<a name="ln473">	fMouseDownMousePos = screen_where;</a>
<a name="ln474">	fMouseDownWindowPos = Frame().LeftTop();</a>
<a name="ln475"> </a>
<a name="ln476">	if (buttons == 1 &amp;&amp; !fIsFullscreen) {</a>
<a name="ln477">		// start mouse tracking</a>
<a name="ln478">		fVideoView-&gt;SetMouseEventMask(B_POINTER_EVENTS | B_NO_POINTER_HISTORY</a>
<a name="ln479">			/* | B_LOCK_WINDOW_FOCUS */);</a>
<a name="ln480">		fMouseDownTracking = true;</a>
<a name="ln481">	}</a>
<a name="ln482"> </a>
<a name="ln483">	// pop up a context menu if right mouse button is down for 200 ms</a>
<a name="ln484"> </a>
<a name="ln485">	if ((buttons &amp; 2) == 0)</a>
<a name="ln486">		return;</a>
<a name="ln487">	bigtime_t start = system_time();</a>
<a name="ln488">	bigtime_t delay = 200000;</a>
<a name="ln489">	BPoint location;</a>
<a name="ln490">	do {</a>
<a name="ln491">		fVideoView-&gt;GetMouse(&amp;location, &amp;buttons);</a>
<a name="ln492">		if ((buttons &amp; 2) == 0)</a>
<a name="ln493">			break;</a>
<a name="ln494">		snooze(1000);</a>
<a name="ln495">	} while (system_time() - start &lt; delay);</a>
<a name="ln496"> </a>
<a name="ln497">	if (buttons &amp; 2)</a>
<a name="ln498">		ShowContextMenu(screen_where);</a>
<a name="ln499">}</a>
<a name="ln500"> </a>
<a name="ln501"> </a>
<a name="ln502">void</a>
<a name="ln503">MainWin::MouseMoved(BMessage *msg)</a>
<a name="ln504">{</a>
<a name="ln505">//	msg-&gt;PrintToStream();</a>
<a name="ln506"> </a>
<a name="ln507">	BPoint mousePos;</a>
<a name="ln508">	uint32 buttons = msg-&gt;FindInt32(&quot;buttons&quot;);</a>
<a name="ln509"> </a>
<a name="ln510">	if (1 == buttons &amp;&amp; fMouseDownTracking &amp;&amp; !fIsFullscreen) {</a>
<a name="ln511">/*</a>
<a name="ln512">		// very broken in Zeta:</a>
<a name="ln513">		BPoint mousePos = msg-&gt;FindPoint(&quot;where&quot;);</a>
<a name="ln514">		printf(&quot;view where: %.0f, %.0f =&gt; &quot;, mousePos.x, mousePos.y);</a>
<a name="ln515">		fVideoView-&gt;ConvertToScreen(&amp;mousePos);</a>
<a name="ln516">*/</a>
<a name="ln517">		// On Zeta, only &quot;screen_where&quot; is relyable, &quot;where&quot; and</a>
<a name="ln518">		// &quot;be:view_where&quot; seem to be broken</a>
<a name="ln519">		if (B_OK != msg-&gt;FindPoint(&quot;screen_where&quot;, &amp;mousePos)) {</a>
<a name="ln520">			// Workaround for BeOS R5, it has no &quot;screen_where&quot;</a>
<a name="ln521">			fVideoView-&gt;GetMouse(&amp;mousePos, &amp;buttons, false);</a>
<a name="ln522">			fVideoView-&gt;ConvertToScreen(&amp;mousePos);</a>
<a name="ln523">		}</a>
<a name="ln524">//		printf(&quot;screen where: %.0f, %.0f =&gt; &quot;, mousePos.x, mousePos.y);</a>
<a name="ln525">		float delta_x = mousePos.x - fMouseDownMousePos.x;</a>
<a name="ln526">		float delta_y = mousePos.y - fMouseDownMousePos.y;</a>
<a name="ln527">		float x = fMouseDownWindowPos.x + delta_x;</a>
<a name="ln528">		float y = fMouseDownWindowPos.y + delta_y;</a>
<a name="ln529">//		printf(&quot;move window to %.0f, %.0f\n&quot;, x, y);</a>
<a name="ln530">		MoveTo(x, y);</a>
<a name="ln531">	}</a>
<a name="ln532">}</a>
<a name="ln533"> </a>
<a name="ln534"> </a>
<a name="ln535">void</a>
<a name="ln536">MainWin::MouseUp(BMessage *msg)</a>
<a name="ln537">{</a>
<a name="ln538">//	msg-&gt;PrintToStream();</a>
<a name="ln539">	fMouseDownTracking = false;</a>
<a name="ln540">}</a>
<a name="ln541"> </a>
<a name="ln542"> </a>
<a name="ln543">void</a>
<a name="ln544">MainWin::ShowContextMenu(const BPoint &amp;screen_point)</a>
<a name="ln545">{</a>
<a name="ln546">	printf(&quot;Show context menu\n&quot;);</a>
<a name="ln547">	BPopUpMenu *menu = new BPopUpMenu(&quot;context menu&quot;, false, false);</a>
<a name="ln548">	BMenuItem *item;</a>
<a name="ln549">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Scale to native size&quot;),</a>
<a name="ln550">		new BMessage(M_SCALE_TO_NATIVE_SIZE), 'N', B_COMMAND_KEY));</a>
<a name="ln551">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Full screen&quot;),</a>
<a name="ln552">		new BMessage(M_TOGGLE_FULLSCREEN), 'F', B_COMMAND_KEY));</a>
<a name="ln553">	item-&gt;SetMarked(fIsFullscreen);</a>
<a name="ln554">	menu-&gt;AddSeparatorItem();</a>
<a name="ln555">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;No menu&quot;),</a>
<a name="ln556">		new BMessage(M_TOGGLE_NO_MENU), 'M', B_COMMAND_KEY));</a>
<a name="ln557">	item-&gt;SetMarked(fNoMenu);</a>
<a name="ln558">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;No border&quot;),</a>
<a name="ln559">		new BMessage(M_TOGGLE_NO_BORDER), 'B', B_COMMAND_KEY));</a>
<a name="ln560">	item-&gt;SetMarked(fNoBorder);</a>
<a name="ln561">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Always on top&quot;),</a>
<a name="ln562">		new BMessage(M_TOGGLE_ALWAYS_ON_TOP), 'T', B_COMMAND_KEY));</a>
<a name="ln563">	item-&gt;SetMarked(fAlwaysOnTop);</a>
<a name="ln564">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Keep aspect ratio&quot;),</a>
<a name="ln565">		new BMessage(M_TOGGLE_KEEP_ASPECT_RATIO), 'K', B_COMMAND_KEY));</a>
<a name="ln566">	item-&gt;SetMarked(fKeepAspectRatio);</a>
<a name="ln567">	menu-&gt;AddSeparatorItem();</a>
<a name="ln568">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln569">		new BMessage(M_FILE_QUIT), 'Q', B_COMMAND_KEY));</a>
<a name="ln570"> </a>
<a name="ln571">	menu-&gt;AddSeparatorItem();</a>
<a name="ln572">	const char* pixel_aspect = &quot;pixel aspect ratio&quot;;</a>
<a name="ln573">	BString str1 = pixel_aspect;</a>
<a name="ln574">	str1 &lt;&lt; &quot; 1.00000:1&quot;;</a>
<a name="ln575">	menu-&gt;AddItem(new BMenuItem(str1.String(),</a>
<a name="ln576">		new BMessage(M_ASPECT_100000_1)));</a>
<a name="ln577">	BString str2 = pixel_aspect;</a>
<a name="ln578">	str2 &lt;&lt; &quot; 1.06666:1&quot;;</a>
<a name="ln579">	menu-&gt;AddItem(new BMenuItem(str2.String(),</a>
<a name="ln580">		new BMessage(M_ASPECT_106666_1)));</a>
<a name="ln581">	BString str3 = pixel_aspect;</a>
<a name="ln582">	str3 &lt;&lt; &quot; 1.09091:1&quot;;</a>
<a name="ln583">	menu-&gt;AddItem(new BMenuItem(str3.String(),</a>
<a name="ln584">		new BMessage(M_ASPECT_109091_1)));</a>
<a name="ln585">	BString str4 = pixel_aspect;</a>
<a name="ln586">	str4 &lt;&lt; &quot; 1.41176:1&quot;;</a>
<a name="ln587">	menu-&gt;AddItem(new BMenuItem(str4.String(),</a>
<a name="ln588">		new BMessage(M_ASPECT_141176_1)));</a>
<a name="ln589">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(</a>
<a name="ln590">		&quot;force 720 x 576, display aspect 4:3&quot;),</a>
<a name="ln591">		new BMessage(M_ASPECT_720_576)));</a>
<a name="ln592">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(</a>
<a name="ln593">		&quot;force 704 x 576, display aspect 4:3&quot;),</a>
<a name="ln594">		new BMessage(M_ASPECT_704_576)));</a>
<a name="ln595">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(</a>
<a name="ln596">		&quot;force 544 x 576, display aspect 4:3&quot;),</a>
<a name="ln597">		new BMessage(M_ASPECT_544_576)));</a>
<a name="ln598"> </a>
<a name="ln599">	menu-&gt;SetTargetForItems(this);</a>
<a name="ln600">	BRect r(screen_point.x - 5, screen_point.y - 5, screen_point.x + 5,</a>
<a name="ln601">		screen_point.y + 5);</a>
<a name="ln602">	menu-&gt;Go(screen_point, true, true, r, true);</a>
<a name="ln603">}</a>
<a name="ln604"> </a>
<a name="ln605"> </a>
<a name="ln606">void</a>
<a name="ln607">MainWin::VideoFormatChange(int width, int height, float width_scale,</a>
<a name="ln608">	float height_scale)</a>
<a name="ln609">{</a>
<a name="ln610">	// called when video format or aspect ratio changes</a>
<a name="ln611"> </a>
<a name="ln612">	printf(&quot;VideoFormatChange enter: width %d, height %d, width_scale %.6f, &quot;</a>
<a name="ln613">		&quot;height_scale %.6f\n&quot;, width, height, width_scale, height_scale);</a>
<a name="ln614"> </a>
<a name="ln615">	if (width_scale &lt; 1.0 &amp;&amp; height_scale &gt;= 1.0) {</a>
<a name="ln616">		width_scale  = 1.0 / width_scale;</a>
<a name="ln617">		height_scale = 1.0 / height_scale;</a>
<a name="ln618">		printf(&quot;inverting! new values: width_scale %.6f, height_scale %.6f\n&quot;,</a>
<a name="ln619">			width_scale, height_scale);</a>
<a name="ln620">	}</a>
<a name="ln621"> </a>
<a name="ln622"> 	fSourceWidth  = width;</a>
<a name="ln623"> 	fSourceHeight = height;</a>
<a name="ln624"> 	fWidthScale   = width_scale;</a>
<a name="ln625"> 	fHeightScale  = height_scale;</a>
<a name="ln626"> </a>
<a name="ln627">//	ResizeWindow(Bounds().Width() + 1, Bounds().Height() + 1, true);</a>
<a name="ln628"> </a>
<a name="ln629">	if (fIsFullscreen) {</a>
<a name="ln630">		AdjustFullscreenRenderer();</a>
<a name="ln631">	} else {</a>
<a name="ln632">		AdjustWindowedRenderer(false);</a>
<a name="ln633">	}</a>
<a name="ln634"> </a>
<a name="ln635">	printf(&quot;VideoFormatChange leave\n&quot;);</a>
<a name="ln636"> </a>
<a name="ln637">}</a>
<a name="ln638"> </a>
<a name="ln639"> </a>
<a name="ln640">void</a>
<a name="ln641">MainWin::Zoom(BPoint rec_position, float rec_width, float rec_height)</a>
<a name="ln642">{</a>
<a name="ln643">	PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln644">}</a>
<a name="ln645"> </a>
<a name="ln646"> </a>
<a name="ln647">void</a>
<a name="ln648">MainWin::FrameResized(float new_width, float new_height)</a>
<a name="ln649">{</a>
<a name="ln650">	// called when the window got resized</a>
<a name="ln651">	fFrameResizedCalled = true;</a>
<a name="ln652"> </a>
<a name="ln653">	if (new_width != Bounds().Width() || new_height != Bounds().Height()) {</a>
<a name="ln654">		debugger(&quot;size wrong\n&quot;);</a>
<a name="ln655">	}</a>
<a name="ln656"> </a>
<a name="ln657"> </a>
<a name="ln658">	printf(&quot;FrameResized enter: new_width %.0f, new_height %.0f, bounds width &quot;</a>
<a name="ln659">		&quot;%.0f, bounds height %.0f\n&quot;, new_width, new_height, Bounds().Width(),</a>
<a name="ln660">		Bounds().Height());</a>
<a name="ln661"> </a>
<a name="ln662">	if (fIsFullscreen) {</a>
<a name="ln663"> </a>
<a name="ln664">		printf(&quot;FrameResized in fullscreen mode\n&quot;);</a>
<a name="ln665"> </a>
<a name="ln666">		fIgnoreFrameResized = false;</a>
<a name="ln667">		AdjustFullscreenRenderer();</a>
<a name="ln668"> </a>
<a name="ln669">	} else {</a>
<a name="ln670"> </a>
<a name="ln671">		if (fFrameResizedTriggeredAutomatically) {</a>
<a name="ln672">			fFrameResizedTriggeredAutomatically = false;</a>
<a name="ln673">			printf(&quot;FrameResized triggered automatically\n&quot;);</a>
<a name="ln674"> </a>
<a name="ln675">			fIgnoreFrameResized = false;</a>
<a name="ln676"> </a>
<a name="ln677">			AdjustWindowedRenderer(false);</a>
<a name="ln678">		} else {</a>
<a name="ln679">			printf(&quot;FrameResized by user in window mode\n&quot;);</a>
<a name="ln680"> </a>
<a name="ln681">			if (fIgnoreFrameResized) {</a>
<a name="ln682">				fIgnoreFrameResized = false;</a>
<a name="ln683">				printf(&quot;FrameResized ignored\n&quot;);</a>
<a name="ln684">				return;</a>
<a name="ln685">			}</a>
<a name="ln686"> </a>
<a name="ln687">			AdjustWindowedRenderer(true);</a>
<a name="ln688">		}</a>
<a name="ln689"> </a>
<a name="ln690">	}</a>
<a name="ln691"> </a>
<a name="ln692">	printf(&quot;FrameResized leave\n&quot;);</a>
<a name="ln693">}</a>
<a name="ln694"> </a>
<a name="ln695"> </a>
<a name="ln696"> </a>
<a name="ln697">void</a>
<a name="ln698">MainWin::UpdateWindowTitle()</a>
<a name="ln699">{</a>
<a name="ln700">	BString title;</a>
<a name="ln701">	title.SetToFormat(&quot;%s - %d x %d, %.3f:%.3f =&gt; %.0f x %.0f&quot;,</a>
<a name="ln702">		B_TRANSLATE_SYSTEM_NAME(NAME),</a>
<a name="ln703">		fSourceWidth, fSourceHeight, fWidthScale, fHeightScale,</a>
<a name="ln704">		fVideoView-&gt;Bounds().Width() + 1, fVideoView-&gt;Bounds().Height() + 1);</a>
<a name="ln705">	SetTitle(title);</a>
<a name="ln706">}</a>
<a name="ln707"> </a>
<a name="ln708"> </a>
<a name="ln709">void</a>
<a name="ln710">MainWin::AdjustFullscreenRenderer()</a>
<a name="ln711">{</a>
<a name="ln712">	// n.b. we don't have a menu in fullscreen mode!</a>
<a name="ln713"> </a>
<a name="ln714">	if (fKeepAspectRatio) {</a>
<a name="ln715"> </a>
<a name="ln716">		// Keep aspect ratio, place render inside</a>
<a name="ln717">		// the background area (may create black bars).</a>
<a name="ln718">		float max_width  = fBackground-&gt;Bounds().Width() + 1.0f;</a>
<a name="ln719">		float max_height = fBackground-&gt;Bounds().Height() + 1.0f;</a>
<a name="ln720">		float scaled_width  = fSourceWidth * fWidthScale;</a>
<a name="ln721">		float scaled_height = fSourceHeight * fHeightScale;</a>
<a name="ln722">		float factor = min_c(max_width / scaled_width, max_height</a>
<a name="ln723">			/ scaled_height);</a>
<a name="ln724">		int render_width = int(scaled_width * factor);</a>
<a name="ln725">		int render_height = int(scaled_height * factor);</a>
<a name="ln726">		int x_ofs = (int(max_width) - render_width) / 2;</a>
<a name="ln727">		int y_ofs = (int(max_height) - render_height) / 2;</a>
<a name="ln728"> </a>
<a name="ln729">		printf(&quot;AdjustFullscreenRenderer: background %.1f x %.1f, src video &quot;</a>
<a name="ln730">			&quot;%d x %d, scaled video %.3f x %.3f, factor %.3f, render %d x %d, &quot;</a>
<a name="ln731">			&quot;x-ofs %d, y-ofs %d\n&quot;, max_width, max_height, fSourceWidth,</a>
<a name="ln732">			fSourceHeight, scaled_width, scaled_height, factor, render_width,</a>
<a name="ln733">			render_height, x_ofs, y_ofs);</a>
<a name="ln734"> </a>
<a name="ln735">		fVideoView-&gt;MoveTo(x_ofs, y_ofs);</a>
<a name="ln736">		fVideoView-&gt;ResizeTo(render_width - 1, render_height - 1);</a>
<a name="ln737"> </a>
<a name="ln738">	} else {</a>
<a name="ln739"> </a>
<a name="ln740">		printf(&quot;AdjustFullscreenRenderer: using whole background area\n&quot;);</a>
<a name="ln741"> </a>
<a name="ln742">		// no need to keep aspect ratio, make</a>
<a name="ln743">		// render cover the whole background</a>
<a name="ln744">		fVideoView-&gt;MoveTo(0, 0);</a>
<a name="ln745">		fVideoView-&gt;ResizeTo(fBackground-&gt;Bounds().Width(),</a>
<a name="ln746">			fBackground-&gt;Bounds().Height());</a>
<a name="ln747"> </a>
<a name="ln748">	}</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751"> </a>
<a name="ln752">void</a>
<a name="ln753">MainWin::AdjustWindowedRenderer(bool user_resized)</a>
<a name="ln754">{</a>
<a name="ln755">	printf(&quot;AdjustWindowedRenderer enter - user_resized %d\n&quot;, user_resized);</a>
<a name="ln756"> </a>
<a name="ln757">	// In windowed mode, the renderer always covers the</a>
<a name="ln758">	// whole background, accounting for the menu</a>
<a name="ln759">	fVideoView-&gt;MoveTo(0, fNoMenu ? 0 : fMenuBarHeight);</a>
<a name="ln760">	fVideoView-&gt;ResizeTo(fBackground-&gt;Bounds().Width(),</a>
<a name="ln761">		fBackground-&gt;Bounds().Height() - (fNoMenu ? 0 : fMenuBarHeight));</a>
<a name="ln762"> </a>
<a name="ln763">	if (fKeepAspectRatio) {</a>
<a name="ln764">		// To keep the aspect ratio correct, we</a>
<a name="ln765">		// do resize the window as required</a>
<a name="ln766"> </a>
<a name="ln767">		float max_width  = Bounds().Width() + 1.0f;</a>
<a name="ln768">		float max_height = Bounds().Height() + 1.0f - (fNoMenu ? 0</a>
<a name="ln769">			: fMenuBarHeight);</a>
<a name="ln770">		float scaled_width  = fSourceWidth * fWidthScale;</a>
<a name="ln771">		float scaled_height = fSourceHeight * fHeightScale;</a>
<a name="ln772"> </a>
<a name="ln773">		if (!user_resized &amp;&amp; (scaled_width &gt; max_width</a>
<a name="ln774">			|| scaled_height &gt; max_height)) {</a>
<a name="ln775">			// A format switch occured, and the window was</a>
<a name="ln776">			// smaller then the video source. As it was not</a>
<a name="ln777">			// initiated by the user resizing the window, we</a>
<a name="ln778">			// enlarge the window to fit the video.</a>
<a name="ln779">			fIgnoreFrameResized = true;</a>
<a name="ln780">			ResizeTo(scaled_width - 1, scaled_height - 1</a>
<a name="ln781">				+ (fNoMenu ? 0 : fMenuBarHeight));</a>
<a name="ln782">//			Sync();</a>
<a name="ln783">			return;</a>
<a name="ln784">		}</a>
<a name="ln785"> </a>
<a name="ln786">		float display_aspect_ratio = scaled_width / scaled_height;</a>
<a name="ln787">		int new_width  = int(max_width);</a>
<a name="ln788">		int new_height = int(max_width / display_aspect_ratio + 0.5);</a>
<a name="ln789"> </a>
<a name="ln790">		printf(&quot;AdjustWindowedRenderer: old display %d x %d, src video &quot;</a>
<a name="ln791">			&quot;%d x %d, scaled video %.3f x %.3f, aspect ratio %.3f, new &quot;</a>
<a name="ln792">			&quot;display %d x %d\n&quot;, int(max_width), int(max_height),</a>
<a name="ln793">			fSourceWidth, fSourceHeight, scaled_width, scaled_height,</a>
<a name="ln794">			display_aspect_ratio, new_width, new_height);</a>
<a name="ln795"> </a>
<a name="ln796">		fIgnoreFrameResized = true;</a>
<a name="ln797">		ResizeTo(new_width - 1, new_height - 1 + (fNoMenu ? 0</a>
<a name="ln798">			: fMenuBarHeight));</a>
<a name="ln799">//		Sync();</a>
<a name="ln800">	}</a>
<a name="ln801"> </a>
<a name="ln802">	printf(&quot;AdjustWindowedRenderer leave\n&quot;);</a>
<a name="ln803">}</a>
<a name="ln804"> </a>
<a name="ln805"> </a>
<a name="ln806">void</a>
<a name="ln807">MainWin::ToggleNoBorderNoMenu()</a>
<a name="ln808">{</a>
<a name="ln809">	if (!fNoMenu &amp;&amp; fNoBorder) {</a>
<a name="ln810">		// if no border, switch of menu, too</a>
<a name="ln811">		PostMessage(M_TOGGLE_NO_MENU);</a>
<a name="ln812">	} else</a>
<a name="ln813">	if (fNoMenu &amp;&amp; !fNoBorder) {</a>
<a name="ln814">		// if no menu, switch of border, too</a>
<a name="ln815">		PostMessage(M_TOGGLE_NO_BORDER);</a>
<a name="ln816">	} else {</a>
<a name="ln817">		// both are either on or off, toggle both</a>
<a name="ln818">		PostMessage(M_TOGGLE_NO_MENU);</a>
<a name="ln819">		PostMessage(M_TOGGLE_NO_BORDER);</a>
<a name="ln820">	}</a>
<a name="ln821">}</a>
<a name="ln822"> </a>
<a name="ln823"> </a>
<a name="ln824">void</a>
<a name="ln825">MainWin::ToggleFullscreen()</a>
<a name="ln826">{</a>
<a name="ln827">	printf(&quot;ToggleFullscreen enter\n&quot;);</a>
<a name="ln828"> </a>
<a name="ln829">	if (!fFrameResizedCalled) {</a>
<a name="ln830">		printf(&quot;ToggleFullscreen - ignoring, as FrameResized wasn't called &quot;</a>
<a name="ln831">			&quot;since last switch\n&quot;);</a>
<a name="ln832">		return;</a>
<a name="ln833">	}</a>
<a name="ln834">	fFrameResizedCalled = false;</a>
<a name="ln835"> </a>
<a name="ln836"> </a>
<a name="ln837">	fIsFullscreen = !fIsFullscreen;</a>
<a name="ln838"> </a>
<a name="ln839">	if (fIsFullscreen) {</a>
<a name="ln840">		// switch to fullscreen</a>
<a name="ln841"> </a>
<a name="ln842">		// Sync here is probably not required</a>
<a name="ln843">//		Sync();</a>
<a name="ln844"> </a>
<a name="ln845">		fSavedFrame = Frame();</a>
<a name="ln846">		printf(&quot;saving current frame: %d %d %d %d\n&quot;, int(fSavedFrame.left),</a>
<a name="ln847">			int(fSavedFrame.top), int(fSavedFrame.right),</a>
<a name="ln848">			int(fSavedFrame.bottom));</a>
<a name="ln849">		BScreen screen(this);</a>
<a name="ln850">		BRect rect(screen.Frame());</a>
<a name="ln851"> </a>
<a name="ln852">		Hide();</a>
<a name="ln853">		if (!fNoMenu) {</a>
<a name="ln854">			// if we have a menu, remove it now</a>
<a name="ln855">			fMenuBar-&gt;Hide();</a>
<a name="ln856">		}</a>
<a name="ln857">		fFrameResizedTriggeredAutomatically = true;</a>
<a name="ln858">		MoveTo(rect.left, rect.top);</a>
<a name="ln859">		ResizeTo(rect.Width(), rect.Height());</a>
<a name="ln860">		Show();</a>
<a name="ln861"> </a>
<a name="ln862">//		Sync();</a>
<a name="ln863"> </a>
<a name="ln864">	} else {</a>
<a name="ln865">		// switch back from full screen mode</a>
<a name="ln866"> </a>
<a name="ln867">		Hide();</a>
<a name="ln868">		// if we need a menu, show it now</a>
<a name="ln869">		if (!fNoMenu) {</a>
<a name="ln870">			fMenuBar-&gt;Show();</a>
<a name="ln871">		}</a>
<a name="ln872">		fFrameResizedTriggeredAutomatically = true;</a>
<a name="ln873">		MoveTo(fSavedFrame.left, fSavedFrame.top);</a>
<a name="ln874">		ResizeTo(fSavedFrame.Width(), fSavedFrame.Height());</a>
<a name="ln875">		Show();</a>
<a name="ln876"> </a>
<a name="ln877">		// We *must* make sure that the window is at</a>
<a name="ln878">		// the correct position before continuing, or</a>
<a name="ln879">		// rapid fullscreen switching by holding down</a>
<a name="ln880">		// the TAB key will expose strange bugs.</a>
<a name="ln881">		// Never remove this Sync!</a>
<a name="ln882">//		Sync();</a>
<a name="ln883">	}</a>
<a name="ln884"> </a>
<a name="ln885">	// FrameResized() will do the required adjustments</a>
<a name="ln886"> </a>
<a name="ln887">	printf(&quot;ToggleFullscreen leave\n&quot;);</a>
<a name="ln888">}</a>
<a name="ln889"> </a>
<a name="ln890"> </a>
<a name="ln891">void</a>
<a name="ln892">MainWin::ToggleNoMenu()</a>
<a name="ln893">{</a>
<a name="ln894">	printf(&quot;ToggleNoMenu enter\n&quot;);</a>
<a name="ln895"> </a>
<a name="ln896">	fNoMenu = !fNoMenu;</a>
<a name="ln897"> </a>
<a name="ln898">	if (fIsFullscreen) {</a>
<a name="ln899">		// fullscreen is always without menu</a>
<a name="ln900">		printf(&quot;ToggleNoMenu leave, doing nothing, we are fullscreen\n&quot;);</a>
<a name="ln901">		return;</a>
<a name="ln902">	}</a>
<a name="ln903"> </a>
<a name="ln904">//	fFrameResizedTriggeredAutomatically = true;</a>
<a name="ln905">	fIgnoreFrameResized = true;</a>
<a name="ln906"> </a>
<a name="ln907">	if (fNoMenu) {</a>
<a name="ln908">		fMenuBar-&gt;Hide();</a>
<a name="ln909">		fVideoView-&gt;MoveTo(0, 0);</a>
<a name="ln910">		fVideoView-&gt;ResizeBy(0, fMenuBarHeight);</a>
<a name="ln911">		MoveBy(0, fMenuBarHeight);</a>
<a name="ln912">		ResizeBy(0, - fMenuBarHeight);</a>
<a name="ln913">//		Sync();</a>
<a name="ln914">	} else {</a>
<a name="ln915">		fMenuBar-&gt;Show();</a>
<a name="ln916">		fVideoView-&gt;MoveTo(0, fMenuBarHeight);</a>
<a name="ln917">		fVideoView-&gt;ResizeBy(0, -fMenuBarHeight);</a>
<a name="ln918">		MoveBy(0, - fMenuBarHeight);</a>
<a name="ln919">		ResizeBy(0, fMenuBarHeight);</a>
<a name="ln920">//		Sync();</a>
<a name="ln921">	}</a>
<a name="ln922"> </a>
<a name="ln923">	printf(&quot;ToggleNoMenu leave\n&quot;);</a>
<a name="ln924">}</a>
<a name="ln925"> </a>
<a name="ln926"> </a>
<a name="ln927">void</a>
<a name="ln928">MainWin::ToggleNoBorder()</a>
<a name="ln929">{</a>
<a name="ln930">	printf(&quot;ToggleNoBorder enter\n&quot;);</a>
<a name="ln931">	fNoBorder = !fNoBorder;</a>
<a name="ln932">//	SetLook(fNoBorder ? B_NO_BORDER_WINDOW_LOOK : B_TITLED_WINDOW_LOOK);</a>
<a name="ln933">	SetLook(fNoBorder ? B_BORDERED_WINDOW_LOOK : B_TITLED_WINDOW_LOOK);</a>
<a name="ln934">	printf(&quot;ToggleNoBorder leave\n&quot;);</a>
<a name="ln935">}</a>
<a name="ln936"> </a>
<a name="ln937"> </a>
<a name="ln938">void</a>
<a name="ln939">MainWin::ToggleAlwaysOnTop()</a>
<a name="ln940">{</a>
<a name="ln941">	printf(&quot;ToggleAlwaysOnTop enter\n&quot;);</a>
<a name="ln942">	fAlwaysOnTop = !fAlwaysOnTop;</a>
<a name="ln943">	SetFeel(fAlwaysOnTop ? B_FLOATING_ALL_WINDOW_FEEL : B_NORMAL_WINDOW_FEEL);</a>
<a name="ln944">	printf(&quot;ToggleAlwaysOnTop leave\n&quot;);</a>
<a name="ln945">}</a>
<a name="ln946"> </a>
<a name="ln947"> </a>
<a name="ln948">void</a>
<a name="ln949">MainWin::ToggleKeepAspectRatio()</a>
<a name="ln950">{</a>
<a name="ln951">	printf(&quot;ToggleKeepAspectRatio enter\n&quot;);</a>
<a name="ln952">	fKeepAspectRatio = !fKeepAspectRatio;</a>
<a name="ln953"> </a>
<a name="ln954">	fFrameResizedTriggeredAutomatically = true;</a>
<a name="ln955">	FrameResized(Bounds().Width(), Bounds().Height());</a>
<a name="ln956">//	if (fIsFullscreen) {</a>
<a name="ln957">//		AdjustFullscreenRenderer();</a>
<a name="ln958">//	} else {</a>
<a name="ln959">//		AdjustWindowedRenderer(false);</a>
<a name="ln960">//	}</a>
<a name="ln961">	printf(&quot;ToggleKeepAspectRatio leave\n&quot;);</a>
<a name="ln962">}</a>
<a name="ln963"> </a>
<a name="ln964"> </a>
<a name="ln965">/* Trap keys that are about to be send to background or renderer view.</a>
<a name="ln966"> * Return B_OK if it shouldn't be passed to the view</a>
<a name="ln967"> */</a>
<a name="ln968">status_t</a>
<a name="ln969">MainWin::KeyDown(BMessage *msg)</a>
<a name="ln970">{</a>
<a name="ln971">//	msg-&gt;PrintToStream();</a>
<a name="ln972"> </a>
<a name="ln973">	uint32 key		 = msg-&gt;FindInt32(&quot;key&quot;);</a>
<a name="ln974">	uint32 raw_char  = msg-&gt;FindInt32(&quot;raw_char&quot;);</a>
<a name="ln975">	uint32 modifiers = msg-&gt;FindInt32(&quot;modifiers&quot;);</a>
<a name="ln976"> </a>
<a name="ln977">	printf(&quot;key 0x%&quot; B_PRIx32 &quot;, raw_char 0x%&quot; B_PRIx32 &quot;, modifiers 0x%&quot; B_PRIx32 &quot;\n&quot;, key, raw_char,</a>
<a name="ln978">		modifiers);</a>
<a name="ln979"> </a>
<a name="ln980">	switch (raw_char) {</a>
<a name="ln981">		case B_SPACE:</a>
<a name="ln982">			PostMessage(M_TOGGLE_NO_BORDER_NO_MENU);</a>
<a name="ln983">			return B_OK;</a>
<a name="ln984"> </a>
<a name="ln985">		case B_ESCAPE:</a>
<a name="ln986">			if (fIsFullscreen) {</a>
<a name="ln987">				PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln988">				return B_OK;</a>
<a name="ln989">			} else</a>
<a name="ln990">				break;</a>
<a name="ln991"> </a>
<a name="ln992">		case B_ENTER:		// Enter / Return</a>
<a name="ln993">			if (modifiers &amp; B_COMMAND_KEY) {</a>
<a name="ln994">				PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln995">				return B_OK;</a>
<a name="ln996">			} else</a>
<a name="ln997">				break;</a>
<a name="ln998"> </a>
<a name="ln999">		case B_TAB:</a>
<a name="ln1000">			if ((modifiers &amp; (B_COMMAND_KEY | B_CONTROL_KEY | B_OPTION_KEY</a>
<a name="ln1001">				| B_MENU_KEY)) == 0) {</a>
<a name="ln1002">				PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln1003">				return B_OK;</a>
<a name="ln1004">			} else</a>
<a name="ln1005">				break;</a>
<a name="ln1006"> </a>
<a name="ln1007">		case B_UP_ARROW:</a>
<a name="ln1008">			if (modifiers &amp; B_COMMAND_KEY) {</a>
<a name="ln1009">				PostMessage(M_CHANNEL_NEXT);</a>
<a name="ln1010">			} else {</a>
<a name="ln1011">				PostMessage(M_VOLUME_UP);</a>
<a name="ln1012">			}</a>
<a name="ln1013">			return B_OK;</a>
<a name="ln1014"> </a>
<a name="ln1015">		case B_DOWN_ARROW:</a>
<a name="ln1016">			if (modifiers &amp; B_COMMAND_KEY) {</a>
<a name="ln1017">				PostMessage(M_CHANNEL_PREV);</a>
<a name="ln1018">			} else {</a>
<a name="ln1019">				PostMessage(M_VOLUME_DOWN);</a>
<a name="ln1020">			}</a>
<a name="ln1021">			return B_OK;</a>
<a name="ln1022"> </a>
<a name="ln1023">		case B_RIGHT_ARROW:</a>
<a name="ln1024">			if (modifiers &amp; B_COMMAND_KEY) {</a>
<a name="ln1025">				PostMessage(M_VOLUME_UP);</a>
<a name="ln1026">			} else {</a>
<a name="ln1027">				PostMessage(M_CHANNEL_NEXT);</a>
<a name="ln1028">			}</a>
<a name="ln1029">			return B_OK;</a>
<a name="ln1030"> </a>
<a name="ln1031">		case B_LEFT_ARROW:</a>
<a name="ln1032">			if (modifiers &amp; B_COMMAND_KEY) {</a>
<a name="ln1033">				PostMessage(M_VOLUME_DOWN);</a>
<a name="ln1034">			} else {</a>
<a name="ln1035">				PostMessage(M_CHANNEL_PREV);</a>
<a name="ln1036">			}</a>
<a name="ln1037">			return B_OK;</a>
<a name="ln1038"> </a>
<a name="ln1039">		case B_PAGE_UP:</a>
<a name="ln1040">			PostMessage(M_CHANNEL_NEXT);</a>
<a name="ln1041">			return B_OK;</a>
<a name="ln1042"> </a>
<a name="ln1043">		case B_PAGE_DOWN:</a>
<a name="ln1044">			PostMessage(M_CHANNEL_PREV);</a>
<a name="ln1045">			return B_OK;</a>
<a name="ln1046">	}</a>
<a name="ln1047"> </a>
<a name="ln1048">	switch (key) {</a>
<a name="ln1049">		case 0x3a:  		// numeric keypad +</a>
<a name="ln1050">			if ((modifiers &amp; B_COMMAND_KEY) == 0) {</a>
<a name="ln1051">				printf(&quot;if\n&quot;);</a>
<a name="ln1052">				PostMessage(M_VOLUME_UP);</a>
<a name="ln1053">				return B_OK;</a>
<a name="ln1054">			} else {</a>
<a name="ln1055">				printf(&quot;else\n&quot;);</a>
<a name="ln1056">				break;</a>
<a name="ln1057">			}</a>
<a name="ln1058"> </a>
<a name="ln1059">		case 0x25:  		// numeric keypad -</a>
<a name="ln1060">			if ((modifiers &amp; B_COMMAND_KEY) == 0) {</a>
<a name="ln1061">				PostMessage(M_VOLUME_DOWN);</a>
<a name="ln1062">				return B_OK;</a>
<a name="ln1063">			} else {</a>
<a name="ln1064">				break;</a>
<a name="ln1065">			}</a>
<a name="ln1066"> </a>
<a name="ln1067">		case 0x38:			// numeric keypad up arrow</a>
<a name="ln1068">			PostMessage(M_VOLUME_UP);</a>
<a name="ln1069">			return B_OK;</a>
<a name="ln1070"> </a>
<a name="ln1071">		case 0x59:			// numeric keypad down arrow</a>
<a name="ln1072">			PostMessage(M_VOLUME_DOWN);</a>
<a name="ln1073">			return B_OK;</a>
<a name="ln1074"> </a>
<a name="ln1075">		case 0x39:			// numeric keypad page up</a>
<a name="ln1076">		case 0x4a:			// numeric keypad right arrow</a>
<a name="ln1077">			PostMessage(M_CHANNEL_NEXT);</a>
<a name="ln1078">			return B_OK;</a>
<a name="ln1079"> </a>
<a name="ln1080">		case 0x5a:			// numeric keypad page down</a>
<a name="ln1081">		case 0x48:			// numeric keypad left arrow</a>
<a name="ln1082">			PostMessage(M_CHANNEL_PREV);</a>
<a name="ln1083">			return B_OK;</a>
<a name="ln1084">	}</a>
<a name="ln1085"> </a>
<a name="ln1086">	return B_ERROR;</a>
<a name="ln1087">}</a>
<a name="ln1088"> </a>
<a name="ln1089"> </a>
<a name="ln1090">void</a>
<a name="ln1091">MainWin::DispatchMessage(BMessage *msg, BHandler *handler)</a>
<a name="ln1092">{</a>
<a name="ln1093">	if ((msg-&gt;what == B_MOUSE_DOWN) &amp;&amp; (handler == fBackground</a>
<a name="ln1094">		|| handler == fVideoView))</a>
<a name="ln1095">		MouseDown(msg);</a>
<a name="ln1096">	if ((msg-&gt;what == B_MOUSE_MOVED) &amp;&amp; (handler == fBackground</a>
<a name="ln1097">		|| handler == fVideoView))</a>
<a name="ln1098">		MouseMoved(msg);</a>
<a name="ln1099">	if ((msg-&gt;what == B_MOUSE_UP) &amp;&amp; (handler == fBackground</a>
<a name="ln1100">		|| handler == fVideoView))</a>
<a name="ln1101">		MouseUp(msg);</a>
<a name="ln1102"> </a>
<a name="ln1103">	if ((msg-&gt;what == B_KEY_DOWN) &amp;&amp; (handler == fBackground</a>
<a name="ln1104">		|| handler == fVideoView)) {</a>
<a name="ln1105"> </a>
<a name="ln1106">		// special case for PrintScreen key</a>
<a name="ln1107">		if (msg-&gt;FindInt32(&quot;key&quot;) == B_PRINT_KEY) {</a>
<a name="ln1108">			fVideoView-&gt;OverlayScreenshotPrepare();</a>
<a name="ln1109">			BWindow::DispatchMessage(msg, handler);</a>
<a name="ln1110">			fVideoView-&gt;OverlayScreenshotCleanup();</a>
<a name="ln1111">			return;</a>
<a name="ln1112">		}</a>
<a name="ln1113"> </a>
<a name="ln1114">		// every other key gets dispatched to our KeyDown first</a>
<a name="ln1115">		if (KeyDown(msg) == B_OK) {</a>
<a name="ln1116">			// it got handled, don't pass it on</a>
<a name="ln1117">			return;</a>
<a name="ln1118">		}</a>
<a name="ln1119">	}</a>
<a name="ln1120"> </a>
<a name="ln1121">	BWindow::DispatchMessage(msg, handler);</a>
<a name="ln1122">}</a>
<a name="ln1123"> </a>
<a name="ln1124"> </a>
<a name="ln1125">void</a>
<a name="ln1126">MainWin::MessageReceived(BMessage *msg)</a>
<a name="ln1127">{</a>
<a name="ln1128">	switch (msg-&gt;what) {</a>
<a name="ln1129">		case B_ACQUIRE_OVERLAY_LOCK:</a>
<a name="ln1130">			printf(&quot;B_ACQUIRE_OVERLAY_LOCK\n&quot;);</a>
<a name="ln1131">			fVideoView-&gt;OverlayLockAcquire();</a>
<a name="ln1132">			break;</a>
<a name="ln1133"> </a>
<a name="ln1134">		case B_RELEASE_OVERLAY_LOCK:</a>
<a name="ln1135">			printf(&quot;B_RELEASE_OVERLAY_LOCK\n&quot;);</a>
<a name="ln1136">			fVideoView-&gt;OverlayLockRelease();</a>
<a name="ln1137">			break;</a>
<a name="ln1138"> </a>
<a name="ln1139">		case B_MOUSE_WHEEL_CHANGED:</a>
<a name="ln1140">		{</a>
<a name="ln1141">			printf(&quot;B_MOUSE_WHEEL_CHANGED\n&quot;);</a>
<a name="ln1142">			float dx = msg-&gt;FindFloat(&quot;be:wheel_delta_x&quot;);</a>
<a name="ln1143">			float dy = msg-&gt;FindFloat(&quot;be:wheel_delta_y&quot;);</a>
<a name="ln1144">			bool inv = modifiers() &amp; B_COMMAND_KEY;</a>
<a name="ln1145">			if (dx &gt; 0.1)	PostMessage(inv ? M_VOLUME_DOWN : M_CHANNEL_PREV);</a>
<a name="ln1146">			if (dx &lt; -0.1)	PostMessage(inv ? M_VOLUME_UP : M_CHANNEL_NEXT);</a>
<a name="ln1147">			if (dy &gt; 0.1)	PostMessage(inv ? M_CHANNEL_PREV : M_VOLUME_DOWN);</a>
<a name="ln1148">			if (dy &lt; -0.1)	PostMessage(inv ? M_CHANNEL_NEXT : M_VOLUME_UP);</a>
<a name="ln1149">			break;</a>
<a name="ln1150">		}</a>
<a name="ln1151"> </a>
<a name="ln1152">		case M_CHANNEL_NEXT:</a>
<a name="ln1153">		{</a>
<a name="ln1154">			printf(&quot;M_CHANNEL_NEXT\n&quot;);</a>
<a name="ln1155">			int chan = fController-&gt;CurrentChannel();</a>
<a name="ln1156">			if (chan != -1) {</a>
<a name="ln1157">				chan++;</a>
<a name="ln1158">				if (chan &lt; fController-&gt;ChannelCount())</a>
<a name="ln1159">					SelectChannel(chan);</a>
<a name="ln1160">			}</a>
<a name="ln1161">			break;</a>
<a name="ln1162">		}</a>
<a name="ln1163"> </a>
<a name="ln1164">		case M_CHANNEL_PREV:</a>
<a name="ln1165">		{</a>
<a name="ln1166">			printf(&quot;M_CHANNEL_PREV\n&quot;);</a>
<a name="ln1167">			int chan = fController-&gt;CurrentChannel();</a>
<a name="ln1168">			if (chan != -1) {</a>
<a name="ln1169">				chan--;</a>
<a name="ln1170">				if (chan &gt;= 0)</a>
<a name="ln1171">					SelectChannel(chan);</a>
<a name="ln1172">			}</a>
<a name="ln1173">			break;</a>
<a name="ln1174">		}</a>
<a name="ln1175"> </a>
<a name="ln1176">		case M_VOLUME_UP:</a>
<a name="ln1177">			printf(&quot;M_VOLUME_UP\n&quot;);</a>
<a name="ln1178">			fController-&gt;VolumeUp();</a>
<a name="ln1179">			break;</a>
<a name="ln1180"> </a>
<a name="ln1181">		case M_VOLUME_DOWN:</a>
<a name="ln1182">			printf(&quot;M_VOLUME_DOWN\n&quot;);</a>
<a name="ln1183">			fController-&gt;VolumeDown();</a>
<a name="ln1184">			break;</a>
<a name="ln1185"> </a>
<a name="ln1186">		case M_ASPECT_100000_1:</a>
<a name="ln1187">			VideoFormatChange(fSourceWidth, fSourceHeight, 1.0, 1.0);</a>
<a name="ln1188">			break;</a>
<a name="ln1189"> </a>
<a name="ln1190">		case M_ASPECT_106666_1:</a>
<a name="ln1191">			VideoFormatChange(fSourceWidth, fSourceHeight, 1.06666, 1.0);</a>
<a name="ln1192">			break;</a>
<a name="ln1193"> </a>
<a name="ln1194">		case M_ASPECT_109091_1:</a>
<a name="ln1195">			VideoFormatChange(fSourceWidth, fSourceHeight, 1.09091, 1.0);</a>
<a name="ln1196">			break;</a>
<a name="ln1197"> </a>
<a name="ln1198">		case M_ASPECT_141176_1:</a>
<a name="ln1199">			VideoFormatChange(fSourceWidth, fSourceHeight, 1.41176, 1.0);</a>
<a name="ln1200">			break;</a>
<a name="ln1201"> </a>
<a name="ln1202">		case M_ASPECT_720_576:</a>
<a name="ln1203">			VideoFormatChange(720, 576, 1.06666, 1.0);</a>
<a name="ln1204">			break;</a>
<a name="ln1205"> </a>
<a name="ln1206">		case M_ASPECT_704_576:</a>
<a name="ln1207">			VideoFormatChange(704, 576, 1.09091, 1.0);</a>
<a name="ln1208">			break;</a>
<a name="ln1209"> </a>
<a name="ln1210">		case M_ASPECT_544_576:</a>
<a name="ln1211">			VideoFormatChange(544, 576, 1.41176, 1.0);</a>
<a name="ln1212">			break;</a>
<a name="ln1213"> </a>
<a name="ln1214">		case B_REFS_RECEIVED:</a>
<a name="ln1215">			printf(&quot;MainWin::MessageReceived: B_REFS_RECEIVED\n&quot;);</a>
<a name="ln1216">//			RefsReceived(msg);</a>
<a name="ln1217">			break;</a>
<a name="ln1218"> </a>
<a name="ln1219">		case B_SIMPLE_DATA:</a>
<a name="ln1220">			printf(&quot;MainWin::MessageReceived: B_SIMPLE_DATA\n&quot;);</a>
<a name="ln1221">//			if (msg-&gt;HasRef(&quot;refs&quot;))</a>
<a name="ln1222">//				RefsReceived(msg);</a>
<a name="ln1223">			break;</a>
<a name="ln1224"> </a>
<a name="ln1225">		case M_FILE_QUIT:</a>
<a name="ln1226">//			be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln1227">			PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln1228">			break;</a>
<a name="ln1229"> </a>
<a name="ln1230">		case M_SCALE_TO_NATIVE_SIZE:</a>
<a name="ln1231">			printf(&quot;M_SCALE_TO_NATIVE_SIZE\n&quot;);</a>
<a name="ln1232">			if (fIsFullscreen) {</a>
<a name="ln1233">				ToggleFullscreen();</a>
<a name="ln1234">			}</a>
<a name="ln1235">			ResizeTo(int(fSourceWidth * fWidthScale),</a>
<a name="ln1236">					 int(fSourceHeight * fHeightScale) + (fNoMenu ? 0</a>
<a name="ln1237">					 	: fMenuBarHeight));</a>
<a name="ln1238">//			Sync();</a>
<a name="ln1239">			break;</a>
<a name="ln1240"> </a>
<a name="ln1241">		case M_TOGGLE_FULLSCREEN:</a>
<a name="ln1242">			ToggleFullscreen();</a>
<a name="ln1243">			fSettingsMenu-&gt;ItemAt(1)-&gt;SetMarked(fIsFullscreen);</a>
<a name="ln1244">			break;</a>
<a name="ln1245"> </a>
<a name="ln1246">		case M_TOGGLE_NO_MENU:</a>
<a name="ln1247">			ToggleNoMenu();</a>
<a name="ln1248">			fSettingsMenu-&gt;ItemAt(3)-&gt;SetMarked(fNoMenu);</a>
<a name="ln1249">			break;</a>
<a name="ln1250"> </a>
<a name="ln1251">		case M_TOGGLE_NO_BORDER:</a>
<a name="ln1252">			ToggleNoBorder();</a>
<a name="ln1253">			fSettingsMenu-&gt;ItemAt(4)-&gt;SetMarked(fNoBorder);</a>
<a name="ln1254">			break;</a>
<a name="ln1255"> </a>
<a name="ln1256">		case M_TOGGLE_ALWAYS_ON_TOP:</a>
<a name="ln1257">			ToggleAlwaysOnTop();</a>
<a name="ln1258">			fSettingsMenu-&gt;ItemAt(5)-&gt;SetMarked(fAlwaysOnTop);</a>
<a name="ln1259">			break;</a>
<a name="ln1260"> </a>
<a name="ln1261">		case M_TOGGLE_KEEP_ASPECT_RATIO:</a>
<a name="ln1262">			ToggleKeepAspectRatio();</a>
<a name="ln1263">			fSettingsMenu-&gt;ItemAt(6)-&gt;SetMarked(fKeepAspectRatio);</a>
<a name="ln1264">			break;</a>
<a name="ln1265"> </a>
<a name="ln1266">		case M_TOGGLE_NO_BORDER_NO_MENU:</a>
<a name="ln1267">			ToggleNoBorderNoMenu();</a>
<a name="ln1268">			break;</a>
<a name="ln1269"> </a>
<a name="ln1270">		case M_PREFERENCES:</a>
<a name="ln1271">			break;</a>
<a name="ln1272"> </a>
<a name="ln1273">		default:</a>
<a name="ln1274">			if (msg-&gt;what &gt;= M_SELECT_CHANNEL</a>
<a name="ln1275">				&amp;&amp; msg-&gt;what &lt;= M_SELECT_CHANNEL_END) {</a>
<a name="ln1276">				SelectChannel(msg-&gt;what - M_SELECT_CHANNEL);</a>
<a name="ln1277">				break;</a>
<a name="ln1278">			}</a>
<a name="ln1279">			if (msg-&gt;what &gt;= M_SELECT_INTERFACE</a>
<a name="ln1280">				&amp;&amp; msg-&gt;what &lt;= M_SELECT_INTERFACE_END) {</a>
<a name="ln1281">				SelectInterface(msg-&gt;what - M_SELECT_INTERFACE - 1);</a>
<a name="ln1282">				break;</a>
<a name="ln1283">			}</a>
<a name="ln1284">	}</a>
<a name="ln1285">}</a>
<a name="ln1286"> </a>

</code></pre>
<div class="balloon" rel="603"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'menu' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
