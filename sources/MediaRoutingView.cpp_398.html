
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>MediaRoutingView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright (c) 1999-2000, Eric Moon.</a>
<a name="ln3"> * All rights reserved.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Redistribution and use in source and binary forms, with or without</a>
<a name="ln6"> * modification, are permitted provided that the following conditions</a>
<a name="ln7"> * are met:</a>
<a name="ln8"> *</a>
<a name="ln9"> * 1. Redistributions of source code must retain the above copyright</a>
<a name="ln10"> *    notice, this list of conditions, and the following disclaimer.</a>
<a name="ln11"> *</a>
<a name="ln12"> * 2. Redistributions in binary form must reproduce the above copyright</a>
<a name="ln13"> *    notice, this list of conditions, and the following disclaimer in the</a>
<a name="ln14"> *    documentation and/or other materials provided with the distribution.</a>
<a name="ln15"> *</a>
<a name="ln16"> * 3. The name of the author may not be used to endorse or promote products</a>
<a name="ln17"> *    derived from this software without specific prior written permission.</a>
<a name="ln18"> *</a>
<a name="ln19"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR &quot;AS IS&quot; AND ANY EXPRESS OR</a>
<a name="ln20"> * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</a>
<a name="ln21"> * OF TITLE, NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS FOR A PARTICULAR</a>
<a name="ln22"> * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</a>
<a name="ln23"> * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</a>
<a name="ln24"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</a>
<a name="ln25"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</a>
<a name="ln26"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</a>
<a name="ln27"> * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</a>
<a name="ln28"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</a>
<a name="ln29"> */</a>
<a name="ln30"> </a>
<a name="ln31"> </a>
<a name="ln32">// MediaRoutingView.cpp</a>
<a name="ln33"> </a>
<a name="ln34">#include &quot;MediaRoutingView.h&quot;</a>
<a name="ln35"> </a>
<a name="ln36">// RouteApp</a>
<a name="ln37">#include &quot;RouteApp.h&quot;</a>
<a name="ln38">#include &quot;RouteAppNodeManager.h&quot;</a>
<a name="ln39">#include &quot;RouteWindow.h&quot;</a>
<a name="ln40">#include &quot;NodeSetIOContext.h&quot;</a>
<a name="ln41">// DormantNodeView</a>
<a name="ln42">#include &quot;DormantNodeView.h&quot;</a>
<a name="ln43">// InfoWindow</a>
<a name="ln44">#include &quot;InfoWindowManager.h&quot;</a>
<a name="ln45">// TransportWindow</a>
<a name="ln46">#include &quot;TransportWindow.h&quot;</a>
<a name="ln47">// MediaRoutingView</a>
<a name="ln48">#include &quot;MediaNodePanel.h&quot;</a>
<a name="ln49">#include &quot;MediaWire.h&quot;</a>
<a name="ln50">// NodeManager</a>
<a name="ln51">#include &quot;NodeGroup.h&quot;</a>
<a name="ln52">#include &quot;NodeRef.h&quot;</a>
<a name="ln53">#include &quot;Connection.h&quot;</a>
<a name="ln54">// ParameterWindow</a>
<a name="ln55">#include &quot;ParameterWindowManager.h&quot;</a>
<a name="ln56"> </a>
<a name="ln57">// Application Kit</a>
<a name="ln58">#include &lt;Application.h&gt;</a>
<a name="ln59">// Interface Kit</a>
<a name="ln60">#include &lt;Alert.h&gt;</a>
<a name="ln61">#include &lt;Bitmap.h&gt;</a>
<a name="ln62">#include &lt;MenuItem.h&gt;</a>
<a name="ln63">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln64">#include &lt;Window.h&gt;</a>
<a name="ln65">// Media Kit</a>
<a name="ln66">#include &lt;MediaRoster.h&gt;</a>
<a name="ln67">// Storage Kit</a>
<a name="ln68">#include &lt;File.h&gt;</a>
<a name="ln69">#include &lt;NodeInfo.h&gt;</a>
<a name="ln70">#include &lt;Path.h&gt;</a>
<a name="ln71">// Translation Kit</a>
<a name="ln72">#include &lt;BitmapStream.h&gt;</a>
<a name="ln73">#include &lt;TranslatorRoster.h&gt;</a>
<a name="ln74"> </a>
<a name="ln75">__USE_CORTEX_NAMESPACE</a>
<a name="ln76"> </a>
<a name="ln77">#include &lt;Debug.h&gt;</a>
<a name="ln78">#define D_METHOD(x) //PRINT (x)</a>
<a name="ln79">#define D_MESSAGE(x) //PRINT (x)</a>
<a name="ln80">#define D_MOUSE(x) //PRINT (x)</a>
<a name="ln81">#define D_KEY(x) //PRINT (x)</a>
<a name="ln82"> </a>
<a name="ln83">// ---------------------------------------------------------------- //</a>
<a name="ln84">// constants</a>
<a name="ln85">// ---------------------------------------------------------------- //</a>
<a name="ln86"> </a>
<a name="ln87">float	MediaRoutingView::M_CLEANUP_H_GAP			= 25.0;</a>
<a name="ln88">float	MediaRoutingView::M_CLEANUP_V_GAP			= 10.0;</a>
<a name="ln89">float	MediaRoutingView::M_CLEANUP_H_MARGIN 		= 15.0;</a>
<a name="ln90">float	MediaRoutingView::M_CLEANUP_V_MARGIN 		= 10.0;</a>
<a name="ln91"> </a>
<a name="ln92">// ---------------------------------------------------------------- //</a>
<a name="ln93">// m_inactiveNodeState content</a>
<a name="ln94">// ---------------------------------------------------------------- //</a>
<a name="ln95"> </a>
<a name="ln96">struct _inactive_node_state_entry {</a>
<a name="ln97">	_inactive_node_state_entry(</a>
<a name="ln98">		const char* _name, int32 _kind, const BMessage&amp; _state) :</a>
<a name="ln99">		name(_name), kind(_kind), state(_state) {}</a>
<a name="ln100"> </a>
<a name="ln101">	BString name;</a>
<a name="ln102">	uint32 kind;</a>
<a name="ln103">	BMessage state;</a>
<a name="ln104">};</a>
<a name="ln105"> </a>
<a name="ln106">// ---------------------------------------------------------------- //</a>
<a name="ln107">// ctor/dtor</a>
<a name="ln108">// ---------------------------------------------------------------- //</a>
<a name="ln109"> </a>
<a name="ln110">MediaRoutingView::MediaRoutingView(</a>
<a name="ln111">	RouteAppNodeManager *nodeManager,</a>
<a name="ln112">	BRect frame,</a>
<a name="ln113">	const char *name,</a>
<a name="ln114">	uint32 resizeMode)</a>
<a name="ln115">	: DiagramView(frame, &quot;MediaRoutingView&quot;, true, B_FOLLOW_ALL_SIDES),</a>
<a name="ln116">	  manager(nodeManager),</a>
<a name="ln117">	  m_layout(M_ICON_VIEW),</a>
<a name="ln118">	  m_nextGroupNumber(1),</a>
<a name="ln119">	  m_lastDroppedNode(0),</a>
<a name="ln120">	  m_draggedWire(0)</a>
<a name="ln121">{</a>
<a name="ln122">	D_METHOD((&quot;MediaRoutingView::MediaRoutingView()\n&quot;));</a>
<a name="ln123">	ASSERT(manager);</a>
<a name="ln124"> </a>
<a name="ln125">	setBackgroundColor(tint_color(ui_color(B_PANEL_BACKGROUND_COLOR), B_DARKEN_2_TINT));</a>
<a name="ln126">	SetItemAlignment(5.0, 5.0);</a>
<a name="ln127">	_initLayout();</a>
<a name="ln128">}</a>
<a name="ln129"> </a>
<a name="ln130">MediaRoutingView::~MediaRoutingView() {</a>
<a name="ln131">	D_METHOD((&quot;MediaRoutingView::~MediaRoutingView()\n&quot;));</a>
<a name="ln132"> </a>
<a name="ln133">	_emptyInactiveNodeState();</a>
<a name="ln134"> </a>
<a name="ln135">	// quit ParameterWindowManager if necessary</a>
<a name="ln136">	ParameterWindowManager::shutDown();</a>
<a name="ln137"> </a>
<a name="ln138">	// quit InfoWindowManager if necessary</a>
<a name="ln139">	InfoWindowManager::shutDown();</a>
<a name="ln140">}</a>
<a name="ln141"> </a>
<a name="ln142">// -------------------------------------------------------- //</a>
<a name="ln143">// *** derived from DiagramView</a>
<a name="ln144">// -------------------------------------------------------- //</a>
<a name="ln145"> </a>
<a name="ln146">void MediaRoutingView::connectionAborted(</a>
<a name="ln147">	DiagramEndPoint *fromWhich)</a>
<a name="ln148">{</a>
<a name="ln149">	D_METHOD((&quot;MediaRoutingView::connectionAborted()\n&quot;));</a>
<a name="ln150"> </a>
<a name="ln151">	be_app-&gt;SetCursor(B_HAND_CURSOR);</a>
<a name="ln152">}</a>
<a name="ln153"> </a>
<a name="ln154">void MediaRoutingView::connectionEstablished(</a>
<a name="ln155">	DiagramEndPoint *fromWhich,</a>
<a name="ln156">	DiagramEndPoint *toWhich)</a>
<a name="ln157">{</a>
<a name="ln158">	D_METHOD((&quot;MediaRoutingView::connectionEstablished()\n&quot;));</a>
<a name="ln159"> </a>
<a name="ln160">	be_app-&gt;SetCursor(B_HAND_CURSOR);</a>
<a name="ln161">}</a>
<a name="ln162"> </a>
<a name="ln163">DiagramWire *MediaRoutingView::createWire(</a>
<a name="ln164">	DiagramEndPoint *fromWhich,</a>
<a name="ln165">	DiagramEndPoint *toWhich)</a>
<a name="ln166">{</a>
<a name="ln167">	D_METHOD((&quot;MediaRoutingView::createWire()\n&quot;));</a>
<a name="ln168"> </a>
<a name="ln169">	MediaJack *outputJack, *inputJack;</a>
<a name="ln170">	MediaJack *jack = dynamic_cast&lt;MediaJack *&gt;(fromWhich);</a>
<a name="ln171"> </a>
<a name="ln172">	if (jack == NULL)</a>
<a name="ln173">		return 0;</a>
<a name="ln174"> </a>
<a name="ln175">	if (jack-&gt;isOutput())</a>
<a name="ln176">	{</a>
<a name="ln177">		outputJack = jack;</a>
<a name="ln178">		inputJack = dynamic_cast&lt;MediaJack *&gt;(toWhich);</a>
<a name="ln179">		if (!inputJack || !inputJack-&gt;isInput())</a>
<a name="ln180">		{</a>
<a name="ln181">			return 0;</a>
<a name="ln182">		}</a>
<a name="ln183">	}</a>
<a name="ln184">	else</a>
<a name="ln185">	{</a>
<a name="ln186">		inputJack = jack;</a>
<a name="ln187">		outputJack = dynamic_cast&lt;MediaJack *&gt;(toWhich);</a>
<a name="ln188">		if (!outputJack || !outputJack-&gt;isOutput())</a>
<a name="ln189">		{</a>
<a name="ln190">			return 0;</a>
<a name="ln191">		}</a>
<a name="ln192">	}</a>
<a name="ln193">	if (!outputJack-&gt;isConnected() &amp;&amp; !inputJack-&gt;isConnected())</a>
<a name="ln194">	{</a>
<a name="ln195">		media_output output;</a>
<a name="ln196">		media_input input;</a>
<a name="ln197">		if ((outputJack-&gt;getOutput(&amp;output) == B_OK)</a>
<a name="ln198">		 &amp;&amp; (inputJack-&gt;getInput(&amp;input) == B_OK))</a>
<a name="ln199">		{</a>
<a name="ln200">			status_t error;</a>
<a name="ln201">			Connection connection;</a>
<a name="ln202">			error = manager-&gt;connect(output, input, &amp;connection);</a>
<a name="ln203">			if (error)</a>
<a name="ln204">			{</a>
<a name="ln205">				showErrorMessage(&quot;Could not connect&quot;, error);</a>
<a name="ln206">			}</a>
<a name="ln207">		}</a>
<a name="ln208">	}</a>
<a name="ln209">	return 0;</a>
<a name="ln210">}</a>
<a name="ln211"> </a>
<a name="ln212">DiagramWire *MediaRoutingView::createWire(</a>
<a name="ln213">	DiagramEndPoint *fromWhich)</a>
<a name="ln214">{</a>
<a name="ln215">	D_METHOD((&quot;MediaRoutingView::createWire(temp)\n&quot;));</a>
<a name="ln216"> </a>
<a name="ln217">	MediaJack *jack = dynamic_cast&lt;MediaJack *&gt;(fromWhich);</a>
<a name="ln218">	if (jack)</a>
<a name="ln219">	{</a>
<a name="ln220">		if (jack-&gt;isOutput()) // this is the start point</a>
<a name="ln221">		{</a>
<a name="ln222">			return new MediaWire(jack, true);</a>
<a name="ln223">		}</a>
<a name="ln224">		else</a>
<a name="ln225">		{</a>
<a name="ln226">			return new MediaWire(jack, false);</a>
<a name="ln227">		}</a>
<a name="ln228">	}</a>
<a name="ln229">	return 0;</a>
<a name="ln230">}</a>
<a name="ln231"> </a>
<a name="ln232"> </a>
<a name="ln233">void</a>
<a name="ln234">MediaRoutingView::BackgroundMouseDown(BPoint point, uint32 buttons,</a>
<a name="ln235">	uint32 clicks)</a>
<a name="ln236">{</a>
<a name="ln237">	D_MOUSE((&quot;MediaRoutingView::BackgroundMouseDown()\n&quot;));</a>
<a name="ln238"> </a>
<a name="ln239">	if ((buttons == B_SECONDARY_MOUSE_BUTTON)</a>
<a name="ln240">	 || (modifiers() &amp; B_CONTROL_KEY)) {</a>
<a name="ln241">		EndRectTracking();</a>
<a name="ln242">		showContextMenu(point);</a>
<a name="ln243">	}</a>
<a name="ln244">}</a>
<a name="ln245"> </a>
<a name="ln246"> </a>
<a name="ln247">void</a>
<a name="ln248">MediaRoutingView::MessageDropped(BPoint point, BMessage *message)</a>
<a name="ln249">{</a>
<a name="ln250">	D_METHOD((&quot;MediaRoutingView::MessageDropped()\n&quot;));</a>
<a name="ln251"> </a>
<a name="ln252">	switch (message-&gt;what) {</a>
<a name="ln253">		case DormantNodeView::M_INSTANTIATE_NODE:</a>
<a name="ln254">		{</a>
<a name="ln255">			D_MESSAGE((&quot;MediaRoutingView::MessageDropped(DormantNodeView::M_INSTANTIATE_NODE)\n&quot;));</a>
<a name="ln256">			type_code type;</a>
<a name="ln257">			int32 count;</a>
<a name="ln258">			if (message-&gt;GetInfo(&quot;which&quot;, &amp;type, &amp;count) == B_OK) {</a>
<a name="ln259">				for (int32 n = 0; n &lt; count; n++) {</a>
<a name="ln260">					dormant_node_info info;</a>
<a name="ln261">					const void *data;</a>
<a name="ln262">					ssize_t dataSize;</a>
<a name="ln263">					if (message-&gt;FindData(&quot;which&quot;, B_RAW_TYPE, &amp;data, &amp;dataSize) == B_OK) {</a>
<a name="ln264">						memcpy(reinterpret_cast&lt;void *&gt;(&amp;info), data, dataSize);</a>
<a name="ln265">						NodeRef* droppedNode;</a>
<a name="ln266">						status_t error;</a>
<a name="ln267">						error = manager-&gt;instantiate(info, &amp;droppedNode);</a>
<a name="ln268">						if (!error) {</a>
<a name="ln269">							m_lastDroppedNode = droppedNode-&gt;id();</a>
<a name="ln270">							BPoint dropPoint, dropOffset;</a>
<a name="ln271">							dropPoint = message-&gt;DropPoint(&amp;dropOffset);</a>
<a name="ln272">							m_lastDropPoint = Align(ConvertFromScreen(dropPoint - dropOffset));</a>
<a name="ln273">						} else {</a>
<a name="ln274">							BString s;</a>
<a name="ln275">							s &lt;&lt; &quot;Could not instantiate '&quot; &lt;&lt; info.name &lt;&lt; &quot;'&quot;;</a>
<a name="ln276">							showErrorMessage(s, error);</a>
<a name="ln277">						}</a>
<a name="ln278">					}</a>
<a name="ln279">				}</a>
<a name="ln280">			}</a>
<a name="ln281">			break;</a>
<a name="ln282">		}</a>
<a name="ln283"> </a>
<a name="ln284">		case B_SIMPLE_DATA:</a>
<a name="ln285">		{</a>
<a name="ln286">			D_MESSAGE((&quot;MediaRoutingView::MessageDropped(B_SIMPLE_DATA)\n&quot;));</a>
<a name="ln287">			entry_ref fileRef;</a>
<a name="ln288">			if (message-&gt;FindRef(&quot;refs&quot;, &amp;fileRef) == B_OK)</a>
<a name="ln289">				_checkDroppedFile(&amp;fileRef, ConvertFromScreen(message-&gt;DropPoint()));</a>
<a name="ln290">			break;</a>
<a name="ln291">		}</a>
<a name="ln292"> </a>
<a name="ln293">		case B_PASTE:</a>
<a name="ln294">		{</a>
<a name="ln295">			D_MESSAGE((&quot;MediaRoutingView::MessageDropped(B_PASTE)\n&quot;));</a>
<a name="ln296">			ssize_t size;</a>
<a name="ln297">			const rgb_color *color; // [e.moon 21nov99] fixed const error</a>
<a name="ln298">			if (message-&gt;FindData(&quot;RGBColor&quot;, B_RGB_COLOR_TYPE,</a>
<a name="ln299">				reinterpret_cast&lt;const void **&gt;(&amp;color), &amp;size) == B_OK)</a>
<a name="ln300">				_changeBackground(*color);</a>
<a name="ln301">			break;</a>
<a name="ln302">		}</a>
<a name="ln303"> </a>
<a name="ln304">		default:</a>
<a name="ln305">			DiagramView::MessageDropped(point, message);</a>
<a name="ln306">	}</a>
<a name="ln307">}</a>
<a name="ln308"> </a>
<a name="ln309"> </a>
<a name="ln310">void</a>
<a name="ln311">MediaRoutingView::SelectionChanged()</a>
<a name="ln312">{</a>
<a name="ln313">	D_METHOD((&quot;MediaRoutingView::selectionChanged()\n&quot;));</a>
<a name="ln314">	_broadcastSelection();</a>
<a name="ln315">}</a>
<a name="ln316"> </a>
<a name="ln317">// ---------------------------------------------------------------- //</a>
<a name="ln318">// *** BView impl.</a>
<a name="ln319">// ---------------------------------------------------------------- //</a>
<a name="ln320"> </a>
<a name="ln321">void MediaRoutingView::AttachedToWindow()</a>
<a name="ln322">{</a>
<a name="ln323">	D_METHOD((&quot;MediaRoutingView::AttachedToWindow()\n&quot;));</a>
<a name="ln324">	_inherited::AttachedToWindow();</a>
<a name="ln325"> </a>
<a name="ln326">	// attach to manager</a>
<a name="ln327">	ASSERT(manager);</a>
<a name="ln328">	add_observer(this, manager);</a>
<a name="ln329"> </a>
<a name="ln330">	// add the context-menu shortcuts to the window</a>
<a name="ln331">	_addShortcuts();</a>
<a name="ln332"> </a>
<a name="ln333">	// populate with existing nodes &amp; connections</a>
<a name="ln334">	_initContent();</a>
<a name="ln335"> </a>
<a name="ln336">	// [e.moon 29nov99] moved from AllAttached()</a>
<a name="ln337">	cleanUp();</a>
<a name="ln338">}</a>
<a name="ln339"> </a>
<a name="ln340">void MediaRoutingView::AllAttached()</a>
<a name="ln341">{</a>
<a name="ln342">	D_METHOD((&quot;MediaRoutingView::AllAttached()\n&quot;));</a>
<a name="ln343">	_inherited::AllAttached();</a>
<a name="ln344"> </a>
<a name="ln345">	_adjustScrollBars();</a>
<a name="ln346"> </a>
<a name="ln347">	// grab keyboard events</a>
<a name="ln348">	MakeFocus();</a>
<a name="ln349">}</a>
<a name="ln350"> </a>
<a name="ln351">void MediaRoutingView::DetachedFromWindow()</a>
<a name="ln352">{</a>
<a name="ln353">	D_METHOD((&quot;MediaRoutingView::DetachedFromWindow()\n&quot;));</a>
<a name="ln354">	_inherited::DetachedFromWindow();</a>
<a name="ln355"> </a>
<a name="ln356">	// detach from manager</a>
<a name="ln357">	if (manager)</a>
<a name="ln358">	{</a>
<a name="ln359">		Autolock lock(manager);</a>
<a name="ln360">		void *cookie = 0;</a>
<a name="ln361">		NodeRef *ref;</a>
<a name="ln362">		while (manager-&gt;getNextRef(&amp;ref, &amp;cookie) == B_OK)</a>
<a name="ln363">		{</a>
<a name="ln364">			remove_observer(this, ref);</a>
<a name="ln365">		}</a>
<a name="ln366">		remove_observer(this, manager);</a>
<a name="ln367">		const_cast&lt;RouteAppNodeManager *&amp;&gt;(manager) = 0;</a>
<a name="ln368">	}</a>
<a name="ln369">}</a>
<a name="ln370"> </a>
<a name="ln371">void MediaRoutingView::KeyDown(</a>
<a name="ln372">	const char *bytes,</a>
<a name="ln373">	int32 numBytes)</a>
<a name="ln374">{</a>
<a name="ln375">	D_METHOD((&quot;MediaRoutingView::KeyDown()\n&quot;));</a>
<a name="ln376"> </a>
<a name="ln377">	switch (bytes[0])</a>
<a name="ln378">	{</a>
<a name="ln379">		case B_ENTER:</a>
<a name="ln380">		{</a>
<a name="ln381">			D_KEY((&quot;MediaRoutingView::KeyDown(B_ENTER)\n&quot;));</a>
<a name="ln382">			_openParameterWindowsForSelection();</a>
<a name="ln383">			break;</a>
<a name="ln384">		}</a>
<a name="ln385">		case B_DELETE:</a>
<a name="ln386">		{</a>
<a name="ln387">			D_KEY((&quot;MediaRoutingView::KeyDown(B_DELETE)\n&quot;));</a>
<a name="ln388">			_deleteSelection();</a>
<a name="ln389">			break;</a>
<a name="ln390">		}</a>
<a name="ln391">		case B_SPACE:</a>
<a name="ln392">		{</a>
<a name="ln393">			// [e.moon 1dec99]</a>
<a name="ln394">			BWindow* w = Window();</a>
<a name="ln395">			ASSERT(w);</a>
<a name="ln396">			BMessenger(w).SendMessage(RouteWindow::M_TOGGLE_GROUP_ROLLING);</a>
<a name="ln397">			break;</a>
<a name="ln398">		}</a>
<a name="ln399">		default:</a>
<a name="ln400">		{</a>
<a name="ln401">			DiagramView::KeyDown(bytes, numBytes);</a>
<a name="ln402">			break;</a>
<a name="ln403">		}</a>
<a name="ln404">	}</a>
<a name="ln405">}</a>
<a name="ln406"> </a>
<a name="ln407">void MediaRoutingView::Pulse()</a>
<a name="ln408">{</a>
<a name="ln409">	// do the animation</a>
<a name="ln410">}</a>
<a name="ln411"> </a>
<a name="ln412">// ---------------------------------------------------------------- //</a>
<a name="ln413">// BHandler impl</a>
<a name="ln414">// ---------------------------------------------------------------- //</a>
<a name="ln415"> </a>
<a name="ln416">void MediaRoutingView::MessageReceived(</a>
<a name="ln417">	BMessage* message)</a>
<a name="ln418">{</a>
<a name="ln419">	D_METHOD((&quot;MediaRoutingView::MessageReceived()\n&quot;));</a>
<a name="ln420"> </a>
<a name="ln421">	switch (message-&gt;what)</a>
<a name="ln422">	{</a>
<a name="ln423">		case B_MEDIA_NODE_CREATED:</a>
<a name="ln424">		{</a>
<a name="ln425">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(B_MEDIA_NODE_CREATED)\n&quot;));</a>
<a name="ln426">			type_code type;</a>
<a name="ln427">			int32 count;</a>
<a name="ln428">			if (message-&gt;GetInfo(&quot;media_node_id&quot;, &amp;type, &amp;count) == B_OK)</a>
<a name="ln429">			{</a>
<a name="ln430">				for(int32 n = 0; n &lt; count; n++)</a>
<a name="ln431">				{</a>
<a name="ln432">					int32 id;</a>
<a name="ln433">					if (message-&gt;FindInt32(&quot;media_node_id&quot;, n, &amp;id) == B_OK)</a>
<a name="ln434">					{</a>
<a name="ln435">						// [e.moon 8dec99] allow for existing panel</a>
<a name="ln436">						MediaNodePanel* panel;</a>
<a name="ln437">						if(_findPanelFor(id, &amp;panel) &lt; B_OK)</a>
<a name="ln438">							_addPanelFor(id, BPoint(5.0, 5.0));</a>
<a name="ln439">					}</a>
<a name="ln440">				}</a>
<a name="ln441">			}</a>
<a name="ln442">			break;</a>
<a name="ln443">		}</a>
<a name="ln444">		case B_MEDIA_NODE_DELETED:</a>
<a name="ln445">		{</a>
<a name="ln446">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(B_MEDIA_NODE_DELETED)\n&quot;));</a>
<a name="ln447">			type_code type;</a>
<a name="ln448">			int32 count;</a>
<a name="ln449">			if (message-&gt;GetInfo(&quot;media_node_id&quot;, &amp;type, &amp;count) == B_OK)</a>
<a name="ln450">			{</a>
<a name="ln451">				for (int32 n = 0; n &lt; count; n++)</a>
<a name="ln452">				{</a>
<a name="ln453">					int32 id;</a>
<a name="ln454">					if (message-&gt;FindInt32(&quot;media_node_id&quot;, n, &amp;id) == B_OK)</a>
<a name="ln455">					{</a>
<a name="ln456">						_removePanelFor(id);</a>
<a name="ln457">					}</a>
<a name="ln458">				}</a>
<a name="ln459">			}</a>
<a name="ln460">			break;</a>
<a name="ln461">		}</a>
<a name="ln462">		case B_MEDIA_CONNECTION_MADE:</a>
<a name="ln463">		{</a>
<a name="ln464">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(B_MEDIA_CONNECTION_MADE)\n&quot;));</a>
<a name="ln465">			type_code type;</a>
<a name="ln466">			int32 count;</a>
<a name="ln467">			if (message-&gt;GetInfo(&quot;output&quot;, &amp;type, &amp;count) == B_OK)</a>
<a name="ln468">			{</a>
<a name="ln469">				for (int32 n = 0; n &lt; count; n++)</a>
<a name="ln470">				{</a>
<a name="ln471">					media_output output;</a>
<a name="ln472">					const void *data;</a>
<a name="ln473">					ssize_t dataSize;</a>
<a name="ln474">					if (message-&gt;FindData(&quot;output&quot;, B_RAW_TYPE, n, &amp;data, &amp;dataSize) == B_OK)</a>
<a name="ln475">					{</a>
<a name="ln476">						output = *reinterpret_cast&lt;const media_output *&gt;(data);</a>
<a name="ln477">						Connection connection;</a>
<a name="ln478">						if (manager-&gt;findConnection(output.node.node, output.source, &amp;connection) == B_OK)</a>
<a name="ln479">						{</a>
<a name="ln480">							_addWireFor(connection);</a>
<a name="ln481">						}</a>
<a name="ln482">					}</a>
<a name="ln483">				}</a>
<a name="ln484">			}</a>
<a name="ln485">			break;</a>
<a name="ln486">		}</a>
<a name="ln487">		case B_MEDIA_CONNECTION_BROKEN:</a>
<a name="ln488">		{</a>
<a name="ln489">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(B_MEDIA_CONNECTION_BROKEN)\n&quot;));</a>
<a name="ln490">			type_code type;</a>
<a name="ln491">			int32 count;</a>
<a name="ln492">			if (message-&gt;GetInfo(&quot;__connection_id&quot;, &amp;type, &amp;count) == B_OK)</a>
<a name="ln493">			{</a>
<a name="ln494">				for (int32 n = 0; n &lt; count; n++)</a>
<a name="ln495">				{</a>
<a name="ln496">					int32 id;</a>
<a name="ln497">					if (message-&gt;FindInt32(&quot;__connection_id&quot;, n, &amp;id) == B_OK)</a>
<a name="ln498">					{</a>
<a name="ln499">						_removeWireFor(id);</a>
<a name="ln500">					}</a>
<a name="ln501">				}</a>
<a name="ln502">			}</a>
<a name="ln503">			break;</a>
<a name="ln504">		}</a>
<a name="ln505">		case B_MEDIA_FORMAT_CHANGED:</a>
<a name="ln506">		{</a>
<a name="ln507">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(B_MEDIA_FORMAT_CHANGED)\n&quot;));</a>
<a name="ln508"> </a>
<a name="ln509">			media_node_id nodeID;</a>
<a name="ln510">			if(message-&gt;FindInt32(&quot;__source_node_id&quot;, &amp;nodeID) &lt; B_OK)</a>
<a name="ln511">				break;</a>
<a name="ln512"> </a>
<a name="ln513">			uint32 connectionID;</a>
<a name="ln514">			if(message-&gt;FindInt32(&quot;__connection_id&quot;, (int32*)&amp;connectionID) &lt; B_OK)</a>
<a name="ln515">				break;</a>
<a name="ln516"> </a>
<a name="ln517">			media_source* source;</a>
<a name="ln518">			ssize_t dataSize;</a>
<a name="ln519">			if(message-&gt;FindData(&quot;be:source&quot;, B_RAW_TYPE, (const void**)&amp;source, &amp;dataSize) &lt; B_OK)</a>
<a name="ln520">				break;</a>
<a name="ln521"> </a>
<a name="ln522">			MediaWire* wire;</a>
<a name="ln523">			if(_findWireFor(connectionID, &amp;wire) == B_OK) {</a>
<a name="ln524">				// copy new connection data</a>
<a name="ln525">				manager-&gt;findConnection(nodeID, *source, &amp;wire-&gt;connection);</a>
<a name="ln526">			}</a>
<a name="ln527">			break;</a>
<a name="ln528">		}</a>
<a name="ln529">		case M_CLEANUP_REQUESTED:</a>
<a name="ln530">		{</a>
<a name="ln531">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_M_CLEANUP_REQUESTED)\n&quot;));</a>
<a name="ln532">			cleanUp();</a>
<a name="ln533">			break;</a>
<a name="ln534">		}</a>
<a name="ln535">		case M_SELECT_ALL:</a>
<a name="ln536">		{</a>
<a name="ln537">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_SELECT_ALL)\n&quot;));</a>
<a name="ln538">			SelectAll(DiagramItem::M_BOX);</a>
<a name="ln539">			break;</a>
<a name="ln540">		}</a>
<a name="ln541">		case M_DELETE_SELECTION:</a>
<a name="ln542">		{</a>
<a name="ln543">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_DELETE_SELECTION)\n&quot;));</a>
<a name="ln544">			_deleteSelection();</a>
<a name="ln545">			break;</a>
<a name="ln546">		}</a>
<a name="ln547">		case M_NODE_CHANGE_CYCLING:</a>
<a name="ln548">		{</a>
<a name="ln549">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_NODE_CYCLING_CHANGED)\n&quot;));</a>
<a name="ln550">			bool cycle;</a>
<a name="ln551">			if (message-&gt;FindBool(&quot;cycle&quot;, &amp;cycle) == B_OK)</a>
<a name="ln552">			{</a>
<a name="ln553">				_changeCyclingForSelection(cycle);</a>
<a name="ln554">			}</a>
<a name="ln555">			break;</a>
<a name="ln556">		}</a>
<a name="ln557">		case M_NODE_CHANGE_RUN_MODE:</a>
<a name="ln558">		{</a>
<a name="ln559">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_NODE_RUNMODE_CHANGED)\n&quot;));</a>
<a name="ln560">			int32 mode;</a>
<a name="ln561">			if (message-&gt;FindInt32(&quot;run_mode&quot;, &amp;mode) == B_OK)</a>
<a name="ln562">			{</a>
<a name="ln563">				_changeRunModeForSelection(static_cast&lt;uint32&gt;(mode));</a>
<a name="ln564">			}</a>
<a name="ln565">			break;</a>
<a name="ln566">		}</a>
<a name="ln567">		case M_LAYOUT_CHANGED:</a>
<a name="ln568">		{</a>
<a name="ln569">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_LAYOUT_CHANGED)\n&quot;));</a>
<a name="ln570">			layout_t layout;</a>
<a name="ln571">			if (message-&gt;FindInt32(&quot;layout&quot;, (int32*)&amp;layout) == B_OK)</a>
<a name="ln572">			{</a>
<a name="ln573">				if (layout != m_layout)</a>
<a name="ln574">				{</a>
<a name="ln575">					layoutChanged(layout);</a>
<a name="ln576">					updateDataRect();</a>
<a name="ln577">					Invalidate();</a>
<a name="ln578">				}</a>
<a name="ln579">			}</a>
<a name="ln580">			break;</a>
<a name="ln581">		}</a>
<a name="ln582">		case M_NODE_START_TIME_SOURCE:</a>
<a name="ln583">		{</a>
<a name="ln584">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_NODE_START_TIME_SOURCE)\n&quot;));</a>
<a name="ln585">			int32 id;</a>
<a name="ln586">			if(message-&gt;FindInt32(&quot;nodeID&quot;, &amp;id) &lt; B_OK)</a>
<a name="ln587">				break;</a>
<a name="ln588">			NodeRef* ref;</a>
<a name="ln589">			if(manager-&gt;getNodeRef(id, &amp;ref) &lt; B_OK)</a>
<a name="ln590">				break;</a>
<a name="ln591"> </a>
<a name="ln592">			bigtime_t when = system_time();</a>
<a name="ln593">			status_t err = manager-&gt;roster-&gt;StartTimeSource(ref-&gt;node(), when);</a>
<a name="ln594">			if(err &lt; B_OK) {</a>
<a name="ln595">				PRINT((</a>
<a name="ln596">					&quot;! StartTimeSource(%&quot; B_PRId32 &quot;): '%s'\n&quot;,</a>
<a name="ln597">					ref-&gt;id(), strerror(err)));</a>
<a name="ln598">			}</a>
<a name="ln599">			break;</a>
<a name="ln600">		}</a>
<a name="ln601">		case M_NODE_STOP_TIME_SOURCE:</a>
<a name="ln602">		{</a>
<a name="ln603">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_NODE_STOP_TIME_SOURCE)\n&quot;));</a>
<a name="ln604">			int32 id;</a>
<a name="ln605">			if(message-&gt;FindInt32(&quot;nodeID&quot;, &amp;id) &lt; B_OK)</a>
<a name="ln606">				break;</a>
<a name="ln607">			NodeRef* ref;</a>
<a name="ln608">			if(manager-&gt;getNodeRef(id, &amp;ref) &lt; B_OK)</a>
<a name="ln609">				break;</a>
<a name="ln610"> </a>
<a name="ln611">			bigtime_t when = system_time();</a>
<a name="ln612">			status_t err = manager-&gt;roster-&gt;StopTimeSource(ref-&gt;node(), when);</a>
<a name="ln613">			if(err &lt; B_OK) {</a>
<a name="ln614">				PRINT((</a>
<a name="ln615">					&quot;! StopTimeSource(%&quot; B_PRId32 &quot;): '%s'\n&quot;,</a>
<a name="ln616">					ref-&gt;id(), strerror(err)));</a>
<a name="ln617">			}</a>
<a name="ln618">			break;</a>
<a name="ln619">		}</a>
<a name="ln620">		case M_NODE_TWEAK_PARAMETERS: {</a>
<a name="ln621">			D_MESSAGE((&quot; -&gt; M_NODE_TWEAK_PARAMETERS\n&quot;));</a>
<a name="ln622">			_openParameterWindowsForSelection();</a>
<a name="ln623">			break;</a>
<a name="ln624">		}</a>
<a name="ln625">		case M_NODE_START_CONTROL_PANEL: {</a>
<a name="ln626">			D_MESSAGE((&quot; -&gt; M_NODE_START_CONTROL_PANEL\n&quot;));</a>
<a name="ln627">			_startControlPanelsForSelection();</a>
<a name="ln628">			break;</a>
<a name="ln629">		}</a>
<a name="ln630">		case M_GROUP_SET_LOCKED:</a>
<a name="ln631">		{</a>
<a name="ln632">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(M_GROUP_SET_LOCKED)\n&quot;));</a>
<a name="ln633">			int32 groupID;</a>
<a name="ln634">			if(message-&gt;FindInt32(&quot;groupID&quot;, &amp;groupID) &lt; B_OK)</a>
<a name="ln635">				break;</a>
<a name="ln636">			bool locked;</a>
<a name="ln637">			if(message-&gt;FindBool(&quot;locked&quot;, &amp;locked) &lt; B_OK)</a>
<a name="ln638">				break;</a>
<a name="ln639">			NodeGroup* group;</a>
<a name="ln640">			if(manager-&gt;findGroup(groupID, &amp;group) &lt; B_OK)</a>
<a name="ln641">				break;</a>
<a name="ln642">			uint32 f = locked ?</a>
<a name="ln643">				group-&gt;groupFlags() | NodeGroup::GROUP_LOCKED :</a>
<a name="ln644">				group-&gt;groupFlags() &amp; ~NodeGroup::GROUP_LOCKED;</a>
<a name="ln645">			group-&gt;setGroupFlags(f);</a>
<a name="ln646">			break;</a>
<a name="ln647">		}</a>
<a name="ln648">		case M_BROADCAST_SELECTION: {</a>
<a name="ln649">			D_MESSAGE((&quot; -&gt; M_BROADCAST_SELECTION\n&quot;));</a>
<a name="ln650">			_broadcastSelection();</a>
<a name="ln651">			break;</a>
<a name="ln652">		}</a>
<a name="ln653">		case InfoWindowManager::M_INFO_WINDOW_REQUESTED:</a>
<a name="ln654">		{</a>
<a name="ln655">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(InfoView::M_INFO_WINDOW_REQUESTED)\n&quot;));</a>
<a name="ln656">			type_code type;</a>
<a name="ln657">			int32 count;</a>
<a name="ln658">			if (message-&gt;GetInfo(&quot;input&quot;, &amp;type, &amp;count) == B_OK)</a>
<a name="ln659">			{</a>
<a name="ln660">				for (int32 i = 0; i &lt; count; i++)</a>
<a name="ln661">				{</a>
<a name="ln662">					media_input input;</a>
<a name="ln663">					const void *data;</a>
<a name="ln664">					ssize_t dataSize;</a>
<a name="ln665">					if (message-&gt;FindData(&quot;input&quot;, B_RAW_TYPE, i, &amp;data, &amp;dataSize) == B_OK)</a>
<a name="ln666">					{</a>
<a name="ln667">						input = *reinterpret_cast&lt;const media_input *&gt;(data);</a>
<a name="ln668">						InfoWindowManager *manager = InfoWindowManager::Instance();</a>
<a name="ln669">						if (manager &amp;&amp; manager-&gt;Lock()) {</a>
<a name="ln670">							manager-&gt;openWindowFor(input);</a>
<a name="ln671">							manager-&gt;Unlock();</a>
<a name="ln672">						}</a>
<a name="ln673">					}</a>
<a name="ln674">				}</a>
<a name="ln675">			}</a>
<a name="ln676">			else if (message-&gt;GetInfo(&quot;output&quot;, &amp;type, &amp;count) == B_OK)</a>
<a name="ln677">			{</a>
<a name="ln678">				for (int32 i = 0; i &lt; count; i++)</a>
<a name="ln679">				{</a>
<a name="ln680">					media_output output;</a>
<a name="ln681">					const void *data;</a>
<a name="ln682">					ssize_t dataSize;</a>
<a name="ln683">					if (message-&gt;FindData(&quot;output&quot;, B_RAW_TYPE, i, &amp;data, &amp;dataSize) == B_OK)</a>
<a name="ln684">					{</a>
<a name="ln685">						output = *reinterpret_cast&lt;const media_output *&gt;(data);</a>
<a name="ln686">						InfoWindowManager *manager = InfoWindowManager::Instance();</a>
<a name="ln687">						if (manager &amp;&amp; manager-&gt;Lock()) {</a>
<a name="ln688">							manager-&gt;openWindowFor(output);</a>
<a name="ln689">							manager-&gt;Unlock();</a>
<a name="ln690">						}</a>
<a name="ln691">					}</a>
<a name="ln692">				}</a>
<a name="ln693">			}</a>
<a name="ln694">			else</a>
<a name="ln695">			{</a>
<a name="ln696">				_openInfoWindowsForSelection();</a>
<a name="ln697">			}</a>
<a name="ln698">			break;</a>
<a name="ln699">		}</a>
<a name="ln700">		case NodeManager::M_RELEASED:</a>
<a name="ln701">		{</a>
<a name="ln702">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(NodeManager::M_RELEASED)\n&quot;));</a>
<a name="ln703">			remove_observer(this, manager);</a>
<a name="ln704">			const_cast&lt;RouteAppNodeManager*&amp;&gt;(manager) = 0;</a>
<a name="ln705">			// +++++ disable view!</a>
<a name="ln706">			break;</a>
<a name="ln707">		}</a>
<a name="ln708">		case NodeRef::M_RELEASED:</a>
<a name="ln709">		{</a>
<a name="ln710">			D_MESSAGE((&quot;MediaRoutingView::MessageReceived(NodeRef::M_RELEASED)\n&quot;));</a>
<a name="ln711">			// only relevant on shutdown; do nothing</a>
<a name="ln712">			break;</a>
<a name="ln713">		}</a>
<a name="ln714">		default:</a>
<a name="ln715">		{</a>
<a name="ln716">			DiagramView::MessageReceived(message);</a>
<a name="ln717">		}</a>
<a name="ln718">	}</a>
<a name="ln719">}</a>
<a name="ln720"> </a>
<a name="ln721">// ---------------------------------------------------------------- //</a>
<a name="ln722">// *** operations (public)</a>
<a name="ln723">// ---------------------------------------------------------------- //</a>
<a name="ln724"> </a>
<a name="ln725">BPoint MediaRoutingView::findFreePositionFor(</a>
<a name="ln726">	const MediaNodePanel* panel) const</a>
<a name="ln727">{</a>
<a name="ln728">	D_METHOD((&quot;MediaRoutingView::_findFreeSpotFor()\n&quot;));</a>
<a name="ln729"> </a>
<a name="ln730">	BPoint p(M_CLEANUP_H_MARGIN, M_CLEANUP_V_MARGIN);</a>
<a name="ln731">	if (panel)</a>
<a name="ln732">	{</a>
<a name="ln733">		switch (m_layout)</a>
<a name="ln734">		{</a>
<a name="ln735">			case M_ICON_VIEW:</a>
<a name="ln736">			{</a>
<a name="ln737">				// find the target column by node_kind</a>
<a name="ln738">				p.x += M_CLEANUP_H_GAP + MediaNodePanel::M_DEFAULT_WIDTH;</a>
<a name="ln739">				if (panel-&gt;ref-&gt;kind() &amp; B_BUFFER_PRODUCER)</a>
<a name="ln740">				{</a>
<a name="ln741">					p.x -= M_CLEANUP_H_GAP + MediaNodePanel::M_DEFAULT_WIDTH;</a>
<a name="ln742">				}</a>
<a name="ln743">				if (panel-&gt;ref-&gt;kind() &amp; B_BUFFER_CONSUMER)</a>
<a name="ln744">				{</a>
<a name="ln745">					p.x += M_CLEANUP_H_GAP + MediaNodePanel::M_DEFAULT_WIDTH;</a>
<a name="ln746">				}</a>
<a name="ln747">				// find the bottom item in the column</a>
<a name="ln748">				float bottom = 0.0;</a>
<a name="ln749">				for (uint32 i = 0; i &lt; CountItems(DiagramItem::M_BOX); i++)</a>
<a name="ln750">				{</a>
<a name="ln751">					BRect r = ItemAt(i, DiagramItem::M_BOX)-&gt;Frame();</a>
<a name="ln752">					if ((r.left &gt;= p.x)</a>
<a name="ln753">					 &amp;&amp; (r.left &lt;= p.x + MediaNodePanel::M_DEFAULT_WIDTH))</a>
<a name="ln754">					{</a>
<a name="ln755">						bottom = (r.bottom &gt; bottom) ? r.bottom : bottom;</a>
<a name="ln756">					}</a>
<a name="ln757">				}</a>
<a name="ln758">				if (bottom &gt;= p.y)</a>
<a name="ln759">				{</a>
<a name="ln760">					p.y = bottom + M_CLEANUP_V_GAP;</a>
<a name="ln761">				}</a>
<a name="ln762">				break;</a>
<a name="ln763">			}</a>
<a name="ln764">			case M_MINI_ICON_VIEW:</a>
<a name="ln765">			{</a>
<a name="ln766">				// find the target row by node_kind</a>
<a name="ln767">				p.y += M_CLEANUP_V_GAP + MediaNodePanel::M_DEFAULT_HEIGHT;</a>
<a name="ln768">				if (panel-&gt;ref-&gt;kind() &amp; B_BUFFER_PRODUCER)</a>
<a name="ln769">				{</a>
<a name="ln770">					p.y -= M_CLEANUP_V_GAP + MediaNodePanel::M_DEFAULT_HEIGHT;</a>
<a name="ln771">				}</a>
<a name="ln772">				if (panel-&gt;ref-&gt;kind() &amp; B_BUFFER_CONSUMER)</a>
<a name="ln773">				{</a>
<a name="ln774">					p.y += M_CLEANUP_V_GAP + MediaNodePanel::M_DEFAULT_HEIGHT;</a>
<a name="ln775">				}</a>
<a name="ln776">				// find the right-most item in the row</a>
<a name="ln777">				float right = 0.0;</a>
<a name="ln778">				for (uint32 i = 0; i &lt; CountItems(DiagramItem::M_BOX); i++)</a>
<a name="ln779">				{</a>
<a name="ln780">					BRect r = ItemAt(i, DiagramItem::M_BOX)-&gt;Frame();</a>
<a name="ln781">					if ((r.top &gt;= p.y)</a>
<a name="ln782">					 &amp;&amp; (r.top &lt;= p.y + MediaNodePanel::M_DEFAULT_HEIGHT))</a>
<a name="ln783">					{</a>
<a name="ln784">						right = (r.right &gt; right) ? r.right : right;</a>
<a name="ln785">					}</a>
<a name="ln786">				}</a>
<a name="ln787">				if (right &gt;= p.x)</a>
<a name="ln788">				{</a>
<a name="ln789">					p.x = right + M_CLEANUP_H_GAP;</a>
<a name="ln790">				}</a>
<a name="ln791">				break;</a>
<a name="ln792">			}</a>
<a name="ln793">		}</a>
<a name="ln794">	}</a>
<a name="ln795">	return p;</a>
<a name="ln796">}</a>
<a name="ln797"> </a>
<a name="ln798">// ---------------------------------------------------------------- //</a>
<a name="ln799">// *** operations (protected)</a>
<a name="ln800">// ---------------------------------------------------------------- //</a>
<a name="ln801"> </a>
<a name="ln802">void MediaRoutingView::layoutChanged(</a>
<a name="ln803">	layout_t layout)</a>
<a name="ln804">{</a>
<a name="ln805">	D_METHOD((&quot;MediaRoutingView::layoutChanged()\n&quot;));</a>
<a name="ln806"> </a>
<a name="ln807">	switch (layout)</a>
<a name="ln808">	{</a>
<a name="ln809">		case M_ICON_VIEW:</a>
<a name="ln810">		{</a>
<a name="ln811">			float temp;</a>
<a name="ln812"> </a>
<a name="ln813">			// swap the cleanup defaults</a>
<a name="ln814">			temp = M_CLEANUP_H_GAP;</a>
<a name="ln815">			M_CLEANUP_H_GAP = M_CLEANUP_V_GAP;</a>
<a name="ln816">			M_CLEANUP_V_GAP = temp;</a>
<a name="ln817">			temp = M_CLEANUP_H_MARGIN;</a>
<a name="ln818">			M_CLEANUP_H_MARGIN = M_CLEANUP_V_MARGIN;</a>
<a name="ln819">			M_CLEANUP_V_MARGIN = temp;</a>
<a name="ln820"> </a>
<a name="ln821">			// swap the default dimensions for MediaJacks</a>
<a name="ln822">			temp = MediaJack::M_DEFAULT_WIDTH;</a>
<a name="ln823">			MediaJack::M_DEFAULT_WIDTH = MediaJack::M_DEFAULT_HEIGHT;</a>
<a name="ln824">			MediaJack::M_DEFAULT_HEIGHT = temp;</a>
<a name="ln825"> </a>
<a name="ln826">			// Add space for the 3-letter i/o-abbreviation</a>
<a name="ln827">			BFont font(be_plain_font);</a>
<a name="ln828">			font.SetSize(font.Size() - 2.0);</a>
<a name="ln829">			for (int i = 0; i &lt; MediaJack::M_MAX_ABBR_LENGTH; i++)</a>
<a name="ln830">			{</a>
<a name="ln831">				MediaJack::M_DEFAULT_WIDTH += font.StringWidth(&quot;M&quot;);</a>
<a name="ln832">			}</a>
<a name="ln833">			MediaJack::M_DEFAULT_WIDTH += 2.0; // add some padding</a>
<a name="ln834"> </a>
<a name="ln835">			// Adjust the default size for MediaNodePanels</a>
<a name="ln836">			float labelWidth, bodyWidth;</a>
<a name="ln837">			float labelHeight, bodyHeight;</a>
<a name="ln838">			font_height fh;</a>
<a name="ln839">			be_plain_font-&gt;GetHeight(&amp;fh);</a>
<a name="ln840">			labelWidth = 4 * MediaNodePanel::M_LABEL_H_MARGIN</a>
<a name="ln841">						 + be_plain_font-&gt;StringWidth(&quot; Be Audio Mixer &quot;);</a>
<a name="ln842">			bodyWidth = 2 * MediaNodePanel::M_BODY_H_MARGIN + B_LARGE_ICON</a>
<a name="ln843">						+ 2 * MediaJack::M_DEFAULT_WIDTH;</a>
<a name="ln844">			labelHeight = 2 * MediaNodePanel::M_LABEL_V_MARGIN</a>
<a name="ln845">						  + fh.ascent + fh.descent + fh.leading + 1.0;</a>
<a name="ln846">			bodyHeight = 2 * MediaNodePanel::M_BODY_V_MARGIN + B_LARGE_ICON;</a>
<a name="ln847">			MediaNodePanel::M_DEFAULT_WIDTH = labelWidth &gt; bodyWidth ? labelWidth : bodyWidth;</a>
<a name="ln848">			MediaNodePanel::M_DEFAULT_HEIGHT = labelHeight + bodyHeight;</a>
<a name="ln849">			Align(&amp;MediaNodePanel::M_DEFAULT_WIDTH, &amp;MediaNodePanel::M_DEFAULT_HEIGHT);</a>
<a name="ln850">			break;</a>
<a name="ln851">		}</a>
<a name="ln852">		case M_MINI_ICON_VIEW:</a>
<a name="ln853">		{</a>
<a name="ln854">			float temp;</a>
<a name="ln855"> </a>
<a name="ln856">			// Swap the cleanup defaults</a>
<a name="ln857">			temp = M_CLEANUP_H_GAP;</a>
<a name="ln858">			M_CLEANUP_H_GAP = M_CLEANUP_V_GAP;</a>
<a name="ln859">			M_CLEANUP_V_GAP = temp;</a>
<a name="ln860">			temp = M_CLEANUP_H_MARGIN;</a>
<a name="ln861">			M_CLEANUP_H_MARGIN = M_CLEANUP_V_MARGIN;</a>
<a name="ln862">			M_CLEANUP_V_MARGIN = temp;</a>
<a name="ln863"> </a>
<a name="ln864">			// Subtract space for the 3-letter i/o-abbreviation</a>
<a name="ln865">			BFont font(be_plain_font);</a>
<a name="ln866">			font.SetSize(font.Size() - 2.0);</a>
<a name="ln867">			for (int i = 0; i &lt; MediaJack::M_MAX_ABBR_LENGTH; i++)</a>
<a name="ln868">			{</a>
<a name="ln869">				MediaJack::M_DEFAULT_WIDTH -= font.StringWidth(&quot;M&quot;);</a>
<a name="ln870">			}</a>
<a name="ln871">			MediaJack::M_DEFAULT_WIDTH -= 2.0; // substract the padding</a>
<a name="ln872"> </a>
<a name="ln873">			// Swap the default dimensions for MediaJacks</a>
<a name="ln874">			temp = MediaJack::M_DEFAULT_WIDTH;</a>
<a name="ln875">			MediaJack::M_DEFAULT_WIDTH = MediaJack::M_DEFAULT_HEIGHT;</a>
<a name="ln876">			MediaJack::M_DEFAULT_HEIGHT = temp;</a>
<a name="ln877"> </a>
<a name="ln878">			// Adjust the default size for MediaNodePanels</a>
<a name="ln879">			float labelWidth, bodyWidth;</a>
<a name="ln880">			float labelHeight, bodyHeight;</a>
<a name="ln881">			font_height fh;</a>
<a name="ln882">			be_plain_font-&gt;GetHeight(&amp;fh);</a>
<a name="ln883">			labelWidth = 4 * MediaNodePanel::M_LABEL_H_MARGIN</a>
<a name="ln884">						 + be_plain_font-&gt;StringWidth(&quot; Be Audio Mixer &quot;);</a>
<a name="ln885">			bodyWidth = 2 * MediaNodePanel::M_BODY_H_MARGIN + B_MINI_ICON;</a>
<a name="ln886">			labelHeight = 3 * MediaNodePanel::M_LABEL_V_MARGIN</a>
<a name="ln887">						  + fh.ascent + fh.descent + fh.leading</a>
<a name="ln888">						  + 2 * MediaJack::M_DEFAULT_HEIGHT;</a>
<a name="ln889">			bodyHeight = 2 * MediaNodePanel::M_BODY_V_MARGIN + B_MINI_ICON;</a>
<a name="ln890">			MediaNodePanel::M_DEFAULT_WIDTH = labelWidth + bodyWidth;</a>
<a name="ln891">			MediaNodePanel::M_DEFAULT_HEIGHT = labelHeight &gt; bodyHeight ? labelHeight : bodyHeight;</a>
<a name="ln892">			Align(&amp;MediaNodePanel::M_DEFAULT_WIDTH, &amp;MediaNodePanel::M_DEFAULT_HEIGHT);</a>
<a name="ln893">			break;</a>
<a name="ln894">		}</a>
<a name="ln895">	}</a>
<a name="ln896">	m_layout = layout;</a>
<a name="ln897">	for (uint32 i = 0; i &lt; CountItems(DiagramItem::M_BOX); i++)</a>
<a name="ln898">	{</a>
<a name="ln899">		MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(ItemAt(i, DiagramItem::M_BOX));</a>
<a name="ln900">		if (panel)</a>
<a name="ln901">		{</a>
<a name="ln902">			panel-&gt;layoutChanged(layout);</a>
<a name="ln903">		}</a>
<a name="ln904">	}</a>
<a name="ln905"> </a>
<a name="ln906">	_adjustScrollBars();</a>
<a name="ln907">}</a>
<a name="ln908"> </a>
<a name="ln909">void MediaRoutingView::cleanUp()</a>
<a name="ln910">{</a>
<a name="ln911">	D_METHOD((&quot;MediaRoutingView::cleanUp()\n&quot;));</a>
<a name="ln912"> </a>
<a name="ln913">	SortItems(DiagramItem::M_BOX, compareID);</a>
<a name="ln914"> </a>
<a name="ln915">	// move all the panels offscreen</a>
<a name="ln916">	for (uint32 i = 0; i &lt; CountItems(DiagramItem::M_BOX); i++)</a>
<a name="ln917">	{</a>
<a name="ln918">		ItemAt(i, DiagramItem::M_BOX)-&gt;moveTo(BPoint(-200.0, -200.0));</a>
<a name="ln919">	}</a>
<a name="ln920"> </a>
<a name="ln921">	// move all panels to their 'ideal' position</a>
<a name="ln922">	for (uint32 i = 0; i &lt; CountItems(DiagramItem::M_BOX); i++)</a>
<a name="ln923">	{</a>
<a name="ln924">		MediaNodePanel *panel;</a>
<a name="ln925">		panel = dynamic_cast&lt;MediaNodePanel *&gt;(ItemAt(i, DiagramItem::M_BOX));</a>
<a name="ln926">		BPoint p = findFreePositionFor(panel);</a>
<a name="ln927">		panel-&gt;moveTo(p);</a>
<a name="ln928">	}</a>
<a name="ln929"> </a>
<a name="ln930">	SortItems(DiagramItem::M_BOX, compareSelectionTime);</a>
<a name="ln931">	Invalidate();</a>
<a name="ln932">	updateDataRect();</a>
<a name="ln933">}</a>
<a name="ln934"> </a>
<a name="ln935">void MediaRoutingView::showContextMenu(</a>
<a name="ln936">	BPoint point)</a>
<a name="ln937">{</a>
<a name="ln938">	D_METHOD((&quot;MediaRoutingView::showContextMenu()\n&quot;));</a>
<a name="ln939"> </a>
<a name="ln940">	BPopUpMenu *menu = new BPopUpMenu(&quot;MediaRoutingView PopUp&quot;, false, false, B_ITEMS_IN_COLUMN);</a>
<a name="ln941">	menu-&gt;SetFont(be_plain_font);</a>
<a name="ln942"> </a>
<a name="ln943">	// add layout options</a>
<a name="ln944">	BMenuItem *item;</a>
<a name="ln945">	BMessage *message = new BMessage(M_LAYOUT_CHANGED);</a>
<a name="ln946">	message-&gt;AddInt32(&quot;layout&quot;, M_ICON_VIEW);</a>
<a name="ln947">	menu-&gt;AddItem(item = new BMenuItem(&quot;Icon view&quot;, message));</a>
<a name="ln948">	if (m_layout == M_ICON_VIEW)</a>
<a name="ln949">	{</a>
<a name="ln950">		item-&gt;SetMarked(true);</a>
<a name="ln951">	}</a>
<a name="ln952">	message = new BMessage(M_LAYOUT_CHANGED);</a>
<a name="ln953">	message-&gt;AddInt32(&quot;layout&quot;, M_MINI_ICON_VIEW);</a>
<a name="ln954">	menu-&gt;AddItem(item = new BMenuItem(&quot;Mini icon view&quot;, message));</a>
<a name="ln955">	if (m_layout == M_MINI_ICON_VIEW)</a>
<a name="ln956">	{</a>
<a name="ln957">		item-&gt;SetMarked(true);</a>
<a name="ln958">	}</a>
<a name="ln959">	menu-&gt;AddSeparatorItem();</a>
<a name="ln960"> </a>
<a name="ln961">	// add 'CleanUp' command</a>
<a name="ln962">	menu-&gt;AddItem(new BMenuItem(&quot;Clean up&quot;, new BMessage(M_CLEANUP_REQUESTED), 'K'));</a>
<a name="ln963"> </a>
<a name="ln964">	// add 'Select All' command</a>
<a name="ln965">	menu-&gt;AddItem(new BMenuItem(&quot;Select all&quot;, new BMessage(M_SELECT_ALL), 'A'));</a>
<a name="ln966"> </a>
<a name="ln967">	menu-&gt;SetTargetForItems(this);</a>
<a name="ln968">	ConvertToScreen(&amp;point);</a>
<a name="ln969">	point -= BPoint(1.0, 1.0);</a>
<a name="ln970">	menu-&gt;Go(point, true, true, true);</a>
<a name="ln971">}</a>
<a name="ln972"> </a>
<a name="ln973">void MediaRoutingView::showErrorMessage(</a>
<a name="ln974">	BString text,</a>
<a name="ln975">	status_t error)</a>
<a name="ln976">{</a>
<a name="ln977">	D_METHOD((&quot;MediaRoutingView::showErrorMessage()\n&quot;));</a>
<a name="ln978"> </a>
<a name="ln979">	if (error) {</a>
<a name="ln980">		text &lt;&lt; &quot; (&quot; &lt;&lt; strerror(error) &lt;&lt; &quot;)&quot;;</a>
<a name="ln981">	}</a>
<a name="ln982"> </a>
<a name="ln983">	BMessage message(M_SHOW_ERROR_MESSAGE);</a>
<a name="ln984">	message.AddString(&quot;text&quot;, text.String());</a>
<a name="ln985">	if (error) {</a>
<a name="ln986">		message.AddBool(&quot;error&quot;, true);</a>
<a name="ln987">	}</a>
<a name="ln988">	BMessenger messenger(0, Window());</a>
<a name="ln989">	if (!messenger.IsValid()</a>
<a name="ln990">	 || (messenger.SendMessage(&amp;message) != B_OK)) {</a>
<a name="ln991">		BAlert *alert = new BAlert(&quot;Error&quot;, text.String(), &quot;OK&quot;, 0, 0,</a>
<a name="ln992">								   B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln993">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln994">		alert-&gt;Go();</a>
<a name="ln995">	}</a>
<a name="ln996">}</a>
<a name="ln997"> </a>
<a name="ln998">// -------------------------------------------------------- //</a>
<a name="ln999">// *** IStateArchivable</a>
<a name="ln1000">// -------------------------------------------------------- //</a>
<a name="ln1001"> </a>
<a name="ln1002">status_t MediaRoutingView::importState(</a>
<a name="ln1003">	const BMessage*						archive) {</a>
<a name="ln1004"> </a>
<a name="ln1005">	status_t err;</a>
<a name="ln1006"> </a>
<a name="ln1007">	_emptyInactiveNodeState();</a>
<a name="ln1008"> </a>
<a name="ln1009">	layout_t layout;</a>
<a name="ln1010">	err = archive-&gt;FindInt32(&quot;layout&quot;, (int32*)&amp;layout);</a>
<a name="ln1011">	if(err == B_OK &amp;&amp; layout != m_layout) {</a>
<a name="ln1012">		layoutChanged(layout);</a>
<a name="ln1013">	}</a>
<a name="ln1014"> </a>
<a name="ln1015">	const char* path;</a>
<a name="ln1016">	err = archive-&gt;FindString(&quot;bgBitmap&quot;, &amp;path);</a>
<a name="ln1017">	if(err == B_OK) {</a>
<a name="ln1018">		BEntry entry(path);</a>
<a name="ln1019">		entry_ref ref;</a>
<a name="ln1020">		err = entry.GetRef(&amp;ref);</a>
<a name="ln1021">		if(err == B_OK)</a>
<a name="ln1022">			_changeBackground(&amp;ref);</a>
<a name="ln1023">	}</a>
<a name="ln1024">	else {</a>
<a name="ln1025">		rgb_color color;</a>
<a name="ln1026">		color.alpha = 255;</a>
<a name="ln1027">		if(</a>
<a name="ln1028">			archive-&gt;FindInt8(&quot;bgRed&quot;, (int8*)&amp;color.red) == B_OK &amp;&amp;</a>
<a name="ln1029">			archive-&gt;FindInt8(&quot;bgGreen&quot;, (int8*)&amp;color.green) == B_OK &amp;&amp;</a>
<a name="ln1030">			archive-&gt;FindInt8(&quot;bgBlue&quot;, (int8*)&amp;color.blue) == B_OK)</a>
<a name="ln1031">				_changeBackground(color);</a>
<a name="ln1032">	}</a>
<a name="ln1033"> </a>
<a name="ln1034">	for(int32 n = 0; ; ++n) {</a>
<a name="ln1035"> </a>
<a name="ln1036">		// find panel state info; stop when exhausted</a>
<a name="ln1037">		BMessage m;</a>
<a name="ln1038">		err = archive-&gt;FindMessage(&quot;panel&quot;, n, &amp;m);</a>
<a name="ln1039">		if(err &lt; B_OK)</a>
<a name="ln1040">			break;</a>
<a name="ln1041"> </a>
<a name="ln1042">		const char* nodeName;</a>
<a name="ln1043">		err = archive-&gt;FindString(&quot;nodeName&quot;, n, &amp;nodeName);</a>
<a name="ln1044">		if(err &lt; B_OK)</a>
<a name="ln1045">			break;</a>
<a name="ln1046"> </a>
<a name="ln1047">		uint32 nodeKind;</a>
<a name="ln1048">		err = archive-&gt;FindInt32(&quot;nodeKind&quot;, n, (int32*)&amp;nodeKind);</a>
<a name="ln1049">		if(err &lt; B_OK)</a>
<a name="ln1050">			break;</a>
<a name="ln1051"> </a>
<a name="ln1052">		// look up matching panel +++++ SLOW +++++</a>
<a name="ln1053">		uint32 panelIndex;</a>
<a name="ln1054">		uint32 items = CountItems(DiagramItem::M_BOX);</a>
<a name="ln1055">		for(</a>
<a name="ln1056">			panelIndex = 0;</a>
<a name="ln1057">			panelIndex &lt; items;</a>
<a name="ln1058">			++panelIndex) {</a>
<a name="ln1059"> </a>
<a name="ln1060">			MediaNodePanel* panel = dynamic_cast&lt;MediaNodePanel*&gt;(</a>
<a name="ln1061">				ItemAt(panelIndex, DiagramItem::M_BOX));</a>
<a name="ln1062"> </a>
<a name="ln1063">			if(panel &amp;&amp;</a>
<a name="ln1064">				!strcmp(panel-&gt;ref-&gt;name(), nodeName) &amp;&amp;</a>
<a name="ln1065">				panel-&gt;ref-&gt;kind() == nodeKind) {</a>
<a name="ln1066"> </a>
<a name="ln1067">				// found match; hand message to panel</a>
<a name="ln1068">				panel-&gt;importState(&amp;m);</a>
<a name="ln1069">				break;</a>
<a name="ln1070">			}</a>
<a name="ln1071">		}</a>
<a name="ln1072">		if(panelIndex == items) {</a>
<a name="ln1073">			// no panel found</a>
<a name="ln1074">			// if a &quot;system node&quot; hang onto (and re-export) state info</a>
<a name="ln1075">			bool sysOwned;</a>
<a name="ln1076">			if(m.FindBool(&quot;sysOwned&quot;, &amp;sysOwned) == B_OK &amp;&amp; sysOwned) {</a>
<a name="ln1077">				m_inactiveNodeState.AddItem(</a>
<a name="ln1078">					new _inactive_node_state_entry(</a>
<a name="ln1079">						nodeName, nodeKind, m));</a>
<a name="ln1080">			}</a>
<a name="ln1081">		}</a>
<a name="ln1082">	}</a>
<a name="ln1083"> </a>
<a name="ln1084">	updateDataRect();</a>
<a name="ln1085"> </a>
<a name="ln1086">	return B_OK;</a>
<a name="ln1087">}</a>
<a name="ln1088"> </a>
<a name="ln1089">// +++++ export state info for currently inactive system nodes +++++</a>
<a name="ln1090">status_t MediaRoutingView::exportState(</a>
<a name="ln1091">	BMessage*									archive) const {</a>
<a name="ln1092"> </a>
<a name="ln1093">	// store layout mode</a>
<a name="ln1094">	archive-&gt;AddInt32(&quot;layout&quot;, m_layout);</a>
<a name="ln1095"> </a>
<a name="ln1096">	// store background settings</a>
<a name="ln1097">	if(m_backgroundBitmapEntry.InitCheck() == B_OK) {</a>
<a name="ln1098">		BPath path;</a>
<a name="ln1099">		m_backgroundBitmapEntry.GetPath(&amp;path);</a>
<a name="ln1100">		archive-&gt;AddString(&quot;bgBitmap&quot;, path.Path());</a>
<a name="ln1101">	} else {</a>
<a name="ln1102">		rgb_color c = backgroundColor();</a>
<a name="ln1103">		archive-&gt;AddInt8(&quot;bgRed&quot;, c.red);</a>
<a name="ln1104">		archive-&gt;AddInt8(&quot;bgGreen&quot;, c.green);</a>
<a name="ln1105">		archive-&gt;AddInt8(&quot;bgBlue&quot;, c.blue);</a>
<a name="ln1106">	}</a>
<a name="ln1107"> </a>
<a name="ln1108">	// store panel positions w/ node names &amp; signatures</a>
<a name="ln1109">	for(uint32 n = 0; n &lt; CountItems(DiagramItem::M_BOX); ++n) {</a>
<a name="ln1110">		MediaNodePanel* panel = dynamic_cast&lt;MediaNodePanel*&gt;(</a>
<a name="ln1111">			ItemAt(n, DiagramItem::M_BOX));</a>
<a name="ln1112">		if(!panel)</a>
<a name="ln1113">			continue;</a>
<a name="ln1114"> </a>
<a name="ln1115">		if(panel-&gt;ref-&gt;isInternal())</a>
<a name="ln1116">			// skip internal nodes</a>
<a name="ln1117">			continue;</a>
<a name="ln1118"> </a>
<a name="ln1119">		BMessage m;</a>
<a name="ln1120">		panel-&gt;exportState(&amp;m);</a>
<a name="ln1121">		archive-&gt;AddString(&quot;nodeName&quot;, panel-&gt;ref-&gt;name());</a>
<a name="ln1122">		archive-&gt;AddInt32(&quot;nodeKind&quot;, panel-&gt;ref-&gt;kind());</a>
<a name="ln1123">		archive-&gt;AddMessage(&quot;panel&quot;, &amp;m);</a>
<a name="ln1124">	}</a>
<a name="ln1125"> </a>
<a name="ln1126">	// copy inactive node state info</a>
<a name="ln1127">	for(int32 n = 0; n &lt; m_inactiveNodeState.CountItems(); ++n) {</a>
<a name="ln1128">		_inactive_node_state_entry* e = reinterpret_cast&lt;_inactive_node_state_entry*&gt;(</a>
<a name="ln1129">			m_inactiveNodeState.ItemAt(n));</a>
<a name="ln1130"> </a>
<a name="ln1131">		archive-&gt;AddString(&quot;nodeName&quot;, e-&gt;name.String());</a>
<a name="ln1132">		archive-&gt;AddInt32(&quot;nodeKind&quot;, e-&gt;kind);</a>
<a name="ln1133">		archive-&gt;AddMessage(&quot;panel&quot;, &amp;e-&gt;state);</a>
<a name="ln1134">	}</a>
<a name="ln1135"> </a>
<a name="ln1136">	return B_OK;</a>
<a name="ln1137">}</a>
<a name="ln1138"> </a>
<a name="ln1139">// [e.moon 8dec99] subset support</a>
<a name="ln1140"> </a>
<a name="ln1141">status_t MediaRoutingView::importStateFor(</a>
<a name="ln1142">	const NodeSetIOContext*		context,</a>
<a name="ln1143">	const BMessage*						archive) {</a>
<a name="ln1144"> </a>
<a name="ln1145">	status_t err;</a>
<a name="ln1146"> </a>
<a name="ln1147">	for(int32 archiveIndex = 0;; ++archiveIndex) {</a>
<a name="ln1148"> </a>
<a name="ln1149">		// fetch archived key &amp; panel data</a>
<a name="ln1150">		const char* key;</a>
<a name="ln1151">		err = archive-&gt;FindString(&quot;nodeKey&quot;, archiveIndex, &amp;key);</a>
<a name="ln1152">		if(err &lt; B_OK)</a>
<a name="ln1153">			break;</a>
<a name="ln1154"> </a>
<a name="ln1155">		BMessage m;</a>
<a name="ln1156">		err = archive-&gt;FindMessage(&quot;panel&quot;, archiveIndex, &amp;m);</a>
<a name="ln1157">		if(err &lt; B_OK) {</a>
<a name="ln1158">			PRINT((</a>
<a name="ln1159">				&quot;!!! MediaRoutingView::importStateFor(): missing panel %&quot;</a>
<a name="ln1160">					B_PRId32 &quot;\n&quot;, archiveIndex));</a>
<a name="ln1161">			continue;</a>
<a name="ln1162">		}</a>
<a name="ln1163"> </a>
<a name="ln1164">		// find corresponding node</a>
<a name="ln1165">		media_node_id id;</a>
<a name="ln1166">		err = context-&gt;getNodeFor(key, &amp;id);</a>
<a name="ln1167">		if(err &lt; B_OK) {</a>
<a name="ln1168">			PRINT((</a>
<a name="ln1169">				&quot;!!! MediaRoutingView::importStateFor(): missing node '%s'\n&quot;,</a>
<a name="ln1170">				key));</a>
<a name="ln1171">			continue;</a>
<a name="ln1172">		}</a>
<a name="ln1173"> </a>
<a name="ln1174">		// look for panel, create it if necessary</a>
<a name="ln1175">		MediaNodePanel* panel;</a>
<a name="ln1176">		err = _findPanelFor(id,	&amp;panel);</a>
<a name="ln1177">		if(err &lt; B_OK) {</a>
<a name="ln1178">			// create it</a>
<a name="ln1179">			err = _addPanelFor(</a>
<a name="ln1180">				id,</a>
<a name="ln1181">				BPoint(5.0, 5.0));</a>
<a name="ln1182">			if(err &lt; B_OK) {</a>
<a name="ln1183">				PRINT((</a>
<a name="ln1184">					&quot;!!! MediaRoutingView::importStateFor(): _addPanelFor():\n&quot;</a>
<a name="ln1185">					&quot;    %s\n&quot;, strerror(err)));</a>
<a name="ln1186">				continue;</a>
<a name="ln1187">			}</a>
<a name="ln1188"> </a>
<a name="ln1189">			err = _findPanelFor(id,	&amp;panel);</a>
<a name="ln1190">			if(err &lt; B_OK) {</a>
<a name="ln1191">				PRINT((</a>
<a name="ln1192">					&quot;!!! MediaRoutingView::importStateFor(): _findPanelFor():\n&quot;</a>
<a name="ln1193">					&quot;    %s\n&quot;, strerror(err)));</a>
<a name="ln1194">				continue;</a>
<a name="ln1195">			}</a>
<a name="ln1196">		}</a>
<a name="ln1197"> </a>
<a name="ln1198">		// pass state data along</a>
<a name="ln1199">		panel-&gt;importState(&amp;m);</a>
<a name="ln1200"> </a>
<a name="ln1201">		// select the panel</a>
<a name="ln1202">		SelectItem(panel, false);</a>
<a name="ln1203">	}</a>
<a name="ln1204"> </a>
<a name="ln1205">	return B_OK;</a>
<a name="ln1206">}</a>
<a name="ln1207"> </a>
<a name="ln1208">status_t MediaRoutingView::exportStateFor(</a>
<a name="ln1209">	const NodeSetIOContext*		context,</a>
<a name="ln1210">	BMessage*									archive) const {</a>
<a name="ln1211"> </a>
<a name="ln1212">	status_t err;</a>
<a name="ln1213"> </a>
<a name="ln1214">	for(uint32 n = 0; n &lt; context-&gt;countNodes(); ++n) {</a>
<a name="ln1215">		MediaNodePanel* panel;</a>
<a name="ln1216">		err = _findPanelFor(</a>
<a name="ln1217">			context-&gt;nodeAt(n),</a>
<a name="ln1218">			&amp;panel);</a>
<a name="ln1219">		if(err &lt; B_OK) {</a>
<a name="ln1220">			PRINT((</a>
<a name="ln1221">				&quot;!!! MediaRoutingView::exportStateFor():\n&quot;</a>
<a name="ln1222">				&quot;    no panel for node %&quot; B_PRId32 &quot;\n&quot;,</a>
<a name="ln1223">				context-&gt;nodeAt(n)));</a>
<a name="ln1224">			return B_BAD_VALUE;</a>
<a name="ln1225">		}</a>
<a name="ln1226"> </a>
<a name="ln1227">		const char* key = context-&gt;keyAt(n);</a>
<a name="ln1228"> </a>
<a name="ln1229">		archive-&gt;AddString(&quot;nodeKey&quot;, key);</a>
<a name="ln1230">		BMessage m;</a>
<a name="ln1231">		panel-&gt;exportState(&amp;m);</a>
<a name="ln1232">		archive-&gt;AddMessage(&quot;panel&quot;, &amp;m);</a>
<a name="ln1233">	}</a>
<a name="ln1234"> </a>
<a name="ln1235">	return B_OK;</a>
<a name="ln1236">}</a>
<a name="ln1237"> </a>
<a name="ln1238">// -------------------------------------------------------- //</a>
<a name="ln1239">// *** children management</a>
<a name="ln1240">// -------------------------------------------------------- //</a>
<a name="ln1241"> </a>
<a name="ln1242">status_t MediaRoutingView::_addPanelFor(</a>
<a name="ln1243">	media_node_id id,</a>
<a name="ln1244">	BPoint atPoint)</a>
<a name="ln1245">{</a>
<a name="ln1246">	D_METHOD((&quot;MediaRoutingView::_addPanelFor()\n&quot;));</a>
<a name="ln1247"> </a>
<a name="ln1248">	manager-&gt;lock();</a>
<a name="ln1249">	NodeRef *ref;</a>
<a name="ln1250">	status_t error = manager-&gt;getNodeRef(id, &amp;ref);</a>
<a name="ln1251">	manager-&gt;unlock();</a>
<a name="ln1252">	if (!error)</a>
<a name="ln1253">	{</a>
<a name="ln1254">		add_observer(this, ref);</a>
<a name="ln1255">		MediaNodePanel *panel = 0;</a>
<a name="ln1256">		if (id == m_lastDroppedNode) // this was instantiated thru drag &amp; drop</a>
<a name="ln1257">		{</a>
<a name="ln1258">			AddItem(panel = new MediaNodePanel(m_lastDropPoint, ref));</a>
<a name="ln1259">			SelectItem(panel, true);</a>
<a name="ln1260">			m_lastDroppedNode = 0;</a>
<a name="ln1261">		}</a>
<a name="ln1262">		else // this was an externally created node, must find a nice position first</a>
<a name="ln1263">		{</a>
<a name="ln1264">			panel = new MediaNodePanel(BPoint(0.0, 0.0), ref);</a>
<a name="ln1265">			AddItem(panel);</a>
<a name="ln1266">			BMessage state;</a>
<a name="ln1267">			if(_fetchInactiveNodeState(panel, &amp;state) == B_OK)</a>
<a name="ln1268">				panel-&gt;importState(&amp;state);</a>
<a name="ln1269">			else {</a>
<a name="ln1270">				BPoint p = findFreePositionFor(panel);</a>
<a name="ln1271">				panel-&gt;moveTo(p);</a>
<a name="ln1272">			}</a>
<a name="ln1273">			Invalidate(panel-&gt;Frame());</a>
<a name="ln1274">		}</a>
<a name="ln1275">	}</a>
<a name="ln1276">	updateDataRect();</a>
<a name="ln1277">	return error;</a>
<a name="ln1278">}</a>
<a name="ln1279"> </a>
<a name="ln1280">status_t MediaRoutingView::_findPanelFor(</a>
<a name="ln1281">	media_node_id id,</a>
<a name="ln1282">	MediaNodePanel **outPanel) const</a>
<a name="ln1283">{</a>
<a name="ln1284">	D_METHOD((&quot;MediaRoutingView::_findPanelFor()\n&quot;));</a>
<a name="ln1285"> </a>
<a name="ln1286">	for (uint32 i = 0; i &lt; CountItems(DiagramItem::M_BOX); i++)</a>
<a name="ln1287">	{</a>
<a name="ln1288">		MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(ItemAt(i, DiagramItem::M_BOX));</a>
<a name="ln1289">		if (panel)</a>
<a name="ln1290">		{</a>
<a name="ln1291">			if (panel-&gt;ref-&gt;id() == id)</a>
<a name="ln1292">			{</a>
<a name="ln1293">				*outPanel = panel;</a>
<a name="ln1294">				return B_OK;</a>
<a name="ln1295">			}</a>
<a name="ln1296">		}</a>
<a name="ln1297">	}</a>
<a name="ln1298">	return B_ERROR;</a>
<a name="ln1299">}</a>
<a name="ln1300"> </a>
<a name="ln1301">status_t MediaRoutingView::_removePanelFor(</a>
<a name="ln1302">	media_node_id id)</a>
<a name="ln1303">{</a>
<a name="ln1304">	D_METHOD((&quot;MediaRoutingView::_removePanelFor()\n&quot;));</a>
<a name="ln1305"> </a>
<a name="ln1306">	MediaNodePanel *panel;</a>
<a name="ln1307">	if (_findPanelFor(id, &amp;panel) == B_OK)</a>
<a name="ln1308">	{</a>
<a name="ln1309">		if (RemoveItem(panel))</a>
<a name="ln1310">		{</a>
<a name="ln1311">			remove_observer(this, panel-&gt;ref);</a>
<a name="ln1312">			Invalidate(panel-&gt;Frame());</a>
<a name="ln1313">			delete panel;</a>
<a name="ln1314">			return B_OK;</a>
<a name="ln1315">		}</a>
<a name="ln1316">	}</a>
<a name="ln1317">	return B_ERROR;</a>
<a name="ln1318">}</a>
<a name="ln1319"> </a>
<a name="ln1320">status_t MediaRoutingView::_addWireFor(</a>
<a name="ln1321">	Connection&amp; connection)</a>
<a name="ln1322">{</a>
<a name="ln1323">	D_METHOD((&quot;MediaRoutingView::_addWireFor()\n&quot;));</a>
<a name="ln1324"> </a>
<a name="ln1325">	MediaNodePanel *source, *destination;</a>
<a name="ln1326">	if ((_findPanelFor(connection.sourceNode(), &amp;source) == B_OK)</a>
<a name="ln1327">	 &amp;&amp; (_findPanelFor(connection.destinationNode(), &amp;destination) == B_OK))</a>
<a name="ln1328">	{</a>
<a name="ln1329">		status_t error;</a>
<a name="ln1330"> </a>
<a name="ln1331">		media_output output;</a>
<a name="ln1332">		error = connection.getOutput(&amp;output);</a>
<a name="ln1333">		if (error)</a>
<a name="ln1334">		{</a>
<a name="ln1335">			return error;</a>
<a name="ln1336">		}</a>
<a name="ln1337">		MediaJack *outputJack = new MediaJack(output);</a>
<a name="ln1338">		source-&gt;AddItem(outputJack);</a>
<a name="ln1339"> </a>
<a name="ln1340">		media_input input;</a>
<a name="ln1341">		error = connection.getInput(&amp;input);</a>
<a name="ln1342">		if (error)</a>
<a name="ln1343">		{</a>
<a name="ln1344">			return error;</a>
<a name="ln1345">		}</a>
<a name="ln1346">		MediaJack *inputJack =  new MediaJack(input);</a>
<a name="ln1347">		destination-&gt;AddItem(inputJack);</a>
<a name="ln1348"> </a>
<a name="ln1349">		MediaWire *wire = new MediaWire(connection, outputJack, inputJack);</a>
<a name="ln1350">		AddItem(wire);</a>
<a name="ln1351">		source-&gt;updateIOJacks();</a>
<a name="ln1352">		source-&gt;arrangeIOJacks();</a>
<a name="ln1353">		destination-&gt;updateIOJacks();</a>
<a name="ln1354">		destination-&gt;arrangeIOJacks();</a>
<a name="ln1355">		updateDataRect();</a>
<a name="ln1356"> </a>
<a name="ln1357">		// [e.moon 21nov99] group creation/merging now performed by</a>
<a name="ln1358">		// RouteAppNodeManager</a>
<a name="ln1359"> </a>
<a name="ln1360">		Invalidate(source-&gt;Frame());</a>
<a name="ln1361">		Invalidate(destination-&gt;Frame());</a>
<a name="ln1362">		Invalidate(wire-&gt;Frame());</a>
<a name="ln1363">		return B_OK;</a>
<a name="ln1364">	}</a>
<a name="ln1365">	else</a>
<a name="ln1366">	{</a>
<a name="ln1367">		return B_ERROR;</a>
<a name="ln1368">	}</a>
<a name="ln1369">}</a>
<a name="ln1370"> </a>
<a name="ln1371">status_t MediaRoutingView::_findWireFor(</a>
<a name="ln1372">	uint32 connectionID,</a>
<a name="ln1373">	MediaWire **outWire) const</a>
<a name="ln1374">{</a>
<a name="ln1375">	D_METHOD((&quot;MediaRoutingView::_findWireFor()\n&quot;));</a>
<a name="ln1376"> </a>
<a name="ln1377">	for (uint32 i = 0; i &lt; CountItems(DiagramItem::M_WIRE); i++)</a>
<a name="ln1378">	{</a>
<a name="ln1379">		MediaWire *wire = dynamic_cast&lt;MediaWire *&gt;(ItemAt(i, DiagramItem::M_WIRE));</a>
<a name="ln1380">		if (wire &amp;&amp; wire-&gt;connection.id() == connectionID)</a>
<a name="ln1381">		{</a>
<a name="ln1382">			*outWire = wire;</a>
<a name="ln1383">			return B_OK;</a>
<a name="ln1384">		}</a>
<a name="ln1385">	}</a>
<a name="ln1386">	return B_ERROR;</a>
<a name="ln1387">}</a>
<a name="ln1388"> </a>
<a name="ln1389">status_t MediaRoutingView::_removeWireFor(</a>
<a name="ln1390">	uint32 connectionID)</a>
<a name="ln1391">{</a>
<a name="ln1392">	D_METHOD((&quot;MediaRoutingView::_removeWireFor()\n&quot;));</a>
<a name="ln1393"> </a>
<a name="ln1394">	MediaWire *wire;</a>
<a name="ln1395">	if (_findWireFor(connectionID, &amp;wire) == B_OK)</a>
<a name="ln1396">	{</a>
<a name="ln1397">		MediaNodePanel *source, *destination;</a>
<a name="ln1398">		_findPanelFor(wire-&gt;connection.sourceNode(), &amp;source);</a>
<a name="ln1399">		_findPanelFor(wire-&gt;connection.destinationNode(), &amp;destination);</a>
<a name="ln1400">		RemoveItem(wire);</a>
<a name="ln1401">		Invalidate(wire-&gt;Frame());</a>
<a name="ln1402">		delete wire;</a>
<a name="ln1403">		if (source)</a>
<a name="ln1404">		{</a>
<a name="ln1405">			source-&gt;updateIOJacks();</a>
<a name="ln1406">			source-&gt;arrangeIOJacks();</a>
<a name="ln1407">			Invalidate(source-&gt;Frame());</a>
<a name="ln1408">		}</a>
<a name="ln1409">		if (destination)</a>
<a name="ln1410">		{</a>
<a name="ln1411">			destination-&gt;updateIOJacks();</a>
<a name="ln1412">			destination-&gt;arrangeIOJacks();</a>
<a name="ln1413">			Invalidate(destination-&gt;Frame());</a>
<a name="ln1414">		}</a>
<a name="ln1415"> </a>
<a name="ln1416">		// [e.moon 21nov99] group split/remove now performed by</a>
<a name="ln1417">		// RouteAppNodeManager</a>
<a name="ln1418"> </a>
<a name="ln1419">		updateDataRect();</a>
<a name="ln1420">		return B_OK;</a>
<a name="ln1421">	}</a>
<a name="ln1422">	return B_ERROR;</a>
<a name="ln1423">}</a>
<a name="ln1424"> </a>
<a name="ln1425">// -------------------------------------------------------- //</a>
<a name="ln1426">// *** internal methods</a>
<a name="ln1427">// -------------------------------------------------------- //</a>
<a name="ln1428"> </a>
<a name="ln1429">void MediaRoutingView::_addShortcuts()</a>
<a name="ln1430">{</a>
<a name="ln1431">	Window()-&gt;AddShortcut('A', B_COMMAND_KEY,</a>
<a name="ln1432">						  new BMessage(M_SELECT_ALL), this);</a>
<a name="ln1433">	Window()-&gt;AddShortcut('K', B_COMMAND_KEY,</a>
<a name="ln1434">						  new BMessage(M_CLEANUP_REQUESTED), this);</a>
<a name="ln1435">	Window()-&gt;AddShortcut('T', B_COMMAND_KEY,</a>
<a name="ln1436">						  new BMessage(M_DELETE_SELECTION), this);</a>
<a name="ln1437">	Window()-&gt;AddShortcut('P', B_COMMAND_KEY,</a>
<a name="ln1438">						  new BMessage(M_NODE_TWEAK_PARAMETERS), this);</a>
<a name="ln1439">	Window()-&gt;AddShortcut('P', B_COMMAND_KEY | B_SHIFT_KEY,</a>
<a name="ln1440">						  new BMessage(M_NODE_START_CONTROL_PANEL), this);</a>
<a name="ln1441">	Window()-&gt;AddShortcut('I', B_COMMAND_KEY,</a>
<a name="ln1442">						  new BMessage(InfoWindowManager::M_INFO_WINDOW_REQUESTED), this);</a>
<a name="ln1443">}</a>
<a name="ln1444"> </a>
<a name="ln1445">void MediaRoutingView::_initLayout()</a>
<a name="ln1446">{</a>
<a name="ln1447">	D_METHOD((&quot;MediaRoutingView::_initLayout()\n&quot;));</a>
<a name="ln1448"> </a>
<a name="ln1449">	switch (m_layout)</a>
<a name="ln1450">	{</a>
<a name="ln1451">		case M_ICON_VIEW:</a>
<a name="ln1452">		{</a>
<a name="ln1453">			// Adjust the jack width for displaying the abbreviated</a>
<a name="ln1454">			// input/output name</a>
<a name="ln1455">			BFont font(be_plain_font);</a>
<a name="ln1456">			font.SetSize(font.Size() - 2.0);</a>
<a name="ln1457">			for (int i = 0; i &lt; MediaJack::M_MAX_ABBR_LENGTH; i++)</a>
<a name="ln1458">			{</a>
<a name="ln1459">				MediaJack::M_DEFAULT_WIDTH += font.StringWidth(&quot;M&quot;);</a>
<a name="ln1460">			}</a>
<a name="ln1461">			MediaJack::M_DEFAULT_WIDTH += 2.0; // add some padding</a>
<a name="ln1462"> </a>
<a name="ln1463">			// Adjust the default size for MediaNodePanels to fit the</a>
<a name="ln1464">			// size of be_plain_font</a>
<a name="ln1465">			float labelWidth, bodyWidth;</a>
<a name="ln1466">			float labelHeight, bodyHeight;</a>
<a name="ln1467">			font_height fh;</a>
<a name="ln1468">			be_plain_font-&gt;GetHeight(&amp;fh);</a>
<a name="ln1469">			labelWidth = 4 * MediaNodePanel::M_LABEL_H_MARGIN</a>
<a name="ln1470">						 + be_plain_font-&gt;StringWidth(&quot; Be Audio Mixer &quot;);</a>
<a name="ln1471">			bodyWidth = 2 * MediaNodePanel::M_BODY_H_MARGIN + B_LARGE_ICON</a>
<a name="ln1472">						+ 2 * MediaJack::M_DEFAULT_WIDTH;</a>
<a name="ln1473">			labelHeight = 2 * MediaNodePanel::M_LABEL_V_MARGIN</a>
<a name="ln1474">						  + fh.ascent + fh.descent + fh.leading + 1.0;</a>
<a name="ln1475">			bodyHeight = 2 * MediaNodePanel::M_BODY_V_MARGIN + B_LARGE_ICON;</a>
<a name="ln1476">			MediaNodePanel::M_DEFAULT_WIDTH = labelWidth &gt; bodyWidth ? labelWidth : bodyWidth;</a>
<a name="ln1477">			MediaNodePanel::M_DEFAULT_HEIGHT = labelHeight + bodyHeight;</a>
<a name="ln1478">			Align(&amp;MediaNodePanel::M_DEFAULT_WIDTH, &amp;MediaNodePanel::M_DEFAULT_HEIGHT);</a>
<a name="ln1479"> </a>
<a name="ln1480">			// Adjust the cleanup settings</a>
<a name="ln1481">			M_CLEANUP_H_GAP += MediaNodePanel::M_DEFAULT_WIDTH;</a>
<a name="ln1482">			break;</a>
<a name="ln1483">		}</a>
<a name="ln1484">		case M_MINI_ICON_VIEW:</a>
<a name="ln1485">		{</a>
<a name="ln1486">			// Adjust the default size for MediaNodePanels to fit the</a>
<a name="ln1487">			// size of be_plain_font</a>
<a name="ln1488">			float labelWidth, bodyWidth;</a>
<a name="ln1489">			float labelHeight, bodyHeight;</a>
<a name="ln1490">			font_height fh;</a>
<a name="ln1491">			be_plain_font-&gt;GetHeight(&amp;fh);</a>
<a name="ln1492">			labelWidth = 4 * MediaNodePanel::M_LABEL_H_MARGIN</a>
<a name="ln1493">						 + be_plain_font-&gt;StringWidth(&quot; Be Audio Mixer &quot;);</a>
<a name="ln1494">			bodyWidth = 2 * MediaNodePanel::M_BODY_H_MARGIN + B_MINI_ICON;</a>
<a name="ln1495">			labelHeight = 3 * MediaNodePanel::M_LABEL_V_MARGIN</a>
<a name="ln1496">						  + fh.ascent + fh.descent + fh.leading</a>
<a name="ln1497">						  + 2 * MediaJack::M_DEFAULT_HEIGHT;</a>
<a name="ln1498">			bodyHeight = 2 * MediaNodePanel::M_BODY_V_MARGIN + B_MINI_ICON;</a>
<a name="ln1499">			MediaNodePanel::M_DEFAULT_WIDTH = labelWidth + bodyWidth;</a>
<a name="ln1500">			MediaNodePanel::M_DEFAULT_HEIGHT = labelHeight &gt; bodyHeight ? labelHeight : bodyHeight;</a>
<a name="ln1501">			Align(&amp;MediaNodePanel::M_DEFAULT_WIDTH, &amp;MediaNodePanel::M_DEFAULT_HEIGHT);</a>
<a name="ln1502"> </a>
<a name="ln1503">			// Adjust the cleanup settings</a>
<a name="ln1504">			M_CLEANUP_V_GAP += MediaNodePanel::M_DEFAULT_HEIGHT;</a>
<a name="ln1505">			break;</a>
<a name="ln1506">		}</a>
<a name="ln1507">	}</a>
<a name="ln1508">}</a>
<a name="ln1509"> </a>
<a name="ln1510">void MediaRoutingView::_initContent()</a>
<a name="ln1511">{</a>
<a name="ln1512">	D_METHOD((&quot;MediaRoutingView::_initContent()\n&quot;));</a>
<a name="ln1513"> </a>
<a name="ln1514">	Autolock lock(manager);</a>
<a name="ln1515"> </a>
<a name="ln1516">	void *cookie = 0;</a>
<a name="ln1517">	NodeRef *ref;</a>
<a name="ln1518">	while (manager-&gt;getNextRef(&amp;ref, &amp;cookie) == B_OK)</a>
<a name="ln1519">	{</a>
<a name="ln1520">		// add self as observer</a>
<a name="ln1521">		add_observer(this, ref);</a>
<a name="ln1522">		// create &amp; place node view (+++++ defer until observer status confirmed!)</a>
<a name="ln1523">		_addPanelFor(ref-&gt;id(), BPoint(M_CLEANUP_H_MARGIN, M_CLEANUP_V_MARGIN));</a>
<a name="ln1524">	}</a>
<a name="ln1525">	cookie = 0;</a>
<a name="ln1526">	Connection connection;</a>
<a name="ln1527">	while (manager-&gt;getNextConnection(&amp;connection, &amp;cookie) == B_OK)</a>
<a name="ln1528">	{</a>
<a name="ln1529">		_addWireFor(connection);</a>
<a name="ln1530">	}</a>
<a name="ln1531"> </a>
<a name="ln1532">	// create default groups</a>
<a name="ln1533">	NodeGroup* group;</a>
<a name="ln1534">	NodeRef* videoIn = manager-&gt;videoInputNode();</a>
<a name="ln1535">	if (videoIn)</a>
<a name="ln1536">	{</a>
<a name="ln1537">		group = manager-&gt;createGroup(&quot;Video input&quot;);</a>
<a name="ln1538">		group-&gt;setRunMode(BMediaNode::B_RECORDING);</a>
<a name="ln1539">		group-&gt;addNode(videoIn);</a>
<a name="ln1540">	}</a>
<a name="ln1541">	NodeRef* audioIn = manager-&gt;audioInputNode();</a>
<a name="ln1542">	if (audioIn)</a>
<a name="ln1543">	{</a>
<a name="ln1544">		group = manager-&gt;createGroup(&quot;Audio input&quot;);</a>
<a name="ln1545">		group-&gt;setRunMode(BMediaNode::B_RECORDING);</a>
<a name="ln1546">		group-&gt;addNode(audioIn);</a>
<a name="ln1547">	}</a>
<a name="ln1548">	NodeRef* videoOut = manager-&gt;videoOutputNode();</a>
<a name="ln1549">	if (videoOut)</a>
<a name="ln1550">	{</a>
<a name="ln1551">		group = manager-&gt;createGroup(&quot;Video output&quot;);</a>
<a name="ln1552">		group-&gt;addNode(videoOut);</a>
<a name="ln1553">	}</a>
<a name="ln1554">}</a>
<a name="ln1555"> </a>
<a name="ln1556">void MediaRoutingView::_changeCyclingForSelection(</a>
<a name="ln1557">	bool cycle)</a>
<a name="ln1558">{</a>
<a name="ln1559">	D_METHOD((&quot;MediaRoutingView::_changeCyclingForSelection()\n&quot;));</a>
<a name="ln1560"> </a>
<a name="ln1561">	if (SelectedType() == DiagramItem::M_BOX)</a>
<a name="ln1562">	{</a>
<a name="ln1563">		manager-&gt;lock();</a>
<a name="ln1564">		for (uint32 i = 0; i &lt; CountSelectedItems(); i++)</a>
<a name="ln1565">		{</a>
<a name="ln1566">			MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(SelectedItemAt(i));</a>
<a name="ln1567">			if (panel &amp;&amp; (panel-&gt;ref-&gt;isCycling() != cycle))</a>
<a name="ln1568">			{</a>
<a name="ln1569">				panel-&gt;ref-&gt;setCycling(cycle);</a>
<a name="ln1570">			}</a>
<a name="ln1571">		}</a>
<a name="ln1572">		manager-&gt;unlock();</a>
<a name="ln1573">	}</a>
<a name="ln1574">}</a>
<a name="ln1575"> </a>
<a name="ln1576">void MediaRoutingView::_changeRunModeForSelection(</a>
<a name="ln1577">	uint32 mode)</a>
<a name="ln1578">{</a>
<a name="ln1579">	D_METHOD((&quot;MediaRoutingView::_changeRunModeForSelection()\n&quot;));</a>
<a name="ln1580"> </a>
<a name="ln1581">	if (SelectedType() == DiagramItem::M_BOX)</a>
<a name="ln1582">	{</a>
<a name="ln1583">		manager-&gt;lock();</a>
<a name="ln1584">		for (uint32 i = 0; i &lt; CountSelectedItems(); i++)</a>
<a name="ln1585">		{</a>
<a name="ln1586">			MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(SelectedItemAt(i));</a>
<a name="ln1587">			if (panel &amp;&amp; (panel-&gt;ref-&gt;runMode() != mode))</a>
<a name="ln1588">			{</a>
<a name="ln1589">				panel-&gt;ref-&gt;setRunMode(mode);</a>
<a name="ln1590">			}</a>
<a name="ln1591">		}</a>
<a name="ln1592">		manager-&gt;unlock();</a>
<a name="ln1593">	}</a>
<a name="ln1594">}</a>
<a name="ln1595"> </a>
<a name="ln1596">void MediaRoutingView::_openInfoWindowsForSelection() {</a>
<a name="ln1597">	D_METHOD((&quot;MediaRoutingView::_openInfoWindowsForSelection()\n&quot;));</a>
<a name="ln1598"> </a>
<a name="ln1599">	InfoWindowManager *manager = InfoWindowManager::Instance();</a>
<a name="ln1600">	if (!manager) {</a>
<a name="ln1601">		return;</a>
<a name="ln1602">	}</a>
<a name="ln1603"> </a>
<a name="ln1604">	if (SelectedType() == DiagramItem::M_BOX) {</a>
<a name="ln1605">		for (uint32 i = 0; i &lt; CountSelectedItems(); i++) {</a>
<a name="ln1606">			MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(SelectedItemAt(i));</a>
<a name="ln1607">			if (panel &amp;&amp; manager-&gt;Lock()) {</a>
<a name="ln1608">				manager-&gt;openWindowFor(panel-&gt;ref);</a>
<a name="ln1609">				manager-&gt;Unlock();</a>
<a name="ln1610">			}</a>
<a name="ln1611">		}</a>
<a name="ln1612">	}</a>
<a name="ln1613">	else if (SelectedType() == DiagramItem::M_WIRE) {</a>
<a name="ln1614">		for (uint32 i = 0; i &lt; CountSelectedItems(); i++) {</a>
<a name="ln1615">			MediaWire *wire = dynamic_cast&lt;MediaWire *&gt;(SelectedItemAt(i));</a>
<a name="ln1616">			if (wire &amp;&amp; manager-&gt;Lock()) {</a>
<a name="ln1617">				manager-&gt;openWindowFor(wire-&gt;connection);</a>
<a name="ln1618">				manager-&gt;Unlock();</a>
<a name="ln1619">			}</a>
<a name="ln1620">		}</a>
<a name="ln1621">	}</a>
<a name="ln1622">}</a>
<a name="ln1623"> </a>
<a name="ln1624">void MediaRoutingView::_openParameterWindowsForSelection() {</a>
<a name="ln1625">	D_METHOD((&quot;MediaRoutingView::_openParameterWindowsForSelection()\n&quot;));</a>
<a name="ln1626"> </a>
<a name="ln1627">	if (SelectedType() != DiagramItem::M_BOX) {</a>
<a name="ln1628">		// can only open parameter window for nodes</a>
<a name="ln1629">		return;</a>
<a name="ln1630">	}</a>
<a name="ln1631"> </a>
<a name="ln1632">	for (uint32 i = 0; i &lt; CountSelectedItems(); i++) {</a>
<a name="ln1633">		MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(SelectedItemAt(i));</a>
<a name="ln1634">		if (panel &amp;&amp; (panel-&gt;ref-&gt;kind() &amp; B_CONTROLLABLE)) {</a>
<a name="ln1635">			ParameterWindowManager *paramMgr= ParameterWindowManager::Instance();</a>
<a name="ln1636">			if (paramMgr &amp;&amp; paramMgr-&gt;Lock()) {</a>
<a name="ln1637">				paramMgr-&gt;openWindowFor(panel-&gt;ref);</a>
<a name="ln1638">				paramMgr-&gt;Unlock();</a>
<a name="ln1639">			}</a>
<a name="ln1640">		}</a>
<a name="ln1641">	}</a>
<a name="ln1642">}</a>
<a name="ln1643"> </a>
<a name="ln1644">void MediaRoutingView::_startControlPanelsForSelection() {</a>
<a name="ln1645">	D_METHOD((&quot;MediaRoutingView::_startControlPanelsForSelection()\n&quot;));</a>
<a name="ln1646"> </a>
<a name="ln1647">	if (SelectedType() != DiagramItem::M_BOX) {</a>
<a name="ln1648">		// can only start control panel for nodes</a>
<a name="ln1649">		return;</a>
<a name="ln1650">	}</a>
<a name="ln1651"> </a>
<a name="ln1652">	for (uint32 i = 0; i &lt; CountSelectedItems(); i++) {</a>
<a name="ln1653">		MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(SelectedItemAt(i));</a>
<a name="ln1654">		if (panel &amp;&amp; (panel-&gt;ref-&gt;kind() &amp; B_CONTROLLABLE)) {</a>
<a name="ln1655">			ParameterWindowManager *paramMgr= ParameterWindowManager::Instance();</a>
<a name="ln1656">			if (paramMgr &amp;&amp; paramMgr-&gt;Lock()) {</a>
<a name="ln1657">				paramMgr-&gt;startControlPanelFor(panel-&gt;ref);</a>
<a name="ln1658">				paramMgr-&gt;Unlock();</a>
<a name="ln1659">			}</a>
<a name="ln1660">		}</a>
<a name="ln1661">	}</a>
<a name="ln1662">}</a>
<a name="ln1663"> </a>
<a name="ln1664">void MediaRoutingView::_deleteSelection()</a>
<a name="ln1665">{</a>
<a name="ln1666">	D_METHOD((&quot;MediaRoutingView::_deleteSelection()\n&quot;));</a>
<a name="ln1667">	if (SelectedType() == DiagramItem::M_BOX)</a>
<a name="ln1668">	{</a>
<a name="ln1669">		for (uint32 i = 0; i &lt; CountSelectedItems(); i++)</a>
<a name="ln1670">		{</a>
<a name="ln1671">			MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(SelectedItemAt(i));</a>
<a name="ln1672">			if (panel &amp;&amp; panel-&gt;ref-&gt;isInternal())</a>
<a name="ln1673">			{</a>
<a name="ln1674">				status_t error = panel-&gt;ref-&gt;releaseNode();</a>
<a name="ln1675">				if (error)</a>
<a name="ln1676">				{</a>
<a name="ln1677">					BString s;</a>
<a name="ln1678">					s &lt;&lt; &quot;Could not release '&quot; &lt;&lt; panel-&gt;ref-&gt;name() &lt;&lt; &quot;'&quot;;</a>
<a name="ln1679">					showErrorMessage(s, error);</a>
<a name="ln1680">				}</a>
<a name="ln1681">			}</a>
<a name="ln1682">		}</a>
<a name="ln1683">	}</a>
<a name="ln1684">	else if (SelectedType() == DiagramItem::M_WIRE)</a>
<a name="ln1685">	{</a>
<a name="ln1686">		for (uint32 i = 0; i &lt; CountSelectedItems(); i++)</a>
<a name="ln1687">		{</a>
<a name="ln1688">			MediaWire *wire = dynamic_cast&lt;MediaWire *&gt;(SelectedItemAt(i));</a>
<a name="ln1689">			if (wire &amp;&amp; !(wire-&gt;connection.flags() &amp; Connection::LOCKED))</a>
<a name="ln1690">			{</a>
<a name="ln1691">				status_t error = manager-&gt;disconnect(wire-&gt;connection);</a>
<a name="ln1692">				if (error)</a>
<a name="ln1693">				{</a>
<a name="ln1694">					showErrorMessage(&quot;Could not disconnect&quot;, error);</a>
<a name="ln1695">				}</a>
<a name="ln1696">			}</a>
<a name="ln1697">		}</a>
<a name="ln1698">	}</a>
<a name="ln1699">	// make sure none of the deleted items is still displaying its mouse cursor !</a>
<a name="ln1700">	be_app-&gt;SetCursor(B_HAND_CURSOR);</a>
<a name="ln1701">}</a>
<a name="ln1702"> </a>
<a name="ln1703">void MediaRoutingView::_checkDroppedFile(</a>
<a name="ln1704">	entry_ref *ref,</a>
<a name="ln1705">	BPoint dropPoint)</a>
<a name="ln1706">{</a>
<a name="ln1707">	D_METHOD((&quot;MediaRoutingView::_checkDroppedFile()\n&quot;));</a>
<a name="ln1708"> </a>
<a name="ln1709">	// [cell 26apr00] traverse links</a>
<a name="ln1710">	BEntry entry(ref, true);</a>
<a name="ln1711">	entry.GetRef(ref);</a>
<a name="ln1712"> </a>
<a name="ln1713">	BNode node(ref);</a>
<a name="ln1714">	if (node.InitCheck() == B_OK)</a>
<a name="ln1715">	{</a>
<a name="ln1716">		BNodeInfo nodeInfo(&amp;node);</a>
<a name="ln1717">		if (nodeInfo.InitCheck() == B_OK)</a>
<a name="ln1718">		{</a>
<a name="ln1719">			char mimeString[B_MIME_TYPE_LENGTH];</a>
<a name="ln1720">			if (nodeInfo.GetType(mimeString) == B_OK)</a>
<a name="ln1721">			{</a>
<a name="ln1722">				BMimeType mimeType(mimeString);</a>
<a name="ln1723">				BMimeType superType;</a>
<a name="ln1724"> </a>
<a name="ln1725">				// [e.moon 22dec99] handle dropped node-set files</a>
<a name="ln1726">				if(mimeType == RouteApp::s_nodeSetType) {</a>
<a name="ln1727">					BMessage m(B_REFS_RECEIVED);</a>
<a name="ln1728">					m.AddRef(&quot;refs&quot;, ref);</a>
<a name="ln1729">					be_app_messenger.SendMessage(&amp;m);</a>
<a name="ln1730">				}</a>
<a name="ln1731">				else if (mimeType.GetSupertype(&amp;superType) == B_OK)</a>
<a name="ln1732">				{</a>
<a name="ln1733">					if (superType == &quot;image&quot;)</a>
<a name="ln1734">					{</a>
<a name="ln1735">						_changeBackground(ref);</a>
<a name="ln1736">					}</a>
<a name="ln1737">					else if ((superType == &quot;audio&quot;) || (superType == &quot;video&quot;))</a>
<a name="ln1738">					{</a>
<a name="ln1739">						NodeRef* droppedNode;</a>
<a name="ln1740">						status_t error;</a>
<a name="ln1741">						error = manager-&gt;instantiate(*ref, B_BUFFER_PRODUCER, &amp;droppedNode);</a>
<a name="ln1742">						if (!error)</a>
<a name="ln1743">						{</a>
<a name="ln1744">							media_output encVideoOutput;</a>
<a name="ln1745">							if (droppedNode-&gt;findFreeOutput(&amp;encVideoOutput, B_MEDIA_ENCODED_VIDEO) == B_OK)</a>
<a name="ln1746">							{</a>
<a name="ln1747">								droppedNode-&gt;setFlags(droppedNode-&gt;flags() | NodeRef::NO_POSITION_REPORTING);</a>
<a name="ln1748">							}</a>
<a name="ln1749">							m_lastDroppedNode = droppedNode-&gt;id();</a>
<a name="ln1750">							m_lastDropPoint = Align(dropPoint);</a>
<a name="ln1751">						}</a>
<a name="ln1752">						else</a>
<a name="ln1753">						{</a>
<a name="ln1754">							char fileName[B_FILE_NAME_LENGTH];</a>
<a name="ln1755">							BEntry entry(ref);</a>
<a name="ln1756">							entry.GetName(fileName);</a>
<a name="ln1757">							BString s;</a>
<a name="ln1758">							s &lt;&lt; &quot;Could not load '&quot; &lt;&lt; fileName &lt;&lt; &quot;'&quot;;</a>
<a name="ln1759">							showErrorMessage(s, error);</a>
<a name="ln1760">						}</a>
<a name="ln1761">					}</a>
<a name="ln1762">				}</a>
<a name="ln1763">			}</a>
<a name="ln1764">		}</a>
<a name="ln1765">	}</a>
<a name="ln1766">}</a>
<a name="ln1767"> </a>
<a name="ln1768">void MediaRoutingView::_changeBackground(</a>
<a name="ln1769">	entry_ref *ref)</a>
<a name="ln1770">{</a>
<a name="ln1771">	D_METHOD((&quot;MediaRoutingView::_changeBackground()\n&quot;));</a>
<a name="ln1772"> </a>
<a name="ln1773">	status_t error;</a>
<a name="ln1774">	BBitmap *background = 0;</a>
<a name="ln1775">	BFile file(ref, B_READ_ONLY);</a>
<a name="ln1776">	error = file.InitCheck();</a>
<a name="ln1777">	if (!error)</a>
<a name="ln1778">	{</a>
<a name="ln1779">		BTranslatorRoster *roster = BTranslatorRoster::Default();</a>
<a name="ln1780">		BBitmapStream stream;</a>
<a name="ln1781">		error = roster-&gt;Translate(&amp;file, NULL, NULL, &amp;stream, B_TRANSLATOR_BITMAP);</a>
<a name="ln1782">		if (!error)</a>
<a name="ln1783">		{</a>
<a name="ln1784">			stream.DetachBitmap(&amp;background);</a>
<a name="ln1785">			setBackgroundBitmap(background);</a>
<a name="ln1786">			Invalidate();</a>
<a name="ln1787"> </a>
<a name="ln1788">			// [e.moon 1dec99] persistence, yay</a>
<a name="ln1789">			m_backgroundBitmapEntry.SetTo(ref);</a>
<a name="ln1790">		}</a>
<a name="ln1791">	}</a>
<a name="ln1792">	delete background;</a>
<a name="ln1793">}</a>
<a name="ln1794"> </a>
<a name="ln1795">void MediaRoutingView::_changeBackground(</a>
<a name="ln1796">	rgb_color color)</a>
<a name="ln1797">{</a>
<a name="ln1798">	D_METHOD((&quot;MediaRoutingView::_changeBackground()\n&quot;));</a>
<a name="ln1799">	setBackgroundColor(color);</a>
<a name="ln1800">	Invalidate();</a>
<a name="ln1801"> </a>
<a name="ln1802">	// [e.moon 1dec99] persistence, yay</a>
<a name="ln1803">	m_backgroundBitmapEntry.Unset();</a>
<a name="ln1804">}</a>
<a name="ln1805"> </a>
<a name="ln1806">void</a>
<a name="ln1807">MediaRoutingView::_adjustScrollBars()</a>
<a name="ln1808">{</a>
<a name="ln1809">	D_METHOD((&quot;MediaRoutingView::_adjustScrollBars()\n&quot;));</a>
<a name="ln1810"> </a>
<a name="ln1811">	BScrollBar *scrollBar;</a>
<a name="ln1812"> </a>
<a name="ln1813">	// adjust horizontal scroll bar</a>
<a name="ln1814">	scrollBar = ScrollBar(B_HORIZONTAL);</a>
<a name="ln1815">	if (scrollBar) {</a>
<a name="ln1816">		float bigStep = floor(MediaNodePanel::M_DEFAULT_WIDTH + M_CLEANUP_H_GAP);</a>
<a name="ln1817">		scrollBar-&gt;SetSteps(floor(bigStep / 10.0), bigStep);</a>
<a name="ln1818">	}</a>
<a name="ln1819"> </a>
<a name="ln1820">	// adjust vertical scroll bar</a>
<a name="ln1821">	scrollBar = ScrollBar(B_VERTICAL);</a>
<a name="ln1822">	if (scrollBar) {</a>
<a name="ln1823">		float bigStep = floor(MediaNodePanel::M_DEFAULT_HEIGHT + M_CLEANUP_V_GAP);</a>
<a name="ln1824">		scrollBar-&gt;SetSteps(floor(bigStep / 10.0), bigStep);</a>
<a name="ln1825">	}</a>
<a name="ln1826">}</a>
<a name="ln1827"> </a>
<a name="ln1828">void</a>
<a name="ln1829">MediaRoutingView::_broadcastSelection() const</a>
<a name="ln1830">{</a>
<a name="ln1831">	int32 selectedGroup = 0;</a>
<a name="ln1832"> </a>
<a name="ln1833">	if (SelectedType() == DiagramItem::M_BOX) {</a>
<a name="ln1834">		// iterate thru the list of selected node panels and make the</a>
<a name="ln1835">		// first group we find the selected group</a>
<a name="ln1836">		for (uint32 i = 0; i &lt; CountSelectedItems(); i++) {</a>
<a name="ln1837">			MediaNodePanel *panel = dynamic_cast&lt;MediaNodePanel *&gt;(SelectedItemAt(i));</a>
<a name="ln1838">			if (panel &amp;&amp; panel-&gt;ref-&gt;group()) {</a>
<a name="ln1839">				selectedGroup = panel-&gt;ref-&gt;group()-&gt;id();</a>
<a name="ln1840">				BMessenger messenger(Window());</a>
<a name="ln1841">				BMessage groupMsg(M_GROUP_SELECTED);</a>
<a name="ln1842">				groupMsg.AddInt32(&quot;groupID&quot;, selectedGroup);</a>
<a name="ln1843">				messenger.SendMessage(&amp;groupMsg);</a>
<a name="ln1844">				return;</a>
<a name="ln1845">			}</a>
<a name="ln1846">		}</a>
<a name="ln1847">	}</a>
<a name="ln1848"> </a>
<a name="ln1849">	// currently no group is selected</a>
<a name="ln1850">	BMessenger messenger(Window());</a>
<a name="ln1851">	BMessage groupMsg(M_GROUP_SELECTED);</a>
<a name="ln1852">	groupMsg.AddInt32(&quot;groupID&quot;, selectedGroup);</a>
<a name="ln1853">	messenger.SendMessage(&amp;groupMsg);</a>
<a name="ln1854">}</a>
<a name="ln1855"> </a>
<a name="ln1856">status_t</a>
<a name="ln1857">MediaRoutingView::_fetchInactiveNodeState(MediaNodePanel *forPanel, BMessage *outMessage)</a>
<a name="ln1858">{</a>
<a name="ln1859">	// copy inactive node state info</a>
<a name="ln1860">	int32 c = m_inactiveNodeState.CountItems();</a>
<a name="ln1861">	for(int32 n = 0; n &lt; c; n++) {</a>
<a name="ln1862">		_inactive_node_state_entry* e = reinterpret_cast&lt;_inactive_node_state_entry*&gt;(</a>
<a name="ln1863">			m_inactiveNodeState.ItemAt(n));</a>
<a name="ln1864">		ASSERT(e);</a>
<a name="ln1865">		if(e-&gt;name != forPanel-&gt;ref-&gt;name())</a>
<a name="ln1866">			continue;</a>
<a name="ln1867"> </a>
<a name="ln1868">		if(e-&gt;kind != forPanel-&gt;ref-&gt;kind())</a>
<a name="ln1869">			continue;</a>
<a name="ln1870"> </a>
<a name="ln1871">		// found match; extract message &amp; remove entry</a>
<a name="ln1872">		*outMessage = e-&gt;state;</a>
<a name="ln1873">		m_inactiveNodeState.RemoveItem(n);</a>
<a name="ln1874">		return B_OK;</a>
<a name="ln1875">	}</a>
<a name="ln1876"> </a>
<a name="ln1877">	return B_BAD_VALUE;</a>
<a name="ln1878">}</a>
<a name="ln1879"> </a>
<a name="ln1880">void</a>
<a name="ln1881">MediaRoutingView::_emptyInactiveNodeState()</a>
<a name="ln1882">{</a>
<a name="ln1883">	int32 c = m_inactiveNodeState.CountItems();</a>
<a name="ln1884">	for(int32 n = 0; n &lt; c; n++) {</a>
<a name="ln1885">		_inactive_node_state_entry* e = reinterpret_cast&lt;_inactive_node_state_entry*&gt;(</a>
<a name="ln1886">			m_inactiveNodeState.ItemAt(n));</a>
<a name="ln1887">		ASSERT(e);</a>
<a name="ln1888">		delete e;</a>
<a name="ln1889">	}</a>
<a name="ln1890">	m_inactiveNodeState.MakeEmpty();</a>
<a name="ln1891">}</a>
<a name="ln1892"> </a>
<a name="ln1893"> </a>
<a name="ln1894">// END -- MediaRoutingView.cpp --</a>

</code></pre>
<div class="balloon" rel="995"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="971"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'menu' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
