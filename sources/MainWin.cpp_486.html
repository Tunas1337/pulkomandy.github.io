
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>MainWin.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * MainWin.cpp - Media Player for the Haiku Operating System</a>
<a name="ln3"> *</a>
<a name="ln4"> * Copyright (C) 2006 Marcus Overhagen &lt;marcus@overhagen.de&gt;</a>
<a name="ln5"> * Copyright (C) 2007-2010 Stephan Aßmus &lt;superstippi@gmx.de&gt; (GPL-&gt;MIT ok)</a>
<a name="ln6"> * Copyright (C) 2007-2009 Fredrik Modéen &lt;[FirstName]@[LastName].se&gt; (MIT ok)</a>
<a name="ln7"> *</a>
<a name="ln8"> * Released under the terms of the MIT license.</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;MainWin.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;math.h&gt;</a>
<a name="ln15">#include &lt;stdio.h&gt;</a>
<a name="ln16">#include &lt;string.h&gt;</a>
<a name="ln17"> </a>
<a name="ln18">#include &lt;Alert.h&gt;</a>
<a name="ln19">#include &lt;Application.h&gt;</a>
<a name="ln20">#include &lt;Autolock.h&gt;</a>
<a name="ln21">#include &lt;Catalog.h&gt;</a>
<a name="ln22">#include &lt;Debug.h&gt;</a>
<a name="ln23">#include &lt;fs_attr.h&gt;</a>
<a name="ln24">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln25">#include &lt;Language.h&gt;</a>
<a name="ln26">#include &lt;Locale.h&gt;</a>
<a name="ln27">#include &lt;MediaRoster.h&gt;</a>
<a name="ln28">#include &lt;Menu.h&gt;</a>
<a name="ln29">#include &lt;MenuBar.h&gt;</a>
<a name="ln30">#include &lt;MenuItem.h&gt;</a>
<a name="ln31">#include &lt;MessageRunner.h&gt;</a>
<a name="ln32">#include &lt;Messenger.h&gt;</a>
<a name="ln33">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln34">#include &lt;PropertyInfo.h&gt;</a>
<a name="ln35">#include &lt;RecentItems.h&gt;</a>
<a name="ln36">#include &lt;Roster.h&gt;</a>
<a name="ln37">#include &lt;Screen.h&gt;</a>
<a name="ln38">#include &lt;String.h&gt;</a>
<a name="ln39">#include &lt;TypeConstants.h&gt;</a>
<a name="ln40">#include &lt;View.h&gt;</a>
<a name="ln41"> </a>
<a name="ln42">#include &quot;AudioProducer.h&quot;</a>
<a name="ln43">#include &quot;ControllerObserver.h&quot;</a>
<a name="ln44">#include &quot;DurationToString.h&quot;</a>
<a name="ln45">#include &quot;FilePlaylistItem.h&quot;</a>
<a name="ln46">#include &quot;MainApp.h&quot;</a>
<a name="ln47">#include &quot;NetworkStreamWin.h&quot;</a>
<a name="ln48">#include &quot;PeakView.h&quot;</a>
<a name="ln49">#include &quot;PlaylistItem.h&quot;</a>
<a name="ln50">#include &quot;PlaylistObserver.h&quot;</a>
<a name="ln51">#include &quot;PlaylistWindow.h&quot;</a>
<a name="ln52">#include &quot;Settings.h&quot;</a>
<a name="ln53"> </a>
<a name="ln54"> </a>
<a name="ln55">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln56">#define B_TRANSLATION_CONTEXT &quot;MediaPlayer-Main&quot;</a>
<a name="ln57">#define MIN_WIDTH 250</a>
<a name="ln58"> </a>
<a name="ln59"> </a>
<a name="ln60">int MainWin::sNoVideoWidth = MIN_WIDTH;</a>
<a name="ln61"> </a>
<a name="ln62"> </a>
<a name="ln63">// XXX TODO: why is lround not defined?</a>
<a name="ln64">#define lround(a) ((int)(0.99999 + (a)))</a>
<a name="ln65"> </a>
<a name="ln66">enum {</a>
<a name="ln67">	M_DUMMY = 0x100,</a>
<a name="ln68">	M_FILE_OPEN = 0x1000,</a>
<a name="ln69">	M_NETWORK_STREAM_OPEN,</a>
<a name="ln70">	M_FILE_INFO,</a>
<a name="ln71">	M_FILE_PLAYLIST,</a>
<a name="ln72">	M_FILE_CLOSE,</a>
<a name="ln73">	M_FILE_QUIT,</a>
<a name="ln74">	M_VIEW_SIZE,</a>
<a name="ln75">	M_TOGGLE_FULLSCREEN,</a>
<a name="ln76">	M_TOGGLE_ALWAYS_ON_TOP,</a>
<a name="ln77">	M_TOGGLE_NO_INTERFACE,</a>
<a name="ln78">	M_VOLUME_UP,</a>
<a name="ln79">	M_VOLUME_DOWN,</a>
<a name="ln80">	M_SKIP_NEXT,</a>
<a name="ln81">	M_SKIP_PREV,</a>
<a name="ln82">	M_WIND,</a>
<a name="ln83"> </a>
<a name="ln84">	// The common display aspect ratios</a>
<a name="ln85">	M_ASPECT_SAME_AS_SOURCE,</a>
<a name="ln86">	M_ASPECT_NO_DISTORTION,</a>
<a name="ln87">	M_ASPECT_4_3,</a>
<a name="ln88">	M_ASPECT_16_9,</a>
<a name="ln89">	M_ASPECT_83_50,</a>
<a name="ln90">	M_ASPECT_7_4,</a>
<a name="ln91">	M_ASPECT_37_20,</a>
<a name="ln92">	M_ASPECT_47_20,</a>
<a name="ln93"> </a>
<a name="ln94">	M_SELECT_AUDIO_TRACK			= 0x00000800,</a>
<a name="ln95">	M_SELECT_AUDIO_TRACK_END		= 0x00000fff,</a>
<a name="ln96">	M_SELECT_VIDEO_TRACK			= 0x00010000,</a>
<a name="ln97">	M_SELECT_VIDEO_TRACK_END		= 0x00010fff,</a>
<a name="ln98">	M_SELECT_SUB_TITLE_TRACK		= 0x00020000,</a>
<a name="ln99">	M_SELECT_SUB_TITLE_TRACK_END	= 0x00020fff,</a>
<a name="ln100"> </a>
<a name="ln101">	M_SET_RATING,</a>
<a name="ln102"> </a>
<a name="ln103">	M_SET_PLAYLIST_POSITION,</a>
<a name="ln104"> </a>
<a name="ln105">	M_FILE_DELETE,</a>
<a name="ln106"> </a>
<a name="ln107">	M_SLIDE_CONTROLS,</a>
<a name="ln108">	M_FINISH_SLIDING_CONTROLS</a>
<a name="ln109">};</a>
<a name="ln110"> </a>
<a name="ln111"> </a>
<a name="ln112">static property_info sPropertyInfo[] = {</a>
<a name="ln113">	{ &quot;Next&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln114">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln115">		&quot;Skip to the next track.&quot;, 0</a>
<a name="ln116">	},</a>
<a name="ln117">	{ &quot;Prev&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln118">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln119">		&quot;Skip to the previous track.&quot;, 0</a>
<a name="ln120">	},</a>
<a name="ln121">	{ &quot;Play&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln122">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln123">		&quot;Start playing.&quot;, 0</a>
<a name="ln124">	},</a>
<a name="ln125">	{ &quot;Stop&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln126">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln127">		&quot;Stop playing.&quot;, 0</a>
<a name="ln128">	},</a>
<a name="ln129">	{ &quot;Pause&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln130">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln131">		&quot;Pause playback.&quot;, 0</a>
<a name="ln132">	},</a>
<a name="ln133">	{ &quot;TogglePlaying&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln134">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln135">		&quot;Toggle pause/play.&quot;, 0</a>
<a name="ln136">	},</a>
<a name="ln137">	{ &quot;Mute&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln138">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln139">		&quot;Toggle mute.&quot;, 0</a>
<a name="ln140">	},</a>
<a name="ln141">	{ &quot;Volume&quot;, { B_GET_PROPERTY, B_SET_PROPERTY, 0 },</a>
<a name="ln142">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln143">		&quot;Gets/sets the volume (0.0-2.0).&quot;, 0,</a>
<a name="ln144">		{ B_FLOAT_TYPE }</a>
<a name="ln145">	},</a>
<a name="ln146">	{ &quot;URI&quot;, { B_GET_PROPERTY, 0 },</a>
<a name="ln147">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln148">		&quot;Gets the URI of the currently playing item.&quot;, 0,</a>
<a name="ln149">		{ B_STRING_TYPE }</a>
<a name="ln150">	},</a>
<a name="ln151">	{ &quot;ToggleFullscreen&quot;, { B_EXECUTE_PROPERTY },</a>
<a name="ln152">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln153">		&quot;Toggle fullscreen.&quot;, 0</a>
<a name="ln154">	},</a>
<a name="ln155">	{ &quot;Duration&quot;, { B_GET_PROPERTY, 0 },</a>
<a name="ln156">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln157">		&quot;Gets the duration of the currently playing item &quot;</a>
<a name="ln158">			&quot;in microseconds.&quot;, 0,</a>
<a name="ln159">		{ B_INT64_TYPE }</a>
<a name="ln160">	},</a>
<a name="ln161">	{ &quot;Position&quot;, { B_GET_PROPERTY, B_SET_PROPERTY, 0 },</a>
<a name="ln162">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln163">		&quot;Gets/sets the current playing position in microseconds.&quot;,</a>
<a name="ln164">		0, { B_INT64_TYPE }</a>
<a name="ln165">	},</a>
<a name="ln166">	{ &quot;Seek&quot;, { B_SET_PROPERTY },</a>
<a name="ln167">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln168">		&quot;Seek by the specified amounts of microseconds.&quot;, 0,</a>
<a name="ln169">		{ B_INT64_TYPE }</a>
<a name="ln170">	},</a>
<a name="ln171">	{ &quot;PlaylistTrackCount&quot;, { B_GET_PROPERTY, 0 },</a>
<a name="ln172">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln173">		&quot;Gets the number of tracks in Playlist.&quot;, 0,</a>
<a name="ln174">		{ B_INT16_TYPE }</a>
<a name="ln175">	},</a>
<a name="ln176">	{ &quot;PlaylistTrackTitle&quot;, { B_GET_PROPERTY, 0 },</a>
<a name="ln177">		{ B_INDEX_SPECIFIER, 0 },</a>
<a name="ln178">		&quot;Gets the title of the nth track in Playlist.&quot;, 0,</a>
<a name="ln179">		{ B_STRING_TYPE }</a>
<a name="ln180">	},</a>
<a name="ln181"> </a>
<a name="ln182">	{ 0 }</a>
<a name="ln183">};</a>
<a name="ln184"> </a>
<a name="ln185"> </a>
<a name="ln186">static const char* kRatingAttrName = &quot;Media:Rating&quot;;</a>
<a name="ln187"> </a>
<a name="ln188">static const char* kDisabledSeekMessage = B_TRANSLATE(&quot;Drop files to play&quot;);</a>
<a name="ln189"> </a>
<a name="ln190">static const char* kApplicationName = B_TRANSLATE_SYSTEM_NAME(NAME);</a>
<a name="ln191"> </a>
<a name="ln192"> </a>
<a name="ln193">MainWin::MainWin(bool isFirstWindow, BMessage* message)</a>
<a name="ln194">	:</a>
<a name="ln195">	BWindow(BRect(100, 100, 400, 300), kApplicationName, B_TITLED_WINDOW,</a>
<a name="ln196"> 		B_ASYNCHRONOUS_CONTROLS),</a>
<a name="ln197"> 	fCreationTime(system_time()),</a>
<a name="ln198">	fInfoWin(NULL),</a>
<a name="ln199">	fPlaylistWindow(NULL),</a>
<a name="ln200">	fHasFile(false),</a>
<a name="ln201">	fHasVideo(false),</a>
<a name="ln202">	fHasAudio(false),</a>
<a name="ln203">	fPlaylist(new Playlist),</a>
<a name="ln204">	fPlaylistObserver(new PlaylistObserver(this)),</a>
<a name="ln205">	fController(new Controller),</a>
<a name="ln206">	fControllerObserver(new ControllerObserver(this,</a>
<a name="ln207">		OBSERVE_FILE_CHANGES | OBSERVE_TRACK_CHANGES</a>
<a name="ln208">			| OBSERVE_PLAYBACK_STATE_CHANGES | OBSERVE_POSITION_CHANGES</a>
<a name="ln209">			| OBSERVE_VOLUME_CHANGES)),</a>
<a name="ln210">	fIsFullscreen(false),</a>
<a name="ln211">	fAlwaysOnTop(false),</a>
<a name="ln212">	fNoInterface(false),</a>
<a name="ln213">	fShowsFullscreenControls(false),</a>
<a name="ln214">	fSourceWidth(-1),</a>
<a name="ln215">	fSourceHeight(-1),</a>
<a name="ln216">	fWidthAspect(0),</a>
<a name="ln217">	fHeightAspect(0),</a>
<a name="ln218">	fSavedFrame(),</a>
<a name="ln219">	fNoVideoFrame(),</a>
<a name="ln220"> </a>
<a name="ln221">	fMouseDownTracking(false),</a>
<a name="ln222">	fLastMousePos(0, 0),</a>
<a name="ln223">	fLastMouseMovedTime(system_time()),</a>
<a name="ln224">	fMouseMoveDist(0),</a>
<a name="ln225"> </a>
<a name="ln226">	fGlobalSettingsListener(this),</a>
<a name="ln227">	fInitialSeekPosition(0),</a>
<a name="ln228">	fAllowWinding(true)</a>
<a name="ln229">{</a>
<a name="ln230">	// Handle window position and size depending on whether this is the</a>
<a name="ln231">	// first window or not. Use the window size from the window that was</a>
<a name="ln232">	// last resized by the user.</a>
<a name="ln233">	static int pos = 0;</a>
<a name="ln234">	MoveBy(pos * 25, pos * 25);</a>
<a name="ln235">	pos = (pos + 1) % 15;</a>
<a name="ln236"> </a>
<a name="ln237">	BRect frame = Settings::Default()-&gt;AudioPlayerWindowFrame();</a>
<a name="ln238">	if (frame.IsValid()) {</a>
<a name="ln239">		if (isFirstWindow) {</a>
<a name="ln240">			if (message == NULL) {</a>
<a name="ln241">				MoveTo(frame.LeftTop());</a>
<a name="ln242">				ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln243">			} else {</a>
<a name="ln244">				// Delay moving to the initial position, since we don't</a>
<a name="ln245">				// know if we will be playing audio at all.</a>
<a name="ln246">				message-&gt;AddRect(&quot;window frame&quot;, frame);</a>
<a name="ln247">			}</a>
<a name="ln248">		}</a>
<a name="ln249">		if (sNoVideoWidth == MIN_WIDTH)</a>
<a name="ln250">			sNoVideoWidth = frame.IntegerWidth();</a>
<a name="ln251">	} else if (sNoVideoWidth &gt; MIN_WIDTH) {</a>
<a name="ln252">		ResizeTo(sNoVideoWidth, Bounds().Height());</a>
<a name="ln253">	}</a>
<a name="ln254">	fNoVideoWidth = sNoVideoWidth;</a>
<a name="ln255"> </a>
<a name="ln256">	BRect rect = Bounds();</a>
<a name="ln257"> </a>
<a name="ln258">	// background</a>
<a name="ln259">	fBackground = new BView(rect, &quot;background&quot;, B_FOLLOW_ALL,</a>
<a name="ln260">		B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE);</a>
<a name="ln261">	fBackground-&gt;SetViewColor(0, 0, 0);</a>
<a name="ln262">	AddChild(fBackground);</a>
<a name="ln263"> </a>
<a name="ln264">	// menu</a>
<a name="ln265">	fMenuBar = new BMenuBar(fBackground-&gt;Bounds(), &quot;menu&quot;);</a>
<a name="ln266">	_CreateMenu();</a>
<a name="ln267">	fBackground-&gt;AddChild(fMenuBar);</a>
<a name="ln268">	fMenuBar-&gt;SetResizingMode(B_FOLLOW_NONE);</a>
<a name="ln269">	fMenuBar-&gt;ResizeToPreferred();</a>
<a name="ln270">	fMenuBarWidth = (int)fMenuBar-&gt;Frame().Width() + 1;</a>
<a name="ln271">	fMenuBarHeight = (int)fMenuBar-&gt;Frame().Height() + 1;</a>
<a name="ln272"> </a>
<a name="ln273">	// video view</a>
<a name="ln274">	rect = BRect(0, fMenuBarHeight, fBackground-&gt;Bounds().right,</a>
<a name="ln275">		fMenuBarHeight + 10);</a>
<a name="ln276">	fVideoView = new VideoView(rect, &quot;video display&quot;, B_FOLLOW_NONE);</a>
<a name="ln277">	fBackground-&gt;AddChild(fVideoView);</a>
<a name="ln278"> </a>
<a name="ln279">	// controls</a>
<a name="ln280">	rect = BRect(0, fMenuBarHeight + 11, fBackground-&gt;Bounds().right,</a>
<a name="ln281">		fBackground-&gt;Bounds().bottom);</a>
<a name="ln282">	fControls = new ControllerView(rect, fController, fPlaylist);</a>
<a name="ln283">	fBackground-&gt;AddChild(fControls);</a>
<a name="ln284">	fControls-&gt;ResizeToPreferred();</a>
<a name="ln285">	fControlsHeight = (int)fControls-&gt;Frame().Height() + 1;</a>
<a name="ln286">	fControlsWidth = (int)fControls-&gt;Frame().Width() + 1;</a>
<a name="ln287">	fControls-&gt;SetResizingMode(B_FOLLOW_BOTTOM | B_FOLLOW_LEFT_RIGHT);</a>
<a name="ln288">	fControls-&gt;SetDisabledString(kDisabledSeekMessage);</a>
<a name="ln289"> </a>
<a name="ln290">	fPlaylist-&gt;AddListener(fPlaylistObserver);</a>
<a name="ln291">	fController-&gt;SetVideoView(fVideoView);</a>
<a name="ln292">	fController-&gt;AddListener(fControllerObserver);</a>
<a name="ln293">	PeakView* peakView = fControls-&gt;GetPeakView();</a>
<a name="ln294">	peakView-&gt;SetPeakNotificationWhat(MSG_PEAK_NOTIFICATION);</a>
<a name="ln295">	fController-&gt;SetPeakListener(peakView);</a>
<a name="ln296"> </a>
<a name="ln297">	_SetupWindow();</a>
<a name="ln298"> </a>
<a name="ln299">	// setup the playlist window now, we need to have it</a>
<a name="ln300">	// running for the undo/redo playlist editing</a>
<a name="ln301">	fPlaylistWindow = new PlaylistWindow(BRect(150, 150, 500, 600), fPlaylist,</a>
<a name="ln302">		fController);</a>
<a name="ln303">	fPlaylistWindow-&gt;Hide();</a>
<a name="ln304">	fPlaylistWindow-&gt;Show();</a>
<a name="ln305">		// this makes sure the window thread is running without</a>
<a name="ln306">		// showing the window just yet</a>
<a name="ln307"> </a>
<a name="ln308">	Settings::Default()-&gt;AddListener(&amp;fGlobalSettingsListener);</a>
<a name="ln309">	_AdoptGlobalSettings();</a>
<a name="ln310"> </a>
<a name="ln311">	AddShortcut('z', B_COMMAND_KEY, new BMessage(B_UNDO));</a>
<a name="ln312">	AddShortcut('y', B_COMMAND_KEY, new BMessage(B_UNDO));</a>
<a name="ln313">	AddShortcut('z', B_COMMAND_KEY | B_SHIFT_KEY, new BMessage(B_REDO));</a>
<a name="ln314">	AddShortcut('y', B_COMMAND_KEY | B_SHIFT_KEY, new BMessage(B_REDO));</a>
<a name="ln315"> </a>
<a name="ln316">	Hide();</a>
<a name="ln317">	Show();</a>
<a name="ln318"> </a>
<a name="ln319">	if (message != NULL)</a>
<a name="ln320">		PostMessage(message);</a>
<a name="ln321"> </a>
<a name="ln322">	BMediaRoster* roster = BMediaRoster::Roster();</a>
<a name="ln323">	roster-&gt;StartWatching(BMessenger(this, this), B_MEDIA_SERVER_STARTED);</a>
<a name="ln324">	roster-&gt;StartWatching(BMessenger(this, this),  B_MEDIA_SERVER_QUIT);</a>
<a name="ln325">}</a>
<a name="ln326"> </a>
<a name="ln327"> </a>
<a name="ln328">MainWin::~MainWin()</a>
<a name="ln329">{</a>
<a name="ln330">//	printf(&quot;MainWin::~MainWin\n&quot;);</a>
<a name="ln331"> </a>
<a name="ln332">	BMediaRoster* roster = BMediaRoster::CurrentRoster();</a>
<a name="ln333">	roster-&gt;StopWatching(BMessenger(this, this), B_MEDIA_SERVER_STARTED);</a>
<a name="ln334">	roster-&gt;StopWatching(BMessenger(this, this), B_MEDIA_SERVER_QUIT);</a>
<a name="ln335"> </a>
<a name="ln336">	Settings::Default()-&gt;RemoveListener(&amp;fGlobalSettingsListener);</a>
<a name="ln337">	fPlaylist-&gt;RemoveListener(fPlaylistObserver);</a>
<a name="ln338">	fController-&gt;Lock();</a>
<a name="ln339">	fController-&gt;RemoveListener(fControllerObserver);</a>
<a name="ln340">	fController-&gt;SetPeakListener(NULL);</a>
<a name="ln341">	fController-&gt;SetVideoTarget(NULL);</a>
<a name="ln342">	fController-&gt;Unlock();</a>
<a name="ln343"> </a>
<a name="ln344">	// give the views a chance to detach from any notifiers</a>
<a name="ln345">	// before we delete them</a>
<a name="ln346">	fBackground-&gt;RemoveSelf();</a>
<a name="ln347">	delete fBackground;</a>
<a name="ln348"> </a>
<a name="ln349">	if (fInfoWin &amp;&amp; fInfoWin-&gt;Lock())</a>
<a name="ln350">		fInfoWin-&gt;Quit();</a>
<a name="ln351"> </a>
<a name="ln352">	if (fPlaylistWindow &amp;&amp; fPlaylistWindow-&gt;Lock())</a>
<a name="ln353">		fPlaylistWindow-&gt;Quit();</a>
<a name="ln354"> </a>
<a name="ln355">	delete fPlaylist;</a>
<a name="ln356">	fPlaylist = NULL;</a>
<a name="ln357"> </a>
<a name="ln358">	// quit the Controller looper thread</a>
<a name="ln359">	thread_id controllerThread = fController-&gt;Thread();</a>
<a name="ln360">	fController-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln361">	status_t exitValue;</a>
<a name="ln362">	wait_for_thread(controllerThread, &amp;exitValue);</a>
<a name="ln363">}</a>
<a name="ln364"> </a>
<a name="ln365"> </a>
<a name="ln366">// #pragma mark -</a>
<a name="ln367"> </a>
<a name="ln368"> </a>
<a name="ln369">void</a>
<a name="ln370">MainWin::FrameResized(float newWidth, float newHeight)</a>
<a name="ln371">{</a>
<a name="ln372">	if (newWidth != Bounds().Width() || newHeight != Bounds().Height()) {</a>
<a name="ln373">		debugger(&quot;size wrong\n&quot;);</a>
<a name="ln374">	}</a>
<a name="ln375"> </a>
<a name="ln376">	bool noMenu = fNoInterface || fIsFullscreen;</a>
<a name="ln377">	bool noControls = fNoInterface || fIsFullscreen;</a>
<a name="ln378"> </a>
<a name="ln379">//	printf(&quot;FrameResized enter: newWidth %.0f, newHeight %.0f\n&quot;,</a>
<a name="ln380">//		newWidth, newHeight);</a>
<a name="ln381"> </a>
<a name="ln382">	if (!fHasVideo)</a>
<a name="ln383">		sNoVideoWidth = fNoVideoWidth = (int)newWidth;</a>
<a name="ln384"> </a>
<a name="ln385">	int maxVideoWidth  = int(newWidth) + 1;</a>
<a name="ln386">	int maxVideoHeight = int(newHeight) + 1</a>
<a name="ln387">		- (noMenu  ? 0 : fMenuBarHeight)</a>
<a name="ln388">		- (noControls ? 0 : fControlsHeight);</a>
<a name="ln389"> </a>
<a name="ln390">	ASSERT(maxVideoHeight &gt;= 0);</a>
<a name="ln391"> </a>
<a name="ln392">	int y = 0;</a>
<a name="ln393"> </a>
<a name="ln394">	if (noMenu) {</a>
<a name="ln395">		if (!fMenuBar-&gt;IsHidden(fMenuBar))</a>
<a name="ln396">			fMenuBar-&gt;Hide();</a>
<a name="ln397">	} else {</a>
<a name="ln398">		fMenuBar-&gt;MoveTo(0, y);</a>
<a name="ln399">		fMenuBar-&gt;ResizeTo(newWidth, fMenuBarHeight - 1);</a>
<a name="ln400">		if (fMenuBar-&gt;IsHidden(fMenuBar))</a>
<a name="ln401">			fMenuBar-&gt;Show();</a>
<a name="ln402">		y += fMenuBarHeight;</a>
<a name="ln403">	}</a>
<a name="ln404"> </a>
<a name="ln405">	if (maxVideoHeight == 0) {</a>
<a name="ln406">		if (!fVideoView-&gt;IsHidden(fVideoView))</a>
<a name="ln407">			fVideoView-&gt;Hide();</a>
<a name="ln408">	} else {</a>
<a name="ln409">		_ResizeVideoView(0, y, maxVideoWidth, maxVideoHeight);</a>
<a name="ln410">		if (fVideoView-&gt;IsHidden(fVideoView))</a>
<a name="ln411">			fVideoView-&gt;Show();</a>
<a name="ln412">		y += maxVideoHeight;</a>
<a name="ln413">	}</a>
<a name="ln414"> </a>
<a name="ln415">	if (noControls) {</a>
<a name="ln416">		if (!fControls-&gt;IsHidden(fControls))</a>
<a name="ln417">			fControls-&gt;Hide();</a>
<a name="ln418">	} else {</a>
<a name="ln419">		fControls-&gt;MoveTo(0, y);</a>
<a name="ln420">		fControls-&gt;ResizeTo(newWidth, fControlsHeight - 1);</a>
<a name="ln421">		if (fControls-&gt;IsHidden(fControls))</a>
<a name="ln422">			fControls-&gt;Show();</a>
<a name="ln423">//		y += fControlsHeight;</a>
<a name="ln424">	}</a>
<a name="ln425"> </a>
<a name="ln426">//	printf(&quot;FrameResized leave\n&quot;);</a>
<a name="ln427">}</a>
<a name="ln428"> </a>
<a name="ln429"> </a>
<a name="ln430">void</a>
<a name="ln431">MainWin::Zoom(BPoint /*position*/, float /*width*/, float /*height*/)</a>
<a name="ln432">{</a>
<a name="ln433">	PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln434">}</a>
<a name="ln435"> </a>
<a name="ln436"> </a>
<a name="ln437">void</a>
<a name="ln438">MainWin::DispatchMessage(BMessage* msg, BHandler* handler)</a>
<a name="ln439">{</a>
<a name="ln440">	if ((msg-&gt;what == B_MOUSE_DOWN)</a>
<a name="ln441">		&amp;&amp; (handler == fBackground || handler == fVideoView</a>
<a name="ln442">			|| handler == fControls)) {</a>
<a name="ln443">		_MouseDown(msg, dynamic_cast&lt;BView*&gt;(handler));</a>
<a name="ln444">	}</a>
<a name="ln445"> </a>
<a name="ln446">	if ((msg-&gt;what == B_MOUSE_MOVED)</a>
<a name="ln447">		&amp;&amp; (handler == fBackground || handler == fVideoView</a>
<a name="ln448">			|| handler == fControls)) {</a>
<a name="ln449">		_MouseMoved(msg, dynamic_cast&lt;BView*&gt;(handler));</a>
<a name="ln450">	}</a>
<a name="ln451"> </a>
<a name="ln452">	if ((msg-&gt;what == B_MOUSE_UP)</a>
<a name="ln453">		&amp;&amp; (handler == fBackground || handler == fVideoView)) {</a>
<a name="ln454">		_MouseUp(msg);</a>
<a name="ln455">	}</a>
<a name="ln456"> </a>
<a name="ln457">	if ((msg-&gt;what == B_KEY_DOWN)</a>
<a name="ln458">		&amp;&amp; (handler == fBackground || handler == fVideoView)) {</a>
<a name="ln459">		// special case for PrintScreen key</a>
<a name="ln460">		if (msg-&gt;FindInt32(&quot;key&quot;) == B_PRINT_KEY) {</a>
<a name="ln461">			fVideoView-&gt;OverlayScreenshotPrepare();</a>
<a name="ln462">			BWindow::DispatchMessage(msg, handler);</a>
<a name="ln463">			fVideoView-&gt;OverlayScreenshotCleanup();</a>
<a name="ln464">			return;</a>
<a name="ln465">		}</a>
<a name="ln466"> </a>
<a name="ln467">		// every other key gets dispatched to our _KeyDown first</a>
<a name="ln468">		if (_KeyDown(msg)) {</a>
<a name="ln469">			// it got handled, don't pass it on</a>
<a name="ln470">			return;</a>
<a name="ln471">		}</a>
<a name="ln472">	}</a>
<a name="ln473"> </a>
<a name="ln474">	BWindow::DispatchMessage(msg, handler);</a>
<a name="ln475">}</a>
<a name="ln476"> </a>
<a name="ln477"> </a>
<a name="ln478">void</a>
<a name="ln479">MainWin::MessageReceived(BMessage* msg)</a>
<a name="ln480">{</a>
<a name="ln481">//	msg-&gt;PrintToStream();</a>
<a name="ln482">	switch (msg-&gt;what) {</a>
<a name="ln483">		case B_EXECUTE_PROPERTY:</a>
<a name="ln484">		case B_GET_PROPERTY:</a>
<a name="ln485">		case B_SET_PROPERTY:</a>
<a name="ln486">		{</a>
<a name="ln487">			BMessage reply(B_REPLY);</a>
<a name="ln488">			status_t result = B_BAD_SCRIPT_SYNTAX;</a>
<a name="ln489">			int32 index;</a>
<a name="ln490">			BMessage specifier;</a>
<a name="ln491">			int32 what;</a>
<a name="ln492">			const char* property;</a>
<a name="ln493"> </a>
<a name="ln494">			if (msg-&gt;GetCurrentSpecifier(&amp;index, &amp;specifier, &amp;what,</a>
<a name="ln495">					&amp;property) != B_OK) {</a>
<a name="ln496">				return BWindow::MessageReceived(msg);</a>
<a name="ln497">			}</a>
<a name="ln498"> </a>
<a name="ln499">			BPropertyInfo propertyInfo(sPropertyInfo);</a>
<a name="ln500">			switch (propertyInfo.FindMatch(msg, index, &amp;specifier, what,</a>
<a name="ln501">					property)) {</a>
<a name="ln502">				case 0:</a>
<a name="ln503">					fControls-&gt;SkipForward();</a>
<a name="ln504">					result = B_OK;</a>
<a name="ln505">					break;</a>
<a name="ln506"> </a>
<a name="ln507">				case 1:</a>
<a name="ln508">					fControls-&gt;SkipBackward();</a>
<a name="ln509">					result = B_OK;</a>
<a name="ln510">					break;</a>
<a name="ln511"> </a>
<a name="ln512">				case 2:</a>
<a name="ln513">					fController-&gt;Play();</a>
<a name="ln514">					result = B_OK;</a>
<a name="ln515">					break;</a>
<a name="ln516"> </a>
<a name="ln517">				case 3:</a>
<a name="ln518">					fController-&gt;Stop();</a>
<a name="ln519">					result = B_OK;</a>
<a name="ln520">					break;</a>
<a name="ln521"> </a>
<a name="ln522">				case 4:</a>
<a name="ln523">					fController-&gt;Pause();</a>
<a name="ln524">					result = B_OK;</a>
<a name="ln525">					break;</a>
<a name="ln526"> </a>
<a name="ln527">				case 5:</a>
<a name="ln528">					fController-&gt;TogglePlaying();</a>
<a name="ln529">					result = B_OK;</a>
<a name="ln530">					break;</a>
<a name="ln531"> </a>
<a name="ln532">				case 6:</a>
<a name="ln533">					fController-&gt;ToggleMute();</a>
<a name="ln534">					result = B_OK;</a>
<a name="ln535">					break;</a>
<a name="ln536"> </a>
<a name="ln537">				case 7:</a>
<a name="ln538">				{</a>
<a name="ln539">					if (msg-&gt;what == B_GET_PROPERTY) {</a>
<a name="ln540">						result = reply.AddFloat(&quot;result&quot;,</a>
<a name="ln541">							fController-&gt;Volume());</a>
<a name="ln542">					} else if (msg-&gt;what == B_SET_PROPERTY) {</a>
<a name="ln543">						float newVolume;</a>
<a name="ln544">						result = msg-&gt;FindFloat(&quot;data&quot;, &amp;newVolume);</a>
<a name="ln545">						if (result == B_OK)</a>
<a name="ln546">							fController-&gt;SetVolume(newVolume);</a>
<a name="ln547">					}</a>
<a name="ln548">					break;</a>
<a name="ln549">				}</a>
<a name="ln550"> </a>
<a name="ln551">				case 8:</a>
<a name="ln552">				{</a>
<a name="ln553">					if (msg-&gt;what == B_GET_PROPERTY) {</a>
<a name="ln554">						BAutolock _(fPlaylist);</a>
<a name="ln555">						const PlaylistItem* item = fController-&gt;Item();</a>
<a name="ln556">						if (item == NULL) {</a>
<a name="ln557">							result = B_NO_INIT;</a>
<a name="ln558">							break;</a>
<a name="ln559">						}</a>
<a name="ln560"> </a>
<a name="ln561">						result = reply.AddString(&quot;result&quot;, item-&gt;LocationURI());</a>
<a name="ln562">					}</a>
<a name="ln563">					break;</a>
<a name="ln564">				}</a>
<a name="ln565"> </a>
<a name="ln566">				case 9:</a>
<a name="ln567">					PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln568">					break;</a>
<a name="ln569"> </a>
<a name="ln570">				case 10:</a>
<a name="ln571">					if (msg-&gt;what != B_GET_PROPERTY)</a>
<a name="ln572">						break;</a>
<a name="ln573"> </a>
<a name="ln574">					result = reply.AddInt64(&quot;result&quot;,</a>
<a name="ln575">						fController-&gt;TimeDuration());</a>
<a name="ln576">					break;</a>
<a name="ln577"> </a>
<a name="ln578">				case 11:</a>
<a name="ln579">				{</a>
<a name="ln580">					if (msg-&gt;what == B_GET_PROPERTY) {</a>
<a name="ln581">						result = reply.AddInt64(&quot;result&quot;,</a>
<a name="ln582">							fController-&gt;TimePosition());</a>
<a name="ln583">					} else if (msg-&gt;what == B_SET_PROPERTY) {</a>
<a name="ln584">						int64 newTime;</a>
<a name="ln585">						result = msg-&gt;FindInt64(&quot;data&quot;, &amp;newTime);</a>
<a name="ln586">						if (result == B_OK)</a>
<a name="ln587">							fController-&gt;SetTimePosition(newTime);</a>
<a name="ln588">					}</a>
<a name="ln589"> </a>
<a name="ln590">					break;</a>
<a name="ln591">				}</a>
<a name="ln592"> </a>
<a name="ln593">				case 12:</a>
<a name="ln594">				{</a>
<a name="ln595">					if (msg-&gt;what != B_SET_PROPERTY)</a>
<a name="ln596">						break;</a>
<a name="ln597"> </a>
<a name="ln598">					bigtime_t seekBy;</a>
<a name="ln599">					result = msg-&gt;FindInt64(&quot;data&quot;, &amp;seekBy);</a>
<a name="ln600">					if (result != B_OK)</a>
<a name="ln601">						break;</a>
<a name="ln602"> </a>
<a name="ln603">					_Wind(seekBy, 0);</a>
<a name="ln604">					break;</a>
<a name="ln605">				}</a>
<a name="ln606"> </a>
<a name="ln607">				case 13:</a>
<a name="ln608">					result = reply.AddInt16(&quot;result&quot;, fPlaylist-&gt;CountItems());</a>
<a name="ln609">					break;</a>
<a name="ln610"> </a>
<a name="ln611">				case 14:</a>
<a name="ln612">				{</a>
<a name="ln613">					int32 i = specifier.GetInt32(&quot;index&quot;, 0);</a>
<a name="ln614">					if (i &gt;= fPlaylist-&gt;CountItems()) {</a>
<a name="ln615">						result = B_NO_INIT;</a>
<a name="ln616">						break;</a>
<a name="ln617">					}</a>
<a name="ln618"> </a>
<a name="ln619">					BAutolock _(fPlaylist);</a>
<a name="ln620">					const PlaylistItem* item = fPlaylist-&gt;ItemAt(i);</a>
<a name="ln621">					result = item == NULL ? B_NO_INIT</a>
<a name="ln622">						: reply.AddString(&quot;result&quot;, item-&gt;Title());</a>
<a name="ln623">					break;</a>
<a name="ln624">				}</a>
<a name="ln625"> </a>
<a name="ln626">				default:</a>
<a name="ln627">					return BWindow::MessageReceived(msg);</a>
<a name="ln628">			}</a>
<a name="ln629"> </a>
<a name="ln630">			if (result != B_OK) {</a>
<a name="ln631">				reply.what = B_MESSAGE_NOT_UNDERSTOOD;</a>
<a name="ln632">				reply.AddString(&quot;message&quot;, strerror(result));</a>
<a name="ln633">				reply.AddInt32(&quot;error&quot;, result);</a>
<a name="ln634">			}</a>
<a name="ln635"> </a>
<a name="ln636">			msg-&gt;SendReply(&amp;reply);</a>
<a name="ln637">			break;</a>
<a name="ln638">		}</a>
<a name="ln639"> </a>
<a name="ln640">		case B_REFS_RECEIVED:</a>
<a name="ln641">		case M_URL_RECEIVED:</a>
<a name="ln642">			_RefsReceived(msg);</a>
<a name="ln643">			break;</a>
<a name="ln644"> </a>
<a name="ln645">		case B_SIMPLE_DATA:</a>
<a name="ln646">			if (msg-&gt;HasRef(&quot;refs&quot;))</a>
<a name="ln647">				_RefsReceived(msg);</a>
<a name="ln648">			break;</a>
<a name="ln649">		case M_OPEN_PREVIOUS_PLAYLIST:</a>
<a name="ln650">			OpenPlaylist(msg);</a>
<a name="ln651">			break;</a>
<a name="ln652"> </a>
<a name="ln653">		case B_UNDO:</a>
<a name="ln654">		case B_REDO:</a>
<a name="ln655">			fPlaylistWindow-&gt;PostMessage(msg);</a>
<a name="ln656">			break;</a>
<a name="ln657"> </a>
<a name="ln658">		case B_MEDIA_SERVER_STARTED:</a>
<a name="ln659">		{</a>
<a name="ln660">			printf(&quot;TODO: implement B_MEDIA_SERVER_STARTED\n&quot;);</a>
<a name="ln661">//</a>
<a name="ln662">//			BAutolock _(fPlaylist);</a>
<a name="ln663">//			BMessage fakePlaylistMessage(MSG_PLAYLIST_CURRENT_ITEM_CHANGED);</a>
<a name="ln664">//			fakePlaylistMessage.AddInt32(&quot;index&quot;,</a>
<a name="ln665">//				fPlaylist-&gt;CurrentItemIndex());</a>
<a name="ln666">//			PostMessage(&amp;fakePlaylistMessage);</a>
<a name="ln667">			break;</a>
<a name="ln668">		}</a>
<a name="ln669"> </a>
<a name="ln670">		case B_MEDIA_SERVER_QUIT:</a>
<a name="ln671">			printf(&quot;TODO: implement B_MEDIA_SERVER_QUIT\n&quot;);</a>
<a name="ln672">//			if (fController-&gt;Lock()) {</a>
<a name="ln673">//				fController-&gt;CleanupNodes();</a>
<a name="ln674">//				fController-&gt;Unlock();</a>
<a name="ln675">//			}</a>
<a name="ln676">			break;</a>
<a name="ln677"> </a>
<a name="ln678">		// PlaylistObserver messages</a>
<a name="ln679">		case MSG_PLAYLIST_ITEM_ADDED:</a>
<a name="ln680">		{</a>
<a name="ln681">			PlaylistItem* item;</a>
<a name="ln682">			int32 index;</a>
<a name="ln683">			if (msg-&gt;FindPointer(&quot;item&quot;, (void**)&amp;item) == B_OK</a>
<a name="ln684">				&amp;&amp; msg-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK) {</a>
<a name="ln685">				_AddPlaylistItem(item, index);</a>
<a name="ln686">			}</a>
<a name="ln687">			break;</a>
<a name="ln688">		}</a>
<a name="ln689">		case MSG_PLAYLIST_ITEM_REMOVED:</a>
<a name="ln690">		{</a>
<a name="ln691">			int32 index;</a>
<a name="ln692">			if (msg-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK)</a>
<a name="ln693">				_RemovePlaylistItem(index);</a>
<a name="ln694">			break;</a>
<a name="ln695">		}</a>
<a name="ln696">		case MSG_PLAYLIST_CURRENT_ITEM_CHANGED:</a>
<a name="ln697">		{</a>
<a name="ln698">			BAutolock _(fPlaylist);</a>
<a name="ln699"> </a>
<a name="ln700">			int32 index;</a>
<a name="ln701">			// if false, the message was meant to only update the GUI</a>
<a name="ln702">			bool play;</a>
<a name="ln703">			if (msg-&gt;FindBool(&quot;play&quot;, &amp;play) &lt; B_OK || !play)</a>
<a name="ln704">				break;</a>
<a name="ln705">			if (msg-&gt;FindInt32(&quot;index&quot;, &amp;index) &lt; B_OK</a>
<a name="ln706">				|| index != fPlaylist-&gt;CurrentItemIndex())</a>
<a name="ln707">				break;</a>
<a name="ln708">			PlaylistItemRef item(fPlaylist-&gt;ItemAt(index));</a>
<a name="ln709">			if (item.Get() != NULL) {</a>
<a name="ln710">				printf(&quot;open playlist item: %s\n&quot;, item-&gt;Name().String());</a>
<a name="ln711">				OpenPlaylistItem(item);</a>
<a name="ln712">				_MarkPlaylistItem(index);</a>
<a name="ln713">			}</a>
<a name="ln714">			break;</a>
<a name="ln715">		}</a>
<a name="ln716">		case MSG_PLAYLIST_IMPORT_FAILED:</a>
<a name="ln717">		{</a>
<a name="ln718">			BAlert* alert = new BAlert(B_TRANSLATE(&quot;Nothing to Play&quot;),</a>
<a name="ln719">				B_TRANSLATE(&quot;None of the files you wanted to play appear &quot;</a>
<a name="ln720">				&quot;to be media files.&quot;), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln721">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln722">			alert-&gt;Go();</a>
<a name="ln723">			fControls-&gt;SetDisabledString(kDisabledSeekMessage);</a>
<a name="ln724">			break;</a>
<a name="ln725">		}</a>
<a name="ln726"> </a>
<a name="ln727">		// ControllerObserver messages</a>
<a name="ln728">		case MSG_CONTROLLER_FILE_FINISHED:</a>
<a name="ln729">		{</a>
<a name="ln730">			BAutolock _(fPlaylist);</a>
<a name="ln731"> </a>
<a name="ln732">			//The file is finished. Open at start next time.</a>
<a name="ln733">			fController-&gt;SaveState(true);</a>
<a name="ln734"> </a>
<a name="ln735">			bool hadNext = fPlaylist-&gt;SetCurrentItemIndex(</a>
<a name="ln736">				fPlaylist-&gt;CurrentItemIndex() + 1);</a>
<a name="ln737">			if (!hadNext) {</a>
<a name="ln738">				// Reached end of playlist</a>
<a name="ln739">				// Handle &quot;quit when done&quot; settings</a>
<a name="ln740">				if ((fHasVideo &amp;&amp; fCloseWhenDonePlayingMovie)</a>
<a name="ln741">					|| (!fHasVideo &amp;&amp; fCloseWhenDonePlayingSound))</a>
<a name="ln742">					PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln743">				// Handle &quot;loop by default&quot; settings</a>
<a name="ln744">				if ((fHasVideo &amp;&amp; fLoopMovies)</a>
<a name="ln745">					|| (!fHasVideo &amp;&amp; fLoopSounds)) {</a>
<a name="ln746">					if (fPlaylist-&gt;CountItems() &gt; 1)</a>
<a name="ln747">						fPlaylist-&gt;SetCurrentItemIndex(0);</a>
<a name="ln748">					else</a>
<a name="ln749">						fController-&gt;Play();</a>
<a name="ln750">				}</a>
<a name="ln751">			}</a>
<a name="ln752">			break;</a>
<a name="ln753">		}</a>
<a name="ln754">		case MSG_CONTROLLER_FILE_CHANGED:</a>
<a name="ln755">		{</a>
<a name="ln756">			status_t result = B_ERROR;</a>
<a name="ln757">			msg-&gt;FindInt32(&quot;result&quot;, &amp;result);</a>
<a name="ln758">			PlaylistItemRef itemRef;</a>
<a name="ln759">			PlaylistItem* item;</a>
<a name="ln760">			if (msg-&gt;FindPointer(&quot;item&quot;, (void**)&amp;item) == B_OK) {</a>
<a name="ln761">				itemRef.SetTo(item, true);</a>
<a name="ln762">					// The reference was passed along with the message.</a>
<a name="ln763">			} else {</a>
<a name="ln764">				BAutolock _(fPlaylist);</a>
<a name="ln765">				itemRef.SetTo(fPlaylist-&gt;ItemAt(</a>
<a name="ln766">					fPlaylist-&gt;CurrentItemIndex()));</a>
<a name="ln767">			}</a>
<a name="ln768">			_PlaylistItemOpened(itemRef, result);</a>
<a name="ln769">			break;</a>
<a name="ln770">		}</a>
<a name="ln771">		case MSG_CONTROLLER_VIDEO_TRACK_CHANGED:</a>
<a name="ln772">		{</a>
<a name="ln773">			int32 index;</a>
<a name="ln774">			if (msg-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK) {</a>
<a name="ln775">				int32 i = 0;</a>
<a name="ln776">				while (BMenuItem* item = fVideoTrackMenu-&gt;ItemAt(i)) {</a>
<a name="ln777">					item-&gt;SetMarked(i == index);</a>
<a name="ln778">					i++;</a>
<a name="ln779">				}</a>
<a name="ln780">			}</a>
<a name="ln781">			break;</a>
<a name="ln782">		}</a>
<a name="ln783">		case MSG_CONTROLLER_AUDIO_TRACK_CHANGED:</a>
<a name="ln784">		{</a>
<a name="ln785">			int32 index;</a>
<a name="ln786">			if (msg-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK) {</a>
<a name="ln787">				int32 i = 0;</a>
<a name="ln788">				while (BMenuItem* item = fAudioTrackMenu-&gt;ItemAt(i)) {</a>
<a name="ln789">					item-&gt;SetMarked(i == index);</a>
<a name="ln790">					i++;</a>
<a name="ln791">				}</a>
<a name="ln792">				_UpdateAudioChannelCount(index);</a>
<a name="ln793">			}</a>
<a name="ln794">			break;</a>
<a name="ln795">		}</a>
<a name="ln796">		case MSG_CONTROLLER_SUB_TITLE_TRACK_CHANGED:</a>
<a name="ln797">		{</a>
<a name="ln798">			int32 index;</a>
<a name="ln799">			if (msg-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK) {</a>
<a name="ln800">				int32 i = 0;</a>
<a name="ln801">				while (BMenuItem* item = fSubTitleTrackMenu-&gt;ItemAt(i)) {</a>
<a name="ln802">					BMessage* message = item-&gt;Message();</a>
<a name="ln803">					if (message != NULL) {</a>
<a name="ln804">						item-&gt;SetMarked((int32)message-&gt;what</a>
<a name="ln805">							- M_SELECT_SUB_TITLE_TRACK == index);</a>
<a name="ln806">					}</a>
<a name="ln807">					i++;</a>
<a name="ln808">				}</a>
<a name="ln809">			}</a>
<a name="ln810">			break;</a>
<a name="ln811">		}</a>
<a name="ln812">		case MSG_CONTROLLER_PLAYBACK_STATE_CHANGED:</a>
<a name="ln813">		{</a>
<a name="ln814">			uint32 state;</a>
<a name="ln815">			if (msg-&gt;FindInt32(&quot;state&quot;, (int32*)&amp;state) == B_OK)</a>
<a name="ln816">				fControls-&gt;SetPlaybackState(state);</a>
<a name="ln817">			break;</a>
<a name="ln818">		}</a>
<a name="ln819">		case MSG_CONTROLLER_POSITION_CHANGED:</a>
<a name="ln820">		{</a>
<a name="ln821">			float position;</a>
<a name="ln822">			if (msg-&gt;FindFloat(&quot;position&quot;, &amp;position) == B_OK) {</a>
<a name="ln823">				fControls-&gt;SetPosition(position, fController-&gt;TimePosition(),</a>
<a name="ln824">					fController-&gt;TimeDuration());</a>
<a name="ln825">				fAllowWinding = true;</a>
<a name="ln826">			}</a>
<a name="ln827">			break;</a>
<a name="ln828">		}</a>
<a name="ln829">		case MSG_CONTROLLER_SEEK_HANDLED:</a>
<a name="ln830">			break;</a>
<a name="ln831"> </a>
<a name="ln832">		case MSG_CONTROLLER_VOLUME_CHANGED:</a>
<a name="ln833">		{</a>
<a name="ln834">			float volume;</a>
<a name="ln835">			if (msg-&gt;FindFloat(&quot;volume&quot;, &amp;volume) == B_OK)</a>
<a name="ln836">				fControls-&gt;SetVolume(volume);</a>
<a name="ln837">			fController-&gt;SaveState();</a>
<a name="ln838">			break;</a>
<a name="ln839">		}</a>
<a name="ln840">		case MSG_CONTROLLER_MUTED_CHANGED:</a>
<a name="ln841">		{</a>
<a name="ln842">			bool muted;</a>
<a name="ln843">			if (msg-&gt;FindBool(&quot;muted&quot;, &amp;muted) == B_OK)</a>
<a name="ln844">				fControls-&gt;SetMuted(muted);</a>
<a name="ln845">			break;</a>
<a name="ln846">		}</a>
<a name="ln847"> </a>
<a name="ln848">		// menu item messages</a>
<a name="ln849">		case M_FILE_OPEN:</a>
<a name="ln850">		{</a>
<a name="ln851">			BMessenger target(this);</a>
<a name="ln852">			BMessage result(B_REFS_RECEIVED);</a>
<a name="ln853">			BMessage appMessage(M_SHOW_OPEN_PANEL);</a>
<a name="ln854">			appMessage.AddMessenger(&quot;target&quot;, target);</a>
<a name="ln855">			appMessage.AddMessage(&quot;message&quot;, &amp;result);</a>
<a name="ln856">			appMessage.AddString(&quot;title&quot;, B_TRANSLATE(&quot;Open clips&quot;));</a>
<a name="ln857">			appMessage.AddString(&quot;label&quot;, B_TRANSLATE(&quot;Open&quot;));</a>
<a name="ln858">			be_app-&gt;PostMessage(&amp;appMessage);</a>
<a name="ln859">			break;</a>
<a name="ln860">		}</a>
<a name="ln861"> </a>
<a name="ln862">		case M_NETWORK_STREAM_OPEN:</a>
<a name="ln863">		{</a>
<a name="ln864">			BMessenger target(this);</a>
<a name="ln865">			NetworkStreamWin* win = new NetworkStreamWin(target);</a>
<a name="ln866">			win-&gt;Show();</a>
<a name="ln867">			break;</a>
<a name="ln868">		}</a>
<a name="ln869"> </a>
<a name="ln870">		case M_FILE_INFO:</a>
<a name="ln871">			ShowFileInfo();</a>
<a name="ln872">			break;</a>
<a name="ln873">		case M_FILE_PLAYLIST:</a>
<a name="ln874">			ShowPlaylistWindow();</a>
<a name="ln875">			break;</a>
<a name="ln876">		case M_FILE_CLOSE:</a>
<a name="ln877">			PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln878">			break;</a>
<a name="ln879">		case M_FILE_QUIT:</a>
<a name="ln880">			be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln881">			break;</a>
<a name="ln882"> </a>
<a name="ln883">		case M_TOGGLE_FULLSCREEN:</a>
<a name="ln884">			_ToggleFullscreen();</a>
<a name="ln885">			break;</a>
<a name="ln886"> </a>
<a name="ln887">		case M_TOGGLE_ALWAYS_ON_TOP:</a>
<a name="ln888">			_ToggleAlwaysOnTop();</a>
<a name="ln889">			break;</a>
<a name="ln890"> </a>
<a name="ln891">		case M_TOGGLE_NO_INTERFACE:</a>
<a name="ln892">			_ToggleNoInterface();</a>
<a name="ln893">			break;</a>
<a name="ln894"> </a>
<a name="ln895">		case M_VIEW_SIZE:</a>
<a name="ln896">		{</a>
<a name="ln897">			int32 size;</a>
<a name="ln898">			if (msg-&gt;FindInt32(&quot;size&quot;, &amp;size) == B_OK) {</a>
<a name="ln899">				if (!fHasVideo)</a>
<a name="ln900">					break;</a>
<a name="ln901">				if (fIsFullscreen)</a>
<a name="ln902">					_ToggleFullscreen();</a>
<a name="ln903">				_ResizeWindow(size);</a>
<a name="ln904">			}</a>
<a name="ln905">			break;</a>
<a name="ln906">		}</a>
<a name="ln907"> </a>
<a name="ln908">/*</a>
<a name="ln909">		case B_ACQUIRE_OVERLAY_LOCK:</a>
<a name="ln910">			printf(&quot;B_ACQUIRE_OVERLAY_LOCK\n&quot;);</a>
<a name="ln911">			fVideoView-&gt;OverlayLockAcquire();</a>
<a name="ln912">			break;</a>
<a name="ln913"> </a>
<a name="ln914">		case B_RELEASE_OVERLAY_LOCK:</a>
<a name="ln915">			printf(&quot;B_RELEASE_OVERLAY_LOCK\n&quot;);</a>
<a name="ln916">			fVideoView-&gt;OverlayLockRelease();</a>
<a name="ln917">			break;</a>
<a name="ln918">*/</a>
<a name="ln919">		case B_MOUSE_WHEEL_CHANGED:</a>
<a name="ln920">		{</a>
<a name="ln921">			float dx = msg-&gt;FindFloat(&quot;be:wheel_delta_x&quot;);</a>
<a name="ln922">			float dy = msg-&gt;FindFloat(&quot;be:wheel_delta_y&quot;);</a>
<a name="ln923">			bool inv = modifiers() &amp; B_COMMAND_KEY;</a>
<a name="ln924">			if (dx &gt; 0.1)</a>
<a name="ln925">				PostMessage(inv ? M_VOLUME_DOWN : M_SKIP_PREV);</a>
<a name="ln926">			if (dx &lt; -0.1)</a>
<a name="ln927">				PostMessage(inv ? M_VOLUME_UP : M_SKIP_NEXT);</a>
<a name="ln928">			if (dy &gt; 0.1)</a>
<a name="ln929">				PostMessage(inv ? M_SKIP_PREV : M_VOLUME_DOWN);</a>
<a name="ln930">			if (dy &lt; -0.1)</a>
<a name="ln931">				PostMessage(inv ? M_SKIP_NEXT : M_VOLUME_UP);</a>
<a name="ln932">			break;</a>
<a name="ln933">		}</a>
<a name="ln934"> </a>
<a name="ln935">		case M_SKIP_NEXT:</a>
<a name="ln936">			fControls-&gt;SkipForward();</a>
<a name="ln937">			break;</a>
<a name="ln938"> </a>
<a name="ln939">		case M_SKIP_PREV:</a>
<a name="ln940">			fControls-&gt;SkipBackward();</a>
<a name="ln941">			break;</a>
<a name="ln942"> </a>
<a name="ln943">		case M_WIND:</a>
<a name="ln944">		{</a>
<a name="ln945">			bigtime_t howMuch;</a>
<a name="ln946">			int64 frames;</a>
<a name="ln947">			if (msg-&gt;FindInt64(&quot;how much&quot;, &amp;howMuch) != B_OK</a>
<a name="ln948">				|| msg-&gt;FindInt64(&quot;frames&quot;, &amp;frames) != B_OK) {</a>
<a name="ln949">				break;</a>
<a name="ln950">			}</a>
<a name="ln951"> </a>
<a name="ln952">			_Wind(howMuch, frames);</a>
<a name="ln953">			break;</a>
<a name="ln954">		}</a>
<a name="ln955"> </a>
<a name="ln956">		case M_VOLUME_UP:</a>
<a name="ln957">			fController-&gt;VolumeUp();</a>
<a name="ln958">			break;</a>
<a name="ln959"> </a>
<a name="ln960">		case M_VOLUME_DOWN:</a>
<a name="ln961">			fController-&gt;VolumeDown();</a>
<a name="ln962">			break;</a>
<a name="ln963"> </a>
<a name="ln964">		case M_ASPECT_SAME_AS_SOURCE:</a>
<a name="ln965">			if (fHasVideo) {</a>
<a name="ln966">				int width;</a>
<a name="ln967">				int height;</a>
<a name="ln968">				int widthAspect;</a>
<a name="ln969">				int heightAspect;</a>
<a name="ln970">				fController-&gt;GetSize(&amp;width, &amp;height,</a>
<a name="ln971">					&amp;widthAspect, &amp;heightAspect);</a>
<a name="ln972">				VideoFormatChange(width, height, widthAspect, heightAspect);</a>
<a name="ln973">			}</a>
<a name="ln974">			break;</a>
<a name="ln975"> </a>
<a name="ln976">		case M_ASPECT_NO_DISTORTION:</a>
<a name="ln977">			if (fHasVideo) {</a>
<a name="ln978">				int width;</a>
<a name="ln979">				int height;</a>
<a name="ln980">				fController-&gt;GetSize(&amp;width, &amp;height);</a>
<a name="ln981">				VideoFormatChange(width, height, width, height);</a>
<a name="ln982">			}</a>
<a name="ln983">			break;</a>
<a name="ln984"> </a>
<a name="ln985">		case M_ASPECT_4_3:</a>
<a name="ln986">			VideoAspectChange(4, 3);</a>
<a name="ln987">			break;</a>
<a name="ln988"> </a>
<a name="ln989">		case M_ASPECT_16_9: // 1.77 : 1</a>
<a name="ln990">			VideoAspectChange(16, 9);</a>
<a name="ln991">			break;</a>
<a name="ln992"> </a>
<a name="ln993">		case M_ASPECT_83_50: // 1.66 : 1</a>
<a name="ln994">			VideoAspectChange(83, 50);</a>
<a name="ln995">			break;</a>
<a name="ln996"> </a>
<a name="ln997">		case M_ASPECT_7_4: // 1.75 : 1</a>
<a name="ln998">			VideoAspectChange(7, 4);</a>
<a name="ln999">			break;</a>
<a name="ln1000"> </a>
<a name="ln1001">		case M_ASPECT_37_20: // 1.85 : 1</a>
<a name="ln1002">			VideoAspectChange(37, 20);</a>
<a name="ln1003">			break;</a>
<a name="ln1004"> </a>
<a name="ln1005">		case M_ASPECT_47_20: // 2.35 : 1</a>
<a name="ln1006">			VideoAspectChange(47, 20);</a>
<a name="ln1007">			break;</a>
<a name="ln1008"> </a>
<a name="ln1009">		case M_SET_PLAYLIST_POSITION:</a>
<a name="ln1010">		{</a>
<a name="ln1011">			BAutolock _(fPlaylist);</a>
<a name="ln1012"> </a>
<a name="ln1013">			int32 index;</a>
<a name="ln1014">			if (msg-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK)</a>
<a name="ln1015">				fPlaylist-&gt;SetCurrentItemIndex(index);</a>
<a name="ln1016">			break;</a>
<a name="ln1017">		}</a>
<a name="ln1018"> </a>
<a name="ln1019">		case MSG_OBJECT_CHANGED:</a>
<a name="ln1020">			// received from fGlobalSettingsListener</a>
<a name="ln1021">			// TODO: find out which object, if we ever watch more than</a>
<a name="ln1022">			// the global settings instance...</a>
<a name="ln1023">			_AdoptGlobalSettings();</a>
<a name="ln1024">			break;</a>
<a name="ln1025"> </a>
<a name="ln1026">		case M_SLIDE_CONTROLS:</a>
<a name="ln1027">		{</a>
<a name="ln1028">			float offset;</a>
<a name="ln1029">			if (msg-&gt;FindFloat(&quot;offset&quot;, &amp;offset) == B_OK) {</a>
<a name="ln1030">				fControls-&gt;MoveBy(0, offset);</a>
<a name="ln1031">				fVideoView-&gt;SetSubTitleMaxBottom(fControls-&gt;Frame().top - 1);</a>
<a name="ln1032">				UpdateIfNeeded();</a>
<a name="ln1033">				snooze(15000);</a>
<a name="ln1034">			}</a>
<a name="ln1035">			break;</a>
<a name="ln1036">		}</a>
<a name="ln1037">		case M_FINISH_SLIDING_CONTROLS:</a>
<a name="ln1038">		{</a>
<a name="ln1039">			float offset;</a>
<a name="ln1040">			bool show;</a>
<a name="ln1041">			if (msg-&gt;FindFloat(&quot;offset&quot;, &amp;offset) == B_OK</a>
<a name="ln1042">				&amp;&amp; msg-&gt;FindBool(&quot;show&quot;, &amp;show) == B_OK) {</a>
<a name="ln1043">				if (show) {</a>
<a name="ln1044">					fControls-&gt;MoveTo(fControls-&gt;Frame().left, offset);</a>
<a name="ln1045">					fVideoView-&gt;SetSubTitleMaxBottom(offset - 1);</a>
<a name="ln1046">				} else {</a>
<a name="ln1047">					fVideoView-&gt;SetSubTitleMaxBottom(</a>
<a name="ln1048">						fVideoView-&gt;Bounds().bottom);</a>
<a name="ln1049">					fControls-&gt;RemoveSelf();</a>
<a name="ln1050">					fControls-&gt;MoveTo(fVideoView-&gt;Frame().left,</a>
<a name="ln1051">						fVideoView-&gt;Frame().bottom + 1);</a>
<a name="ln1052">					fBackground-&gt;AddChild(fControls);</a>
<a name="ln1053">					fControls-&gt;SetSymbolScale(1.0f);</a>
<a name="ln1054">					while (!fControls-&gt;IsHidden())</a>
<a name="ln1055">						fControls-&gt;Hide();</a>
<a name="ln1056">				}</a>
<a name="ln1057">			}</a>
<a name="ln1058">			break;</a>
<a name="ln1059">		}</a>
<a name="ln1060">		case M_HIDE_FULL_SCREEN_CONTROLS:</a>
<a name="ln1061">			if (fIsFullscreen) {</a>
<a name="ln1062">				BPoint videoViewWhere;</a>
<a name="ln1063">				if (msg-&gt;FindPoint(&quot;where&quot;, &amp;videoViewWhere) == B_OK) {</a>
<a name="ln1064">					if (msg-&gt;FindBool(&quot;force&quot;)</a>
<a name="ln1065">						|| !fControls-&gt;Frame().Contains(videoViewWhere)) {</a>
<a name="ln1066">						_ShowFullscreenControls(false);</a>
<a name="ln1067">						// hide the mouse cursor until the user moves it</a>
<a name="ln1068">						be_app-&gt;ObscureCursor();</a>
<a name="ln1069">					}</a>
<a name="ln1070">				}</a>
<a name="ln1071">			}</a>
<a name="ln1072">			break;</a>
<a name="ln1073"> </a>
<a name="ln1074">		case M_SET_RATING:</a>
<a name="ln1075">		{</a>
<a name="ln1076">			int32 rating;</a>
<a name="ln1077">			if (msg-&gt;FindInt32(&quot;rating&quot;, &amp;rating) == B_OK)</a>
<a name="ln1078">				_SetRating(rating);</a>
<a name="ln1079">			break;</a>
<a name="ln1080">		}</a>
<a name="ln1081"> </a>
<a name="ln1082">		default:</a>
<a name="ln1083">			if (msg-&gt;what &gt;= M_SELECT_AUDIO_TRACK</a>
<a name="ln1084">				&amp;&amp; msg-&gt;what &lt;= M_SELECT_AUDIO_TRACK_END) {</a>
<a name="ln1085">				fController-&gt;SelectAudioTrack(msg-&gt;what - M_SELECT_AUDIO_TRACK);</a>
<a name="ln1086">				break;</a>
<a name="ln1087">			}</a>
<a name="ln1088">			if (msg-&gt;what &gt;= M_SELECT_VIDEO_TRACK</a>
<a name="ln1089">				&amp;&amp; msg-&gt;what &lt;= M_SELECT_VIDEO_TRACK_END) {</a>
<a name="ln1090">				fController-&gt;SelectVideoTrack(msg-&gt;what - M_SELECT_VIDEO_TRACK);</a>
<a name="ln1091">				break;</a>
<a name="ln1092">			}</a>
<a name="ln1093">			if ((int32)msg-&gt;what &gt;= M_SELECT_SUB_TITLE_TRACK - 1</a>
<a name="ln1094">				&amp;&amp; msg-&gt;what &lt;= M_SELECT_SUB_TITLE_TRACK_END) {</a>
<a name="ln1095">				fController-&gt;SelectSubTitleTrack((int32)msg-&gt;what</a>
<a name="ln1096">					- M_SELECT_SUB_TITLE_TRACK);</a>
<a name="ln1097">				break;</a>
<a name="ln1098">			}</a>
<a name="ln1099">			// let BWindow handle the rest</a>
<a name="ln1100">			BWindow::MessageReceived(msg);</a>
<a name="ln1101">	}</a>
<a name="ln1102">}</a>
<a name="ln1103"> </a>
<a name="ln1104"> </a>
<a name="ln1105">void</a>
<a name="ln1106">MainWin::WindowActivated(bool active)</a>
<a name="ln1107">{</a>
<a name="ln1108">	fController-&gt;PlayerActivated(active);</a>
<a name="ln1109">}</a>
<a name="ln1110"> </a>
<a name="ln1111"> </a>
<a name="ln1112">bool</a>
<a name="ln1113">MainWin::QuitRequested()</a>
<a name="ln1114">{</a>
<a name="ln1115">	fController-&gt;SaveState();</a>
<a name="ln1116">	BMessage message(M_PLAYER_QUIT);</a>
<a name="ln1117">	GetQuitMessage(&amp;message);</a>
<a name="ln1118">	be_app-&gt;PostMessage(&amp;message);</a>
<a name="ln1119">	return true;</a>
<a name="ln1120">}</a>
<a name="ln1121"> </a>
<a name="ln1122"> </a>
<a name="ln1123">void</a>
<a name="ln1124">MainWin::MenusBeginning()</a>
<a name="ln1125">{</a>
<a name="ln1126">	_SetupVideoAspectItems(fVideoAspectMenu);</a>
<a name="ln1127">}</a>
<a name="ln1128"> </a>
<a name="ln1129"> </a>
<a name="ln1130">// #pragma mark -</a>
<a name="ln1131"> </a>
<a name="ln1132"> </a>
<a name="ln1133">void</a>
<a name="ln1134">MainWin::OpenPlaylist(const BMessage* playlistArchive)</a>
<a name="ln1135">{</a>
<a name="ln1136">	if (playlistArchive == NULL)</a>
<a name="ln1137">		return;</a>
<a name="ln1138"> </a>
<a name="ln1139">	BAutolock _(this);</a>
<a name="ln1140">	BAutolock playlistLocker(fPlaylist);</a>
<a name="ln1141"> </a>
<a name="ln1142">	if (fPlaylist-&gt;Unarchive(playlistArchive) != B_OK)</a>
<a name="ln1143">		return;</a>
<a name="ln1144"> </a>
<a name="ln1145">	int32 currentIndex;</a>
<a name="ln1146">	if (playlistArchive-&gt;FindInt32(&quot;index&quot;, &amp;currentIndex) != B_OK)</a>
<a name="ln1147">		currentIndex = 0;</a>
<a name="ln1148">	fPlaylist-&gt;SetCurrentItemIndex(currentIndex);</a>
<a name="ln1149"> </a>
<a name="ln1150">	playlistLocker.Unlock();</a>
<a name="ln1151"> </a>
<a name="ln1152">	if (currentIndex != -1) {</a>
<a name="ln1153">		// Restore the current play position only if we have something to play</a>
<a name="ln1154">		playlistArchive-&gt;FindInt64(&quot;position&quot;, (int64*)&amp;fInitialSeekPosition);</a>
<a name="ln1155">	}</a>
<a name="ln1156"> </a>
<a name="ln1157">	if (IsHidden())</a>
<a name="ln1158">		Show();</a>
<a name="ln1159">}</a>
<a name="ln1160"> </a>
<a name="ln1161"> </a>
<a name="ln1162">void</a>
<a name="ln1163">MainWin::OpenPlaylistItem(const PlaylistItemRef&amp; item)</a>
<a name="ln1164">{</a>
<a name="ln1165">	status_t ret = fController-&gt;SetToAsync(item);</a>
<a name="ln1166">	if (ret != B_OK) {</a>
<a name="ln1167">		fprintf(stderr, &quot;MainWin::OpenPlaylistItem() - Failed to send message &quot;</a>
<a name="ln1168">			&quot;to Controller.\n&quot;);</a>
<a name="ln1169">		BString message = B_TRANSLATE(&quot;%app% encountered an internal error. &quot;</a>
<a name="ln1170">			&quot;The file could not be opened.&quot;);</a>
<a name="ln1171">		message.ReplaceFirst(&quot;%app%&quot;, kApplicationName);</a>
<a name="ln1172">		BAlert* alert = new BAlert(kApplicationName, message.String(),</a>
<a name="ln1173">			B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln1174">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1175">		alert-&gt;Go();</a>
<a name="ln1176">		_PlaylistItemOpened(item, ret);</a>
<a name="ln1177">	} else {</a>
<a name="ln1178">		BString string;</a>
<a name="ln1179">		string &lt;&lt; &quot;Opening '&quot; &lt;&lt; item-&gt;Name() &lt;&lt; &quot;'.&quot;;</a>
<a name="ln1180">		fControls-&gt;SetDisabledString(string.String());</a>
<a name="ln1181">	}</a>
<a name="ln1182">}</a>
<a name="ln1183"> </a>
<a name="ln1184"> </a>
<a name="ln1185">void</a>
<a name="ln1186">MainWin::ShowFileInfo()</a>
<a name="ln1187">{</a>
<a name="ln1188">	if (!fInfoWin)</a>
<a name="ln1189">		fInfoWin = new InfoWin(Frame().LeftTop(), fController);</a>
<a name="ln1190"> </a>
<a name="ln1191">	if (fInfoWin-&gt;Lock()) {</a>
<a name="ln1192">		if (fInfoWin-&gt;IsHidden())</a>
<a name="ln1193">			fInfoWin-&gt;Show();</a>
<a name="ln1194">		else</a>
<a name="ln1195">			fInfoWin-&gt;Activate();</a>
<a name="ln1196">		fInfoWin-&gt;Unlock();</a>
<a name="ln1197">	}</a>
<a name="ln1198">}</a>
<a name="ln1199"> </a>
<a name="ln1200"> </a>
<a name="ln1201">void</a>
<a name="ln1202">MainWin::ShowPlaylistWindow()</a>
<a name="ln1203">{</a>
<a name="ln1204">	if (fPlaylistWindow-&gt;Lock()) {</a>
<a name="ln1205">		// make sure the window shows on the same workspace as ourself</a>
<a name="ln1206">		uint32 workspaces = Workspaces();</a>
<a name="ln1207">		if (fPlaylistWindow-&gt;Workspaces() != workspaces)</a>
<a name="ln1208">			fPlaylistWindow-&gt;SetWorkspaces(workspaces);</a>
<a name="ln1209"> </a>
<a name="ln1210">		// show or activate</a>
<a name="ln1211">		if (fPlaylistWindow-&gt;IsHidden())</a>
<a name="ln1212">			fPlaylistWindow-&gt;Show();</a>
<a name="ln1213">		else</a>
<a name="ln1214">			fPlaylistWindow-&gt;Activate();</a>
<a name="ln1215"> </a>
<a name="ln1216">		fPlaylistWindow-&gt;Unlock();</a>
<a name="ln1217">	}</a>
<a name="ln1218">}</a>
<a name="ln1219"> </a>
<a name="ln1220"> </a>
<a name="ln1221">void</a>
<a name="ln1222">MainWin::VideoAspectChange(int forcedWidth, int forcedHeight, float widthScale)</a>
<a name="ln1223">{</a>
<a name="ln1224">	// Force specific source size and pixel width scale.</a>
<a name="ln1225">	if (fHasVideo) {</a>
<a name="ln1226">		int width;</a>
<a name="ln1227">		int height;</a>
<a name="ln1228">		fController-&gt;GetSize(&amp;width, &amp;height);</a>
<a name="ln1229">		VideoFormatChange(forcedWidth, forcedHeight,</a>
<a name="ln1230">			lround(width * widthScale), height);</a>
<a name="ln1231">	}</a>
<a name="ln1232">}</a>
<a name="ln1233"> </a>
<a name="ln1234"> </a>
<a name="ln1235">void</a>
<a name="ln1236">MainWin::VideoAspectChange(float widthScale)</a>
<a name="ln1237">{</a>
<a name="ln1238">	// Called when video aspect ratio changes and the original</a>
<a name="ln1239">	// width/height should be restored too, display aspect is not known,</a>
<a name="ln1240">	// only pixel width scale.</a>
<a name="ln1241">	if (fHasVideo) {</a>
<a name="ln1242">		int width;</a>
<a name="ln1243">		int height;</a>
<a name="ln1244">		fController-&gt;GetSize(&amp;width, &amp;height);</a>
<a name="ln1245">		VideoFormatChange(width, height, lround(width * widthScale), height);</a>
<a name="ln1246">	}</a>
<a name="ln1247">}</a>
<a name="ln1248"> </a>
<a name="ln1249"> </a>
<a name="ln1250">void</a>
<a name="ln1251">MainWin::VideoAspectChange(int widthAspect, int heightAspect)</a>
<a name="ln1252">{</a>
<a name="ln1253">	// Called when video aspect ratio changes and the original</a>
<a name="ln1254">	// width/height should be restored too.</a>
<a name="ln1255">	if (fHasVideo) {</a>
<a name="ln1256">		int width;</a>
<a name="ln1257">		int height;</a>
<a name="ln1258">		fController-&gt;GetSize(&amp;width, &amp;height);</a>
<a name="ln1259">		VideoFormatChange(width, height, widthAspect, heightAspect);</a>
<a name="ln1260">	}</a>
<a name="ln1261">}</a>
<a name="ln1262"> </a>
<a name="ln1263"> </a>
<a name="ln1264">void</a>
<a name="ln1265">MainWin::VideoFormatChange(int width, int height, int widthAspect,</a>
<a name="ln1266">	int heightAspect)</a>
<a name="ln1267">{</a>
<a name="ln1268">	// Called when video format or aspect ratio changes.</a>
<a name="ln1269"> </a>
<a name="ln1270">	printf(&quot;VideoFormatChange enter: width %d, height %d, &quot;</a>
<a name="ln1271">		&quot;aspect ratio: %d:%d\n&quot;, width, height, widthAspect, heightAspect);</a>
<a name="ln1272"> </a>
<a name="ln1273">	// remember current view scale</a>
<a name="ln1274">	int percent = _CurrentVideoSizeInPercent();</a>
<a name="ln1275"> </a>
<a name="ln1276"> 	fSourceWidth = width;</a>
<a name="ln1277"> 	fSourceHeight = height;</a>
<a name="ln1278"> 	fWidthAspect = widthAspect;</a>
<a name="ln1279"> 	fHeightAspect = heightAspect;</a>
<a name="ln1280"> </a>
<a name="ln1281">	if (percent == 100)</a>
<a name="ln1282">		_ResizeWindow(100);</a>
<a name="ln1283">	else</a>
<a name="ln1284">	 	FrameResized(Bounds().Width(), Bounds().Height());</a>
<a name="ln1285"> </a>
<a name="ln1286">	printf(&quot;VideoFormatChange leave\n&quot;);</a>
<a name="ln1287">}</a>
<a name="ln1288"> </a>
<a name="ln1289"> </a>
<a name="ln1290">void</a>
<a name="ln1291">MainWin::GetQuitMessage(BMessage* message)</a>
<a name="ln1292">{</a>
<a name="ln1293">	message-&gt;AddPointer(&quot;instance&quot;, this);</a>
<a name="ln1294">	message-&gt;AddRect(&quot;window frame&quot;, Frame());</a>
<a name="ln1295">	message-&gt;AddBool(&quot;audio only&quot;, !fHasVideo);</a>
<a name="ln1296">	message-&gt;AddInt64(&quot;creation time&quot;, fCreationTime);</a>
<a name="ln1297"> </a>
<a name="ln1298">	if (!fHasVideo &amp;&amp; fHasAudio) {</a>
<a name="ln1299">		// store playlist, current index and position if this is audio</a>
<a name="ln1300">		BMessage playlistArchive;</a>
<a name="ln1301"> </a>
<a name="ln1302">		BAutolock controllerLocker(fController);</a>
<a name="ln1303">		playlistArchive.AddInt64(&quot;position&quot;, fController-&gt;TimePosition());</a>
<a name="ln1304">		controllerLocker.Unlock();</a>
<a name="ln1305"> </a>
<a name="ln1306">		if (!fPlaylist)</a>
<a name="ln1307">			return;</a>
<a name="ln1308"> </a>
<a name="ln1309">		BAutolock playlistLocker(fPlaylist);</a>
<a name="ln1310">		if (fPlaylist-&gt;Archive(&amp;playlistArchive) != B_OK</a>
<a name="ln1311">			|| playlistArchive.AddInt32(&quot;index&quot;,</a>
<a name="ln1312">				fPlaylist-&gt;CurrentItemIndex()) != B_OK</a>
<a name="ln1313">			|| message-&gt;AddMessage(&quot;playlist&quot;, &amp;playlistArchive) != B_OK) {</a>
<a name="ln1314">			fprintf(stderr, &quot;Failed to store current playlist.\n&quot;);</a>
<a name="ln1315">		}</a>
<a name="ln1316">	}</a>
<a name="ln1317">}</a>
<a name="ln1318"> </a>
<a name="ln1319"> </a>
<a name="ln1320">BHandler*</a>
<a name="ln1321">MainWin::ResolveSpecifier(BMessage* message, int32 index, BMessage* specifier,</a>
<a name="ln1322">	int32 what, const char* property)</a>
<a name="ln1323">{</a>
<a name="ln1324">	BPropertyInfo propertyInfo(sPropertyInfo);</a>
<a name="ln1325">	if (propertyInfo.FindMatch(message, index, specifier, what, property)</a>
<a name="ln1326">			!= B_ERROR)</a>
<a name="ln1327">		return this;</a>
<a name="ln1328"> </a>
<a name="ln1329">	return BWindow::ResolveSpecifier(message, index, specifier, what, property);</a>
<a name="ln1330">}</a>
<a name="ln1331"> </a>
<a name="ln1332"> </a>
<a name="ln1333">status_t</a>
<a name="ln1334">MainWin::GetSupportedSuites(BMessage* data)</a>
<a name="ln1335">{</a>
<a name="ln1336">	if (data == NULL)</a>
<a name="ln1337">		return B_BAD_VALUE;</a>
<a name="ln1338"> </a>
<a name="ln1339">	status_t status = data-&gt;AddString(&quot;suites&quot;, &quot;suite/vnd.Haiku-MediaPlayer&quot;);</a>
<a name="ln1340">	if (status != B_OK)</a>
<a name="ln1341">		return status;</a>
<a name="ln1342"> </a>
<a name="ln1343">	BPropertyInfo propertyInfo(sPropertyInfo);</a>
<a name="ln1344">	status = data-&gt;AddFlat(&quot;messages&quot;, &amp;propertyInfo);</a>
<a name="ln1345">	if (status != B_OK)</a>
<a name="ln1346">		return status;</a>
<a name="ln1347"> </a>
<a name="ln1348">	return BWindow::GetSupportedSuites(data);</a>
<a name="ln1349">}</a>
<a name="ln1350"> </a>
<a name="ln1351"> </a>
<a name="ln1352">// #pragma mark -</a>
<a name="ln1353"> </a>
<a name="ln1354"> </a>
<a name="ln1355">void</a>
<a name="ln1356">MainWin::_RefsReceived(BMessage* message)</a>
<a name="ln1357">{</a>
<a name="ln1358">	// the playlist is replaced by dropped files</a>
<a name="ln1359">	// or the dropped files are appended to the end</a>
<a name="ln1360">	// of the existing playlist if &lt;shift&gt; is pressed</a>
<a name="ln1361">	bool append = false;</a>
<a name="ln1362">	if (message-&gt;FindBool(&quot;append to playlist&quot;, &amp;append) != B_OK)</a>
<a name="ln1363">		append = modifiers() &amp; B_SHIFT_KEY;</a>
<a name="ln1364"> </a>
<a name="ln1365">	BAutolock _(fPlaylist);</a>
<a name="ln1366">	int32 appendIndex = append ? APPEND_INDEX_APPEND_LAST</a>
<a name="ln1367">		: APPEND_INDEX_REPLACE_PLAYLIST;</a>
<a name="ln1368">	message-&gt;AddInt32(&quot;append_index&quot;, appendIndex);</a>
<a name="ln1369"> </a>
<a name="ln1370">	// forward the message to the playlist window,</a>
<a name="ln1371">	// so that undo/redo is used for modifying the playlist</a>
<a name="ln1372">	fPlaylistWindow-&gt;PostMessage(message);</a>
<a name="ln1373"> </a>
<a name="ln1374">	if (message-&gt;FindRect(&quot;window frame&quot;, &amp;fNoVideoFrame) != B_OK)</a>
<a name="ln1375">		fNoVideoFrame = BRect();</a>
<a name="ln1376">}</a>
<a name="ln1377"> </a>
<a name="ln1378"> </a>
<a name="ln1379">void</a>
<a name="ln1380">MainWin::_PlaylistItemOpened(const PlaylistItemRef&amp; item, status_t result)</a>
<a name="ln1381">{</a>
<a name="ln1382">	if (result != B_OK) {</a>
<a name="ln1383">		BAutolock _(fPlaylist);</a>
<a name="ln1384"> </a>
<a name="ln1385">		item-&gt;SetPlaybackFailed();</a>
<a name="ln1386">		bool allItemsFailed = true;</a>
<a name="ln1387">		int32 count = fPlaylist-&gt;CountItems();</a>
<a name="ln1388">		for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1389">			if (!fPlaylist-&gt;ItemAtFast(i)-&gt;PlaybackFailed()) {</a>
<a name="ln1390">				allItemsFailed = false;</a>
<a name="ln1391">				break;</a>
<a name="ln1392">			}</a>
<a name="ln1393">		}</a>
<a name="ln1394"> </a>
<a name="ln1395">		if (allItemsFailed) {</a>
<a name="ln1396">			// Display error if all files failed to play.</a>
<a name="ln1397">			BString message(B_TRANSLATE(</a>
<a name="ln1398">				&quot;The file '%filename' could not be opened.\n\n&quot;));;</a>
<a name="ln1399">			message.ReplaceAll(&quot;%filename&quot;, item-&gt;Name());</a>
<a name="ln1400"> </a>
<a name="ln1401">			if (result == B_MEDIA_NO_HANDLER) {</a>
<a name="ln1402">				// give a more detailed message for the most likely of all</a>
<a name="ln1403">				// errors</a>
<a name="ln1404">				message &lt;&lt; B_TRANSLATE(</a>
<a name="ln1405">					&quot;There is no decoder installed to handle the &quot;</a>
<a name="ln1406">					&quot;file format, or the decoder has trouble with the &quot;</a>
<a name="ln1407">					&quot;specific version of the format.&quot;);</a>
<a name="ln1408">			} else {</a>
<a name="ln1409">				message &lt;&lt; B_TRANSLATE(&quot;Error: &quot;) &lt;&lt; strerror(result);</a>
<a name="ln1410">			}</a>
<a name="ln1411">			BAlert* alert = new BAlert(&quot;error&quot;, message.String(),</a>
<a name="ln1412">				B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln1413">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln1414">			alert-&gt;Go();</a>
<a name="ln1415">			fControls-&gt;SetDisabledString(kDisabledSeekMessage);</a>
<a name="ln1416">		} else {</a>
<a name="ln1417">			// Just go to the next file and don't bother user (yet)</a>
<a name="ln1418">			fPlaylist-&gt;SetCurrentItemIndex(fPlaylist-&gt;CurrentItemIndex() + 1);</a>
<a name="ln1419">		}</a>
<a name="ln1420"> </a>
<a name="ln1421">		fHasFile = false;</a>
<a name="ln1422">		fHasVideo = false;</a>
<a name="ln1423">		fHasAudio = false;</a>
<a name="ln1424">		SetTitle(kApplicationName);</a>
<a name="ln1425">	} else {</a>
<a name="ln1426">		fHasFile = true;</a>
<a name="ln1427">		fHasVideo = fController-&gt;VideoTrackCount() != 0;</a>
<a name="ln1428">		fHasAudio = fController-&gt;AudioTrackCount() != 0;</a>
<a name="ln1429">		SetTitle(item-&gt;Name().String());</a>
<a name="ln1430"> </a>
<a name="ln1431">		if (fInitialSeekPosition &lt; 0) {</a>
<a name="ln1432">			fInitialSeekPosition</a>
<a name="ln1433">				= fController-&gt;TimeDuration() + fInitialSeekPosition;</a>
<a name="ln1434">		}</a>
<a name="ln1435">		fController-&gt;SetTimePosition(fInitialSeekPosition);</a>
<a name="ln1436">		fInitialSeekPosition = 0;</a>
<a name="ln1437"> </a>
<a name="ln1438">		if (fPlaylist-&gt;CountItems() == 1)</a>
<a name="ln1439">			fController-&gt;RestoreState();</a>
<a name="ln1440">	}</a>
<a name="ln1441">	_SetupWindow();</a>
<a name="ln1442"> </a>
<a name="ln1443">	if (result == B_OK)</a>
<a name="ln1444">		_UpdatePlaylistItemFile();</a>
<a name="ln1445">}</a>
<a name="ln1446"> </a>
<a name="ln1447"> </a>
<a name="ln1448">void</a>
<a name="ln1449">MainWin::_SetupWindow()</a>
<a name="ln1450">{</a>
<a name="ln1451">//	printf(&quot;MainWin::_SetupWindow\n&quot;);</a>
<a name="ln1452">	// Populate the track menus</a>
<a name="ln1453">	_SetupTrackMenus(fAudioTrackMenu, fVideoTrackMenu, fSubTitleTrackMenu);</a>
<a name="ln1454">	_UpdateAudioChannelCount(fController-&gt;CurrentAudioTrack());</a>
<a name="ln1455"> </a>
<a name="ln1456">	fVideoMenu-&gt;SetEnabled(fHasVideo);</a>
<a name="ln1457">	fAudioMenu-&gt;SetEnabled(fHasAudio);</a>
<a name="ln1458">	int previousSourceWidth = fSourceWidth;</a>
<a name="ln1459">	int previousSourceHeight = fSourceHeight;</a>
<a name="ln1460">	int previousWidthAspect = fWidthAspect;</a>
<a name="ln1461">	int previousHeightAspect = fHeightAspect;</a>
<a name="ln1462">	if (fHasVideo) {</a>
<a name="ln1463">		fController-&gt;GetSize(&amp;fSourceWidth, &amp;fSourceHeight,</a>
<a name="ln1464">			&amp;fWidthAspect, &amp;fHeightAspect);</a>
<a name="ln1465">	} else {</a>
<a name="ln1466">		fSourceWidth = 0;</a>
<a name="ln1467">		fSourceHeight = 0;</a>
<a name="ln1468">		fWidthAspect = 1;</a>
<a name="ln1469">		fHeightAspect = 1;</a>
<a name="ln1470">	}</a>
<a name="ln1471">	_UpdateControlsEnabledStatus();</a>
<a name="ln1472"> </a>
<a name="ln1473">	// Adopt the size and window layout if necessary</a>
<a name="ln1474">	if (previousSourceWidth != fSourceWidth</a>
<a name="ln1475">		|| previousSourceHeight != fSourceHeight</a>
<a name="ln1476">		|| previousWidthAspect != fWidthAspect</a>
<a name="ln1477">		|| previousHeightAspect != fHeightAspect) {</a>
<a name="ln1478"> </a>
<a name="ln1479">		_SetWindowSizeLimits();</a>
<a name="ln1480"> </a>
<a name="ln1481">		if (!fIsFullscreen) {</a>
<a name="ln1482">			// Resize to 100% but stay on screen</a>
<a name="ln1483">			_ResizeWindow(100, !fHasVideo, true);</a>
<a name="ln1484">		} else {</a>
<a name="ln1485">			// Make sure we relayout the video view when in full screen mode</a>
<a name="ln1486">			FrameResized(Frame().Width(), Frame().Height());</a>
<a name="ln1487">		}</a>
<a name="ln1488">	}</a>
<a name="ln1489"> </a>
<a name="ln1490">	_ShowIfNeeded();</a>
<a name="ln1491"> </a>
<a name="ln1492">	fVideoView-&gt;MakeFocus();</a>
<a name="ln1493">}</a>
<a name="ln1494"> </a>
<a name="ln1495"> </a>
<a name="ln1496">void</a>
<a name="ln1497">MainWin::_CreateMenu()</a>
<a name="ln1498">{</a>
<a name="ln1499">	fFileMenu = new BMenu(kApplicationName);</a>
<a name="ln1500">	fPlaylistMenu = new BMenu(B_TRANSLATE(&quot;Playlist&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln1501">	fAudioMenu = new BMenu(B_TRANSLATE(&quot;Audio&quot;));</a>
<a name="ln1502">	fVideoMenu = new BMenu(B_TRANSLATE(&quot;Video&quot;));</a>
<a name="ln1503">	fVideoAspectMenu = new BMenu(B_TRANSLATE(&quot;Aspect ratio&quot;));</a>
<a name="ln1504">	fAudioTrackMenu = new BMenu(B_TRANSLATE_CONTEXT(&quot;Track&quot;,</a>
<a name="ln1505">		&quot;Audio Track Menu&quot;));</a>
<a name="ln1506">	fVideoTrackMenu = new BMenu(B_TRANSLATE_CONTEXT(&quot;Track&quot;,</a>
<a name="ln1507">		&quot;Video Track Menu&quot;));</a>
<a name="ln1508">	fSubTitleTrackMenu = new BMenu(B_TRANSLATE(&quot;Subtitles&quot;));</a>
<a name="ln1509">	fAttributesMenu = new BMenu(B_TRANSLATE(&quot;Attributes&quot;));</a>
<a name="ln1510"> </a>
<a name="ln1511">	fMenuBar-&gt;AddItem(fFileMenu);</a>
<a name="ln1512">	fMenuBar-&gt;AddItem(fAudioMenu);</a>
<a name="ln1513">	fMenuBar-&gt;AddItem(fVideoMenu);</a>
<a name="ln1514">	fMenuBar-&gt;AddItem(fAttributesMenu);</a>
<a name="ln1515"> </a>
<a name="ln1516">	BMenuItem* item = new BMenuItem(B_TRANSLATE(&quot;New player&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1517">		new BMessage(M_NEW_PLAYER), 'N');</a>
<a name="ln1518">	fFileMenu-&gt;AddItem(item);</a>
<a name="ln1519">	item-&gt;SetTarget(be_app);</a>
<a name="ln1520"> </a>
<a name="ln1521">	// Add recent files to &quot;Open File&quot; entry as sub-menu.</a>
<a name="ln1522">	BRecentFilesList recentFiles(10, false, NULL, kAppSig);</a>
<a name="ln1523">	item = new BMenuItem(recentFiles.NewFileListMenu(</a>
<a name="ln1524">		B_TRANSLATE(&quot;Open file&quot; B_UTF8_ELLIPSIS), NULL, NULL, this, 10, true,</a>
<a name="ln1525">		NULL, kAppSig), new BMessage(M_FILE_OPEN));</a>
<a name="ln1526">	item-&gt;SetShortcut('O', 0);</a>
<a name="ln1527">	fFileMenu-&gt;AddItem(item);</a>
<a name="ln1528"> </a>
<a name="ln1529">	item = new BMenuItem(B_TRANSLATE(&quot;Open network stream&quot;),</a>
<a name="ln1530">		new BMessage(M_NETWORK_STREAM_OPEN));</a>
<a name="ln1531">	fFileMenu-&gt;AddItem(item);</a>
<a name="ln1532"> </a>
<a name="ln1533">	fFileMenu-&gt;AddSeparatorItem();</a>
<a name="ln1534"> </a>
<a name="ln1535">	fFileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;File info&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1536">		new BMessage(M_FILE_INFO), 'I'));</a>
<a name="ln1537">	fFileMenu-&gt;AddItem(fPlaylistMenu);</a>
<a name="ln1538">	fPlaylistMenu-&gt;Superitem()-&gt;SetShortcut('P', B_COMMAND_KEY);</a>
<a name="ln1539">	fPlaylistMenu-&gt;Superitem()-&gt;SetMessage(new BMessage(M_FILE_PLAYLIST));</a>
<a name="ln1540"> </a>
<a name="ln1541">	fFileMenu-&gt;AddSeparatorItem();</a>
<a name="ln1542"> </a>
<a name="ln1543">	fNoInterfaceMenuItem = new BMenuItem(B_TRANSLATE(&quot;Hide interface&quot;),</a>
<a name="ln1544">		new BMessage(M_TOGGLE_NO_INTERFACE), 'H');</a>
<a name="ln1545">	fFileMenu-&gt;AddItem(fNoInterfaceMenuItem);</a>
<a name="ln1546">	fFileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Always on top&quot;),</a>
<a name="ln1547">		new BMessage(M_TOGGLE_ALWAYS_ON_TOP), 'A'));</a>
<a name="ln1548"> </a>
<a name="ln1549">	item = new BMenuItem(B_TRANSLATE(&quot;Settings&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1550">		new BMessage(M_SETTINGS), 'S');</a>
<a name="ln1551">	fFileMenu-&gt;AddItem(item);</a>
<a name="ln1552">	item-&gt;SetTarget(be_app);</a>
<a name="ln1553"> </a>
<a name="ln1554">	fFileMenu-&gt;AddSeparatorItem();</a>
<a name="ln1555"> </a>
<a name="ln1556">	fFileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Close&quot;),</a>
<a name="ln1557">		new BMessage(M_FILE_CLOSE), 'W'));</a>
<a name="ln1558">	fFileMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln1559">		new BMessage(M_FILE_QUIT), 'Q'));</a>
<a name="ln1560"> </a>
<a name="ln1561">	fPlaylistMenu-&gt;SetRadioMode(true);</a>
<a name="ln1562"> </a>
<a name="ln1563">	fAudioMenu-&gt;AddItem(fAudioTrackMenu);</a>
<a name="ln1564"> </a>
<a name="ln1565">	fVideoMenu-&gt;AddItem(fVideoTrackMenu);</a>
<a name="ln1566">	fVideoMenu-&gt;AddItem(fSubTitleTrackMenu);</a>
<a name="ln1567">	fVideoMenu-&gt;AddSeparatorItem();</a>
<a name="ln1568">	BMessage* resizeMessage = new BMessage(M_VIEW_SIZE);</a>
<a name="ln1569">	resizeMessage-&gt;AddInt32(&quot;size&quot;, 50);</a>
<a name="ln1570">	fVideoMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln1571">		B_TRANSLATE(&quot;50% scale&quot;), resizeMessage, '0'));</a>
<a name="ln1572"> </a>
<a name="ln1573">	resizeMessage = new BMessage(M_VIEW_SIZE);</a>
<a name="ln1574">	resizeMessage-&gt;AddInt32(&quot;size&quot;, 100);</a>
<a name="ln1575">	fVideoMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln1576">		B_TRANSLATE(&quot;100% scale&quot;), resizeMessage, '1'));</a>
<a name="ln1577"> </a>
<a name="ln1578">	resizeMessage = new BMessage(M_VIEW_SIZE);</a>
<a name="ln1579">	resizeMessage-&gt;AddInt32(&quot;size&quot;, 200);</a>
<a name="ln1580">	fVideoMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln1581">		B_TRANSLATE(&quot;200% scale&quot;), resizeMessage, '2'));</a>
<a name="ln1582"> </a>
<a name="ln1583">	resizeMessage = new BMessage(M_VIEW_SIZE);</a>
<a name="ln1584">	resizeMessage-&gt;AddInt32(&quot;size&quot;, 300);</a>
<a name="ln1585">	fVideoMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln1586">		B_TRANSLATE(&quot;300% scale&quot;), resizeMessage, '3'));</a>
<a name="ln1587"> </a>
<a name="ln1588">	resizeMessage = new BMessage(M_VIEW_SIZE);</a>
<a name="ln1589">	resizeMessage-&gt;AddInt32(&quot;size&quot;, 400);</a>
<a name="ln1590">	fVideoMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln1591">		B_TRANSLATE(&quot;400% scale&quot;), resizeMessage, '4'));</a>
<a name="ln1592"> </a>
<a name="ln1593">	fVideoMenu-&gt;AddSeparatorItem();</a>
<a name="ln1594"> </a>
<a name="ln1595">	fVideoMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Full screen&quot;),</a>
<a name="ln1596">		new BMessage(M_TOGGLE_FULLSCREEN), B_ENTER));</a>
<a name="ln1597"> </a>
<a name="ln1598">	fVideoMenu-&gt;AddSeparatorItem();</a>
<a name="ln1599"> </a>
<a name="ln1600">	_SetupVideoAspectItems(fVideoAspectMenu);</a>
<a name="ln1601">	fVideoMenu-&gt;AddItem(fVideoAspectMenu);</a>
<a name="ln1602"> </a>
<a name="ln1603">	fRatingMenu = new BMenu(B_TRANSLATE(&quot;Rating&quot;));</a>
<a name="ln1604">	fAttributesMenu-&gt;AddItem(fRatingMenu);</a>
<a name="ln1605">	for (int32 i = 1; i &lt;= 10; i++) {</a>
<a name="ln1606">		char label[16];</a>
<a name="ln1607">		snprintf(label, sizeof(label), &quot;%&quot; B_PRId32, i);</a>
<a name="ln1608">		BMessage* setRatingMsg = new BMessage(M_SET_RATING);</a>
<a name="ln1609">		setRatingMsg-&gt;AddInt32(&quot;rating&quot;, i);</a>
<a name="ln1610">		fRatingMenu-&gt;AddItem(new BMenuItem(label, setRatingMsg));</a>
<a name="ln1611">	}</a>
<a name="ln1612">}</a>
<a name="ln1613"> </a>
<a name="ln1614"> </a>
<a name="ln1615">void</a>
<a name="ln1616">MainWin::_SetupVideoAspectItems(BMenu* menu)</a>
<a name="ln1617">{</a>
<a name="ln1618">	BMenuItem* item;</a>
<a name="ln1619">	while ((item = menu-&gt;RemoveItem((int32)0)) != NULL)</a>
<a name="ln1620">		delete item;</a>
<a name="ln1621"> </a>
<a name="ln1622">	int width;</a>
<a name="ln1623">	int height;</a>
<a name="ln1624">	int widthAspect;</a>
<a name="ln1625">	int heightAspect;</a>
<a name="ln1626">	fController-&gt;GetSize(&amp;width, &amp;height, &amp;widthAspect, &amp;heightAspect);</a>
<a name="ln1627">		// We don't care if there is a video track at all. In that</a>
<a name="ln1628">		// case we should end up not marking any item.</a>
<a name="ln1629"> </a>
<a name="ln1630">	// NOTE: The item marking may end up marking for example both</a>
<a name="ln1631">	// &quot;Stream Settings&quot; and &quot;16 : 9&quot; if the stream settings happen to</a>
<a name="ln1632">	// be &quot;16 : 9&quot;.</a>
<a name="ln1633"> </a>
<a name="ln1634">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Stream settings&quot;),</a>
<a name="ln1635">		new BMessage(M_ASPECT_SAME_AS_SOURCE), '1', B_SHIFT_KEY));</a>
<a name="ln1636">	item-&gt;SetMarked(widthAspect == fWidthAspect</a>
<a name="ln1637">		&amp;&amp; heightAspect == fHeightAspect);</a>
<a name="ln1638"> </a>
<a name="ln1639">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;No aspect correction&quot;),</a>
<a name="ln1640">		new BMessage(M_ASPECT_NO_DISTORTION), '0', B_SHIFT_KEY));</a>
<a name="ln1641">	item-&gt;SetMarked(width == fWidthAspect &amp;&amp; height == fHeightAspect);</a>
<a name="ln1642"> </a>
<a name="ln1643">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1644"> </a>
<a name="ln1645">	menu-&gt;AddItem(item = new BMenuItem(&quot;4 : 3&quot;,</a>
<a name="ln1646">		new BMessage(M_ASPECT_4_3), 2, B_SHIFT_KEY));</a>
<a name="ln1647">	item-&gt;SetMarked(fWidthAspect == 4 &amp;&amp; fHeightAspect == 3);</a>
<a name="ln1648">	menu-&gt;AddItem(item = new BMenuItem(&quot;16 : 9&quot;,</a>
<a name="ln1649">		new BMessage(M_ASPECT_16_9), 3, B_SHIFT_KEY));</a>
<a name="ln1650">	item-&gt;SetMarked(fWidthAspect == 16 &amp;&amp; fHeightAspect == 9);</a>
<a name="ln1651"> </a>
<a name="ln1652">	menu-&gt;AddSeparatorItem();</a>
<a name="ln1653"> </a>
<a name="ln1654">	menu-&gt;AddItem(item = new BMenuItem(&quot;1.66 : 1&quot;,</a>
<a name="ln1655">		new BMessage(M_ASPECT_83_50)));</a>
<a name="ln1656">	item-&gt;SetMarked(fWidthAspect == 83 &amp;&amp; fHeightAspect == 50);</a>
<a name="ln1657">	menu-&gt;AddItem(item = new BMenuItem(&quot;1.75 : 1&quot;,</a>
<a name="ln1658">		new BMessage(M_ASPECT_7_4)));</a>
<a name="ln1659">	item-&gt;SetMarked(fWidthAspect == 7 &amp;&amp; fHeightAspect == 4);</a>
<a name="ln1660">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;1.85 : 1 (American)&quot;),</a>
<a name="ln1661">		new BMessage(M_ASPECT_37_20)));</a>
<a name="ln1662">	item-&gt;SetMarked(fWidthAspect == 37 &amp;&amp; fHeightAspect == 20);</a>
<a name="ln1663">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;2.35 : 1 (Cinemascope)&quot;),</a>
<a name="ln1664">		new BMessage(M_ASPECT_47_20)));</a>
<a name="ln1665">	item-&gt;SetMarked(fWidthAspect == 47 &amp;&amp; fHeightAspect == 20);</a>
<a name="ln1666">}</a>
<a name="ln1667"> </a>
<a name="ln1668"> </a>
<a name="ln1669">void</a>
<a name="ln1670">MainWin::_SetupTrackMenus(BMenu* audioTrackMenu, BMenu* videoTrackMenu,</a>
<a name="ln1671">	BMenu* subTitleTrackMenu)</a>
<a name="ln1672">{</a>
<a name="ln1673">	audioTrackMenu-&gt;RemoveItems(0, audioTrackMenu-&gt;CountItems(), true);</a>
<a name="ln1674">	videoTrackMenu-&gt;RemoveItems(0, videoTrackMenu-&gt;CountItems(), true);</a>
<a name="ln1675">	subTitleTrackMenu-&gt;RemoveItems(0, subTitleTrackMenu-&gt;CountItems(), true);</a>
<a name="ln1676"> </a>
<a name="ln1677">	char s[100];</a>
<a name="ln1678"> </a>
<a name="ln1679">	int count = fController-&gt;AudioTrackCount();</a>
<a name="ln1680">	int current = fController-&gt;CurrentAudioTrack();</a>
<a name="ln1681">	for (int i = 0; i &lt; count; i++) {</a>
<a name="ln1682">		BMessage metaData;</a>
<a name="ln1683">		const char* languageString = NULL;</a>
<a name="ln1684">		if (fController-&gt;GetAudioMetaData(i, &amp;metaData) == B_OK)</a>
<a name="ln1685">			metaData.FindString(&quot;language&quot;, &amp;languageString);</a>
<a name="ln1686">		if (languageString != NULL) {</a>
<a name="ln1687">			BLanguage language(languageString);</a>
<a name="ln1688">			BString languageName;</a>
<a name="ln1689">			if (language.GetName(languageName) == B_OK)</a>
<a name="ln1690">				languageString = languageName.String();</a>
<a name="ln1691">			snprintf(s, sizeof(s), &quot;%s&quot;, languageString);</a>
<a name="ln1692">		} else</a>
<a name="ln1693">			snprintf(s, sizeof(s), B_TRANSLATE(&quot;Track %d&quot;), i + 1);</a>
<a name="ln1694">		BMenuItem* item = new BMenuItem(s,</a>
<a name="ln1695">			new BMessage(M_SELECT_AUDIO_TRACK + i));</a>
<a name="ln1696">		item-&gt;SetMarked(i == current);</a>
<a name="ln1697">		audioTrackMenu-&gt;AddItem(item);</a>
<a name="ln1698">	}</a>
<a name="ln1699">	if (count == 0) {</a>
<a name="ln1700">		audioTrackMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE_CONTEXT(&quot;none&quot;,</a>
<a name="ln1701">			&quot;Audio track menu&quot;), new BMessage(M_DUMMY)));</a>
<a name="ln1702">		audioTrackMenu-&gt;ItemAt(0)-&gt;SetMarked(true);</a>
<a name="ln1703">	}</a>
<a name="ln1704">	audioTrackMenu-&gt;SetEnabled(count &gt; 1);</a>
<a name="ln1705"> </a>
<a name="ln1706">	count = fController-&gt;VideoTrackCount();</a>
<a name="ln1707">	current = fController-&gt;CurrentVideoTrack();</a>
<a name="ln1708">	for (int i = 0; i &lt; count; i++) {</a>
<a name="ln1709">		snprintf(s, sizeof(s), B_TRANSLATE(&quot;Track %d&quot;), i + 1);</a>
<a name="ln1710">		BMenuItem* item = new BMenuItem(s,</a>
<a name="ln1711">			new BMessage(M_SELECT_VIDEO_TRACK + i));</a>
<a name="ln1712">		item-&gt;SetMarked(i == current);</a>
<a name="ln1713">		videoTrackMenu-&gt;AddItem(item);</a>
<a name="ln1714">	}</a>
<a name="ln1715">	if (count == 0) {</a>
<a name="ln1716">		videoTrackMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;none&quot;),</a>
<a name="ln1717">			new BMessage(M_DUMMY)));</a>
<a name="ln1718">		videoTrackMenu-&gt;ItemAt(0)-&gt;SetMarked(true);</a>
<a name="ln1719">	}</a>
<a name="ln1720">	videoTrackMenu-&gt;SetEnabled(count &gt; 1);</a>
<a name="ln1721"> </a>
<a name="ln1722">	count = fController-&gt;SubTitleTrackCount();</a>
<a name="ln1723">	if (count &gt; 0) {</a>
<a name="ln1724">		current = fController-&gt;CurrentSubTitleTrack();</a>
<a name="ln1725">		BMenuItem* item = new BMenuItem(</a>
<a name="ln1726">			B_TRANSLATE_CONTEXT(&quot;Off&quot;, &quot;Subtitles menu&quot;),</a>
<a name="ln1727">			new BMessage(M_SELECT_SUB_TITLE_TRACK - 1));</a>
<a name="ln1728">		subTitleTrackMenu-&gt;AddItem(item);</a>
<a name="ln1729">		item-&gt;SetMarked(current == -1);</a>
<a name="ln1730"> </a>
<a name="ln1731">		subTitleTrackMenu-&gt;AddSeparatorItem();</a>
<a name="ln1732"> </a>
<a name="ln1733">		for (int i = 0; i &lt; count; i++) {</a>
<a name="ln1734">			const char* name = fController-&gt;SubTitleTrackName(i);</a>
<a name="ln1735">			if (name != NULL)</a>
<a name="ln1736">				snprintf(s, sizeof(s), &quot;%s&quot;, name);</a>
<a name="ln1737">			else</a>
<a name="ln1738">				snprintf(s, sizeof(s), B_TRANSLATE(&quot;Track %d&quot;), i + 1);</a>
<a name="ln1739">			item = new BMenuItem(s,</a>
<a name="ln1740">				new BMessage(M_SELECT_SUB_TITLE_TRACK + i));</a>
<a name="ln1741">			item-&gt;SetMarked(i == current);</a>
<a name="ln1742">			subTitleTrackMenu-&gt;AddItem(item);</a>
<a name="ln1743">		}</a>
<a name="ln1744">	} else {</a>
<a name="ln1745">		subTitleTrackMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln1746">			B_TRANSLATE_CONTEXT(&quot;none&quot;, &quot;Subtitles menu&quot;),</a>
<a name="ln1747">			new BMessage(M_DUMMY)));</a>
<a name="ln1748">		subTitleTrackMenu-&gt;ItemAt(0)-&gt;SetMarked(true);</a>
<a name="ln1749">	}</a>
<a name="ln1750">	subTitleTrackMenu-&gt;SetEnabled(count &gt; 0);</a>
<a name="ln1751">}</a>
<a name="ln1752"> </a>
<a name="ln1753"> </a>
<a name="ln1754">void</a>
<a name="ln1755">MainWin::_UpdateAudioChannelCount(int32 audioTrackIndex)</a>
<a name="ln1756">{</a>
<a name="ln1757">	fControls-&gt;SetAudioChannelCount(fController-&gt;AudioTrackChannelCount());</a>
<a name="ln1758">}</a>
<a name="ln1759"> </a>
<a name="ln1760"> </a>
<a name="ln1761">void</a>
<a name="ln1762">MainWin::_GetMinimumWindowSize(int&amp; width, int&amp; height) const</a>
<a name="ln1763">{</a>
<a name="ln1764">	width = MIN_WIDTH;</a>
<a name="ln1765">	height = 0;</a>
<a name="ln1766">	if (!fNoInterface) {</a>
<a name="ln1767">		width = max_c(width, fMenuBarWidth);</a>
<a name="ln1768">		width = max_c(width, fControlsWidth);</a>
<a name="ln1769">		height = fMenuBarHeight + fControlsHeight;</a>
<a name="ln1770">	}</a>
<a name="ln1771">}</a>
<a name="ln1772"> </a>
<a name="ln1773"> </a>
<a name="ln1774">void</a>
<a name="ln1775">MainWin::_GetUnscaledVideoSize(int&amp; videoWidth, int&amp; videoHeight) const</a>
<a name="ln1776">{</a>
<a name="ln1777">	if (fWidthAspect != 0 &amp;&amp; fHeightAspect != 0) {</a>
<a name="ln1778">		videoWidth = fSourceHeight * fWidthAspect / fHeightAspect;</a>
<a name="ln1779">		videoHeight = fSourceWidth * fHeightAspect / fWidthAspect;</a>
<a name="ln1780">		// Use the scaling which produces an enlarged view.</a>
<a name="ln1781">		if (videoWidth &gt; fSourceWidth) {</a>
<a name="ln1782">			// Enlarge width</a>
<a name="ln1783">			videoHeight = fSourceHeight;</a>
<a name="ln1784">		} else {</a>
<a name="ln1785">			// Enlarge height</a>
<a name="ln1786">			videoWidth = fSourceWidth;</a>
<a name="ln1787">		}</a>
<a name="ln1788">	} else {</a>
<a name="ln1789">		videoWidth = fSourceWidth;</a>
<a name="ln1790">		videoHeight = fSourceHeight;</a>
<a name="ln1791">	}</a>
<a name="ln1792">}</a>
<a name="ln1793"> </a>
<a name="ln1794"> </a>
<a name="ln1795">void</a>
<a name="ln1796">MainWin::_SetWindowSizeLimits()</a>
<a name="ln1797">{</a>
<a name="ln1798">	int minWidth;</a>
<a name="ln1799">	int minHeight;</a>
<a name="ln1800">	_GetMinimumWindowSize(minWidth, minHeight);</a>
<a name="ln1801">	SetSizeLimits(minWidth - 1, 32000, minHeight - 1,</a>
<a name="ln1802">		fHasVideo ? 32000 : minHeight - 1);</a>
<a name="ln1803">}</a>
<a name="ln1804"> </a>
<a name="ln1805"> </a>
<a name="ln1806">int</a>
<a name="ln1807">MainWin::_CurrentVideoSizeInPercent() const</a>
<a name="ln1808">{</a>
<a name="ln1809">	if (!fHasVideo)</a>
<a name="ln1810">		return 0;</a>
<a name="ln1811"> </a>
<a name="ln1812">	int videoWidth;</a>
<a name="ln1813">	int videoHeight;</a>
<a name="ln1814">	_GetUnscaledVideoSize(videoWidth, videoHeight);</a>
<a name="ln1815"> </a>
<a name="ln1816">	int viewWidth = fVideoView-&gt;Bounds().IntegerWidth() + 1;</a>
<a name="ln1817">	int viewHeight = fVideoView-&gt;Bounds().IntegerHeight() + 1;</a>
<a name="ln1818"> </a>
<a name="ln1819">	int widthPercent = viewWidth * 100 / videoWidth;</a>
<a name="ln1820">	int heightPercent = viewHeight * 100 / videoHeight;</a>
<a name="ln1821"> </a>
<a name="ln1822">	if (widthPercent &gt; heightPercent)</a>
<a name="ln1823">		return widthPercent;</a>
<a name="ln1824">	return heightPercent;</a>
<a name="ln1825">}</a>
<a name="ln1826"> </a>
<a name="ln1827"> </a>
<a name="ln1828">void</a>
<a name="ln1829">MainWin::_ZoomVideoView(int percentDiff)</a>
<a name="ln1830">{</a>
<a name="ln1831">	if (!fHasVideo)</a>
<a name="ln1832">		return;</a>
<a name="ln1833"> </a>
<a name="ln1834">	int percent = _CurrentVideoSizeInPercent();</a>
<a name="ln1835">	int newSize = percent * (100 + percentDiff) / 100;</a>
<a name="ln1836"> </a>
<a name="ln1837">	if (newSize &lt; 25)</a>
<a name="ln1838">		newSize = 25;</a>
<a name="ln1839">	if (newSize &gt; 400)</a>
<a name="ln1840">		newSize = 400;</a>
<a name="ln1841">	if (newSize != percent) {</a>
<a name="ln1842">		BMessage message(M_VIEW_SIZE);</a>
<a name="ln1843">		message.AddInt32(&quot;size&quot;, newSize);</a>
<a name="ln1844">		PostMessage(&amp;message);</a>
<a name="ln1845">	}</a>
<a name="ln1846">}</a>
<a name="ln1847"> </a>
<a name="ln1848"> </a>
<a name="ln1849">void</a>
<a name="ln1850">MainWin::_ResizeWindow(int percent, bool useNoVideoWidth, bool stayOnScreen)</a>
<a name="ln1851">{</a>
<a name="ln1852">	// Get required window size</a>
<a name="ln1853">	int videoWidth;</a>
<a name="ln1854">	int videoHeight;</a>
<a name="ln1855">	_GetUnscaledVideoSize(videoWidth, videoHeight);</a>
<a name="ln1856"> </a>
<a name="ln1857">	videoWidth = (videoWidth * percent) / 100;</a>
<a name="ln1858">	videoHeight = (videoHeight * percent) / 100;</a>
<a name="ln1859"> </a>
<a name="ln1860">	// Calculate and set the minimum window size</a>
<a name="ln1861">	int width;</a>
<a name="ln1862">	int height;</a>
<a name="ln1863">	_GetMinimumWindowSize(width, height);</a>
<a name="ln1864"> </a>
<a name="ln1865">	width = max_c(width, videoWidth) - 1;</a>
<a name="ln1866">	if (useNoVideoWidth)</a>
<a name="ln1867">		width = max_c(width, fNoVideoWidth);</a>
<a name="ln1868">	height = height + videoHeight - 1;</a>
<a name="ln1869"> </a>
<a name="ln1870">	if (stayOnScreen) {</a>
<a name="ln1871">		BRect screenFrame(BScreen(this).Frame());</a>
<a name="ln1872">		BRect frame(Frame());</a>
<a name="ln1873">		BRect decoratorFrame(DecoratorFrame());</a>
<a name="ln1874"> </a>
<a name="ln1875">		// Shrink the screen frame by the window border size</a>
<a name="ln1876">		screenFrame.top += frame.top - decoratorFrame.top;</a>
<a name="ln1877">		screenFrame.left += frame.left - decoratorFrame.left;</a>
<a name="ln1878">		screenFrame.right += frame.right - decoratorFrame.right;</a>
<a name="ln1879">		screenFrame.bottom += frame.bottom - decoratorFrame.bottom;</a>
<a name="ln1880"> </a>
<a name="ln1881">		// Update frame to what the new size would be</a>
<a name="ln1882">		frame.right = frame.left + width;</a>
<a name="ln1883">		frame.bottom = frame.top + height;</a>
<a name="ln1884"> </a>
<a name="ln1885">		if (!screenFrame.Contains(frame)) {</a>
<a name="ln1886">			// Resize the window so it doesn't extend outside the current</a>
<a name="ln1887">			// screen frame.</a>
<a name="ln1888">			// We don't use BWindow::MoveOnScreen() in order to resize the</a>
<a name="ln1889">			// window while keeping the same aspect ratio.</a>
<a name="ln1890">			if (frame.Width() &gt; screenFrame.Width()</a>
<a name="ln1891">				|| frame.Height() &gt; screenFrame.Height()) {</a>
<a name="ln1892">				// too large</a>
<a name="ln1893">				int widthDiff</a>
<a name="ln1894">					= frame.IntegerWidth() - screenFrame.IntegerWidth();</a>
<a name="ln1895">				int heightDiff</a>
<a name="ln1896">					= frame.IntegerHeight() - screenFrame.IntegerHeight();</a>
<a name="ln1897"> </a>
<a name="ln1898">				float shrinkScale;</a>
<a name="ln1899">				if (widthDiff &gt; heightDiff)</a>
<a name="ln1900">					shrinkScale = (float)(width - widthDiff) / width;</a>
<a name="ln1901">				else</a>
<a name="ln1902">					shrinkScale = (float)(height - heightDiff) / height;</a>
<a name="ln1903"> </a>
<a name="ln1904">				// Resize width/height and center window</a>
<a name="ln1905">				width = lround(width * shrinkScale);</a>
<a name="ln1906">				height = lround(height * shrinkScale);</a>
<a name="ln1907">				MoveTo((screenFrame.left + screenFrame.right - width) / 2,</a>
<a name="ln1908">					(screenFrame.top + screenFrame.bottom - height) / 2);</a>
<a name="ln1909">			} else {</a>
<a name="ln1910">				// just off-screen on one or more sides</a>
<a name="ln1911">				int offsetX = 0;</a>
<a name="ln1912">				int offsetY = 0;</a>
<a name="ln1913">				if (frame.left &lt; screenFrame.left)</a>
<a name="ln1914">					offsetX = (int)(screenFrame.left - frame.left);</a>
<a name="ln1915">				else if (frame.right &gt; screenFrame.right)</a>
<a name="ln1916">					offsetX = (int)(screenFrame.right - frame.right);</a>
<a name="ln1917">				if (frame.top &lt; screenFrame.top)</a>
<a name="ln1918">					offsetY = (int)(screenFrame.top - frame.top);</a>
<a name="ln1919">				else if (frame.bottom &gt; screenFrame.bottom)</a>
<a name="ln1920">					offsetY = (int)(screenFrame.bottom - frame.bottom);</a>
<a name="ln1921">				MoveBy(offsetX, offsetY);</a>
<a name="ln1922">			}</a>
<a name="ln1923">		}</a>
<a name="ln1924">	}</a>
<a name="ln1925"> </a>
<a name="ln1926">	ResizeTo(width, height);</a>
<a name="ln1927">}</a>
<a name="ln1928"> </a>
<a name="ln1929"> </a>
<a name="ln1930">void</a>
<a name="ln1931">MainWin::_ResizeVideoView(int x, int y, int width, int height)</a>
<a name="ln1932">{</a>
<a name="ln1933">	// Keep aspect ratio, place video view inside</a>
<a name="ln1934">	// the background area (may create black bars).</a>
<a name="ln1935">	int videoWidth;</a>
<a name="ln1936">	int videoHeight;</a>
<a name="ln1937">	_GetUnscaledVideoSize(videoWidth, videoHeight);</a>
<a name="ln1938">	float scaledWidth  = videoWidth;</a>
<a name="ln1939">	float scaledHeight = videoHeight;</a>
<a name="ln1940">	float factor = min_c(width / scaledWidth, height / scaledHeight);</a>
<a name="ln1941">	int renderWidth = lround(scaledWidth * factor);</a>
<a name="ln1942">	int renderHeight = lround(scaledHeight * factor);</a>
<a name="ln1943">	if (renderWidth &gt; width)</a>
<a name="ln1944">		renderWidth = width;</a>
<a name="ln1945">	if (renderHeight &gt; height)</a>
<a name="ln1946">		renderHeight = height;</a>
<a name="ln1947"> </a>
<a name="ln1948">	int xOffset = (width - renderWidth) / 2;</a>
<a name="ln1949">	int yOffset = (height - renderHeight) / 2;</a>
<a name="ln1950"> </a>
<a name="ln1951">	fVideoView-&gt;MoveTo(x, y);</a>
<a name="ln1952">	fVideoView-&gt;ResizeTo(width - 1, height - 1);</a>
<a name="ln1953"> </a>
<a name="ln1954">	BRect videoFrame(xOffset, yOffset,</a>
<a name="ln1955">		xOffset + renderWidth - 1, yOffset + renderHeight - 1);</a>
<a name="ln1956"> </a>
<a name="ln1957">	fVideoView-&gt;SetVideoFrame(videoFrame);</a>
<a name="ln1958">	fVideoView-&gt;SetSubTitleMaxBottom(height - 1);</a>
<a name="ln1959">}</a>
<a name="ln1960"> </a>
<a name="ln1961"> </a>
<a name="ln1962">// #pragma mark -</a>
<a name="ln1963"> </a>
<a name="ln1964"> </a>
<a name="ln1965">void</a>
<a name="ln1966">MainWin::_MouseDown(BMessage* msg, BView* originalHandler)</a>
<a name="ln1967">{</a>
<a name="ln1968">	uint32 buttons = msg-&gt;FindInt32(&quot;buttons&quot;);</a>
<a name="ln1969"> </a>
<a name="ln1970">	// On Zeta, only &quot;screen_where&quot; is reliable, &quot;where&quot; and &quot;be:view_where&quot;</a>
<a name="ln1971">	// seem to be broken</a>
<a name="ln1972">	BPoint screenWhere;</a>
<a name="ln1973">	if (msg-&gt;FindPoint(&quot;screen_where&quot;, &amp;screenWhere) != B_OK) {</a>
<a name="ln1974">		// TODO: remove</a>
<a name="ln1975">		// Workaround for BeOS R5, it has no &quot;screen_where&quot;</a>
<a name="ln1976">		if (!originalHandler || msg-&gt;FindPoint(&quot;where&quot;, &amp;screenWhere) &lt; B_OK)</a>
<a name="ln1977">			return;</a>
<a name="ln1978">		originalHandler-&gt;ConvertToScreen(&amp;screenWhere);</a>
<a name="ln1979">	}</a>
<a name="ln1980"> </a>
<a name="ln1981">	// double click handling</a>
<a name="ln1982"> </a>
<a name="ln1983">	if (msg-&gt;FindInt32(&quot;clicks&quot;) % 2 == 0) {</a>
<a name="ln1984">		BRect rect(screenWhere.x - 1, screenWhere.y - 1, screenWhere.x + 1,</a>
<a name="ln1985">			screenWhere.y + 1);</a>
<a name="ln1986">		if (rect.Contains(fMouseDownMousePos)) {</a>
<a name="ln1987">			if (buttons == B_PRIMARY_MOUSE_BUTTON)</a>
<a name="ln1988">				PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln1989">			else if (buttons == B_SECONDARY_MOUSE_BUTTON)</a>
<a name="ln1990">				PostMessage(M_TOGGLE_NO_INTERFACE);</a>
<a name="ln1991"> </a>
<a name="ln1992">			return;</a>
<a name="ln1993">		}</a>
<a name="ln1994">	}</a>
<a name="ln1995"> </a>
<a name="ln1996">	fMouseDownMousePos = screenWhere;</a>
<a name="ln1997">	fMouseDownWindowPos = Frame().LeftTop();</a>
<a name="ln1998"> </a>
<a name="ln1999">	if (buttons == B_PRIMARY_MOUSE_BUTTON &amp;&amp; !fIsFullscreen) {</a>
<a name="ln2000">		// start mouse tracking</a>
<a name="ln2001">		fVideoView-&gt;SetMouseEventMask(B_POINTER_EVENTS | B_NO_POINTER_HISTORY</a>
<a name="ln2002">			/* | B_LOCK_WINDOW_FOCUS */);</a>
<a name="ln2003">		fMouseDownTracking = true;</a>
<a name="ln2004">	}</a>
<a name="ln2005"> </a>
<a name="ln2006">	// pop up a context menu if right mouse button is down</a>
<a name="ln2007"> </a>
<a name="ln2008">	if ((buttons &amp; B_SECONDARY_MOUSE_BUTTON) != 0)</a>
<a name="ln2009">		_ShowContextMenu(screenWhere);</a>
<a name="ln2010">}</a>
<a name="ln2011"> </a>
<a name="ln2012"> </a>
<a name="ln2013">void</a>
<a name="ln2014">MainWin::_MouseMoved(BMessage* msg, BView* originalHandler)</a>
<a name="ln2015">{</a>
<a name="ln2016">//	msg-&gt;PrintToStream();</a>
<a name="ln2017"> </a>
<a name="ln2018">	BPoint mousePos;</a>
<a name="ln2019">	uint32 buttons = msg-&gt;FindInt32(&quot;buttons&quot;);</a>
<a name="ln2020">	// On Zeta, only &quot;screen_where&quot; is reliable, &quot;where&quot;</a>
<a name="ln2021">	// and &quot;be:view_where&quot; seem to be broken</a>
<a name="ln2022">	if (msg-&gt;FindPoint(&quot;screen_where&quot;, &amp;mousePos) != B_OK) {</a>
<a name="ln2023">		// TODO: remove</a>
<a name="ln2024">		// Workaround for BeOS R5, it has no &quot;screen_where&quot;</a>
<a name="ln2025">		if (!originalHandler || msg-&gt;FindPoint(&quot;where&quot;, &amp;mousePos) &lt; B_OK)</a>
<a name="ln2026">			return;</a>
<a name="ln2027">		originalHandler-&gt;ConvertToScreen(&amp;mousePos);</a>
<a name="ln2028">	}</a>
<a name="ln2029"> </a>
<a name="ln2030">	if (buttons == B_PRIMARY_MOUSE_BUTTON &amp;&amp; fMouseDownTracking</a>
<a name="ln2031">		&amp;&amp; !fIsFullscreen) {</a>
<a name="ln2032">//		printf(&quot;screen where: %.0f, %.0f =&gt; &quot;, mousePos.x, mousePos.y);</a>
<a name="ln2033">		float delta_x = mousePos.x - fMouseDownMousePos.x;</a>
<a name="ln2034">		float delta_y = mousePos.y - fMouseDownMousePos.y;</a>
<a name="ln2035">		float x = fMouseDownWindowPos.x + delta_x;</a>
<a name="ln2036">		float y = fMouseDownWindowPos.y + delta_y;</a>
<a name="ln2037">//		printf(&quot;move window to %.0f, %.0f\n&quot;, x, y);</a>
<a name="ln2038">		MoveTo(x, y);</a>
<a name="ln2039">	}</a>
<a name="ln2040"> </a>
<a name="ln2041">	bigtime_t eventTime;</a>
<a name="ln2042">	if (msg-&gt;FindInt64(&quot;when&quot;, &amp;eventTime) != B_OK)</a>
<a name="ln2043">		eventTime = system_time();</a>
<a name="ln2044"> </a>
<a name="ln2045">	if (buttons == 0 &amp;&amp; fIsFullscreen) {</a>
<a name="ln2046">		BPoint moveDelta = mousePos - fLastMousePos;</a>
<a name="ln2047">		float moveDeltaDist</a>
<a name="ln2048">			= sqrtf(moveDelta.x * moveDelta.x + moveDelta.y * moveDelta.y);</a>
<a name="ln2049">		if (eventTime - fLastMouseMovedTime &lt; 200000)</a>
<a name="ln2050">			fMouseMoveDist += moveDeltaDist;</a>
<a name="ln2051">		else</a>
<a name="ln2052">			fMouseMoveDist = moveDeltaDist;</a>
<a name="ln2053">		if (fMouseMoveDist &gt; 5)</a>
<a name="ln2054">			_ShowFullscreenControls(true);</a>
<a name="ln2055">	}</a>
<a name="ln2056"> </a>
<a name="ln2057">	fLastMousePos = mousePos;</a>
<a name="ln2058">	fLastMouseMovedTime =eventTime;</a>
<a name="ln2059">}</a>
<a name="ln2060"> </a>
<a name="ln2061"> </a>
<a name="ln2062">void</a>
<a name="ln2063">MainWin::_MouseUp(BMessage* msg)</a>
<a name="ln2064">{</a>
<a name="ln2065">	fMouseDownTracking = false;</a>
<a name="ln2066">}</a>
<a name="ln2067"> </a>
<a name="ln2068"> </a>
<a name="ln2069">void</a>
<a name="ln2070">MainWin::_ShowContextMenu(const BPoint&amp; screenPoint)</a>
<a name="ln2071">{</a>
<a name="ln2072">	printf(&quot;Show context menu\n&quot;);</a>
<a name="ln2073">	BPopUpMenu* menu = new BPopUpMenu(&quot;context menu&quot;, false, false);</a>
<a name="ln2074">	BMenuItem* item;</a>
<a name="ln2075">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Full screen&quot;),</a>
<a name="ln2076">		new BMessage(M_TOGGLE_FULLSCREEN), B_ENTER));</a>
<a name="ln2077">	item-&gt;SetMarked(fIsFullscreen);</a>
<a name="ln2078">	item-&gt;SetEnabled(fHasVideo);</a>
<a name="ln2079"> </a>
<a name="ln2080">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Hide interface&quot;),</a>
<a name="ln2081">		new BMessage(M_TOGGLE_NO_INTERFACE), 'H'));</a>
<a name="ln2082">	item-&gt;SetMarked(fNoInterface);</a>
<a name="ln2083">	item-&gt;SetEnabled(fHasVideo &amp;&amp; !fIsFullscreen);</a>
<a name="ln2084"> </a>
<a name="ln2085">	menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Always on top&quot;),</a>
<a name="ln2086">		new BMessage(M_TOGGLE_ALWAYS_ON_TOP), 'A'));</a>
<a name="ln2087">	item-&gt;SetMarked(fAlwaysOnTop);</a>
<a name="ln2088">	item-&gt;SetEnabled(fHasVideo);</a>
<a name="ln2089"> </a>
<a name="ln2090">	BMenu* aspectSubMenu = new BMenu(B_TRANSLATE(&quot;Aspect ratio&quot;));</a>
<a name="ln2091">	_SetupVideoAspectItems(aspectSubMenu);</a>
<a name="ln2092">	aspectSubMenu-&gt;SetTargetForItems(this);</a>
<a name="ln2093">	menu-&gt;AddItem(item = new BMenuItem(aspectSubMenu));</a>
<a name="ln2094">	item-&gt;SetEnabled(fHasVideo);</a>
<a name="ln2095"> </a>
<a name="ln2096">	menu-&gt;AddSeparatorItem();</a>
<a name="ln2097"> </a>
<a name="ln2098">	// Add track selector menus</a>
<a name="ln2099">	BMenu* audioTrackMenu = new BMenu(B_TRANSLATE(&quot;Audio track&quot;));</a>
<a name="ln2100">	BMenu* videoTrackMenu = new BMenu(B_TRANSLATE(&quot;Video track&quot;));</a>
<a name="ln2101">	BMenu* subTitleTrackMenu = new BMenu(B_TRANSLATE(&quot;Subtitles&quot;));</a>
<a name="ln2102">	_SetupTrackMenus(audioTrackMenu, videoTrackMenu, subTitleTrackMenu);</a>
<a name="ln2103"> </a>
<a name="ln2104">	audioTrackMenu-&gt;SetTargetForItems(this);</a>
<a name="ln2105">	videoTrackMenu-&gt;SetTargetForItems(this);</a>
<a name="ln2106">	subTitleTrackMenu-&gt;SetTargetForItems(this);</a>
<a name="ln2107"> </a>
<a name="ln2108">	menu-&gt;AddItem(item = new BMenuItem(audioTrackMenu));</a>
<a name="ln2109">	item-&gt;SetEnabled(fHasAudio);</a>
<a name="ln2110"> </a>
<a name="ln2111">	menu-&gt;AddItem(item = new BMenuItem(videoTrackMenu));</a>
<a name="ln2112">	item-&gt;SetEnabled(fHasVideo);</a>
<a name="ln2113"> </a>
<a name="ln2114">	menu-&gt;AddItem(item = new BMenuItem(subTitleTrackMenu));</a>
<a name="ln2115">	item-&gt;SetEnabled(fHasVideo);</a>
<a name="ln2116"> </a>
<a name="ln2117">	menu-&gt;AddSeparatorItem();</a>
<a name="ln2118">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Quit&quot;), new BMessage(M_FILE_QUIT), 'Q'));</a>
<a name="ln2119"> </a>
<a name="ln2120">	menu-&gt;SetTargetForItems(this);</a>
<a name="ln2121">	BRect rect(screenPoint.x - 5, screenPoint.y - 5, screenPoint.x + 5,</a>
<a name="ln2122">		screenPoint.y + 5);</a>
<a name="ln2123">	menu-&gt;Go(screenPoint, true, true, rect, true);</a>
<a name="ln2124">}</a>
<a name="ln2125"> </a>
<a name="ln2126"> </a>
<a name="ln2127">/*!	Trap keys that are about to be send to background or renderer view.</a>
<a name="ln2128">	Return true if it shouldn't be passed to the view.</a>
<a name="ln2129">*/</a>
<a name="ln2130">bool</a>
<a name="ln2131">MainWin::_KeyDown(BMessage* msg)</a>
<a name="ln2132">{</a>
<a name="ln2133">	uint32 key = msg-&gt;FindInt32(&quot;key&quot;);</a>
<a name="ln2134">	uint32 rawChar = msg-&gt;FindInt32(&quot;raw_char&quot;);</a>
<a name="ln2135">	uint32 modifier = msg-&gt;FindInt32(&quot;modifiers&quot;);</a>
<a name="ln2136"> </a>
<a name="ln2137">//	printf(&quot;key 0x%lx, rawChar 0x%lx, modifiers 0x%lx\n&quot;, key, rawChar,</a>
<a name="ln2138">//		modifier);</a>
<a name="ln2139"> </a>
<a name="ln2140">	// ignore the system modifier namespace</a>
<a name="ln2141">	if ((modifier &amp; (B_CONTROL_KEY | B_COMMAND_KEY))</a>
<a name="ln2142">			== (B_CONTROL_KEY | B_COMMAND_KEY))</a>
<a name="ln2143">		return false;</a>
<a name="ln2144"> </a>
<a name="ln2145">	switch (rawChar) {</a>
<a name="ln2146">		case B_SPACE:</a>
<a name="ln2147">			fController-&gt;TogglePlaying();</a>
<a name="ln2148">			return true;</a>
<a name="ln2149"> </a>
<a name="ln2150">		case 'm':</a>
<a name="ln2151">			fController-&gt;ToggleMute();</a>
<a name="ln2152">			return true;</a>
<a name="ln2153"> </a>
<a name="ln2154">		case B_ESCAPE:</a>
<a name="ln2155">			if (!fIsFullscreen)</a>
<a name="ln2156">				break;</a>
<a name="ln2157"> </a>
<a name="ln2158">			PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln2159">			return true;</a>
<a name="ln2160"> </a>
<a name="ln2161">		case B_ENTER:		// Enter / Return</a>
<a name="ln2162">			if ((modifier &amp; B_COMMAND_KEY) != 0) {</a>
<a name="ln2163">				PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln2164">				return true;</a>
<a name="ln2165">			}</a>
<a name="ln2166">			break;</a>
<a name="ln2167"> </a>
<a name="ln2168">		case B_TAB:</a>
<a name="ln2169">		case 'f':</a>
<a name="ln2170">			if ((modifier &amp; (B_COMMAND_KEY | B_CONTROL_KEY | B_OPTION_KEY</a>
<a name="ln2171">					| B_MENU_KEY)) == 0) {</a>
<a name="ln2172">				PostMessage(M_TOGGLE_FULLSCREEN);</a>
<a name="ln2173">				return true;</a>
<a name="ln2174">			}</a>
<a name="ln2175">			break;</a>
<a name="ln2176"> </a>
<a name="ln2177">		case B_UP_ARROW:</a>
<a name="ln2178">			if ((modifier &amp; B_COMMAND_KEY) != 0)</a>
<a name="ln2179">				PostMessage(M_SKIP_NEXT);</a>
<a name="ln2180">			else</a>
<a name="ln2181">				PostMessage(M_VOLUME_UP);</a>
<a name="ln2182">			return true;</a>
<a name="ln2183"> </a>
<a name="ln2184">		case B_DOWN_ARROW:</a>
<a name="ln2185">			if ((modifier &amp; B_COMMAND_KEY) != 0)</a>
<a name="ln2186">				PostMessage(M_SKIP_PREV);</a>
<a name="ln2187">			else</a>
<a name="ln2188">				PostMessage(M_VOLUME_DOWN);</a>
<a name="ln2189">			return true;</a>
<a name="ln2190"> </a>
<a name="ln2191">		case B_RIGHT_ARROW:</a>
<a name="ln2192">			if ((modifier &amp; B_COMMAND_KEY) != 0)</a>
<a name="ln2193">				PostMessage(M_SKIP_NEXT);</a>
<a name="ln2194">			else if (fAllowWinding) {</a>
<a name="ln2195">				BMessage windMessage(M_WIND);</a>
<a name="ln2196">				if ((modifier &amp; B_SHIFT_KEY) != 0) {</a>
<a name="ln2197">					windMessage.AddInt64(&quot;how much&quot;, 30000000LL);</a>
<a name="ln2198">					windMessage.AddInt64(&quot;frames&quot;, 5);</a>
<a name="ln2199">				} else {</a>
<a name="ln2200">					windMessage.AddInt64(&quot;how much&quot;, 5000000LL);</a>
<a name="ln2201">					windMessage.AddInt64(&quot;frames&quot;, 1);</a>
<a name="ln2202">				}</a>
<a name="ln2203">				PostMessage(&amp;windMessage);</a>
<a name="ln2204">			}</a>
<a name="ln2205">			return true;</a>
<a name="ln2206"> </a>
<a name="ln2207">		case B_LEFT_ARROW:</a>
<a name="ln2208">			if ((modifier &amp; B_COMMAND_KEY) != 0)</a>
<a name="ln2209">				PostMessage(M_SKIP_PREV);</a>
<a name="ln2210">			else if (fAllowWinding) {</a>
<a name="ln2211">				BMessage windMessage(M_WIND);</a>
<a name="ln2212">				if ((modifier &amp; B_SHIFT_KEY) != 0) {</a>
<a name="ln2213">					windMessage.AddInt64(&quot;how much&quot;, -30000000LL);</a>
<a name="ln2214">					windMessage.AddInt64(&quot;frames&quot;, -5);</a>
<a name="ln2215">				} else {</a>
<a name="ln2216">					windMessage.AddInt64(&quot;how much&quot;, -5000000LL);</a>
<a name="ln2217">					windMessage.AddInt64(&quot;frames&quot;, -1);</a>
<a name="ln2218">				}</a>
<a name="ln2219">				PostMessage(&amp;windMessage);</a>
<a name="ln2220">			}</a>
<a name="ln2221">			return true;</a>
<a name="ln2222"> </a>
<a name="ln2223">		case B_PAGE_UP:</a>
<a name="ln2224">			PostMessage(M_SKIP_NEXT);</a>
<a name="ln2225">			return true;</a>
<a name="ln2226"> </a>
<a name="ln2227">		case B_PAGE_DOWN:</a>
<a name="ln2228">			PostMessage(M_SKIP_PREV);</a>
<a name="ln2229">			return true;</a>
<a name="ln2230"> </a>
<a name="ln2231">		case '+':</a>
<a name="ln2232">			if ((modifier &amp; B_COMMAND_KEY) == 0) {</a>
<a name="ln2233">				_ZoomVideoView(10);</a>
<a name="ln2234">				return true;</a>
<a name="ln2235">			}</a>
<a name="ln2236">			break;</a>
<a name="ln2237"> </a>
<a name="ln2238">		case '-':</a>
<a name="ln2239">			if ((modifier &amp; B_COMMAND_KEY) == 0) {</a>
<a name="ln2240">				_ZoomVideoView(-10);</a>
<a name="ln2241">				return true;</a>
<a name="ln2242">			}</a>
<a name="ln2243">			break;</a>
<a name="ln2244"> </a>
<a name="ln2245">		case B_DELETE:</a>
<a name="ln2246">		case 'd': 			// d for delete</a>
<a name="ln2247">		case 't':			// t for Trash</a>
<a name="ln2248">			if ((modifiers() &amp; B_COMMAND_KEY) != 0) {</a>
<a name="ln2249">				BAutolock _(fPlaylist);</a>
<a name="ln2250">				BMessage removeMessage(M_PLAYLIST_MOVE_TO_TRASH);</a>
<a name="ln2251">				removeMessage.AddInt32(&quot;playlist index&quot;,</a>
<a name="ln2252">					fPlaylist-&gt;CurrentItemIndex());</a>
<a name="ln2253">				fPlaylistWindow-&gt;PostMessage(&amp;removeMessage);</a>
<a name="ln2254">				return true;</a>
<a name="ln2255">			}</a>
<a name="ln2256">			break;</a>
<a name="ln2257">	}</a>
<a name="ln2258"> </a>
<a name="ln2259">	switch (key) {</a>
<a name="ln2260">		case 0x3a:  		// numeric keypad +</a>
<a name="ln2261">			if ((modifier &amp; B_COMMAND_KEY) == 0) {</a>
<a name="ln2262">				_ZoomVideoView(10);</a>
<a name="ln2263">				return true;</a>
<a name="ln2264">			}</a>
<a name="ln2265">			break;</a>
<a name="ln2266"> </a>
<a name="ln2267">		case 0x25:  		// numeric keypad -</a>
<a name="ln2268">			if ((modifier &amp; B_COMMAND_KEY) == 0) {</a>
<a name="ln2269">				_ZoomVideoView(-10);</a>
<a name="ln2270">				return true;</a>
<a name="ln2271">			}</a>
<a name="ln2272">			break;</a>
<a name="ln2273"> </a>
<a name="ln2274">		case 0x38:			// numeric keypad up arrow</a>
<a name="ln2275">			PostMessage(M_VOLUME_UP);</a>
<a name="ln2276">			return true;</a>
<a name="ln2277"> </a>
<a name="ln2278">		case 0x59:			// numeric keypad down arrow</a>
<a name="ln2279">			PostMessage(M_VOLUME_DOWN);</a>
<a name="ln2280">			return true;</a>
<a name="ln2281"> </a>
<a name="ln2282">		case 0x39:			// numeric keypad page up</a>
<a name="ln2283">		case 0x4a:			// numeric keypad right arrow</a>
<a name="ln2284">			PostMessage(M_SKIP_NEXT);</a>
<a name="ln2285">			return true;</a>
<a name="ln2286"> </a>
<a name="ln2287">		case 0x5a:			// numeric keypad page down</a>
<a name="ln2288">		case 0x48:			// numeric keypad left arrow</a>
<a name="ln2289">			PostMessage(M_SKIP_PREV);</a>
<a name="ln2290">			return true;</a>
<a name="ln2291"> </a>
<a name="ln2292">		// Playback controls along the bottom of the keyboard:</a>
<a name="ln2293">		// Z X C (V) B  for US International</a>
<a name="ln2294">		case 0x4c:</a>
<a name="ln2295">			PostMessage(M_SKIP_PREV);</a>
<a name="ln2296">			return true;</a>
<a name="ln2297">		case 0x4d:</a>
<a name="ln2298">			fController-&gt;TogglePlaying();</a>
<a name="ln2299">			return true;</a>
<a name="ln2300">		case 0x4e:</a>
<a name="ln2301">			fController-&gt;Pause();</a>
<a name="ln2302">			return true;</a>
<a name="ln2303">		case 0x4f:</a>
<a name="ln2304">			fController-&gt;Stop();</a>
<a name="ln2305">			return true;</a>
<a name="ln2306">		case 0x50:</a>
<a name="ln2307">			PostMessage(M_SKIP_NEXT);</a>
<a name="ln2308">			return true;</a>
<a name="ln2309">	}</a>
<a name="ln2310"> </a>
<a name="ln2311">	return false;</a>
<a name="ln2312">}</a>
<a name="ln2313"> </a>
<a name="ln2314"> </a>
<a name="ln2315">// #pragma mark -</a>
<a name="ln2316"> </a>
<a name="ln2317"> </a>
<a name="ln2318">void</a>
<a name="ln2319">MainWin::_ToggleFullscreen()</a>
<a name="ln2320">{</a>
<a name="ln2321">	printf(&quot;_ToggleFullscreen enter\n&quot;);</a>
<a name="ln2322"> </a>
<a name="ln2323">	if (!fHasVideo) {</a>
<a name="ln2324">		printf(&quot;_ToggleFullscreen - ignoring, as we don't have a video\n&quot;);</a>
<a name="ln2325">		return;</a>
<a name="ln2326">	}</a>
<a name="ln2327"> </a>
<a name="ln2328">	fIsFullscreen = !fIsFullscreen;</a>
<a name="ln2329"> </a>
<a name="ln2330">	if (fIsFullscreen) {</a>
<a name="ln2331">		// switch to fullscreen</a>
<a name="ln2332"> </a>
<a name="ln2333">		fSavedFrame = Frame();</a>
<a name="ln2334">		printf(&quot;saving current frame: %d %d %d %d\n&quot;, int(fSavedFrame.left),</a>
<a name="ln2335">			int(fSavedFrame.top), int(fSavedFrame.right),</a>
<a name="ln2336">			int(fSavedFrame.bottom));</a>
<a name="ln2337">		BScreen screen(this);</a>
<a name="ln2338">		BRect rect(screen.Frame());</a>
<a name="ln2339"> </a>
<a name="ln2340">		Hide();</a>
<a name="ln2341">		MoveTo(rect.left, rect.top);</a>
<a name="ln2342">		ResizeTo(rect.Width(), rect.Height());</a>
<a name="ln2343">		Show();</a>
<a name="ln2344"> </a>
<a name="ln2345">	} else {</a>
<a name="ln2346">		// switch back from full screen mode</a>
<a name="ln2347">		_ShowFullscreenControls(false, false);</a>
<a name="ln2348"> </a>
<a name="ln2349">		Hide();</a>
<a name="ln2350">		MoveTo(fSavedFrame.left, fSavedFrame.top);</a>
<a name="ln2351">		ResizeTo(fSavedFrame.Width(), fSavedFrame.Height());</a>
<a name="ln2352">		Show();</a>
<a name="ln2353">	}</a>
<a name="ln2354"> </a>
<a name="ln2355">	fVideoView-&gt;SetFullscreen(fIsFullscreen);</a>
<a name="ln2356"> </a>
<a name="ln2357">	_MarkItem(fFileMenu, M_TOGGLE_FULLSCREEN, fIsFullscreen);</a>
<a name="ln2358"> </a>
<a name="ln2359">	printf(&quot;_ToggleFullscreen leave\n&quot;);</a>
<a name="ln2360">}</a>
<a name="ln2361"> </a>
<a name="ln2362">void</a>
<a name="ln2363">MainWin::_ToggleAlwaysOnTop()</a>
<a name="ln2364">{</a>
<a name="ln2365">	fAlwaysOnTop = !fAlwaysOnTop;</a>
<a name="ln2366">	SetFeel(fAlwaysOnTop ? B_FLOATING_ALL_WINDOW_FEEL : B_NORMAL_WINDOW_FEEL);</a>
<a name="ln2367"> </a>
<a name="ln2368">	_MarkItem(fFileMenu, M_TOGGLE_ALWAYS_ON_TOP, fAlwaysOnTop);</a>
<a name="ln2369">}</a>
<a name="ln2370"> </a>
<a name="ln2371"> </a>
<a name="ln2372">void</a>
<a name="ln2373">MainWin::_ToggleNoInterface()</a>
<a name="ln2374">{</a>
<a name="ln2375">	printf(&quot;_ToggleNoInterface enter\n&quot;);</a>
<a name="ln2376"> </a>
<a name="ln2377">	if (fIsFullscreen || !fHasVideo) {</a>
<a name="ln2378">		// Fullscreen playback is always without interface and</a>
<a name="ln2379">		// audio playback is always with interface. So we ignore these</a>
<a name="ln2380">		// two states here.</a>
<a name="ln2381">		printf(&quot;_ToggleNoControls leave, doing nothing, we are fullscreen\n&quot;);</a>
<a name="ln2382">		return;</a>
<a name="ln2383">	}</a>
<a name="ln2384"> </a>
<a name="ln2385">	fNoInterface = !fNoInterface;</a>
<a name="ln2386">	_SetWindowSizeLimits();</a>
<a name="ln2387"> </a>
<a name="ln2388">	if (fNoInterface) {</a>
<a name="ln2389">		MoveBy(0, fMenuBarHeight);</a>
<a name="ln2390">		ResizeBy(0, -(fControlsHeight + fMenuBarHeight));</a>
<a name="ln2391">		SetLook(B_BORDERED_WINDOW_LOOK);</a>
<a name="ln2392">	} else {</a>
<a name="ln2393">		MoveBy(0, -fMenuBarHeight);</a>
<a name="ln2394">		ResizeBy(0, fControlsHeight + fMenuBarHeight);</a>
<a name="ln2395">		SetLook(B_TITLED_WINDOW_LOOK);</a>
<a name="ln2396">	}</a>
<a name="ln2397"> </a>
<a name="ln2398">	_MarkItem(fFileMenu, M_TOGGLE_NO_INTERFACE, fNoInterface);</a>
<a name="ln2399"> </a>
<a name="ln2400">	printf(&quot;_ToggleNoInterface leave\n&quot;);</a>
<a name="ln2401">}</a>
<a name="ln2402"> </a>
<a name="ln2403"> </a>
<a name="ln2404">void</a>
<a name="ln2405">MainWin::_ShowIfNeeded()</a>
<a name="ln2406">{</a>
<a name="ln2407">	// Only proceed if the window is already running</a>
<a name="ln2408">	if (find_thread(NULL) != Thread())</a>
<a name="ln2409">		return;</a>
<a name="ln2410"> </a>
<a name="ln2411">	if (!fHasVideo &amp;&amp; fNoVideoFrame.IsValid()) {</a>
<a name="ln2412">		MoveTo(fNoVideoFrame.LeftTop());</a>
<a name="ln2413">		ResizeTo(fNoVideoFrame.Width(), fNoVideoFrame.Height());</a>
<a name="ln2414">		MoveOnScreen(B_MOVE_IF_PARTIALLY_OFFSCREEN);</a>
<a name="ln2415">	} else if (fHasVideo &amp;&amp; IsHidden())</a>
<a name="ln2416">		CenterOnScreen();</a>
<a name="ln2417"> </a>
<a name="ln2418">	fNoVideoFrame = BRect();</a>
<a name="ln2419"> </a>
<a name="ln2420">	if (IsHidden()) {</a>
<a name="ln2421">		Show();</a>
<a name="ln2422">		UpdateIfNeeded();</a>
<a name="ln2423">	}</a>
<a name="ln2424">}</a>
<a name="ln2425"> </a>
<a name="ln2426"> </a>
<a name="ln2427">void</a>
<a name="ln2428">MainWin::_ShowFullscreenControls(bool show, bool animate)</a>
<a name="ln2429">{</a>
<a name="ln2430">	if (fShowsFullscreenControls == show)</a>
<a name="ln2431">		return;</a>
<a name="ln2432"> </a>
<a name="ln2433">	fShowsFullscreenControls = show;</a>
<a name="ln2434">	fVideoView-&gt;SetFullscreenControlsVisible(show);</a>
<a name="ln2435"> </a>
<a name="ln2436">	if (show) {</a>
<a name="ln2437">		fControls-&gt;RemoveSelf();</a>
<a name="ln2438">		fControls-&gt;MoveTo(fVideoView-&gt;Bounds().left,</a>
<a name="ln2439">			fVideoView-&gt;Bounds().bottom + 1);</a>
<a name="ln2440">		fVideoView-&gt;AddChild(fControls);</a>
<a name="ln2441">		if (fScaleFullscreenControls)</a>
<a name="ln2442">			fControls-&gt;SetSymbolScale(1.5f);</a>
<a name="ln2443"> </a>
<a name="ln2444">		while (fControls-&gt;IsHidden())</a>
<a name="ln2445">			fControls-&gt;Show();</a>
<a name="ln2446">	}</a>
<a name="ln2447"> </a>
<a name="ln2448">	if (animate) {</a>
<a name="ln2449">		// Slide the controls into view. We need to do this with</a>
<a name="ln2450">		// messages, otherwise we block the video playback for the</a>
<a name="ln2451">		// time of the animation.</a>
<a name="ln2452">		const float kAnimationOffsets[] = { 0.05, 0.2, 0.5, 0.2, 0.05 };</a>
<a name="ln2453">		const int32 steps = sizeof(kAnimationOffsets) / sizeof(float);</a>
<a name="ln2454">		float height = fControls-&gt;Bounds().Height();</a>
<a name="ln2455">		float moveDist = show ? -height : height;</a>
<a name="ln2456">		float originalY = fControls-&gt;Frame().top;</a>
<a name="ln2457">		for (int32 i = 0; i &lt; steps; i++) {</a>
<a name="ln2458">			BMessage message(M_SLIDE_CONTROLS);</a>
<a name="ln2459">			message.AddFloat(&quot;offset&quot;,</a>
<a name="ln2460">				floorf(moveDist * kAnimationOffsets[i]));</a>
<a name="ln2461">			PostMessage(&amp;message, this);</a>
<a name="ln2462">		}</a>
<a name="ln2463">		BMessage finalMessage(M_FINISH_SLIDING_CONTROLS);</a>
<a name="ln2464">		finalMessage.AddFloat(&quot;offset&quot;, originalY + moveDist);</a>
<a name="ln2465">		finalMessage.AddBool(&quot;show&quot;, show);</a>
<a name="ln2466">		PostMessage(&amp;finalMessage, this);</a>
<a name="ln2467">	} else if (!show) {</a>
<a name="ln2468">		fControls-&gt;RemoveSelf();</a>
<a name="ln2469">		fControls-&gt;MoveTo(fVideoView-&gt;Frame().left,</a>
<a name="ln2470">			fVideoView-&gt;Frame().bottom + 1);</a>
<a name="ln2471">		fBackground-&gt;AddChild(fControls);</a>
<a name="ln2472">		fControls-&gt;SetSymbolScale(1.0f);</a>
<a name="ln2473"> </a>
<a name="ln2474">		while (!fControls-&gt;IsHidden())</a>
<a name="ln2475">			fControls-&gt;Hide();</a>
<a name="ln2476">	}</a>
<a name="ln2477">}</a>
<a name="ln2478"> </a>
<a name="ln2479"> </a>
<a name="ln2480">// #pragma mark -</a>
<a name="ln2481"> </a>
<a name="ln2482"> </a>
<a name="ln2483">void</a>
<a name="ln2484">MainWin::_Wind(bigtime_t howMuch, int64 frames)</a>
<a name="ln2485">{</a>
<a name="ln2486">	if (!fAllowWinding || !fController-&gt;Lock())</a>
<a name="ln2487">		return;</a>
<a name="ln2488"> </a>
<a name="ln2489">	if (frames != 0 &amp;&amp; fHasVideo &amp;&amp; !fController-&gt;IsPlaying()) {</a>
<a name="ln2490">		int64 newFrame = fController-&gt;CurrentFrame() + frames;</a>
<a name="ln2491">		fController-&gt;SetFramePosition(newFrame);</a>
<a name="ln2492">	} else {</a>
<a name="ln2493">		bigtime_t seekTime = fController-&gt;TimePosition() + howMuch;</a>
<a name="ln2494">		if (seekTime &lt; 0) {</a>
<a name="ln2495">			fInitialSeekPosition = seekTime;</a>
<a name="ln2496">			PostMessage(M_SKIP_PREV);</a>
<a name="ln2497">		} else if (seekTime &gt; fController-&gt;TimeDuration()) {</a>
<a name="ln2498">			fInitialSeekPosition = 0;</a>
<a name="ln2499">			PostMessage(M_SKIP_NEXT);</a>
<a name="ln2500">		} else</a>
<a name="ln2501">			fController-&gt;SetTimePosition(seekTime);</a>
<a name="ln2502">	}</a>
<a name="ln2503"> </a>
<a name="ln2504">	fController-&gt;Unlock();</a>
<a name="ln2505">	fAllowWinding = false;</a>
<a name="ln2506">}</a>
<a name="ln2507"> </a>
<a name="ln2508"> </a>
<a name="ln2509">// #pragma mark -</a>
<a name="ln2510"> </a>
<a name="ln2511"> </a>
<a name="ln2512">void</a>
<a name="ln2513">MainWin::_UpdatePlaylistItemFile()</a>
<a name="ln2514">{</a>
<a name="ln2515">	BAutolock locker(fPlaylist);</a>
<a name="ln2516">	const FilePlaylistItem* item</a>
<a name="ln2517">		= dynamic_cast&lt;const FilePlaylistItem*&gt;(fController-&gt;Item());</a>
<a name="ln2518">	if (item == NULL)</a>
<a name="ln2519">		return;</a>
<a name="ln2520"> </a>
<a name="ln2521">	if (!fHasVideo &amp;&amp; !fHasAudio)</a>
<a name="ln2522">		return;</a>
<a name="ln2523"> </a>
<a name="ln2524">	BNode node(&amp;item-&gt;Ref());</a>
<a name="ln2525">	if (node.InitCheck())</a>
<a name="ln2526">		return;</a>
<a name="ln2527"> </a>
<a name="ln2528">	locker.Unlock();</a>
<a name="ln2529"> </a>
<a name="ln2530">	// Set some standard attributes of the currently played file.</a>
<a name="ln2531">	// This should only be a temporary solution.</a>
<a name="ln2532"> </a>
<a name="ln2533">	// Write duration</a>
<a name="ln2534">	const char* kDurationAttrName = &quot;Media:Length&quot;;</a>
<a name="ln2535">	attr_info info;</a>
<a name="ln2536">	status_t status = node.GetAttrInfo(kDurationAttrName, &amp;info);</a>
<a name="ln2537">	if (status != B_OK || info.size == 0) {</a>
<a name="ln2538">		bigtime_t duration = fController-&gt;TimeDuration();</a>
<a name="ln2539">		// TODO: Tracker does not seem to care about endian for scalar types</a>
<a name="ln2540">		node.WriteAttr(kDurationAttrName, B_INT64_TYPE, 0, &amp;duration,</a>
<a name="ln2541">			sizeof(int64));</a>
<a name="ln2542">	}</a>
<a name="ln2543"> </a>
<a name="ln2544">	// Write audio bitrate</a>
<a name="ln2545">	if (fHasAudio) {</a>
<a name="ln2546">		status = node.GetAttrInfo(&quot;Audio:Bitrate&quot;, &amp;info);</a>
<a name="ln2547">		if (status != B_OK || info.size == 0) {</a>
<a name="ln2548">			media_format format;</a>
<a name="ln2549">			if (fController-&gt;GetEncodedAudioFormat(&amp;format) == B_OK</a>
<a name="ln2550">				&amp;&amp; format.type == B_MEDIA_ENCODED_AUDIO) {</a>
<a name="ln2551">				int32 bitrate = (int32)(format.u.encoded_audio.bit_rate</a>
<a name="ln2552">					/ 1000);</a>
<a name="ln2553">				char text[256];</a>
<a name="ln2554">				snprintf(text, sizeof(text), &quot;%&quot; B_PRId32 &quot; kbit&quot;, bitrate);</a>
<a name="ln2555">				node.WriteAttr(&quot;Audio:Bitrate&quot;, B_STRING_TYPE, 0, text,</a>
<a name="ln2556">					strlen(text) + 1);</a>
<a name="ln2557">			}</a>
<a name="ln2558">		}</a>
<a name="ln2559">	}</a>
<a name="ln2560"> </a>
<a name="ln2561">	// Write video bitrate</a>
<a name="ln2562">	if (fHasVideo) {</a>
<a name="ln2563">		status = node.GetAttrInfo(&quot;Video:Bitrate&quot;, &amp;info);</a>
<a name="ln2564">		if (status != B_OK || info.size == 0) {</a>
<a name="ln2565">			media_format format;</a>
<a name="ln2566">			if (fController-&gt;GetEncodedVideoFormat(&amp;format) == B_OK</a>
<a name="ln2567">				&amp;&amp; format.type == B_MEDIA_ENCODED_VIDEO) {</a>
<a name="ln2568">				int32 bitrate = (int32)(format.u.encoded_video.avg_bit_rate</a>
<a name="ln2569">					/ 1000);</a>
<a name="ln2570">				char text[256];</a>
<a name="ln2571">				snprintf(text, sizeof(text), &quot;%&quot; B_PRId32 &quot; kbit&quot;, bitrate);</a>
<a name="ln2572">				node.WriteAttr(&quot;Video:Bitrate&quot;, B_STRING_TYPE, 0, text,</a>
<a name="ln2573">					strlen(text) + 1);</a>
<a name="ln2574">			}</a>
<a name="ln2575">		}</a>
<a name="ln2576">	}</a>
<a name="ln2577"> </a>
<a name="ln2578">	_UpdateAttributesMenu(node);</a>
<a name="ln2579">}</a>
<a name="ln2580"> </a>
<a name="ln2581"> </a>
<a name="ln2582">void</a>
<a name="ln2583">MainWin::_UpdateAttributesMenu(const BNode&amp; node)</a>
<a name="ln2584">{</a>
<a name="ln2585">	int32 rating = -1;</a>
<a name="ln2586"> </a>
<a name="ln2587">	attr_info info;</a>
<a name="ln2588">	status_t status = node.GetAttrInfo(kRatingAttrName, &amp;info);</a>
<a name="ln2589">	if (status == B_OK &amp;&amp; info.type == B_INT32_TYPE) {</a>
<a name="ln2590">		// Node has the Rating attribute.</a>
<a name="ln2591">		node.ReadAttr(kRatingAttrName, B_INT32_TYPE, 0, &amp;rating,</a>
<a name="ln2592">			sizeof(rating));</a>
<a name="ln2593">	}</a>
<a name="ln2594"> </a>
<a name="ln2595">	for (int32 i = 0; BMenuItem* item = fRatingMenu-&gt;ItemAt(i); i++)</a>
<a name="ln2596">		item-&gt;SetMarked(i + 1 == rating);</a>
<a name="ln2597">}</a>
<a name="ln2598"> </a>
<a name="ln2599"> </a>
<a name="ln2600">void</a>
<a name="ln2601">MainWin::_SetRating(int32 rating)</a>
<a name="ln2602">{</a>
<a name="ln2603">	BAutolock locker(fPlaylist);</a>
<a name="ln2604">	const FilePlaylistItem* item</a>
<a name="ln2605">		= dynamic_cast&lt;const FilePlaylistItem*&gt;(fController-&gt;Item());</a>
<a name="ln2606">	if (item == NULL)</a>
<a name="ln2607">		return;</a>
<a name="ln2608"> </a>
<a name="ln2609">	BNode node(&amp;item-&gt;Ref());</a>
<a name="ln2610">	if (node.InitCheck())</a>
<a name="ln2611">		return;</a>
<a name="ln2612"> </a>
<a name="ln2613">	locker.Unlock();</a>
<a name="ln2614"> </a>
<a name="ln2615">	node.WriteAttr(kRatingAttrName, B_INT32_TYPE, 0, &amp;rating, sizeof(rating));</a>
<a name="ln2616"> </a>
<a name="ln2617">	// TODO: The whole mechnism should work like this:</a>
<a name="ln2618">	// * There is already an attribute API for PlaylistItem, flesh it out!</a>
<a name="ln2619">	// * FilePlaylistItem node-monitors it's file somehow.</a>
<a name="ln2620">	// * FilePlaylistItem keeps attributes in sync and sends notications.</a>
<a name="ln2621">	// * MainWin updates the menu according to FilePlaylistItem notifications.</a>
<a name="ln2622">	// * PlaylistWin shows columns with attribute and other info.</a>
<a name="ln2623">	// * PlaylistWin updates also upon FilePlaylistItem notifications.</a>
<a name="ln2624">	// * This keeps attributes in sync when another app changes them.</a>
<a name="ln2625"> </a>
<a name="ln2626">	_UpdateAttributesMenu(node);</a>
<a name="ln2627">}</a>
<a name="ln2628"> </a>
<a name="ln2629"> </a>
<a name="ln2630">void</a>
<a name="ln2631">MainWin::_UpdateControlsEnabledStatus()</a>
<a name="ln2632">{</a>
<a name="ln2633">	uint32 enabledButtons = 0;</a>
<a name="ln2634">	if (fHasVideo || fHasAudio) {</a>
<a name="ln2635">		enabledButtons |= PLAYBACK_ENABLED | SEEK_ENABLED</a>
<a name="ln2636">			| SEEK_BACK_ENABLED | SEEK_FORWARD_ENABLED;</a>
<a name="ln2637">	}</a>
<a name="ln2638">	if (fHasAudio)</a>
<a name="ln2639">		enabledButtons |= VOLUME_ENABLED;</a>
<a name="ln2640"> </a>
<a name="ln2641">	BAutolock _(fPlaylist);</a>
<a name="ln2642">	bool canSkipPrevious, canSkipNext;</a>
<a name="ln2643">	fPlaylist-&gt;GetSkipInfo(&amp;canSkipPrevious, &amp;canSkipNext);</a>
<a name="ln2644">	if (canSkipPrevious)</a>
<a name="ln2645">		enabledButtons |= SKIP_BACK_ENABLED;</a>
<a name="ln2646">	if (canSkipNext)</a>
<a name="ln2647">		enabledButtons |= SKIP_FORWARD_ENABLED;</a>
<a name="ln2648"> </a>
<a name="ln2649">	fControls-&gt;SetEnabled(enabledButtons);</a>
<a name="ln2650"> </a>
<a name="ln2651">	fNoInterfaceMenuItem-&gt;SetEnabled(fHasVideo);</a>
<a name="ln2652">	fAttributesMenu-&gt;SetEnabled(fHasAudio || fHasVideo);</a>
<a name="ln2653">}</a>
<a name="ln2654"> </a>
<a name="ln2655"> </a>
<a name="ln2656">void</a>
<a name="ln2657">MainWin::_UpdatePlaylistMenu()</a>
<a name="ln2658">{</a>
<a name="ln2659">	if (!fPlaylist-&gt;Lock())</a>
<a name="ln2660">		return;</a>
<a name="ln2661"> </a>
<a name="ln2662">	fPlaylistMenu-&gt;RemoveItems(0, fPlaylistMenu-&gt;CountItems(), true);</a>
<a name="ln2663"> </a>
<a name="ln2664">	int32 count = fPlaylist-&gt;CountItems();</a>
<a name="ln2665">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln2666">		PlaylistItem* item = fPlaylist-&gt;ItemAtFast(i);</a>
<a name="ln2667">		_AddPlaylistItem(item, i);</a>
<a name="ln2668">	}</a>
<a name="ln2669">	fPlaylistMenu-&gt;SetTargetForItems(this);</a>
<a name="ln2670"> </a>
<a name="ln2671">	_MarkPlaylistItem(fPlaylist-&gt;CurrentItemIndex());</a>
<a name="ln2672"> </a>
<a name="ln2673">	fPlaylist-&gt;Unlock();</a>
<a name="ln2674">}</a>
<a name="ln2675"> </a>
<a name="ln2676"> </a>
<a name="ln2677">void</a>
<a name="ln2678">MainWin::_AddPlaylistItem(PlaylistItem* item, int32 index)</a>
<a name="ln2679">{</a>
<a name="ln2680">	BMessage* message = new BMessage(M_SET_PLAYLIST_POSITION);</a>
<a name="ln2681">	message-&gt;AddInt32(&quot;index&quot;, index);</a>
<a name="ln2682">	BMenuItem* menuItem = new BMenuItem(item-&gt;Name().String(), message);</a>
<a name="ln2683">	fPlaylistMenu-&gt;AddItem(menuItem, index);</a>
<a name="ln2684">}</a>
<a name="ln2685"> </a>
<a name="ln2686"> </a>
<a name="ln2687">void</a>
<a name="ln2688">MainWin::_RemovePlaylistItem(int32 index)</a>
<a name="ln2689">{</a>
<a name="ln2690">	delete fPlaylistMenu-&gt;RemoveItem(index);</a>
<a name="ln2691">}</a>
<a name="ln2692"> </a>
<a name="ln2693"> </a>
<a name="ln2694">void</a>
<a name="ln2695">MainWin::_MarkPlaylistItem(int32 index)</a>
<a name="ln2696">{</a>
<a name="ln2697">	if (BMenuItem* item = fPlaylistMenu-&gt;ItemAt(index)) {</a>
<a name="ln2698">		item-&gt;SetMarked(true);</a>
<a name="ln2699">		// ... and in case the menu is currently on screen:</a>
<a name="ln2700">		if (fPlaylistMenu-&gt;LockLooper()) {</a>
<a name="ln2701">			fPlaylistMenu-&gt;Invalidate();</a>
<a name="ln2702">			fPlaylistMenu-&gt;UnlockLooper();</a>
<a name="ln2703">		}</a>
<a name="ln2704">	}</a>
<a name="ln2705">}</a>
<a name="ln2706"> </a>
<a name="ln2707"> </a>
<a name="ln2708">void</a>
<a name="ln2709">MainWin::_MarkItem(BMenu* menu, uint32 command, bool mark)</a>
<a name="ln2710">{</a>
<a name="ln2711">	if (BMenuItem* item = menu-&gt;FindItem(command))</a>
<a name="ln2712">		item-&gt;SetMarked(mark);</a>
<a name="ln2713">}</a>
<a name="ln2714"> </a>
<a name="ln2715"> </a>
<a name="ln2716">void</a>
<a name="ln2717">MainWin::_AdoptGlobalSettings()</a>
<a name="ln2718">{</a>
<a name="ln2719">	mpSettings settings;</a>
<a name="ln2720">	Settings::Default()-&gt;Get(settings);</a>
<a name="ln2721"> </a>
<a name="ln2722">	fCloseWhenDonePlayingMovie = settings.closeWhenDonePlayingMovie;</a>
<a name="ln2723">	fCloseWhenDonePlayingSound = settings.closeWhenDonePlayingSound;</a>
<a name="ln2724">	fLoopMovies = settings.loopMovie;</a>
<a name="ln2725">	fLoopSounds = settings.loopSound;</a>
<a name="ln2726">	fScaleFullscreenControls = settings.scaleFullscreenControls;</a>
<a name="ln2727">}</a>
<a name="ln2728"> </a>
<a name="ln2729"> </a>

</code></pre>
<div class="balloon" rel="1416"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="2124"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'menu' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="1177"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
