
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>KeymapWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2004-2015 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Alexandre Deckner, alex@zappotek.com</a>
<a name="ln7"> *		Axel Dörfler, axeld@pinc-software.de</a>
<a name="ln8"> *		Jérôme Duval</a>
<a name="ln9"> *		John Scipione, jscipione@gmai.com</a>
<a name="ln10"> *		Sandor Vroemisse</a>
<a name="ln11"> */</a>
<a name="ln12"> </a>
<a name="ln13"> </a>
<a name="ln14">#include &quot;KeymapWindow.h&quot;</a>
<a name="ln15"> </a>
<a name="ln16">#include &lt;string.h&gt;</a>
<a name="ln17">#include &lt;stdio.h&gt;</a>
<a name="ln18"> </a>
<a name="ln19">#include &lt;Alert.h&gt;</a>
<a name="ln20">#include &lt;Button.h&gt;</a>
<a name="ln21">#include &lt;Catalog.h&gt;</a>
<a name="ln22">#include &lt;Directory.h&gt;</a>
<a name="ln23">#include &lt;File.h&gt;</a>
<a name="ln24">#include &lt;FindDirectory.h&gt;</a>
<a name="ln25">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln26">#include &lt;ListView.h&gt;</a>
<a name="ln27">#include &lt;Locale.h&gt;</a>
<a name="ln28">#include &lt;MenuBar.h&gt;</a>
<a name="ln29">#include &lt;MenuField.h&gt;</a>
<a name="ln30">#include &lt;MenuItem.h&gt;</a>
<a name="ln31">#include &lt;Path.h&gt;</a>
<a name="ln32">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln33">#include &lt;Screen.h&gt;</a>
<a name="ln34">#include &lt;ScrollView.h&gt;</a>
<a name="ln35">#include &lt;StringView.h&gt;</a>
<a name="ln36">#include &lt;TextControl.h&gt;</a>
<a name="ln37"> </a>
<a name="ln38">#include &quot;KeyboardLayoutView.h&quot;</a>
<a name="ln39">#include &quot;KeymapApplication.h&quot;</a>
<a name="ln40">#include &quot;KeymapListItem.h&quot;</a>
<a name="ln41">#include &quot;KeymapNames.h&quot;</a>
<a name="ln42"> </a>
<a name="ln43"> </a>
<a name="ln44">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln45">#define B_TRANSLATION_CONTEXT &quot;Keymap window&quot;</a>
<a name="ln46"> </a>
<a name="ln47"> </a>
<a name="ln48">static const uint32 kMsgMenuFileOpen = 'mMFO';</a>
<a name="ln49">static const uint32 kMsgMenuFileSaveAs = 'mMFA';</a>
<a name="ln50"> </a>
<a name="ln51">static const uint32 kChangeKeyboardLayout = 'cKyL';</a>
<a name="ln52"> </a>
<a name="ln53">static const uint32 kMsgSwitchShortcuts = 'swSc';</a>
<a name="ln54"> </a>
<a name="ln55">static const uint32 kMsgMenuFontChanged = 'mMFC';</a>
<a name="ln56"> </a>
<a name="ln57">static const uint32 kMsgSystemMapSelected = 'SmST';</a>
<a name="ln58">static const uint32 kMsgUserMapSelected = 'UmST';</a>
<a name="ln59"> </a>
<a name="ln60">static const uint32 kMsgDefaultKeymap = 'Dflt';</a>
<a name="ln61">static const uint32 kMsgRevertKeymap = 'Rvrt';</a>
<a name="ln62">static const uint32 kMsgKeymapUpdated = 'kMup';</a>
<a name="ln63"> </a>
<a name="ln64">static const uint32 kMsgDeadKeyAcuteChanged = 'dkAc';</a>
<a name="ln65">static const uint32 kMsgDeadKeyCircumflexChanged = 'dkCc';</a>
<a name="ln66">static const uint32 kMsgDeadKeyDiaeresisChanged = 'dkDc';</a>
<a name="ln67">static const uint32 kMsgDeadKeyGraveChanged = 'dkGc';</a>
<a name="ln68">static const uint32 kMsgDeadKeyTildeChanged = 'dkTc';</a>
<a name="ln69"> </a>
<a name="ln70">static const char* kDeadKeyTriggerNone = &quot;&lt;none&gt;&quot;;</a>
<a name="ln71"> </a>
<a name="ln72">static const char* kCurrentKeymapName = &quot;(Current)&quot;;</a>
<a name="ln73">static const char* kDefaultKeymapName = &quot;US-International&quot;;</a>
<a name="ln74"> </a>
<a name="ln75"> </a>
<a name="ln76">static int</a>
<a name="ln77">compare_key_list_items(const void* a, const void* b)</a>
<a name="ln78">{</a>
<a name="ln79">	KeymapListItem* item1 = *(KeymapListItem**)a;</a>
<a name="ln80">	KeymapListItem* item2 = *(KeymapListItem**)b;</a>
<a name="ln81">	return BLocale::Default()-&gt;StringCompare(item1-&gt;Text(), item2-&gt;Text());</a>
<a name="ln82">}</a>
<a name="ln83"> </a>
<a name="ln84"> </a>
<a name="ln85">KeymapWindow::KeymapWindow()</a>
<a name="ln86">	:</a>
<a name="ln87">	BWindow(BRect(80, 50, 650, 300), B_TRANSLATE_SYSTEM_NAME(&quot;Keymap&quot;),</a>
<a name="ln88">		B_TITLED_WINDOW, B_ASYNCHRONOUS_CONTROLS | B_AUTO_UPDATE_SIZE_LIMITS)</a>
<a name="ln89">{</a>
<a name="ln90">	fKeyboardLayoutView = new KeyboardLayoutView(&quot;layout&quot;);</a>
<a name="ln91">	fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln92">	fKeyboardLayoutView-&gt;SetExplicitMinSize(BSize(B_SIZE_UNSET, 192));</a>
<a name="ln93"> </a>
<a name="ln94">	fTextControl = new BTextControl(B_TRANSLATE(&quot;Sample and clipboard:&quot;),</a>
<a name="ln95">		&quot;&quot;, NULL);</a>
<a name="ln96"> </a>
<a name="ln97">	fSwitchShortcutsButton = new BButton(&quot;switch&quot;, &quot;&quot;,</a>
<a name="ln98">		new BMessage(kMsgSwitchShortcuts));</a>
<a name="ln99"> </a>
<a name="ln100">	// controls pane</a>
<a name="ln101">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln102">		.Add(_CreateMenu())</a>
<a name="ln103">		.AddGroup(B_HORIZONTAL)</a>
<a name="ln104">			.SetInsets(B_USE_WINDOW_SPACING)</a>
<a name="ln105">			.Add(_CreateMapLists(), 0.25)</a>
<a name="ln106">			.AddGroup(B_VERTICAL)</a>
<a name="ln107">				.Add(fKeyboardLayoutView)</a>
<a name="ln108">				.AddGroup(B_HORIZONTAL)</a>
<a name="ln109">					.Add(_CreateDeadKeyMenuField(), 0.0)</a>
<a name="ln110">					.AddGlue()</a>
<a name="ln111">					.Add(fSwitchShortcutsButton)</a>
<a name="ln112">					.End()</a>
<a name="ln113">				.Add(fTextControl)</a>
<a name="ln114">				.AddGlue(0.0)</a>
<a name="ln115">				.AddGroup(B_HORIZONTAL)</a>
<a name="ln116">					.AddGlue()</a>
<a name="ln117">					.Add(fDefaultsButton = new BButton(&quot;defaultsButton&quot;,</a>
<a name="ln118">						B_TRANSLATE(&quot;Defaults&quot;),</a>
<a name="ln119">							new BMessage(kMsgDefaultKeymap)))</a>
<a name="ln120">					.Add(fRevertButton = new BButton(&quot;revertButton&quot;,</a>
<a name="ln121">						B_TRANSLATE(&quot;Revert&quot;), new BMessage(kMsgRevertKeymap)))</a>
<a name="ln122">					.End()</a>
<a name="ln123">				.End()</a>
<a name="ln124">			.End()</a>
<a name="ln125">		.End();</a>
<a name="ln126"> </a>
<a name="ln127">	fKeyboardLayoutView-&gt;SetTarget(fTextControl-&gt;TextView());</a>
<a name="ln128">	fTextControl-&gt;MakeFocus();</a>
<a name="ln129"> </a>
<a name="ln130">	// Make sure the user keymap directory exists</a>
<a name="ln131">	BPath path;</a>
<a name="ln132">	find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path);</a>
<a name="ln133">	path.Append(&quot;Keymap&quot;);</a>
<a name="ln134"> </a>
<a name="ln135">	entry_ref ref;</a>
<a name="ln136">	BEntry entry(path.Path(), true); // follow symlink</a>
<a name="ln137">	BDirectory userKeymapsDir(&amp;entry);</a>
<a name="ln138">	if (userKeymapsDir.InitCheck() != B_OK</a>
<a name="ln139">		&amp;&amp; create_directory(path.Path(), S_IRWXU | S_IRWXG | S_IRWXO)</a>
<a name="ln140">			== B_OK) {</a>
<a name="ln141">		get_ref_for_path(path.Path(), &amp;ref);</a>
<a name="ln142">	} else if (entry.InitCheck() == B_OK)</a>
<a name="ln143">		entry.GetRef(&amp;ref);</a>
<a name="ln144">	else</a>
<a name="ln145">		get_ref_for_path(path.Path(), &amp;ref);</a>
<a name="ln146"> </a>
<a name="ln147">	BMessenger messenger(this);</a>
<a name="ln148">	fOpenPanel = new BFilePanel(B_OPEN_PANEL, &amp;messenger, &amp;ref,</a>
<a name="ln149">		B_FILE_NODE, false, NULL);</a>
<a name="ln150">	fSavePanel = new BFilePanel(B_SAVE_PANEL, &amp;messenger, &amp;ref,</a>
<a name="ln151">		B_FILE_NODE, false, NULL);</a>
<a name="ln152"> </a>
<a name="ln153">	BRect windowFrame;</a>
<a name="ln154">	if (_LoadSettings(windowFrame) == B_OK) {</a>
<a name="ln155">		ResizeTo(windowFrame.Width(), windowFrame.Height());</a>
<a name="ln156">		MoveTo(windowFrame.LeftTop());</a>
<a name="ln157">		MoveOnScreen();</a>
<a name="ln158">	} else</a>
<a name="ln159">		CenterOnScreen();</a>
<a name="ln160"> </a>
<a name="ln161">	// TODO: this might be a bug in the interface kit, but scrolling to</a>
<a name="ln162">	// selection does not correctly work unless the window is shown.</a>
<a name="ln163">	Show();</a>
<a name="ln164">	Lock();</a>
<a name="ln165"> </a>
<a name="ln166">	// Try and find the current map name in the two list views (if the name</a>
<a name="ln167">	// was read at all)</a>
<a name="ln168">	_SelectCurrentMap();</a>
<a name="ln169"> </a>
<a name="ln170">	KeymapListItem* current</a>
<a name="ln171">		= static_cast&lt;KeymapListItem*&gt;(fUserListView-&gt;FirstItem());</a>
<a name="ln172"> </a>
<a name="ln173">	fCurrentMap.Load(current-&gt;EntryRef());</a>
<a name="ln174">	fPreviousMap = fCurrentMap;</a>
<a name="ln175">	fAppliedMap = fCurrentMap;</a>
<a name="ln176">	fCurrentMap.SetTarget(this, new BMessage(kMsgKeymapUpdated));</a>
<a name="ln177"> </a>
<a name="ln178">	_UpdateButtons();</a>
<a name="ln179"> </a>
<a name="ln180">	_UpdateDeadKeyMenu();</a>
<a name="ln181">	_UpdateSwitchShortcutButton();</a>
<a name="ln182"> </a>
<a name="ln183">	Unlock();</a>
<a name="ln184">}</a>
<a name="ln185"> </a>
<a name="ln186"> </a>
<a name="ln187">KeymapWindow::~KeymapWindow()</a>
<a name="ln188">{</a>
<a name="ln189">	delete fOpenPanel;</a>
<a name="ln190">	delete fSavePanel;</a>
<a name="ln191">}</a>
<a name="ln192"> </a>
<a name="ln193"> </a>
<a name="ln194">bool</a>
<a name="ln195">KeymapWindow::QuitRequested()</a>
<a name="ln196">{</a>
<a name="ln197">	_SaveSettings();</a>
<a name="ln198"> </a>
<a name="ln199">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln200">	return true;</a>
<a name="ln201">}</a>
<a name="ln202"> </a>
<a name="ln203"> </a>
<a name="ln204">void</a>
<a name="ln205">KeymapWindow::MessageReceived(BMessage* message)</a>
<a name="ln206">{</a>
<a name="ln207">	switch (message-&gt;what) {</a>
<a name="ln208">		case B_SIMPLE_DATA:</a>
<a name="ln209">		case B_REFS_RECEIVED:</a>
<a name="ln210">		{</a>
<a name="ln211">			entry_ref ref;</a>
<a name="ln212">			int32 i = 0;</a>
<a name="ln213">			while (message-&gt;FindRef(&quot;refs&quot;, i++, &amp;ref) == B_OK) {</a>
<a name="ln214">				fCurrentMap.Load(ref);</a>
<a name="ln215">				fAppliedMap = fCurrentMap;</a>
<a name="ln216">			}</a>
<a name="ln217">			fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln218">			fSystemListView-&gt;DeselectAll();</a>
<a name="ln219">			fUserListView-&gt;DeselectAll();</a>
<a name="ln220">			break;</a>
<a name="ln221">		}</a>
<a name="ln222"> </a>
<a name="ln223">		case B_SAVE_REQUESTED:</a>
<a name="ln224">		{</a>
<a name="ln225">			entry_ref ref;</a>
<a name="ln226">			const char* name;</a>
<a name="ln227">			if (message-&gt;FindRef(&quot;directory&quot;, &amp;ref) == B_OK</a>
<a name="ln228">				&amp;&amp; message-&gt;FindString(&quot;name&quot;, &amp;name) == B_OK) {</a>
<a name="ln229">				BDirectory directory(&amp;ref);</a>
<a name="ln230">				BEntry entry(&amp;directory, name);</a>
<a name="ln231">				entry.GetRef(&amp;ref);</a>
<a name="ln232">				fCurrentMap.SetName(name);</a>
<a name="ln233">				fCurrentMap.Save(ref);</a>
<a name="ln234">				fAppliedMap = fCurrentMap;</a>
<a name="ln235">				_FillUserMaps();</a>
<a name="ln236">				fCurrentMapName = name;</a>
<a name="ln237">				_SelectCurrentMap();</a>
<a name="ln238">			}</a>
<a name="ln239">			break;</a>
<a name="ln240">		}</a>
<a name="ln241"> </a>
<a name="ln242">		case kMsgMenuFileOpen:</a>
<a name="ln243">			fOpenPanel-&gt;Show();</a>
<a name="ln244">			break;</a>
<a name="ln245">		case kMsgMenuFileSaveAs:</a>
<a name="ln246">			fSavePanel-&gt;Show();</a>
<a name="ln247">			break;</a>
<a name="ln248">		case kMsgShowModifierKeysWindow:</a>
<a name="ln249">			be_app-&gt;PostMessage(kMsgShowModifierKeysWindow);</a>
<a name="ln250">			break;</a>
<a name="ln251"> </a>
<a name="ln252">		case kChangeKeyboardLayout:</a>
<a name="ln253">		{</a>
<a name="ln254">			entry_ref ref;</a>
<a name="ln255">			BPath path;</a>
<a name="ln256">			if (message-&gt;FindRef(&quot;ref&quot;, &amp;ref) == B_OK)</a>
<a name="ln257">				path.SetTo(&amp;ref);</a>
<a name="ln258"> </a>
<a name="ln259">			_SetKeyboardLayout(path.Path());</a>
<a name="ln260">			break;</a>
<a name="ln261">		}</a>
<a name="ln262"> </a>
<a name="ln263">		case kMsgSwitchShortcuts:</a>
<a name="ln264">			_SwitchShortcutKeys();</a>
<a name="ln265">			break;</a>
<a name="ln266"> </a>
<a name="ln267">		case kMsgMenuFontChanged:</a>
<a name="ln268">		{</a>
<a name="ln269">			BMenuItem* item = fFontMenu-&gt;FindMarked();</a>
<a name="ln270">			if (item != NULL) {</a>
<a name="ln271">				BFont font;</a>
<a name="ln272">				font.SetFamilyAndStyle(item-&gt;Label(), NULL);</a>
<a name="ln273">				fKeyboardLayoutView-&gt;SetBaseFont(font);</a>
<a name="ln274">				fTextControl-&gt;TextView()-&gt;SetFontAndColor(&amp;font);</a>
<a name="ln275">			}</a>
<a name="ln276">			break;</a>
<a name="ln277">		}</a>
<a name="ln278"> </a>
<a name="ln279">		case kMsgSystemMapSelected:</a>
<a name="ln280">		case kMsgUserMapSelected:</a>
<a name="ln281">		{</a>
<a name="ln282">			BListView* listView;</a>
<a name="ln283">			BListView* otherListView;</a>
<a name="ln284"> </a>
<a name="ln285">			if (message-&gt;what == kMsgSystemMapSelected) {</a>
<a name="ln286">				listView = fSystemListView;</a>
<a name="ln287">				otherListView = fUserListView;</a>
<a name="ln288">			} else {</a>
<a name="ln289">				listView = fUserListView;</a>
<a name="ln290">				otherListView = fSystemListView;</a>
<a name="ln291">			}</a>
<a name="ln292"> </a>
<a name="ln293">			int32 index = listView-&gt;CurrentSelection();</a>
<a name="ln294">			if (index &lt; 0)</a>
<a name="ln295">				break;</a>
<a name="ln296"> </a>
<a name="ln297">			// Deselect item in other BListView</a>
<a name="ln298">			otherListView-&gt;DeselectAll();</a>
<a name="ln299"> </a>
<a name="ln300">			if (index == 0 &amp;&amp; listView == fUserListView) {</a>
<a name="ln301">				// we can safely ignore the &quot;(Current)&quot; item</a>
<a name="ln302">				break;</a>
<a name="ln303">			}</a>
<a name="ln304"> </a>
<a name="ln305">			KeymapListItem* item</a>
<a name="ln306">				= static_cast&lt;KeymapListItem*&gt;(listView-&gt;ItemAt(index));</a>
<a name="ln307">			if (item != NULL) {</a>
<a name="ln308">				status_t status = fCurrentMap.Load(item-&gt;EntryRef());</a>
<a name="ln309">				if (status != B_OK) {</a>
<a name="ln310">					listView-&gt;RemoveItem(item);</a>
<a name="ln311">					break;</a>
<a name="ln312">				}</a>
<a name="ln313"> </a>
<a name="ln314">				fAppliedMap = fCurrentMap;</a>
<a name="ln315">				fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln316">				_UseKeymap();</a>
<a name="ln317">				_UpdateButtons();</a>
<a name="ln318">			}</a>
<a name="ln319">			break;</a>
<a name="ln320">		}</a>
<a name="ln321"> </a>
<a name="ln322">		case kMsgDefaultKeymap:</a>
<a name="ln323">			_DefaultKeymap();</a>
<a name="ln324">			_UpdateButtons();</a>
<a name="ln325">			break;</a>
<a name="ln326"> </a>
<a name="ln327">		case kMsgRevertKeymap:</a>
<a name="ln328">			_RevertKeymap();</a>
<a name="ln329">			_UpdateButtons();</a>
<a name="ln330">			break;</a>
<a name="ln331"> </a>
<a name="ln332">		case kMsgUpdateNormalKeys:</a>
<a name="ln333">		{</a>
<a name="ln334">			uint32 keyCode;</a>
<a name="ln335">			if (message-&gt;FindUInt32(&quot;keyCode&quot;, &amp;keyCode) != B_OK)</a>
<a name="ln336">				break;</a>
<a name="ln337"> </a>
<a name="ln338">			bool unset;</a>
<a name="ln339">			if (message-&gt;FindBool(&quot;unset&quot;, &amp;unset) == B_OK &amp;&amp; unset) {</a>
<a name="ln340">				fCurrentMap.SetKey(keyCode, modifiers(), 0, &quot;&quot;, 0);</a>
<a name="ln341">				_UpdateButtons();</a>
<a name="ln342">				fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln343">			}</a>
<a name="ln344">			break;</a>
<a name="ln345">		}</a>
<a name="ln346"> </a>
<a name="ln347">		case kMsgUpdateModifierKeys:</a>
<a name="ln348">		{</a>
<a name="ln349">			uint32 keyCode;</a>
<a name="ln350">			bool unset;</a>
<a name="ln351">			if (message-&gt;FindBool(&quot;unset&quot;, &amp;unset) != B_OK)</a>
<a name="ln352">				unset = false;</a>
<a name="ln353"> </a>
<a name="ln354">			if (message-&gt;FindUInt32(&quot;left_shift_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln355">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln356">					B_LEFT_SHIFT_KEY);</a>
<a name="ln357">			}</a>
<a name="ln358"> </a>
<a name="ln359">			if (message-&gt;FindUInt32(&quot;right_shift_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln360">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln361">					B_RIGHT_SHIFT_KEY);</a>
<a name="ln362">			}</a>
<a name="ln363"> </a>
<a name="ln364">			if (message-&gt;FindUInt32(&quot;left_control_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln365">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln366">					B_LEFT_CONTROL_KEY);</a>
<a name="ln367">			}</a>
<a name="ln368"> </a>
<a name="ln369">			if (message-&gt;FindUInt32(&quot;right_control_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln370">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln371">					B_RIGHT_CONTROL_KEY);</a>
<a name="ln372">			}</a>
<a name="ln373"> </a>
<a name="ln374">			if (message-&gt;FindUInt32(&quot;left_option_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln375">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln376">					B_LEFT_OPTION_KEY);</a>
<a name="ln377">			}</a>
<a name="ln378"> </a>
<a name="ln379">			if (message-&gt;FindUInt32(&quot;right_option_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln380">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln381">					B_RIGHT_OPTION_KEY);</a>
<a name="ln382">			}</a>
<a name="ln383"> </a>
<a name="ln384">			if (message-&gt;FindUInt32(&quot;left_command_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln385">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln386">					B_LEFT_COMMAND_KEY);</a>
<a name="ln387">			}</a>
<a name="ln388"> </a>
<a name="ln389">			if (message-&gt;FindUInt32(&quot;right_command_key&quot;, &amp;keyCode) == B_OK) {</a>
<a name="ln390">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode,</a>
<a name="ln391">					B_RIGHT_COMMAND_KEY);</a>
<a name="ln392">			}</a>
<a name="ln393"> </a>
<a name="ln394">			if (message-&gt;FindUInt32(&quot;menu_key&quot;, &amp;keyCode) == B_OK)</a>
<a name="ln395">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode, B_MENU_KEY);</a>
<a name="ln396"> </a>
<a name="ln397">			if (message-&gt;FindUInt32(&quot;caps_key&quot;, &amp;keyCode) == B_OK)</a>
<a name="ln398">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode, B_CAPS_LOCK);</a>
<a name="ln399"> </a>
<a name="ln400">			if (message-&gt;FindUInt32(&quot;num_key&quot;, &amp;keyCode) == B_OK)</a>
<a name="ln401">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode, B_NUM_LOCK);</a>
<a name="ln402"> </a>
<a name="ln403">			if (message-&gt;FindUInt32(&quot;scroll_key&quot;, &amp;keyCode) == B_OK)</a>
<a name="ln404">				fCurrentMap.SetModifier(unset ? 0x00 : keyCode, B_SCROLL_LOCK);</a>
<a name="ln405"> </a>
<a name="ln406">			_UpdateButtons();</a>
<a name="ln407">			fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln408">			break;</a>
<a name="ln409">		}</a>
<a name="ln410"> </a>
<a name="ln411">		case kMsgKeymapUpdated:</a>
<a name="ln412">			_UpdateButtons();</a>
<a name="ln413">			fSystemListView-&gt;DeselectAll();</a>
<a name="ln414">			fUserListView-&gt;Select(0L);</a>
<a name="ln415">			break;</a>
<a name="ln416"> </a>
<a name="ln417">		case kMsgDeadKeyAcuteChanged:</a>
<a name="ln418">		{</a>
<a name="ln419">			BMenuItem* item = fAcuteMenu-&gt;FindMarked();</a>
<a name="ln420">			if (item != NULL) {</a>
<a name="ln421">				const char* trigger = item-&gt;Label();</a>
<a name="ln422">				if (strcmp(trigger, kDeadKeyTriggerNone) == 0)</a>
<a name="ln423">					trigger = NULL;</a>
<a name="ln424">				fCurrentMap.SetDeadKeyTrigger(kDeadKeyAcute, trigger);</a>
<a name="ln425">				fKeyboardLayoutView-&gt;Invalidate();</a>
<a name="ln426">			}</a>
<a name="ln427">			break;</a>
<a name="ln428">		}</a>
<a name="ln429"> </a>
<a name="ln430">		case kMsgDeadKeyCircumflexChanged:</a>
<a name="ln431">		{</a>
<a name="ln432">			BMenuItem* item = fCircumflexMenu-&gt;FindMarked();</a>
<a name="ln433">			if (item != NULL) {</a>
<a name="ln434">				const char* trigger = item-&gt;Label();</a>
<a name="ln435">				if (strcmp(trigger, kDeadKeyTriggerNone) == 0)</a>
<a name="ln436">					trigger = NULL;</a>
<a name="ln437">				fCurrentMap.SetDeadKeyTrigger(kDeadKeyCircumflex, trigger);</a>
<a name="ln438">				fKeyboardLayoutView-&gt;Invalidate();</a>
<a name="ln439">			}</a>
<a name="ln440">			break;</a>
<a name="ln441">		}</a>
<a name="ln442"> </a>
<a name="ln443">		case kMsgDeadKeyDiaeresisChanged:</a>
<a name="ln444">		{</a>
<a name="ln445">			BMenuItem* item = fDiaeresisMenu-&gt;FindMarked();</a>
<a name="ln446">			if (item != NULL) {</a>
<a name="ln447">				const char* trigger = item-&gt;Label();</a>
<a name="ln448">				if (strcmp(trigger, kDeadKeyTriggerNone) == 0)</a>
<a name="ln449">					trigger = NULL;</a>
<a name="ln450">				fCurrentMap.SetDeadKeyTrigger(kDeadKeyDiaeresis, trigger);</a>
<a name="ln451">				fKeyboardLayoutView-&gt;Invalidate();</a>
<a name="ln452">			}</a>
<a name="ln453">			break;</a>
<a name="ln454">		}</a>
<a name="ln455"> </a>
<a name="ln456">		case kMsgDeadKeyGraveChanged:</a>
<a name="ln457">		{</a>
<a name="ln458">			BMenuItem* item = fGraveMenu-&gt;FindMarked();</a>
<a name="ln459">			if (item != NULL) {</a>
<a name="ln460">				const char* trigger = item-&gt;Label();</a>
<a name="ln461">				if (strcmp(trigger, kDeadKeyTriggerNone) == 0)</a>
<a name="ln462">					trigger = NULL;</a>
<a name="ln463">				fCurrentMap.SetDeadKeyTrigger(kDeadKeyGrave, trigger);</a>
<a name="ln464">				fKeyboardLayoutView-&gt;Invalidate();</a>
<a name="ln465">			}</a>
<a name="ln466">			break;</a>
<a name="ln467">		}</a>
<a name="ln468"> </a>
<a name="ln469">		case kMsgDeadKeyTildeChanged:</a>
<a name="ln470">		{</a>
<a name="ln471">			BMenuItem* item = fTildeMenu-&gt;FindMarked();</a>
<a name="ln472">			if (item != NULL) {</a>
<a name="ln473">				const char* trigger = item-&gt;Label();</a>
<a name="ln474">				if (strcmp(trigger, kDeadKeyTriggerNone) == 0)</a>
<a name="ln475">					trigger = NULL;</a>
<a name="ln476">				fCurrentMap.SetDeadKeyTrigger(kDeadKeyTilde, trigger);</a>
<a name="ln477">				fKeyboardLayoutView-&gt;Invalidate();</a>
<a name="ln478">			}</a>
<a name="ln479">			break;</a>
<a name="ln480">		}</a>
<a name="ln481"> </a>
<a name="ln482">		default:</a>
<a name="ln483">			BWindow::MessageReceived(message);</a>
<a name="ln484">			break;</a>
<a name="ln485">	}</a>
<a name="ln486">}</a>
<a name="ln487"> </a>
<a name="ln488"> </a>
<a name="ln489">BMenuBar*</a>
<a name="ln490">KeymapWindow::_CreateMenu()</a>
<a name="ln491">{</a>
<a name="ln492">	BMenuBar* menuBar = new BMenuBar(Bounds(), &quot;menubar&quot;);</a>
<a name="ln493"> </a>
<a name="ln494">	// Create the File menu</a>
<a name="ln495">	BMenu* menu = new BMenu(B_TRANSLATE(&quot;File&quot;));</a>
<a name="ln496">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Open&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln497">		new BMessage(kMsgMenuFileOpen), 'O'));</a>
<a name="ln498">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Save as&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln499">		new BMessage(kMsgMenuFileSaveAs)));</a>
<a name="ln500">	menu-&gt;AddSeparatorItem();</a>
<a name="ln501">	menu-&gt;AddItem(new BMenuItem(</a>
<a name="ln502">		B_TRANSLATE(&quot;Set modifier keys&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln503">		new BMessage(kMsgShowModifierKeysWindow)));</a>
<a name="ln504">	menu-&gt;AddSeparatorItem();</a>
<a name="ln505">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln506">		new BMessage(B_QUIT_REQUESTED), 'Q'));</a>
<a name="ln507">	menuBar-&gt;AddItem(menu);</a>
<a name="ln508"> </a>
<a name="ln509">	// Create keyboard layout menu</a>
<a name="ln510">	fLayoutMenu = new BMenu(B_TRANSLATE(&quot;Layout&quot;));</a>
<a name="ln511">	_AddKeyboardLayouts(fLayoutMenu);</a>
<a name="ln512">	menuBar-&gt;AddItem(fLayoutMenu);</a>
<a name="ln513"> </a>
<a name="ln514">	// Create the Font menu</a>
<a name="ln515">	fFontMenu = new BMenu(B_TRANSLATE(&quot;Font&quot;));</a>
<a name="ln516">	fFontMenu-&gt;SetRadioMode(true);</a>
<a name="ln517">	int32 numFamilies = count_font_families();</a>
<a name="ln518">	font_family family, currentFamily;</a>
<a name="ln519">	font_style currentStyle;</a>
<a name="ln520">	uint32 flags;</a>
<a name="ln521"> </a>
<a name="ln522">	be_plain_font-&gt;GetFamilyAndStyle(&amp;currentFamily, &amp;currentStyle);</a>
<a name="ln523"> </a>
<a name="ln524">	for (int32 i = 0; i &lt; numFamilies; i++) {</a>
<a name="ln525">		if (get_font_family(i, &amp;family, &amp;flags) == B_OK) {</a>
<a name="ln526">			BMenuItem* item</a>
<a name="ln527">				= new BMenuItem(family, new BMessage(kMsgMenuFontChanged));</a>
<a name="ln528">			fFontMenu-&gt;AddItem(item);</a>
<a name="ln529"> </a>
<a name="ln530">			if (!strcmp(family, currentFamily))</a>
<a name="ln531">				item-&gt;SetMarked(true);</a>
<a name="ln532">		}</a>
<a name="ln533">	}</a>
<a name="ln534">	menuBar-&gt;AddItem(fFontMenu);</a>
<a name="ln535"> </a>
<a name="ln536">	return menuBar;</a>
<a name="ln537">}</a>
<a name="ln538"> </a>
<a name="ln539"> </a>
<a name="ln540">BMenuField*</a>
<a name="ln541">KeymapWindow::_CreateDeadKeyMenuField()</a>
<a name="ln542">{</a>
<a name="ln543">	BPopUpMenu* deadKeyMenu = new BPopUpMenu(B_TRANSLATE(&quot;Select dead keys&quot;),</a>
<a name="ln544">		false, false);</a>
<a name="ln545"> </a>
<a name="ln546">	fAcuteMenu = new BMenu(B_TRANSLATE(&quot;Acute trigger&quot;));</a>
<a name="ln547">	fAcuteMenu-&gt;SetRadioMode(true);</a>
<a name="ln548">	fAcuteMenu-&gt;AddItem(new BMenuItem(&quot;\xC2\xB4&quot;,</a>
<a name="ln549">		new BMessage(kMsgDeadKeyAcuteChanged)));</a>
<a name="ln550">	fAcuteMenu-&gt;AddItem(new BMenuItem(&quot;'&quot;,</a>
<a name="ln551">		new BMessage(kMsgDeadKeyAcuteChanged)));</a>
<a name="ln552">	fAcuteMenu-&gt;AddItem(new BMenuItem(kDeadKeyTriggerNone,</a>
<a name="ln553">		new BMessage(kMsgDeadKeyAcuteChanged)));</a>
<a name="ln554">	deadKeyMenu-&gt;AddItem(fAcuteMenu);</a>
<a name="ln555"> </a>
<a name="ln556">	fCircumflexMenu = new BMenu(B_TRANSLATE(&quot;Circumflex trigger&quot;));</a>
<a name="ln557">	fCircumflexMenu-&gt;SetRadioMode(true);</a>
<a name="ln558">	fCircumflexMenu-&gt;AddItem(new BMenuItem(&quot;^&quot;,</a>
<a name="ln559">		new BMessage(kMsgDeadKeyCircumflexChanged)));</a>
<a name="ln560">	fCircumflexMenu-&gt;AddItem(new BMenuItem(kDeadKeyTriggerNone,</a>
<a name="ln561">		new BMessage(kMsgDeadKeyCircumflexChanged)));</a>
<a name="ln562">	deadKeyMenu-&gt;AddItem(fCircumflexMenu);</a>
<a name="ln563"> </a>
<a name="ln564">	fDiaeresisMenu = new BMenu(B_TRANSLATE(&quot;Diaeresis trigger&quot;));</a>
<a name="ln565">	fDiaeresisMenu-&gt;SetRadioMode(true);</a>
<a name="ln566">	fDiaeresisMenu-&gt;AddItem(new BMenuItem(&quot;\xC2\xA8&quot;,</a>
<a name="ln567">		new BMessage(kMsgDeadKeyDiaeresisChanged)));</a>
<a name="ln568">	fDiaeresisMenu-&gt;AddItem(new BMenuItem(&quot;\&quot;&quot;,</a>
<a name="ln569">		new BMessage(kMsgDeadKeyDiaeresisChanged)));</a>
<a name="ln570">	fDiaeresisMenu-&gt;AddItem(new BMenuItem(kDeadKeyTriggerNone,</a>
<a name="ln571">		new BMessage(kMsgDeadKeyDiaeresisChanged)));</a>
<a name="ln572">	deadKeyMenu-&gt;AddItem(fDiaeresisMenu);</a>
<a name="ln573"> </a>
<a name="ln574">	fGraveMenu = new BMenu(B_TRANSLATE(&quot;Grave trigger&quot;));</a>
<a name="ln575">	fGraveMenu-&gt;SetRadioMode(true);</a>
<a name="ln576">	fGraveMenu-&gt;AddItem(new BMenuItem(&quot;`&quot;,</a>
<a name="ln577">		new BMessage(kMsgDeadKeyGraveChanged)));</a>
<a name="ln578">	fGraveMenu-&gt;AddItem(new BMenuItem(kDeadKeyTriggerNone,</a>
<a name="ln579">		new BMessage(kMsgDeadKeyGraveChanged)));</a>
<a name="ln580">	deadKeyMenu-&gt;AddItem(fGraveMenu);</a>
<a name="ln581"> </a>
<a name="ln582">	fTildeMenu = new BMenu(B_TRANSLATE(&quot;Tilde trigger&quot;));</a>
<a name="ln583">	fTildeMenu-&gt;SetRadioMode(true);</a>
<a name="ln584">	fTildeMenu-&gt;AddItem(new BMenuItem(&quot;~&quot;,</a>
<a name="ln585">		new BMessage(kMsgDeadKeyTildeChanged)));</a>
<a name="ln586">	fTildeMenu-&gt;AddItem(new BMenuItem(kDeadKeyTriggerNone,</a>
<a name="ln587">		new BMessage(kMsgDeadKeyTildeChanged)));</a>
<a name="ln588">	deadKeyMenu-&gt;AddItem(fTildeMenu);</a>
<a name="ln589"> </a>
<a name="ln590">	return new BMenuField(NULL, deadKeyMenu);</a>
<a name="ln591">}</a>
<a name="ln592"> </a>
<a name="ln593"> </a>
<a name="ln594">BView*</a>
<a name="ln595">KeymapWindow::_CreateMapLists()</a>
<a name="ln596">{</a>
<a name="ln597">	// The System list</a>
<a name="ln598">	fSystemListView = new BListView(&quot;systemList&quot;);</a>
<a name="ln599">	fSystemListView-&gt;SetSelectionMessage(new BMessage(kMsgSystemMapSelected));</a>
<a name="ln600"> </a>
<a name="ln601">	BScrollView* systemScroller = new BScrollView(&quot;systemScrollList&quot;,</a>
<a name="ln602">		fSystemListView, 0, false, true);</a>
<a name="ln603"> </a>
<a name="ln604">	// The User list</a>
<a name="ln605">	fUserListView = new BListView(&quot;userList&quot;);</a>
<a name="ln606">	fUserListView-&gt;SetSelectionMessage(new BMessage(kMsgUserMapSelected));</a>
<a name="ln607">	BScrollView* userScroller = new BScrollView(&quot;userScrollList&quot;,</a>
<a name="ln608">		fUserListView, 0, false, true);</a>
<a name="ln609"> </a>
<a name="ln610">	// Saved keymaps</a>
<a name="ln611"> </a>
<a name="ln612">	_FillSystemMaps();</a>
<a name="ln613">	_FillUserMaps();</a>
<a name="ln614"> </a>
<a name="ln615">	_SetListViewSize(fSystemListView);</a>
<a name="ln616">	_SetListViewSize(fUserListView);</a>
<a name="ln617"> </a>
<a name="ln618">	return BLayoutBuilder::Group&lt;&gt;(B_VERTICAL)</a>
<a name="ln619">		.Add(new BStringView(&quot;system&quot;, B_TRANSLATE(&quot;System:&quot;)))</a>
<a name="ln620">		.Add(systemScroller, 3)</a>
<a name="ln621">		.Add(new BStringView(&quot;user&quot;, B_TRANSLATE(&quot;User:&quot;)))</a>
<a name="ln622">		.Add(userScroller)</a>
<a name="ln623">		.View();</a>
<a name="ln624">}</a>
<a name="ln625"> </a>
<a name="ln626"> </a>
<a name="ln627">void</a>
<a name="ln628">KeymapWindow::_AddKeyboardLayouts(BMenu* menu)</a>
<a name="ln629">{</a>
<a name="ln630">	directory_which dataDirectories[] = {</a>
<a name="ln631">		B_USER_NONPACKAGED_DATA_DIRECTORY,</a>
<a name="ln632">		B_USER_DATA_DIRECTORY,</a>
<a name="ln633">		B_SYSTEM_NONPACKAGED_DATA_DIRECTORY,</a>
<a name="ln634">		B_SYSTEM_DATA_DIRECTORY,</a>
<a name="ln635">	};</a>
<a name="ln636"> </a>
<a name="ln637">	for (uint32 i = 0;</a>
<a name="ln638">			i &lt; sizeof(dataDirectories) / sizeof(dataDirectories[0]); i++) {</a>
<a name="ln639">		BPath path;</a>
<a name="ln640">		if (find_directory(dataDirectories[i], &amp;path) != B_OK)</a>
<a name="ln641">			continue;</a>
<a name="ln642"> </a>
<a name="ln643">		if (path.Append(&quot;KeyboardLayouts&quot;) != B_OK)</a>
<a name="ln644">			continue;</a>
<a name="ln645"> </a>
<a name="ln646">		BDirectory directory;</a>
<a name="ln647">		if (directory.SetTo(path.Path()) == B_OK)</a>
<a name="ln648">			_AddKeyboardLayoutMenu(menu, directory);</a>
<a name="ln649">	}</a>
<a name="ln650">}</a>
<a name="ln651"> </a>
<a name="ln652"> </a>
<a name="ln653">/*!	Adds a menu populated with the keyboard layouts found in the passed</a>
<a name="ln654">	in directory to the passed in menu. Each subdirectory in the passed</a>
<a name="ln655">	in directory is added as a submenu recursively.</a>
<a name="ln656">*/</a>
<a name="ln657">void</a>
<a name="ln658">KeymapWindow::_AddKeyboardLayoutMenu(BMenu* menu, BDirectory directory)</a>
<a name="ln659">{</a>
<a name="ln660">	entry_ref ref;</a>
<a name="ln661"> </a>
<a name="ln662">	while (directory.GetNextRef(&amp;ref) == B_OK) {</a>
<a name="ln663">		if (menu-&gt;FindItem(ref.name) != NULL)</a>
<a name="ln664">			continue;</a>
<a name="ln665"> </a>
<a name="ln666">		BDirectory subdirectory;</a>
<a name="ln667">		subdirectory.SetTo(&amp;ref);</a>
<a name="ln668">		if (subdirectory.InitCheck() == B_OK) {</a>
<a name="ln669">			BMenu* submenu = new BMenu(B_TRANSLATE_NOCOLLECT(ref.name));</a>
<a name="ln670"> </a>
<a name="ln671">			_AddKeyboardLayoutMenu(submenu, subdirectory);</a>
<a name="ln672">			menu-&gt;AddItem(submenu, (int32)0);</a>
<a name="ln673">		} else {</a>
<a name="ln674">			BMessage* message = new BMessage(kChangeKeyboardLayout);</a>
<a name="ln675"> </a>
<a name="ln676">			message-&gt;AddRef(&quot;ref&quot;, &amp;ref);</a>
<a name="ln677">			menu-&gt;AddItem(new BMenuItem(B_TRANSLATE_NOCOLLECT(ref.name),</a>
<a name="ln678">				message), (int32)0);</a>
<a name="ln679">		}</a>
<a name="ln680">	}</a>
<a name="ln681">}</a>
<a name="ln682"> </a>
<a name="ln683"> </a>
<a name="ln684">/*!	Sets the keyboard layout with the passed in path and marks the</a>
<a name="ln685">	corresponding menu item. If the path is not found in the menu this method</a>
<a name="ln686">	sets the default keyboard layout and marks the corresponding menu item.</a>
<a name="ln687">*/</a>
<a name="ln688">status_t</a>
<a name="ln689">KeymapWindow::_SetKeyboardLayout(const char* path)</a>
<a name="ln690">{</a>
<a name="ln691">	status_t status = fKeyboardLayoutView-&gt;GetKeyboardLayout()-&gt;Load(path);</a>
<a name="ln692"> </a>
<a name="ln693">	// mark a menu item (unmarking all others)</a>
<a name="ln694">	_MarkKeyboardLayoutItem(path, fLayoutMenu);</a>
<a name="ln695"> </a>
<a name="ln696">	if (path == NULL || path[0] == '\0' || status != B_OK) {</a>
<a name="ln697">		fKeyboardLayoutView-&gt;GetKeyboardLayout()-&gt;SetDefault();</a>
<a name="ln698">		BMenuItem* item = fLayoutMenu-&gt;FindItem(</a>
<a name="ln699">			fKeyboardLayoutView-&gt;GetKeyboardLayout()-&gt;Name());</a>
<a name="ln700">		if (item != NULL)</a>
<a name="ln701">			item-&gt;SetMarked(true);</a>
<a name="ln702">	}</a>
<a name="ln703"> </a>
<a name="ln704">	// Refresh currently set layout</a>
<a name="ln705">	fKeyboardLayoutView-&gt;SetKeyboardLayout(</a>
<a name="ln706">		fKeyboardLayoutView-&gt;GetKeyboardLayout());</a>
<a name="ln707"> </a>
<a name="ln708">	return status;</a>
<a name="ln709">}</a>
<a name="ln710"> </a>
<a name="ln711"> </a>
<a name="ln712">/*!	Marks a keyboard layout item by iterating through the menus recursively</a>
<a name="ln713">	searching for the menu item with the passed in path. This method always</a>
<a name="ln714">	iterates through all menu items and unmarks them. If no item with the</a>
<a name="ln715">	passed in path is found it is up to the caller to set the default keyboard</a>
<a name="ln716">	layout and mark item corresponding to the default keyboard layout path.</a>
<a name="ln717">*/</a>
<a name="ln718">void</a>
<a name="ln719">KeymapWindow::_MarkKeyboardLayoutItem(const char* path, BMenu* menu)</a>
<a name="ln720">{</a>
<a name="ln721">	BMenuItem* item = NULL;</a>
<a name="ln722">	entry_ref ref;</a>
<a name="ln723"> </a>
<a name="ln724">	for (int32 i = 0; i &lt; menu-&gt;CountItems(); i++) {</a>
<a name="ln725">		item = menu-&gt;ItemAt(i);</a>
<a name="ln726">		if (item == NULL)</a>
<a name="ln727">			continue;</a>
<a name="ln728"> </a>
<a name="ln729">		// Unmark each item initially</a>
<a name="ln730">		item-&gt;SetMarked(false);</a>
<a name="ln731"> </a>
<a name="ln732">		BMenu* submenu = item-&gt;Submenu();</a>
<a name="ln733">		if (submenu != NULL)</a>
<a name="ln734">			_MarkKeyboardLayoutItem(path, submenu);</a>
<a name="ln735">		else {</a>
<a name="ln736">			if (item-&gt;Message()-&gt;FindRef(&quot;ref&quot;, &amp;ref) == B_OK) {</a>
<a name="ln737">				BPath layoutPath(&amp;ref);</a>
<a name="ln738">				if (path != NULL &amp;&amp; path[0] != '\0' &amp;&amp; layoutPath == path) {</a>
<a name="ln739">					// Found it, mark the item</a>
<a name="ln740">					item-&gt;SetMarked(true);</a>
<a name="ln741">				}</a>
<a name="ln742">			}</a>
<a name="ln743">		}</a>
<a name="ln744">	}</a>
<a name="ln745">}</a>
<a name="ln746"> </a>
<a name="ln747"> </a>
<a name="ln748">/*!	Sets the label of the &quot;Switch Shorcuts&quot; button to make it more</a>
<a name="ln749">	descriptive what will happen when you press that button.</a>
<a name="ln750">*/</a>
<a name="ln751">void</a>
<a name="ln752">KeymapWindow::_UpdateSwitchShortcutButton()</a>
<a name="ln753">{</a>
<a name="ln754">	const char* label = B_TRANSLATE(&quot;Switch shortcut keys&quot;);</a>
<a name="ln755">	if (fCurrentMap.KeyForModifier(B_LEFT_COMMAND_KEY) == 0x5d</a>
<a name="ln756">		&amp;&amp; fCurrentMap.KeyForModifier(B_LEFT_CONTROL_KEY) == 0x5c) {</a>
<a name="ln757">		label = B_TRANSLATE(&quot;Switch shortcut keys to Windows/Linux mode&quot;);</a>
<a name="ln758">	} else if (fCurrentMap.KeyForModifier(B_LEFT_COMMAND_KEY) == 0x5c</a>
<a name="ln759">		&amp;&amp; fCurrentMap.KeyForModifier(B_LEFT_CONTROL_KEY) == 0x5d) {</a>
<a name="ln760">		label = B_TRANSLATE(&quot;Switch shortcut keys to Haiku mode&quot;);</a>
<a name="ln761">	}</a>
<a name="ln762"> </a>
<a name="ln763">	fSwitchShortcutsButton-&gt;SetLabel(label);</a>
<a name="ln764">}</a>
<a name="ln765"> </a>
<a name="ln766"> </a>
<a name="ln767">/*!	Marks the menu items corresponding to the dead key state of the current</a>
<a name="ln768">	key map.</a>
<a name="ln769">*/</a>
<a name="ln770">void</a>
<a name="ln771">KeymapWindow::_UpdateDeadKeyMenu()</a>
<a name="ln772">{</a>
<a name="ln773">	BString trigger;</a>
<a name="ln774">	fCurrentMap.GetDeadKeyTrigger(kDeadKeyAcute, trigger);</a>
<a name="ln775">	if (!trigger.Length())</a>
<a name="ln776">		trigger = kDeadKeyTriggerNone;</a>
<a name="ln777">	BMenuItem* menuItem = fAcuteMenu-&gt;FindItem(trigger.String());</a>
<a name="ln778">	if (menuItem)</a>
<a name="ln779">		menuItem-&gt;SetMarked(true);</a>
<a name="ln780"> </a>
<a name="ln781">	fCurrentMap.GetDeadKeyTrigger(kDeadKeyCircumflex, trigger);</a>
<a name="ln782">	if (!trigger.Length())</a>
<a name="ln783">		trigger = kDeadKeyTriggerNone;</a>
<a name="ln784">	menuItem = fCircumflexMenu-&gt;FindItem(trigger.String());</a>
<a name="ln785">	if (menuItem)</a>
<a name="ln786">		menuItem-&gt;SetMarked(true);</a>
<a name="ln787"> </a>
<a name="ln788">	fCurrentMap.GetDeadKeyTrigger(kDeadKeyDiaeresis, trigger);</a>
<a name="ln789">	if (!trigger.Length())</a>
<a name="ln790">		trigger = kDeadKeyTriggerNone;</a>
<a name="ln791">	menuItem = fDiaeresisMenu-&gt;FindItem(trigger.String());</a>
<a name="ln792">	if (menuItem)</a>
<a name="ln793">		menuItem-&gt;SetMarked(true);</a>
<a name="ln794"> </a>
<a name="ln795">	fCurrentMap.GetDeadKeyTrigger(kDeadKeyGrave, trigger);</a>
<a name="ln796">	if (!trigger.Length())</a>
<a name="ln797">		trigger = kDeadKeyTriggerNone;</a>
<a name="ln798">	menuItem = fGraveMenu-&gt;FindItem(trigger.String());</a>
<a name="ln799">	if (menuItem)</a>
<a name="ln800">		menuItem-&gt;SetMarked(true);</a>
<a name="ln801"> </a>
<a name="ln802">	fCurrentMap.GetDeadKeyTrigger(kDeadKeyTilde, trigger);</a>
<a name="ln803">	if (!trigger.Length())</a>
<a name="ln804">		trigger = kDeadKeyTriggerNone;</a>
<a name="ln805">	menuItem = fTildeMenu-&gt;FindItem(trigger.String());</a>
<a name="ln806">	if (menuItem)</a>
<a name="ln807">		menuItem-&gt;SetMarked(true);</a>
<a name="ln808">}</a>
<a name="ln809"> </a>
<a name="ln810"> </a>
<a name="ln811">void</a>
<a name="ln812">KeymapWindow::_UpdateButtons()</a>
<a name="ln813">{</a>
<a name="ln814">	if (fCurrentMap != fAppliedMap) {</a>
<a name="ln815">		fCurrentMap.SetName(kCurrentKeymapName);</a>
<a name="ln816">		_UseKeymap();</a>
<a name="ln817">	}</a>
<a name="ln818"> </a>
<a name="ln819">	fDefaultsButton-&gt;SetEnabled(</a>
<a name="ln820">		fCurrentMapName.ICompare(kDefaultKeymapName) != 0);</a>
<a name="ln821">	fRevertButton-&gt;SetEnabled(fCurrentMap != fPreviousMap);</a>
<a name="ln822"> </a>
<a name="ln823">	_UpdateDeadKeyMenu();</a>
<a name="ln824">	_UpdateSwitchShortcutButton();</a>
<a name="ln825">}</a>
<a name="ln826"> </a>
<a name="ln827"> </a>
<a name="ln828">void</a>
<a name="ln829">KeymapWindow::_SwitchShortcutKeys()</a>
<a name="ln830">{</a>
<a name="ln831">	uint32 leftCommand = fCurrentMap.Map().left_command_key;</a>
<a name="ln832">	uint32 leftControl = fCurrentMap.Map().left_control_key;</a>
<a name="ln833">	uint32 rightCommand = fCurrentMap.Map().right_command_key;</a>
<a name="ln834">	uint32 rightControl = fCurrentMap.Map().right_control_key;</a>
<a name="ln835"> </a>
<a name="ln836">	// switch left side</a>
<a name="ln837">	fCurrentMap.Map().left_command_key = leftControl;</a>
<a name="ln838">	fCurrentMap.Map().left_control_key = leftCommand;</a>
<a name="ln839"> </a>
<a name="ln840">	// switch right side</a>
<a name="ln841">	fCurrentMap.Map().right_command_key = rightControl;</a>
<a name="ln842">	fCurrentMap.Map().right_control_key = rightCommand;</a>
<a name="ln843"> </a>
<a name="ln844">	fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln845">	_UpdateButtons();</a>
<a name="ln846">}</a>
<a name="ln847"> </a>
<a name="ln848"> </a>
<a name="ln849">//!	Restores the default keymap.</a>
<a name="ln850">void</a>
<a name="ln851">KeymapWindow::_DefaultKeymap()</a>
<a name="ln852">{</a>
<a name="ln853">	fCurrentMap.RestoreSystemDefault();</a>
<a name="ln854">	fAppliedMap = fCurrentMap;</a>
<a name="ln855"> </a>
<a name="ln856">	fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln857"> </a>
<a name="ln858">	fCurrentMapName = _GetActiveKeymapName();</a>
<a name="ln859">	_SelectCurrentMap();</a>
<a name="ln860">}</a>
<a name="ln861"> </a>
<a name="ln862"> </a>
<a name="ln863">//!	Saves previous map to the &quot;Key_map&quot; file.</a>
<a name="ln864">void</a>
<a name="ln865">KeymapWindow::_RevertKeymap()</a>
<a name="ln866">{</a>
<a name="ln867">	entry_ref ref;</a>
<a name="ln868">	_GetCurrentKeymap(ref);</a>
<a name="ln869"> </a>
<a name="ln870">	status_t status = fPreviousMap.Save(ref);</a>
<a name="ln871">	if (status != B_OK) {</a>
<a name="ln872">		printf(&quot;error when saving keymap: %s&quot;, strerror(status));</a>
<a name="ln873">		return;</a>
<a name="ln874">	}</a>
<a name="ln875"> </a>
<a name="ln876">	fPreviousMap.Use();</a>
<a name="ln877">	fCurrentMap.Load(ref);</a>
<a name="ln878">	fAppliedMap = fCurrentMap;</a>
<a name="ln879"> </a>
<a name="ln880">	fKeyboardLayoutView-&gt;SetKeymap(&amp;fCurrentMap);</a>
<a name="ln881"> </a>
<a name="ln882">	fCurrentMapName = _GetActiveKeymapName();</a>
<a name="ln883">	_SelectCurrentMap();</a>
<a name="ln884">}</a>
<a name="ln885"> </a>
<a name="ln886"> </a>
<a name="ln887">//!	Saves current map to the &quot;Key_map&quot; file.</a>
<a name="ln888">void</a>
<a name="ln889">KeymapWindow::_UseKeymap()</a>
<a name="ln890">{</a>
<a name="ln891">	entry_ref ref;</a>
<a name="ln892">	_GetCurrentKeymap(ref);</a>
<a name="ln893"> </a>
<a name="ln894">	status_t status = fCurrentMap.Save(ref);</a>
<a name="ln895">	if (status != B_OK) {</a>
<a name="ln896">		printf(&quot;error when saving : %s&quot;, strerror(status));</a>
<a name="ln897">		return;</a>
<a name="ln898">	}</a>
<a name="ln899"> </a>
<a name="ln900">	fCurrentMap.Use();</a>
<a name="ln901">	fAppliedMap.Load(ref);</a>
<a name="ln902"> </a>
<a name="ln903">	fCurrentMapName = _GetActiveKeymapName();</a>
<a name="ln904">	_SelectCurrentMap();</a>
<a name="ln905">}</a>
<a name="ln906"> </a>
<a name="ln907"> </a>
<a name="ln908">void</a>
<a name="ln909">KeymapWindow::_FillSystemMaps()</a>
<a name="ln910">{</a>
<a name="ln911">	BListItem* item;</a>
<a name="ln912">	while ((item = fSystemListView-&gt;RemoveItem(static_cast&lt;int32&gt;(0))))</a>
<a name="ln913">		delete item;</a>
<a name="ln914"> </a>
<a name="ln915">	// TODO: common keymaps!</a>
<a name="ln916">	BPath path;</a>
<a name="ln917">	if (find_directory(B_SYSTEM_DATA_DIRECTORY, &amp;path) != B_OK)</a>
<a name="ln918">		return;</a>
<a name="ln919"> </a>
<a name="ln920">	path.Append(&quot;Keymaps&quot;);</a>
<a name="ln921"> </a>
<a name="ln922">	BDirectory directory;</a>
<a name="ln923">	entry_ref ref;</a>
<a name="ln924"> </a>
<a name="ln925">	if (directory.SetTo(path.Path()) == B_OK) {</a>
<a name="ln926">		while (directory.GetNextRef(&amp;ref) == B_OK) {</a>
<a name="ln927">			fSystemListView-&gt;AddItem(</a>
<a name="ln928">				new KeymapListItem(ref, B_TRANSLATE_NOCOLLECT(ref.name)));</a>
<a name="ln929">		}</a>
<a name="ln930">	}</a>
<a name="ln931"> </a>
<a name="ln932">	fSystemListView-&gt;SortItems(&amp;compare_key_list_items);</a>
<a name="ln933">}</a>
<a name="ln934"> </a>
<a name="ln935"> </a>
<a name="ln936">void</a>
<a name="ln937">KeymapWindow::_FillUserMaps()</a>
<a name="ln938">{</a>
<a name="ln939">	BListItem* item;</a>
<a name="ln940">	while ((item = fUserListView-&gt;RemoveItem(static_cast&lt;int32&gt;(0))))</a>
<a name="ln941">		delete item;</a>
<a name="ln942"> </a>
<a name="ln943">	entry_ref ref;</a>
<a name="ln944">	_GetCurrentKeymap(ref);</a>
<a name="ln945"> </a>
<a name="ln946">	fUserListView-&gt;AddItem(new KeymapListItem(ref, B_TRANSLATE(&quot;(Current)&quot;)));</a>
<a name="ln947"> </a>
<a name="ln948">	fCurrentMapName = _GetActiveKeymapName();</a>
<a name="ln949"> </a>
<a name="ln950">	BPath path;</a>
<a name="ln951">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path) != B_OK)</a>
<a name="ln952">		return;</a>
<a name="ln953"> </a>
<a name="ln954">	path.Append(&quot;Keymap&quot;);</a>
<a name="ln955"> </a>
<a name="ln956">	BDirectory directory;</a>
<a name="ln957">	if (directory.SetTo(path.Path()) == B_OK) {</a>
<a name="ln958">		while (directory.GetNextRef(&amp;ref) == B_OK) {</a>
<a name="ln959">			fUserListView-&gt;AddItem(new KeymapListItem(ref));</a>
<a name="ln960">		}</a>
<a name="ln961">	}</a>
<a name="ln962"> </a>
<a name="ln963">	fUserListView-&gt;SortItems(&amp;compare_key_list_items);</a>
<a name="ln964">}</a>
<a name="ln965"> </a>
<a name="ln966"> </a>
<a name="ln967">void</a>
<a name="ln968">KeymapWindow::_SetListViewSize(BListView* listView)</a>
<a name="ln969">{</a>
<a name="ln970">	float minWidth = 0;</a>
<a name="ln971">	for (int32 i = 0; i &lt; listView-&gt;CountItems(); i++) {</a>
<a name="ln972">		BStringItem* item = (BStringItem*)listView-&gt;ItemAt(i);</a>
<a name="ln973">		float width = listView-&gt;StringWidth(item-&gt;Text());</a>
<a name="ln974">		if (width &gt; minWidth)</a>
<a name="ln975">			minWidth = width;</a>
<a name="ln976">	}</a>
<a name="ln977"> </a>
<a name="ln978">	listView-&gt;SetExplicitMinSize(BSize(minWidth + 8, 32));</a>
<a name="ln979">}</a>
<a name="ln980"> </a>
<a name="ln981"> </a>
<a name="ln982">status_t</a>
<a name="ln983">KeymapWindow::_GetCurrentKeymap(entry_ref&amp; ref)</a>
<a name="ln984">{</a>
<a name="ln985">	BPath path;</a>
<a name="ln986">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path) != B_OK)</a>
<a name="ln987">		return B_ERROR;</a>
<a name="ln988"> </a>
<a name="ln989">	path.Append(&quot;Key_map&quot;);</a>
<a name="ln990"> </a>
<a name="ln991">	return get_ref_for_path(path.Path(), &amp;ref);</a>
<a name="ln992">}</a>
<a name="ln993"> </a>
<a name="ln994"> </a>
<a name="ln995">BString</a>
<a name="ln996">KeymapWindow::_GetActiveKeymapName()</a>
<a name="ln997">{</a>
<a name="ln998">	BString mapName = kCurrentKeymapName;</a>
<a name="ln999">		// safe default</a>
<a name="ln1000"> </a>
<a name="ln1001">	entry_ref ref;</a>
<a name="ln1002">	_GetCurrentKeymap(ref);</a>
<a name="ln1003"> </a>
<a name="ln1004">	BNode node(&amp;ref);</a>
<a name="ln1005"> </a>
<a name="ln1006">	if (node.InitCheck() == B_OK)</a>
<a name="ln1007">		node.ReadAttrString(&quot;keymap:name&quot;, &amp;mapName);</a>
<a name="ln1008"> </a>
<a name="ln1009">	return mapName;</a>
<a name="ln1010">}</a>
<a name="ln1011"> </a>
<a name="ln1012"> </a>
<a name="ln1013">bool</a>
<a name="ln1014">KeymapWindow::_SelectCurrentMap(BListView* view)</a>
<a name="ln1015">{</a>
<a name="ln1016">	if (fCurrentMapName.Length() &lt;= 0)</a>
<a name="ln1017">		return false;</a>
<a name="ln1018"> </a>
<a name="ln1019">	for (int32 i = 0; i &lt; view-&gt;CountItems(); i++) {</a>
<a name="ln1020">		BStringItem* current = dynamic_cast&lt;BStringItem *&gt;(view-&gt;ItemAt(i));</a>
<a name="ln1021">		if (current != NULL &amp;&amp; fCurrentMapName == current-&gt;Text()) {</a>
<a name="ln1022">			view-&gt;Select(i);</a>
<a name="ln1023">			view-&gt;ScrollToSelection();</a>
<a name="ln1024">			return true;</a>
<a name="ln1025">		}</a>
<a name="ln1026">	}</a>
<a name="ln1027"> </a>
<a name="ln1028">	return false;</a>
<a name="ln1029">}</a>
<a name="ln1030"> </a>
<a name="ln1031"> </a>
<a name="ln1032">void</a>
<a name="ln1033">KeymapWindow::_SelectCurrentMap()</a>
<a name="ln1034">{</a>
<a name="ln1035">	if (!_SelectCurrentMap(fSystemListView)</a>
<a name="ln1036">		&amp;&amp; !_SelectCurrentMap(fUserListView)) {</a>
<a name="ln1037">		// Select the &quot;(Current)&quot; entry if no name matches</a>
<a name="ln1038">		fUserListView-&gt;Select(0L);</a>
<a name="ln1039">	}</a>
<a name="ln1040">}</a>
<a name="ln1041"> </a>
<a name="ln1042"> </a>
<a name="ln1043">status_t</a>
<a name="ln1044">KeymapWindow::_GetSettings(BFile&amp; file, int mode) const</a>
<a name="ln1045">{</a>
<a name="ln1046">	BPath path;</a>
<a name="ln1047">	status_t status = find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path,</a>
<a name="ln1048">		(mode &amp; O_ACCMODE) != O_RDONLY);</a>
<a name="ln1049">	if (status != B_OK)</a>
<a name="ln1050">		return status;</a>
<a name="ln1051"> </a>
<a name="ln1052">	path.Append(&quot;Keymap settings&quot;);</a>
<a name="ln1053"> </a>
<a name="ln1054">	return file.SetTo(path.Path(), mode);</a>
<a name="ln1055">}</a>
<a name="ln1056"> </a>
<a name="ln1057"> </a>
<a name="ln1058">status_t</a>
<a name="ln1059">KeymapWindow::_LoadSettings(BRect&amp; windowFrame)</a>
<a name="ln1060">{</a>
<a name="ln1061">	BScreen screen(this);</a>
<a name="ln1062"> </a>
<a name="ln1063">	windowFrame.Set(-1, -1, 669, 357);</a>
<a name="ln1064">	// See if we can use a larger default size</a>
<a name="ln1065">	if (screen.Frame().Width() &gt; 1200) {</a>
<a name="ln1066">		windowFrame.right = 899;</a>
<a name="ln1067">		windowFrame.bottom = 349;</a>
<a name="ln1068">	}</a>
<a name="ln1069">	float scaling = be_plain_font-&gt;Size() / 12.0f;</a>
<a name="ln1070">	windowFrame.right *= scaling;</a>
<a name="ln1071">	windowFrame.bottom *= scaling;</a>
<a name="ln1072"> </a>
<a name="ln1073">	BFile file;</a>
<a name="ln1074">	status_t status = _GetSettings(file, B_READ_ONLY);</a>
<a name="ln1075">	if (status == B_OK) {</a>
<a name="ln1076">		BMessage settings;</a>
<a name="ln1077">		status = settings.Unflatten(&amp;file);</a>
<a name="ln1078">		if (status == B_OK) {</a>
<a name="ln1079">			BRect frame;</a>
<a name="ln1080">			status = settings.FindRect(&quot;window frame&quot;, &amp;frame);</a>
<a name="ln1081">			if (status == B_OK)</a>
<a name="ln1082">				windowFrame = frame;</a>
<a name="ln1083"> </a>
<a name="ln1084">			const char* layoutPath;</a>
<a name="ln1085">			if (settings.FindString(&quot;keyboard layout&quot;, &amp;layoutPath) == B_OK)</a>
<a name="ln1086">				_SetKeyboardLayout(layoutPath);</a>
<a name="ln1087">		}</a>
<a name="ln1088">	}</a>
<a name="ln1089"> </a>
<a name="ln1090">	return status;</a>
<a name="ln1091">}</a>
<a name="ln1092"> </a>
<a name="ln1093"> </a>
<a name="ln1094">status_t</a>
<a name="ln1095">KeymapWindow::_SaveSettings()</a>
<a name="ln1096">{</a>
<a name="ln1097">	BFile file;</a>
<a name="ln1098">	status_t status</a>
<a name="ln1099">		= _GetSettings(file, B_WRITE_ONLY | B_ERASE_FILE | B_CREATE_FILE);</a>
<a name="ln1100">	if (status != B_OK)</a>
<a name="ln1101">		return status;</a>
<a name="ln1102"> </a>
<a name="ln1103">	BMessage settings('keym');</a>
<a name="ln1104">	settings.AddRect(&quot;window frame&quot;, Frame());</a>
<a name="ln1105"> </a>
<a name="ln1106">	BPath path = _GetMarkedKeyboardLayoutPath(fLayoutMenu);</a>
<a name="ln1107">	if (path.InitCheck() == B_OK)</a>
<a name="ln1108">		settings.AddString(&quot;keyboard layout&quot;, path.Path());</a>
<a name="ln1109"> </a>
<a name="ln1110">	return settings.Flatten(&amp;file);</a>
<a name="ln1111">}</a>
<a name="ln1112"> </a>
<a name="ln1113"> </a>
<a name="ln1114">/*!	Gets the path of the currently marked keyboard layout item</a>
<a name="ln1115">	by searching through each of the menus recursively until</a>
<a name="ln1116">	a marked item is found.</a>
<a name="ln1117">*/</a>
<a name="ln1118">BPath</a>
<a name="ln1119">KeymapWindow::_GetMarkedKeyboardLayoutPath(BMenu* menu)</a>
<a name="ln1120">{</a>
<a name="ln1121">	BPath path;</a>
<a name="ln1122">	BMenuItem* item = NULL;</a>
<a name="ln1123">	entry_ref ref;</a>
<a name="ln1124"> </a>
<a name="ln1125">	for (int32 i = 0; i &lt; menu-&gt;CountItems(); i++) {</a>
<a name="ln1126">		item = menu-&gt;ItemAt(i);</a>
<a name="ln1127">		if (item == NULL)</a>
<a name="ln1128">			continue;</a>
<a name="ln1129"> </a>
<a name="ln1130">		BMenu* submenu = item-&gt;Submenu();</a>
<a name="ln1131">		if (submenu != NULL) {</a>
<a name="ln1132">			path = _GetMarkedKeyboardLayoutPath(submenu);</a>
<a name="ln1133">			if (path.InitCheck() == B_OK)</a>
<a name="ln1134">				return path;</a>
<a name="ln1135">		} else {</a>
<a name="ln1136">			if (item-&gt;IsMarked()</a>
<a name="ln1137">				&amp;&amp; item-&gt;Message()-&gt;FindRef(&quot;ref&quot;, &amp;ref) == B_OK) {</a>
<a name="ln1138">				path.SetTo(&amp;ref);</a>
<a name="ln1139">				return path;</a>
<a name="ln1140">			}</a>
<a name="ln1141">		}</a>
<a name="ln1142">	}</a>
<a name="ln1143"> </a>
<a name="ln1144">	return path;</a>
<a name="ln1145">}</a>

</code></pre>
<div class="balloon" rel="679"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'message' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
