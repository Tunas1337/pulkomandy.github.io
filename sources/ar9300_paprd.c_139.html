
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ar9300_paprd.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright (c) 2013 Qualcomm Atheros, Inc.</a>
<a name="ln3"> *</a>
<a name="ln4"> * Permission to use, copy, modify, and/or distribute this software for any</a>
<a name="ln5"> * purpose with or without fee is hereby granted, provided that the above</a>
<a name="ln6"> * copyright notice and this permission notice appear in all copies.</a>
<a name="ln7"> *</a>
<a name="ln8"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH</a>
<a name="ln9"> * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY</a>
<a name="ln10"> * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,</a>
<a name="ln11"> * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM</a>
<a name="ln12"> * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR</a>
<a name="ln13"> * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR</a>
<a name="ln14"> * PERFORMANCE OF THIS SOFTWARE.</a>
<a name="ln15"> */</a>
<a name="ln16"> </a>
<a name="ln17">#include &quot;opt_ah.h&quot;</a>
<a name="ln18">#include &quot;ah.h&quot;</a>
<a name="ln19">#include &quot;ar9300.h&quot;</a>
<a name="ln20">#include &quot;ah_internal.h&quot;</a>
<a name="ln21">#include &quot;ar9300paprd.h&quot;</a>
<a name="ln22">#include &quot;ar9300reg.h&quot;</a>
<a name="ln23"> </a>
<a name="ln24"> </a>
<a name="ln25">#if ATH_SUPPORT_PAPRD</a>
<a name="ln26"> </a>
<a name="ln27">static struct ar9300_paprd_pwr_adjust ar9300_paprd_pwr_adj_array[] = {</a>
<a name="ln28">/*   rate index     ,   register offset   ,  mask of register               , */</a>
<a name="ln29">  {ALL_TARGET_HT20_5, AR_PHY_POWERTX_RATE5, AR_PHY_POWERTX_RATE5_POWERTXHT20_3,</a>
<a name="ln30">/* mask offset of register             ,  offset  dB*/</a>
<a name="ln31">   AR_PHY_POWERTX_RATE5_POWERTXHT20_3_S,      1},</a>
<a name="ln32">  {ALL_TARGET_HT20_6, AR_PHY_POWERTX_RATE6, AR_PHY_POWERTX_RATE6_POWERTXHT20_4,</a>
<a name="ln33">   AR_PHY_POWERTX_RATE6_POWERTXHT20_4_S,      2},</a>
<a name="ln34">  {ALL_TARGET_HT20_7, AR_PHY_POWERTX_RATE6, AR_PHY_POWERTX_RATE6_POWERTXHT20_5,</a>
<a name="ln35">   AR_PHY_POWERTX_RATE6_POWERTXHT20_5_S,      2},</a>
<a name="ln36">  {ALL_TARGET_HT40_5, AR_PHY_POWERTX_RATE7, AR_PHY_POWERTX_RATE7_POWERTXHT40_3,</a>
<a name="ln37">   AR_PHY_POWERTX_RATE7_POWERTXHT40_3_S,      1},</a>
<a name="ln38">  {ALL_TARGET_HT40_6, AR_PHY_POWERTX_RATE8, AR_PHY_POWERTX_RATE8_POWERTXHT40_4,</a>
<a name="ln39">   AR_PHY_POWERTX_RATE8_POWERTXHT40_4_S,      2},</a>
<a name="ln40">  {ALL_TARGET_HT40_7, AR_PHY_POWERTX_RATE8, AR_PHY_POWERTX_RATE8_POWERTXHT40_5,</a>
<a name="ln41">   AR_PHY_POWERTX_RATE8_POWERTXHT40_5_S,      2},</a>
<a name="ln42"> {ALL_TARGET_LEGACY_54, AR_PHY_POWERTX_RATE2, AR_PHY_POWERTX_RATE2_POWERTX54M_7,</a>
<a name="ln43">   AR_PHY_POWERTX_RATE2_POWERTX54M_7_S,       2},</a>
<a name="ln44">};</a>
<a name="ln45"> </a>
<a name="ln46">HAL_BOOL create_pa_curve(u_int32_t * paprd_train_data_l,</a>
<a name="ln47">    u_int32_t *paprd_train_data_u, u_int32_t *pa_table, u_int32_t *g_fxp_ext,</a>
<a name="ln48">    int * pa_in);</a>
<a name="ln49"> </a>
<a name="ln50">static int</a>
<a name="ln51">ar9300_paprd_setup_single_table(struct ath_hal *ah, struct ieee80211_channel * chan)</a>
<a name="ln52">{</a>
<a name="ln53">    int is_2g = IEEE80211_IS_CHAN_2GHZ(chan);</a>
<a name="ln54">    HAL_CHANNEL_INTERNAL *ichan = ath_hal_checkchannel(ah, chan);</a>
<a name="ln55">    struct ath_hal_9300 *ahp = AH9300(ah);</a>
<a name="ln56">    int is_ht40 = 0;</a>
<a name="ln57">    u_int32_t am_mask = 0;</a>
<a name="ln58">    u_int32_t val = OS_REG_READ(ah, AR_2040_MODE);</a>
<a name="ln59">    u_int8_t target_power_val_t2[ar9300_rate_size];</a>
<a name="ln60">    int      power_tblindex = 0, power_delta = 0;</a>
<a name="ln61">    int      paprd_scale_factor = 5;  </a>
<a name="ln62"> </a>
<a name="ln63">    const u_int8_t mask2num[8] = {</a>
<a name="ln64">        0 /* 000 */,</a>
<a name="ln65">        1 /* 001 */,</a>
<a name="ln66">        1 /* 010 */,</a>
<a name="ln67">        2 /* 011 */,</a>
<a name="ln68">        1 /* 100 */,</a>
<a name="ln69">        2 /* 101 */,</a>
<a name="ln70">        2 /* 110 */,</a>
<a name="ln71">        3 /* 111 */</a>
<a name="ln72">    };</a>
<a name="ln73"> </a>
<a name="ln74">    ar9300_eeprom_t *eep = &amp;AH9300(ah)-&gt;ah_eeprom;</a>
<a name="ln75"> </a>
<a name="ln76">#define ABS(_x, _y) ((int)_x &gt; (int)_y ? (int)_x - (int)_y : (int)_y - (int)_x)</a>
<a name="ln77"> </a>
<a name="ln78">    ar9300_set_target_power_from_eeprom(ah, ichan-&gt;channel, target_power_val_t2);</a>
<a name="ln79">    if (val &amp; HAL_HT_MACMODE_2040) {</a>
<a name="ln80">        is_ht40 = 1;</a>
<a name="ln81">    }</a>
<a name="ln82"> </a>
<a name="ln83">    /*</a>
<a name="ln84">     * Note on paprd_scale_factor</a>
<a name="ln85">     * This factor is saved in eeprom as 3 bit fields in following fashion. </a>
<a name="ln86">     * In 5G there are 3 scale factors -- upper, mid and lower band.</a>
<a name="ln87">     * Upper band scale factor is coded in bits 25-27 of</a>
<a name="ln88">     * modal_header_5g.paprd_rate_mask_ht20.</a>
<a name="ln89">     * Mid band scale factor is coded in bits 28-30 of</a>
<a name="ln90">     * modal_header_5g.paprd_rate_mask_ht40.</a>
<a name="ln91">     * Lower band scale factor is coded in bits 25-27 of</a>
<a name="ln92">     * modal_header_5g.paprd_rate_mask_ht40.</a>
<a name="ln93">     * For 2G there is only one scale factor. It is saved in bits 25-27 of</a>
<a name="ln94">     * modal_header_2g.paprd_rate_mask_ht20.</a>
<a name="ln95">     */</a>
<a name="ln96">    AH_PAPRD_GET_SCALE_FACTOR(paprd_scale_factor, eep, is_2g, ichan-&gt;channel);</a>
<a name="ln97">    if (is_2g) {</a>
<a name="ln98">        if (is_ht40) {</a>
<a name="ln99">            am_mask = ahp-&gt;ah_2g_paprd_rate_mask_ht40 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln100">            power_tblindex = ALL_TARGET_HT40_0_8_16;</a>
<a name="ln101">        } else {</a>
<a name="ln102">            am_mask = ahp-&gt;ah_2g_paprd_rate_mask_ht20 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln103">            power_tblindex = ALL_TARGET_HT20_0_8_16;</a>
<a name="ln104">        }</a>
<a name="ln105">        if (AR_SREV_HORNET(ah) || AR_SREV_WASP(ah) || AR_SREV_JUPITER(ah) || AR_SREV_APHRODITE(ah)) {</a>
<a name="ln106">            if (is_ht40) {</a>
<a name="ln107">                ahp-&gt;paprd_training_power = </a>
<a name="ln108">                    target_power_val_t2[ALL_TARGET_HT40_7] + 2;</a>
<a name="ln109">            } else {</a>
<a name="ln110">                ahp-&gt;paprd_training_power = </a>
<a name="ln111">                    target_power_val_t2[ALL_TARGET_HT20_7] + 2;</a>
<a name="ln112">            }</a>
<a name="ln113">		} else if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln114">            ahp-&gt;paprd_training_power = 25;</a>
<a name="ln115">        } else {</a>
<a name="ln116">            ahp-&gt;paprd_training_power =</a>
<a name="ln117">                OS_REG_READ_FIELD_ALT(ah, AR_PHY_POWERTX_RATE5,</a>
<a name="ln118">                AR_PHY_POWERTX_RATE5_POWERTXHT20_0);</a>
<a name="ln119">            if (ABS(target_power_val_t2[power_tblindex], </a>
<a name="ln120">                ahp-&gt;paprd_training_power) &gt;  paprd_scale_factor)</a>
<a name="ln121">            {</a>
<a name="ln122">                HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln123">                    &quot;%s[%d]: Chan %d paprd failing EEP PWR 0x%08x&quot; </a>
<a name="ln124">                    &quot;TGT PWR 0x%08x\n&quot;, __func__, __LINE__, ichan-&gt;channel,</a>
<a name="ln125">                    target_power_val_t2[power_tblindex], </a>
<a name="ln126">                    ahp-&gt;paprd_training_power);</a>
<a name="ln127">                goto FAILED;</a>
<a name="ln128">            }</a>
<a name="ln129">            </a>
<a name="ln130">            power_delta =</a>
<a name="ln131">                ABS(ahp-&gt;paprd_training_power, </a>
<a name="ln132">                    target_power_val_t2[power_tblindex]);</a>
<a name="ln133"> </a>
<a name="ln134">            power_delta = power_delta &gt; 4 ? 0 : 4 - power_delta;</a>
<a name="ln135">            ahp-&gt;paprd_training_power = </a>
<a name="ln136">                ahp-&gt;paprd_training_power - power_delta;</a>
<a name="ln137">        }</a>
<a name="ln138"> </a>
<a name="ln139"> </a>
<a name="ln140">    } else {</a>
<a name="ln141">        if (is_ht40) {</a>
<a name="ln142">            ahp-&gt;paprd_training_power =</a>
<a name="ln143">			    OS_REG_READ_FIELD_ALT(ah, AR_PHY_POWERTX_RATE8,</a>
<a name="ln144">				AR_PHY_POWERTX_RATE8_POWERTXHT40_5);</a>
<a name="ln145">            am_mask = ahp-&gt;ah_5g_paprd_rate_mask_ht40 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln146">            switch (mask2num[ahp-&gt;ah_tx_chainmask])</a>
<a name="ln147">            {</a>
<a name="ln148">            case 1:</a>
<a name="ln149">                power_delta = 6;</a>
<a name="ln150">                break;</a>
<a name="ln151">            case 2:</a>
<a name="ln152">                power_delta = 4;</a>
<a name="ln153">                break;</a>
<a name="ln154">            case 3:</a>
<a name="ln155">                power_delta = 2;</a>
<a name="ln156">                break;</a>
<a name="ln157">            default:</a>
<a name="ln158">                goto FAILED;</a>
<a name="ln159">                break;</a>
<a name="ln160">            }</a>
<a name="ln161">            power_tblindex = ALL_TARGET_HT40_7;</a>
<a name="ln162">        } else {</a>
<a name="ln163">            ahp-&gt;paprd_training_power =</a>
<a name="ln164">			    OS_REG_READ_FIELD_ALT(ah, AR_PHY_POWERTX_RATE6,</a>
<a name="ln165">				AR_PHY_POWERTX_RATE6_POWERTXHT20_5);</a>
<a name="ln166">            am_mask = ahp-&gt;ah_5g_paprd_rate_mask_ht20 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln167">            switch (mask2num[ahp-&gt;ah_tx_chainmask])</a>
<a name="ln168">            {</a>
<a name="ln169">            case 1:</a>
<a name="ln170">                power_delta = 6;</a>
<a name="ln171">                break;</a>
<a name="ln172">            case 2:</a>
<a name="ln173">                power_delta = 4;</a>
<a name="ln174">                break;</a>
<a name="ln175">            case 3:</a>
<a name="ln176">                power_delta = 2;</a>
<a name="ln177">                break;</a>
<a name="ln178">            default:</a>
<a name="ln179">                goto FAILED;</a>
<a name="ln180">                break;</a>
<a name="ln181">            }</a>
<a name="ln182">            power_tblindex = ALL_TARGET_HT20_7;</a>
<a name="ln183">        }</a>
<a name="ln184">        /* Adjust for scale factor */</a>
<a name="ln185">        ahp-&gt;paprd_training_power += paprd_scale_factor;</a>
<a name="ln186">        /*</a>
<a name="ln187">        ath_hal_printf(ah, &quot;%s[%d] paprd_scale_factor %d power_delta %d\n&quot;,</a>
<a name="ln188">            __func__, __LINE__, paprd_scale_factor, power_delta);</a>
<a name="ln189">         */</a>
<a name="ln190">        if (ABS(target_power_val_t2[power_tblindex], ahp-&gt;paprd_training_power)</a>
<a name="ln191">            &gt;  paprd_scale_factor)</a>
<a name="ln192">        {</a>
<a name="ln193">            HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln194">                &quot;%s[%d]: Chan %d paprd failing EEP PWR 0x%08x TGT PWR 0x%08x\n&quot;,</a>
<a name="ln195">                __func__, __LINE__, ichan-&gt;channel,</a>
<a name="ln196">                target_power_val_t2[power_tblindex], ahp-&gt;paprd_training_power);</a>
<a name="ln197">            goto FAILED;</a>
<a name="ln198">        }</a>
<a name="ln199">        ahp-&gt;paprd_training_power = ahp-&gt;paprd_training_power + power_delta;</a>
<a name="ln200">    }</a>
<a name="ln201"> </a>
<a name="ln202">    HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s 2G %d HT40 %d am_mask 0x%08x\n&quot;,</a>
<a name="ln203">        __func__, is_2g, is_ht40, am_mask);</a>
<a name="ln204">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_AM2AM, AR_PHY_PAPRD_AM2AM_MASK,</a>
<a name="ln205">        am_mask);</a>
<a name="ln206">    if (AR_SREV_HORNET(ah)) {</a>
<a name="ln207">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_AM2PM, AR_PHY_PAPRD_AM2PM_MASK,</a>
<a name="ln208">            0);</a>
<a name="ln209">    }</a>
<a name="ln210">    else {</a>
<a name="ln211">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_AM2PM, AR_PHY_PAPRD_AM2PM_MASK,</a>
<a name="ln212">            am_mask);</a>
<a name="ln213">    }</a>
<a name="ln214"> </a>
<a name="ln215">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_HT40, AR_PHY_PAPRD_HT40_MASK,</a>
<a name="ln216">        AR_PHY_PAPRD_HT40_MASK);</a>
<a name="ln217">    /* chain0 */</a>
<a name="ln218">    if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN0_MASK) {</a>
<a name="ln219">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln220">            AR_PHY_PAPRD_CTRL0_B0_USE_SINGLE_TABLE_MASK, 1);</a>
<a name="ln221">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln222">            AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2PM_ENABLE_0, 1);</a>
<a name="ln223">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln224">            AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2AM_ENABLE_0, 1);</a>
<a name="ln225">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln226">            AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln227">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln228">            AR_PHY_PAPRD_CTRL1_B0_PA_GAIN_SCALE_FACT_0_MASK, 181);</a>
<a name="ln229">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln230">            AR_PHY_PAPRD_CTRL1_B0_PAPRD_MAG_SCALE_FACT_0, 361);</a>
<a name="ln231">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln232">            AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln233">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln234">            AR_PHY_PAPRD_CTRL0_B0_PAPRD_MAG_THRSH_0, 3);</a>
<a name="ln235">    }</a>
<a name="ln236"> </a>
<a name="ln237">    /* chain1 */</a>
<a name="ln238">    if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN1_MASK) {</a>
<a name="ln239">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln240">            AR_PHY_PAPRD_CTRL0_B1_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_1, 1);</a>
<a name="ln241">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln242">            AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2PM_ENABLE_1, 1);</a>
<a name="ln243">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln244">            AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2AM_ENABLE_1, 1);</a>
<a name="ln245">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln246">            AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln247">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln248">            AR_PHY_PAPRD_CTRL1_B1_PA_GAIN_SCALE_FACT_1_MASK, 181);</a>
<a name="ln249">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln250">            AR_PHY_PAPRD_CTRL1_B1_PAPRD_MAG_SCALE_FACT_1, 361);</a>
<a name="ln251">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln252">            AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln253">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln254">            AR_PHY_PAPRD_CTRL0_B1_PAPRD_MAG_THRSH_1, 3);</a>
<a name="ln255">    }</a>
<a name="ln256"> </a>
<a name="ln257">    /* chain2 */</a>
<a name="ln258">    if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN2_MASK) {</a>
<a name="ln259">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln260">            AR_PHY_PAPRD_CTRL0_B2_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_2, 1);</a>
<a name="ln261">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln262">            AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2PM_ENABLE_2, 1);</a>
<a name="ln263">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln264">            AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2AM_ENABLE_2, 1);</a>
<a name="ln265">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln266">            AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln267">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln268">            AR_PHY_PAPRD_CTRL1_B2_PA_GAIN_SCALE_FACT_2_MASK, 181);</a>
<a name="ln269">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln270">            AR_PHY_PAPRD_CTRL1_B2_PAPRD_MAG_SCALE_FACT_2, 361);</a>
<a name="ln271">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln272">            AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln273">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln274">            AR_PHY_PAPRD_CTRL0_B2_PAPRD_MAG_THRSH_2, 3);</a>
<a name="ln275">    }</a>
<a name="ln276"> </a>
<a name="ln277">    ar9300_enable_paprd(ah, AH_FALSE, chan);</a>
<a name="ln278">    if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln279">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln280">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP, 0x30);</a>
<a name="ln281">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln282">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE, 1);</a>
<a name="ln283">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln284">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE, 1);</a>
<a name="ln285">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln286">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE, 0);</a>
<a name="ln287">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln288">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE, 0);</a>
<a name="ln289">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln290">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING, 28);</a>
<a name="ln291">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln292">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE, 1);</a>
<a name="ln293">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL2_POSEIDON,</a>
<a name="ln294">            AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN, 148);</a>
<a name="ln295">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln296">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN, 4);</a>
<a name="ln297">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln298">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN, 4);</a>
<a name="ln299">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln300">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES, 7);</a>
<a name="ln301">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln302">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL, 1);</a>
<a name="ln303">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln304">	        AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, -3);</a>
<a name="ln305">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln306">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE, -15);</a>
<a name="ln307">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln308">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE, 1);</a>
<a name="ln309">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON,</a>
<a name="ln310">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA, 0);</a>
<a name="ln311">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON,</a>
<a name="ln312">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR, 400);</a>
<a name="ln313">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON,</a>
<a name="ln314">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_NUM_TRAIN_SAMPLES, 100);</a>
<a name="ln315">    } else {</a>
<a name="ln316">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln317">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP, 0x30);</a>
<a name="ln318">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln319">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE, 1);</a>
<a name="ln320">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln321">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE, 1);</a>
<a name="ln322">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln323">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE, 0);</a>
<a name="ln324">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln325">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE, 0);</a>
<a name="ln326">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln327">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING, 28);</a>
<a name="ln328">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln329">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE, 1);</a>
<a name="ln330">        if (is_2g) {</a>
<a name="ln331">        	 if(AR_SREV_JUPITER(ah) || AR_SREV_APHRODITE(ah)){ </a>
<a name="ln332">             OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL2,</a>
<a name="ln333">                 AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN, 0x91);</a>
<a name="ln334">           }else{</a>
<a name="ln335">             OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL2,</a>
<a name="ln336">                 AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN, 147);          	</a>
<a name="ln337">           }</a>
<a name="ln338">        }</a>
<a name="ln339">		else if (AR_SREV_WASP(ah) &amp;&amp; !is_2g) {</a>
<a name="ln340">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL2,</a>
<a name="ln341">	            AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN, 137);</a>
<a name="ln342">		} else {</a>
<a name="ln343">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL2,</a>
<a name="ln344">	            AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN, 147);</a>
<a name="ln345">        }</a>
<a name="ln346">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln347">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN, 4);</a>
<a name="ln348">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln349">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN, 4);</a>
<a name="ln350">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln351">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES, 7);</a>
<a name="ln352">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln353">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL, 1);</a>
<a name="ln354">        if (AR_SREV_HORNET(ah) || AR_SREV_WASP(ah) || AR_SREV_JUPITER(ah) || AR_SREV_APHRODITE(ah)) {</a>
<a name="ln355">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln356">                AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, -3);</a>
<a name="ln357">        } else {</a>
<a name="ln358">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln359">                AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, -6);</a>
<a name="ln360">        }</a>
<a name="ln361">        if (is_2g) {</a>
<a name="ln362">            if(AR_SREV_JUPITER(ah) || AR_SREV_APHRODITE(ah)){       	</a>
<a name="ln363">                OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln364">                    AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE, -10);</a>
<a name="ln365">            }else{</a>
<a name="ln366">                OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln367">                    AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE, -15);         	           </a>
<a name="ln368">            }</a>
<a name="ln369">        }</a>
<a name="ln370">        else {</a>
<a name="ln371">             OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln372">                 AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE, -10);</a>
<a name="ln373">        }</a>
<a name="ln374">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln375">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE, 1);</a>
<a name="ln376">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4,</a>
<a name="ln377">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA, 0);</a>
<a name="ln378">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4,</a>
<a name="ln379">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR, 400);</a>
<a name="ln380">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4,</a>
<a name="ln381">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_NUM_TRAIN_SAMPLES, 100);</a>
<a name="ln382">    }</a>
<a name="ln383"> </a>
<a name="ln384">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_0_B0,</a>
<a name="ln385">        AR_PHY_PAPRD_PRE_POST_SCALE_0_B0_PAPRD_PRE_POST_SCALING_0_0, 261376);</a>
<a name="ln386">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_1_B0,</a>
<a name="ln387">        AR_PHY_PAPRD_PRE_POST_SCALE_1_B0_PAPRD_PRE_POST_SCALING_1_0, 248079);</a>
<a name="ln388">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_2_B0,</a>
<a name="ln389">        AR_PHY_PAPRD_PRE_POST_SCALE_2_B0_PAPRD_PRE_POST_SCALING_2_0, 233759);</a>
<a name="ln390">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_3_B0,</a>
<a name="ln391">        AR_PHY_PAPRD_PRE_POST_SCALE_3_B0_PAPRD_PRE_POST_SCALING_3_0, 220464);</a>
<a name="ln392">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_4_B0,</a>
<a name="ln393">        AR_PHY_PAPRD_PRE_POST_SCALE_4_B0_PAPRD_PRE_POST_SCALING_4_0, 208194);</a>
<a name="ln394">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_5_B0,</a>
<a name="ln395">        AR_PHY_PAPRD_PRE_POST_SCALE_5_B0_PAPRD_PRE_POST_SCALING_5_0, 196949);</a>
<a name="ln396">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_6_B0,</a>
<a name="ln397">        AR_PHY_PAPRD_PRE_POST_SCALE_6_B0_PAPRD_PRE_POST_SCALING_6_0, 185706);</a>
<a name="ln398">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_PRE_POST_SCALE_7_B0,</a>
<a name="ln399">        AR_PHY_PAPRD_PRE_POST_SCALE_7_B0_PAPRD_PRE_POST_SCALING_7_0, 175487);</a>
<a name="ln400">    return 0;</a>
<a name="ln401">    </a>
<a name="ln402">FAILED:</a>
<a name="ln403">    return -1;</a>
<a name="ln404">#undef ABS    </a>
<a name="ln405">}</a>
<a name="ln406"> </a>
<a name="ln407">/*</a>
<a name="ln408"> * XXX There's another copy of this in ar9300_reset.c, use that!</a>
<a name="ln409"> */</a>
<a name="ln410">#if 0</a>
<a name="ln411">static inline HAL_CHANNEL_INTERNAL*</a>
<a name="ln412">ar9300_check_chan(struct ath_hal *ah, HAL_CHANNEL *chan)</a>
<a name="ln413">{</a>
<a name="ln414">    if ((AR9300_IS_CHAN(chan, CHANNEL_2GHZ) ^</a>
<a name="ln415">         AR9300_IS_CHAN(chan, CHANNEL_5GHZ)) == 0)</a>
<a name="ln416">    {</a>
<a name="ln417">        HALDEBUG(ah, HAL_DEBUG_CHANNEL,</a>
<a name="ln418">            &quot;%s: invalid channel %u/0x%x; not marked as 2GHz or 5GHz\n&quot;,</a>
<a name="ln419">            __func__, chan-&gt;channel, chan-&gt;channel_flags);</a>
<a name="ln420">        return AH_NULL;</a>
<a name="ln421">    }</a>
<a name="ln422"> </a>
<a name="ln423">    if ((AR9300_IS_CHAN(chan, CHANNEL_OFDM)     ^</a>
<a name="ln424">         AR9300_IS_CHAN(chan, CHANNEL_CCK)      ^</a>
<a name="ln425">         AR9300_IS_CHAN(chan, CHANNEL_HT20)     ^</a>
<a name="ln426">         AR9300_IS_CHAN(chan, CHANNEL_HT40PLUS) ^</a>
<a name="ln427">         AR9300_IS_CHAN(chan, CHANNEL_HT40MINUS)) == 0)</a>
<a name="ln428">    {</a>
<a name="ln429">        HALDEBUG(ah, HAL_DEBUG_CHANNEL,</a>
<a name="ln430">            &quot;%s: invalid channel %u/0x%x; not marked as &quot;</a>
<a name="ln431">            &quot;OFDM or CCK or HT20 or HT40PLUS or HT40MINUS\n&quot;, __func__,</a>
<a name="ln432">            chan-&gt;channel, chan-&gt;channel_flags);</a>
<a name="ln433">        return AH_NULL;</a>
<a name="ln434">    }</a>
<a name="ln435"> </a>
<a name="ln436">    return (ath_hal_checkchannel(ah, chan));</a>
<a name="ln437">}</a>
<a name="ln438">#endif</a>
<a name="ln439"> </a>
<a name="ln440">void ar9300_enable_paprd(struct ath_hal *ah, HAL_BOOL enable_flag,</a>
<a name="ln441">    struct ieee80211_channel * chan)</a>
<a name="ln442">{</a>
<a name="ln443">    HAL_BOOL enable = enable_flag;</a>
<a name="ln444">    u_int32_t am_mask = 0;</a>
<a name="ln445">    u_int32_t val = OS_REG_READ(ah, AR_2040_MODE);</a>
<a name="ln446">    int is_2g = IEEE80211_IS_CHAN_2GHZ(chan);</a>
<a name="ln447">    HAL_CHANNEL_INTERNAL *ichan = ath_hal_checkchannel(ah, chan);</a>
<a name="ln448">    int is_ht40 = 0;</a>
<a name="ln449">    struct ath_hal_9300 *ahp = AH9300(ah);</a>
<a name="ln450"> </a>
<a name="ln451">    if (val &amp; HAL_HT_MACMODE_2040) {</a>
<a name="ln452">        is_ht40 = 1;</a>
<a name="ln453">    }</a>
<a name="ln454">    if (enable_flag == AH_TRUE) {</a>
<a name="ln455">        ar9300_eeprom_t *eep = &amp;AH9300(ah)-&gt;ah_eeprom;</a>
<a name="ln456"> </a>
<a name="ln457">        if (!is_2g) {</a>
<a name="ln458">            /*</a>
<a name="ln459">             * 3 bits for modal_header_5g.paprd_rate_mask_ht20</a>
<a name="ln460">             * is used for sub band disabling of paprd.</a>
<a name="ln461">             * 5G band is divided into 3 sub bands -- upper, mid, lower.</a>
<a name="ln462">             * If bit 30 of modal_header_5g.paprd_rate_mask_ht20 is set</a>
<a name="ln463">             * to one -- disable paprd for upper 5G</a>
<a name="ln464">             * If bit 29 of modal_header_5g.paprd_rate_mask_ht20 is set</a>
<a name="ln465">             * to one -- disable paprd for mid 5G</a>
<a name="ln466">             * If bit 28 of modal_header_5g.paprd_rate_mask_ht20 is set</a>
<a name="ln467">             * to one -- disable paprd for lower 5G</a>
<a name="ln468">             * u_int32_t am_mask = eep-&gt;modal_header_5g.paprd_rate_mask_ht20;</a>
<a name="ln469">             */</a>
<a name="ln470">            if (ichan-&gt;channel &gt;= UPPER_5G_SUB_BANDSTART) {</a>
<a name="ln471">                if (eep-&gt;modal_header_5g.paprd_rate_mask_ht20 &amp; (1 &lt;&lt; 30)) {</a>
<a name="ln472">                    enable = AH_FALSE;</a>
<a name="ln473">                }</a>
<a name="ln474">            } else if (ichan-&gt;channel &gt;= MID_5G_SUB_BANDSTART) {</a>
<a name="ln475">                if (eep-&gt;modal_header_5g.paprd_rate_mask_ht20 &amp; (1 &lt;&lt; 29)) {</a>
<a name="ln476">                    enable = AH_FALSE;</a>
<a name="ln477">                }</a>
<a name="ln478">            } else { /* must be in the lower 5G subband */</a>
<a name="ln479">                if (eep-&gt;modal_header_5g.paprd_rate_mask_ht20 &amp; (1 &lt;&lt; 28)) {</a>
<a name="ln480">                    enable = AH_FALSE;</a>
<a name="ln481">                }</a>
<a name="ln482">            }</a>
<a name="ln483">        }</a>
<a name="ln484"> </a>
<a name="ln485">        if (ahp-&gt;ah_paprd_broken) {</a>
<a name="ln486">            ahp-&gt;ah_paprd_broken = AH_FALSE;</a>
<a name="ln487">            enable = AH_FALSE;</a>
<a name="ln488"> </a>
<a name="ln489">            HALDEBUG(ah, HAL_DEBUG_UNMASKABLE, </a>
<a name="ln490">                     &quot;%s: PAPRD is in bad state. Don't enable PAPRD\n&quot;,</a>
<a name="ln491">                     __func__);</a>
<a name="ln492">        }</a>
<a name="ln493">    }</a>
<a name="ln494">    if (enable) {</a>
<a name="ln495">        HAL_CHANNEL_INTERNAL *ichan;</a>
<a name="ln496">        if (is_2g) {</a>
<a name="ln497">            if (is_ht40) {</a>
<a name="ln498">                am_mask = ahp-&gt;ah_2g_paprd_rate_mask_ht40 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln499">            } else {</a>
<a name="ln500">                am_mask = ahp-&gt;ah_2g_paprd_rate_mask_ht20 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln501">            }</a>
<a name="ln502">        } else {</a>
<a name="ln503">            if (is_ht40) {</a>
<a name="ln504">                am_mask = ahp-&gt;ah_5g_paprd_rate_mask_ht40 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln505">            } else {</a>
<a name="ln506">                am_mask = ahp-&gt;ah_5g_paprd_rate_mask_ht20 &amp; AH_PAPRD_AM_PM_MASK;</a>
<a name="ln507">            }</a>
<a name="ln508">        }</a>
<a name="ln509">        /* Earlier we promgrammed TGT Power with Scaled down value, since</a>
<a name="ln510">         * PAPRD CAL was not done.</a>
<a name="ln511">         * Now we finish PAPRD CAL, so bump up the TGT PWR to original</a>
<a name="ln512">         * EEPROM Power. CTLs calc and Maverickd in</a>
<a name="ln513">         * &quot;ar9300_eeprom_set_transmit_power&quot;</a>
<a name="ln514">         */</a>
<a name="ln515">        ichan = ar9300_check_chan(ah, chan);</a>
<a name="ln516">        ichan-&gt;paprd_table_write_done = 1;</a>
<a name="ln517">//        chan-&gt;paprd_table_write_done = 1;</a>
<a name="ln518">        /*</a>
<a name="ln519">        ath_hal_printf(ah, &quot;%s[%d] eeprom_set_transmit_power PAPRD\n&quot;,</a>
<a name="ln520">            __func__, __LINE__);</a>
<a name="ln521">         */</a>
<a name="ln522">        if (ar9300_eeprom_set_transmit_power(ah, &amp;ahp-&gt;ah_eeprom, chan,</a>
<a name="ln523">            ath_hal_getctl(ah, chan), ath_hal_getantennaallowed(ah, chan),</a>
<a name="ln524">            ath_hal_get_twice_max_regpower(AH_PRIVATE(ah), ichan, chan),</a>
<a name="ln525">            AH_MIN(MAX_RATE_POWER, AH_PRIVATE(ah)-&gt;ah_powerLimit)) != HAL_OK) {</a>
<a name="ln526">            ichan-&gt;paprd_table_write_done = 0;</a>
<a name="ln527">//            chan-&gt;paprd_table_write_done = 0;</a>
<a name="ln528">            /* Intentional print */</a>
<a name="ln529">            ath_hal_printf(ah,</a>
<a name="ln530">                &quot;%s[%d] eeprom_set_transmit_power failed ABORT PAPRD\n&quot;,</a>
<a name="ln531">                __func__, __LINE__);</a>
<a name="ln532">            </a>
<a name="ln533">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln534">                AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0, 0);</a>
<a name="ln535">            if (!AR_SREV_POSEIDON(ah) &amp;&amp; !AR_SREV_HORNET(ah)) {</a>
<a name="ln536">                OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln537">                    AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1, 0);</a>
<a name="ln538">                if (!AR_SREV_JUPITER(ah) || (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN2_MASK)) {</a>
<a name="ln539">                    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln540">                        AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2, 0);</a>
<a name="ln541"> </a>
<a name="ln542">                }</a>
<a name="ln543">            }</a>
<a name="ln544">            return;</a>
<a name="ln545">        }</a>
<a name="ln546"> </a>
<a name="ln547">        HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s 2G %d HT40 %d am_mask 0x%08x\n&quot;,</a>
<a name="ln548">            __func__, is_2g, is_ht40, am_mask);</a>
<a name="ln549">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_AM2AM, AR_PHY_PAPRD_AM2AM_MASK,</a>
<a name="ln550">            am_mask);</a>
<a name="ln551">        if (AR_SREV_HORNET(ah)) {</a>
<a name="ln552">            OS_REG_RMW_FIELD_ALT(ah,</a>
<a name="ln553">                AR_PHY_PAPRD_AM2PM, AR_PHY_PAPRD_AM2PM_MASK, 0);</a>
<a name="ln554">        } else {</a>
<a name="ln555">            OS_REG_RMW_FIELD_ALT(ah,</a>
<a name="ln556">                AR_PHY_PAPRD_AM2PM, AR_PHY_PAPRD_AM2PM_MASK, am_mask);</a>
<a name="ln557">        }</a>
<a name="ln558"> </a>
<a name="ln559">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_HT40, AR_PHY_PAPRD_HT40_MASK,</a>
<a name="ln560">            AR_PHY_PAPRD_HT40_MASK);</a>
<a name="ln561">        /* chain0 */</a>
<a name="ln562">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN0_MASK) {</a>
<a name="ln563">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln564">                AR_PHY_PAPRD_CTRL0_B0_USE_SINGLE_TABLE_MASK, 1);</a>
<a name="ln565">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln566">                AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2PM_ENABLE_0, 1);</a>
<a name="ln567">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln568">                AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2AM_ENABLE_0, 1);</a>
<a name="ln569">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln570">                AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln571">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln572">                AR_PHY_PAPRD_CTRL1_B0_PA_GAIN_SCALE_FACT_0_MASK, 181);</a>
<a name="ln573">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln574">                AR_PHY_PAPRD_CTRL1_B0_PAPRD_MAG_SCALE_FACT_0, 361);</a>
<a name="ln575">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln576">                AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln577">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln578">                AR_PHY_PAPRD_CTRL0_B0_PAPRD_MAG_THRSH_0, 3);</a>
<a name="ln579">        }</a>
<a name="ln580">        /* chain1 */</a>
<a name="ln581">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN1_MASK) {</a>
<a name="ln582">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln583">                AR_PHY_PAPRD_CTRL0_B1_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_1, 1);</a>
<a name="ln584">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln585">                AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2PM_ENABLE_1, 1);</a>
<a name="ln586">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln587">                AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2AM_ENABLE_1, 1);</a>
<a name="ln588">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln589">                AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln590">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln591">                AR_PHY_PAPRD_CTRL1_B1_PA_GAIN_SCALE_FACT_1_MASK, 181);</a>
<a name="ln592">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln593">                AR_PHY_PAPRD_CTRL1_B1_PAPRD_MAG_SCALE_FACT_1, 361);</a>
<a name="ln594">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln595">                AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln596">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln597">                AR_PHY_PAPRD_CTRL0_B1_PAPRD_MAG_THRSH_1, 3);</a>
<a name="ln598">        }</a>
<a name="ln599">        /* chain2 */</a>
<a name="ln600">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN2_MASK) {</a>
<a name="ln601">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln602">                AR_PHY_PAPRD_CTRL0_B2_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_2, 1);</a>
<a name="ln603">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln604">                AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2PM_ENABLE_2, 1);</a>
<a name="ln605">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln606">                AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2AM_ENABLE_2, 1);</a>
<a name="ln607">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln608">                AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln609">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln610">                AR_PHY_PAPRD_CTRL1_B2_PA_GAIN_SCALE_FACT_2_MASK, 181);</a>
<a name="ln611">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln612">                AR_PHY_PAPRD_CTRL1_B2_PAPRD_MAG_SCALE_FACT_2, 361);</a>
<a name="ln613">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln614">                AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA, 0);</a>
<a name="ln615">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln616">                AR_PHY_PAPRD_CTRL0_B2_PAPRD_MAG_THRSH_2, 3);</a>
<a name="ln617">        }</a>
<a name="ln618">        </a>
<a name="ln619">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN0_MASK) {</a>
<a name="ln620">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln621">                AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0, 1);</a>
<a name="ln622">        }</a>
<a name="ln623">        </a>
<a name="ln624">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN1_MASK) {</a>
<a name="ln625">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln626">                AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1, 1);</a>
<a name="ln627">        }</a>
<a name="ln628"> </a>
<a name="ln629">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN2_MASK) {</a>
<a name="ln630">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln631">                AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2, 1);</a>
<a name="ln632">        }</a>
<a name="ln633">        </a>
<a name="ln634">    } else {</a>
<a name="ln635">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN0_MASK) {</a>
<a name="ln636">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln637">                AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0, 0);</a>
<a name="ln638">        }</a>
<a name="ln639">        </a>
<a name="ln640">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN1_MASK) {</a>
<a name="ln641">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln642">                AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1, 0);</a>
<a name="ln643">        }</a>
<a name="ln644">        </a>
<a name="ln645">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN2_MASK) {</a>
<a name="ln646">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln647">                AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2, 0);</a>
<a name="ln648">        }</a>
<a name="ln649">    }</a>
<a name="ln650">}</a>
<a name="ln651"> </a>
<a name="ln652">static void ar9300_gain_table_entries(struct ath_hal *ah)</a>
<a name="ln653">{</a>
<a name="ln654">    int i;</a>
<a name="ln655">    u_int32_t reg;</a>
<a name="ln656">    u_int32_t *gain_table_entries = AH9300(ah)-&gt;paprd_gain_table_entries;</a>
<a name="ln657">    u_int32_t *gain_vs_table_index = AH9300(ah)-&gt;paprd_gain_table_index;</a>
<a name="ln658"> </a>
<a name="ln659">    reg = AR_PHY_TXGAIN_TAB(1);</a>
<a name="ln660"> </a>
<a name="ln661">    for (i = 0; i &lt; 32; i++) {</a>
<a name="ln662">        gain_table_entries[i] = OS_REG_READ(ah, reg);</a>
<a name="ln663">        gain_vs_table_index[i] = (gain_table_entries[i] &gt;&gt; 24) &amp; 0xff;</a>
<a name="ln664">        /*</a>
<a name="ln665">         * ath_hal_printf(</a>
<a name="ln666">         *     ah, &quot;+++reg 0x%08x gain_table_entries[%d] = 0x%08x \n&quot;, </a>
<a name="ln667">         *     reg, i, gain_table_entries[i]);</a>
<a name="ln668">         */</a>
<a name="ln669">        reg = reg + 4;</a>
<a name="ln670">    }</a>
<a name="ln671">}</a>
<a name="ln672"> </a>
<a name="ln673">/* Get gain index for Target power */</a>
<a name="ln674">static unsigned int ar9300_get_desired_gain_for_chain(struct ath_hal *ah,</a>
<a name="ln675">    int chain_num, int target_power)</a>
<a name="ln676">{</a>
<a name="ln677">    int olpc_gain_delta = 0;</a>
<a name="ln678">    int alpha_therm = 0, alpha_volt = 0;</a>
<a name="ln679">    int therm_cal_value = 0, volt_cal_value = 0;</a>
<a name="ln680">    int latest_therm_value = 0, latest_volt_value = 0, olpc_gain_delta_tmp = 0;</a>
<a name="ln681">    int thermal_gain_corr = 0, voltage_gain_corr = 0, desired_scale = 0;</a>
<a name="ln682">    int desired_gain = 0;</a>
<a name="ln683">    int cl_gain_mod = 0;</a>
<a name="ln684"> </a>
<a name="ln685">    /* Clear the training done bit */</a>
<a name="ln686">    if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln687">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln688">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE, 0);</a>
<a name="ln689">    } else {</a>
<a name="ln690">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln691">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE, 0);</a>
<a name="ln692">    }</a>
<a name="ln693">    /*field_read(&quot;BB_tpc_12.desired_scale_ht40_5&quot;, &amp;desired_scale);*/</a>
<a name="ln694">    desired_scale =</a>
<a name="ln695">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_12,</a>
<a name="ln696">        AR_PHY_TPC_12_DESIRED_SCALE_HT40_5);</a>
<a name="ln697">    /*field_read(&quot;BB_tpc_19.alpha_therm&quot;, &amp;alpha_therm);*/</a>
<a name="ln698">    alpha_therm =</a>
<a name="ln699">        OS_REG_READ_FIELD(ah, AR_PHY_TPC_19, AR_PHY_TPC_19_ALPHA_THERM);</a>
<a name="ln700">    /*field_read(&quot;BB_tpc_19.alpha_volt&quot;, &amp;alpha_volt);*/</a>
<a name="ln701">    alpha_volt =</a>
<a name="ln702">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_19, AR_PHY_TPC_19_ALT_ALPHA_VOLT);</a>
<a name="ln703"> </a>
<a name="ln704">    /*field_read(&quot;BB_tpc_18.therm_cal_value&quot;, &amp;therm_cal_value);*/</a>
<a name="ln705">    therm_cal_value =</a>
<a name="ln706">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_18,</a>
<a name="ln707">        AR_PHY_TPC_18_ALT_THERM_CAL_VALUE);</a>
<a name="ln708">    /*field_read(&quot;BB_tpc_18.volt_cal_value&quot;, &amp;volt_cal_value);*/</a>
<a name="ln709">    volt_cal_value =</a>
<a name="ln710">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_18,</a>
<a name="ln711">        AR_PHY_TPC_18_ALT_VOLT_CAL_VALUE);</a>
<a name="ln712"> </a>
<a name="ln713">    /*field_read(&quot;BB_therm_adc_4.latest_therm_value&quot;, &amp;latest_therm_value);*/</a>
<a name="ln714">    latest_therm_value =</a>
<a name="ln715">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_THERM_ADC_4,</a>
<a name="ln716">        AR_PHY_THERM_ADC_4_LATEST_THERM_VALUE);</a>
<a name="ln717">    /*field_read(&quot;BB_therm_adc_4.latest_volt_value&quot;, &amp;latest_volt_value);*/</a>
<a name="ln718">    latest_volt_value =</a>
<a name="ln719">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_THERM_ADC_4,</a>
<a name="ln720">        AR_PHY_THERM_ADC_4_LATEST_VOLT_VALUE);</a>
<a name="ln721"> </a>
<a name="ln722">    /*</a>
<a name="ln723">     * sprintf(</a>
<a name="ln724">     *     field_name, &quot;%s%d%s%d\0&quot;, &quot;BB_tpc_11_b&quot;, </a>
<a name="ln725">     *     chain_num, &quot;.olpc_gain_delta_&quot;, chain_num);</a>
<a name="ln726">     */</a>
<a name="ln727">    /*field_read(field_name, &amp;olpc_gain_delta_tmp);*/</a>
<a name="ln728"> </a>
<a name="ln729"> </a>
<a name="ln730">    if (chain_num == 0) {</a>
<a name="ln731">        olpc_gain_delta_tmp =</a>
<a name="ln732">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_11_B0,</a>
<a name="ln733">            AR_PHY_TPC_11_B0_OLPC_GAIN_DELTA_0);</a>
<a name="ln734">        cl_gain_mod = OS_REG_READ_FIELD_ALT(ah, AR_PHY_CL_TAB_0, </a>
<a name="ln735">            AR_PHY_CL_TAB_0_CL_GAIN_MOD);</a>
<a name="ln736">    } else if (chain_num == 1) {</a>
<a name="ln737">        if (!AR_SREV_POSEIDON(ah)) {</a>
<a name="ln738">            olpc_gain_delta_tmp =</a>
<a name="ln739">                OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_11_B1,</a>
<a name="ln740">                AR_PHY_TPC_11_B1_OLPC_GAIN_DELTA_1);</a>
<a name="ln741">            cl_gain_mod = OS_REG_READ_FIELD_ALT(ah, AR_PHY_CL_TAB_1, </a>
<a name="ln742">                AR_PHY_CL_TAB_1_CL_GAIN_MOD);</a>
<a name="ln743">        }</a>
<a name="ln744">    } else if (chain_num == 2) {</a>
<a name="ln745">        if (!AR_SREV_POSEIDON(ah)) {</a>
<a name="ln746">            olpc_gain_delta_tmp =</a>
<a name="ln747">                OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_11_B2,</a>
<a name="ln748">                AR_PHY_TPC_11_B2_OLPC_GAIN_DELTA_2);</a>
<a name="ln749">            cl_gain_mod = OS_REG_READ_FIELD_ALT(ah, AR_PHY_CL_TAB_2, </a>
<a name="ln750">                AR_PHY_CL_TAB_2_CL_GAIN_MOD);</a>
<a name="ln751">        }</a>
<a name="ln752">    } else {</a>
<a name="ln753">        /* invalid chain_num */</a>
<a name="ln754">    }</a>
<a name="ln755"> </a>
<a name="ln756">    if (olpc_gain_delta_tmp &lt; 128) {</a>
<a name="ln757">        olpc_gain_delta = olpc_gain_delta_tmp;</a>
<a name="ln758">    } else {</a>
<a name="ln759">        olpc_gain_delta = olpc_gain_delta_tmp - 256;</a>
<a name="ln760">    }</a>
<a name="ln761"> </a>
<a name="ln762">    thermal_gain_corr =</a>
<a name="ln763">        (int) (alpha_therm * (latest_therm_value - therm_cal_value) +</a>
<a name="ln764">        128) &gt;&gt; 8;</a>
<a name="ln765">    voltage_gain_corr =</a>
<a name="ln766">        (int) (alpha_volt * (latest_volt_value - volt_cal_value) + 64) &gt;&gt; 7;</a>
<a name="ln767">    desired_gain =</a>
<a name="ln768">        target_power - olpc_gain_delta - thermal_gain_corr -</a>
<a name="ln769">        voltage_gain_corr + desired_scale + cl_gain_mod;</a>
<a name="ln770">    /*</a>
<a name="ln771">     * printf(</a>
<a name="ln772">     *     &quot;olpc_gain_delta %d, desired_gain %d\n&quot;, </a>
<a name="ln773">     *     olpc_gain_delta, desired_gain);</a>
<a name="ln774">     */</a>
<a name="ln775">#if 0</a>
<a name="ln776">    ath_hal_printf(ah,</a>
<a name="ln777">        &quot;+++ target_power %d olpc_gain_delta %d, cl_gain_mod %d,&quot;</a>
<a name="ln778">        &quot;thermal_gain_corr %d  voltage_gain_corr %d desired_scale %d&quot;</a>
<a name="ln779">        &quot;desired_gain %d\n&quot;,</a>
<a name="ln780">        target_power, olpc_gain_delta, cl_gain_mod, thermal_gain_corr,</a>
<a name="ln781">        voltage_gain_corr,</a>
<a name="ln782">        desired_scale, desired_gain);</a>
<a name="ln783">#endif</a>
<a name="ln784">    return (unsigned int) desired_gain;</a>
<a name="ln785">}</a>
<a name="ln786"> </a>
<a name="ln787">static void ar9300_tx_force_gain(struct ath_hal *ah, unsigned int gain_index)</a>
<a name="ln788">{</a>
<a name="ln789">    int selected_gain_entry, txbb1dbgain, txbb6dbgain, txmxrgain;</a>
<a name="ln790">    int padrvgn_a, padrvgn_b, padrvgn_c, padrvgn_d;</a>
<a name="ln791">    u_int32_t *gain_table_entries = AH9300(ah)-&gt;paprd_gain_table_entries;</a>
<a name="ln792"> </a>
<a name="ln793">    /*u_int32_t *gain_vs_table_index = ah-&gt;paprd_gain_table_index;*/</a>
<a name="ln794">    selected_gain_entry = gain_table_entries[gain_index];</a>
<a name="ln795">    txbb1dbgain = selected_gain_entry &amp; 0x7;</a>
<a name="ln796">    txbb6dbgain = (selected_gain_entry &gt;&gt; 3) &amp; 0x3;</a>
<a name="ln797">    txmxrgain = (selected_gain_entry &gt;&gt; 5) &amp; 0xf;</a>
<a name="ln798">    padrvgn_a = (selected_gain_entry &gt;&gt; 9) &amp; 0xf;</a>
<a name="ln799">    padrvgn_b = (selected_gain_entry &gt;&gt; 13) &amp; 0xf;</a>
<a name="ln800">    padrvgn_c = (selected_gain_entry &gt;&gt; 17) &amp; 0xf;</a>
<a name="ln801">    padrvgn_d = (selected_gain_entry &gt;&gt; 21) &amp; 0x3;</a>
<a name="ln802"> </a>
<a name="ln803">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln804">        AR_PHY_TX_FORCED_GAIN_FORCED_TXBB1DBGAIN, txbb1dbgain);</a>
<a name="ln805">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln806">        AR_PHY_TX_FORCED_GAIN_FORCED_TXBB6DBGAIN, txbb6dbgain);</a>
<a name="ln807">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln808">        AR_PHY_TX_FORCED_GAIN_FORCED_TXMXRGAIN, txmxrgain);</a>
<a name="ln809">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln810">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNA, padrvgn_a);</a>
<a name="ln811">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln812">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNB, padrvgn_b);</a>
<a name="ln813">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln814">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNC, padrvgn_c);</a>
<a name="ln815">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln816">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGND, padrvgn_d);</a>
<a name="ln817">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln818">        AR_PHY_TX_FORCED_GAIN_FORCED_ENABLE_PAL, 0);</a>
<a name="ln819">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln820">        AR_PHY_TX_FORCED_GAIN_FORCE_TX_GAIN, 0);</a>
<a name="ln821"> </a>
<a name="ln822">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCED_DAC_GAIN, 0);</a>
<a name="ln823">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCE_DAC_GAIN, 0);</a>
<a name="ln824">}</a>
<a name="ln825"> </a>
<a name="ln826">#define HAL_DEBUG_PAPRD HAL_DEBUG_CALIBRATE  /* driver: conditionally print */</a>
<a name="ln827"> </a>
<a name="ln828">#if defined(ART_PAPRD_DEBUG) || defined(AH_DEBUG)</a>
<a name="ln829">static void ar9300_paprd_debug_print(struct ath_hal *ah)</a>
<a name="ln830">{</a>
<a name="ln831">    int temp;</a>
<a name="ln832">    int txbb1dbgain, txbb6dbgain, txmxrgain;</a>
<a name="ln833">    int padrvgn_a, padrvgn_b, padrvgn_c, padrvgn_d;</a>
<a name="ln834"> </a>
<a name="ln835">    if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln836">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_lb_skip&quot;, &amp;temp);*/</a>
<a name="ln837">        temp =</a>
<a name="ln838">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln839">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP);</a>
<a name="ln840">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln841">            &quot;BB_paprd_trainer_cntl1.cf_paprd_lb_skip=0x%x\n&quot;, temp);</a>
<a name="ln842">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_lb_enable&quot;, &amp;temp);*/</a>
<a name="ln843">        temp =</a>
<a name="ln844">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln845">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE);</a>
<a name="ln846">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln847">            &quot;BB_paprd_trainer_cntl1.cf_paprd_lb_enable=0x%x\n&quot;, temp);</a>
<a name="ln848">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force&quot;, &amp;temp);*/</a>
<a name="ln849">        temp =</a>
<a name="ln850">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln851">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE);</a>
<a name="ln852">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln853">            &quot;BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force=0x%x\n&quot;, temp);</a>
<a name="ln854">        /*</a>
<a name="ln855">         * field_read(</a>
<a name="ln856">         *     &quot;BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force&quot;, &amp;temp);</a>
<a name="ln857">         */</a>
<a name="ln858">        temp =</a>
<a name="ln859">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln860">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE);</a>
<a name="ln861">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln862">            &quot;BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force=0x%x\n&quot;, temp);</a>
<a name="ln863">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable&quot;, &amp;temp);*/</a>
<a name="ln864">        temp =</a>
<a name="ln865">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln866">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE);</a>
<a name="ln867">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln868">            &quot;BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable=0x%x\n&quot;, temp);</a>
<a name="ln869">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_agc2_settling&quot;, &amp;temp);*/</a>
<a name="ln870">        temp =</a>
<a name="ln871">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln872">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING);</a>
<a name="ln873">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln874">            &quot;BB_paprd_trainer_cntl1.cf_paprd_agc2_settling=0x%x\n&quot;, temp);</a>
<a name="ln875">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_train_enable&quot;, &amp;temp);*/</a>
<a name="ln876">        temp =</a>
<a name="ln877">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON,</a>
<a name="ln878">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE);</a>
<a name="ln879">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln880">            &quot;BB_paprd_trainer_cntl1.cf_paprd_train_enable=0x%x\n&quot;, temp);</a>
<a name="ln881">        /*</a>
<a name="ln882">         * field_read(&quot;BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain&quot;, &amp;temp);</a>
<a name="ln883">         */</a>
<a name="ln884">        temp =</a>
<a name="ln885">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL2_POSEIDON,</a>
<a name="ln886">            AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN);</a>
<a name="ln887">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln888">            &quot;BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain=0x%x\n&quot;, temp);</a>
<a name="ln889">        /*field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len&quot;, &amp;temp);*/</a>
<a name="ln890">        temp =</a>
<a name="ln891">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln892">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN);</a>
<a name="ln893">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln894">            &quot;BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len=0x%x\n&quot;, temp);</a>
<a name="ln895">        /*</a>
<a name="ln896">         * field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len&quot;, &amp;temp);</a>
<a name="ln897">         */</a>
<a name="ln898">        temp =</a>
<a name="ln899">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln900">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN);</a>
<a name="ln901">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln902">            &quot;BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len=0x%x\n&quot;, temp);</a>
<a name="ln903">        /*</a>
<a name="ln904">         * field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages&quot;, &amp;temp);</a>
<a name="ln905">         */</a>
<a name="ln906">        temp =</a>
<a name="ln907">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln908">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES);</a>
<a name="ln909">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln910">            &quot;BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages=0x%x\n&quot;, temp);</a>
<a name="ln911">        /*</a>
<a name="ln912">         * field_read(</a>
<a name="ln913">         *     &quot;BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del&quot;, &amp;temp);</a>
<a name="ln914">         */</a>
<a name="ln915">        temp =</a>
<a name="ln916">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln917">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL);</a>
<a name="ln918">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln919">            &quot;BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del=0x%x\n&quot;, temp);</a>
<a name="ln920">        /*field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_quick_drop&quot;, &amp;temp);*/</a>
<a name="ln921">        temp =</a>
<a name="ln922">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln923">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP);</a>
<a name="ln924">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln925">            &quot;BB_paprd_trainer_cntl3.cf_paprd_quick_drop=0x%x\n&quot;, temp);</a>
<a name="ln926">        /*</a>
<a name="ln927">         * field_read(</a>
<a name="ln928">         *     &quot;BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size&quot;, &amp;temp);</a>
<a name="ln929">         */</a>
<a name="ln930">        temp =</a>
<a name="ln931">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln932">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE);</a>
<a name="ln933">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln934">            &quot;BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size=0x%x\n&quot;, temp);</a>
<a name="ln935">        /*</a>
<a name="ln936">         * field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable&quot;, &amp;temp);</a>
<a name="ln937">         */</a>
<a name="ln938">        temp =</a>
<a name="ln939">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln940">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE);</a>
<a name="ln941">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln942">            &quot;BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable=0x%x\n&quot;, temp);</a>
<a name="ln943">        /*field_read(&quot;BB_paprd_trainer_cntl4.cf_paprd_safety_delta&quot;, &amp;temp);*/</a>
<a name="ln944">        temp =</a>
<a name="ln945">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON,</a>
<a name="ln946">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA);</a>
<a name="ln947">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln948">            &quot;BB_paprd_trainer_cntl4.cf_paprd_safety_delta=0x%x\n&quot;, temp);</a>
<a name="ln949">        /*field_read(&quot;BB_paprd_trainer_cntl4.cf_paprd_min_corr&quot;, &amp;temp);*/</a>
<a name="ln950">        temp =</a>
<a name="ln951">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON,</a>
<a name="ln952">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR);</a>
<a name="ln953">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln954">            &quot;BB_paprd_trainer_cntl4.cf_paprd_min_corr=0x%x\n&quot;, temp);</a>
<a name="ln955">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_agc2_pwr&quot;, &amp;temp);*/</a>
<a name="ln956">        temp =</a>
<a name="ln957">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln958">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR);</a>
<a name="ln959">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln960">            &quot;    paprd_agc2_pwr              = 0x%02x\n&quot;, temp);</a>
<a name="ln961">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_rx_gain_idx&quot;, &amp;temp);*/</a>
<a name="ln962">        temp =</a>
<a name="ln963">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln964">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_RX_GAIN_IDX);</a>
<a name="ln965">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln966">            &quot;    paprd_rx_gain_idx           = 0x%02x\n&quot;, temp);</a>
<a name="ln967">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_train_active&quot;, &amp;temp);*/</a>
<a name="ln968">        temp =</a>
<a name="ln969">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln970">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_ACTIVE);</a>
<a name="ln971">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln972">            &quot;    paprd_train_active          = 0x%08x\n&quot;, temp);</a>
<a name="ln973">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_corr_err&quot;, &amp;temp);*/</a>
<a name="ln974">        temp =</a>
<a name="ln975">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln976">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_CORR_ERR);</a>
<a name="ln977">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln978">            &quot;    paprd_corr_err              = 0x%08x\n&quot;, temp);</a>
<a name="ln979">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_train_incomplete&quot;, &amp;temp);*/</a>
<a name="ln980">        temp =</a>
<a name="ln981">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln982">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_INCOMPLETE);</a>
<a name="ln983">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln984">            &quot;    paprd_train_incomplete      = 0x%08x\n&quot;, temp);</a>
<a name="ln985">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_train_done&quot;, &amp;temp);*/</a>
<a name="ln986">        temp =</a>
<a name="ln987">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln988">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);</a>
<a name="ln989">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln990">            &quot;    paprd_train_done            = 0x%08x\n&quot;, temp);</a>
<a name="ln991">        /*field_read(&quot;BB_paprd_trainer_stat2.paprd_fine_idx&quot;, &amp;temp);*/</a>
<a name="ln992">        temp =</a>
<a name="ln993">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT2_POSEIDON,</a>
<a name="ln994">            AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_IDX);</a>
<a name="ln995">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln996">            &quot;    paprd_fine_idx              = 0x%08x\n&quot;, temp);</a>
<a name="ln997">        /*field_read(&quot;BB_paprd_trainer_stat2.paprd_coarse_idx&quot;, &amp;temp);*/</a>
<a name="ln998">        temp =</a>
<a name="ln999">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT2_POSEIDON,</a>
<a name="ln1000">            AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_COARSE_IDX);</a>
<a name="ln1001">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1002">            &quot;    paprd_coarse_idx            = 0x%08x\n&quot;, temp);</a>
<a name="ln1003">        /*field_read(&quot;BB_paprd_trainer_stat2.paprd_fine_val&quot;, &amp;temp);*/</a>
<a name="ln1004">        temp =</a>
<a name="ln1005">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT2_POSEIDON,</a>
<a name="ln1006">            AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_VAL);</a>
<a name="ln1007">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1008">            &quot;    paprd_fine_val              = 0x%08x\n&quot;, temp);</a>
<a name="ln1009">        /*field_read(&quot;BB_paprd_trainer_stat3.paprd_train_samples_cnt&quot;, &amp;temp);*/</a>
<a name="ln1010">        temp =</a>
<a name="ln1011">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT3_POSEIDON,</a>
<a name="ln1012">            AR_PHY_PAPRD_TRAINER_STAT3_PAPRD_TRAIN_SAMPLES_CNT);</a>
<a name="ln1013">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1014">            &quot;    paprd_train_samples_cnt     = 0x%08x\n&quot;, temp);</a>
<a name="ln1015">    } else {</a>
<a name="ln1016">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_lb_skip&quot;, &amp;temp);*/</a>
<a name="ln1017">        temp =</a>
<a name="ln1018">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln1019">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP);</a>
<a name="ln1020">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1021">            &quot;BB_paprd_trainer_cntl1.cf_paprd_lb_skip=0x%x\n&quot;, temp);</a>
<a name="ln1022">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_lb_enable&quot;, &amp;temp);*/</a>
<a name="ln1023">        temp =</a>
<a name="ln1024">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln1025">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE);</a>
<a name="ln1026">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1027">            &quot;BB_paprd_trainer_cntl1.cf_paprd_lb_enable=0x%x\n&quot;, temp);</a>
<a name="ln1028">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force&quot;, &amp;temp);*/</a>
<a name="ln1029">        temp =</a>
<a name="ln1030">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln1031">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE);</a>
<a name="ln1032">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1033">            &quot;BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force=0x%x\n&quot;, temp);</a>
<a name="ln1034">        /*</a>
<a name="ln1035">         * field_read(</a>
<a name="ln1036">         *     &quot;BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force&quot;, &amp;temp);</a>
<a name="ln1037">         */</a>
<a name="ln1038">        temp =</a>
<a name="ln1039">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln1040">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE);</a>
<a name="ln1041">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1042">            &quot;BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force=0x%x\n&quot;, temp);</a>
<a name="ln1043">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable&quot;, &amp;temp);*/</a>
<a name="ln1044">        temp =</a>
<a name="ln1045">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln1046">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE);</a>
<a name="ln1047">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1048">            &quot;BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable=0x%x\n&quot;, temp);</a>
<a name="ln1049">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_agc2_settling&quot;, &amp;temp);*/</a>
<a name="ln1050">        temp =</a>
<a name="ln1051">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln1052">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING);</a>
<a name="ln1053">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1054">            &quot;BB_paprd_trainer_cntl1.cf_paprd_agc2_settling=0x%x\n&quot;, temp);</a>
<a name="ln1055">        /*field_read(&quot;BB_paprd_trainer_cntl1.cf_paprd_train_enable&quot;, &amp;temp);*/</a>
<a name="ln1056">        temp =</a>
<a name="ln1057">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL1,</a>
<a name="ln1058">            AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE);</a>
<a name="ln1059">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1060">            &quot;BB_paprd_trainer_cntl1.cf_paprd_train_enable=0x%x\n&quot;, temp);</a>
<a name="ln1061">        /*</a>
<a name="ln1062">         * field_read(&quot;BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain&quot;, &amp;temp);</a>
<a name="ln1063">         */</a>
<a name="ln1064">        temp =</a>
<a name="ln1065">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL2,</a>
<a name="ln1066">            AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN);</a>
<a name="ln1067">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1068">            &quot;BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain=0x%x\n&quot;, temp);</a>
<a name="ln1069">        /*field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len&quot;, &amp;temp);*/</a>
<a name="ln1070">        temp =</a>
<a name="ln1071">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln1072">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN);</a>
<a name="ln1073">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1074">            &quot;BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len=0x%x\n&quot;, temp);</a>
<a name="ln1075">        /*</a>
<a name="ln1076">         * field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len&quot;, &amp;temp);</a>
<a name="ln1077">         */</a>
<a name="ln1078">        temp =</a>
<a name="ln1079">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln1080">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN);</a>
<a name="ln1081">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1082">            &quot;BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len=0x%x\n&quot;, temp);</a>
<a name="ln1083">        /*</a>
<a name="ln1084">         * field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages&quot;, &amp;temp);</a>
<a name="ln1085">         */</a>
<a name="ln1086">        temp =</a>
<a name="ln1087">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln1088">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES);</a>
<a name="ln1089">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1090">            &quot;BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages=0x%x\n&quot;, temp);</a>
<a name="ln1091">        /*</a>
<a name="ln1092">         * field_read(</a>
<a name="ln1093">         *     &quot;BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del&quot;, &amp;temp);</a>
<a name="ln1094">         */</a>
<a name="ln1095">        temp =</a>
<a name="ln1096">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln1097">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL);</a>
<a name="ln1098">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1099">            &quot;BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del=0x%x\n&quot;, temp);</a>
<a name="ln1100">        /*field_read(&quot;BB_paprd_trainer_cntl3.cf_paprd_quick_drop&quot;, &amp;temp);*/</a>
<a name="ln1101">        temp =</a>
<a name="ln1102">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln1103">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP);</a>
<a name="ln1104">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1105">            &quot;BB_paprd_trainer_cntl3.cf_paprd_quick_drop=0x%x\n&quot;, temp);</a>
<a name="ln1106">        /*</a>
<a name="ln1107">         * field_read(</a>
<a name="ln1108">         *     &quot;BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size&quot;, &amp;temp);</a>
<a name="ln1109">         */</a>
<a name="ln1110">        temp =</a>
<a name="ln1111">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln1112">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE);</a>
<a name="ln1113">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1114">            &quot;BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size=0x%x\n&quot;, temp);</a>
<a name="ln1115">        /*</a>
<a name="ln1116">         * field_read(</a>
<a name="ln1117">         *     &quot;BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable&quot;, &amp;temp);</a>
<a name="ln1118">         */</a>
<a name="ln1119">        temp =</a>
<a name="ln1120">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln1121">            AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE);</a>
<a name="ln1122">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1123">            &quot;BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable=0x%x\n&quot;, temp);</a>
<a name="ln1124">        /*field_read(&quot;BB_paprd_trainer_cntl4.cf_paprd_safety_delta&quot;, &amp;temp);*/</a>
<a name="ln1125">        temp =</a>
<a name="ln1126">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4,</a>
<a name="ln1127">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA);</a>
<a name="ln1128">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1129">            &quot;BB_paprd_trainer_cntl4.cf_paprd_safety_delta=0x%x\n&quot;, temp);</a>
<a name="ln1130">        /*field_read(&quot;BB_paprd_trainer_cntl4.cf_paprd_min_corr&quot;, &amp;temp);*/</a>
<a name="ln1131">        temp =</a>
<a name="ln1132">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL4,</a>
<a name="ln1133">            AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR);</a>
<a name="ln1134">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1135">            &quot;BB_paprd_trainer_cntl4.cf_paprd_min_corr=0x%x\n&quot;, temp);</a>
<a name="ln1136">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_agc2_pwr&quot;, &amp;temp);*/</a>
<a name="ln1137">        temp =</a>
<a name="ln1138">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln1139">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR);</a>
<a name="ln1140">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1141">            &quot;    paprd_agc2_pwr              = 0x%02x\n&quot;, temp);</a>
<a name="ln1142">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_rx_gain_idx&quot;, &amp;temp);*/</a>
<a name="ln1143">        temp =</a>
<a name="ln1144">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln1145">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_RX_GAIN_IDX);</a>
<a name="ln1146">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1147">            &quot;    paprd_rx_gain_idx           = 0x%02x\n&quot;, temp);</a>
<a name="ln1148">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_train_active&quot;, &amp;temp);*/</a>
<a name="ln1149">        temp =</a>
<a name="ln1150">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln1151">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_ACTIVE);</a>
<a name="ln1152">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1153">            &quot;    paprd_train_active          = 0x%08x\n&quot;, temp);</a>
<a name="ln1154">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_corr_err&quot;, &amp;temp);*/</a>
<a name="ln1155">        temp =</a>
<a name="ln1156">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln1157">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_CORR_ERR);</a>
<a name="ln1158">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1159">            &quot;    paprd_corr_err              = 0x%08x\n&quot;, temp);</a>
<a name="ln1160">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_train_incomplete&quot;, &amp;temp);*/</a>
<a name="ln1161">        temp =</a>
<a name="ln1162">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln1163">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_INCOMPLETE);</a>
<a name="ln1164">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1165">            &quot;    paprd_train_incomplete      = 0x%08x\n&quot;, temp);</a>
<a name="ln1166">        /*field_read(&quot;BB_paprd_trainer_stat1.paprd_train_done&quot;, &amp;temp);*/</a>
<a name="ln1167">        temp =</a>
<a name="ln1168">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln1169">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);</a>
<a name="ln1170">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1171">            &quot;    paprd_train_done            = 0x%08x\n&quot;, temp);</a>
<a name="ln1172">        /*field_read(&quot;BB_paprd_trainer_stat2.paprd_fine_idx&quot;, &amp;temp);*/</a>
<a name="ln1173">        temp =</a>
<a name="ln1174">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT2,</a>
<a name="ln1175">            AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_IDX);</a>
<a name="ln1176">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1177">            &quot;    paprd_fine_idx              = 0x%08x\n&quot;, temp);</a>
<a name="ln1178">        /*field_read(&quot;BB_paprd_trainer_stat2.paprd_coarse_idx&quot;, &amp;temp);*/</a>
<a name="ln1179">        temp =</a>
<a name="ln1180">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT2,</a>
<a name="ln1181">            AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_COARSE_IDX);</a>
<a name="ln1182">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1183">            &quot;    paprd_coarse_idx            = 0x%08x\n&quot;, temp);</a>
<a name="ln1184">        /*field_read(&quot;BB_paprd_trainer_stat2.paprd_fine_val&quot;, &amp;temp);*/</a>
<a name="ln1185">        temp =</a>
<a name="ln1186">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT2,</a>
<a name="ln1187">            AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_VAL);</a>
<a name="ln1188">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1189">            &quot;    paprd_fine_val              = 0x%08x\n&quot;, temp);</a>
<a name="ln1190">        /*field_read(&quot;BB_paprd_trainer_stat3.paprd_train_samples_cnt&quot;, &amp;temp);*/</a>
<a name="ln1191">        temp =</a>
<a name="ln1192">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT3,</a>
<a name="ln1193">            AR_PHY_PAPRD_TRAINER_STAT3_PAPRD_TRAIN_SAMPLES_CNT);</a>
<a name="ln1194">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1195">            &quot;    paprd_train_samples_cnt     = 0x%08x\n&quot;, temp);</a>
<a name="ln1196">    }</a>
<a name="ln1197"> </a>
<a name="ln1198">    /*field_read(&quot;BB_tpc_1.force_dac_gain&quot;, &amp;temp);*/</a>
<a name="ln1199">    temp =</a>
<a name="ln1200">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCE_DAC_GAIN);</a>
<a name="ln1201">    HALDEBUG(ah, HAL_DEBUG_PAPRD, &quot;    dac_gain_forced     = 0x%08x\n&quot;,</a>
<a name="ln1202">        temp);</a>
<a name="ln1203">    /*field_read(&quot;BB_tpc_1.forced_dac_gain&quot;, &amp;temp);*/</a>
<a name="ln1204">    temp =</a>
<a name="ln1205">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCED_DAC_GAIN);</a>
<a name="ln1206">    HALDEBUG(ah, HAL_DEBUG_PAPRD, &quot;    forced_dac_gain     = 0x%08x\n&quot;,</a>
<a name="ln1207">        temp);</a>
<a name="ln1208"> </a>
<a name="ln1209">    /*field_read(&quot;BB_paprd_ctrl0_b0.paprd_enable_0&quot;, &amp;temp);*/</a>
<a name="ln1210">    temp =</a>
<a name="ln1211">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B0,</a>
<a name="ln1212">        AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0);</a>
<a name="ln1213">    HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1214">        &quot;    BB_paprd_ctrl0_b0.paprd_enable_0     = 0x%08x\n&quot;, temp);</a>
<a name="ln1215">    if (!AR_SREV_POSEIDON(ah)) {</a>
<a name="ln1216">        /*field_read(&quot;BB_paprd_ctrl0_b1.paprd_enable_1&quot;, &amp;temp);*/</a>
<a name="ln1217">        temp =</a>
<a name="ln1218">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B1,</a>
<a name="ln1219">            AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1);</a>
<a name="ln1220">        HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1221">            &quot;    BB_paprd_ctrl0_b1.paprd_enable_1     = 0x%08x\n&quot;, temp);</a>
<a name="ln1222">        if (AH9300(ah)-&gt;ah_tx_chainmask &amp; AR9300_CHAIN2_MASK) {</a>
<a name="ln1223">            /*field_read(&quot;BB_paprd_ctrl0_b2.paprd_enable_2&quot;, &amp;temp);*/</a>
<a name="ln1224">            temp =</a>
<a name="ln1225">                OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL0_B2,</a>
<a name="ln1226">                AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2);</a>
<a name="ln1227">            HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1228">                &quot;    BB_paprd_ctrl0_b2.paprd_enable_2     = 0x%08x\n&quot;, temp);</a>
<a name="ln1229">        }</a>
<a name="ln1230">    }</a>
<a name="ln1231"> </a>
<a name="ln1232">    /*field_read(&quot;BB_tx_forced_gain.forced_txbb1dbgain&quot;, &amp;txbb1dbgain);*/</a>
<a name="ln1233">    txbb1dbgain =</a>
<a name="ln1234">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln1235">        AR_PHY_TX_FORCED_GAIN_FORCED_TXBB1DBGAIN);</a>
<a name="ln1236">    /*field_read(&quot;BB_tx_forced_gain.forced_txbb6dbgain&quot;, &amp;txbb6dbgain);*/</a>
<a name="ln1237">    txbb6dbgain =</a>
<a name="ln1238">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln1239">        AR_PHY_TX_FORCED_GAIN_FORCED_TXBB6DBGAIN);</a>
<a name="ln1240">    /*field_read(&quot;BB_tx_forced_gain.forced_txmxrgain&quot;, &amp;txmxrgain);*/</a>
<a name="ln1241">    txmxrgain =</a>
<a name="ln1242">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln1243">        AR_PHY_TX_FORCED_GAIN_FORCED_TXMXRGAIN);</a>
<a name="ln1244">    /*field_read(&quot;BB_tx_forced_gain.forced_padrvgn_a&quot;, &amp;padrvgn_a);*/</a>
<a name="ln1245">    padrvgn_a =</a>
<a name="ln1246">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln1247">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNA);</a>
<a name="ln1248">    /*field_read(&quot;BB_tx_forced_gain.forced_padrvgn_b&quot;, &amp;padrvgn_b);*/</a>
<a name="ln1249">    padrvgn_b =</a>
<a name="ln1250">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln1251">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNB);</a>
<a name="ln1252">    /*field_read(&quot;BB_tx_forced_gain.forced_padrvgn_c&quot;, &amp;padrvgn_c);*/</a>
<a name="ln1253">    padrvgn_c =</a>
<a name="ln1254">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln1255">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNC);</a>
<a name="ln1256">    /*field_read(&quot;BB_tx_forced_gain.forced_padrvgn_d&quot;, &amp;padrvgn_d);*/</a>
<a name="ln1257">    padrvgn_d =</a>
<a name="ln1258">        OS_REG_READ_FIELD_ALT(ah, AR_PHY_TX_FORCED_GAIN,</a>
<a name="ln1259">        AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGND);</a>
<a name="ln1260"> </a>
<a name="ln1261">    HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1262">        &quot;txbb1dbgain=0x%x, txbb6dbgain=0x%x, txmxrgain=0x%x\n&quot;,</a>
<a name="ln1263">        txbb1dbgain, txbb6dbgain, txmxrgain);</a>
<a name="ln1264">    HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1265">        &quot;padrvgn_a=0x%x, padrvgn_b=0x%x\n&quot;, padrvgn_a, padrvgn_b);</a>
<a name="ln1266">    HALDEBUG(ah, HAL_DEBUG_PAPRD,</a>
<a name="ln1267">        &quot;padrvgn_c=0x%x, padrvgn_d=0x%x\n&quot;, padrvgn_c, padrvgn_d);</a>
<a name="ln1268">}</a>
<a name="ln1269">#else</a>
<a name="ln1270">#define ar9300_paprd_debug_print(ah) /* dummy macro */</a>
<a name="ln1271">#endif /* defined(ART_PAPRD_DEBUG) || defined(AH_DEBUG) */</a>
<a name="ln1272"> </a>
<a name="ln1273">static int ar9300_create_pa_curve(struct ath_hal *ah, u_int32_t * pa_table,</a>
<a name="ln1274">    u_int32_t * small_signal_gain, int * pa_in)</a>
<a name="ln1275">{</a>
<a name="ln1276">    int i;</a>
<a name="ln1277">    int status;</a>
<a name="ln1278">    /*char field_name[100];*/</a>
<a name="ln1279">    u_int32_t paprd_train_data_l[48], paprd_train_data_u[48];</a>
<a name="ln1280">    u_int32_t reg;</a>
<a name="ln1281"> </a>
<a name="ln1282">    ar9300_paprd_debug_print(ah);</a>
<a name="ln1283">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_CHAN_INFO_MEMORY,</a>
<a name="ln1284">        AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ, 0);</a>
<a name="ln1285">    reg = AR_PHY_CHAN_INFO_TAB_0;</a>
<a name="ln1286"> </a>
<a name="ln1287">    for (i = 0; i &lt; 48; i++) {</a>
<a name="ln1288">        /*</a>
<a name="ln1289">         * sprintf(</a>
<a name="ln1290">         *     field_name, &quot;%s%d%s\0&quot;, &quot;BB_chan_info_chan_tab_b0[&quot;, </a>
<a name="ln1291">         *     i, &quot;].chaninfo_word&quot;);</a>
<a name="ln1292">         */</a>
<a name="ln1293">        /*field_read(field_name, &amp;paprd_train_data_l[i]);*/</a>
<a name="ln1294">        paprd_train_data_l[i] = OS_REG_READ(ah, reg);</a>
<a name="ln1295">        reg = reg + 4;</a>
<a name="ln1296">    }</a>
<a name="ln1297"> </a>
<a name="ln1298">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_CHAN_INFO_MEMORY,</a>
<a name="ln1299">        AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ, 1);</a>
<a name="ln1300">    reg = AR_PHY_CHAN_INFO_TAB_0;</a>
<a name="ln1301"> </a>
<a name="ln1302">    for (i = 0; i &lt; 48; i++) {</a>
<a name="ln1303">        /*</a>
<a name="ln1304">         * sprintf(</a>
<a name="ln1305">         *     field_name, &quot;%s%d%s\0&quot;, &quot;BB_chan_info_chan_tab_b0[&quot;, </a>
<a name="ln1306">         *     i, &quot;].chaninfo_word&quot;);</a>
<a name="ln1307">         */</a>
<a name="ln1308">        /*field_read(field_name, &amp;paprd_train_data_u[i]);*/</a>
<a name="ln1309">        paprd_train_data_u[i] = OS_REG_READ(ah, reg);</a>
<a name="ln1310">        reg = reg + 4;</a>
<a name="ln1311">    }</a>
<a name="ln1312"> </a>
<a name="ln1313">    /*</a>
<a name="ln1314">     * for(i=0; i&lt;48; i++)</a>
<a name="ln1315">     *     ath_hal_printf(</a>
<a name="ln1316">     *         ah, &quot;%08x%08x\n&quot;, paprd_train_data_u[i], paprd_train_data_l[i]);</a>
<a name="ln1317">     */</a>
<a name="ln1318">    status = 0;</a>
<a name="ln1319">    if (create_pa_curve(</a>
<a name="ln1320">            paprd_train_data_l, paprd_train_data_u, </a>
<a name="ln1321">            pa_table, small_signal_gain, pa_in) ==</a>
<a name="ln1322">            AH_FALSE)</a>
<a name="ln1323">    {</a>
<a name="ln1324">        status = -2;</a>
<a name="ln1325">    }</a>
<a name="ln1326">    /* Clear the training done bit */</a>
<a name="ln1327">    if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln1328">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln1329">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE, 0);</a>
<a name="ln1330">    } else {</a>
<a name="ln1331">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln1332">            AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE, 0);</a>
<a name="ln1333">    }</a>
<a name="ln1334">    return status;</a>
<a name="ln1335">}</a>
<a name="ln1336"> </a>
<a name="ln1337">static int find_expn(int num)</a>
<a name="ln1338">{</a>
<a name="ln1339">    int tmp, exp;</a>
<a name="ln1340"> </a>
<a name="ln1341">    exp = 0;</a>
<a name="ln1342">    tmp = num &gt;&gt; 1;</a>
<a name="ln1343"> </a>
<a name="ln1344">    while (tmp != 0) {</a>
<a name="ln1345">        tmp = tmp &gt;&gt; 1;</a>
<a name="ln1346">        exp++;</a>
<a name="ln1347">    }</a>
<a name="ln1348"> </a>
<a name="ln1349">    return exp;</a>
<a name="ln1350">}</a>
<a name="ln1351"> </a>
<a name="ln1352">static int find_proper_scale(int expn, int n)</a>
<a name="ln1353">{</a>
<a name="ln1354">    int q_pw;</a>
<a name="ln1355"> </a>
<a name="ln1356">    q_pw = (expn &gt; n) ? expn - 10 : 0;</a>
<a name="ln1357">    return q_pw;</a>
<a name="ln1358">}</a>
<a name="ln1359"> </a>
<a name="ln1360">static int find_max(int *array, int length)</a>
<a name="ln1361">{</a>
<a name="ln1362">    int i, loc_max;</a>
<a name="ln1363"> </a>
<a name="ln1364">    loc_max = 0;</a>
<a name="ln1365"> </a>
<a name="ln1366">    for (i = 0; i &lt; length; i++) {</a>
<a name="ln1367">        if (array[i] &gt; loc_max) {</a>
<a name="ln1368">            loc_max = array[i];</a>
<a name="ln1369">        }</a>
<a name="ln1370">    }</a>
<a name="ln1371"> </a>
<a name="ln1372">    return loc_max;</a>
<a name="ln1373">}</a>
<a name="ln1374"> </a>
<a name="ln1375">static int paprd_abs(int num)</a>
<a name="ln1376">{</a>
<a name="ln1377">    if (num &lt; 0) {</a>
<a name="ln1378">        return -num;</a>
<a name="ln1379">    }</a>
<a name="ln1380">    return num;</a>
<a name="ln1381">}</a>
<a name="ln1382"> </a>
<a name="ln1383">#define NUM_BIN 23</a>
<a name="ln1384"> </a>
<a name="ln1385">HAL_BOOL create_pa_curve(u_int32_t * paprd_train_data_l,</a>
<a name="ln1386">    u_int32_t * paprd_train_data_u, u_int32_t * pa_table, </a>
<a name="ln1387">    u_int32_t * g_fxp_ext, int *pa_in)</a>
<a name="ln1388">{</a>
<a name="ln1389">    unsigned int accum_cnt[NUM_BIN + 1];</a>
<a name="ln1390">    unsigned int accum_tx[NUM_BIN + 1];</a>
<a name="ln1391">    unsigned int accum_rx[NUM_BIN + 1];</a>
<a name="ln1392">    unsigned int accum_ang[NUM_BIN + 1];</a>
<a name="ln1393">    unsigned int thresh_accum_cnt;</a>
<a name="ln1394"> </a>
<a name="ln1395">    int max_index;</a>
<a name="ln1396">    int scale_factor;</a>
<a name="ln1397"> </a>
<a name="ln1398">    int x_est[NUM_BIN + 1];</a>
<a name="ln1399">    int y[NUM_BIN + 1];</a>
<a name="ln1400">    int theta[NUM_BIN + 1];</a>
<a name="ln1401">    int y_sqr[NUM_BIN + 1];</a>
<a name="ln1402">    int y_quad[NUM_BIN + 1];</a>
<a name="ln1403">    int theta_tilde[NUM_BIN + 1];</a>
<a name="ln1404">    int pa_angle[NUM_BIN + 1];</a>
<a name="ln1405"> </a>
<a name="ln1406">    int b1_tmp[NUM_BIN + 1];</a>
<a name="ln1407">    int b2_tmp[NUM_BIN + 1];</a>
<a name="ln1408">    int b1_abs[NUM_BIN + 1];</a>
<a name="ln1409">    int b2_abs[NUM_BIN + 1];</a>
<a name="ln1410"> </a>
<a name="ln1411">    int y_lin[NUM_BIN + 1];</a>
<a name="ln1412">    int y_est[NUM_BIN + 1];</a>
<a name="ln1413">    int x_est_fxp1_nonlin[NUM_BIN + 1];</a>
<a name="ln1414">    int x_tilde[NUM_BIN + 1];</a>
<a name="ln1415">    int x_tilde_abs[NUM_BIN + 1];</a>
<a name="ln1416"> </a>
<a name="ln1417">    int g_fxp;</a>
<a name="ln1418">    int y_intercept;</a>
<a name="ln1419">    int order_x_by_y;</a>
<a name="ln1420">    int m, half_lo, half_hi;</a>
<a name="ln1421">    int sum_y_sqr;</a>
<a name="ln1422">    int sum_y_quad;</a>
<a name="ln1423">    int q_x, q_b1, q_b2;</a>
<a name="ln1424">    int beta_raw, alpha_raw, scale_b;</a>
<a name="ln1425">    int q_scale_b, q_beta, q_alpha;</a>
<a name="ln1426">    int alpha, beta;</a>
<a name="ln1427">    int order_1, order_2;</a>
<a name="ln1428">    int order1_5x, order2_3x;</a>
<a name="ln1429">    int order1_5x_rem, order2_3x_rem;</a>
<a name="ln1430">    int y5, y3, tmp;</a>
<a name="ln1431">    int bin, idx;</a>
<a name="ln1432">    int theta_low_bin = 0;</a>
<a name="ln1433"> </a>
<a name="ln1434">    /*</a>
<a name="ln1435">     * [15:00] u16, accum_cnt[15:00]: number of samples in the bin</a>
<a name="ln1436">     * [42:16] u27, accum_tx[26:00]: sum(tx amplitude) of the bin</a>
<a name="ln1437">     * [63:43] u21, accum_rx[20:00]: </a>
<a name="ln1438">     *     sum(rx amplitude distance to lower bin edge) of the bin</a>
<a name="ln1439">     * [90:64] s27, accum_ang[26:00]: sum(angles) of the bin</a>
<a name="ln1440">     */</a>
<a name="ln1441">    max_index = 0;</a>
<a name="ln1442">    /*</a>
<a name="ln1443">     * Disregard any bin that contains less than </a>
<a name="ln1444">     * or equal to 16 counts of samples</a>
<a name="ln1445">     */</a>
<a name="ln1446">    thresh_accum_cnt = 16;      </a>
<a name="ln1447">    scale_factor = 5;</a>
<a name="ln1448"> </a>
<a name="ln1449">    for (bin = 0; bin &lt; NUM_BIN; bin++) {</a>
<a name="ln1450">        accum_cnt[bin] = paprd_train_data_l[bin] &amp; 0xffff;</a>
<a name="ln1451">        /* lower 16 bit OR-ed  upper 11 bits */</a>
<a name="ln1452">        accum_tx[bin] = </a>
<a name="ln1453">            ((paprd_train_data_l[bin] &gt;&gt; 16) &amp; 0xffff) | </a>
<a name="ln1454">            ((paprd_train_data_u[bin] &amp; 0x7ff) &lt;&lt; 16);</a>
<a name="ln1455">        accum_rx[bin] =</a>
<a name="ln1456">            ((paprd_train_data_u[bin] &gt;&gt; 11) &amp; 0x1f) |</a>
<a name="ln1457">             ((paprd_train_data_l[bin + 23] &amp; 0xffff) &lt;&lt; 5);</a>
<a name="ln1458">        accum_ang[bin] =</a>
<a name="ln1459">            ((paprd_train_data_l[bin + 23] &gt;&gt; 16) &amp; 0xffff) |</a>
<a name="ln1460">             ((paprd_train_data_u[bin + 23] &amp; 0x7ff) &lt;&lt; 16);</a>
<a name="ln1461">        /*</a>
<a name="ln1462">         * printf(</a>
<a name="ln1463">         *     &quot;%d\t%d\t%d\t%d\n&quot;, accum_cnt[bin], accum_tx[bin],</a>
<a name="ln1464">         *     accum_rx[bin], accum_ang[bin]);</a>
<a name="ln1465">         */</a>
<a name="ln1466">        if (accum_cnt[bin] &gt; thresh_accum_cnt) {</a>
<a name="ln1467">            /* accum_cnt[i] will be non-zero at this point */</a>
<a name="ln1468">            x_est[bin + 1] =</a>
<a name="ln1469">                ((((accum_tx[bin] &lt;&lt; scale_factor) +</a>
<a name="ln1470">                    accum_cnt[bin]) / accum_cnt[bin]) + 32) &gt;&gt; scale_factor;</a>
<a name="ln1471">            y[bin + 1] =</a>
<a name="ln1472">                (((((accum_rx[bin] &lt;&lt; scale_factor) +</a>
<a name="ln1473">                     accum_cnt[bin]) / accum_cnt[bin]) + 32) &gt;&gt; scale_factor) +</a>
<a name="ln1474">                (1 &lt;&lt; scale_factor) * max_index + 16;</a>
<a name="ln1475">            if (accum_ang[bin] &gt;= (1 &lt;&lt; 26)) {</a>
<a name="ln1476">                theta[bin + 1] =</a>
<a name="ln1477">                    ((accum_ang[bin] - (1 &lt;&lt; 27)) * (1 &lt;&lt; scale_factor) +</a>
<a name="ln1478">                    accum_cnt[bin]);</a>
<a name="ln1479">                theta[bin + 1] = theta[bin + 1] / (int) accum_cnt[bin];</a>
<a name="ln1480">                /*</a>
<a name="ln1481">                 *  theta[i+1] = </a>
<a name="ln1482">                 *      ((accum_ang[i] - (1 &lt;&lt; 27)) * </a>
<a name="ln1483">                 *      (1 &lt;&lt; scale_factor) + zz) / zz;</a>
<a name="ln1484">                 */</a>
<a name="ln1485">            } else {</a>
<a name="ln1486">                theta[bin + 1] =</a>
<a name="ln1487">                    ((accum_ang[bin] * (1 &lt;&lt; scale_factor)) +</a>
<a name="ln1488">                    accum_cnt[bin]) / accum_cnt[bin];</a>
<a name="ln1489">            }</a>
<a name="ln1490">            max_index++;</a>
<a name="ln1491">        }</a>
<a name="ln1492">        /*</a>
<a name="ln1493">         * printf(</a>
<a name="ln1494">         *     &quot;i=%d, theta[i+1]=%d\t%d\t%d\t%d\t%d\n&quot;, </a>
<a name="ln1495">         *     i, theta[i+1], accum_cnt[i], </a>
<a name="ln1496">         *     accum_tx[i], accum_rx[i], accum_ang[i]);</a>
<a name="ln1497">         */</a>
<a name="ln1498">    }</a>
<a name="ln1499"> </a>
<a name="ln1500">    /*</a>
<a name="ln1501">     * Find average theta of first 5 bin and all of those to same value. </a>
<a name="ln1502">     * Curve is linear at that range.</a>
<a name="ln1503">     */</a>
<a name="ln1504">    for (bin = 1; bin &lt; 6; bin++) {</a>
<a name="ln1505">        theta_low_bin += theta[bin];</a>
<a name="ln1506">    }</a>
<a name="ln1507">    theta_low_bin = theta_low_bin / 5;</a>
<a name="ln1508">    for (bin = 1; bin &lt; 6; bin++) {</a>
<a name="ln1509">        theta[bin] = theta_low_bin;</a>
<a name="ln1510">    }</a>
<a name="ln1511"> </a>
<a name="ln1512">    /* Set values at origin */</a>
<a name="ln1513">    theta[0] = theta_low_bin;</a>
<a name="ln1514"> </a>
<a name="ln1515">    for (bin = 0; bin &lt;= max_index; bin++) {</a>
<a name="ln1516">        theta[bin] = theta[bin] - theta_low_bin;</a>
<a name="ln1517">        /*printf(&quot;bin=%d, theta[bin] = %d\n&quot;, bin, theta[bin]);*/</a>
<a name="ln1518">    }</a>
<a name="ln1519"> </a>
<a name="ln1520">    x_est[0] = 0;</a>
<a name="ln1521">    y[0] = 0;</a>
<a name="ln1522">    scale_factor = 8;</a>
<a name="ln1523">    /* low signal gain */</a>
<a name="ln1524">    if (x_est[6] == x_est[3]) {</a>
<a name="ln1525">        return AH_FALSE;</a>
<a name="ln1526">    }</a>
<a name="ln1527">    g_fxp =</a>
<a name="ln1528">        (((y[6] - y[3]) * 1 &lt;&lt; scale_factor) + (x_est[6] - x_est[3])) /</a>
<a name="ln1529">        (x_est[6] - x_est[3]);</a>
<a name="ln1530">    if (g_fxp == 0) {</a>
<a name="ln1531">        /*</a>
<a name="ln1532">         * ath_hal_printf(</a>
<a name="ln1533">         *     NULL, &quot;%s[%d] Potential divide by zero error\n&quot;,</a>
<a name="ln1534">         *     __func__, __LINE__);</a>
<a name="ln1535">         */</a>
<a name="ln1536">        return AH_FALSE;</a>
<a name="ln1537">    }</a>
<a name="ln1538"> </a>
<a name="ln1539">    for (bin = 0; bin &lt;= max_index; bin++) {</a>
<a name="ln1540">        y_lin[bin] =</a>
<a name="ln1541">            (g_fxp * (x_est[bin] - x_est[3]) + (1 &lt;&lt; scale_factor)) /</a>
<a name="ln1542">            (1 &lt;&lt; scale_factor) + y[3];</a>
<a name="ln1543">    }</a>
<a name="ln1544">    y_intercept = y_lin[0];</a>
<a name="ln1545"> </a>
<a name="ln1546">    for (bin = 0; bin &lt;= max_index; bin++) {</a>
<a name="ln1547">        y_est[bin] = y[bin] - y_intercept;</a>
<a name="ln1548">        y_lin[bin] = y_lin[bin] - y_intercept;</a>
<a name="ln1549">    }</a>
<a name="ln1550"> </a>
<a name="ln1551">    for (bin = 0; bin &lt;= 3; bin++) {</a>
<a name="ln1552">        y_est[bin] = bin * 32;</a>
<a name="ln1553">        /* g_fxp was checked for zero already */</a>
<a name="ln1554">        x_est[bin] = ((y_est[bin] * 1 &lt;&lt; scale_factor) + g_fxp) / g_fxp;</a>
<a name="ln1555">    }</a>
<a name="ln1556"> </a>
<a name="ln1557">    /*</a>
<a name="ln1558">     *  for (bin = 0; bin &lt;= max_index; bin++) {</a>
<a name="ln1559">     *      printf(&quot;y_est[%d] = %d, x_est[%d]=%d\n&quot;,</a>
<a name="ln1560">     *          bin, y_est[bin], bin, x_est[bin]);</a>
<a name="ln1561">     *  }</a>
<a name="ln1562">     */</a>
<a name="ln1563">    for (bin = 0; bin &lt;= max_index; bin++) {</a>
<a name="ln1564">        x_est_fxp1_nonlin[bin] =</a>
<a name="ln1565">            x_est[bin] - ((1 &lt;&lt; scale_factor) * y_est[bin] + g_fxp) / g_fxp;</a>
<a name="ln1566">        /*printf(&quot;x_est_fxp1_nonlin[%d] = %d\n&quot;, bin, x_est_fxp1_nonlin[bin]);*/</a>
<a name="ln1567">    }</a>
<a name="ln1568"> </a>
<a name="ln1569">    /* Check for divide by 0 */</a>
<a name="ln1570">    if (y_est[max_index] == 0) {</a>
<a name="ln1571">        return AH_FALSE;</a>
<a name="ln1572">    }</a>
<a name="ln1573">    order_x_by_y =</a>
<a name="ln1574">        (x_est_fxp1_nonlin[max_index] + y_est[max_index]) / y_est[max_index];</a>
<a name="ln1575">    if (order_x_by_y == 0) {</a>
<a name="ln1576">        m = 10;</a>
<a name="ln1577">    } else if (order_x_by_y == 1) {</a>
<a name="ln1578">        m = 9;</a>
<a name="ln1579">    } else {</a>
<a name="ln1580">        m = 8;</a>
<a name="ln1581">    }</a>
<a name="ln1582"> </a>
<a name="ln1583">    half_lo = (max_index &gt; 15) ? 7 : max_index &gt;&gt; 1;</a>
<a name="ln1584">    half_hi = max_index - half_lo;</a>
<a name="ln1585">    scale_factor = 8;</a>
<a name="ln1586">    sum_y_sqr = 0;</a>
<a name="ln1587">    sum_y_quad = 0;</a>
<a name="ln1588"> </a>
<a name="ln1589">    for (bin = 0; bin &lt;= half_hi; bin++) {</a>
<a name="ln1590">        if (y_est[bin + half_lo] == 0) {</a>
<a name="ln1591">            /*</a>
<a name="ln1592">             * ath_hal_printf(</a>
<a name="ln1593">             *     NULL, &quot;%s Potential divide by zero error\n&quot;, __func__);</a>
<a name="ln1594">             */</a>
<a name="ln1595">            return AH_FALSE;</a>
<a name="ln1596">        }</a>
<a name="ln1597"> </a>
<a name="ln1598">        x_tilde[bin] =</a>
<a name="ln1599">            (x_est_fxp1_nonlin[bin + half_lo] * (1 &lt;&lt; m) +</a>
<a name="ln1600">             y_est[bin + half_lo]) / y_est[bin + half_lo];</a>
<a name="ln1601">        x_tilde[bin] = (x_tilde[bin] * (1 &lt;&lt; m) + y_est[bin + half_lo]) /</a>
<a name="ln1602">            y_est[bin + half_lo];</a>
<a name="ln1603">        x_tilde[bin] = (x_tilde[bin] * (1 &lt;&lt; m) + y_est[bin + half_lo]) /</a>
<a name="ln1604">            y_est[bin + half_lo];</a>
<a name="ln1605"> </a>
<a name="ln1606">        y_sqr[bin] =</a>
<a name="ln1607">            (y_est[bin + half_lo] * y_est[bin + half_lo] +</a>
<a name="ln1608">             (scale_factor * scale_factor)) / (scale_factor * scale_factor);</a>
<a name="ln1609">        x_tilde_abs[bin] = paprd_abs(x_tilde[bin]);</a>
<a name="ln1610">        y_quad[bin] = y_sqr[bin] * y_sqr[bin];</a>
<a name="ln1611">        sum_y_sqr = sum_y_sqr + y_sqr[bin];</a>
<a name="ln1612">        sum_y_quad = sum_y_quad + y_quad[bin];</a>
<a name="ln1613">    }</a>
<a name="ln1614"> </a>
<a name="ln1615">    /*printf(&quot;sum_y_sqr = %d, sum_y_quad=%d\n&quot;, sum_y_sqr, sum_y_quad);*/</a>
<a name="ln1616"> </a>
<a name="ln1617">    for (bin = 0; bin &lt;= half_hi; bin++) {</a>
<a name="ln1618">        b1_tmp[bin] = y_sqr[bin] * (half_hi + 1) - sum_y_sqr;</a>
<a name="ln1619">        b2_tmp[bin] = sum_y_quad - sum_y_sqr * y_sqr[bin];</a>
<a name="ln1620">        b1_abs[bin] = paprd_abs(b1_tmp[bin]);</a>
<a name="ln1621">        b2_abs[bin] = paprd_abs(b2_tmp[bin]);</a>
<a name="ln1622"> </a>
<a name="ln1623">        /*</a>
<a name="ln1624">         * printf(</a>
<a name="ln1625">         *     &quot;bin=%d, b1_tmp[bin] = %d, b2_tmp[bin] = %d\n&quot;, </a>
<a name="ln1626">         *     bin, b1_tmp[bin], b2_tmp[bin]);</a>
<a name="ln1627">         */</a>
<a name="ln1628">    }</a>
<a name="ln1629"> </a>
<a name="ln1630">    q_x = find_proper_scale(find_expn(find_max(x_tilde_abs, half_hi + 1)), 10);</a>
<a name="ln1631">    q_b1 = find_proper_scale(find_expn(find_max(b1_abs, half_hi + 1)), 10);</a>
<a name="ln1632">    q_b2 = find_proper_scale(find_expn(find_max(b2_abs, half_hi + 1)), 10);</a>
<a name="ln1633"> </a>
<a name="ln1634">    beta_raw = 0;</a>
<a name="ln1635">    alpha_raw = 0;</a>
<a name="ln1636"> </a>
<a name="ln1637">    for (bin = 0; bin &lt;= half_hi; bin++) {</a>
<a name="ln1638">        x_tilde[bin] = x_tilde[bin] / (1 &lt;&lt; q_x);</a>
<a name="ln1639">        b1_tmp[bin] = b1_tmp[bin] / (1 &lt;&lt; q_b1);</a>
<a name="ln1640">        b2_tmp[bin] = b2_tmp[bin] / (1 &lt;&lt; q_b2);</a>
<a name="ln1641"> </a>
<a name="ln1642">        /*</a>
<a name="ln1643">         * printf(</a>
<a name="ln1644">         *     &quot;bin=%d, b1_tmp[bin]=%d b2_tmp[bin]=%d x_tilde[bin] = %d\n&quot;, </a>
<a name="ln1645">         *     bin, b1_tmp[bin], b2_tmp[bin], x_tilde[bin]);</a>
<a name="ln1646">         */</a>
<a name="ln1647">        beta_raw = beta_raw + b1_tmp[bin] * x_tilde[bin];</a>
<a name="ln1648">        alpha_raw = alpha_raw + b2_tmp[bin] * x_tilde[bin];</a>
<a name="ln1649">    }</a>
<a name="ln1650"> </a>
<a name="ln1651">    scale_b =</a>
<a name="ln1652">        ((sum_y_quad / scale_factor) * (half_hi + 1) -</a>
<a name="ln1653">        (sum_y_sqr / scale_factor) * sum_y_sqr) * scale_factor;</a>
<a name="ln1654">    q_scale_b = find_proper_scale(find_expn(paprd_abs(scale_b)), 10);</a>
<a name="ln1655">    scale_b = scale_b / (1 &lt;&lt; q_scale_b);</a>
<a name="ln1656">    /* Check for divide by 0 */</a>
<a name="ln1657">    if (scale_b == 0) {</a>
<a name="ln1658">        return AH_FALSE;</a>
<a name="ln1659">    }</a>
<a name="ln1660">    q_beta = find_proper_scale(find_expn(paprd_abs(beta_raw)), 10);</a>
<a name="ln1661">    q_alpha = find_proper_scale(find_expn(paprd_abs(alpha_raw)), 10);</a>
<a name="ln1662"> </a>
<a name="ln1663">    beta_raw = beta_raw / (1 &lt;&lt; q_beta);</a>
<a name="ln1664">    alpha_raw = alpha_raw / (1 &lt;&lt; q_alpha);</a>
<a name="ln1665">    alpha = (alpha_raw &lt;&lt; 10) / scale_b;</a>
<a name="ln1666">    beta = (beta_raw &lt;&lt; 10) / scale_b;</a>
<a name="ln1667">    order_1 = 3 * m - q_x - q_b1 - q_beta + 10 + q_scale_b;</a>
<a name="ln1668">    order_2 = 3 * m - q_x - q_b2 - q_alpha + 10 + q_scale_b;</a>
<a name="ln1669"> </a>
<a name="ln1670">    order1_5x = order_1 / 5;</a>
<a name="ln1671">    order2_3x = order_2 / 3;</a>
<a name="ln1672"> </a>
<a name="ln1673">    order1_5x_rem = order_1 - 5 * order1_5x;</a>
<a name="ln1674">    order2_3x_rem = order_2 - 3 * order2_3x;</a>
<a name="ln1675"> </a>
<a name="ln1676">    for (idx = 0; idx &lt; AR9300_PAPRD_TABLE_SZ; idx++) {</a>
<a name="ln1677">        tmp = idx * 32;</a>
<a name="ln1678">        y5 = ((beta * tmp) &gt;&gt; 6) &gt;&gt; order1_5x;</a>
<a name="ln1679">        y5 = (y5 * tmp) &gt;&gt; order1_5x;</a>
<a name="ln1680">        y5 = (y5 * tmp) &gt;&gt; order1_5x;</a>
<a name="ln1681">        y5 = (y5 * tmp) &gt;&gt; order1_5x;</a>
<a name="ln1682">        y5 = (y5 * tmp) &gt;&gt; order1_5x;</a>
<a name="ln1683"> </a>
<a name="ln1684">        y5 = y5 &gt;&gt; order1_5x_rem;</a>
<a name="ln1685">        y3 = (alpha * tmp) &gt;&gt; order2_3x;</a>
<a name="ln1686">        y3 = (y3 * tmp) &gt;&gt; order2_3x;</a>
<a name="ln1687">        y3 = (y3 * tmp) &gt;&gt; order2_3x;</a>
<a name="ln1688"> </a>
<a name="ln1689">        y3 = y3 &gt;&gt; order2_3x_rem;</a>
<a name="ln1690">        /* g_fxp was checked for zero already */</a>
<a name="ln1691">        pa_in[idx] = y5 + y3 + (256 * tmp) / g_fxp;</a>
<a name="ln1692">    }</a>
<a name="ln1693"> </a>
<a name="ln1694">    for (idx = 1; idx &lt; 23; idx++) {</a>
<a name="ln1695">        tmp = pa_in[idx + 1] - pa_in[idx];</a>
<a name="ln1696">        if (tmp &lt; 0) {</a>
<a name="ln1697">            pa_in[idx + 1] = pa_in[idx] + (pa_in[idx] - pa_in[idx - 1]);</a>
<a name="ln1698">        }</a>
<a name="ln1699">    }</a>
<a name="ln1700"> </a>
<a name="ln1701">    for (idx = 0; idx &lt; AR9300_PAPRD_TABLE_SZ; idx++) {</a>
<a name="ln1702">        pa_in[idx] = (pa_in[idx] &lt; 1400) ? pa_in[idx] : 1400;</a>
<a name="ln1703">        /*printf(&quot;idx=%d, pa_in[idx]=%d\n&quot;, i, pa_in[idx]);*/</a>
<a name="ln1704">    }</a>
<a name="ln1705"> </a>
<a name="ln1706">    beta_raw = 0;</a>
<a name="ln1707">    alpha_raw = 0;</a>
<a name="ln1708"> </a>
<a name="ln1709">    for (bin = 0; bin &lt;= half_hi; bin++) {</a>
<a name="ln1710">        /*</a>
<a name="ln1711">         *  printf(</a>
<a name="ln1712">         *      &quot;bin=%d half_lo=%d m=%d theta[bin+half_lo]=%d &quot;</a>
<a name="ln1713">         *      &quot;y_est[bin+half_lo]=%d\n&quot;, </a>
<a name="ln1714">         *      bin, half_lo, m, theta[bin+half_lo], y_est[bin+half_lo]);</a>
<a name="ln1715">         */</a>
<a name="ln1716">        /* y_est[] was already checked for zero */</a>
<a name="ln1717">        theta_tilde[bin] =</a>
<a name="ln1718">            ((theta[bin + half_lo] &lt;&lt; m) + y_est[bin + half_lo]) /</a>
<a name="ln1719">            y_est[bin + half_lo];</a>
<a name="ln1720">        theta_tilde[bin] = ((theta_tilde[bin] &lt;&lt; m) + y_est[bin + half_lo]) /</a>
<a name="ln1721">            y_est[bin + half_lo];</a>
<a name="ln1722">        theta_tilde[bin] = ((theta_tilde[bin] &lt;&lt; m) + y_est[bin + half_lo]) /</a>
<a name="ln1723">            y_est[bin + half_lo];</a>
<a name="ln1724"> </a>
<a name="ln1725">        /*printf(&quot;bin=%d theta_tilde[bin]=%d\n&quot;, bin, theta_tilde[bin]);*/</a>
<a name="ln1726">        beta_raw = beta_raw + b1_tmp[bin] * theta_tilde[bin];</a>
<a name="ln1727">        alpha_raw = alpha_raw + b2_tmp[bin] * theta_tilde[bin];</a>
<a name="ln1728"> </a>
<a name="ln1729">        /*</a>
<a name="ln1730">        printf(&quot;bin=%d, alpha_raw=%d, beta_raw=%d\n&quot;, bin, alpha_raw, beta_raw);</a>
<a name="ln1731">         */</a>
<a name="ln1732">    }</a>
<a name="ln1733"> </a>
<a name="ln1734">    q_beta = find_proper_scale(find_expn(paprd_abs(beta_raw)), 10);</a>
<a name="ln1735">    q_alpha = find_proper_scale(find_expn(paprd_abs(alpha_raw)), 10);</a>
<a name="ln1736"> </a>
<a name="ln1737">    beta_raw = beta_raw / (1 &lt;&lt; q_beta);</a>
<a name="ln1738">    alpha_raw = alpha_raw / (1 &lt;&lt; q_alpha);</a>
<a name="ln1739">    /* scale_b checked for zero previously */</a>
<a name="ln1740">    alpha = (alpha_raw &lt;&lt; 10) / scale_b;</a>
<a name="ln1741">    beta = (beta_raw &lt;&lt; 10) / scale_b;</a>
<a name="ln1742">    order_1 = 3 * m - q_x - q_b1 - q_beta + 10 + q_scale_b + 5;</a>
<a name="ln1743">    order_2 = 3 * m - q_x - q_b2 - q_alpha + 10 + q_scale_b + 5;</a>
<a name="ln1744"> </a>
<a name="ln1745">    order1_5x = order_1 / 5;</a>
<a name="ln1746">    order2_3x = order_2 / 3;</a>
<a name="ln1747"> </a>
<a name="ln1748">    order1_5x_rem = order_1 - 5 * order1_5x;</a>
<a name="ln1749">    order2_3x_rem = order_2 - 3 * order2_3x;</a>
<a name="ln1750"> </a>
<a name="ln1751">    for (idx = 0; idx &lt; AR9300_PAPRD_TABLE_SZ; idx++) {</a>
<a name="ln1752">        tmp = idx * 32;</a>
<a name="ln1753"> </a>
<a name="ln1754">        if (beta &gt; 0) {</a>
<a name="ln1755">            y5 = (((beta * tmp - 64) &gt;&gt; 6) -</a>
<a name="ln1756">                (1 &lt;&lt; order1_5x)) / (1 &lt;&lt; order1_5x);</a>
<a name="ln1757">        } else {</a>
<a name="ln1758">            y5 = ((((beta * tmp - 64) &gt;&gt; 6) +</a>
<a name="ln1759">                    (1 &lt;&lt; order1_5x)) / (1 &lt;&lt; order1_5x));</a>
<a name="ln1760">        }</a>
<a name="ln1761"> </a>
<a name="ln1762">        y5 = (y5 * tmp) / (1 &lt;&lt; order1_5x);</a>
<a name="ln1763">        y5 = (y5 * tmp) / (1 &lt;&lt; order1_5x);</a>
<a name="ln1764">        y5 = (y5 * tmp) / (1 &lt;&lt; order1_5x);</a>
<a name="ln1765">        y5 = (y5 * tmp) / (1 &lt;&lt; order1_5x);</a>
<a name="ln1766"> </a>
<a name="ln1767">        y5 = y5 / (1 &lt;&lt; order1_5x_rem);</a>
<a name="ln1768"> </a>
<a name="ln1769">        if (beta &gt; 0) {</a>
<a name="ln1770">            y3 = (alpha * tmp - (1 &lt;&lt; order2_3x)) / (1 &lt;&lt; order2_3x);</a>
<a name="ln1771">        } else {</a>
<a name="ln1772">            y3 = (alpha * tmp + (1 &lt;&lt; order2_3x)) / (1 &lt;&lt; order2_3x);</a>
<a name="ln1773">        }</a>
<a name="ln1774"> </a>
<a name="ln1775">        y3 = (y3 * tmp) / (1 &lt;&lt; order2_3x);</a>
<a name="ln1776">        y3 = (y3 * tmp) / (1 &lt;&lt; order2_3x);</a>
<a name="ln1777"> </a>
<a name="ln1778">        y3 = y3 / (1 &lt;&lt; order2_3x_rem);</a>
<a name="ln1779">        pa_angle[idx] = y5 + y3;</a>
<a name="ln1780">        /*printf(&quot;idx=%d, y5 = %d, y3=%d\n&quot;, idx, y5, y3);*/</a>
<a name="ln1781">        pa_angle[idx] =</a>
<a name="ln1782">            (pa_angle[idx] &lt; -150) ? -150 : ((pa_angle[idx] &gt;</a>
<a name="ln1783">                150) ? 150 : pa_angle[idx]);</a>
<a name="ln1784">    }</a>
<a name="ln1785"> </a>
<a name="ln1786">    pa_angle[0] = 0;</a>
<a name="ln1787">    pa_angle[1] = 0;</a>
<a name="ln1788">    pa_angle[2] = 0;</a>
<a name="ln1789">    pa_angle[3] = 0;</a>
<a name="ln1790"> </a>
<a name="ln1791">    pa_angle[4] = (pa_angle[5] + 2) &gt;&gt; 1;</a>
<a name="ln1792"> </a>
<a name="ln1793">    for (idx = 0; idx &lt; AR9300_PAPRD_TABLE_SZ; idx++) {</a>
<a name="ln1794">        pa_table[idx] = ((pa_in[idx] &amp; 0x7ff) &lt;&lt; 11) + (pa_angle[idx] &amp; 0x7ff);</a>
<a name="ln1795">        /*</a>
<a name="ln1796">         * HALDEBUG(</a>
<a name="ln1797">         *     NULL, HAL_DEBUG_UNMASKABLE,&quot;%d\t%d\t0x%x\n&quot;, </a>
<a name="ln1798">         *     pa_in[idx], pa_angle[idx], pa_table[idx]);</a>
<a name="ln1799">         */</a>
<a name="ln1800">    }</a>
<a name="ln1801"> </a>
<a name="ln1802">    /*HALDEBUG(NULL, HAL_DEBUG_UNMASKABLE, &quot;g_fxp = %d\n&quot;, g_fxp);*/</a>
<a name="ln1803">    *g_fxp_ext = g_fxp;</a>
<a name="ln1804">    return AH_TRUE;</a>
<a name="ln1805">}</a>
<a name="ln1806"> </a>
<a name="ln1807">// Due to a hardware bug, when transmitting with just one chain the papd</a>
<a name="ln1808">// data for chain 0 is always used. So when using chain 2 or 4, the </a>
<a name="ln1809">// corresponding data must be copied into the chain 0 area.</a>
<a name="ln1810">void ar9300_swizzle_paprd_entries(struct ath_hal *ah, unsigned int txchain)</a>
<a name="ln1811">{</a>
<a name="ln1812">    int i;</a>
<a name="ln1813">    u_int32_t *paprd_table_val = NULL;</a>
<a name="ln1814">    u_int32_t small_signal_gain = 0;</a>
<a name="ln1815">    u_int32_t reg = 0;</a>
<a name="ln1816"> </a>
<a name="ln1817">    reg = AR_PHY_PAPRD_MEM_TAB_B0;</a>
<a name="ln1818">    switch (txchain) {</a>
<a name="ln1819">    case 0x1: </a>
<a name="ln1820">    case 0x3:</a>
<a name="ln1821">    case 0x7:</a>
<a name="ln1822">	paprd_table_val = &amp;AH9300(ah)-&gt;pa_table[0][0];</a>
<a name="ln1823">	small_signal_gain = AH9300(ah)-&gt;small_signal_gain[0];</a>
<a name="ln1824">	break;</a>
<a name="ln1825">    case 0x2:</a>
<a name="ln1826">	paprd_table_val = &amp;AH9300(ah)-&gt;pa_table[1][0];</a>
<a name="ln1827">	small_signal_gain = AH9300(ah)-&gt;small_signal_gain[1];</a>
<a name="ln1828">	break;</a>
<a name="ln1829">    case 0x4:</a>
<a name="ln1830">	paprd_table_val = &amp;AH9300(ah)-&gt;pa_table[2][0];</a>
<a name="ln1831">	small_signal_gain = AH9300(ah)-&gt;small_signal_gain[2];</a>
<a name="ln1832">	break;</a>
<a name="ln1833">    default:</a>
<a name="ln1834">	// Error out.</a>
<a name="ln1835">	ath_hal_printf(ah, &quot;YAK! Bad chain mask %x\n&quot;, txchain);</a>
<a name="ln1836">	return;</a>
<a name="ln1837">    }</a>
<a name="ln1838">    for (i = 0; i &lt; AR9300_PAPRD_TABLE_SZ; i++) { </a>
<a name="ln1839">        OS_REG_WRITE(ah, reg, paprd_table_val[i]);</a>
<a name="ln1840">        HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__,</a>
<a name="ln1841">		 __LINE__, reg, paprd_table_val[i]);</a>
<a name="ln1842">        </a>
<a name="ln1843">        reg = reg + 4;</a>
<a name="ln1844">    }</a>
<a name="ln1845">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PA_GAIN123_B0,AR_PHY_PA_GAIN123_B0_PA_GAIN1_0, small_signal_gain);</a>
<a name="ln1846">    HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x small_signal_gain 0x%08x\n&quot;, __func__, __LINE__,</a>
<a name="ln1847">	     (unsigned) AR_PHY_PA_GAIN123_B0, OS_REG_READ(ah, AR_PHY_PA_GAIN123_B0));</a>
<a name="ln1848"> </a>
<a name="ln1849">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0, AR_PHY_PAPRD_CTRL1_B0_PAPRD_POWER_AT_AM2AM_CAL_0,</a>
<a name="ln1850">			 AH9300(ah)-&gt;paprd_training_power);</a>
<a name="ln1851">    HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__, __LINE__, </a>
<a name="ln1852">	     (unsigned) AR_PHY_PAPRD_CTRL1_B0, OS_REG_READ(ah, AR_PHY_PAPRD_CTRL1_B0));</a>
<a name="ln1853"> </a>
<a name="ln1854">}</a>
<a name="ln1855"> </a>
<a name="ln1856">void ar9300_populate_paprd_single_table(struct ath_hal *ah,</a>
<a name="ln1857">    struct ieee80211_channel *chan, int chain_num)</a>
<a name="ln1858">{</a>
<a name="ln1859">    int i, j, bad_read = 0;</a>
<a name="ln1860">#ifdef	AH_DEBUG</a>
<a name="ln1861">    HAL_CHANNEL_INTERNAL *ichan = ath_hal_checkchannel(ah, chan);</a>
<a name="ln1862">#endif</a>
<a name="ln1863">    u_int32_t *paprd_table_val = &amp;AH9300(ah)-&gt;pa_table[chain_num][0];</a>
<a name="ln1864">    u_int32_t small_signal_gain = AH9300(ah)-&gt;small_signal_gain[chain_num];</a>
<a name="ln1865">    u_int32_t reg = 0;</a>
<a name="ln1866"> </a>
<a name="ln1867">    HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln1868">        &quot;%s[%d]: channel %d paprd_done %d write %d\n&quot;, __func__, __LINE__,</a>
<a name="ln1869">        ichan-&gt;channel, ichan-&gt;paprd_done, ichan-&gt;paprd_table_write_done);</a>
<a name="ln1870"> </a>
<a name="ln1871">    if (chain_num == 0) {</a>
<a name="ln1872">        reg = AR_PHY_PAPRD_MEM_TAB_B0;</a>
<a name="ln1873">    } else if (chain_num == 1) {</a>
<a name="ln1874">        reg = AR_PHY_PAPRD_MEM_TAB_B1;</a>
<a name="ln1875">    } else if (chain_num == 2) {</a>
<a name="ln1876">        reg = AR_PHY_PAPRD_MEM_TAB_B2;</a>
<a name="ln1877">    }</a>
<a name="ln1878"> </a>
<a name="ln1879">    for (i = 0; i &lt; AR9300_PAPRD_TABLE_SZ; i++) {</a>
<a name="ln1880">        if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln1881">            HALASSERT(chain_num == 0x1);</a>
<a name="ln1882">            if ((reg == AR_PHY_PAPRD_MEM_TAB_B1) || </a>
<a name="ln1883">                (reg == AR_PHY_PAPRD_MEM_TAB_B2)) {</a>
<a name="ln1884">                continue;</a>
<a name="ln1885">            }</a>
<a name="ln1886">        }</a>
<a name="ln1887">        /*</a>
<a name="ln1888">         * sprintf(</a>
<a name="ln1889">         *     field_name, &quot;%s%d[%d]%s\0&quot;, &quot;BB_paprd_mem_tab_b&quot;, </a>
<a name="ln1890">         *     chain_num, i, &quot;.paprd_mem&quot;);</a>
<a name="ln1891">         */</a>
<a name="ln1892">        OS_REG_WRITE(ah, reg, paprd_table_val[i]);</a>
<a name="ln1893">        HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__,</a>
<a name="ln1894">            __LINE__, reg, paprd_table_val[i]);</a>
<a name="ln1895">        /*</a>
<a name="ln1896">         * printf(</a>
<a name="ln1897">         *     &quot;%s[%d] reg %08x = 0x%08x\n&quot;, </a>
<a name="ln1898">         *     __func__, __LINE__, reg, paprd_table_val[i]);</a>
<a name="ln1899">         */</a>
<a name="ln1900">         if (OS_REG_READ(ah, reg) == 0xdeadbeef) {</a>
<a name="ln1901">            HALDEBUG(ah, HAL_DEBUG_UNMASKABLE, </a>
<a name="ln1902">                     &quot;%s: Reg0x%x = 0xdeadbeef\n&quot;, __func__, reg);</a>
<a name="ln1903">            bad_read++;</a>
<a name="ln1904">            for (j = AR_PHY_PAPRD_MEM_TAB_B0; j &lt; (AR_PHY_PAPRD_MEM_TAB_B0 + 0x10); j+=4)</a>
<a name="ln1905">            {</a>
<a name="ln1906">                if (OS_REG_READ(ah, j) == 0xdeadbeef) {</a>
<a name="ln1907">                    HALDEBUG(ah, HAL_DEBUG_UNMASKABLE, </a>
<a name="ln1908">                             &quot;%s: Reg0x%x = 0xdeadbeef\n&quot;, __func__, j);</a>
<a name="ln1909">                    bad_read++;</a>
<a name="ln1910">                }</a>
<a name="ln1911">            }</a>
<a name="ln1912">            for (j = AR_PHY_PAPRD_MEM_TAB_B1; j &lt; (AR_PHY_PAPRD_MEM_TAB_B1 + 0x10); j+=4)</a>
<a name="ln1913">            {</a>
<a name="ln1914">                if (OS_REG_READ(ah, j) == 0xdeadbeef) {</a>
<a name="ln1915">                    HALDEBUG(ah, HAL_DEBUG_UNMASKABLE, </a>
<a name="ln1916">                             &quot;%s: Reg0x%x = 0xdeadbeef\n&quot;, __func__, j);</a>
<a name="ln1917">                    bad_read++;</a>
<a name="ln1918">                }</a>
<a name="ln1919">            }</a>
<a name="ln1920">         }</a>
<a name="ln1921">         </a>
<a name="ln1922">        reg = reg + 4;</a>
<a name="ln1923">    }</a>
<a name="ln1924"> </a>
<a name="ln1925">    if (bad_read &gt; 4) {</a>
<a name="ln1926">        HALDEBUG(ah, HAL_DEBUG_UNMASKABLE, </a>
<a name="ln1927">                 &quot;%s: Get %d 0xdeadbeef. Mark PAPRD as broken.\n&quot;, </a>
<a name="ln1928">                 __func__, bad_read);</a>
<a name="ln1929">        AH9300(ah)-&gt;ah_paprd_broken = AH_TRUE;</a>
<a name="ln1930">    }</a>
<a name="ln1931"> </a>
<a name="ln1932">    if (chain_num == 0) {</a>
<a name="ln1933">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PA_GAIN123_B0,</a>
<a name="ln1934">            AR_PHY_PA_GAIN123_B0_PA_GAIN1_0, small_signal_gain);</a>
<a name="ln1935">        HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln1936">            &quot;%s[%d] reg %08x small_signal_gain 0x%08x\n&quot;, __func__, __LINE__,</a>
<a name="ln1937">            (unsigned) AR_PHY_PA_GAIN123_B0,</a>
<a name="ln1938">            OS_REG_READ(ah, AR_PHY_PA_GAIN123_B0));</a>
<a name="ln1939">    } else if (chain_num == 1) {</a>
<a name="ln1940">        if (!AR_SREV_POSEIDON(ah) &amp;&amp; !AR_SREV_HORNET(ah) &amp;&amp; !AR_SREV_APHRODITE(ah)) {</a>
<a name="ln1941">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PA_GAIN123_B1,</a>
<a name="ln1942">                AR_PHY_PA_GAIN123_B1_PA_GAIN1_1, small_signal_gain);</a>
<a name="ln1943">            HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln1944">                &quot;%s[%d] reg %08x small_signal_gain 0x%08x\n&quot;,</a>
<a name="ln1945">                __func__, __LINE__,</a>
<a name="ln1946">                (unsigned) AR_PHY_PA_GAIN123_B1,</a>
<a name="ln1947">                OS_REG_READ(ah, AR_PHY_PA_GAIN123_B1));</a>
<a name="ln1948">        }</a>
<a name="ln1949">    } else if (chain_num == 2) {</a>
<a name="ln1950">        if (!AR_SREV_POSEIDON(ah) &amp;&amp; !AR_SREV_HORNET(ah) &amp;&amp; !AR_SREV_APHRODITE(ah)) {</a>
<a name="ln1951">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PA_GAIN123_B2,</a>
<a name="ln1952">                AR_PHY_PA_GAIN123_B2_PA_GAIN1_2, small_signal_gain);</a>
<a name="ln1953">            HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln1954">                &quot;%s[%d] reg %08x small_signal_gain 0x%08x\n&quot;,</a>
<a name="ln1955">                __func__, __LINE__,</a>
<a name="ln1956">                (unsigned) AR_PHY_PA_GAIN123_B2,</a>
<a name="ln1957">                OS_REG_READ(ah, AR_PHY_PA_GAIN123_B2));</a>
<a name="ln1958">        }</a>
<a name="ln1959">    } else {</a>
<a name="ln1960">        /* invalid channel number */</a>
<a name="ln1961">    }</a>
<a name="ln1962"> </a>
<a name="ln1963">    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln1964">        AR_PHY_PAPRD_CTRL1_B0_PAPRD_POWER_AT_AM2AM_CAL_0,</a>
<a name="ln1965">        AH9300(ah)-&gt;paprd_training_power);</a>
<a name="ln1966">    HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__,</a>
<a name="ln1967">        __LINE__, (unsigned) AR_PHY_PAPRD_CTRL1_B0,</a>
<a name="ln1968">        OS_REG_READ(ah, AR_PHY_PAPRD_CTRL1_B0));</a>
<a name="ln1969">    if (!AR_SREV_POSEIDON(ah) &amp;&amp; !AR_SREV_HORNET(ah) &amp;&amp; !AR_SREV_APHRODITE(ah)) {</a>
<a name="ln1970">        OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln1971">            AR_PHY_PAPRD_CTRL1_B1_PAPRD_POWER_AT_AM2AM_CAL_1,</a>
<a name="ln1972">            AH9300(ah)-&gt;paprd_training_power);</a>
<a name="ln1973">        HALDEBUG(ah, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__,</a>
<a name="ln1974">            __LINE__, (unsigned) AR_PHY_PAPRD_CTRL1_B1,</a>
<a name="ln1975">            OS_REG_READ(ah, AR_PHY_PAPRD_CTRL1_B1));</a>
<a name="ln1976">        if (!AR_SREV_WASP(ah) &amp;&amp; !AR_SREV_JUPITER(ah)) {</a>
<a name="ln1977">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln1978">                AR_PHY_PAPRD_CTRL1_B2_PAPRD_POWER_AT_AM2AM_CAL_2,</a>
<a name="ln1979">                AH9300(ah)-&gt;paprd_training_power);</a>
<a name="ln1980">            HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln1981">                &quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__,</a>
<a name="ln1982">                __LINE__, (unsigned) AR_PHY_PAPRD_CTRL1_B2,</a>
<a name="ln1983">                OS_REG_READ(ah, AR_PHY_PAPRD_CTRL1_B2));</a>
<a name="ln1984">        }</a>
<a name="ln1985">    }</a>
<a name="ln1986">    /*ar9300_enable_paprd(ah, AH_TRUE);*/</a>
<a name="ln1987">}</a>
<a name="ln1988"> </a>
<a name="ln1989">HAL_STATUS ar9300_paprd_setup_gain_table(struct ath_hal *ah, int chain_num)</a>
<a name="ln1990">{</a>
<a name="ln1991">    unsigned int i, desired_gain, gain_index;</a>
<a name="ln1992">    HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln1993">        &quot;Run papredistortion single table algorithm:: Training power = %d\n&quot;,</a>
<a name="ln1994">        AH9300(ah)-&gt;paprd_training_power / 2);</a>
<a name="ln1995"> </a>
<a name="ln1996">    if (AH9300(ah)-&gt;ah_tx_chainmask &amp; (1 &lt;&lt; chain_num)) {</a>
<a name="ln1997">        /* this is an active chain */</a>
<a name="ln1998">        desired_gain = ar9300_get_desired_gain_for_chain(</a>
<a name="ln1999">            ah, chain_num, AH9300(ah)-&gt;paprd_training_power);</a>
<a name="ln2000">        /* find out gain index */</a>
<a name="ln2001">        gain_index = 0;</a>
<a name="ln2002"> </a>
<a name="ln2003">        for (i = 0; i &lt; 32; i++) {</a>
<a name="ln2004">            if (AH9300(ah)-&gt;paprd_gain_table_index[i] &lt; desired_gain) {</a>
<a name="ln2005">                gain_index = gain_index + 1;</a>
<a name="ln2006">            } else {</a>
<a name="ln2007">                break;</a>
<a name="ln2008">            }</a>
<a name="ln2009">        }</a>
<a name="ln2010"> </a>
<a name="ln2011">        /*printf(&quot;gain_index = %d\n&quot;, gain_index);*/</a>
<a name="ln2012">        /*ath_hal_printf(ah, &quot;++++ gain_index = %d\n&quot;, gain_index);*/</a>
<a name="ln2013">        ar9300_tx_force_gain(ah, gain_index);</a>
<a name="ln2014">        if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln2015">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln2016">                AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE, 0);</a>
<a name="ln2017">        } else {</a>
<a name="ln2018">            OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln2019">                AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE, 0);</a>
<a name="ln2020">        }</a>
<a name="ln2021">    }</a>
<a name="ln2022"> </a>
<a name="ln2023">    return HAL_OK;</a>
<a name="ln2024">}</a>
<a name="ln2025"> </a>
<a name="ln2026">static HAL_BOOL ar9300_paprd_retrain_pain(struct ath_hal * ah, int * pa_in)</a>
<a name="ln2027">{</a>
<a name="ln2028">    int count = 0, i;</a>
<a name="ln2029">    int capdiv_offset = 0, quick_drop_offset;</a>
<a name="ln2030">    int capdiv2g, quick_drop;</a>
<a name="ln2031"> </a>
<a name="ln2032">    capdiv2g = (OS_REG_READ(ah, AR_PHY_65NM_CH0_TXRF3) &gt;&gt; 1) &amp; 0xF;</a>
<a name="ln2033">    if (!AR_SREV_POSEIDON(ah)) {</a>
<a name="ln2034">        quick_drop = </a>
<a name="ln2035">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3,</a>
<a name="ln2036">                AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP);</a>
<a name="ln2037">    } else {</a>
<a name="ln2038">        quick_drop = </a>
<a name="ln2039">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON,</a>
<a name="ln2040">                AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP);</a>
<a name="ln2041">    }</a>
<a name="ln2042"> </a>
<a name="ln2043">    if ( quick_drop != 0 ) {</a>
<a name="ln2044">        quick_drop -= 0x40; </a>
<a name="ln2045">    }</a>
<a name="ln2046">    for (i = 0; i &lt; (NUM_BIN + 1); i++) {</a>
<a name="ln2047">        if (pa_in[i] == 1400) {</a>
<a name="ln2048">            count++;</a>
<a name="ln2049">        }            </a>
<a name="ln2050">    }</a>
<a name="ln2051"> </a>
<a name="ln2052">    if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln2053">        if ((pa_in[23] &lt; 800) || (pa_in[23] == 1400)) {</a>
<a name="ln2054">            if (pa_in[23] &lt; 800) {</a>
<a name="ln2055">                capdiv_offset = (int)((1000 - pa_in[23] + 75) / 150);</a>
<a name="ln2056">                capdiv2g = capdiv2g + capdiv_offset;</a>
<a name="ln2057">                if (capdiv2g &gt; 7) {</a>
<a name="ln2058">                    capdiv2g = 7;</a>
<a name="ln2059">                    if (pa_in[23] &lt; 600) {</a>
<a name="ln2060">                        quick_drop = quick_drop + 1;</a>
<a name="ln2061">                        if (quick_drop &gt; 0) {</a>
<a name="ln2062">                            quick_drop = 0;</a>
<a name="ln2063">                        }</a>
<a name="ln2064">                    }</a>
<a name="ln2065">                }</a>
<a name="ln2066">                </a>
<a name="ln2067">                OS_REG_RMW_FIELD(ah, </a>
<a name="ln2068">                    AR_PHY_65NM_CH0_TXRF3, </a>
<a name="ln2069">    			    AR_PHY_65NM_CH0_TXRF3_CAPDIV2G, </a>
<a name="ln2070">    			    capdiv2g);</a>
<a name="ln2071"> </a>
<a name="ln2072">                OS_REG_RMW_FIELD_ALT(ah, </a>
<a name="ln2073">                    AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON, </a>
<a name="ln2074">                    AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, </a>
<a name="ln2075">                    quick_drop);</a>
<a name="ln2076">                </a>
<a name="ln2077">                return AH_TRUE;</a>
<a name="ln2078">            } /* end of if (pa_in[23] &lt; 800) */</a>
<a name="ln2079">            else if (pa_in[23] == 1400) {</a>
<a name="ln2080">                quick_drop_offset = (int)(count / 3);</a>
<a name="ln2081">                if (quick_drop_offset &gt; 2) {</a>
<a name="ln2082">                    quick_drop_offset = 2;</a>
<a name="ln2083">                }</a>
<a name="ln2084">                quick_drop = quick_drop + quick_drop_offset;</a>
<a name="ln2085">                capdiv2g = capdiv2g + (int)(quick_drop_offset / 2); </a>
<a name="ln2086">                if (capdiv2g &gt; 7) {</a>
<a name="ln2087">                    capdiv2g = 7;</a>
<a name="ln2088">                }</a>
<a name="ln2089">                if (quick_drop &gt; 0) {</a>
<a name="ln2090">                    quick_drop = 0;</a>
<a name="ln2091">                    capdiv2g = capdiv2g - (int)(quick_drop_offset / 1);</a>
<a name="ln2092">    				if (capdiv2g &lt; 0) {</a>
<a name="ln2093">                        capdiv2g = 0;</a>
<a name="ln2094">    				}</a>
<a name="ln2095">                }</a>
<a name="ln2096">                OS_REG_RMW_FIELD(ah, </a>
<a name="ln2097">                        AR_PHY_65NM_CH0_TXRF3, </a>
<a name="ln2098">    			        AR_PHY_65NM_CH0_TXRF3_CAPDIV2G, </a>
<a name="ln2099">    			        capdiv2g);</a>
<a name="ln2100"> </a>
<a name="ln2101">                OS_REG_RMW_FIELD_ALT(ah, </a>
<a name="ln2102">                        AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON, </a>
<a name="ln2103">        			    AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, </a>
<a name="ln2104">                        quick_drop);</a>
<a name="ln2105">                </a>
<a name="ln2106">                return AH_TRUE;</a>
<a name="ln2107">                /* sleep(1); */            </a>
<a name="ln2108">            } /* end of if (pa_in[23] == 1400)*/</a>
<a name="ln2109">        } /* end of if ((pa_in[23] &lt; 800) || (pa_in[23] == 1400)) */</a>
<a name="ln2110">    }else if (AR_SREV_HORNET(ah)) {</a>
<a name="ln2111">        if ((pa_in[23] &lt; 1000) || (pa_in[23] == 1400)) {</a>
<a name="ln2112">            if (pa_in[23] &lt; 1000) {</a>
<a name="ln2113">                capdiv_offset = ((1000 - pa_in[23]) / 100);   </a>
<a name="ln2114">                capdiv2g = capdiv2g + capdiv_offset;</a>
<a name="ln2115">                if (capdiv_offset &gt; 3) {</a>
<a name="ln2116">                    quick_drop_offset = 1;</a>
<a name="ln2117">                    quick_drop = quick_drop - quick_drop_offset;</a>
<a name="ln2118">                    capdiv2g = capdiv2g + 1;</a>
<a name="ln2119">                    if (capdiv2g &gt; 6) {</a>
<a name="ln2120">                        capdiv2g = 6;</a>
<a name="ln2121">                    }</a>
<a name="ln2122">                    if (quick_drop &lt; -4) {</a>
<a name="ln2123">                        quick_drop = -4;</a>
<a name="ln2124">                    }</a>
<a name="ln2125">                    OS_REG_RMW_FIELD(ah, </a>
<a name="ln2126">                        AR_PHY_65NM_CH0_TXRF3, </a>
<a name="ln2127">                        AR_PHY_65NM_CH0_TXRF3_CAPDIV2G, </a>
<a name="ln2128">                        capdiv2g);</a>
<a name="ln2129">                    OS_REG_RMW_FIELD_ALT(ah, </a>
<a name="ln2130">                        AR_PHY_PAPRD_TRAINER_CNTL3, </a>
<a name="ln2131">                        AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, </a>
<a name="ln2132">                        quick_drop);</a>
<a name="ln2133">                    return AH_TRUE;</a>
<a name="ln2134">                } else {</a>
<a name="ln2135">                    capdiv2g = capdiv2g + capdiv_offset;</a>
<a name="ln2136">                    if (capdiv2g &gt; 6) {</a>
<a name="ln2137">                        capdiv2g = 6;</a>
<a name="ln2138">                    }</a>
<a name="ln2139">                    if (quick_drop &lt; -4) {</a>
<a name="ln2140">                        quick_drop = -4;</a>
<a name="ln2141">                    }</a>
<a name="ln2142">                    OS_REG_RMW_FIELD(ah, </a>
<a name="ln2143">                        AR_PHY_65NM_CH0_TXRF3, </a>
<a name="ln2144">                        AR_PHY_65NM_CH0_TXRF3_CAPDIV2G, </a>
<a name="ln2145">                        capdiv2g);</a>
<a name="ln2146">                    OS_REG_RMW_FIELD_ALT(ah, </a>
<a name="ln2147">                        AR_PHY_PAPRD_TRAINER_CNTL3, </a>
<a name="ln2148">                        AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, </a>
<a name="ln2149">                        quick_drop);</a>
<a name="ln2150">                    return AH_TRUE;</a>
<a name="ln2151">                }</a>
<a name="ln2152">            } /* end of if (PA_in[23] &lt; 1000) */</a>
<a name="ln2153">            else if (pa_in[23] == 1400) {</a>
<a name="ln2154">                if (count &gt; 3) {</a>
<a name="ln2155">                    quick_drop_offset = 1;</a>
<a name="ln2156">                    quick_drop = quick_drop + quick_drop_offset;</a>
<a name="ln2157">                    capdiv2g = capdiv2g - (count / 4);  </a>
<a name="ln2158">                    if (capdiv2g &lt; 0) {</a>
<a name="ln2159">                        capdiv2g = 0;</a>
<a name="ln2160">                    }</a>
<a name="ln2161">                    if (quick_drop &gt; -2) {</a>
<a name="ln2162">                        quick_drop = -2;</a>
<a name="ln2163">                    }</a>
<a name="ln2164">                    OS_REG_RMW_FIELD(ah, AR_PHY_65NM_CH0_TXRF3, </a>
<a name="ln2165">                        AR_PHY_65NM_CH0_TXRF3_CAPDIV2G, </a>
<a name="ln2166">                        capdiv2g);</a>
<a name="ln2167">                    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3, </a>
<a name="ln2168">                        AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP,</a>
<a name="ln2169">                        quick_drop);</a>
<a name="ln2170">                    return AH_TRUE;</a>
<a name="ln2171">                } else {</a>
<a name="ln2172">                    capdiv2g = capdiv2g - 1;  </a>
<a name="ln2173">                    if (capdiv2g &lt; 0) {</a>
<a name="ln2174">                        capdiv2g = 0;</a>
<a name="ln2175">                    }</a>
<a name="ln2176">                    OS_REG_RMW_FIELD(ah, AR_PHY_65NM_CH0_TXRF3, </a>
<a name="ln2177">                        AR_PHY_65NM_CH0_TXRF3_CAPDIV2G, </a>
<a name="ln2178">                        capdiv2g);</a>
<a name="ln2179">                    OS_REG_RMW_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_CNTL3, </a>
<a name="ln2180">                        AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, </a>
<a name="ln2181">                        quick_drop);</a>
<a name="ln2182">                    return AH_TRUE; </a>
<a name="ln2183">                }</a>
<a name="ln2184">            } /* end of if (PA_in[23] == 1400)*/</a>
<a name="ln2185">        } /* end of if ((PA_in[23] &lt; 1000) || (PA_in[23] == 1400)) */</a>
<a name="ln2186">    }</a>
<a name="ln2187"> </a>
<a name="ln2188">    return AH_FALSE;</a>
<a name="ln2189">}</a>
<a name="ln2190"> </a>
<a name="ln2191">HAL_STATUS ar9300_paprd_create_curve(struct ath_hal * ah,</a>
<a name="ln2192">  struct ieee80211_channel * chan, int chain_num)</a>
<a name="ln2193">{</a>
<a name="ln2194">    int status = 0;</a>
<a name="ln2195">    u_int32_t *pa_table, small_signal_gain;</a>
<a name="ln2196">    int pa_in[NUM_BIN + 1];</a>
<a name="ln2197"> </a>
<a name="ln2198">    if (AH9300(ah)-&gt;ah_tx_chainmask &amp; (1 &lt;&lt; chain_num)) {</a>
<a name="ln2199">        pa_table = &amp;AH9300(ah)-&gt;pa_table[chain_num][0];</a>
<a name="ln2200">        /* Compute PA table and gain index */</a>
<a name="ln2201">        status = ar9300_create_pa_curve(ah, &amp;pa_table[0], &amp;small_signal_gain, </a>
<a name="ln2202">                    &amp;pa_in[0]);</a>
<a name="ln2203"> </a>
<a name="ln2204">		if (AR_SREV_WASP(ah)) {</a>
<a name="ln2205">			OS_DELAY(1000);</a>
<a name="ln2206">		}</a>
<a name="ln2207"> </a>
<a name="ln2208">        if (status != 0) {</a>
<a name="ln2209">            ath_hal_printf(ah, &quot;ERROR:: paprd failed with error code = %d\n&quot;,</a>
<a name="ln2210">                status);</a>
<a name="ln2211">            return -1;</a>
<a name="ln2212">        }</a>
<a name="ln2213">        AH9300(ah)-&gt;small_signal_gain[chain_num] = small_signal_gain;</a>
<a name="ln2214"> </a>
<a name="ln2215">        if (AR_SREV_POSEIDON(ah) || AR_SREV_HORNET(ah)) {</a>
<a name="ln2216">            if (ar9300_paprd_retrain_pain(ah, pa_in)) {</a>
<a name="ln2217">                /* need re-train PAPRD */</a>
<a name="ln2218">                return HAL_EINPROGRESS;</a>
<a name="ln2219">		    }</a>
<a name="ln2220">        }</a>
<a name="ln2221">    }</a>
<a name="ln2222">    return HAL_OK;</a>
<a name="ln2223">}</a>
<a name="ln2224"> </a>
<a name="ln2225">int ar9300_paprd_init_table(struct ath_hal *ah, struct ieee80211_channel * chan)</a>
<a name="ln2226">{</a>
<a name="ln2227">    HAL_CHANNEL_INTERNAL *ichan = ath_hal_checkchannel(ah, chan);</a>
<a name="ln2228"> </a>
<a name="ln2229">    if ((AR_SREV_WASP(ah) &amp;&amp; IS_CHAN_5GHZ(ichan)) ||</a>
<a name="ln2230">         ar9300_paprd_setup_single_table(ah, chan)) {</a>
<a name="ln2231">        goto FAIL;</a>
<a name="ln2232">    }</a>
<a name="ln2233">    OS_MEMZERO(AH9300(ah)-&gt;paprd_gain_table_entries,</a>
<a name="ln2234">        sizeof(AH9300(ah)-&gt;paprd_gain_table_entries));</a>
<a name="ln2235">    OS_MEMZERO(AH9300(ah)-&gt;paprd_gain_table_index,</a>
<a name="ln2236">        sizeof(AH9300(ah)-&gt;paprd_gain_table_index));</a>
<a name="ln2237"> </a>
<a name="ln2238">    ar9300_gain_table_entries(ah);</a>
<a name="ln2239">    return 0;</a>
<a name="ln2240">FAIL:</a>
<a name="ln2241">    return -1;</a>
<a name="ln2242">}</a>
<a name="ln2243"> </a>
<a name="ln2244">int ar9300_paprd_is_done(struct ath_hal *ah)</a>
<a name="ln2245">{</a>
<a name="ln2246">    int temp, agc2_pwr;</a>
<a name="ln2247"> </a>
<a name="ln2248">    /*field_read(&quot;BB_paprd_trainer_stat1.paprd_train_done&quot;, &amp;temp);*/</a>
<a name="ln2249">    if (!AR_SREV_POSEIDON(ah)) {</a>
<a name="ln2250">        temp =</a>
<a name="ln2251">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln2252">                AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);</a>
<a name="ln2253"> </a>
<a name="ln2254">        if (temp == 0x1) {</a>
<a name="ln2255">            agc2_pwr =</a>
<a name="ln2256">                OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1,</a>
<a name="ln2257">                   AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR);</a>
<a name="ln2258"> </a>
<a name="ln2259">            HALDEBUG(ah, HAL_DEBUG_CALIBRATE,</a>
<a name="ln2260">                   &quot;%s AGC2_PWR=0x%2x Training done=0x%2x\n&quot;,</a>
<a name="ln2261">                   __func__, agc2_pwr, temp);</a>
<a name="ln2262"> </a>
<a name="ln2263">            /* Retrain if agc2_pwr is not in ideal range */</a>
<a name="ln2264">            if (agc2_pwr &lt;= AH_PAPRD_IDEAL_AGC2_PWR_RANGE) {</a>
<a name="ln2265">                temp = 0;</a>
<a name="ln2266">            }</a>
<a name="ln2267">		}</a>
<a name="ln2268">    } else {</a>
<a name="ln2269">        temp =</a>
<a name="ln2270">            OS_REG_READ_FIELD_ALT(ah, AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON,</a>
<a name="ln2271">                AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);</a>
<a name="ln2272">    }</a>
<a name="ln2273">    if (!temp) {</a>
<a name="ln2274">        /*ath_hal_printf(ah, &quot;%s[%d] PAPRD TEMp Error\n&quot;, __func__, __LINE__);*/</a>
<a name="ln2275">    }</a>
<a name="ln2276"> </a>
<a name="ln2277">    return temp;</a>
<a name="ln2278">}</a>
<a name="ln2279"> </a>
<a name="ln2280">/*</a>
<a name="ln2281"> * ar9300_paprd_dec_tx_pwr</a>
<a name="ln2282"> *</a>
<a name="ln2283"> * This function do decrease tx power if Paprd is off or train failed.</a>
<a name="ln2284"> */</a>
<a name="ln2285">void </a>
<a name="ln2286">ar9300_paprd_dec_tx_pwr(struct ath_hal *ah)</a>
<a name="ln2287">{</a>
<a name="ln2288">    u_int32_t   pwr_temp, pwr_reg;</a>
<a name="ln2289">    int         i, loop_cnt;</a>
<a name="ln2290">    struct ar9300_paprd_pwr_adjust  *p_item;</a>
<a name="ln2291">    struct ath_hal_9300 *ahp = AH9300(ah);</a>
<a name="ln2292"> </a>
<a name="ln2293">    if (AR_SREV_POSEIDON(ah)) {</a>
<a name="ln2294">        loop_cnt = </a>
<a name="ln2295">        (sizeof(ar9300_paprd_pwr_adj_array) / </a>
<a name="ln2296">            sizeof(struct ar9300_paprd_pwr_adjust));</a>
<a name="ln2297">        for (i = 0; i &lt; loop_cnt; i++ )</a>
<a name="ln2298">        {</a>
<a name="ln2299">            p_item = &amp;ar9300_paprd_pwr_adj_array[i];</a>
<a name="ln2300">            pwr_reg = OS_REG_READ(ah, p_item-&gt;reg_addr);</a>
<a name="ln2301">            pwr_temp = ahp-&gt;ah_default_tx_power[p_item-&gt;target_rate];</a>
<a name="ln2302">            pwr_temp -= (p_item-&gt;sub_db * 2);</a>
<a name="ln2303">            pwr_temp = pwr_temp &lt;&lt; p_item-&gt;reg_mask_offset;</a>
<a name="ln2304">            pwr_temp |= (pwr_reg&amp;~(p_item-&gt;reg_mask &lt;&lt;p_item-&gt;reg_mask_offset));</a>
<a name="ln2305"> </a>
<a name="ln2306">            if (pwr_temp != pwr_reg) </a>
<a name="ln2307">            {</a>
<a name="ln2308">                OS_REG_WRITE(ah, p_item-&gt;reg_addr, pwr_temp);</a>
<a name="ln2309">            }</a>
<a name="ln2310">        }</a>
<a name="ln2311">    }</a>
<a name="ln2312">    return;</a>
<a name="ln2313">}</a>
<a name="ln2314"> </a>
<a name="ln2315">int ar9300_paprd_thermal_send(struct ath_hal *ah)</a>
<a name="ln2316">{</a>
<a name="ln2317">    if (AR_SREV_HORNET(ah)) {</a>
<a name="ln2318">        return OS_REG_READ(ah, AR_TFCNT);</a>
<a name="ln2319">    } else {</a>
<a name="ln2320">        return 1;</a>
<a name="ln2321">    }</a>
<a name="ln2322">}</a>
<a name="ln2323"> </a>
<a name="ln2324">#if 0</a>
<a name="ln2325">void ar9300_paprd_test_prints(struct ath_hal *ah)</a>
<a name="ln2326">{</a>
<a name="ln2327">    u_int32_t i, reg = 0;</a>
<a name="ln2328"> </a>
<a name="ln2329">    HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, &quot;=====ar9300_paprd_test_prints=======\n&quot;);</a>
<a name="ln2330">    /*printf(&quot;=====ar9300_paprd_test_prints=======\n&quot;);*/</a>
<a name="ln2331">    HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, &quot;BB_paprd_ctrl0_b0 = 0x%08x\n&quot;,</a>
<a name="ln2332">        OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B0));</a>
<a name="ln2333">    /*</a>
<a name="ln2334">     * printf(</a>
<a name="ln2335">     *     &quot;BB_paprd_ctrl0_b0 = 0x%08x\n&quot;, </a>
<a name="ln2336">     *     OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B0));</a>
<a name="ln2337">     */</a>
<a name="ln2338">    if (!AR_SREV_POSEIDON(ah) &amp;&amp; !AR_SREV_HORNET(ah)) {</a>
<a name="ln2339">        HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, &quot;BB_paprd_ctrl0_b1 = 0x%08x\n&quot;,</a>
<a name="ln2340">            OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B1));</a>
<a name="ln2341">        /*</a>
<a name="ln2342">         * printf(</a>
<a name="ln2343">         *     &quot;BB_paprd_ctrl0_b1 = 0x%08x\n&quot;, </a>
<a name="ln2344">         *     OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B1));</a>
<a name="ln2345">         */</a>
<a name="ln2346">        HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, &quot;BB_paprd_ctrl0_b2 = 0x%08x\n&quot;,</a>
<a name="ln2347">            OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B2));</a>
<a name="ln2348">        /*</a>
<a name="ln2349">         * printf(</a>
<a name="ln2350">         *     &quot;BB_paprd_ctrl0_b2 = 0x%08x\n&quot;, </a>
<a name="ln2351">         *     OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B2));</a>
<a name="ln2352">         */</a>
<a name="ln2353">    }</a>
<a name="ln2354"> </a>
<a name="ln2355">    reg = AR_PHY_PAPRD_MEM_TAB_B0;</a>
<a name="ln2356">    HALDEBUG(NULL, HAL_DEBUG_CALIBRATE,</a>
<a name="ln2357">        &quot;%s[%d] reg %08lx small_signal_gain ch0 0x%08x\n&quot;, __func__, __LINE__,</a>
<a name="ln2358">        AR_PHY_PA_GAIN123_B0, OS_REG_READ(ah, AR_PHY_PA_GAIN123_B0));</a>
<a name="ln2359">    /*</a>
<a name="ln2360">     * printf(</a>
<a name="ln2361">     *     &quot;%s[%d] reg %08lx small_signal_gain ch0 0x%08x\n&quot;,</a>
<a name="ln2362">     *     __func__,  __LINE__, AR_PHY_PA_GAIN123_B0, </a>
<a name="ln2363">     *     OS_REG_READ(ah, AR_PHY_PA_GAIN123_B0));</a>
<a name="ln2364">     */</a>
<a name="ln2365"> </a>
<a name="ln2366">    for (i = 0; i &lt; 24; i++) {</a>
<a name="ln2367">        HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x = 0x%08x\n&quot;,</a>
<a name="ln2368">            __func__, __LINE__, reg, OS_REG_READ(ah, reg));</a>
<a name="ln2369">        /*</a>
<a name="ln2370">         * printf(</a>
<a name="ln2371">         *     &quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__, __LINE__,</a>
<a name="ln2372">         *     reg, OS_REG_READ(ah, reg));</a>
<a name="ln2373">         */</a>
<a name="ln2374">        reg = reg + 4;</a>
<a name="ln2375">    }</a>
<a name="ln2376"> </a>
<a name="ln2377">    ar9300_paprd_debug_print(ah);</a>
<a name="ln2378">    HALDEBUG(NULL, HAL_DEBUG_CALIBRATE,</a>
<a name="ln2379">        &quot;=====ar9300_paprd_test_prints end=======\n&quot;);</a>
<a name="ln2380">    /*printf(&quot;=====ar9300_paprd_test_prints end=======\n&quot;);*/</a>
<a name="ln2381"> </a>
<a name="ln2382">    if (!AR_SREV_POSEIDON(ah)) {</a>
<a name="ln2383">        reg = AR_PHY_PAPRD_MEM_TAB_B1;</a>
<a name="ln2384">        printf(&quot;%s[%d] reg %08lx small_signal_gain ch1 0x%08x\n&quot;,</a>
<a name="ln2385">            __func__, __LINE__,</a>
<a name="ln2386">            AR_PHY_PA_GAIN123_B1, OS_REG_READ(ah, AR_PHY_PA_GAIN123_B1));</a>
<a name="ln2387">        for (i = 0; i &lt; 24; i++) {</a>
<a name="ln2388">            OS_REG_WRITE(ah, reg, paprd_table_val[i]);</a>
<a name="ln2389">            HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, &quot;%s[%d] reg %08x = 0x%08x\n&quot;,</a>
<a name="ln2390">                __func__, __LINE__, reg, OS_REG_READ(ah, reg));</a>
<a name="ln2391">            printf(&quot;%s[%d] reg %08x = 0x%08x\n&quot;, __func__, __LINE__, reg,</a>
<a name="ln2392">                OS_REG_READ(ah, reg));</a>
<a name="ln2393">            reg = reg + 4;</a>
<a name="ln2394">        }</a>
<a name="ln2395">    </a>
<a name="ln2396">        reg = AR_PHY_PAPRD_MEM_TAB_B2;</a>
<a name="ln2397">        printf(&quot;%s[%d] reg %08lx small_signal_gain ch2 0x%08x\n&quot;,</a>
<a name="ln2398">            __func__, __LINE__,</a>
<a name="ln2399">            AR_PHY_PA_GAIN123_B2, OS_REG_READ(ah, AR_PHY_PA_GAIN123_B2));</a>
<a name="ln2400">    }</a>
<a name="ln2401">}</a>
<a name="ln2402">#endif</a>
<a name="ln2403"> </a>
<a name="ln2404">#else</a>
<a name="ln2405">int</a>
<a name="ln2406">ar9300_paprd_init_table(struct ath_hal *ah, HAL_CHANNEL * chan)</a>
<a name="ln2407">{</a>
<a name="ln2408">    return 0;</a>
<a name="ln2409">}</a>
<a name="ln2410"> </a>
<a name="ln2411">HAL_STATUS</a>
<a name="ln2412">ar9300_paprd_setup_gain_table(struct ath_hal * ah, int chain_num)</a>
<a name="ln2413">{</a>
<a name="ln2414">    return HAL_OK;</a>
<a name="ln2415">}</a>
<a name="ln2416"> </a>
<a name="ln2417">HAL_STATUS</a>
<a name="ln2418">ar9300_paprd_create_curve(struct ath_hal * ah, HAL_CHANNEL * chan,</a>
<a name="ln2419">    int chain_num)</a>
<a name="ln2420">{</a>
<a name="ln2421">    return HAL_OK;</a>
<a name="ln2422">}</a>
<a name="ln2423"> </a>
<a name="ln2424">int</a>
<a name="ln2425">ar9300_paprd_is_done(struct ath_hal *ah)</a>
<a name="ln2426">{</a>
<a name="ln2427">    return 0;</a>
<a name="ln2428">}</a>
<a name="ln2429"> </a>
<a name="ln2430">void</a>
<a name="ln2431">ar9300_enable_paprd(struct ath_hal *ah, HAL_BOOL enable_flag, HAL_CHANNEL * chan)</a>
<a name="ln2432">{</a>
<a name="ln2433">    return;</a>
<a name="ln2434">}</a>
<a name="ln2435"> </a>
<a name="ln2436">void</a>
<a name="ln2437">ar9300_populate_paprd_single_table(struct ath_hal *ah, HAL_CHANNEL * chan,</a>
<a name="ln2438">    int chain_num)</a>
<a name="ln2439">{</a>
<a name="ln2440">    return;</a>
<a name="ln2441">}</a>
<a name="ln2442"> </a>
<a name="ln2443">void </a>
<a name="ln2444">ar9300_paprd_dec_tx_pwr(struct ath_hal *ah)</a>
<a name="ln2445">{</a>
<a name="ln2446">    return;</a>
<a name="ln2447">}</a>
<a name="ln2448"> </a>
<a name="ln2449">int ar9300_paprd_thermal_send(struct ath_hal *ah)</a>
<a name="ln2450">{</a>
<a name="ln2451">    return 1;</a>
<a name="ln2452">}</a>
<a name="ln2453">#endif                          /* ATH_SUPPORT_PAPRD */</a>

</code></pre>
<div class="balloon" rel="366"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v610/" target="_blank">V610</a> Undefined behavior. Check the shift operator '<<'. The left operand '(- 15)' is negative.</p></div>
<div class="balloon" rel="1528"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v634/" target="_blank">V634</a> The priority of the '*' operation is higher than that of the '<<' operation. It's possible that parentheses should be used in the expression.</p></div>
<div class="balloon" rel="1554"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v634/" target="_blank">V634</a> The priority of the '*' operation is higher than that of the '<<' operation. It's possible that parentheses should be used in the expression.</p></div>
<div class="balloon" rel="371"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v610/" target="_blank">V610</a> Undefined behavior. Check the shift operator '<<'. The left operand '(- 10)' is negative.</p></div>
<div class="balloon" rel="358"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v610/" target="_blank">V610</a> Undefined behavior. Check the shift operator '<<'. The left operand '(- 6)' is negative.</p></div>
<div class="balloon" rel="355"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v610/" target="_blank">V610</a> Undefined behavior. Check the shift operator '<<'. The left operand '(- 3)' is negative.</p></div>
<div class="balloon" rel="305"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v610/" target="_blank">V610</a> Undefined behavior. Check the shift operator '<<'. The left operand '(- 15)' is negative.</p></div>
<div class="balloon" rel="303"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v610/" target="_blank">V610</a> Undefined behavior. Check the shift operator '<<'. The left operand '(- 3)' is negative.</p></div>
<div class="balloon" rel="363"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v610/" target="_blank">V610</a> Undefined behavior. Check the shift operator '<<'. The left operand '(- 10)' is negative.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
