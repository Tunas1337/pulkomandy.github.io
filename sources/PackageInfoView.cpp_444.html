
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>PackageInfoView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2013-2014, Stephan AÃŸmus &lt;superstippi@gmx.de&gt;.</a>
<a name="ln3"> * Copyright 2018-2019, Andrew Lindesay &lt;apl@lindesay.co.nz&gt;.</a>
<a name="ln4"> * All rights reserved. Distributed under the terms of the MIT License.</a>
<a name="ln5"> */</a>
<a name="ln6"> </a>
<a name="ln7">#include &quot;PackageInfoView.h&quot;</a>
<a name="ln8"> </a>
<a name="ln9">#include &lt;algorithm&gt;</a>
<a name="ln10">#include &lt;stdio.h&gt;</a>
<a name="ln11"> </a>
<a name="ln12">#include &lt;Alert.h&gt;</a>
<a name="ln13">#include &lt;Autolock.h&gt;</a>
<a name="ln14">#include &lt;Bitmap.h&gt;</a>
<a name="ln15">#include &lt;Button.h&gt;</a>
<a name="ln16">#include &lt;CardLayout.h&gt;</a>
<a name="ln17">#include &lt;Catalog.h&gt;</a>
<a name="ln18">#include &lt;ColumnListView.h&gt;</a>
<a name="ln19">#include &lt;DateFormat.h&gt;</a>
<a name="ln20">#include &lt;Font.h&gt;</a>
<a name="ln21">#include &lt;GridView.h&gt;</a>
<a name="ln22">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln23">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln24">#include &lt;LocaleRoster.h&gt;</a>
<a name="ln25">#include &lt;Message.h&gt;</a>
<a name="ln26">#include &lt;OutlineListView.h&gt;</a>
<a name="ln27">#include &lt;ScrollView.h&gt;</a>
<a name="ln28">#include &lt;SpaceLayoutItem.h&gt;</a>
<a name="ln29">#include &lt;StatusBar.h&gt;</a>
<a name="ln30">#include &lt;StringView.h&gt;</a>
<a name="ln31">#include &lt;TabView.h&gt;</a>
<a name="ln32">#include &lt;Url.h&gt;</a>
<a name="ln33"> </a>
<a name="ln34">#include &lt;package/hpkg/PackageReader.h&gt;</a>
<a name="ln35">#include &lt;package/hpkg/NoErrorOutput.h&gt;</a>
<a name="ln36">#include &lt;package/hpkg/PackageContentHandler.h&gt;</a>
<a name="ln37">#include &lt;package/hpkg/PackageEntry.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39">#include &quot;BitmapView.h&quot;</a>
<a name="ln40">#include &quot;LinkView.h&quot;</a>
<a name="ln41">#include &quot;LinkedBitmapView.h&quot;</a>
<a name="ln42">#include &quot;MarkupTextView.h&quot;</a>
<a name="ln43">#include &quot;MessagePackageListener.h&quot;</a>
<a name="ln44">#include &quot;PackageActionHandler.h&quot;</a>
<a name="ln45">#include &quot;PackageContentsView.h&quot;</a>
<a name="ln46">#include &quot;PackageInfo.h&quot;</a>
<a name="ln47">#include &quot;PackageManager.h&quot;</a>
<a name="ln48">#include &quot;RatingView.h&quot;</a>
<a name="ln49">#include &quot;ScrollableGroupView.h&quot;</a>
<a name="ln50">#include &quot;TextView.h&quot;</a>
<a name="ln51"> </a>
<a name="ln52"> </a>
<a name="ln53">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln54">#define B_TRANSLATION_CONTEXT &quot;PackageInfoView&quot;</a>
<a name="ln55"> </a>
<a name="ln56"> </a>
<a name="ln57">static const rgb_color kLightBlack = (rgb_color) { 60, 60, 60, 255 };</a>
<a name="ln58">static const float kContentTint = (B_NO_TINT + B_LIGHTEN_1_TINT) / 2.0f;</a>
<a name="ln59"> </a>
<a name="ln60"> </a>
<a name="ln61">//! Layouts the scrollbar so it looks nice with no border and the document</a>
<a name="ln62">// window look.</a>
<a name="ln63">class CustomScrollView : public BScrollView {</a>
<a name="ln64">public:</a>
<a name="ln65">	CustomScrollView(const char* name, BView* target)</a>
<a name="ln66">		:</a>
<a name="ln67">		BScrollView(name, target, 0, false, true, B_NO_BORDER)</a>
<a name="ln68">	{</a>
<a name="ln69">	}</a>
<a name="ln70"> </a>
<a name="ln71">	virtual void DoLayout()</a>
<a name="ln72">	{</a>
<a name="ln73">		BRect innerFrame = Bounds();</a>
<a name="ln74">		innerFrame.right -= B_V_SCROLL_BAR_WIDTH + 1;</a>
<a name="ln75"> </a>
<a name="ln76">		BView* target = Target();</a>
<a name="ln77">		if (target != NULL) {</a>
<a name="ln78">			Target()-&gt;MoveTo(innerFrame.left, innerFrame.top);</a>
<a name="ln79">			Target()-&gt;ResizeTo(innerFrame.Width(), innerFrame.Height());</a>
<a name="ln80">		}</a>
<a name="ln81"> </a>
<a name="ln82">		BScrollBar* scrollBar = ScrollBar(B_VERTICAL);</a>
<a name="ln83">		if (scrollBar != NULL) {</a>
<a name="ln84">			BRect rect = innerFrame;</a>
<a name="ln85">			rect.left = rect.right + 1;</a>
<a name="ln86">			rect.right = rect.left + B_V_SCROLL_BAR_WIDTH;</a>
<a name="ln87">			rect.bottom -= B_H_SCROLL_BAR_HEIGHT;</a>
<a name="ln88"> </a>
<a name="ln89">			scrollBar-&gt;MoveTo(rect.left, rect.top);</a>
<a name="ln90">			scrollBar-&gt;ResizeTo(rect.Width(), rect.Height());</a>
<a name="ln91">		}</a>
<a name="ln92">	}</a>
<a name="ln93">};</a>
<a name="ln94"> </a>
<a name="ln95"> </a>
<a name="ln96">class RatingsScrollView : public CustomScrollView {</a>
<a name="ln97">public:</a>
<a name="ln98">	RatingsScrollView(const char* name, BView* target)</a>
<a name="ln99">		:</a>
<a name="ln100">		CustomScrollView(name, target)</a>
<a name="ln101">	{</a>
<a name="ln102">	}</a>
<a name="ln103"> </a>
<a name="ln104">	virtual void DoLayout()</a>
<a name="ln105">	{</a>
<a name="ln106">		CustomScrollView::DoLayout();</a>
<a name="ln107"> </a>
<a name="ln108">		BScrollBar* scrollBar = ScrollBar(B_VERTICAL);</a>
<a name="ln109">		BView* target = Target();</a>
<a name="ln110">		if (target != NULL &amp;&amp; scrollBar != NULL) {</a>
<a name="ln111">			// Set the scroll steps</a>
<a name="ln112">			BView* item = target-&gt;ChildAt(0);</a>
<a name="ln113">			if (item != NULL) {</a>
<a name="ln114">				scrollBar-&gt;SetSteps(item-&gt;MinSize().height + 1,</a>
<a name="ln115">					item-&gt;MinSize().height + 1);</a>
<a name="ln116">			}</a>
<a name="ln117">		}</a>
<a name="ln118">	}</a>
<a name="ln119">};</a>
<a name="ln120"> </a>
<a name="ln121"> </a>
<a name="ln122">// #pragma mark - rating stats</a>
<a name="ln123"> </a>
<a name="ln124"> </a>
<a name="ln125">class DiagramBarView : public BView {</a>
<a name="ln126">public:</a>
<a name="ln127">	DiagramBarView()</a>
<a name="ln128">		:</a>
<a name="ln129">		BView(&quot;diagram bar view&quot;, B_WILL_DRAW),</a>
<a name="ln130">		fValue(0.0f)</a>
<a name="ln131">	{</a>
<a name="ln132">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, kContentTint);</a>
<a name="ln133">		SetHighUIColor(B_CONTROL_MARK_COLOR);</a>
<a name="ln134">	}</a>
<a name="ln135"> </a>
<a name="ln136">	virtual ~DiagramBarView()</a>
<a name="ln137">	{</a>
<a name="ln138">	}</a>
<a name="ln139"> </a>
<a name="ln140">	virtual void AttachedToWindow()</a>
<a name="ln141">	{</a>
<a name="ln142">	}</a>
<a name="ln143"> </a>
<a name="ln144">	virtual void Draw(BRect updateRect)</a>
<a name="ln145">	{</a>
<a name="ln146">		FillRect(updateRect, B_SOLID_LOW);</a>
<a name="ln147"> </a>
<a name="ln148">		if (fValue &lt;= 0.0f)</a>
<a name="ln149">			return;</a>
<a name="ln150"> </a>
<a name="ln151">		BRect rect(Bounds());</a>
<a name="ln152">		rect.right = ceilf(rect.left + fValue * rect.Width());</a>
<a name="ln153"> </a>
<a name="ln154">		FillRect(rect, B_SOLID_HIGH);</a>
<a name="ln155">	}</a>
<a name="ln156"> </a>
<a name="ln157">	virtual BSize MinSize()</a>
<a name="ln158">	{</a>
<a name="ln159">		return BSize(64, 10);</a>
<a name="ln160">	}</a>
<a name="ln161"> </a>
<a name="ln162">	virtual BSize PreferredSize()</a>
<a name="ln163">	{</a>
<a name="ln164">		return MinSize();</a>
<a name="ln165">	}</a>
<a name="ln166"> </a>
<a name="ln167">	virtual BSize MaxSize()</a>
<a name="ln168">	{</a>
<a name="ln169">		return BSize(64, 10);</a>
<a name="ln170">	}</a>
<a name="ln171"> </a>
<a name="ln172">	void SetValue(float value)</a>
<a name="ln173">	{</a>
<a name="ln174">		if (fValue != value) {</a>
<a name="ln175">			fValue = value;</a>
<a name="ln176">			Invalidate();</a>
<a name="ln177">		}</a>
<a name="ln178">	}</a>
<a name="ln179"> </a>
<a name="ln180">private:</a>
<a name="ln181">	float			fValue;</a>
<a name="ln182">};</a>
<a name="ln183"> </a>
<a name="ln184"> </a>
<a name="ln185">// #pragma mark - TitleView</a>
<a name="ln186"> </a>
<a name="ln187"> </a>
<a name="ln188">enum {</a>
<a name="ln189">	MSG_PACKAGE_ACTION			= 'pkga',</a>
<a name="ln190">	MSG_MOUSE_ENTERED_RATING	= 'menr',</a>
<a name="ln191">	MSG_MOUSE_EXITED_RATING		= 'mexr',</a>
<a name="ln192">};</a>
<a name="ln193"> </a>
<a name="ln194"> </a>
<a name="ln195">class TransitReportingButton : public BButton {</a>
<a name="ln196">public:</a>
<a name="ln197">	TransitReportingButton(const char* name, const char* label,</a>
<a name="ln198">			BMessage* message)</a>
<a name="ln199">		:</a>
<a name="ln200">		BButton(name, label, message),</a>
<a name="ln201">		fTransitMessage(NULL)</a>
<a name="ln202">	{</a>
<a name="ln203">	}</a>
<a name="ln204"> </a>
<a name="ln205">	virtual ~TransitReportingButton()</a>
<a name="ln206">	{</a>
<a name="ln207">		SetTransitMessage(NULL);</a>
<a name="ln208">	}</a>
<a name="ln209"> </a>
<a name="ln210">	virtual void MouseMoved(BPoint point, uint32 transit,</a>
<a name="ln211">		const BMessage* dragMessage)</a>
<a name="ln212">	{</a>
<a name="ln213">		BButton::MouseMoved(point, transit, dragMessage);</a>
<a name="ln214"> </a>
<a name="ln215">		if (fTransitMessage != NULL &amp;&amp; transit == B_EXITED_VIEW)</a>
<a name="ln216">			Invoke(fTransitMessage);</a>
<a name="ln217">	}</a>
<a name="ln218"> </a>
<a name="ln219">	void SetTransitMessage(BMessage* message)</a>
<a name="ln220">	{</a>
<a name="ln221">		if (fTransitMessage != message) {</a>
<a name="ln222">			delete fTransitMessage;</a>
<a name="ln223">			fTransitMessage = message;</a>
<a name="ln224">		}</a>
<a name="ln225">	}</a>
<a name="ln226"> </a>
<a name="ln227">private:</a>
<a name="ln228">	BMessage*	fTransitMessage;</a>
<a name="ln229">};</a>
<a name="ln230"> </a>
<a name="ln231"> </a>
<a name="ln232">class TransitReportingRatingView : public RatingView, public BInvoker {</a>
<a name="ln233">public:</a>
<a name="ln234">	TransitReportingRatingView(BMessage* transitMessage)</a>
<a name="ln235">		:</a>
<a name="ln236">		RatingView(&quot;package rating view&quot;),</a>
<a name="ln237">		fTransitMessage(transitMessage)</a>
<a name="ln238">	{</a>
<a name="ln239">	}</a>
<a name="ln240"> </a>
<a name="ln241">	virtual ~TransitReportingRatingView()</a>
<a name="ln242">	{</a>
<a name="ln243">		delete fTransitMessage;</a>
<a name="ln244">	}</a>
<a name="ln245"> </a>
<a name="ln246">	virtual void MouseMoved(BPoint point, uint32 transit,</a>
<a name="ln247">		const BMessage* dragMessage)</a>
<a name="ln248">	{</a>
<a name="ln249">		RatingView::MouseMoved(point, transit, dragMessage);</a>
<a name="ln250"> </a>
<a name="ln251">		if (fTransitMessage != NULL &amp;&amp; transit == B_ENTERED_VIEW)</a>
<a name="ln252">			Invoke(fTransitMessage);</a>
<a name="ln253">	}</a>
<a name="ln254"> </a>
<a name="ln255">private:</a>
<a name="ln256">	BMessage*	fTransitMessage;</a>
<a name="ln257">};</a>
<a name="ln258"> </a>
<a name="ln259"> </a>
<a name="ln260">class TitleView : public BGroupView {</a>
<a name="ln261">public:</a>
<a name="ln262">	TitleView()</a>
<a name="ln263">		:</a>
<a name="ln264">		BGroupView(&quot;title view&quot;, B_HORIZONTAL)</a>
<a name="ln265">	{</a>
<a name="ln266">		fIconView = new BitmapView(&quot;package icon view&quot;);</a>
<a name="ln267">		fTitleView = new BStringView(&quot;package title view&quot;, &quot;&quot;);</a>
<a name="ln268">		fPublisherView = new BStringView(&quot;package publisher view&quot;, &quot;&quot;);</a>
<a name="ln269"> </a>
<a name="ln270">		// Title font</a>
<a name="ln271">		BFont font;</a>
<a name="ln272">		GetFont(&amp;font);</a>
<a name="ln273">		font_family family;</a>
<a name="ln274">		font_style style;</a>
<a name="ln275">		font.SetSize(ceilf(font.Size() * 1.5f));</a>
<a name="ln276">		font.GetFamilyAndStyle(&amp;family, &amp;style);</a>
<a name="ln277">		font.SetFamilyAndStyle(family, &quot;Bold&quot;);</a>
<a name="ln278">		fTitleView-&gt;SetFont(&amp;font);</a>
<a name="ln279"> </a>
<a name="ln280">		// Publisher font</a>
<a name="ln281">		GetFont(&amp;font);</a>
<a name="ln282">		font.SetSize(std::max(9.0f, floorf(font.Size() * 0.92f)));</a>
<a name="ln283">		font.SetFamilyAndStyle(family, &quot;Italic&quot;);</a>
<a name="ln284">		fPublisherView-&gt;SetFont(&amp;font);</a>
<a name="ln285">		fPublisherView-&gt;SetHighColor(kLightBlack);</a>
<a name="ln286"> </a>
<a name="ln287">		// slightly bigger font</a>
<a name="ln288">		GetFont(&amp;font);</a>
<a name="ln289">		font.SetSize(ceilf(font.Size() * 1.2f));</a>
<a name="ln290"> </a>
<a name="ln291">		// Version info</a>
<a name="ln292">		fVersionInfo = new BStringView(&quot;package version info&quot;, &quot;&quot;);</a>
<a name="ln293">		fVersionInfo-&gt;SetFont(&amp;font);</a>
<a name="ln294">		fVersionInfo-&gt;SetHighColor(kLightBlack);</a>
<a name="ln295"> </a>
<a name="ln296">		// Rating view</a>
<a name="ln297">		fRatingView = new TransitReportingRatingView(</a>
<a name="ln298">			new BMessage(MSG_MOUSE_ENTERED_RATING));</a>
<a name="ln299"> </a>
<a name="ln300">		fAvgRating = new BStringView(&quot;package average rating&quot;, &quot;&quot;);</a>
<a name="ln301">		fAvgRating-&gt;SetFont(&amp;font);</a>
<a name="ln302">		fAvgRating-&gt;SetHighColor(kLightBlack);</a>
<a name="ln303"> </a>
<a name="ln304">		fVoteInfo = new BStringView(&quot;package vote info&quot;, &quot;&quot;);</a>
<a name="ln305">		// small font</a>
<a name="ln306">		GetFont(&amp;font);</a>
<a name="ln307">		font.SetSize(std::max(9.0f, floorf(font.Size() * 0.85f)));</a>
<a name="ln308">		fVoteInfo-&gt;SetFont(&amp;font);</a>
<a name="ln309">		fVoteInfo-&gt;SetHighColor(kLightBlack);</a>
<a name="ln310"> </a>
<a name="ln311">		// Rate button</a>
<a name="ln312">		fRateButton = new TransitReportingButton(&quot;rate&quot;,</a>
<a name="ln313">			B_TRANSLATE(&quot;Rate package&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln314">			new BMessage(MSG_RATE_PACKAGE));</a>
<a name="ln315">		fRateButton-&gt;SetTransitMessage(new BMessage(MSG_MOUSE_EXITED_RATING));</a>
<a name="ln316">		fRateButton-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln317">			B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln318"> </a>
<a name="ln319">		// Rating group</a>
<a name="ln320">		BView* ratingStack = new BView(&quot;rating stack&quot;, 0);</a>
<a name="ln321">		fRatingLayout = new BCardLayout();</a>
<a name="ln322">		ratingStack-&gt;SetLayout(fRatingLayout);</a>
<a name="ln323">		ratingStack-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln324">		ratingStack-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln325"> </a>
<a name="ln326">		BGroupView* ratingGroup = new BGroupView(B_HORIZONTAL,</a>
<a name="ln327">			B_USE_SMALL_SPACING);</a>
<a name="ln328">		BLayoutBuilder::Group&lt;&gt;(ratingGroup)</a>
<a name="ln329">			.Add(fRatingView)</a>
<a name="ln330">			.Add(fAvgRating)</a>
<a name="ln331">			.Add(fVoteInfo)</a>
<a name="ln332">		;</a>
<a name="ln333"> </a>
<a name="ln334">		ratingStack-&gt;AddChild(ratingGroup);</a>
<a name="ln335">		ratingStack-&gt;AddChild(fRateButton);</a>
<a name="ln336">		fRatingLayout-&gt;SetVisibleItem((int32)0);</a>
<a name="ln337"> </a>
<a name="ln338">		BLayoutBuilder::Group&lt;&gt;(this)</a>
<a name="ln339">			.Add(fIconView)</a>
<a name="ln340">			.AddGroup(B_VERTICAL, 1.0f, 2.2f)</a>
<a name="ln341">				.Add(fTitleView)</a>
<a name="ln342">				.Add(fPublisherView)</a>
<a name="ln343">				.SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET))</a>
<a name="ln344">			.End()</a>
<a name="ln345">			.AddGlue(0.1f)</a>
<a name="ln346">			.Add(ratingStack, 0.8f)</a>
<a name="ln347">			.AddGlue(0.2f)</a>
<a name="ln348">			.AddGroup(B_HORIZONTAL, B_USE_SMALL_SPACING, 2.0f)</a>
<a name="ln349">				.Add(fVersionInfo)</a>
<a name="ln350">				.AddGlue()</a>
<a name="ln351">				.SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET))</a>
<a name="ln352">			.End()</a>
<a name="ln353">		;</a>
<a name="ln354"> </a>
<a name="ln355">		Clear();</a>
<a name="ln356">	}</a>
<a name="ln357"> </a>
<a name="ln358">	virtual ~TitleView()</a>
<a name="ln359">	{</a>
<a name="ln360">	}</a>
<a name="ln361"> </a>
<a name="ln362">	virtual void AttachedToWindow()</a>
<a name="ln363">	{</a>
<a name="ln364">		fRateButton-&gt;SetTarget(this);</a>
<a name="ln365">		fRatingView-&gt;SetTarget(this);</a>
<a name="ln366">	}</a>
<a name="ln367"> </a>
<a name="ln368">	virtual void MessageReceived(BMessage* message)</a>
<a name="ln369">	{</a>
<a name="ln370">		switch (message-&gt;what) {</a>
<a name="ln371">			case MSG_RATE_PACKAGE:</a>
<a name="ln372">				// Forward to window (The button has us as target so</a>
<a name="ln373">				// we receive the message below.)</a>
<a name="ln374">				Window()-&gt;PostMessage(MSG_RATE_PACKAGE);</a>
<a name="ln375">				break;</a>
<a name="ln376"> </a>
<a name="ln377">			case MSG_MOUSE_ENTERED_RATING:</a>
<a name="ln378">				fRatingLayout-&gt;SetVisibleItem(1);</a>
<a name="ln379">				break;</a>
<a name="ln380"> </a>
<a name="ln381">			case MSG_MOUSE_EXITED_RATING:</a>
<a name="ln382">				fRatingLayout-&gt;SetVisibleItem((int32)0);</a>
<a name="ln383">				break;</a>
<a name="ln384">		}</a>
<a name="ln385">	}</a>
<a name="ln386"> </a>
<a name="ln387">	void SetPackage(const PackageInfo&amp; package)</a>
<a name="ln388">	{</a>
<a name="ln389">		if (package.Icon().Get() != NULL)</a>
<a name="ln390">			fIconView-&gt;SetBitmap(package.Icon(), SharedBitmap::SIZE_32);</a>
<a name="ln391">		else</a>
<a name="ln392">			fIconView-&gt;UnsetBitmap();</a>
<a name="ln393"> </a>
<a name="ln394">		fTitleView-&gt;SetText(package.Title());</a>
<a name="ln395"> </a>
<a name="ln396">		BString publisher = package.Publisher().Name();</a>
<a name="ln397">		if (publisher.CountChars() &gt; 45) {</a>
<a name="ln398">			fPublisherView-&gt;SetToolTip(publisher);</a>
<a name="ln399">			fPublisherView-&gt;SetText(publisher.TruncateChars(45)</a>
<a name="ln400">				.Append(B_UTF8_ELLIPSIS));</a>
<a name="ln401">		} else</a>
<a name="ln402">			fPublisherView-&gt;SetText(publisher);</a>
<a name="ln403"> </a>
<a name="ln404">		BString version = B_TRANSLATE(&quot;%Version%&quot;);</a>
<a name="ln405">		version.ReplaceAll(&quot;%Version%&quot;, package.Version().ToString());</a>
<a name="ln406">		fVersionInfo-&gt;SetText(version);</a>
<a name="ln407"> </a>
<a name="ln408">		RatingSummary ratingSummary = package.CalculateRatingSummary();</a>
<a name="ln409"> </a>
<a name="ln410">		fRatingView-&gt;SetRating(ratingSummary.averageRating);</a>
<a name="ln411"> </a>
<a name="ln412">		if (ratingSummary.ratingCount &gt; 0) {</a>
<a name="ln413">			BString avgRating;</a>
<a name="ln414">			avgRating.SetToFormat(&quot;%.1f&quot;, ratingSummary.averageRating);</a>
<a name="ln415">			fAvgRating-&gt;SetText(avgRating);</a>
<a name="ln416"> </a>
<a name="ln417">			BString votes;</a>
<a name="ln418">			votes.SetToFormat(&quot;%d&quot;, ratingSummary.ratingCount);</a>
<a name="ln419"> </a>
<a name="ln420">			BString voteInfo(B_TRANSLATE(&quot;(%Votes%)&quot;));</a>
<a name="ln421">			voteInfo.ReplaceAll(&quot;%Votes%&quot;, votes);</a>
<a name="ln422"> </a>
<a name="ln423">			fVoteInfo-&gt;SetText(voteInfo);</a>
<a name="ln424">		} else {</a>
<a name="ln425">			fAvgRating-&gt;SetText(&quot;&quot;);</a>
<a name="ln426">			fVoteInfo-&gt;SetText(B_TRANSLATE(&quot;n/a&quot;));</a>
<a name="ln427">		}</a>
<a name="ln428"> </a>
<a name="ln429">		InvalidateLayout();</a>
<a name="ln430">		Invalidate();</a>
<a name="ln431">	}</a>
<a name="ln432"> </a>
<a name="ln433">	void Clear()</a>
<a name="ln434">	{</a>
<a name="ln435">		fIconView-&gt;UnsetBitmap();</a>
<a name="ln436">		fTitleView-&gt;SetText(&quot;&quot;);</a>
<a name="ln437">		fPublisherView-&gt;SetText(&quot;&quot;);</a>
<a name="ln438">		fVersionInfo-&gt;SetText(&quot;&quot;);</a>
<a name="ln439">		fRatingView-&gt;SetRating(-1.0f);</a>
<a name="ln440">		fAvgRating-&gt;SetText(&quot;&quot;);</a>
<a name="ln441">		fVoteInfo-&gt;SetText(&quot;&quot;);</a>
<a name="ln442">	}</a>
<a name="ln443"> </a>
<a name="ln444">private:</a>
<a name="ln445">	BitmapView*						fIconView;</a>
<a name="ln446"> </a>
<a name="ln447">	BStringView*					fTitleView;</a>
<a name="ln448">	BStringView*					fPublisherView;</a>
<a name="ln449"> </a>
<a name="ln450">	BStringView*					fVersionInfo;</a>
<a name="ln451"> </a>
<a name="ln452">	BCardLayout*					fRatingLayout;</a>
<a name="ln453"> </a>
<a name="ln454">	TransitReportingRatingView*		fRatingView;</a>
<a name="ln455">	BStringView*					fAvgRating;</a>
<a name="ln456">	BStringView*					fVoteInfo;</a>
<a name="ln457"> </a>
<a name="ln458">	TransitReportingButton*			fRateButton;</a>
<a name="ln459">};</a>
<a name="ln460"> </a>
<a name="ln461"> </a>
<a name="ln462">// #pragma mark - PackageActionView</a>
<a name="ln463"> </a>
<a name="ln464"> </a>
<a name="ln465">class PackageActionView : public BView {</a>
<a name="ln466">public:</a>
<a name="ln467">	PackageActionView(PackageActionHandler* handler)</a>
<a name="ln468">		:</a>
<a name="ln469">		BView(&quot;about view&quot;, B_WILL_DRAW),</a>
<a name="ln470">		fLayout(new BGroupLayout(B_HORIZONTAL)),</a>
<a name="ln471">		fPackageActionHandler(handler),</a>
<a name="ln472">		fStatusLabel(NULL),</a>
<a name="ln473">		fStatusBar(NULL)</a>
<a name="ln474">	{</a>
<a name="ln475">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln476"> </a>
<a name="ln477">		SetLayout(fLayout);</a>
<a name="ln478">		fLayout-&gt;AddItem(BSpaceLayoutItem::CreateGlue());</a>
<a name="ln479">	}</a>
<a name="ln480"> </a>
<a name="ln481">	virtual ~PackageActionView()</a>
<a name="ln482">	{</a>
<a name="ln483">		Clear();</a>
<a name="ln484">	}</a>
<a name="ln485"> </a>
<a name="ln486">	virtual void MessageReceived(BMessage* message)</a>
<a name="ln487">	{</a>
<a name="ln488">		switch (message-&gt;what) {</a>
<a name="ln489">			case MSG_PACKAGE_ACTION:</a>
<a name="ln490">				_RunPackageAction(message);</a>
<a name="ln491">				break;</a>
<a name="ln492"> </a>
<a name="ln493">			default:</a>
<a name="ln494">				BView::MessageReceived(message);</a>
<a name="ln495">				break;</a>
<a name="ln496">		}</a>
<a name="ln497">	}</a>
<a name="ln498"> </a>
<a name="ln499">	void SetPackage(const PackageInfo&amp; package)</a>
<a name="ln500">	{</a>
<a name="ln501">		if (package.State() == DOWNLOADING) {</a>
<a name="ln502">			AdoptDownloadProgress(package);</a>
<a name="ln503">		} else {</a>
<a name="ln504">			AdoptActions(package);</a>
<a name="ln505">		}</a>
<a name="ln506"> </a>
<a name="ln507">	}</a>
<a name="ln508"> </a>
<a name="ln509">	void AdoptActions(const PackageInfo&amp; package)</a>
<a name="ln510">	{</a>
<a name="ln511">		PackageManager manager(</a>
<a name="ln512">			BPackageKit::B_PACKAGE_INSTALLATION_LOCATION_HOME);</a>
<a name="ln513"> </a>
<a name="ln514">		// TODO: if the given package is either a system package</a>
<a name="ln515">		// or a system dependency, show a message indicating that status</a>
<a name="ln516">		// so the user knows why no actions are presented</a>
<a name="ln517">		PackageActionList actions = manager.GetPackageActions(</a>
<a name="ln518">			const_cast&lt;PackageInfo*&gt;(&amp;package),</a>
<a name="ln519">			fPackageActionHandler-&gt;GetModel());</a>
<a name="ln520"> </a>
<a name="ln521">		bool clearNeeded = fStatusBar != NULL;</a>
<a name="ln522">		if (!clearNeeded) {</a>
<a name="ln523">			if (actions.CountItems() != fPackageActions.CountItems())</a>
<a name="ln524">				clearNeeded = true;</a>
<a name="ln525">			else {</a>
<a name="ln526">				for (int32 i = 0; i &lt; actions.CountItems(); i++) {</a>
<a name="ln527">					if (actions.ItemAtFast(i)-&gt;Type()</a>
<a name="ln528">							!= fPackageActions.ItemAtFast(i)-&gt;Type()) {</a>
<a name="ln529">						clearNeeded = true;</a>
<a name="ln530">						break;</a>
<a name="ln531">					}</a>
<a name="ln532">				}</a>
<a name="ln533">			}</a>
<a name="ln534">		}</a>
<a name="ln535"> </a>
<a name="ln536">		fPackageActions = actions;</a>
<a name="ln537">		if (!clearNeeded &amp;&amp; fButtons.CountItems() == actions.CountItems()) {</a>
<a name="ln538">			int32 index = 0;</a>
<a name="ln539">			for (int32 i = fPackageActions.CountItems() - 1; i &gt;= 0; i--) {</a>
<a name="ln540">				const PackageActionRef&amp; action = fPackageActions.ItemAtFast(i);</a>
<a name="ln541">				BButton* button = (BButton*)fButtons.ItemAtFast(index++);</a>
<a name="ln542">				button-&gt;SetLabel(action-&gt;Label());</a>
<a name="ln543">			}</a>
<a name="ln544">			return;</a>
<a name="ln545">		}</a>
<a name="ln546"> </a>
<a name="ln547">		Clear();</a>
<a name="ln548"> </a>
<a name="ln549">		// Add Buttons in reverse action order</a>
<a name="ln550">		for (int32 i = fPackageActions.CountItems() - 1; i &gt;= 0; i--) {</a>
<a name="ln551">			const PackageActionRef&amp; action = fPackageActions.ItemAtFast(i);</a>
<a name="ln552"> </a>
<a name="ln553">			BMessage* message = new BMessage(MSG_PACKAGE_ACTION);</a>
<a name="ln554">			message-&gt;AddInt32(&quot;index&quot;, i);</a>
<a name="ln555"> </a>
<a name="ln556">			BButton* button = new BButton(action-&gt;Label(), message);</a>
<a name="ln557">			fLayout-&gt;AddView(button);</a>
<a name="ln558">			button-&gt;SetTarget(this);</a>
<a name="ln559"> </a>
<a name="ln560">			fButtons.AddItem(button);</a>
<a name="ln561">		}</a>
<a name="ln562">	}</a>
<a name="ln563"> </a>
<a name="ln564">	void AdoptDownloadProgress(const PackageInfo&amp; package)</a>
<a name="ln565">	{</a>
<a name="ln566">		if (fButtons.CountItems() &gt; 0)</a>
<a name="ln567">			Clear();</a>
<a name="ln568"> </a>
<a name="ln569">		if (fStatusBar == NULL) {</a>
<a name="ln570">			fStatusLabel = new BStringView(&quot;progress label&quot;,</a>
<a name="ln571">				B_TRANSLATE(&quot;Downloading:&quot;));</a>
<a name="ln572">			fLayout-&gt;AddView(fStatusLabel);</a>
<a name="ln573"> </a>
<a name="ln574">			fStatusBar = new BStatusBar(&quot;progress&quot;);</a>
<a name="ln575">			fStatusBar-&gt;SetMaxValue(100.0);</a>
<a name="ln576">			fStatusBar-&gt;SetExplicitMinSize(</a>
<a name="ln577">				BSize(StringWidth(&quot;XXX&quot;) * 5, B_SIZE_UNSET));</a>
<a name="ln578"> </a>
<a name="ln579">			fLayout-&gt;AddView(fStatusBar);</a>
<a name="ln580">		}</a>
<a name="ln581"> </a>
<a name="ln582">		fStatusBar-&gt;SetTo(package.DownloadProgress() * 100.0);</a>
<a name="ln583">	}</a>
<a name="ln584"> </a>
<a name="ln585">	void Clear()</a>
<a name="ln586">	{</a>
<a name="ln587">		for (int32 i = fButtons.CountItems() - 1; i &gt;= 0; i--) {</a>
<a name="ln588">			BButton* button = (BButton*)fButtons.ItemAtFast(i);</a>
<a name="ln589">			button-&gt;RemoveSelf();</a>
<a name="ln590">			delete button;</a>
<a name="ln591">		}</a>
<a name="ln592">		fButtons.MakeEmpty();</a>
<a name="ln593"> </a>
<a name="ln594">		if (fStatusBar != NULL) {</a>
<a name="ln595">			fStatusBar-&gt;RemoveSelf();</a>
<a name="ln596">			delete fStatusBar;</a>
<a name="ln597">			fStatusBar = NULL;</a>
<a name="ln598">		}</a>
<a name="ln599">		if (fStatusLabel != NULL) {</a>
<a name="ln600">			fStatusLabel-&gt;RemoveSelf();</a>
<a name="ln601">			delete fStatusLabel;</a>
<a name="ln602">			fStatusLabel = NULL;</a>
<a name="ln603">		}</a>
<a name="ln604">	}</a>
<a name="ln605"> </a>
<a name="ln606">private:</a>
<a name="ln607">	void _RunPackageAction(BMessage* message)</a>
<a name="ln608">	{</a>
<a name="ln609">		int32 index;</a>
<a name="ln610">		if (message-&gt;FindInt32(&quot;index&quot;, &amp;index) != B_OK)</a>
<a name="ln611">			return;</a>
<a name="ln612"> </a>
<a name="ln613">		const PackageActionRef&amp; action = fPackageActions.ItemAt(index);</a>
<a name="ln614">		if (action.Get() == NULL)</a>
<a name="ln615">			return;</a>
<a name="ln616"> </a>
<a name="ln617">		PackageActionList actions;</a>
<a name="ln618">		actions.Add(action);</a>
<a name="ln619">		status_t result</a>
<a name="ln620">			= fPackageActionHandler-&gt;SchedulePackageActions(actions);</a>
<a name="ln621"> </a>
<a name="ln622">		if (result != B_OK) {</a>
<a name="ln623">			fprintf(stderr, &quot;Failed to schedule action: &quot;</a>
<a name="ln624">				&quot;%s '%s': %s\n&quot;, action-&gt;Label(),</a>
<a name="ln625">				action-&gt;Package()-&gt;Name().String(),</a>
<a name="ln626">				strerror(result));</a>
<a name="ln627">			BString message(B_TRANSLATE(&quot;The package action &quot;</a>
<a name="ln628">				&quot;could not be scheduled: %Error%&quot;));</a>
<a name="ln629">			message.ReplaceAll(&quot;%Error%&quot;, strerror(result));</a>
<a name="ln630">			BAlert* alert = new(std::nothrow) BAlert(</a>
<a name="ln631">				B_TRANSLATE(&quot;Package action failed&quot;),</a>
<a name="ln632">				message, B_TRANSLATE(&quot;OK&quot;), NULL, NULL,</a>
<a name="ln633">				B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln634">			if (alert != NULL)</a>
<a name="ln635">				alert-&gt;Go();</a>
<a name="ln636">		} else {</a>
<a name="ln637">			// Find the button for this action and disable it.</a>
<a name="ln638">			// Actually search the matching button instead of just using</a>
<a name="ln639">			// fButtons.ItemAt((fButtons.CountItems() - 1) - index) to</a>
<a name="ln640">			// make this robust against for example changing the order of</a>
<a name="ln641">			// buttons from right -&gt; left to left -&gt; right...</a>
<a name="ln642">			for (int32 i = 0; i &lt; fButtons.CountItems(); i++) {</a>
<a name="ln643">				BButton* button = (BButton*)fButtons.ItemAt(index);</a>
<a name="ln644">				if (button == NULL)</a>
<a name="ln645">					continue;</a>
<a name="ln646">				BMessage* buttonMessage = button-&gt;Message();</a>
<a name="ln647">				if (buttonMessage == NULL)</a>
<a name="ln648">					continue;</a>
<a name="ln649">				int32 buttonIndex;</a>
<a name="ln650">				if (buttonMessage-&gt;FindInt32(&quot;index&quot;, &amp;buttonIndex) != B_OK)</a>
<a name="ln651">					continue;</a>
<a name="ln652">				if (buttonIndex == index) {</a>
<a name="ln653">					button-&gt;SetEnabled(false);</a>
<a name="ln654">					break;</a>
<a name="ln655">				}</a>
<a name="ln656">			}</a>
<a name="ln657">		}</a>
<a name="ln658">	}</a>
<a name="ln659"> </a>
<a name="ln660">private:</a>
<a name="ln661">	BGroupLayout*		fLayout;</a>
<a name="ln662">	PackageActionList	fPackageActions;</a>
<a name="ln663">	PackageActionHandler* fPackageActionHandler;</a>
<a name="ln664">	BList				fButtons;</a>
<a name="ln665"> </a>
<a name="ln666">	BStringView*		fStatusLabel;</a>
<a name="ln667">	BStatusBar*			fStatusBar;</a>
<a name="ln668">};</a>
<a name="ln669"> </a>
<a name="ln670"> </a>
<a name="ln671">// #pragma mark - AboutView</a>
<a name="ln672"> </a>
<a name="ln673"> </a>
<a name="ln674">enum {</a>
<a name="ln675">	MSG_EMAIL_PUBLISHER				= 'emlp',</a>
<a name="ln676">	MSG_VISIT_PUBLISHER_WEBSITE		= 'vpws',</a>
<a name="ln677">};</a>
<a name="ln678"> </a>
<a name="ln679"> </a>
<a name="ln680">class AboutView : public BView {</a>
<a name="ln681">public:</a>
<a name="ln682">	AboutView()</a>
<a name="ln683">		:</a>
<a name="ln684">		BView(&quot;about view&quot;, 0),</a>
<a name="ln685">		fEmailIcon(&quot;text/x-email&quot;),</a>
<a name="ln686">		fWebsiteIcon(&quot;text/html&quot;)</a>
<a name="ln687">	{</a>
<a name="ln688">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, kContentTint);</a>
<a name="ln689"> </a>
<a name="ln690">		fDescriptionView = new MarkupTextView(&quot;description view&quot;);</a>
<a name="ln691">		fDescriptionView-&gt;SetViewUIColor(ViewUIColor(), kContentTint);</a>
<a name="ln692">		fDescriptionView-&gt;SetInsets(be_plain_font-&gt;Size());</a>
<a name="ln693"> </a>
<a name="ln694">		BScrollView* scrollView = new CustomScrollView(</a>
<a name="ln695">			&quot;description scroll view&quot;, fDescriptionView);</a>
<a name="ln696"> </a>
<a name="ln697">		BFont smallFont;</a>
<a name="ln698">		GetFont(&amp;smallFont);</a>
<a name="ln699">		smallFont.SetSize(std::max(9.0f, ceilf(smallFont.Size() * 0.85f)));</a>
<a name="ln700"> </a>
<a name="ln701">		// TODO: Clicking the screen shot view should open ShowImage with the</a>
<a name="ln702">		// the screen shot. This could be done by writing the screen shot to</a>
<a name="ln703">		// a temporary folder, launching ShowImage to display it, and writing</a>
<a name="ln704">		// all other screenshots associated with the package to the same folder</a>
<a name="ln705">		// so the user can use the ShowImage navigation to view the other</a>
<a name="ln706">		// screenshots.</a>
<a name="ln707">		fScreenshotView = new LinkedBitmapView(&quot;screenshot view&quot;,</a>
<a name="ln708">			new BMessage(MSG_SHOW_SCREENSHOT));</a>
<a name="ln709">		fScreenshotView-&gt;SetExplicitMinSize(BSize(64.0f, 64.0f));</a>
<a name="ln710">		fScreenshotView-&gt;SetExplicitMaxSize(</a>
<a name="ln711">			BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED));</a>
<a name="ln712">		fScreenshotView-&gt;SetExplicitAlignment(</a>
<a name="ln713">			BAlignment(B_ALIGN_CENTER, B_ALIGN_TOP));</a>
<a name="ln714"> </a>
<a name="ln715">		fEmailIconView = new BitmapView(&quot;email icon view&quot;);</a>
<a name="ln716">		fEmailLinkView = new LinkView(&quot;email link view&quot;, &quot;&quot;,</a>
<a name="ln717">			new BMessage(MSG_EMAIL_PUBLISHER));</a>
<a name="ln718">		fEmailLinkView-&gt;SetFont(&amp;smallFont);</a>
<a name="ln719"> </a>
<a name="ln720">		fWebsiteIconView = new BitmapView(&quot;website icon view&quot;);</a>
<a name="ln721">		fWebsiteLinkView = new LinkView(&quot;website link view&quot;, &quot;&quot;,</a>
<a name="ln722">			new BMessage(MSG_VISIT_PUBLISHER_WEBSITE));</a>
<a name="ln723">		fWebsiteLinkView-&gt;SetFont(&amp;smallFont);</a>
<a name="ln724"> </a>
<a name="ln725">		BGroupView* leftGroup = new BGroupView(B_VERTICAL,</a>
<a name="ln726">			B_USE_DEFAULT_SPACING);</a>
<a name="ln727"> </a>
<a name="ln728">		fScreenshotView-&gt;SetViewUIColor(ViewUIColor(), kContentTint);</a>
<a name="ln729">		fEmailLinkView-&gt;SetViewUIColor(ViewUIColor(), kContentTint);</a>
<a name="ln730">		fWebsiteLinkView-&gt;SetViewUIColor(ViewUIColor(), kContentTint);</a>
<a name="ln731"> </a>
<a name="ln732">		BLayoutBuilder::Group&lt;&gt;(this, B_HORIZONTAL, 0.0f)</a>
<a name="ln733">			.AddGroup(leftGroup, 1.0f)</a>
<a name="ln734">				.Add(fScreenshotView)</a>
<a name="ln735">				.AddGroup(B_HORIZONTAL)</a>
<a name="ln736">					.AddGrid(B_USE_HALF_ITEM_SPACING, B_USE_HALF_ITEM_SPACING)</a>
<a name="ln737">						.Add(fEmailIconView, 0, 0)</a>
<a name="ln738">						.Add(fEmailLinkView, 1, 0)</a>
<a name="ln739">						.Add(fWebsiteIconView, 0, 1)</a>
<a name="ln740">						.Add(fWebsiteLinkView, 1, 1)</a>
<a name="ln741">					.End()</a>
<a name="ln742">				.End()</a>
<a name="ln743">				.SetInsets(B_USE_DEFAULT_SPACING)</a>
<a name="ln744">				.SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET))</a>
<a name="ln745">			.End()</a>
<a name="ln746">			.Add(scrollView, 2.0f)</a>
<a name="ln747"> </a>
<a name="ln748">			.SetExplicitMaxSize(BSize(B_SIZE_UNSET, B_SIZE_UNLIMITED))</a>
<a name="ln749">			.SetInsets(0.0f, -1.0f, -1.0f, -1.0f)</a>
<a name="ln750">		;</a>
<a name="ln751">	}</a>
<a name="ln752"> </a>
<a name="ln753">	virtual ~AboutView()</a>
<a name="ln754">	{</a>
<a name="ln755">		Clear();</a>
<a name="ln756">	}</a>
<a name="ln757"> </a>
<a name="ln758">	virtual void AttachedToWindow()</a>
<a name="ln759">	{</a>
<a name="ln760">		fScreenshotView-&gt;SetTarget(this);</a>
<a name="ln761">		fEmailLinkView-&gt;SetTarget(this);</a>
<a name="ln762">		fWebsiteLinkView-&gt;SetTarget(this);</a>
<a name="ln763">	}</a>
<a name="ln764"> </a>
<a name="ln765">	virtual void AllAttached()</a>
<a name="ln766">	{</a>
<a name="ln767">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, kContentTint);</a>
<a name="ln768"> </a>
<a name="ln769">		for (int32 index = 0; index &lt; CountChildren(); ++index)</a>
<a name="ln770">			ChildAt(index)-&gt;AdoptParentColors();</a>
<a name="ln771">	}</a>
<a name="ln772"> </a>
<a name="ln773">	virtual void MessageReceived(BMessage* message)</a>
<a name="ln774">	{</a>
<a name="ln775">		switch (message-&gt;what) {</a>
<a name="ln776">			case MSG_SHOW_SCREENSHOT:</a>
<a name="ln777">			{</a>
<a name="ln778">				// Forward to window for now</a>
<a name="ln779">				Window()-&gt;PostMessage(message, Window());</a>
<a name="ln780">				break;</a>
<a name="ln781">			}</a>
<a name="ln782"> </a>
<a name="ln783">			case MSG_EMAIL_PUBLISHER:</a>
<a name="ln784">			{</a>
<a name="ln785">				// TODO: Implement. If memory serves, there is a</a>
<a name="ln786">				// standard command line interface which mail apps should</a>
<a name="ln787">				// support, i.e. to open a compose window with the TO: field</a>
<a name="ln788">				// already set.</a>
<a name="ln789">				break;</a>
<a name="ln790">			}</a>
<a name="ln791"> </a>
<a name="ln792">			case MSG_VISIT_PUBLISHER_WEBSITE:</a>
<a name="ln793">			{</a>
<a name="ln794">				BUrl url(fWebsiteLinkView-&gt;Text());</a>
<a name="ln795">				url.OpenWithPreferredApplication();</a>
<a name="ln796">				break;</a>
<a name="ln797">			}</a>
<a name="ln798"> </a>
<a name="ln799">			default:</a>
<a name="ln800">				BView::MessageReceived(message);</a>
<a name="ln801">				break;</a>
<a name="ln802">		}</a>
<a name="ln803">	}</a>
<a name="ln804"> </a>
<a name="ln805">	void SetPackage(const PackageInfo&amp; package)</a>
<a name="ln806">	{</a>
<a name="ln807">		fDescriptionView-&gt;SetText(package.ShortDescription(),</a>
<a name="ln808">			package.FullDescription());</a>
<a name="ln809"> </a>
<a name="ln810">		fEmailIconView-&gt;SetBitmap(&amp;fEmailIcon, SharedBitmap::SIZE_16);</a>
<a name="ln811">		_SetContactInfo(fEmailLinkView, package.Publisher().Email());</a>
<a name="ln812">		fWebsiteIconView-&gt;SetBitmap(&amp;fWebsiteIcon, SharedBitmap::SIZE_16);</a>
<a name="ln813">		_SetContactInfo(fWebsiteLinkView, package.Publisher().Website());</a>
<a name="ln814"> </a>
<a name="ln815">		bool hasScreenshot = false;</a>
<a name="ln816">		const BitmapList&amp; screenShots = package.Screenshots();</a>
<a name="ln817">		if (screenShots.CountItems() &gt; 0) {</a>
<a name="ln818">			const BitmapRef&amp; bitmapRef = screenShots.ItemAtFast(0);</a>
<a name="ln819">			if (bitmapRef.Get() != NULL) {</a>
<a name="ln820">				hasScreenshot = true;</a>
<a name="ln821">				fScreenshotView-&gt;SetBitmap(bitmapRef);</a>
<a name="ln822">			}</a>
<a name="ln823">		}</a>
<a name="ln824"> </a>
<a name="ln825">		if (!hasScreenshot)</a>
<a name="ln826">			fScreenshotView-&gt;UnsetBitmap();</a>
<a name="ln827"> </a>
<a name="ln828">		fScreenshotView-&gt;SetEnabled(hasScreenshot);</a>
<a name="ln829">	}</a>
<a name="ln830"> </a>
<a name="ln831">	void Clear()</a>
<a name="ln832">	{</a>
<a name="ln833">		fDescriptionView-&gt;SetText(&quot;&quot;);</a>
<a name="ln834">		fEmailIconView-&gt;UnsetBitmap();</a>
<a name="ln835">		fEmailLinkView-&gt;SetText(&quot;&quot;);</a>
<a name="ln836">		fWebsiteIconView-&gt;UnsetBitmap();</a>
<a name="ln837">		fWebsiteLinkView-&gt;SetText(&quot;&quot;);</a>
<a name="ln838"> </a>
<a name="ln839">		fScreenshotView-&gt;UnsetBitmap();</a>
<a name="ln840">		fScreenshotView-&gt;SetEnabled(false);</a>
<a name="ln841">	}</a>
<a name="ln842"> </a>
<a name="ln843">private:</a>
<a name="ln844">	void _SetContactInfo(LinkView* view, const BString&amp; string)</a>
<a name="ln845">	{</a>
<a name="ln846">		if (string.Length() &gt; 0) {</a>
<a name="ln847">			view-&gt;SetText(string);</a>
<a name="ln848">			view-&gt;SetEnabled(true);</a>
<a name="ln849">		} else {</a>
<a name="ln850">			view-&gt;SetText(B_TRANSLATE(&quot;&lt;no info&gt;&quot;));</a>
<a name="ln851">			view-&gt;SetEnabled(false);</a>
<a name="ln852">		}</a>
<a name="ln853">	}</a>
<a name="ln854"> </a>
<a name="ln855">private:</a>
<a name="ln856">	MarkupTextView*		fDescriptionView;</a>
<a name="ln857"> </a>
<a name="ln858">	LinkedBitmapView*	fScreenshotView;</a>
<a name="ln859"> </a>
<a name="ln860">	SharedBitmap		fEmailIcon;</a>
<a name="ln861">	BitmapView*			fEmailIconView;</a>
<a name="ln862">	LinkView*			fEmailLinkView;</a>
<a name="ln863"> </a>
<a name="ln864">	SharedBitmap		fWebsiteIcon;</a>
<a name="ln865">	BitmapView*			fWebsiteIconView;</a>
<a name="ln866">	LinkView*			fWebsiteLinkView;</a>
<a name="ln867">};</a>
<a name="ln868"> </a>
<a name="ln869"> </a>
<a name="ln870">// #pragma mark - UserRatingsView</a>
<a name="ln871"> </a>
<a name="ln872"> </a>
<a name="ln873">class RatingItemView : public BGroupView {</a>
<a name="ln874">public:</a>
<a name="ln875">	RatingItemView(const UserRating&amp; rating)</a>
<a name="ln876">		:</a>
<a name="ln877">		BGroupView(B_HORIZONTAL, 0.0f)</a>
<a name="ln878">	{</a>
<a name="ln879">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, kContentTint);</a>
<a name="ln880"> </a>
<a name="ln881">		BGroupLayout* verticalGroup = new BGroupLayout(B_VERTICAL, 0.0f);</a>
<a name="ln882">		GroupLayout()-&gt;AddItem(verticalGroup);</a>
<a name="ln883"> </a>
<a name="ln884">		{</a>
<a name="ln885">			BStringView* userNicknameView = new BStringView(&quot;user-nickname&quot;,</a>
<a name="ln886">				rating.User().NickName());</a>
<a name="ln887">			userNicknameView-&gt;SetFont(be_bold_font);</a>
<a name="ln888">			verticalGroup-&gt;AddView(userNicknameView);</a>
<a name="ln889">		}</a>
<a name="ln890"> </a>
<a name="ln891">		BGroupLayout* ratingGroup =</a>
<a name="ln892">			new BGroupLayout(B_HORIZONTAL, B_USE_DEFAULT_SPACING);</a>
<a name="ln893">		verticalGroup-&gt;AddItem(ratingGroup);</a>
<a name="ln894"> </a>
<a name="ln895">		if (rating.Rating() &gt;= 0) {</a>
<a name="ln896">			RatingView* ratingView = new RatingView(&quot;package rating view&quot;);</a>
<a name="ln897">			ratingView-&gt;SetRating(rating.Rating());</a>
<a name="ln898">			ratingGroup-&gt;AddView(ratingView);</a>
<a name="ln899">		}</a>
<a name="ln900"> </a>
<a name="ln901">		{</a>
<a name="ln902">			BDateFormat dateFormat;</a>
<a name="ln903">			BString createTimestampPresentation;</a>
<a name="ln904"> </a>
<a name="ln905">			dateFormat.Format(createTimestampPresentation,</a>
<a name="ln906">				rating.CreateTimestamp().Date(), B_MEDIUM_DATE_FORMAT);</a>
<a name="ln907"> </a>
<a name="ln908">			BString ratingContextDescription(</a>
<a name="ln909">				B_TRANSLATE(&quot;%hd.timestamp% (version %hd.version%)&quot;));</a>
<a name="ln910">			ratingContextDescription.ReplaceAll(&quot;%hd.timestamp%&quot;,</a>
<a name="ln911">				createTimestampPresentation);</a>
<a name="ln912">			ratingContextDescription.ReplaceAll(&quot;%hd.version%&quot;,</a>
<a name="ln913">				rating.PackageVersion());</a>
<a name="ln914"> </a>
<a name="ln915">			BStringView* ratingContextView = new BStringView(&quot;rating-context&quot;,</a>
<a name="ln916">				ratingContextDescription);</a>
<a name="ln917">			BFont versionFont(be_plain_font);</a>
<a name="ln918">			ratingContextView-&gt;SetFont(&amp;versionFont);</a>
<a name="ln919">			ratingGroup-&gt;AddView(ratingContextView);</a>
<a name="ln920">		}</a>
<a name="ln921"> </a>
<a name="ln922">		ratingGroup-&gt;AddItem(BSpaceLayoutItem::CreateGlue());</a>
<a name="ln923"> </a>
<a name="ln924">		if (rating.Comment() &gt; 0) {</a>
<a name="ln925">			TextView* textView = new TextView(&quot;rating-text&quot;);</a>
<a name="ln926">			ParagraphStyle paragraphStyle(textView-&gt;ParagraphStyle());</a>
<a name="ln927">			paragraphStyle.SetJustify(true);</a>
<a name="ln928">			textView-&gt;SetParagraphStyle(paragraphStyle);</a>
<a name="ln929">			textView-&gt;SetText(rating.Comment());</a>
<a name="ln930">			verticalGroup-&gt;AddItem(BSpaceLayoutItem::CreateVerticalStrut(8.0f));</a>
<a name="ln931">			verticalGroup-&gt;AddView(textView);</a>
<a name="ln932">			verticalGroup-&gt;AddItem(BSpaceLayoutItem::CreateVerticalStrut(8.0f));</a>
<a name="ln933">		}</a>
<a name="ln934"> </a>
<a name="ln935">		verticalGroup-&gt;SetInsets(B_USE_DEFAULT_SPACING);</a>
<a name="ln936"> </a>
<a name="ln937">		SetFlags(Flags() | B_WILL_DRAW);</a>
<a name="ln938">	}</a>
<a name="ln939"> </a>
<a name="ln940">	void AllAttached()</a>
<a name="ln941">	{</a>
<a name="ln942">		for (int32 index = 0; index &lt; CountChildren(); ++index)</a>
<a name="ln943">			ChildAt(index)-&gt;AdoptParentColors();</a>
<a name="ln944">	}</a>
<a name="ln945"> </a>
<a name="ln946">	void Draw(BRect rect)</a>
<a name="ln947">	{</a>
<a name="ln948">		rgb_color color = mix_color(ViewColor(), ui_color(B_PANEL_TEXT_COLOR), 64);</a>
<a name="ln949">		SetHighColor(color);</a>
<a name="ln950">		StrokeLine(Bounds().LeftBottom(), Bounds().RightBottom());</a>
<a name="ln951">	}</a>
<a name="ln952"> </a>
<a name="ln953">};</a>
<a name="ln954"> </a>
<a name="ln955"> </a>
<a name="ln956">class RatingSummaryView : public BGridView {</a>
<a name="ln957">public:</a>
<a name="ln958">	RatingSummaryView()</a>
<a name="ln959">		:</a>
<a name="ln960">		BGridView(&quot;rating summary view&quot;, B_USE_HALF_ITEM_SPACING, 0.0f)</a>
<a name="ln961">	{</a>
<a name="ln962">		float tint = kContentTint - 0.1;</a>
<a name="ln963">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, tint);</a>
<a name="ln964"> </a>
<a name="ln965">		BLayoutBuilder::Grid&lt;&gt; layoutBuilder(this);</a>
<a name="ln966"> </a>
<a name="ln967">		BFont smallFont;</a>
<a name="ln968">		GetFont(&amp;smallFont);</a>
<a name="ln969">		smallFont.SetSize(std::max(9.0f, floorf(smallFont.Size() * 0.85f)));</a>
<a name="ln970"> </a>
<a name="ln971">		for (int32 i = 0; i &lt; 5; i++) {</a>
<a name="ln972">			BString label;</a>
<a name="ln973">			label.SetToFormat(&quot;%&quot; B_PRId32, 5 - i);</a>
<a name="ln974">			fLabelViews[i] = new BStringView(&quot;&quot;, label);</a>
<a name="ln975">			fLabelViews[i]-&gt;SetFont(&amp;smallFont);</a>
<a name="ln976">			fLabelViews[i]-&gt;SetViewUIColor(ViewUIColor(), tint);</a>
<a name="ln977">			layoutBuilder.Add(fLabelViews[i], 0, i);</a>
<a name="ln978"> </a>
<a name="ln979">			fDiagramBarViews[i] = new DiagramBarView();</a>
<a name="ln980">			layoutBuilder.Add(fDiagramBarViews[i], 1, i);</a>
<a name="ln981"> </a>
<a name="ln982">			fCountViews[i] = new BStringView(&quot;&quot;, &quot;&quot;);</a>
<a name="ln983">			fCountViews[i]-&gt;SetFont(&amp;smallFont);</a>
<a name="ln984">			fCountViews[i]-&gt;SetViewUIColor(ViewUIColor(), tint);</a>
<a name="ln985">			fCountViews[i]-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln986">			layoutBuilder.Add(fCountViews[i], 2, i);</a>
<a name="ln987">		}</a>
<a name="ln988"> </a>
<a name="ln989">		layoutBuilder.SetInsets(5);</a>
<a name="ln990">	}</a>
<a name="ln991"> </a>
<a name="ln992">	void SetToSummary(const RatingSummary&amp; summary) {</a>
<a name="ln993">		for (int32 i = 0; i &lt; 5; i++) {</a>
<a name="ln994">			int32 count = summary.ratingCountByStar[4 - i];</a>
<a name="ln995"> </a>
<a name="ln996">			BString label;</a>
<a name="ln997">			label.SetToFormat(&quot;%&quot; B_PRId32, count);</a>
<a name="ln998">			fCountViews[i]-&gt;SetText(label);</a>
<a name="ln999"> </a>
<a name="ln1000">			if (summary.ratingCount &gt; 0) {</a>
<a name="ln1001">				fDiagramBarViews[i]-&gt;SetValue(</a>
<a name="ln1002">					(float)count / summary.ratingCount);</a>
<a name="ln1003">			} else</a>
<a name="ln1004">				fDiagramBarViews[i]-&gt;SetValue(0.0f);</a>
<a name="ln1005">		}</a>
<a name="ln1006">	}</a>
<a name="ln1007"> </a>
<a name="ln1008">	void Clear() {</a>
<a name="ln1009">		for (int32 i = 0; i &lt; 5; i++) {</a>
<a name="ln1010">			fCountViews[i]-&gt;SetText(&quot;&quot;);</a>
<a name="ln1011">			fDiagramBarViews[i]-&gt;SetValue(0.0f);</a>
<a name="ln1012">		}</a>
<a name="ln1013">	}</a>
<a name="ln1014"> </a>
<a name="ln1015">private:</a>
<a name="ln1016">	BStringView*	fLabelViews[5];</a>
<a name="ln1017">	DiagramBarView*	fDiagramBarViews[5];</a>
<a name="ln1018">	BStringView*	fCountViews[5];</a>
<a name="ln1019">};</a>
<a name="ln1020"> </a>
<a name="ln1021"> </a>
<a name="ln1022">class UserRatingsView : public BGroupView {</a>
<a name="ln1023">public:</a>
<a name="ln1024">	UserRatingsView()</a>
<a name="ln1025">		:</a>
<a name="ln1026">		BGroupView(&quot;package ratings view&quot;, B_HORIZONTAL)</a>
<a name="ln1027">	{</a>
<a name="ln1028">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, kContentTint);</a>
<a name="ln1029"> </a>
<a name="ln1030">		fRatingSummaryView = new RatingSummaryView();</a>
<a name="ln1031"> </a>
<a name="ln1032">		ScrollableGroupView* ratingsContainerView = new ScrollableGroupView();</a>
<a name="ln1033">		ratingsContainerView-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR,</a>
<a name="ln1034">												kContentTint);</a>
<a name="ln1035">		fRatingContainerLayout = ratingsContainerView-&gt;GroupLayout();</a>
<a name="ln1036"> </a>
<a name="ln1037">		BScrollView* scrollView = new RatingsScrollView(</a>
<a name="ln1038">			&quot;ratings scroll view&quot;, ratingsContainerView);</a>
<a name="ln1039">		scrollView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED,</a>
<a name="ln1040">			B_SIZE_UNLIMITED));</a>
<a name="ln1041"> </a>
<a name="ln1042">		BLayoutBuilder::Group&lt;&gt;(this)</a>
<a name="ln1043">			.AddGroup(B_VERTICAL)</a>
<a name="ln1044">				.Add(fRatingSummaryView, 0.0f)</a>
<a name="ln1045">				.AddGlue()</a>
<a name="ln1046">				.SetInsets(0.0f, B_USE_DEFAULT_SPACING, 0.0f, 0.0f)</a>
<a name="ln1047">			.End()</a>
<a name="ln1048">			.AddStrut(64.0)</a>
<a name="ln1049">			.Add(scrollView, 1.0f)</a>
<a name="ln1050">			.SetInsets(B_USE_DEFAULT_SPACING, -1.0f, -1.0f, -1.0f)</a>
<a name="ln1051">		;</a>
<a name="ln1052">	}</a>
<a name="ln1053"> </a>
<a name="ln1054">	virtual ~UserRatingsView()</a>
<a name="ln1055">	{</a>
<a name="ln1056">		Clear();</a>
<a name="ln1057">	}</a>
<a name="ln1058"> </a>
<a name="ln1059">	void SetPackage(const PackageInfo&amp; package)</a>
<a name="ln1060">	{</a>
<a name="ln1061">		ClearRatings();</a>
<a name="ln1062"> </a>
<a name="ln1063">		// TODO: Re-use rating summary already used for TitleView...</a>
<a name="ln1064">		fRatingSummaryView-&gt;SetToSummary(package.CalculateRatingSummary());</a>
<a name="ln1065"> </a>
<a name="ln1066">		const UserRatingList&amp; userRatings = package.UserRatings();</a>
<a name="ln1067"> </a>
<a name="ln1068">		int count = userRatings.CountItems();</a>
<a name="ln1069">		if (count == 0) {</a>
<a name="ln1070">			BStringView* noRatingsView = new BStringView(&quot;no ratings&quot;,</a>
<a name="ln1071">				B_TRANSLATE(&quot;No user ratings available.&quot;));</a>
<a name="ln1072">			noRatingsView-&gt;SetViewUIColor(ViewUIColor(), kContentTint);</a>
<a name="ln1073">			noRatingsView-&gt;SetAlignment(B_ALIGN_CENTER);</a>
<a name="ln1074">			noRatingsView-&gt;SetHighColor(disable_color(ui_color(B_PANEL_TEXT_COLOR),</a>
<a name="ln1075">				ViewColor()));</a>
<a name="ln1076">			noRatingsView-&gt;SetExplicitMaxSize(</a>
<a name="ln1077">				BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED));</a>
<a name="ln1078">			fRatingContainerLayout-&gt;AddView(0, noRatingsView);</a>
<a name="ln1079">			return;</a>
<a name="ln1080">		}</a>
<a name="ln1081"> </a>
<a name="ln1082">		// TODO: Sort by age or usefullness rating</a>
<a name="ln1083">		for (int i = count - 1; i &gt;= 0; i--) {</a>
<a name="ln1084">			const UserRating&amp; rating = userRatings.ItemAtFast(i);</a>
<a name="ln1085">				// was previously filtering comments just for the current</a>
<a name="ln1086">				// user's language, but as there are not so many comments at</a>
<a name="ln1087">				// the moment, just show all of them for now.</a>
<a name="ln1088">			RatingItemView* view = new RatingItemView(rating);</a>
<a name="ln1089">			fRatingContainerLayout-&gt;AddView(0, view);</a>
<a name="ln1090">		}</a>
<a name="ln1091">	}</a>
<a name="ln1092"> </a>
<a name="ln1093">	void Clear()</a>
<a name="ln1094">	{</a>
<a name="ln1095">		fRatingSummaryView-&gt;Clear();</a>
<a name="ln1096">		ClearRatings();</a>
<a name="ln1097">	}</a>
<a name="ln1098"> </a>
<a name="ln1099">	void ClearRatings()</a>
<a name="ln1100">	{</a>
<a name="ln1101">		for (int32 i = fRatingContainerLayout-&gt;CountItems() - 1;</a>
<a name="ln1102">				BLayoutItem* item = fRatingContainerLayout-&gt;ItemAt(i); i--) {</a>
<a name="ln1103">			BView* view = dynamic_cast&lt;RatingItemView*&gt;(item-&gt;View());</a>
<a name="ln1104">			if (view == NULL)</a>
<a name="ln1105">				view = dynamic_cast&lt;BStringView*&gt;(item-&gt;View());</a>
<a name="ln1106">			if (view != NULL) {</a>
<a name="ln1107">				view-&gt;RemoveSelf();</a>
<a name="ln1108">				delete view;</a>
<a name="ln1109">			}</a>
<a name="ln1110">		}</a>
<a name="ln1111">	}</a>
<a name="ln1112"> </a>
<a name="ln1113">private:</a>
<a name="ln1114">	BGroupLayout*			fRatingContainerLayout;</a>
<a name="ln1115">	RatingSummaryView*		fRatingSummaryView;</a>
<a name="ln1116">};</a>
<a name="ln1117"> </a>
<a name="ln1118"> </a>
<a name="ln1119">// #pragma mark - ContentsView</a>
<a name="ln1120"> </a>
<a name="ln1121"> </a>
<a name="ln1122">class ContentsView : public BGroupView {</a>
<a name="ln1123">public:</a>
<a name="ln1124">	ContentsView()</a>
<a name="ln1125">		:</a>
<a name="ln1126">		BGroupView(&quot;package contents view&quot;, B_HORIZONTAL)</a>
<a name="ln1127">	{</a>
<a name="ln1128">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, kContentTint);</a>
<a name="ln1129"> </a>
<a name="ln1130">		fPackageContents = new PackageContentsView(&quot;contents_list&quot;);</a>
<a name="ln1131">		AddChild(fPackageContents);</a>
<a name="ln1132"> </a>
<a name="ln1133">	}</a>
<a name="ln1134"> </a>
<a name="ln1135">	virtual ~ContentsView()</a>
<a name="ln1136">	{</a>
<a name="ln1137">	}</a>
<a name="ln1138"> </a>
<a name="ln1139">	virtual void Draw(BRect updateRect)</a>
<a name="ln1140">	{</a>
<a name="ln1141">	}</a>
<a name="ln1142"> </a>
<a name="ln1143">	void SetPackage(const PackageInfoRef&amp; package)</a>
<a name="ln1144">	{</a>
<a name="ln1145">		fPackageContents-&gt;SetPackage(package);</a>
<a name="ln1146">	}</a>
<a name="ln1147"> </a>
<a name="ln1148">	void Clear()</a>
<a name="ln1149">	{</a>
<a name="ln1150">		fPackageContents-&gt;Clear();</a>
<a name="ln1151">	}</a>
<a name="ln1152"> </a>
<a name="ln1153">private:</a>
<a name="ln1154">	PackageContentsView*	fPackageContents;</a>
<a name="ln1155">};</a>
<a name="ln1156"> </a>
<a name="ln1157"> </a>
<a name="ln1158">// #pragma mark - ChangelogView</a>
<a name="ln1159"> </a>
<a name="ln1160"> </a>
<a name="ln1161">class ChangelogView : public BGroupView {</a>
<a name="ln1162">public:</a>
<a name="ln1163">	ChangelogView()</a>
<a name="ln1164">		:</a>
<a name="ln1165">		BGroupView(&quot;package changelog view&quot;, B_HORIZONTAL)</a>
<a name="ln1166">	{</a>
<a name="ln1167">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR, kContentTint);</a>
<a name="ln1168"> </a>
<a name="ln1169">		fTextView = new MarkupTextView(&quot;changelog view&quot;);</a>
<a name="ln1170">		fTextView-&gt;SetLowUIColor(ViewUIColor());</a>
<a name="ln1171">		fTextView-&gt;SetInsets(be_plain_font-&gt;Size());</a>
<a name="ln1172"> </a>
<a name="ln1173">		BScrollView* scrollView = new CustomScrollView(</a>
<a name="ln1174">			&quot;changelog scroll view&quot;, fTextView);</a>
<a name="ln1175"> </a>
<a name="ln1176">		BLayoutBuilder::Group&lt;&gt;(this)</a>
<a name="ln1177">			.Add(BSpaceLayoutItem::CreateHorizontalStrut(32.0f))</a>
<a name="ln1178">			.Add(scrollView, 1.0f)</a>
<a name="ln1179">			.SetInsets(B_USE_DEFAULT_SPACING, -1.0f, -1.0f, -1.0f)</a>
<a name="ln1180">		;</a>
<a name="ln1181">	}</a>
<a name="ln1182"> </a>
<a name="ln1183">	virtual ~ChangelogView()</a>
<a name="ln1184">	{</a>
<a name="ln1185">	}</a>
<a name="ln1186"> </a>
<a name="ln1187">	virtual void Draw(BRect updateRect)</a>
<a name="ln1188">	{</a>
<a name="ln1189">	}</a>
<a name="ln1190"> </a>
<a name="ln1191">	void SetPackage(const PackageInfo&amp; package)</a>
<a name="ln1192">	{</a>
<a name="ln1193">		const BString&amp; changelog = package.Changelog();</a>
<a name="ln1194">		if (changelog.Length() &gt; 0)</a>
<a name="ln1195">			fTextView-&gt;SetText(changelog);</a>
<a name="ln1196">		else</a>
<a name="ln1197">			fTextView-&gt;SetDisabledText(B_TRANSLATE(&quot;No changelog available.&quot;));</a>
<a name="ln1198">	}</a>
<a name="ln1199"> </a>
<a name="ln1200">	void Clear()</a>
<a name="ln1201">	{</a>
<a name="ln1202">		fTextView-&gt;SetText(&quot;&quot;);</a>
<a name="ln1203">	}</a>
<a name="ln1204"> </a>
<a name="ln1205">private:</a>
<a name="ln1206">	MarkupTextView*		fTextView;</a>
<a name="ln1207">};</a>
<a name="ln1208"> </a>
<a name="ln1209"> </a>
<a name="ln1210">// #pragma mark - PagesView</a>
<a name="ln1211"> </a>
<a name="ln1212"> </a>
<a name="ln1213">class PagesView : public BTabView {</a>
<a name="ln1214">public:</a>
<a name="ln1215">	PagesView()</a>
<a name="ln1216">		:</a>
<a name="ln1217">		BTabView(&quot;pages view&quot;, B_WIDTH_FROM_WIDEST),</a>
<a name="ln1218">		fLayout(new BCardLayout())</a>
<a name="ln1219">	{</a>
<a name="ln1220">		SetBorder(B_NO_BORDER);</a>
<a name="ln1221"> </a>
<a name="ln1222">		fAboutView = new AboutView();</a>
<a name="ln1223">		fUserRatingsView = new UserRatingsView();</a>
<a name="ln1224">		fChangelogView = new ChangelogView();</a>
<a name="ln1225">		fContentsView = new ContentsView();</a>
<a name="ln1226"> </a>
<a name="ln1227">		AddTab(fAboutView);</a>
<a name="ln1228">		AddTab(fUserRatingsView);</a>
<a name="ln1229">		AddTab(fChangelogView);</a>
<a name="ln1230">		AddTab(fContentsView);</a>
<a name="ln1231"> </a>
<a name="ln1232">		TabAt(0)-&gt;SetLabel(B_TRANSLATE(&quot;About&quot;));</a>
<a name="ln1233">		TabAt(1)-&gt;SetLabel(B_TRANSLATE(&quot;Ratings&quot;));</a>
<a name="ln1234">		TabAt(2)-&gt;SetLabel(B_TRANSLATE(&quot;Changelog&quot;));</a>
<a name="ln1235">		TabAt(3)-&gt;SetLabel(B_TRANSLATE(&quot;Contents&quot;));</a>
<a name="ln1236"> </a>
<a name="ln1237">		Select(0);</a>
<a name="ln1238">	}</a>
<a name="ln1239"> </a>
<a name="ln1240">	virtual ~PagesView()</a>
<a name="ln1241">	{</a>
<a name="ln1242">		Clear();</a>
<a name="ln1243">	}</a>
<a name="ln1244"> </a>
<a name="ln1245">	void SetPackage(const PackageInfoRef&amp; package, bool switchToDefaultTab)</a>
<a name="ln1246">	{</a>
<a name="ln1247">		if (switchToDefaultTab)</a>
<a name="ln1248">			Select(0);</a>
<a name="ln1249">		fAboutView-&gt;SetPackage(*package.Get());</a>
<a name="ln1250">		fUserRatingsView-&gt;SetPackage(*package.Get());</a>
<a name="ln1251">		fChangelogView-&gt;SetPackage(*package.Get());</a>
<a name="ln1252">		fContentsView-&gt;SetPackage(package);</a>
<a name="ln1253">	}</a>
<a name="ln1254"> </a>
<a name="ln1255">	void Clear()</a>
<a name="ln1256">	{</a>
<a name="ln1257">		fAboutView-&gt;Clear();</a>
<a name="ln1258">		fUserRatingsView-&gt;Clear();</a>
<a name="ln1259">		fChangelogView-&gt;Clear();</a>
<a name="ln1260">		fContentsView-&gt;Clear();</a>
<a name="ln1261">	}</a>
<a name="ln1262"> </a>
<a name="ln1263">private:</a>
<a name="ln1264">	BCardLayout*		fLayout;</a>
<a name="ln1265"> </a>
<a name="ln1266">	AboutView*			fAboutView;</a>
<a name="ln1267">	UserRatingsView*	fUserRatingsView;</a>
<a name="ln1268">	ChangelogView*		fChangelogView;</a>
<a name="ln1269">	ContentsView* 		fContentsView;</a>
<a name="ln1270">};</a>
<a name="ln1271"> </a>
<a name="ln1272"> </a>
<a name="ln1273">// #pragma mark - PackageInfoView</a>
<a name="ln1274"> </a>
<a name="ln1275"> </a>
<a name="ln1276">PackageInfoView::PackageInfoView(BLocker* modelLock,</a>
<a name="ln1277">		PackageActionHandler* handler)</a>
<a name="ln1278">	:</a>
<a name="ln1279">	BView(&quot;package info view&quot;, 0),</a>
<a name="ln1280">	fModelLock(modelLock),</a>
<a name="ln1281">	fPackageListener(new(std::nothrow) OnePackageMessagePackageListener(this))</a>
<a name="ln1282">{</a>
<a name="ln1283">	fCardLayout = new BCardLayout();</a>
<a name="ln1284">	SetLayout(fCardLayout);</a>
<a name="ln1285"> </a>
<a name="ln1286">	BGroupView* noPackageCard = new BGroupView(&quot;no package card&quot;, B_VERTICAL);</a>
<a name="ln1287">	AddChild(noPackageCard);</a>
<a name="ln1288"> </a>
<a name="ln1289">	BStringView* noPackageView = new BStringView(&quot;no package view&quot;,</a>
<a name="ln1290">		B_TRANSLATE(&quot;Click a package to view information&quot;));</a>
<a name="ln1291">	noPackageView-&gt;SetHighColor(kLightBlack);</a>
<a name="ln1292">	noPackageView-&gt;SetExplicitAlignment(BAlignment(</a>
<a name="ln1293">		B_ALIGN_HORIZONTAL_CENTER, B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln1294"> </a>
<a name="ln1295">	BLayoutBuilder::Group&lt;&gt;(noPackageCard)</a>
<a name="ln1296">		.Add(noPackageView)</a>
<a name="ln1297">		.SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED))</a>
<a name="ln1298">	;</a>
<a name="ln1299"> </a>
<a name="ln1300">	BGroupView* packageCard = new BGroupView(&quot;package card&quot;, B_VERTICAL);</a>
<a name="ln1301">	AddChild(packageCard);</a>
<a name="ln1302"> </a>
<a name="ln1303">	fCardLayout-&gt;SetVisibleItem((int32)0);</a>
<a name="ln1304"> </a>
<a name="ln1305">	fTitleView = new TitleView();</a>
<a name="ln1306">	fPackageActionView = new PackageActionView(handler);</a>
<a name="ln1307">	fPackageActionView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED,</a>
<a name="ln1308">		B_SIZE_UNSET));</a>
<a name="ln1309">	fPagesView = new PagesView();</a>
<a name="ln1310"> </a>
<a name="ln1311">	BLayoutBuilder::Group&lt;&gt;(packageCard)</a>
<a name="ln1312">		.AddGroup(B_HORIZONTAL, 0.0f)</a>
<a name="ln1313">			.Add(fTitleView, 6.0f)</a>
<a name="ln1314">			.Add(fPackageActionView, 1.0f)</a>
<a name="ln1315">			.SetInsets(</a>
<a name="ln1316">				B_USE_DEFAULT_SPACING, 0.0f,</a>
<a name="ln1317">				B_USE_DEFAULT_SPACING, 0.0f)</a>
<a name="ln1318">		.End()</a>
<a name="ln1319">		.Add(fPagesView)</a>
<a name="ln1320">	;</a>
<a name="ln1321"> </a>
<a name="ln1322">	Clear();</a>
<a name="ln1323">}</a>
<a name="ln1324"> </a>
<a name="ln1325"> </a>
<a name="ln1326">PackageInfoView::~PackageInfoView()</a>
<a name="ln1327">{</a>
<a name="ln1328">	fPackageListener-&gt;SetPackage(PackageInfoRef(NULL));</a>
<a name="ln1329">	delete fPackageListener;</a>
<a name="ln1330">}</a>
<a name="ln1331"> </a>
<a name="ln1332"> </a>
<a name="ln1333">void</a>
<a name="ln1334">PackageInfoView::AttachedToWindow()</a>
<a name="ln1335">{</a>
<a name="ln1336">}</a>
<a name="ln1337"> </a>
<a name="ln1338"> </a>
<a name="ln1339">void</a>
<a name="ln1340">PackageInfoView::MessageReceived(BMessage* message)</a>
<a name="ln1341">{</a>
<a name="ln1342">	switch (message-&gt;what) {</a>
<a name="ln1343">		case MSG_UPDATE_PACKAGE:</a>
<a name="ln1344">		{</a>
<a name="ln1345">			if (fPackageListener-&gt;Package().Get() == NULL)</a>
<a name="ln1346">				break;</a>
<a name="ln1347"> </a>
<a name="ln1348">			BString name;</a>
<a name="ln1349">			uint32 changes;</a>
<a name="ln1350">			if (message-&gt;FindString(&quot;name&quot;, &amp;name) != B_OK</a>
<a name="ln1351">				|| message-&gt;FindUInt32(&quot;changes&quot;, &amp;changes) != B_OK) {</a>
<a name="ln1352">				break;</a>
<a name="ln1353">			}</a>
<a name="ln1354"> </a>
<a name="ln1355">			const PackageInfoRef&amp; package = fPackageListener-&gt;Package();</a>
<a name="ln1356">			if (package-&gt;Name() != name)</a>
<a name="ln1357">				break;</a>
<a name="ln1358"> </a>
<a name="ln1359">			BAutolock _(fModelLock);</a>
<a name="ln1360"> </a>
<a name="ln1361">			if ((changes &amp; PKG_CHANGED_SUMMARY) != 0</a>
<a name="ln1362">				|| (changes &amp; PKG_CHANGED_DESCRIPTION) != 0</a>
<a name="ln1363">				|| (changes &amp; PKG_CHANGED_SCREENSHOTS) != 0</a>
<a name="ln1364">				|| (changes &amp; PKG_CHANGED_TITLE) != 0</a>
<a name="ln1365">				|| (changes &amp; PKG_CHANGED_RATINGS) != 0</a>
<a name="ln1366">				|| (changes &amp; PKG_CHANGED_STATE) != 0</a>
<a name="ln1367">				|| (changes &amp; PKG_CHANGED_CHANGELOG) != 0) {</a>
<a name="ln1368">				fPagesView-&gt;SetPackage(package, false);</a>
<a name="ln1369">			}</a>
<a name="ln1370"> </a>
<a name="ln1371">			if ((changes &amp; PKG_CHANGED_TITLE) != 0</a>
<a name="ln1372">				|| (changes &amp; PKG_CHANGED_RATINGS) != 0) {</a>
<a name="ln1373">				fTitleView-&gt;SetPackage(*package.Get());</a>
<a name="ln1374">			}</a>
<a name="ln1375"> </a>
<a name="ln1376">			if ((changes &amp; PKG_CHANGED_STATE) != 0) {</a>
<a name="ln1377">				fPackageActionView-&gt;SetPackage(*package.Get());</a>
<a name="ln1378">			}</a>
<a name="ln1379"> </a>
<a name="ln1380">			break;</a>
<a name="ln1381">		}</a>
<a name="ln1382">		default:</a>
<a name="ln1383">			BView::MessageReceived(message);</a>
<a name="ln1384">			break;</a>
<a name="ln1385">	}</a>
<a name="ln1386">}</a>
<a name="ln1387"> </a>
<a name="ln1388"> </a>
<a name="ln1389">void</a>
<a name="ln1390">PackageInfoView::SetPackage(const PackageInfoRef&amp; packageRef)</a>
<a name="ln1391">{</a>
<a name="ln1392">	BAutolock _(fModelLock);</a>
<a name="ln1393"> </a>
<a name="ln1394">	if (packageRef.Get() == NULL) {</a>
<a name="ln1395">		Clear();</a>
<a name="ln1396">		return;</a>
<a name="ln1397">	}</a>
<a name="ln1398"> </a>
<a name="ln1399">	bool switchToDefaultTab = true;</a>
<a name="ln1400">	if (fPackage == packageRef) {</a>
<a name="ln1401">		// When asked to display the already showing package ref,</a>
<a name="ln1402">		// don't switch to the default tab.</a>
<a name="ln1403">		switchToDefaultTab = false;</a>
<a name="ln1404">	} else if (fPackage.Get() != NULL &amp;&amp; packageRef.Get() != NULL</a>
<a name="ln1405">		&amp;&amp; fPackage-&gt;Name() == packageRef-&gt;Name()) {</a>
<a name="ln1406">		// When asked to display a different PackageInfo instance,</a>
<a name="ln1407">		// but it has the same package title as the already showing</a>
<a name="ln1408">		// instance, this probably means there was a repository</a>
<a name="ln1409">		// refresh and we are in fact still requested to show the</a>
<a name="ln1410">		// same package as before the refresh.</a>
<a name="ln1411">		switchToDefaultTab = false;</a>
<a name="ln1412">	}</a>
<a name="ln1413"> </a>
<a name="ln1414">	const PackageInfo&amp; package = *packageRef.Get();</a>
<a name="ln1415"> </a>
<a name="ln1416">	fTitleView-&gt;SetPackage(package);</a>
<a name="ln1417">	fPackageActionView-&gt;SetPackage(package);</a>
<a name="ln1418">	fPagesView-&gt;SetPackage(packageRef, switchToDefaultTab);</a>
<a name="ln1419"> </a>
<a name="ln1420">	fCardLayout-&gt;SetVisibleItem(1);</a>
<a name="ln1421"> </a>
<a name="ln1422">	fPackageListener-&gt;SetPackage(packageRef);</a>
<a name="ln1423"> </a>
<a name="ln1424">	// Set the fPackage reference last, so we keep a reference to the</a>
<a name="ln1425">	// previous package before switching all the views to the new package.</a>
<a name="ln1426">	// Otherwise the PackageInfo instance may go away because we had the</a>
<a name="ln1427">	// last reference. And some of the views, the PackageActionView for</a>
<a name="ln1428">	// example, keeps references to stuff from the previous package and</a>
<a name="ln1429">	// access it while switching to the new package.</a>
<a name="ln1430">	fPackage = packageRef;</a>
<a name="ln1431">}</a>
<a name="ln1432"> </a>
<a name="ln1433"> </a>
<a name="ln1434">void</a>
<a name="ln1435">PackageInfoView::Clear()</a>
<a name="ln1436">{</a>
<a name="ln1437">	BAutolock _(fModelLock);</a>
<a name="ln1438"> </a>
<a name="ln1439">	fTitleView-&gt;Clear();</a>
<a name="ln1440">	fPackageActionView-&gt;Clear();</a>
<a name="ln1441">	fPagesView-&gt;Clear();</a>
<a name="ln1442"> </a>
<a name="ln1443">	fCardLayout-&gt;SetVisibleItem((int32)0);</a>
<a name="ln1444"> </a>
<a name="ln1445">	fPackageListener-&gt;SetPackage(PackageInfoRef(NULL));</a>
<a name="ln1446"> </a>
<a name="ln1447">	fPackage.Unset();</a>
<a name="ln1448">}</a>

</code></pre>
<div class="balloon" rel="636"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
