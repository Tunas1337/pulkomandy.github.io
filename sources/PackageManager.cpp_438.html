
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>PackageManager.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2013-2017, Haiku, Inc. All Rights Reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Ingo Weinhold &lt;ingo_weinhold@gmx.de&gt;</a>
<a name="ln7"> * 		Stephan AÃŸmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln8"> * 		Rene Gollent &lt;rene@gollent.com&gt;</a>
<a name="ln9"> *		Julian Harnath &lt;julian.harnath@rwth-aachen.de&gt;</a>
<a name="ln10"> */</a>
<a name="ln11"> </a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;PackageManager.h&quot;</a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;stdio.h&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;Alert.h&gt;</a>
<a name="ln18">#include &lt;Catalog.h&gt;</a>
<a name="ln19">#include &lt;Entry.h&gt;</a>
<a name="ln20">#include &lt;FindDirectory.h&gt;</a>
<a name="ln21">#include &lt;Path.h&gt;</a>
<a name="ln22">#include &lt;Roster.h&gt;</a>
<a name="ln23"> </a>
<a name="ln24">#include &lt;package/DownloadFileRequest.h&gt;</a>
<a name="ln25">#include &lt;package/manager/Exceptions.h&gt;</a>
<a name="ln26">#include &lt;package/RefreshRepositoryRequest.h&gt;</a>
<a name="ln27">#include &lt;package/hpkg/NoErrorOutput.h&gt;</a>
<a name="ln28">#include &lt;package/hpkg/PackageContentHandler.h&gt;</a>
<a name="ln29">#include &lt;package/hpkg/PackageEntry.h&gt;</a>
<a name="ln30">#include &lt;package/hpkg/PackageEntryAttribute.h&gt;</a>
<a name="ln31">#include &lt;package/hpkg/PackageInfoAttributeValue.h&gt;</a>
<a name="ln32">#include &lt;package/hpkg/PackageReader.h&gt;</a>
<a name="ln33">#include &lt;package/solver/SolverPackage.h&gt;</a>
<a name="ln34">#include &lt;package/solver/SolverProblem.h&gt;</a>
<a name="ln35">#include &lt;package/solver/SolverProblemSolution.h&gt;</a>
<a name="ln36"> </a>
<a name="ln37">#include &quot;AutoDeleter.h&quot;</a>
<a name="ln38">#include &quot;AutoLocker.h&quot;</a>
<a name="ln39">#include &quot;Model.h&quot;</a>
<a name="ln40">#include &quot;PackageInfo.h&quot;</a>
<a name="ln41">#include &quot;ProblemWindow.h&quot;</a>
<a name="ln42">#include &quot;ResultWindow.h&quot;</a>
<a name="ln43"> </a>
<a name="ln44"> </a>
<a name="ln45">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln46">#define B_TRANSLATION_CONTEXT &quot;PackageManager&quot;</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">using namespace BPackageKit;</a>
<a name="ln50">using namespace BPackageKit::BPrivate;</a>
<a name="ln51">using namespace BPackageKit::BManager::BPrivate;</a>
<a name="ln52"> </a>
<a name="ln53">using BPackageKit::BRefreshRepositoryRequest;</a>
<a name="ln54">using BPackageKit::DownloadFileRequest;</a>
<a name="ln55">using BPackageKit::BSolver;</a>
<a name="ln56">using BPackageKit::BSolverPackage;</a>
<a name="ln57">using BPackageKit::BSolverRepository;</a>
<a name="ln58">using BPackageKit::BHPKG::BNoErrorOutput;</a>
<a name="ln59">using BPackageKit::BHPKG::BPackageContentHandler;</a>
<a name="ln60">using BPackageKit::BHPKG::BPackageEntry;</a>
<a name="ln61">using BPackageKit::BHPKG::BPackageEntryAttribute;</a>
<a name="ln62">using BPackageKit::BHPKG::BPackageInfoAttributeValue;</a>
<a name="ln63">using BPackageKit::BHPKG::BPackageReader;</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">typedef std::set&lt;PackageInfoRef&gt; PackageInfoSet;</a>
<a name="ln67"> </a>
<a name="ln68"> </a>
<a name="ln69">// #pragma mark - PackageProgressListener</a>
<a name="ln70"> </a>
<a name="ln71"> </a>
<a name="ln72">PackageProgressListener::~PackageProgressListener()</a>
<a name="ln73">{</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76"> </a>
<a name="ln77">void</a>
<a name="ln78">PackageProgressListener::DownloadProgressChanged(const char* packageName,</a>
<a name="ln79">	float progress)</a>
<a name="ln80">{</a>
<a name="ln81">}</a>
<a name="ln82"> </a>
<a name="ln83"> </a>
<a name="ln84">void</a>
<a name="ln85">PackageProgressListener::DownloadProgressComplete(const char* packageName)</a>
<a name="ln86">{</a>
<a name="ln87">}</a>
<a name="ln88"> </a>
<a name="ln89"> </a>
<a name="ln90">void</a>
<a name="ln91">PackageProgressListener::ConfirmedChanges(</a>
<a name="ln92">	BPackageManager::InstalledRepository&amp; repository)</a>
<a name="ln93">{</a>
<a name="ln94">}</a>
<a name="ln95"> </a>
<a name="ln96"> </a>
<a name="ln97">void</a>
<a name="ln98">PackageProgressListener::StartApplyingChanges(</a>
<a name="ln99">	BPackageManager::InstalledRepository&amp; repository)</a>
<a name="ln100">{</a>
<a name="ln101">}</a>
<a name="ln102"> </a>
<a name="ln103"> </a>
<a name="ln104">void</a>
<a name="ln105">PackageProgressListener::ApplyingChangesDone(</a>
<a name="ln106">	BPackageManager::InstalledRepository&amp; repository)</a>
<a name="ln107">{</a>
<a name="ln108">}</a>
<a name="ln109"> </a>
<a name="ln110"> </a>
<a name="ln111"> </a>
<a name="ln112">// #pragma mark - InstallPackageAction</a>
<a name="ln113"> </a>
<a name="ln114"> </a>
<a name="ln115">class InstallPackageAction : public PackageAction,</a>
<a name="ln116">	private PackageProgressListener {</a>
<a name="ln117">public:</a>
<a name="ln118">	InstallPackageAction(PackageInfoRef package, Model* model)</a>
<a name="ln119">		:</a>
<a name="ln120">		PackageAction(PACKAGE_ACTION_INSTALL, package, model),</a>
<a name="ln121">		fLastDownloadUpdate(0)</a>
<a name="ln122">	{</a>
<a name="ln123">	}</a>
<a name="ln124"> </a>
<a name="ln125">	virtual const char* Label() const</a>
<a name="ln126">	{</a>
<a name="ln127">		return B_TRANSLATE(&quot;Install&quot;);</a>
<a name="ln128">	}</a>
<a name="ln129"> </a>
<a name="ln130">	virtual status_t Perform()</a>
<a name="ln131">	{</a>
<a name="ln132">		fPackageManager-&gt;Init(BPackageManager::B_ADD_INSTALLED_REPOSITORIES</a>
<a name="ln133">			| BPackageManager::B_ADD_REMOTE_REPOSITORIES</a>
<a name="ln134">			| BPackageManager::B_REFRESH_REPOSITORIES);</a>
<a name="ln135">		PackageInfoRef ref(Package());</a>
<a name="ln136">		PackageState state = ref-&gt;State();</a>
<a name="ln137">		ref-&gt;SetState(PENDING);</a>
<a name="ln138"> </a>
<a name="ln139">		fPackageManager-&gt;SetCurrentActionPackage(ref, true);</a>
<a name="ln140">		fPackageManager-&gt;AddProgressListener(this);</a>
<a name="ln141"> </a>
<a name="ln142">		BString packageName;</a>
<a name="ln143">		if (ref-&gt;IsLocalFile())</a>
<a name="ln144">			packageName = ref-&gt;LocalFilePath();</a>
<a name="ln145">		else</a>
<a name="ln146">			packageName = ref-&gt;Name();</a>
<a name="ln147"> </a>
<a name="ln148">		const char* packageNameString = packageName.String();</a>
<a name="ln149">		try {</a>
<a name="ln150">			fPackageManager-&gt;Install(&amp;packageNameString, 1);</a>
<a name="ln151">		} catch (BFatalErrorException ex) {</a>
<a name="ln152">			BString errorString;</a>
<a name="ln153">			errorString.SetToFormat(</a>
<a name="ln154">				&quot;Fatal error occurred while installing package %s: &quot;</a>
<a name="ln155">				&quot;%s (%s)\n&quot;, packageNameString, ex.Message().String(),</a>
<a name="ln156">				ex.Details().String());</a>
<a name="ln157">			BAlert* alert(new(std::nothrow) BAlert(B_TRANSLATE(&quot;Fatal error&quot;),</a>
<a name="ln158">				errorString, B_TRANSLATE(&quot;Close&quot;), NULL, NULL,</a>
<a name="ln159">				B_WIDTH_AS_USUAL, B_STOP_ALERT));</a>
<a name="ln160">			if (alert != NULL)</a>
<a name="ln161">				alert-&gt;Go();</a>
<a name="ln162">			_SetDownloadedPackagesState(NONE);</a>
<a name="ln163">			ref-&gt;SetState(state);</a>
<a name="ln164">			return ex.Error();</a>
<a name="ln165">		} catch (BAbortedByUserException ex) {</a>
<a name="ln166">			fprintf(stderr, &quot;Installation of package &quot;</a>
<a name="ln167">				&quot;%s aborted by user: %s\n&quot;, packageNameString,</a>
<a name="ln168">				ex.Message().String());</a>
<a name="ln169">			_SetDownloadedPackagesState(NONE);</a>
<a name="ln170">			ref-&gt;SetState(state);</a>
<a name="ln171">			return B_OK;</a>
<a name="ln172">		} catch (BNothingToDoException ex) {</a>
<a name="ln173">			fprintf(stderr, &quot;Nothing to do while installing package &quot;</a>
<a name="ln174">				&quot;%s: %s\n&quot;, packageNameString, ex.Message().String());</a>
<a name="ln175">			return B_OK;</a>
<a name="ln176">		} catch (BException ex) {</a>
<a name="ln177">			fprintf(stderr, &quot;Exception occurred while installing package &quot;</a>
<a name="ln178">				&quot;%s: %s\n&quot;, packageNameString, ex.Message().String());</a>
<a name="ln179">			_SetDownloadedPackagesState(NONE);</a>
<a name="ln180">			ref-&gt;SetState(state);</a>
<a name="ln181">			return B_ERROR;</a>
<a name="ln182">		}</a>
<a name="ln183"> </a>
<a name="ln184">		fPackageManager-&gt;RemoveProgressListener(this);</a>
<a name="ln185"> </a>
<a name="ln186">		_SetDownloadedPackagesState(ACTIVATED);</a>
<a name="ln187"> </a>
<a name="ln188">		return B_OK;</a>
<a name="ln189">	}</a>
<a name="ln190"> </a>
<a name="ln191">	// DownloadProgressListener</a>
<a name="ln192">	virtual void DownloadProgressChanged(const char* packageName,</a>
<a name="ln193">		float progress)</a>
<a name="ln194">	{</a>
<a name="ln195">		bigtime_t now = system_time();</a>
<a name="ln196">		if (now - fLastDownloadUpdate &gt; 250000 || progress == 1.0) {</a>
<a name="ln197">			BString tempName(packageName);</a>
<a name="ln198">			tempName.Truncate(tempName.FindFirst('-'));</a>
<a name="ln199">				// strip version suffix off package filename</a>
<a name="ln200">			PackageInfoRef ref(FindPackageByName(tempName));</a>
<a name="ln201">			if (ref.Get() != NULL) {</a>
<a name="ln202">				ref-&gt;SetDownloadProgress(progress);</a>
<a name="ln203">				fLastDownloadUpdate = now;</a>
<a name="ln204">			}</a>
<a name="ln205">		}</a>
<a name="ln206">	}</a>
<a name="ln207"> </a>
<a name="ln208">	virtual void DownloadProgressComplete(const char* packageName)</a>
<a name="ln209">	{</a>
<a name="ln210">		BString tempName(packageName);</a>
<a name="ln211">		tempName.Truncate(tempName.FindFirst('-'));</a>
<a name="ln212">			// strip version suffix off package filename</a>
<a name="ln213">		PackageInfoRef ref(FindPackageByName(tempName));</a>
<a name="ln214">		if (ref.Get() != NULL) {</a>
<a name="ln215">			ref-&gt;SetDownloadProgress(1.0);</a>
<a name="ln216">			fDownloadedPackages.insert(ref);</a>
<a name="ln217">		}</a>
<a name="ln218">	}</a>
<a name="ln219"> </a>
<a name="ln220">	virtual	void ConfirmedChanges(BPackageManager::InstalledRepository&amp;</a>
<a name="ln221">		repository)</a>
<a name="ln222">	{</a>
<a name="ln223">		BPackageManager::InstalledRepository::PackageList&amp; activationList =</a>
<a name="ln224">			repository.PackagesToActivate();</a>
<a name="ln225"> </a>
<a name="ln226">		BSolverPackage* package = NULL;</a>
<a name="ln227">		for (int32 i = 0; (package = activationList.ItemAt(i)); i++) {</a>
<a name="ln228">			PackageInfoRef ref(FindPackageByName(package-&gt;Info().Name()));</a>
<a name="ln229">			if (ref.Get() != NULL)</a>
<a name="ln230">				ref-&gt;SetState(PENDING);</a>
<a name="ln231">		}</a>
<a name="ln232">	}</a>
<a name="ln233"> </a>
<a name="ln234">private:</a>
<a name="ln235">	void _SetDownloadedPackagesState(PackageState state)</a>
<a name="ln236">	{</a>
<a name="ln237">		for (PackageInfoSet::iterator it = fDownloadedPackages.begin();</a>
<a name="ln238">				it != fDownloadedPackages.end(); ++it) {</a>
<a name="ln239">			(*it)-&gt;SetState(state);</a>
<a name="ln240">		}</a>
<a name="ln241">	}</a>
<a name="ln242"> </a>
<a name="ln243">private:</a>
<a name="ln244">	bigtime_t fLastDownloadUpdate;</a>
<a name="ln245">	PackageInfoSet fDownloadedPackages;</a>
<a name="ln246">};</a>
<a name="ln247"> </a>
<a name="ln248"> </a>
<a name="ln249">// #pragma mark - UninstallPackageAction</a>
<a name="ln250"> </a>
<a name="ln251"> </a>
<a name="ln252">class UninstallPackageAction : public PackageAction,</a>
<a name="ln253">	private PackageProgressListener {</a>
<a name="ln254">public:</a>
<a name="ln255">	UninstallPackageAction(PackageInfoRef package, Model* model)</a>
<a name="ln256">		:</a>
<a name="ln257">		PackageAction(PACKAGE_ACTION_UNINSTALL, package, model)</a>
<a name="ln258">	{</a>
<a name="ln259">	}</a>
<a name="ln260"> </a>
<a name="ln261">	virtual const char* Label() const</a>
<a name="ln262">	{</a>
<a name="ln263">		return B_TRANSLATE(&quot;Uninstall&quot;);</a>
<a name="ln264">	}</a>
<a name="ln265"> </a>
<a name="ln266">	virtual status_t Perform()</a>
<a name="ln267">	{</a>
<a name="ln268">		fPackageManager-&gt;Init(BPackageManager::B_ADD_INSTALLED_REPOSITORIES);</a>
<a name="ln269">		PackageInfoRef ref(Package());</a>
<a name="ln270">		PackageState state = ref-&gt;State();</a>
<a name="ln271">		fPackageManager-&gt;SetCurrentActionPackage(ref, false);</a>
<a name="ln272">		fPackageManager-&gt;AddProgressListener(this);</a>
<a name="ln273">		const char* packageName = ref-&gt;Name().String();</a>
<a name="ln274">		try {</a>
<a name="ln275">			fPackageManager-&gt;Uninstall(&amp;packageName, 1);</a>
<a name="ln276">		} catch (BFatalErrorException ex) {</a>
<a name="ln277">			BString errorString;</a>
<a name="ln278">			errorString.SetToFormat(</a>
<a name="ln279">				&quot;Fatal error occurred while uninstalling package %s: &quot;</a>
<a name="ln280">				&quot;%s (%s)\n&quot;, packageName, ex.Message().String(),</a>
<a name="ln281">				ex.Details().String());</a>
<a name="ln282">			BAlert* alert(new(std::nothrow) BAlert(B_TRANSLATE(&quot;Fatal error&quot;),</a>
<a name="ln283">				errorString, B_TRANSLATE(&quot;Close&quot;), NULL, NULL,</a>
<a name="ln284">				B_WIDTH_AS_USUAL, B_STOP_ALERT));</a>
<a name="ln285">			if (alert != NULL)</a>
<a name="ln286">				alert-&gt;Go();</a>
<a name="ln287">			ref-&gt;SetState(state);</a>
<a name="ln288">			return ex.Error();</a>
<a name="ln289">		} catch (BAbortedByUserException ex) {</a>
<a name="ln290">			return B_OK;</a>
<a name="ln291">		} catch (BNothingToDoException ex) {</a>
<a name="ln292">			return B_OK;</a>
<a name="ln293">		} catch (BException ex) {</a>
<a name="ln294">			fprintf(stderr, &quot;Exception occurred while uninstalling package &quot;</a>
<a name="ln295">				&quot;%s: %s\n&quot;, packageName, ex.Message().String());</a>
<a name="ln296">			ref-&gt;SetState(state);</a>
<a name="ln297">			return B_ERROR;</a>
<a name="ln298">		}</a>
<a name="ln299"> </a>
<a name="ln300">		fPackageManager-&gt;RemoveProgressListener(this);</a>
<a name="ln301"> </a>
<a name="ln302">		ref-&gt;SetState(NONE);</a>
<a name="ln303"> </a>
<a name="ln304">		return B_OK;</a>
<a name="ln305">	}</a>
<a name="ln306"> </a>
<a name="ln307">	void StartApplyingChanges(</a>
<a name="ln308">		BPackageManager::InstalledRepository&amp; repository)</a>
<a name="ln309">	{</a>
<a name="ln310">		BPackageManager::InstalledRepository::PackageList&amp; packages</a>
<a name="ln311">			= repository.PackagesToDeactivate();</a>
<a name="ln312">		for (int32 i = 0; i &lt; packages.CountItems(); i++) {</a>
<a name="ln313">			PackageInfoRef ref(FindPackageByName(packages.ItemAt(i)</a>
<a name="ln314">					-&gt;Name()));</a>
<a name="ln315">			if (ref.Get() != NULL)</a>
<a name="ln316">				fRemovedPackages.Add(ref);</a>
<a name="ln317">		}</a>
<a name="ln318">	}</a>
<a name="ln319"> </a>
<a name="ln320">	void ApplyingChangesDone(</a>
<a name="ln321">		BPackageManager::InstalledRepository&amp; repository)</a>
<a name="ln322">	{</a>
<a name="ln323">		for (int32 i = 0; i &lt; fRemovedPackages.CountItems(); i++)</a>
<a name="ln324">			fRemovedPackages.ItemAt(i)-&gt;SetState(NONE);</a>
<a name="ln325">	}</a>
<a name="ln326"> </a>
<a name="ln327">private:</a>
<a name="ln328">	PackageList fRemovedPackages;</a>
<a name="ln329">};</a>
<a name="ln330"> </a>
<a name="ln331"> </a>
<a name="ln332">// #pragma mark - OpenPackageAction</a>
<a name="ln333"> </a>
<a name="ln334"> </a>
<a name="ln335">struct DeskbarLink {</a>
<a name="ln336">	DeskbarLink()</a>
<a name="ln337">	{</a>
<a name="ln338">	}</a>
<a name="ln339"> </a>
<a name="ln340">	DeskbarLink(const BString&amp; path, const BString&amp; link)</a>
<a name="ln341">		:</a>
<a name="ln342">		path(path),</a>
<a name="ln343">		link(link)</a>
<a name="ln344">	{</a>
<a name="ln345">	}</a>
<a name="ln346"> </a>
<a name="ln347">	DeskbarLink(const DeskbarLink&amp; other)</a>
<a name="ln348">		:</a>
<a name="ln349">		path(other.path),</a>
<a name="ln350">		link(other.link)</a>
<a name="ln351">	{</a>
<a name="ln352">	}</a>
<a name="ln353"> </a>
<a name="ln354">	DeskbarLink&amp; operator=(const DeskbarLink&amp; other)</a>
<a name="ln355">	{</a>
<a name="ln356">		if (this == &amp;other)</a>
<a name="ln357">			return *this;</a>
<a name="ln358">		path = other.path;</a>
<a name="ln359">		link = other.link;</a>
<a name="ln360">		return *this;</a>
<a name="ln361">	}</a>
<a name="ln362"> </a>
<a name="ln363">	bool operator==(const DeskbarLink&amp; other)</a>
<a name="ln364">	{</a>
<a name="ln365">		return path == other.path &amp;&amp; link == other.link;</a>
<a name="ln366">	}</a>
<a name="ln367"> </a>
<a name="ln368">	bool operator!=(const DeskbarLink&amp; other)</a>
<a name="ln369">	{</a>
<a name="ln370">		return !(*this == other);</a>
<a name="ln371">	}</a>
<a name="ln372"> </a>
<a name="ln373">	BString	path;</a>
<a name="ln374">	BString	link;</a>
<a name="ln375">};</a>
<a name="ln376"> </a>
<a name="ln377"> </a>
<a name="ln378">typedef List&lt;DeskbarLink, false&gt; DeskbarLinkList;</a>
<a name="ln379"> </a>
<a name="ln380"> </a>
<a name="ln381">class DeskbarLinkFinder : public BPackageContentHandler {</a>
<a name="ln382">public:</a>
<a name="ln383">	DeskbarLinkFinder(DeskbarLinkList&amp; foundLinks)</a>
<a name="ln384">		:</a>
<a name="ln385">		fDeskbarLinks(foundLinks)</a>
<a name="ln386">	{</a>
<a name="ln387">	}</a>
<a name="ln388"> </a>
<a name="ln389">	virtual status_t HandleEntry(BPackageEntry* entry)</a>
<a name="ln390">	{</a>
<a name="ln391">		BString path = MakePath(entry);</a>
<a name="ln392">		if (path.FindFirst(&quot;data/deskbar/menu&quot;) == 0</a>
<a name="ln393">			&amp;&amp; entry-&gt;SymlinkPath() != NULL) {</a>
<a name="ln394">			printf(&quot;found deskbar entry: %s -&gt; %s\n&quot;, path.String(),</a>
<a name="ln395">				entry-&gt;SymlinkPath());</a>
<a name="ln396">			fDeskbarLinks.Add(DeskbarLink(path, entry-&gt;SymlinkPath()));</a>
<a name="ln397">		}</a>
<a name="ln398">		return B_OK;</a>
<a name="ln399">	}</a>
<a name="ln400"> </a>
<a name="ln401">	virtual status_t HandleEntryAttribute(BPackageEntry* entry,</a>
<a name="ln402">		BPackageEntryAttribute* attribute)</a>
<a name="ln403">	{</a>
<a name="ln404">		return B_OK;</a>
<a name="ln405">	}</a>
<a name="ln406"> </a>
<a name="ln407">	virtual status_t HandleEntryDone(BPackageEntry* entry)</a>
<a name="ln408">	{</a>
<a name="ln409">		return B_OK;</a>
<a name="ln410">	}</a>
<a name="ln411"> </a>
<a name="ln412">	virtual status_t HandlePackageAttribute(</a>
<a name="ln413">		const BPackageInfoAttributeValue&amp; value)</a>
<a name="ln414">	{</a>
<a name="ln415">		return B_OK;</a>
<a name="ln416">	}</a>
<a name="ln417"> </a>
<a name="ln418">	virtual void HandleErrorOccurred()</a>
<a name="ln419">	{</a>
<a name="ln420">	}</a>
<a name="ln421"> </a>
<a name="ln422">	BString MakePath(const BPackageEntry* entry)</a>
<a name="ln423">	{</a>
<a name="ln424">		BString path;</a>
<a name="ln425">		while (entry != NULL) {</a>
<a name="ln426">			if (!path.IsEmpty())</a>
<a name="ln427">				path.Prepend('/', 1);</a>
<a name="ln428">			path.Prepend(entry-&gt;Name());</a>
<a name="ln429">			entry = entry-&gt;Parent();</a>
<a name="ln430">		}</a>
<a name="ln431">		return path;</a>
<a name="ln432">	}</a>
<a name="ln433"> </a>
<a name="ln434">private:</a>
<a name="ln435">	DeskbarLinkList&amp;	fDeskbarLinks;</a>
<a name="ln436">};</a>
<a name="ln437"> </a>
<a name="ln438"> </a>
<a name="ln439">class OpenPackageAction : public PackageAction {</a>
<a name="ln440">public:</a>
<a name="ln441">	OpenPackageAction(PackageInfoRef package, Model* model,</a>
<a name="ln442">		const DeskbarLink&amp; link)</a>
<a name="ln443">		:</a>
<a name="ln444">		PackageAction(PACKAGE_ACTION_OPEN, package, model),</a>
<a name="ln445">		fDeskbarLink(link),</a>
<a name="ln446">		fLabel(B_TRANSLATE(&quot;Open %DeskbarLink%&quot;))</a>
<a name="ln447">	{</a>
<a name="ln448">		BString target = fDeskbarLink.link;</a>
<a name="ln449">		int32 lastPathSeparator = target.FindLast('/');</a>
<a name="ln450">		if (lastPathSeparator &gt; 0 &amp;&amp; lastPathSeparator + 1 &lt; target.Length())</a>
<a name="ln451">			target.Remove(0, lastPathSeparator + 1);</a>
<a name="ln452"> </a>
<a name="ln453">		fLabel.ReplaceAll(&quot;%DeskbarLink%&quot;, target);</a>
<a name="ln454">	}</a>
<a name="ln455"> </a>
<a name="ln456">	virtual const char* Label() const</a>
<a name="ln457">	{</a>
<a name="ln458">		return fLabel;</a>
<a name="ln459">	}</a>
<a name="ln460"> </a>
<a name="ln461">	virtual status_t Perform()</a>
<a name="ln462">	{</a>
<a name="ln463">		status_t status;</a>
<a name="ln464">		BPath path;</a>
<a name="ln465">		if (fDeskbarLink.link.FindFirst('/') == 0) {</a>
<a name="ln466">			status = path.SetTo(fDeskbarLink.link);</a>
<a name="ln467">			printf(&quot;trying to launch (absolute link): %s\n&quot;, path.Path());</a>
<a name="ln468">		} else {</a>
<a name="ln469">			int32 location = InstallLocation();</a>
<a name="ln470">			if (location == B_PACKAGE_INSTALLATION_LOCATION_SYSTEM) {</a>
<a name="ln471">				status = find_directory(B_SYSTEM_DIRECTORY, &amp;path);</a>
<a name="ln472">				if (status != B_OK)</a>
<a name="ln473">					return status;</a>
<a name="ln474">			} else if (location == B_PACKAGE_INSTALLATION_LOCATION_HOME) {</a>
<a name="ln475">				status = find_directory(B_USER_DIRECTORY, &amp;path);</a>
<a name="ln476">				if (status != B_OK)</a>
<a name="ln477">					return status;</a>
<a name="ln478">			} else {</a>
<a name="ln479">				return B_ERROR;</a>
<a name="ln480">			}</a>
<a name="ln481"> </a>
<a name="ln482">			status = path.Append(fDeskbarLink.path);</a>
<a name="ln483">			if (status == B_OK)</a>
<a name="ln484">				status = path.GetParent(&amp;path);</a>
<a name="ln485">			if (status == B_OK) {</a>
<a name="ln486">				status = path.Append(fDeskbarLink.link, true);</a>
<a name="ln487">				printf(&quot;trying to launch: %s\n&quot;, path.Path());</a>
<a name="ln488">			}</a>
<a name="ln489">		}</a>
<a name="ln490"> </a>
<a name="ln491">		entry_ref ref;</a>
<a name="ln492">		if (status == B_OK)</a>
<a name="ln493">			status = get_ref_for_path(path.Path(), &amp;ref);</a>
<a name="ln494"> </a>
<a name="ln495">		if (status == B_OK)</a>
<a name="ln496">			status = be_roster-&gt;Launch(&amp;ref);</a>
<a name="ln497"> </a>
<a name="ln498">		return status;</a>
<a name="ln499">	}</a>
<a name="ln500"> </a>
<a name="ln501">	static bool FindAppToLaunch(const PackageInfoRef&amp; package,</a>
<a name="ln502">		DeskbarLinkList&amp; foundLinks)</a>
<a name="ln503">	{</a>
<a name="ln504">		if (package.Get() == NULL)</a>
<a name="ln505">			return false;</a>
<a name="ln506"> </a>
<a name="ln507">		int32 installLocation = InstallLocation(package);</a>
<a name="ln508"> </a>
<a name="ln509">		BPath packagePath;</a>
<a name="ln510">		if (installLocation == B_PACKAGE_INSTALLATION_LOCATION_SYSTEM) {</a>
<a name="ln511">			if (find_directory(B_SYSTEM_PACKAGES_DIRECTORY, &amp;packagePath)</a>
<a name="ln512">				!= B_OK) {</a>
<a name="ln513">				return false;</a>
<a name="ln514">			}</a>
<a name="ln515">		} else if (installLocation == B_PACKAGE_INSTALLATION_LOCATION_HOME) {</a>
<a name="ln516">			if (find_directory(B_USER_PACKAGES_DIRECTORY, &amp;packagePath)</a>
<a name="ln517">				!= B_OK) {</a>
<a name="ln518">				return false;</a>
<a name="ln519">			}</a>
<a name="ln520">		} else {</a>
<a name="ln521">			printf(&quot;OpenPackageAction::FindAppToLaunch(): &quot;</a>
<a name="ln522">				&quot;unknown install location&quot;);</a>
<a name="ln523">			return false;</a>
<a name="ln524">		}</a>
<a name="ln525"> </a>
<a name="ln526">		packagePath.Append(package-&gt;FileName());</a>
<a name="ln527"> </a>
<a name="ln528">		BNoErrorOutput errorOutput;</a>
<a name="ln529">		BPackageReader reader(&amp;errorOutput);</a>
<a name="ln530"> </a>
<a name="ln531">		status_t status = reader.Init(packagePath.Path());</a>
<a name="ln532">		if (status != B_OK) {</a>
<a name="ln533">			printf(&quot;OpenPackageAction::FindAppToLaunch(): &quot;</a>
<a name="ln534">				&quot;failed to init BPackageReader(%s): %s\n&quot;,</a>
<a name="ln535">				packagePath.Path(), strerror(status));</a>
<a name="ln536">			return false;</a>
<a name="ln537">		}</a>
<a name="ln538"> </a>
<a name="ln539">		// Scan package contents for Deskbar links</a>
<a name="ln540">		DeskbarLinkFinder contentHandler(foundLinks);</a>
<a name="ln541">		status = reader.ParseContent(&amp;contentHandler);</a>
<a name="ln542">		if (status != B_OK) {</a>
<a name="ln543">			printf(&quot;OpenPackageAction::FindAppToLaunch(): &quot;</a>
<a name="ln544">				&quot;failed parse package contents (%s): %s\n&quot;,</a>
<a name="ln545">				packagePath.Path(), strerror(status));</a>
<a name="ln546">			return false;</a>
<a name="ln547">		}</a>
<a name="ln548"> </a>
<a name="ln549">		return foundLinks.CountItems() &gt; 0;</a>
<a name="ln550">	}</a>
<a name="ln551"> </a>
<a name="ln552">private:</a>
<a name="ln553">	DeskbarLink		fDeskbarLink;</a>
<a name="ln554">	BString			fLabel;</a>
<a name="ln555">};</a>
<a name="ln556"> </a>
<a name="ln557"> </a>
<a name="ln558">// #pragma mark - PackageManager</a>
<a name="ln559"> </a>
<a name="ln560"> </a>
<a name="ln561">PackageManager::PackageManager(BPackageInstallationLocation location)</a>
<a name="ln562">	:</a>
<a name="ln563">	BPackageManager(location, &amp;fClientInstallationInterface, this),</a>
<a name="ln564">	BPackageManager::UserInteractionHandler(),</a>
<a name="ln565">	fDecisionProvider(),</a>
<a name="ln566">	fClientInstallationInterface(),</a>
<a name="ln567">	fProblemWindow(NULL),</a>
<a name="ln568">	fCurrentInstallPackage(NULL),</a>
<a name="ln569">	fCurrentUninstallPackage(NULL)</a>
<a name="ln570">{</a>
<a name="ln571">}</a>
<a name="ln572"> </a>
<a name="ln573"> </a>
<a name="ln574">PackageManager::~PackageManager()</a>
<a name="ln575">{</a>
<a name="ln576">	if (fProblemWindow != NULL)</a>
<a name="ln577">		fProblemWindow-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln578">}</a>
<a name="ln579"> </a>
<a name="ln580"> </a>
<a name="ln581">PackageState</a>
<a name="ln582">PackageManager::GetPackageState(const PackageInfo&amp; package)</a>
<a name="ln583">{</a>
<a name="ln584">	// TODO: Fetch information from the PackageKit</a>
<a name="ln585">	return NONE;</a>
<a name="ln586">}</a>
<a name="ln587"> </a>
<a name="ln588"> </a>
<a name="ln589">PackageActionList</a>
<a name="ln590">PackageManager::GetPackageActions(PackageInfoRef package, Model* model)</a>
<a name="ln591">{</a>
<a name="ln592">	PackageActionList actionList;</a>
<a name="ln593">	if (package-&gt;IsSystemPackage() || package-&gt;IsSystemDependency())</a>
<a name="ln594">		return actionList;</a>
<a name="ln595"> </a>
<a name="ln596">	int32 state = package-&gt;State();</a>
<a name="ln597">	if (state == ACTIVATED || state == INSTALLED) {</a>
<a name="ln598">		actionList.Add(PackageActionRef(new UninstallPackageAction(</a>
<a name="ln599">			package, model), true));</a>
<a name="ln600"> </a>
<a name="ln601">		// Add OpenPackageActions for each deskbar link found in the</a>
<a name="ln602">		// package</a>
<a name="ln603">		DeskbarLinkList foundLinks;</a>
<a name="ln604">		if (OpenPackageAction::FindAppToLaunch(package, foundLinks)</a>
<a name="ln605">			&amp;&amp; foundLinks.CountItems() &lt; 4) {</a>
<a name="ln606">			for (int32 i = 0; i &lt; foundLinks.CountItems(); i++) {</a>
<a name="ln607">				const DeskbarLink&amp; link = foundLinks.ItemAtFast(i);</a>
<a name="ln608">				actionList.Add(PackageActionRef(new OpenPackageAction(</a>
<a name="ln609">					package, model, link), true));</a>
<a name="ln610">			}</a>
<a name="ln611">		}</a>
<a name="ln612">	} else if (state == NONE || state == UNINSTALLED) {</a>
<a name="ln613">		actionList.Add(PackageActionRef(new InstallPackageAction(package,</a>
<a name="ln614">				model),	true));</a>
<a name="ln615">	}</a>
<a name="ln616">	// TODO: activation status</a>
<a name="ln617"> </a>
<a name="ln618">	return actionList;</a>
<a name="ln619">}</a>
<a name="ln620"> </a>
<a name="ln621"> </a>
<a name="ln622">void</a>
<a name="ln623">PackageManager::SetCurrentActionPackage(PackageInfoRef package, bool install)</a>
<a name="ln624">{</a>
<a name="ln625">	BSolverPackage* solverPackage = _GetSolverPackage(package);</a>
<a name="ln626">	fCurrentInstallPackage = install ? solverPackage : NULL;</a>
<a name="ln627">	fCurrentUninstallPackage = install ? NULL : solverPackage;</a>
<a name="ln628">}</a>
<a name="ln629"> </a>
<a name="ln630"> </a>
<a name="ln631">status_t</a>
<a name="ln632">PackageManager::RefreshRepository(const BRepositoryConfig&amp; repoConfig)</a>
<a name="ln633">{</a>
<a name="ln634">	status_t result;</a>
<a name="ln635">	try {</a>
<a name="ln636">		result = BPackageManager::RefreshRepository(repoConfig);</a>
<a name="ln637">	} catch (BFatalErrorException ex) {</a>
<a name="ln638">		fprintf(stderr, &quot;Fatal error occurred while refreshing repository: &quot;</a>
<a name="ln639">			&quot;%s (%s)\n&quot;, ex.Message().String(), ex.Details().String());</a>
<a name="ln640">		result = ex.Error();</a>
<a name="ln641">	} catch (BException ex) {</a>
<a name="ln642">		fprintf(stderr, &quot;Exception occurred while refreshing &quot;</a>
<a name="ln643">			&quot;repository: %s\n&quot;, ex.Message().String());</a>
<a name="ln644">		result = B_ERROR;</a>
<a name="ln645">	}</a>
<a name="ln646"> </a>
<a name="ln647">	return result;</a>
<a name="ln648">}</a>
<a name="ln649"> </a>
<a name="ln650"> </a>
<a name="ln651">status_t</a>
<a name="ln652">PackageManager::DownloadPackage(const BString&amp; fileURL,</a>
<a name="ln653">	const BEntry&amp; targetEntry, const BString&amp; checksum)</a>
<a name="ln654">{</a>
<a name="ln655">	status_t result;</a>
<a name="ln656">	try {</a>
<a name="ln657">		result = BPackageManager::DownloadPackage(fileURL, targetEntry,</a>
<a name="ln658">			checksum);</a>
<a name="ln659">	} catch (BFatalErrorException ex) {</a>
<a name="ln660">		fprintf(stderr, &quot;Fatal error occurred while downloading package: &quot;</a>
<a name="ln661">			&quot;%s: %s (%s)\n&quot;, fileURL.String(), ex.Message().String(),</a>
<a name="ln662">			ex.Details().String());</a>
<a name="ln663">		result = ex.Error();</a>
<a name="ln664">	} catch (BException ex) {</a>
<a name="ln665">		fprintf(stderr, &quot;Exception occurred while downloading package &quot;</a>
<a name="ln666">			&quot;%s: %s\n&quot;, fileURL.String(), ex.Message().String());</a>
<a name="ln667">		result = B_ERROR;</a>
<a name="ln668">	}</a>
<a name="ln669"> </a>
<a name="ln670">	return result;</a>
<a name="ln671">}</a>
<a name="ln672"> </a>
<a name="ln673"> </a>
<a name="ln674">void</a>
<a name="ln675">PackageManager::AddProgressListener(PackageProgressListener* listener)</a>
<a name="ln676">{</a>
<a name="ln677">	fPackageProgressListeners.AddItem(listener);</a>
<a name="ln678">}</a>
<a name="ln679"> </a>
<a name="ln680"> </a>
<a name="ln681">void</a>
<a name="ln682">PackageManager::RemoveProgressListener(PackageProgressListener* listener)</a>
<a name="ln683">{</a>
<a name="ln684">	fPackageProgressListeners.RemoveItem(listener);</a>
<a name="ln685">}</a>
<a name="ln686"> </a>
<a name="ln687"> </a>
<a name="ln688">void</a>
<a name="ln689">PackageManager::HandleProblems()</a>
<a name="ln690">{</a>
<a name="ln691">	if (fProblemWindow == NULL)</a>
<a name="ln692">		fProblemWindow = new ProblemWindow;</a>
<a name="ln693"> </a>
<a name="ln694">	ProblemWindow::SolverPackageSet installPackages;</a>
<a name="ln695">	ProblemWindow::SolverPackageSet uninstallPackages;</a>
<a name="ln696">	if (fCurrentInstallPackage != NULL)</a>
<a name="ln697">		installPackages.insert(fCurrentInstallPackage);</a>
<a name="ln698"> </a>
<a name="ln699">	if (fCurrentUninstallPackage != NULL)</a>
<a name="ln700">		uninstallPackages.insert(fCurrentUninstallPackage);</a>
<a name="ln701"> </a>
<a name="ln702">	if (!fProblemWindow-&gt;Go(fSolver,installPackages, uninstallPackages))</a>
<a name="ln703">		throw BAbortedByUserException();</a>
<a name="ln704">}</a>
<a name="ln705"> </a>
<a name="ln706"> </a>
<a name="ln707">void</a>
<a name="ln708">PackageManager::ConfirmChanges(bool fromMostSpecific)</a>
<a name="ln709">{</a>
<a name="ln710">	ResultWindow* window = new ResultWindow;</a>
<a name="ln711">	ObjectDeleter&lt;ResultWindow&gt; windowDeleter(window);</a>
<a name="ln712"> </a>
<a name="ln713">	bool hasOtherChanges = false;</a>
<a name="ln714">	int32 count = fInstalledRepositories.CountItems();</a>
<a name="ln715"> </a>
<a name="ln716">	if (fromMostSpecific) {</a>
<a name="ln717">		for (int32 i = count - 1; i &gt;= 0; i--)</a>
<a name="ln718">			hasOtherChanges</a>
<a name="ln719">				|= _AddResults(*fInstalledRepositories.ItemAt(i), window);</a>
<a name="ln720">	} else {</a>
<a name="ln721">		for (int32 i = 0; i &lt; count; i++)</a>
<a name="ln722">			hasOtherChanges</a>
<a name="ln723">				|= _AddResults(*fInstalledRepositories.ItemAt(i), window);</a>
<a name="ln724">	}</a>
<a name="ln725"> </a>
<a name="ln726">	if (!hasOtherChanges) {</a>
<a name="ln727">		_NotifyChangesConfirmed();</a>
<a name="ln728">		return;</a>
<a name="ln729">	}</a>
<a name="ln730"> </a>
<a name="ln731">	// show the window</a>
<a name="ln732">	if (windowDeleter.Detach()-&gt;Go() == 0)</a>
<a name="ln733">		throw BAbortedByUserException();</a>
<a name="ln734"> </a>
<a name="ln735">	_NotifyChangesConfirmed();</a>
<a name="ln736">}</a>
<a name="ln737"> </a>
<a name="ln738"> </a>
<a name="ln739">void</a>
<a name="ln740">PackageManager::Warn(status_t error, const char* format, ...)</a>
<a name="ln741">{</a>
<a name="ln742">	// TODO: Show alert to user</a>
<a name="ln743"> </a>
<a name="ln744">	va_list args;</a>
<a name="ln745">	va_start(args, format);</a>
<a name="ln746">	vfprintf(stderr, format, args);</a>
<a name="ln747">	va_end(args);</a>
<a name="ln748"> </a>
<a name="ln749">	if (error == B_OK)</a>
<a name="ln750">		printf(&quot;\n&quot;);</a>
<a name="ln751">	else</a>
<a name="ln752">		printf(&quot;: %s\n&quot;, strerror(error));</a>
<a name="ln753">}</a>
<a name="ln754"> </a>
<a name="ln755"> </a>
<a name="ln756">void</a>
<a name="ln757">PackageManager::ProgressPackageDownloadStarted(const char* packageName)</a>
<a name="ln758">{</a>
<a name="ln759">	ProgressPackageDownloadActive(packageName, 0.0f, 0, 0);</a>
<a name="ln760">}</a>
<a name="ln761"> </a>
<a name="ln762"> </a>
<a name="ln763">void</a>
<a name="ln764">PackageManager::ProgressPackageDownloadActive(const char* packageName,</a>
<a name="ln765">	float completionPercentage, off_t bytes, off_t totalBytes)</a>
<a name="ln766">{</a>
<a name="ln767">	for (int32 i = 0; i &lt; fPackageProgressListeners.CountItems(); i++) {</a>
<a name="ln768">		fPackageProgressListeners.ItemAt(i)-&gt;DownloadProgressChanged(</a>
<a name="ln769">			packageName, completionPercentage);</a>
<a name="ln770">	}</a>
<a name="ln771">}</a>
<a name="ln772"> </a>
<a name="ln773"> </a>
<a name="ln774">void</a>
<a name="ln775">PackageManager::ProgressPackageDownloadComplete(const char* packageName)</a>
<a name="ln776">{</a>
<a name="ln777">	for (int32 i = 0; i &lt; fPackageProgressListeners.CountItems(); i++) {</a>
<a name="ln778">		fPackageProgressListeners.ItemAt(i)-&gt;DownloadProgressComplete(</a>
<a name="ln779">			packageName);</a>
<a name="ln780">	}</a>
<a name="ln781">}</a>
<a name="ln782"> </a>
<a name="ln783"> </a>
<a name="ln784">void</a>
<a name="ln785">PackageManager::ProgressPackageChecksumStarted(const char* title)</a>
<a name="ln786">{</a>
<a name="ln787">	// TODO: implement</a>
<a name="ln788">}</a>
<a name="ln789"> </a>
<a name="ln790"> </a>
<a name="ln791">void</a>
<a name="ln792">PackageManager::ProgressPackageChecksumComplete(const char* title)</a>
<a name="ln793">{</a>
<a name="ln794">	// TODO: implement</a>
<a name="ln795">}</a>
<a name="ln796"> </a>
<a name="ln797"> </a>
<a name="ln798">void</a>
<a name="ln799">PackageManager::ProgressStartApplyingChanges(InstalledRepository&amp; repository)</a>
<a name="ln800">{</a>
<a name="ln801">	for (int32 i = 0; i &lt; fPackageProgressListeners.CountItems(); i++)</a>
<a name="ln802">		fPackageProgressListeners.ItemAt(i)-&gt;StartApplyingChanges(repository);</a>
<a name="ln803">}</a>
<a name="ln804"> </a>
<a name="ln805"> </a>
<a name="ln806">void</a>
<a name="ln807">PackageManager::ProgressTransactionCommitted(InstalledRepository&amp; repository,</a>
<a name="ln808">	const BCommitTransactionResult&amp; result)</a>
<a name="ln809">{</a>
<a name="ln810">	// TODO: implement</a>
<a name="ln811">}</a>
<a name="ln812"> </a>
<a name="ln813"> </a>
<a name="ln814">void</a>
<a name="ln815">PackageManager::ProgressApplyingChangesDone(InstalledRepository&amp; repository)</a>
<a name="ln816">{</a>
<a name="ln817">	for (int32 i = 0; i &lt; fPackageProgressListeners.CountItems(); i++)</a>
<a name="ln818">		fPackageProgressListeners.ItemAt(i)-&gt;ApplyingChangesDone(repository);</a>
<a name="ln819"> </a>
<a name="ln820">	if (BPackageRoster().IsRebootNeeded()) {</a>
<a name="ln821">		BString infoString(B_TRANSLATE(&quot;A reboot is necessary to complete the &quot;</a>
<a name="ln822">			&quot;installation process.&quot;));</a>
<a name="ln823">		BAlert* alert = new(std::nothrow) BAlert(B_TRANSLATE(&quot;Reboot required&quot;),</a>
<a name="ln824">			infoString, B_TRANSLATE(&quot;Close&quot;), NULL, NULL,</a>
<a name="ln825">			B_WIDTH_AS_USUAL, B_INFO_ALERT);</a>
<a name="ln826">		if (alert != NULL)</a>
<a name="ln827">			alert-&gt;Go();</a>
<a name="ln828">	}</a>
<a name="ln829">}</a>
<a name="ln830"> </a>
<a name="ln831"> </a>
<a name="ln832">bool</a>
<a name="ln833">PackageManager::_AddResults(InstalledRepository&amp; repository,</a>
<a name="ln834">	ResultWindow* window)</a>
<a name="ln835">{</a>
<a name="ln836">	if (!repository.HasChanges())</a>
<a name="ln837">		return false;</a>
<a name="ln838"> </a>
<a name="ln839">	ProblemWindow::SolverPackageSet installPackages;</a>
<a name="ln840">	ProblemWindow::SolverPackageSet uninstallPackages;</a>
<a name="ln841">	if (fCurrentInstallPackage != NULL)</a>
<a name="ln842">		installPackages.insert(fCurrentInstallPackage);</a>
<a name="ln843"> </a>
<a name="ln844">	if (fCurrentUninstallPackage != NULL)</a>
<a name="ln845">		uninstallPackages.insert(fCurrentUninstallPackage);</a>
<a name="ln846"> </a>
<a name="ln847">	return window-&gt;AddLocationChanges(repository.Name(),</a>
<a name="ln848">		repository.PackagesToActivate(), installPackages,</a>
<a name="ln849">		repository.PackagesToDeactivate(), uninstallPackages);</a>
<a name="ln850">}</a>
<a name="ln851"> </a>
<a name="ln852"> </a>
<a name="ln853">void</a>
<a name="ln854">PackageManager::_NotifyChangesConfirmed()</a>
<a name="ln855">{</a>
<a name="ln856">	int32 count = fInstalledRepositories.CountItems();</a>
<a name="ln857">	for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln858">		for (int32 j = 0; j &lt; fPackageProgressListeners.CountItems(); j++) {</a>
<a name="ln859">			fPackageProgressListeners.ItemAt(j)-&gt;ConfirmedChanges(</a>
<a name="ln860">				*fInstalledRepositories.ItemAt(i));</a>
<a name="ln861">		}</a>
<a name="ln862">	}</a>
<a name="ln863">}</a>
<a name="ln864"> </a>
<a name="ln865"> </a>
<a name="ln866">BSolverPackage*</a>
<a name="ln867">PackageManager::_GetSolverPackage(PackageInfoRef package)</a>
<a name="ln868">{</a>
<a name="ln869">	int32 flags = BSolver::B_FIND_IN_NAME;</a>
<a name="ln870">	if (package-&gt;State() == ACTIVATED || package-&gt;State() == INSTALLED)</a>
<a name="ln871">		flags |= BSolver::B_FIND_INSTALLED_ONLY;</a>
<a name="ln872"> </a>
<a name="ln873">	BObjectList&lt;BSolverPackage&gt; packages;</a>
<a name="ln874">	status_t result = Solver()-&gt;FindPackages(package-&gt;Name(), flags, packages);</a>
<a name="ln875">	if (result == B_OK) {</a>
<a name="ln876">		for (int32 i = 0; i &lt; packages.CountItems(); i++) {</a>
<a name="ln877">			BSolverPackage* solverPackage = packages.ItemAt(i);</a>
<a name="ln878">			if (solverPackage-&gt;Name() != package-&gt;Name())</a>
<a name="ln879">				continue;</a>
<a name="ln880">			else if (package-&gt;State() == NONE</a>
<a name="ln881">				&amp;&amp; dynamic_cast&lt;BPackageManager::RemoteRepository*&gt;(</a>
<a name="ln882">					solverPackage-&gt;Repository()) == NULL) {</a>
<a name="ln883">				continue;</a>
<a name="ln884">			}</a>
<a name="ln885">			return solverPackage;</a>
<a name="ln886">		}</a>
<a name="ln887">	}</a>
<a name="ln888"> </a>
<a name="ln889">	return NULL;</a>
<a name="ln890">}</a>

</code></pre>
<div class="balloon" rel="164"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="288"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="828"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
