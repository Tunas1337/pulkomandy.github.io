
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>BackgroundsView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2002-2017 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Axel Dörfler, axeld@pinc-software.de</a>
<a name="ln7"> *		Jerome Duval, jerome.duval@free.fr</a>
<a name="ln8"> *		Jonas Sundström, jonas@kirilla.se</a>
<a name="ln9"> *		John Scipione, jscipione@gmail.com</a>
<a name="ln10"> *		Brian Hill &lt;supernova@warpmail.net&gt;</a>
<a name="ln11"> */</a>
<a name="ln12"> </a>
<a name="ln13"> </a>
<a name="ln14">#include &quot;BackgroundsView.h&quot;</a>
<a name="ln15"> </a>
<a name="ln16">#include &lt;algorithm&gt;</a>
<a name="ln17"> </a>
<a name="ln18">#include &lt;stdio.h&gt;</a>
<a name="ln19">#include &lt;stdlib.h&gt;</a>
<a name="ln20"> </a>
<a name="ln21">#include &lt;Alert.h&gt;</a>
<a name="ln22">#include &lt;Bitmap.h&gt;</a>
<a name="ln23">#include &lt;Catalog.h&gt;</a>
<a name="ln24">#include &lt;ControlLook.h&gt;</a>
<a name="ln25">#include &lt;Cursor.h&gt;</a>
<a name="ln26">#include &lt;Debug.h&gt;</a>
<a name="ln27">#include &lt;File.h&gt;</a>
<a name="ln28">#include &lt;FindDirectory.h&gt;</a>
<a name="ln29">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln30">#include &lt;Locale.h&gt;</a>
<a name="ln31">#include &lt;MenuField.h&gt;</a>
<a name="ln32">#include &lt;Messenger.h&gt;</a>
<a name="ln33">#include &lt;MimeType.h&gt;</a>
<a name="ln34">#include &lt;Point.h&gt;</a>
<a name="ln35">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln36"> </a>
<a name="ln37">#include &lt;be_apps/Tracker/Background.h&gt;</a>
<a name="ln38">#include &lt;ScreenDefs.h&gt;</a>
<a name="ln39"> </a>
<a name="ln40">#include &quot;ImageFilePanel.h&quot;</a>
<a name="ln41"> </a>
<a name="ln42"> </a>
<a name="ln43">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln44">#define B_TRANSLATION_CONTEXT &quot;Main View&quot;</a>
<a name="ln45"> </a>
<a name="ln46"> </a>
<a name="ln47">static const uint32 kMsgApplySettings = 'aply';</a>
<a name="ln48">static const uint32 kMsgRevertSettings = 'rvrt';</a>
<a name="ln49"> </a>
<a name="ln50">static const uint32 kMsgUpdateColor = 'upcl';</a>
<a name="ln51">static const uint32 kMsgAllWorkspaces = 'alwk';</a>
<a name="ln52">static const uint32 kMsgCurrentWorkspace = 'crwk';</a>
<a name="ln53">static const uint32 kMsgDefaultFolder = 'dffl';</a>
<a name="ln54">static const uint32 kMsgOtherFolder = 'otfl';</a>
<a name="ln55">static const uint32 kMsgNoImage = 'noim';</a>
<a name="ln56">static const uint32 kMsgOtherImage = 'otim';</a>
<a name="ln57">static const uint32 kMsgImageSelected = 'imsl';</a>
<a name="ln58">static const uint32 kMsgFolderSelected = 'flsl';</a>
<a name="ln59"> </a>
<a name="ln60">static const uint32 kMsgCenterPlacement = 'cnpl';</a>
<a name="ln61">static const uint32 kMsgManualPlacement = 'mnpl';</a>
<a name="ln62">static const uint32 kMsgScalePlacement = 'scpl';</a>
<a name="ln63">static const uint32 kMsgTilePlacement = 'tlpl';</a>
<a name="ln64">static const uint32 kMsgIconLabelOutline = 'ilol';</a>
<a name="ln65"> </a>
<a name="ln66">static const uint32 kMsgImagePlacement = 'xypl';</a>
<a name="ln67">static const uint32 kMsgUpdatePreviewPlacement = 'pvpl';</a>
<a name="ln68"> </a>
<a name="ln69"> </a>
<a name="ln70">BackgroundsView::BackgroundsView()</a>
<a name="ln71">	:</a>
<a name="ln72">	BBox(&quot;BackgroundsView&quot;),</a>
<a name="ln73">	fCurrent(NULL),</a>
<a name="ln74">	fCurrentInfo(NULL),</a>
<a name="ln75">	fLastImageIndex(-1),</a>
<a name="ln76">	fRecentFoldersLimit(10),</a>
<a name="ln77">	fPathList(1, true),</a>
<a name="ln78">	fImageList(1, true),</a>
<a name="ln79">	fFoundPositionSetting(false)</a>
<a name="ln80">{</a>
<a name="ln81">	SetBorder(B_NO_BORDER);</a>
<a name="ln82"> </a>
<a name="ln83">	BBox* previewBox = new BBox(&quot;preview&quot;);</a>
<a name="ln84">	previewBox-&gt;SetLabel(B_TRANSLATE(&quot;Preview&quot;));</a>
<a name="ln85"> </a>
<a name="ln86">	fPreview = new Preview();</a>
<a name="ln87"> </a>
<a name="ln88">	fTopLeft = new FramePart(FRAME_TOP_LEFT);</a>
<a name="ln89">	fTop = new FramePart(FRAME_TOP);</a>
<a name="ln90">	fTopRight = new FramePart(FRAME_TOP_RIGHT);</a>
<a name="ln91">	fLeft = new FramePart(FRAME_LEFT_SIDE);</a>
<a name="ln92">	fRight = new FramePart(FRAME_RIGHT_SIDE);</a>
<a name="ln93">	fBottomLeft = new FramePart(FRAME_BOTTOM_LEFT);</a>
<a name="ln94">	fBottom = new FramePart(FRAME_BOTTOM);</a>
<a name="ln95">	fBottomRight = new FramePart(FRAME_BOTTOM_RIGHT);</a>
<a name="ln96"> </a>
<a name="ln97">	fXPlacementText = new BTextControl(B_TRANSLATE(&quot;X:&quot;), NULL,</a>
<a name="ln98">		new BMessage(kMsgImagePlacement));</a>
<a name="ln99">	fYPlacementText = new BTextControl(B_TRANSLATE(&quot;Y:&quot;), NULL,</a>
<a name="ln100">		new BMessage(kMsgImagePlacement));</a>
<a name="ln101"> </a>
<a name="ln102">	fXPlacementText-&gt;TextView()-&gt;SetMaxBytes(5);</a>
<a name="ln103">	fYPlacementText-&gt;TextView()-&gt;SetMaxBytes(5);</a>
<a name="ln104"> </a>
<a name="ln105">	for (int32 i = 0; i &lt; 256; i++) {</a>
<a name="ln106">		if ((i &lt; '0' || i &gt; '9') &amp;&amp; i != '-') {</a>
<a name="ln107">			fXPlacementText-&gt;TextView()-&gt;DisallowChar(i);</a>
<a name="ln108">			fYPlacementText-&gt;TextView()-&gt;DisallowChar(i);</a>
<a name="ln109">		}</a>
<a name="ln110">	}</a>
<a name="ln111"> </a>
<a name="ln112">	previewBox-&gt;AddChild(BLayoutBuilder::Group&lt;&gt;()</a>
<a name="ln113">		.AddGlue()</a>
<a name="ln114">		.AddGroup(B_VERTICAL, 0)</a>
<a name="ln115">			.AddGroup(B_HORIZONTAL, 0)</a>
<a name="ln116">				.AddGlue()</a>
<a name="ln117">				.AddGrid(0, 0, 1)</a>
<a name="ln118">					.Add(fTopLeft, 0, 0)</a>
<a name="ln119">					.Add(fTop, 1, 0)</a>
<a name="ln120">					.Add(fTopRight, 2, 0)</a>
<a name="ln121">					.Add(fLeft, 0, 1)</a>
<a name="ln122">					.Add(fPreview, 1, 1)</a>
<a name="ln123">					.Add(fRight, 2, 1)</a>
<a name="ln124">					.Add(fBottomLeft, 0, 2)</a>
<a name="ln125">					.Add(fBottom, 1, 2)</a>
<a name="ln126">					.Add(fBottomRight, 2, 2)</a>
<a name="ln127">					.End()</a>
<a name="ln128">				.AddGlue()</a>
<a name="ln129">				.End()</a>
<a name="ln130">			.AddStrut(be_control_look-&gt;DefaultItemSpacing() * 2)</a>
<a name="ln131">			.AddGroup(B_HORIZONTAL)</a>
<a name="ln132">				.Add(fXPlacementText)</a>
<a name="ln133">				.Add(fYPlacementText)</a>
<a name="ln134">				.End()</a>
<a name="ln135">			.AddGlue()</a>
<a name="ln136">			.SetInsets(B_USE_DEFAULT_SPACING)</a>
<a name="ln137">			.End()</a>
<a name="ln138">		.AddGlue()</a>
<a name="ln139">		.View());</a>
<a name="ln140"> </a>
<a name="ln141">	BBox* rightbox = new BBox(&quot;rightbox&quot;);</a>
<a name="ln142"> </a>
<a name="ln143">	fWorkspaceMenu = new BPopUpMenu(B_TRANSLATE(&quot;pick one&quot;));</a>
<a name="ln144">	fWorkspaceMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;All workspaces&quot;),</a>
<a name="ln145">		new BMessage(kMsgAllWorkspaces)));</a>
<a name="ln146">	BMenuItem* menuItem;</a>
<a name="ln147">	fWorkspaceMenu-&gt;AddItem(menuItem = new BMenuItem(</a>
<a name="ln148">		B_TRANSLATE(&quot;Current workspace&quot;),</a>
<a name="ln149">		new BMessage(kMsgCurrentWorkspace)));</a>
<a name="ln150">	menuItem-&gt;SetMarked(true);</a>
<a name="ln151">	fWorkspaceMenu-&gt;AddSeparatorItem();</a>
<a name="ln152">	fWorkspaceMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Default folder&quot;),</a>
<a name="ln153">		new BMessage(kMsgDefaultFolder)));</a>
<a name="ln154">	fWorkspaceMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln155">		B_TRANSLATE(&quot;Other folder&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln156">		new BMessage(kMsgOtherFolder)));</a>
<a name="ln157"> </a>
<a name="ln158">	BMenuField* workspaceMenuField = new BMenuField(&quot;workspaceMenuField&quot;,</a>
<a name="ln159">		NULL, fWorkspaceMenu);</a>
<a name="ln160">	workspaceMenuField-&gt;ResizeToPreferred();</a>
<a name="ln161">	rightbox-&gt;SetLabel(workspaceMenuField);</a>
<a name="ln162"> </a>
<a name="ln163">	fImageMenu = new BPopUpMenu(B_TRANSLATE(&quot;pick one&quot;));</a>
<a name="ln164">	fImageMenu-&gt;AddItem(new BGImageMenuItem(B_TRANSLATE(&quot;None&quot;), -1,</a>
<a name="ln165">		new BMessage(kMsgNoImage)));</a>
<a name="ln166">	fImageMenu-&gt;AddSeparatorItem();</a>
<a name="ln167">	fImageMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Other&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln168">		new BMessage(kMsgOtherImage)));</a>
<a name="ln169"> </a>
<a name="ln170">	BMenuField* imageMenuField = new BMenuField(&quot;image&quot;,</a>
<a name="ln171">		B_TRANSLATE(&quot;Image:&quot;), fImageMenu);</a>
<a name="ln172">	imageMenuField-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln173"> </a>
<a name="ln174">	fPlacementMenu = new BPopUpMenu(B_TRANSLATE(&quot;pick one&quot;));</a>
<a name="ln175">	fPlacementMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Manual&quot;),</a>
<a name="ln176">		new BMessage(kMsgManualPlacement)));</a>
<a name="ln177">	fPlacementMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Center&quot;),</a>
<a name="ln178">		new BMessage(kMsgCenterPlacement)));</a>
<a name="ln179">	fPlacementMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Scale to fit&quot;),</a>
<a name="ln180">		new BMessage(kMsgScalePlacement)));</a>
<a name="ln181">	fPlacementMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Tile&quot;),</a>
<a name="ln182">		new BMessage(kMsgTilePlacement)));</a>
<a name="ln183"> </a>
<a name="ln184">	BMenuField* placementMenuField = new BMenuField(&quot;placement&quot;,</a>
<a name="ln185">		B_TRANSLATE(&quot;Placement:&quot;), fPlacementMenu);</a>
<a name="ln186">	placementMenuField-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln187"> </a>
<a name="ln188">	fIconLabelOutline = new BCheckBox(B_TRANSLATE(&quot;Icon label outline&quot;),</a>
<a name="ln189">		new BMessage(kMsgIconLabelOutline));</a>
<a name="ln190">	fIconLabelOutline-&gt;SetValue(B_CONTROL_OFF);</a>
<a name="ln191"> </a>
<a name="ln192">	fPicker = new BColorControl(BPoint(0, 0), B_CELLS_32x8, 8.0, &quot;Picker&quot;,</a>
<a name="ln193">		new BMessage(kMsgUpdateColor));</a>
<a name="ln194"> </a>
<a name="ln195">	rightbox-&gt;AddChild(BLayoutBuilder::Group&lt;&gt;(B_VERTICAL)</a>
<a name="ln196">		.AddGroup(B_HORIZONTAL, 0.0f)</a>
<a name="ln197">			.AddGrid(B_USE_DEFAULT_SPACING, B_USE_SMALL_SPACING)</a>
<a name="ln198">				.Add(imageMenuField-&gt;CreateLabelLayoutItem(), 0, 0)</a>
<a name="ln199">				.AddGroup(B_HORIZONTAL, 0.0f, 1, 0)</a>
<a name="ln200">					.Add(imageMenuField-&gt;CreateMenuBarLayoutItem(), 0.0f)</a>
<a name="ln201">					.AddGlue()</a>
<a name="ln202">					.End()</a>
<a name="ln203">				.Add(placementMenuField-&gt;CreateLabelLayoutItem(), 0, 1)</a>
<a name="ln204">				.AddGroup(B_HORIZONTAL, 0.0f, 1, 1)</a>
<a name="ln205">					.Add(placementMenuField-&gt;CreateMenuBarLayoutItem(), 0.0f)</a>
<a name="ln206">					.AddGlue()</a>
<a name="ln207">					.End()</a>
<a name="ln208">				.Add(fIconLabelOutline, 1, 2)</a>
<a name="ln209">				.End()</a>
<a name="ln210">			.AddGlue()</a>
<a name="ln211">			.End()</a>
<a name="ln212">		.AddGlue()</a>
<a name="ln213">		.Add(fPicker)</a>
<a name="ln214">		.SetInsets(B_USE_DEFAULT_SPACING)</a>
<a name="ln215">		.View());</a>
<a name="ln216"> </a>
<a name="ln217">	fRevert = new BButton(B_TRANSLATE(&quot;Revert&quot;),</a>
<a name="ln218">		new BMessage(kMsgRevertSettings));</a>
<a name="ln219">	fApply = new BButton(B_TRANSLATE(&quot;Apply&quot;),</a>
<a name="ln220">		new BMessage(kMsgApplySettings));</a>
<a name="ln221"> </a>
<a name="ln222">	fRevert-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln223">		B_ALIGN_NO_VERTICAL));</a>
<a name="ln224">	fApply-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_RIGHT,</a>
<a name="ln225">		B_ALIGN_NO_VERTICAL));</a>
<a name="ln226"> </a>
<a name="ln227">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln228">		.SetInsets(B_USE_WINDOW_SPACING)</a>
<a name="ln229">		.AddGroup(B_HORIZONTAL, 0)</a>
<a name="ln230">			.AddGroup(B_VERTICAL, 0)</a>
<a name="ln231">				.AddStrut(floorf(rightbox-&gt;TopBorderOffset()</a>
<a name="ln232">					- previewBox-&gt;TopBorderOffset()) - 1)</a>
<a name="ln233">				.Add(previewBox)</a>
<a name="ln234">				.End()</a>
<a name="ln235">			.AddStrut(B_USE_DEFAULT_SPACING)</a>
<a name="ln236">			.Add(rightbox)</a>
<a name="ln237">			.End()</a>
<a name="ln238">		.AddGroup(B_HORIZONTAL, 0)</a>
<a name="ln239">			.Add(fRevert)</a>
<a name="ln240">			.Add(fApply)</a>
<a name="ln241">			.SetInsets(0, B_USE_DEFAULT_SPACING, 0,	0)</a>
<a name="ln242">			.End();</a>
<a name="ln243"> </a>
<a name="ln244">	fApply-&gt;MakeDefault(true);</a>
<a name="ln245">}</a>
<a name="ln246"> </a>
<a name="ln247"> </a>
<a name="ln248">BackgroundsView::~BackgroundsView()</a>
<a name="ln249">{</a>
<a name="ln250">	// The order matter. The last panel saves the state</a>
<a name="ln251">	delete fFolderPanel;</a>
<a name="ln252">	delete fPanel;</a>
<a name="ln253">}</a>
<a name="ln254"> </a>
<a name="ln255"> </a>
<a name="ln256">void</a>
<a name="ln257">BackgroundsView::AllAttached()</a>
<a name="ln258">{</a>
<a name="ln259">	fPlacementMenu-&gt;SetTargetForItems(this);</a>
<a name="ln260">	fImageMenu-&gt;SetTargetForItems(this);</a>
<a name="ln261">	fWorkspaceMenu-&gt;SetTargetForItems(this);</a>
<a name="ln262">	fXPlacementText-&gt;SetTarget(this);</a>
<a name="ln263">	fYPlacementText-&gt;SetTarget(this);</a>
<a name="ln264">	fIconLabelOutline-&gt;SetTarget(this);</a>
<a name="ln265">	fPicker-&gt;SetTarget(this);</a>
<a name="ln266">	fApply-&gt;SetTarget(this);</a>
<a name="ln267">	fRevert-&gt;SetTarget(this);</a>
<a name="ln268"> </a>
<a name="ln269">	BPath path;</a>
<a name="ln270">	entry_ref ref;</a>
<a name="ln271">	if (find_directory(B_SYSTEM_DATA_DIRECTORY, &amp;path) == B_OK) {</a>
<a name="ln272">		path.Append(&quot;artwork&quot;);</a>
<a name="ln273">		get_ref_for_path(path.Path(), &amp;ref);</a>
<a name="ln274">	}</a>
<a name="ln275"> </a>
<a name="ln276">	BMessenger messenger(this);</a>
<a name="ln277">	fPanel = new ImageFilePanel(B_OPEN_PANEL, &amp;messenger, &amp;ref,</a>
<a name="ln278">		B_FILE_NODE, false, NULL, new CustomRefFilter(true));</a>
<a name="ln279">	fPanel-&gt;SetButtonLabel(B_DEFAULT_BUTTON, B_TRANSLATE(&quot;Select&quot;));</a>
<a name="ln280"> </a>
<a name="ln281">	fFolderPanel = new BFilePanel(B_OPEN_PANEL, &amp;messenger, NULL,</a>
<a name="ln282">		B_DIRECTORY_NODE, false, NULL, new CustomRefFilter(false));</a>
<a name="ln283">	fFolderPanel-&gt;SetButtonLabel(B_DEFAULT_BUTTON, B_TRANSLATE(&quot;Select&quot;));</a>
<a name="ln284"> </a>
<a name="ln285">	_LoadSettings();</a>
<a name="ln286">	_LoadDesktopFolder();</a>
<a name="ln287"> </a>
<a name="ln288">	BPoint point;</a>
<a name="ln289">	if (fSettings.FindPoint(&quot;pos&quot;, &amp;point) == B_OK) {</a>
<a name="ln290">		fFoundPositionSetting = true;</a>
<a name="ln291">		Window()-&gt;MoveTo(point);</a>
<a name="ln292">	}</a>
<a name="ln293"> </a>
<a name="ln294">	fApply-&gt;SetEnabled(false);</a>
<a name="ln295">	fRevert-&gt;SetEnabled(false);</a>
<a name="ln296">}</a>
<a name="ln297"> </a>
<a name="ln298"> </a>
<a name="ln299">void</a>
<a name="ln300">BackgroundsView::MessageReceived(BMessage* message)</a>
<a name="ln301">{</a>
<a name="ln302">	// Color drop</a>
<a name="ln303">	if (message-&gt;WasDropped()) {</a>
<a name="ln304">		rgb_color *clr;</a>
<a name="ln305">		ssize_t out_size;</a>
<a name="ln306">		if (message-&gt;FindData(&quot;RGBColor&quot;, B_RGB_COLOR_TYPE,</a>
<a name="ln307">			(const void **)&amp;clr, &amp;out_size) == B_OK) {</a>
<a name="ln308">			fPicker-&gt;SetValue(*clr);</a>
<a name="ln309">			_UpdatePreview();</a>
<a name="ln310">			_UpdateButtons();</a>
<a name="ln311">			return;</a>
<a name="ln312">		}</a>
<a name="ln313">	}</a>
<a name="ln314"> </a>
<a name="ln315">	switch (message-&gt;what) {</a>
<a name="ln316">		case B_SIMPLE_DATA:</a>
<a name="ln317">		case B_REFS_RECEIVED:</a>
<a name="ln318">			RefsReceived(message);</a>
<a name="ln319">			break;</a>
<a name="ln320"> </a>
<a name="ln321">		case kMsgUpdatePreviewPlacement:</a>
<a name="ln322">		{</a>
<a name="ln323">			BString xstring, ystring;</a>
<a name="ln324">			xstring &lt;&lt; (int)fPreview-&gt;fPoint.x;</a>
<a name="ln325">			ystring &lt;&lt; (int)fPreview-&gt;fPoint.y;</a>
<a name="ln326">			fXPlacementText-&gt;SetText(xstring.String());</a>
<a name="ln327">			fYPlacementText-&gt;SetText(ystring.String());</a>
<a name="ln328">			_UpdatePreview();</a>
<a name="ln329">			_UpdateButtons();</a>
<a name="ln330">			break;</a>
<a name="ln331">		}</a>
<a name="ln332"> </a>
<a name="ln333">		case kMsgManualPlacement:</a>
<a name="ln334">		case kMsgTilePlacement:</a>
<a name="ln335">		case kMsgScalePlacement:</a>
<a name="ln336">		case kMsgCenterPlacement:</a>
<a name="ln337">			_UpdatePreview();</a>
<a name="ln338">			_UpdateButtons();</a>
<a name="ln339">			break;</a>
<a name="ln340"> </a>
<a name="ln341">		case kMsgIconLabelOutline:</a>
<a name="ln342">			_UpdateButtons();</a>
<a name="ln343">			break;</a>
<a name="ln344"> </a>
<a name="ln345">		case kMsgUpdateColor:</a>
<a name="ln346">		case kMsgImagePlacement:</a>
<a name="ln347">			_UpdatePreview();</a>
<a name="ln348">			_UpdateButtons();</a>
<a name="ln349">			break;</a>
<a name="ln350"> </a>
<a name="ln351">		case kMsgCurrentWorkspace:</a>
<a name="ln352">		case kMsgAllWorkspaces:</a>
<a name="ln353">			fImageMenu-&gt;FindItem(kMsgNoImage)-&gt;SetLabel(B_TRANSLATE(&quot;None&quot;));</a>
<a name="ln354">			if (fCurrent &amp;&amp; fCurrent-&gt;IsDesktop()) {</a>
<a name="ln355">				_UpdateButtons();</a>
<a name="ln356">			} else {</a>
<a name="ln357">				_SetDesktop(true);</a>
<a name="ln358">				_LoadDesktopFolder();</a>
<a name="ln359">			}</a>
<a name="ln360">			break;</a>
<a name="ln361"> </a>
<a name="ln362">		case kMsgDefaultFolder:</a>
<a name="ln363">			fImageMenu-&gt;FindItem(kMsgNoImage)-&gt;SetLabel(B_TRANSLATE(&quot;None&quot;));</a>
<a name="ln364">			_SetDesktop(false);</a>
<a name="ln365">			_LoadDefaultFolder();</a>
<a name="ln366">			break;</a>
<a name="ln367"> </a>
<a name="ln368">		case kMsgOtherFolder:</a>
<a name="ln369">			fFolderPanel-&gt;Show();</a>
<a name="ln370">			break;</a>
<a name="ln371"> </a>
<a name="ln372">		case kMsgOtherImage:</a>
<a name="ln373">			fPanel-&gt;Show();</a>
<a name="ln374">			break;</a>
<a name="ln375"> </a>
<a name="ln376">		case B_CANCEL:</a>
<a name="ln377">		{</a>
<a name="ln378">			PRINT((&quot;cancel received\n&quot;));</a>
<a name="ln379">			void* pointer;</a>
<a name="ln380">			message-&gt;FindPointer(&quot;source&quot;, &amp;pointer);</a>
<a name="ln381">			if (pointer == fPanel) {</a>
<a name="ln382">				if (fLastImageIndex &gt;= 0)</a>
<a name="ln383">					_FindImageItem(fLastImageIndex)-&gt;SetMarked(true);</a>
<a name="ln384">				else</a>
<a name="ln385">					fImageMenu-&gt;ItemAt(0)-&gt;SetMarked(true);</a>
<a name="ln386">			}</a>
<a name="ln387">			break;</a>
<a name="ln388">		}</a>
<a name="ln389"> </a>
<a name="ln390">		case kMsgImageSelected:</a>
<a name="ln391">		case kMsgNoImage:</a>
<a name="ln392">			fLastImageIndex = ((BGImageMenuItem*)fImageMenu-&gt;FindMarked())</a>
<a name="ln393">				-&gt;ImageIndex();</a>
<a name="ln394">			_UpdatePreview();</a>
<a name="ln395">			_UpdateButtons();</a>
<a name="ln396">			break;</a>
<a name="ln397"> </a>
<a name="ln398">		case kMsgFolderSelected:</a>
<a name="ln399">		{</a>
<a name="ln400">			fImageMenu-&gt;FindItem(kMsgNoImage)-&gt;SetLabel(B_TRANSLATE(&quot;Default&quot;));</a>
<a name="ln401">			_SetDesktop(false);</a>
<a name="ln402">			BString folderPathStr;</a>
<a name="ln403">			if (message-&gt;FindString(&quot;folderPath&quot;, &amp;folderPathStr) == B_OK) {</a>
<a name="ln404">				BPath folderPath(folderPathStr);</a>
<a name="ln405">				_LoadRecentFolder(folderPath);</a>
<a name="ln406">			}</a>
<a name="ln407">			break;</a>
<a name="ln408">		}</a>
<a name="ln409">		case kMsgApplySettings:</a>
<a name="ln410">		{</a>
<a name="ln411">			_Save();</a>
<a name="ln412"> </a>
<a name="ln413">			// Notify the server and Screen preflet</a>
<a name="ln414">			thread_id notify_thread;</a>
<a name="ln415">			notify_thread = spawn_thread(BackgroundsView::_NotifyThread,</a>
<a name="ln416">				&quot;notifyThread&quot;, B_NORMAL_PRIORITY, this);</a>
<a name="ln417">			resume_thread(notify_thread);</a>
<a name="ln418">			_UpdateButtons();</a>
<a name="ln419">			break;</a>
<a name="ln420">		}</a>
<a name="ln421">		case kMsgRevertSettings:</a>
<a name="ln422">			_UpdateWithCurrent();</a>
<a name="ln423">			break;</a>
<a name="ln424"> </a>
<a name="ln425">		default:</a>
<a name="ln426">			BView::MessageReceived(message);</a>
<a name="ln427">			break;</a>
<a name="ln428">	}</a>
<a name="ln429">}</a>
<a name="ln430"> </a>
<a name="ln431"> </a>
<a name="ln432">void</a>
<a name="ln433">BackgroundsView::_LoadDesktopFolder()</a>
<a name="ln434">{</a>
<a name="ln435">	BPath path;</a>
<a name="ln436">	if (find_directory(B_DESKTOP_DIRECTORY, &amp;path) == B_OK) {</a>
<a name="ln437">		status_t err;</a>
<a name="ln438">		err = get_ref_for_path(path.Path(), &amp;fCurrentRef);</a>
<a name="ln439">		if (err != B_OK)</a>
<a name="ln440">			printf(&quot;error in LoadDesktopSettings\n&quot;);</a>
<a name="ln441">		_LoadFolder(true);</a>
<a name="ln442">	}</a>
<a name="ln443">}</a>
<a name="ln444"> </a>
<a name="ln445"> </a>
<a name="ln446">void</a>
<a name="ln447">BackgroundsView::_LoadDefaultFolder()</a>
<a name="ln448">{</a>
<a name="ln449">	BPath path;</a>
<a name="ln450">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path) == B_OK) {</a>
<a name="ln451">		BString pathString = path.Path();</a>
<a name="ln452">		pathString &lt;&lt; &quot;/Tracker/DefaultFolderTemplate&quot;;</a>
<a name="ln453">		status_t err;</a>
<a name="ln454">		err = get_ref_for_path(pathString.String(), &amp;fCurrentRef);</a>
<a name="ln455">		if (err != B_OK)</a>
<a name="ln456">			printf(&quot;error in LoadDefaultFolderSettings\n&quot;);</a>
<a name="ln457">		_LoadFolder(false);</a>
<a name="ln458">	}</a>
<a name="ln459">}</a>
<a name="ln460"> </a>
<a name="ln461"> </a>
<a name="ln462">void</a>
<a name="ln463">BackgroundsView::_LoadRecentFolder(BPath path)</a>
<a name="ln464">{</a>
<a name="ln465">	status_t err;</a>
<a name="ln466">	err = get_ref_for_path(path.Path(), &amp;fCurrentRef);</a>
<a name="ln467">	if (err != B_OK)</a>
<a name="ln468">		printf(&quot;error in LoadRecentFolder\n&quot;);</a>
<a name="ln469">	_LoadFolder(false);</a>
<a name="ln470">}</a>
<a name="ln471"> </a>
<a name="ln472"> </a>
<a name="ln473">void</a>
<a name="ln474">BackgroundsView::_LoadFolder(bool isDesktop)</a>
<a name="ln475">{</a>
<a name="ln476">	if (fCurrent) {</a>
<a name="ln477">		delete fCurrent;</a>
<a name="ln478">		fCurrent = NULL;</a>
<a name="ln479">	}</a>
<a name="ln480"> </a>
<a name="ln481">	BNode node(&amp;fCurrentRef);</a>
<a name="ln482">	if (node.InitCheck() == B_OK)</a>
<a name="ln483">		fCurrent = BackgroundImage::GetBackgroundImage(&amp;node, isDesktop, this);</a>
<a name="ln484"> </a>
<a name="ln485">	_UpdateWithCurrent();</a>
<a name="ln486">}</a>
<a name="ln487"> </a>
<a name="ln488"> </a>
<a name="ln489">void</a>
<a name="ln490">BackgroundsView::_UpdateWithCurrent(void)</a>
<a name="ln491">{</a>
<a name="ln492">	if (fCurrent == NULL)</a>
<a name="ln493">		return;</a>
<a name="ln494"> </a>
<a name="ln495">	fPlacementMenu-&gt;FindItem(kMsgScalePlacement)</a>
<a name="ln496">		-&gt;SetEnabled(fCurrent-&gt;IsDesktop());</a>
<a name="ln497">	fPlacementMenu-&gt;FindItem(kMsgCenterPlacement)</a>
<a name="ln498">		-&gt;SetEnabled(fCurrent-&gt;IsDesktop());</a>
<a name="ln499"> </a>
<a name="ln500">	if (fWorkspaceMenu-&gt;IndexOf(fWorkspaceMenu-&gt;FindMarked()) &gt; 5)</a>
<a name="ln501">		fImageMenu-&gt;FindItem(kMsgNoImage)-&gt;SetLabel(B_TRANSLATE(&quot;Default&quot;));</a>
<a name="ln502">	else</a>
<a name="ln503">		fImageMenu-&gt;FindItem(kMsgNoImage)-&gt;SetLabel(B_TRANSLATE(&quot;None&quot;));</a>
<a name="ln504"> </a>
<a name="ln505">	for (int32 i = fImageMenu-&gt;CountItems() - 5; i &gt;= 0; i--) {</a>
<a name="ln506">		fImageMenu-&gt;RemoveItem(2);</a>
<a name="ln507">	}</a>
<a name="ln508"> </a>
<a name="ln509">	for (int32 i = fImageList.CountItems() - 1; i &gt;= 0; i--) {</a>
<a name="ln510">		BMessage* message = new BMessage(kMsgImageSelected);</a>
<a name="ln511">		_AddItem(new BGImageMenuItem(GetImage(i)-&gt;GetName(), i, message));</a>
<a name="ln512">	}</a>
<a name="ln513"> </a>
<a name="ln514">	fImageMenu-&gt;SetTargetForItems(this);</a>
<a name="ln515"> </a>
<a name="ln516">	fCurrentInfo = fCurrent-&gt;ImageInfoForWorkspace(current_workspace());</a>
<a name="ln517"> </a>
<a name="ln518">	if (!fCurrentInfo) {</a>
<a name="ln519">		fImageMenu-&gt;FindItem(kMsgNoImage)-&gt;SetMarked(true);</a>
<a name="ln520">		fPlacementMenu-&gt;FindItem(kMsgManualPlacement)-&gt;SetMarked(true);</a>
<a name="ln521">		fIconLabelOutline-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln522">	} else {</a>
<a name="ln523">		fIconLabelOutline-&gt;SetValue(fCurrentInfo-&gt;fTextWidgetLabelOutline</a>
<a name="ln524">			? B_CONTROL_ON : B_CONTROL_OFF);</a>
<a name="ln525"> </a>
<a name="ln526">		fLastImageIndex = fCurrentInfo-&gt;fImageIndex;</a>
<a name="ln527">		_FindImageItem(fLastImageIndex)-&gt;SetMarked(true);</a>
<a name="ln528"> </a>
<a name="ln529">		if (fLastImageIndex &gt; -1) {</a>
<a name="ln530"> </a>
<a name="ln531">			BString xtext, ytext;</a>
<a name="ln532">			int32 cmd = 0;</a>
<a name="ln533">			switch (fCurrentInfo-&gt;fMode) {</a>
<a name="ln534">				case BackgroundImage::kCentered:</a>
<a name="ln535">					cmd = kMsgCenterPlacement;</a>
<a name="ln536">					break;</a>
<a name="ln537">				case BackgroundImage::kScaledToFit:</a>
<a name="ln538">					cmd = kMsgScalePlacement;</a>
<a name="ln539">					break;</a>
<a name="ln540">				case BackgroundImage::kAtOffset:</a>
<a name="ln541">					cmd = kMsgManualPlacement;</a>
<a name="ln542">					xtext &lt;&lt; (int)fCurrentInfo-&gt;fOffset.x;</a>
<a name="ln543">					ytext &lt;&lt; (int)fCurrentInfo-&gt;fOffset.y;</a>
<a name="ln544">					break;</a>
<a name="ln545">				case BackgroundImage::kTiled:</a>
<a name="ln546">					cmd = kMsgTilePlacement;</a>
<a name="ln547">					break;</a>
<a name="ln548">			}</a>
<a name="ln549"> </a>
<a name="ln550">			if (cmd != 0)</a>
<a name="ln551">				fPlacementMenu-&gt;FindItem(cmd)-&gt;SetMarked(true);</a>
<a name="ln552"> </a>
<a name="ln553">			fXPlacementText-&gt;SetText(xtext.String());</a>
<a name="ln554">			fYPlacementText-&gt;SetText(ytext.String());</a>
<a name="ln555">		} else {</a>
<a name="ln556">			fPlacementMenu-&gt;FindItem(kMsgManualPlacement)-&gt;SetMarked(true);</a>
<a name="ln557">		}</a>
<a name="ln558">	}</a>
<a name="ln559"> </a>
<a name="ln560">	rgb_color color = {255, 255, 255, 255};</a>
<a name="ln561">	if (fCurrent-&gt;IsDesktop()) {</a>
<a name="ln562">		color = BScreen().DesktopColor();</a>
<a name="ln563">		fPicker-&gt;SetEnabled(true);</a>
<a name="ln564">	} else</a>
<a name="ln565">		fPicker-&gt;SetEnabled(false);</a>
<a name="ln566"> </a>
<a name="ln567">	fPicker-&gt;SetValue(color);</a>
<a name="ln568"> </a>
<a name="ln569">	_UpdatePreview();</a>
<a name="ln570">	_UpdateButtons();</a>
<a name="ln571">}</a>
<a name="ln572"> </a>
<a name="ln573"> </a>
<a name="ln574">void</a>
<a name="ln575">BackgroundsView::_Save()</a>
<a name="ln576">{</a>
<a name="ln577">	bool textWidgetLabelOutline</a>
<a name="ln578">		= fIconLabelOutline-&gt;Value() == B_CONTROL_ON;</a>
<a name="ln579"> </a>
<a name="ln580">	BackgroundImage::Mode mode = _FindPlacementMode();</a>
<a name="ln581">	BPoint offset(atoi(fXPlacementText-&gt;Text()), atoi(fYPlacementText-&gt;Text()));</a>
<a name="ln582"> </a>
<a name="ln583">	if (!fCurrent-&gt;IsDesktop()) {</a>
<a name="ln584">		if (fCurrentInfo == NULL) {</a>
<a name="ln585">			fCurrentInfo = new BackgroundImage::BackgroundImageInfo(</a>
<a name="ln586">				B_ALL_WORKSPACES, fLastImageIndex, mode, offset,</a>
<a name="ln587">				textWidgetLabelOutline, 0, 0);</a>
<a name="ln588">			fCurrent-&gt;Add(fCurrentInfo);</a>
<a name="ln589">		} else {</a>
<a name="ln590">			fCurrentInfo-&gt;fTextWidgetLabelOutline = textWidgetLabelOutline;</a>
<a name="ln591">			fCurrentInfo-&gt;fMode = mode;</a>
<a name="ln592">			if (fCurrentInfo-&gt;fMode == BackgroundImage::kAtOffset)</a>
<a name="ln593">				fCurrentInfo-&gt;fOffset = offset;</a>
<a name="ln594">			fCurrentInfo-&gt;fImageIndex = fLastImageIndex;</a>
<a name="ln595">		}</a>
<a name="ln596">	} else {</a>
<a name="ln597">		uint32 workspaceMask = 1;</a>
<a name="ln598">		int32 workspace = current_workspace();</a>
<a name="ln599">		for (; workspace; workspace--)</a>
<a name="ln600">			workspaceMask *= 2;</a>
<a name="ln601"> </a>
<a name="ln602">		if (fCurrentInfo != NULL) {</a>
<a name="ln603">			if (fWorkspaceMenu-&gt;FindItem(kMsgCurrentWorkspace)-&gt;IsMarked()) {</a>
<a name="ln604">				if (fCurrentInfo-&gt;fWorkspace &amp; workspaceMask</a>
<a name="ln605">					&amp;&amp; fCurrentInfo-&gt;fWorkspace != workspaceMask) {</a>
<a name="ln606">					fCurrentInfo-&gt;fWorkspace = fCurrentInfo-&gt;fWorkspace</a>
<a name="ln607">						^ workspaceMask;</a>
<a name="ln608">					fCurrentInfo = new BackgroundImage::BackgroundImageInfo(</a>
<a name="ln609">						workspaceMask, fLastImageIndex, mode, offset,</a>
<a name="ln610">						textWidgetLabelOutline, fCurrentInfo-&gt;fImageSet,</a>
<a name="ln611">						fCurrentInfo-&gt;fCacheMode);</a>
<a name="ln612">					fCurrent-&gt;Add(fCurrentInfo);</a>
<a name="ln613">				} else if (fCurrentInfo-&gt;fWorkspace == workspaceMask) {</a>
<a name="ln614">					fCurrentInfo-&gt;fTextWidgetLabelOutline</a>
<a name="ln615">						= textWidgetLabelOutline;</a>
<a name="ln616">					fCurrentInfo-&gt;fMode = mode;</a>
<a name="ln617">					if (fCurrentInfo-&gt;fMode == BackgroundImage::kAtOffset)</a>
<a name="ln618">						fCurrentInfo-&gt;fOffset = offset;</a>
<a name="ln619"> </a>
<a name="ln620">					fCurrentInfo-&gt;fImageIndex = fLastImageIndex;</a>
<a name="ln621">				}</a>
<a name="ln622">			} else {</a>
<a name="ln623">				fCurrent-&gt;RemoveAll();</a>
<a name="ln624"> </a>
<a name="ln625">				fCurrentInfo = new BackgroundImage::BackgroundImageInfo(</a>
<a name="ln626">					B_ALL_WORKSPACES, fLastImageIndex, mode, offset,</a>
<a name="ln627">					textWidgetLabelOutline, fCurrent-&gt;GetShowingImageSet(),</a>
<a name="ln628">					fCurrentInfo-&gt;fCacheMode);</a>
<a name="ln629">				fCurrent-&gt;Add(fCurrentInfo);</a>
<a name="ln630">			}</a>
<a name="ln631">		} else {</a>
<a name="ln632">			if (fWorkspaceMenu-&gt;FindItem(kMsgCurrentWorkspace)-&gt;IsMarked()) {</a>
<a name="ln633">				fCurrentInfo = new BackgroundImage::BackgroundImageInfo(</a>
<a name="ln634">					workspaceMask, fLastImageIndex, mode, offset,</a>
<a name="ln635">					textWidgetLabelOutline, fCurrent-&gt;GetShowingImageSet(), 0);</a>
<a name="ln636">			} else {</a>
<a name="ln637">				fCurrent-&gt;RemoveAll();</a>
<a name="ln638">				fCurrentInfo = new BackgroundImage::BackgroundImageInfo(</a>
<a name="ln639">					B_ALL_WORKSPACES, fLastImageIndex, mode, offset,</a>
<a name="ln640">					textWidgetLabelOutline, fCurrent-&gt;GetShowingImageSet(), 0);</a>
<a name="ln641">			}</a>
<a name="ln642">			fCurrent-&gt;Add(fCurrentInfo);</a>
<a name="ln643">		}</a>
<a name="ln644"> </a>
<a name="ln645">		if (!fWorkspaceMenu-&gt;FindItem(kMsgCurrentWorkspace)-&gt;IsMarked()) {</a>
<a name="ln646">			for (int32 i = 0; i &lt; count_workspaces(); i++) {</a>
<a name="ln647">				BScreen().SetDesktopColor(fPicker-&gt;ValueAsColor(), i, true);</a>
<a name="ln648">			}</a>
<a name="ln649">		} else</a>
<a name="ln650">			BScreen().SetDesktopColor(fPicker-&gt;ValueAsColor(), true);</a>
<a name="ln651">	}</a>
<a name="ln652"> </a>
<a name="ln653">	BNode node(&amp;fCurrentRef);</a>
<a name="ln654"> </a>
<a name="ln655">	status_t status = fCurrent-&gt;SetBackgroundImage(&amp;node);</a>
<a name="ln656">	if (status != B_OK) {</a>
<a name="ln657">		BString error(strerror(status));</a>
<a name="ln658">		BString text(B_TRANSLATE(&quot;Setting the background image failed:&quot;));</a>
<a name="ln659">		text.Append(&quot;\n&quot;).Append(error);</a>
<a name="ln660">		BAlert* alert = new BAlert(B_TRANSLATE(&quot;Set background image error&quot;),</a>
<a name="ln661">			text, B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln662">		alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln663">		alert-&gt;Go(NULL);</a>
<a name="ln664">		printf(&quot;setting background image failed: %s\n&quot;, error.String());</a>
<a name="ln665">	}</a>
<a name="ln666">}</a>
<a name="ln667"> </a>
<a name="ln668"> </a>
<a name="ln669">void</a>
<a name="ln670">BackgroundsView::_NotifyServer()</a>
<a name="ln671">{</a>
<a name="ln672">	BMessenger tracker(&quot;application/x-vnd.Be-TRAK&quot;);</a>
<a name="ln673"> </a>
<a name="ln674">	if (fCurrent-&gt;IsDesktop()) {</a>
<a name="ln675">		tracker.SendMessage(new BMessage(B_RESTORE_BACKGROUND_IMAGE));</a>
<a name="ln676">	} else {</a>
<a name="ln677">		int32 i = -1;</a>
<a name="ln678">		BMessage reply;</a>
<a name="ln679">		int32 err;</a>
<a name="ln680">		BEntry currentEntry(&amp;fCurrentRef);</a>
<a name="ln681">		BPath currentPath(&amp;currentEntry);</a>
<a name="ln682">		bool isCustomFolder</a>
<a name="ln683">			= !fWorkspaceMenu-&gt;FindItem(kMsgDefaultFolder)-&gt;IsMarked();</a>
<a name="ln684"> </a>
<a name="ln685">		do {</a>
<a name="ln686">			BMessage msg(B_GET_PROPERTY);</a>
<a name="ln687">			i++;</a>
<a name="ln688"> </a>
<a name="ln689">			// look at the &quot;Poses&quot; in every Tracker window</a>
<a name="ln690">			msg.AddSpecifier(&quot;Poses&quot;);</a>
<a name="ln691">			msg.AddSpecifier(&quot;Window&quot;, i);</a>
<a name="ln692"> </a>
<a name="ln693">			reply.MakeEmpty();</a>
<a name="ln694">			tracker.SendMessage(&amp;msg, &amp;reply);</a>
<a name="ln695"> </a>
<a name="ln696">			// break out of the loop when we're at the end of</a>
<a name="ln697">			// the windows</a>
<a name="ln698">			if (reply.what == B_MESSAGE_NOT_UNDERSTOOD</a>
<a name="ln699">				&amp;&amp; reply.FindInt32(&quot;error&quot;, &amp;err) == B_OK</a>
<a name="ln700">				&amp;&amp; err == B_BAD_INDEX)</a>
<a name="ln701">				break;</a>
<a name="ln702"> </a>
<a name="ln703">			// don't stop for windows that don't understand</a>
<a name="ln704">			// a request for &quot;Poses&quot;; they're not displaying</a>
<a name="ln705">			// folders</a>
<a name="ln706">			if (reply.what == B_MESSAGE_NOT_UNDERSTOOD</a>
<a name="ln707">				&amp;&amp; reply.FindInt32(&quot;error&quot;, &amp;err) == B_OK</a>
<a name="ln708">				&amp;&amp; err != B_BAD_SCRIPT_SYNTAX)</a>
<a name="ln709">				continue;</a>
<a name="ln710"> </a>
<a name="ln711">			BMessenger trackerWindow;</a>
<a name="ln712">			if (reply.FindMessenger(&quot;result&quot;, &amp;trackerWindow) != B_OK)</a>
<a name="ln713">				continue;</a>
<a name="ln714"> </a>
<a name="ln715">			if (isCustomFolder) {</a>
<a name="ln716">				// found a window with poses, ask for its path</a>
<a name="ln717">				msg.MakeEmpty();</a>
<a name="ln718">				msg.what = B_GET_PROPERTY;</a>
<a name="ln719">				msg.AddSpecifier(&quot;Path&quot;);</a>
<a name="ln720">				msg.AddSpecifier(&quot;Poses&quot;);</a>
<a name="ln721">				msg.AddSpecifier(&quot;Window&quot;, i);</a>
<a name="ln722"> </a>
<a name="ln723">				reply.MakeEmpty();</a>
<a name="ln724">				tracker.SendMessage(&amp;msg, &amp;reply);</a>
<a name="ln725"> </a>
<a name="ln726">				// go on with the next if this din't have a path</a>
<a name="ln727">				if (reply.what == B_MESSAGE_NOT_UNDERSTOOD)</a>
<a name="ln728">					continue;</a>
<a name="ln729"> </a>
<a name="ln730">				entry_ref ref;</a>
<a name="ln731">				if (reply.FindRef(&quot;result&quot;, &amp;ref) == B_OK) {</a>
<a name="ln732">					BEntry entry(&amp;ref);</a>
<a name="ln733">					BPath path(&amp;entry);</a>
<a name="ln734"> </a>
<a name="ln735">					// these are not the paths you're looking for</a>
<a name="ln736">					if (currentPath != path)</a>
<a name="ln737">						continue;</a>
<a name="ln738">				}</a>
<a name="ln739">			}</a>
<a name="ln740"> </a>
<a name="ln741">			trackerWindow.SendMessage(B_RESTORE_BACKGROUND_IMAGE);</a>
<a name="ln742">		} while (true);</a>
<a name="ln743">	}</a>
<a name="ln744">}</a>
<a name="ln745"> </a>
<a name="ln746"> </a>
<a name="ln747">void</a>
<a name="ln748">BackgroundsView::_NotifyScreenPreflet()</a>
<a name="ln749">{</a>
<a name="ln750">	BMessenger messenger(&quot;application/x-vnd.Haiku-Screen&quot;);</a>
<a name="ln751">	if (messenger.IsValid())</a>
<a name="ln752">		messenger.SendMessage(UPDATE_DESKTOP_COLOR_MSG);</a>
<a name="ln753">}</a>
<a name="ln754"> </a>
<a name="ln755"> </a>
<a name="ln756">int32</a>
<a name="ln757">BackgroundsView::_NotifyThread(void* data)</a>
<a name="ln758">{</a>
<a name="ln759">	BackgroundsView* view = (BackgroundsView*)data;</a>
<a name="ln760"> </a>
<a name="ln761">	view-&gt;_NotifyServer();</a>
<a name="ln762">	view-&gt;_NotifyScreenPreflet();</a>
<a name="ln763">	return B_OK;</a>
<a name="ln764">}</a>
<a name="ln765"> </a>
<a name="ln766"> </a>
<a name="ln767">void</a>
<a name="ln768">BackgroundsView::SaveSettings(void)</a>
<a name="ln769">{</a>
<a name="ln770">	BPath path;</a>
<a name="ln771">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path) == B_OK) {</a>
<a name="ln772">		path.Append(SETTINGS_FILE);</a>
<a name="ln773">		BFile file(path.Path(), B_READ_WRITE | B_CREATE_FILE | B_ERASE_FILE);</a>
<a name="ln774"> </a>
<a name="ln775">		BPoint point = Window()-&gt;Frame().LeftTop();</a>
<a name="ln776">		if (fSettings.ReplacePoint(&quot;pos&quot;, point) != B_OK)</a>
<a name="ln777">			fSettings.AddPoint(&quot;pos&quot;, point);</a>
<a name="ln778"> </a>
<a name="ln779">		entry_ref ref;</a>
<a name="ln780">		BEntry entry;</a>
<a name="ln781"> </a>
<a name="ln782">		fPanel-&gt;GetPanelDirectory(&amp;ref);</a>
<a name="ln783">		entry.SetTo(&amp;ref);</a>
<a name="ln784">		entry.GetPath(&amp;path);</a>
<a name="ln785">		if (fSettings.ReplaceString(&quot;paneldir&quot;, path.Path()) != B_OK)</a>
<a name="ln786">			fSettings.AddString(&quot;paneldir&quot;, path.Path());</a>
<a name="ln787"> </a>
<a name="ln788">		fFolderPanel-&gt;GetPanelDirectory(&amp;ref);</a>
<a name="ln789">		entry.SetTo(&amp;ref);</a>
<a name="ln790">		entry.GetPath(&amp;path);</a>
<a name="ln791">		if (fSettings.ReplaceString(&quot;folderpaneldir&quot;, path.Path()) != B_OK)</a>
<a name="ln792">			fSettings.AddString(&quot;folderpaneldir&quot;, path.Path());</a>
<a name="ln793"> </a>
<a name="ln794">		fSettings.RemoveName(&quot;recentfolder&quot;);</a>
<a name="ln795">		for (int32 i = 0; i &lt; fPathList.CountItems(); i++) {</a>
<a name="ln796">			fSettings.AddString(&quot;recentfolder&quot;, fPathList.ItemAt(i)-&gt;Path());</a>
<a name="ln797">		}</a>
<a name="ln798"> </a>
<a name="ln799">		fSettings.Flatten(&amp;file);</a>
<a name="ln800">	}</a>
<a name="ln801">}</a>
<a name="ln802"> </a>
<a name="ln803"> </a>
<a name="ln804">void</a>
<a name="ln805">BackgroundsView::_LoadSettings()</a>
<a name="ln806">{</a>
<a name="ln807">	fSettings.MakeEmpty();</a>
<a name="ln808"> </a>
<a name="ln809">	BPath path;</a>
<a name="ln810">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path) != B_OK)</a>
<a name="ln811">		return;</a>
<a name="ln812"> </a>
<a name="ln813">	path.Append(SETTINGS_FILE);</a>
<a name="ln814">	BFile file(path.Path(), B_READ_ONLY);</a>
<a name="ln815">	if (file.InitCheck() != B_OK)</a>
<a name="ln816">		return;</a>
<a name="ln817"> </a>
<a name="ln818">	if (fSettings.Unflatten(&amp;file) != B_OK) {</a>
<a name="ln819">		printf(&quot;Error unflattening settings file %s\n&quot;, path.Path());</a>
<a name="ln820">		return;</a>
<a name="ln821">	}</a>
<a name="ln822"> </a>
<a name="ln823">	PRINT_OBJECT(fSettings);</a>
<a name="ln824"> </a>
<a name="ln825">	BString settingStr;</a>
<a name="ln826">	if (fSettings.FindString(&quot;paneldir&quot;, &amp;settingStr) == B_OK)</a>
<a name="ln827">		fPanel-&gt;SetPanelDirectory(settingStr.String());</a>
<a name="ln828"> </a>
<a name="ln829">	if (fSettings.FindString(&quot;folderpaneldir&quot;, &amp;settingStr) == B_OK)</a>
<a name="ln830">		fFolderPanel-&gt;SetPanelDirectory(settingStr.String());</a>
<a name="ln831"> </a>
<a name="ln832">	int32 index = 0;</a>
<a name="ln833">	while (fSettings.FindString(&quot;recentfolder&quot;, index, &amp;settingStr) == B_OK) {</a>
<a name="ln834">		path.SetTo(settingStr.String());</a>
<a name="ln835">		_AddRecentFolder(path);</a>
<a name="ln836">		index++;</a>
<a name="ln837">	}</a>
<a name="ln838"> </a>
<a name="ln839">	fWorkspaceMenu-&gt;ItemAt(1)-&gt;SetMarked(true);</a>
<a name="ln840">	fWorkspaceMenu-&gt;SetTargetForItems(this);</a>
<a name="ln841"> </a>
<a name="ln842">	PRINT((&quot;Settings Loaded\n&quot;));</a>
<a name="ln843">}</a>
<a name="ln844"> </a>
<a name="ln845"> </a>
<a name="ln846">void</a>
<a name="ln847">BackgroundsView::WorkspaceActivated(uint32 oldWorkspaces, bool active)</a>
<a name="ln848">{</a>
<a name="ln849">	_UpdateWithCurrent();</a>
<a name="ln850">}</a>
<a name="ln851"> </a>
<a name="ln852"> </a>
<a name="ln853">void</a>
<a name="ln854">BackgroundsView::_UpdatePreview()</a>
<a name="ln855">{</a>
<a name="ln856">	bool imageEnabled = !(fImageMenu-&gt;FindItem(kMsgNoImage)-&gt;IsMarked());</a>
<a name="ln857">	if (fPlacementMenu-&gt;IsEnabled() ^ imageEnabled)</a>
<a name="ln858">		fPlacementMenu-&gt;SetEnabled(imageEnabled);</a>
<a name="ln859"> </a>
<a name="ln860">	bool textEnabled</a>
<a name="ln861">		= (fPlacementMenu-&gt;FindItem(kMsgManualPlacement)-&gt;IsMarked())</a>
<a name="ln862">		&amp;&amp; imageEnabled;</a>
<a name="ln863">	if (fXPlacementText-&gt;IsEnabled() ^ textEnabled)</a>
<a name="ln864">		fXPlacementText-&gt;SetEnabled(textEnabled);</a>
<a name="ln865">	if (fYPlacementText-&gt;IsEnabled() ^ textEnabled)</a>
<a name="ln866">		fYPlacementText-&gt;SetEnabled(textEnabled);</a>
<a name="ln867"> </a>
<a name="ln868">	if (textEnabled &amp;&amp; (strcmp(fXPlacementText-&gt;Text(), &quot;&quot;) == 0)) {</a>
<a name="ln869">		fXPlacementText-&gt;SetText(&quot;0&quot;);</a>
<a name="ln870">		fYPlacementText-&gt;SetText(&quot;0&quot;);</a>
<a name="ln871">	}</a>
<a name="ln872">	if (!textEnabled) {</a>
<a name="ln873">		fXPlacementText-&gt;SetText(NULL);</a>
<a name="ln874">		fYPlacementText-&gt;SetText(NULL);</a>
<a name="ln875">	}</a>
<a name="ln876"> </a>
<a name="ln877">	fXPlacementText-&gt;TextView()-&gt;MakeSelectable(textEnabled);</a>
<a name="ln878">	fYPlacementText-&gt;TextView()-&gt;MakeSelectable(textEnabled);</a>
<a name="ln879">	fXPlacementText-&gt;TextView()-&gt;MakeEditable(textEnabled);</a>
<a name="ln880">	fYPlacementText-&gt;TextView()-&gt;MakeEditable(textEnabled);</a>
<a name="ln881"> </a>
<a name="ln882">	fPreview-&gt;ClearViewBitmap();</a>
<a name="ln883"> </a>
<a name="ln884">	int32 index = ((BGImageMenuItem*)fImageMenu-&gt;FindMarked())-&gt;ImageIndex();</a>
<a name="ln885">	if (index &gt;= 0) {</a>
<a name="ln886">		BBitmap* bitmap = GetImage(index)-&gt;GetBitmap();</a>
<a name="ln887">		if (bitmap) {</a>
<a name="ln888">			BackgroundImage::BackgroundImageInfo* info</a>
<a name="ln889">				= new BackgroundImage::BackgroundImageInfo(0, index,</a>
<a name="ln890">					_FindPlacementMode(), BPoint(atoi(fXPlacementText-&gt;Text()),</a>
<a name="ln891">						atoi(fYPlacementText-&gt;Text())),</a>
<a name="ln892">					fIconLabelOutline-&gt;Value() == B_CONTROL_ON, 0, 0);</a>
<a name="ln893">			if (info-&gt;fMode == BackgroundImage::kAtOffset) {</a>
<a name="ln894">				fPreview-&gt;SetEnabled(true);</a>
<a name="ln895">				fPreview-&gt;fPoint.x = atoi(fXPlacementText-&gt;Text());</a>
<a name="ln896">				fPreview-&gt;fPoint.y = atoi(fYPlacementText-&gt;Text());</a>
<a name="ln897">			} else</a>
<a name="ln898">				fPreview-&gt;SetEnabled(false);</a>
<a name="ln899"> </a>
<a name="ln900">			fPreview-&gt;fImageBounds = BRect(bitmap-&gt;Bounds());</a>
<a name="ln901">			fCurrent-&gt;Show(info, fPreview);</a>
<a name="ln902"> </a>
<a name="ln903">			delete info;</a>
<a name="ln904">		}</a>
<a name="ln905">	} else</a>
<a name="ln906">		fPreview-&gt;SetEnabled(false);</a>
<a name="ln907"> </a>
<a name="ln908">	fPreview-&gt;SetViewColor(fPicker-&gt;ValueAsColor());</a>
<a name="ln909">	fPreview-&gt;Invalidate();</a>
<a name="ln910">}</a>
<a name="ln911"> </a>
<a name="ln912"> </a>
<a name="ln913">BackgroundImage::Mode</a>
<a name="ln914">BackgroundsView::_FindPlacementMode()</a>
<a name="ln915">{</a>
<a name="ln916">	BackgroundImage::Mode mode = BackgroundImage::kAtOffset;</a>
<a name="ln917"> </a>
<a name="ln918">	if (fPlacementMenu-&gt;FindItem(kMsgCenterPlacement)-&gt;IsMarked())</a>
<a name="ln919">		mode = BackgroundImage::kCentered;</a>
<a name="ln920">	if (fPlacementMenu-&gt;FindItem(kMsgScalePlacement)-&gt;IsMarked())</a>
<a name="ln921">		mode = BackgroundImage::kScaledToFit;</a>
<a name="ln922">	if (fPlacementMenu-&gt;FindItem(kMsgManualPlacement)-&gt;IsMarked())</a>
<a name="ln923">		mode = BackgroundImage::kAtOffset;</a>
<a name="ln924">	if (fPlacementMenu-&gt;FindItem(kMsgTilePlacement)-&gt;IsMarked())</a>
<a name="ln925">		mode = BackgroundImage::kTiled;</a>
<a name="ln926"> </a>
<a name="ln927">	return mode;</a>
<a name="ln928">}</a>
<a name="ln929"> </a>
<a name="ln930"> </a>
<a name="ln931">void</a>
<a name="ln932">BackgroundsView::_UpdateButtons()</a>
<a name="ln933">{</a>
<a name="ln934">	bool hasChanged = false;</a>
<a name="ln935">	if (fPicker-&gt;IsEnabled()</a>
<a name="ln936">		&amp;&amp; fPicker-&gt;ValueAsColor() != BScreen().DesktopColor()) {</a>
<a name="ln937">		hasChanged = true;</a>
<a name="ln938">	} else if (fCurrentInfo) {</a>
<a name="ln939">		if ((fIconLabelOutline-&gt;Value() == B_CONTROL_ON)</a>
<a name="ln940">			^ fCurrentInfo-&gt;fTextWidgetLabelOutline) {</a>
<a name="ln941">			hasChanged = true;</a>
<a name="ln942">		} else if (_FindPlacementMode() != fCurrentInfo-&gt;fMode) {</a>
<a name="ln943">			hasChanged = true;</a>
<a name="ln944">		} else if (fCurrentInfo-&gt;fImageIndex</a>
<a name="ln945">			!= ((BGImageMenuItem*)fImageMenu-&gt;FindMarked())-&gt;ImageIndex()) {</a>
<a name="ln946">			hasChanged = true;</a>
<a name="ln947">		} else if (fCurrent-&gt;IsDesktop()</a>
<a name="ln948">			&amp;&amp; ((fCurrentInfo-&gt;fWorkspace != B_ALL_WORKSPACES)</a>
<a name="ln949">				^ (fWorkspaceMenu-&gt;FindItem(kMsgCurrentWorkspace)-&gt;IsMarked())))</a>
<a name="ln950">		{</a>
<a name="ln951">			hasChanged = true;</a>
<a name="ln952">		} else if (fCurrentInfo-&gt;fImageIndex &gt; -1</a>
<a name="ln953">			&amp;&amp; fCurrentInfo-&gt;fMode == BackgroundImage::kAtOffset) {</a>
<a name="ln954">			BString oldString, newString;</a>
<a name="ln955">			oldString &lt;&lt; (int)fCurrentInfo-&gt;fOffset.x;</a>
<a name="ln956">			if (oldString != BString(fXPlacementText-&gt;Text())) {</a>
<a name="ln957">				hasChanged = true;</a>
<a name="ln958">			}</a>
<a name="ln959">			oldString = &quot;&quot;;</a>
<a name="ln960">			oldString &lt;&lt; (int)fCurrentInfo-&gt;fOffset.y;</a>
<a name="ln961">			if (oldString != BString(fYPlacementText-&gt;Text())) {</a>
<a name="ln962">				hasChanged = true;</a>
<a name="ln963">			}</a>
<a name="ln964">		}</a>
<a name="ln965">	} else if (fImageMenu-&gt;IndexOf(fImageMenu-&gt;FindMarked()) &gt; 0) {</a>
<a name="ln966">		hasChanged = true;</a>
<a name="ln967">	} else if (fIconLabelOutline-&gt;Value() == B_CONTROL_OFF) {</a>
<a name="ln968">		hasChanged = true;</a>
<a name="ln969">	}</a>
<a name="ln970"> </a>
<a name="ln971">	fApply-&gt;SetEnabled(hasChanged);</a>
<a name="ln972">	fRevert-&gt;SetEnabled(hasChanged);</a>
<a name="ln973">}</a>
<a name="ln974"> </a>
<a name="ln975"> </a>
<a name="ln976">void</a>
<a name="ln977">BackgroundsView::RefsReceived(BMessage* message)</a>
<a name="ln978">{</a>
<a name="ln979">	if (!message-&gt;HasRef(&quot;refs&quot;) &amp;&amp; message-&gt;HasRef(&quot;dir_ref&quot;)) {</a>
<a name="ln980">		entry_ref dirRef;</a>
<a name="ln981">		if (message-&gt;FindRef(&quot;dir_ref&quot;, &amp;dirRef) == B_OK)</a>
<a name="ln982">			message-&gt;AddRef(&quot;refs&quot;, &amp;dirRef);</a>
<a name="ln983">	}</a>
<a name="ln984"> </a>
<a name="ln985">	entry_ref ref;</a>
<a name="ln986">	int32 i = 0;</a>
<a name="ln987">	BMimeType imageType(&quot;image&quot;);</a>
<a name="ln988">	BPath desktopPath;</a>
<a name="ln989">	find_directory(B_DESKTOP_DIRECTORY, &amp;desktopPath);</a>
<a name="ln990"> </a>
<a name="ln991">	while (message-&gt;FindRef(&quot;refs&quot;, i++, &amp;ref) == B_OK) {</a>
<a name="ln992">		BPath path;</a>
<a name="ln993">		BEntry entry(&amp;ref, true);</a>
<a name="ln994">		path.SetTo(&amp;entry);</a>
<a name="ln995">		BNode node(&amp;entry);</a>
<a name="ln996"> </a>
<a name="ln997">		if (node.IsFile()) {</a>
<a name="ln998">			BMimeType refType;</a>
<a name="ln999">			BMimeType::GuessMimeType(&amp;ref, &amp;refType);</a>
<a name="ln1000">			if (!imageType.Contains(&amp;refType))</a>
<a name="ln1001">				continue;</a>
<a name="ln1002"> </a>
<a name="ln1003">			BGImageMenuItem* item;</a>
<a name="ln1004">			int32 index = AddImage(path);</a>
<a name="ln1005">			if (index &gt;= 0) {</a>
<a name="ln1006">				item = _FindImageItem(index);</a>
<a name="ln1007">				fLastImageIndex = index;</a>
<a name="ln1008">			} else {</a>
<a name="ln1009">				const char* name = GetImage(-index - 1)-&gt;GetName();</a>
<a name="ln1010">				item = new BGImageMenuItem(name, -index - 1,</a>
<a name="ln1011">					new BMessage(kMsgImageSelected));</a>
<a name="ln1012">				_AddItem(item);</a>
<a name="ln1013">				item-&gt;SetTarget(this);</a>
<a name="ln1014">				fLastImageIndex = -index - 1;</a>
<a name="ln1015">			}</a>
<a name="ln1016"> </a>
<a name="ln1017">			// An optional placement may have been sent</a>
<a name="ln1018">			int32 placement = 0;</a>
<a name="ln1019">			if (message-&gt;FindInt32(&quot;placement&quot;, &amp;placement) == B_OK) {</a>
<a name="ln1020">				BMenuItem* item = fPlacementMenu-&gt;FindItem(placement);</a>
<a name="ln1021">				if (item)</a>
<a name="ln1022">					item-&gt;SetMarked(true);</a>
<a name="ln1023">			}</a>
<a name="ln1024">			item-&gt;SetMarked(true);</a>
<a name="ln1025">			BMessenger(this).SendMessage(kMsgImageSelected);</a>
<a name="ln1026">		} else if (node.IsDirectory()) {</a>
<a name="ln1027">			if (desktopPath == path) {</a>
<a name="ln1028">				fWorkspaceMenu-&gt;FindItem(kMsgCurrentWorkspace)-&gt;SetMarked(true);</a>
<a name="ln1029">				BMessenger(this).SendMessage(kMsgCurrentWorkspace);</a>
<a name="ln1030">				break;</a>
<a name="ln1031">			}</a>
<a name="ln1032"> </a>
<a name="ln1033">			// Add the newly selected path as a recent folder,</a>
<a name="ln1034">			// removing the oldest entry if needed</a>
<a name="ln1035">			_AddRecentFolder(path, true);</a>
<a name="ln1036">		}</a>
<a name="ln1037">	}</a>
<a name="ln1038">}</a>
<a name="ln1039"> </a>
<a name="ln1040"> </a>
<a name="ln1041">static BPath*</a>
<a name="ln1042">FindPath(BPath* currentPath, void* newPath)</a>
<a name="ln1043">{</a>
<a name="ln1044">	BPath* pathToCheck = static_cast&lt;BPath*&gt;(newPath);</a>
<a name="ln1045">	int compare = ICompare(currentPath-&gt;Path(), pathToCheck-&gt;Path());</a>
<a name="ln1046">	return compare == 0 ? currentPath : NULL;</a>
<a name="ln1047">}</a>
<a name="ln1048"> </a>
<a name="ln1049"> </a>
<a name="ln1050">void</a>
<a name="ln1051">BackgroundsView::_AddRecentFolder(BPath path, bool notifyApp)</a>
<a name="ln1052">{</a>
<a name="ln1053">	BPath* currentPath = fPathList.EachElement(FindPath, &amp;path);</a>
<a name="ln1054">	BMenuItem* item;</a>
<a name="ln1055">	BMessage* folderSelectedMsg = new BMessage(kMsgFolderSelected);</a>
<a name="ln1056">	folderSelectedMsg-&gt;AddString(&quot;folderPath&quot;, path.Path());</a>
<a name="ln1057"> </a>
<a name="ln1058">	if (currentPath == NULL) {</a>
<a name="ln1059">		// &quot;All Workspaces&quot;, &quot;Current Workspace&quot;, &quot;--&quot;, &quot;Default folder&quot;,</a>
<a name="ln1060">		// &quot;Other folder...&quot;, If only these 5 exist,</a>
<a name="ln1061">		// we need a new separator to add path specific recent folders.</a>
<a name="ln1062">		if (fWorkspaceMenu-&gt;CountItems() &lt;= 5)</a>
<a name="ln1063">			fWorkspaceMenu-&gt;AddSeparatorItem();</a>
<a name="ln1064">		// Maxed out the number of recent folders, remove the oldest entry</a>
<a name="ln1065">		if (fPathList.CountItems() == fRecentFoldersLimit) {</a>
<a name="ln1066">			fPathList.RemoveItemAt(0);</a>
<a name="ln1067">			fWorkspaceMenu-&gt;RemoveItem(6);</a>
<a name="ln1068">		}</a>
<a name="ln1069">		// Add the new recent folder</a>
<a name="ln1070">		BString folderMenuText(B_TRANSLATE(&quot;Folder: %path&quot;));</a>
<a name="ln1071">		folderMenuText.ReplaceFirst(&quot;%path&quot;, path.Leaf());</a>
<a name="ln1072">		item = new BMenuItem(folderMenuText.String(), folderSelectedMsg);</a>
<a name="ln1073">		fWorkspaceMenu-&gt;AddItem(item);</a>
<a name="ln1074">		fPathList.AddItem(new BPath(path));</a>
<a name="ln1075">		item-&gt;SetTarget(this);</a>
<a name="ln1076">	} else {</a>
<a name="ln1077">		int32 itemIndex = fPathList.IndexOf(currentPath);</a>
<a name="ln1078">		item = fWorkspaceMenu-&gt;ItemAt(itemIndex + 6);</a>
<a name="ln1079">	}</a>
<a name="ln1080"> </a>
<a name="ln1081">	item-&gt;SetMarked(true);</a>
<a name="ln1082"> </a>
<a name="ln1083">	if (notifyApp)</a>
<a name="ln1084">		BMessenger(this).SendMessage(folderSelectedMsg);</a>
<a name="ln1085">}</a>
<a name="ln1086"> </a>
<a name="ln1087"> </a>
<a name="ln1088">int32</a>
<a name="ln1089">BackgroundsView::AddImage(BPath path)</a>
<a name="ln1090">{</a>
<a name="ln1091">	int32 count = fImageList.CountItems();</a>
<a name="ln1092">	int32 index = 0;</a>
<a name="ln1093">	for (; index &lt; count; index++) {</a>
<a name="ln1094">		Image* image = fImageList.ItemAt(index);</a>
<a name="ln1095">		if (image-&gt;GetPath() == path)</a>
<a name="ln1096">			return index;</a>
<a name="ln1097">	}</a>
<a name="ln1098"> </a>
<a name="ln1099">	fImageList.AddItem(new Image(path));</a>
<a name="ln1100">	return -index - 1;</a>
<a name="ln1101">}</a>
<a name="ln1102"> </a>
<a name="ln1103"> </a>
<a name="ln1104">Image*</a>
<a name="ln1105">BackgroundsView::GetImage(int32 imageIndex)</a>
<a name="ln1106">{</a>
<a name="ln1107">	return fImageList.ItemAt(imageIndex);</a>
<a name="ln1108">}</a>
<a name="ln1109"> </a>
<a name="ln1110"> </a>
<a name="ln1111">BGImageMenuItem*</a>
<a name="ln1112">BackgroundsView::_FindImageItem(const int32 imageIndex)</a>
<a name="ln1113">{</a>
<a name="ln1114">	if (imageIndex &lt; 0)</a>
<a name="ln1115">		return (BGImageMenuItem*)fImageMenu-&gt;ItemAt(0);</a>
<a name="ln1116"> </a>
<a name="ln1117">	int32 count = fImageMenu-&gt;CountItems() - 2;</a>
<a name="ln1118">	int32 index = 2;</a>
<a name="ln1119">	for (; index &lt; count; index++) {</a>
<a name="ln1120">		BGImageMenuItem* image = (BGImageMenuItem*)fImageMenu-&gt;ItemAt(index);</a>
<a name="ln1121">		if (image-&gt;ImageIndex() == imageIndex)</a>
<a name="ln1122">			return image;</a>
<a name="ln1123">	}</a>
<a name="ln1124">	return NULL;</a>
<a name="ln1125">}</a>
<a name="ln1126"> </a>
<a name="ln1127"> </a>
<a name="ln1128">bool</a>
<a name="ln1129">BackgroundsView::_AddItem(BGImageMenuItem* item)</a>
<a name="ln1130">{</a>
<a name="ln1131">	int32 count = fImageMenu-&gt;CountItems() - 2;</a>
<a name="ln1132">	int32 index = 2;</a>
<a name="ln1133">	if (count &lt; index) {</a>
<a name="ln1134">		fImageMenu-&gt;AddItem(new BSeparatorItem(), 1);</a>
<a name="ln1135">		count = fImageMenu-&gt;CountItems() - 2;</a>
<a name="ln1136">	}</a>
<a name="ln1137"> </a>
<a name="ln1138">	for (; index &lt; count; index++) {</a>
<a name="ln1139">		BGImageMenuItem* image = (BGImageMenuItem*)fImageMenu-&gt;ItemAt(index);</a>
<a name="ln1140">		int c = (BString(image-&gt;Label()).ICompare(BString(item-&gt;Label())));</a>
<a name="ln1141">		if (c &gt; 0)</a>
<a name="ln1142">			break;</a>
<a name="ln1143">	}</a>
<a name="ln1144">	return fImageMenu-&gt;AddItem(item, index);</a>
<a name="ln1145">}</a>
<a name="ln1146"> </a>
<a name="ln1147"> </a>
<a name="ln1148">void</a>
<a name="ln1149">BackgroundsView::_SetDesktop(bool isDesktop)</a>
<a name="ln1150">{</a>
<a name="ln1151">	fTopLeft-&gt;SetDesktop(isDesktop);</a>
<a name="ln1152">	fTop-&gt;SetDesktop(isDesktop);</a>
<a name="ln1153">	fTopRight-&gt;SetDesktop(isDesktop);</a>
<a name="ln1154">	fLeft-&gt;SetDesktop(isDesktop);</a>
<a name="ln1155">	fRight-&gt;SetDesktop(isDesktop);</a>
<a name="ln1156">	fBottomLeft-&gt;SetDesktop(isDesktop);</a>
<a name="ln1157">	fBottom-&gt;SetDesktop(isDesktop);</a>
<a name="ln1158">	fBottomRight-&gt;SetDesktop(isDesktop);</a>
<a name="ln1159"> </a>
<a name="ln1160">	Invalidate();</a>
<a name="ln1161">}</a>
<a name="ln1162"> </a>
<a name="ln1163"> </a>
<a name="ln1164">bool</a>
<a name="ln1165">BackgroundsView::FoundPositionSetting()</a>
<a name="ln1166">{</a>
<a name="ln1167">	return fFoundPositionSetting;</a>
<a name="ln1168">}</a>
<a name="ln1169"> </a>
<a name="ln1170"> </a>
<a name="ln1171">//	#pragma mark -</a>
<a name="ln1172"> </a>
<a name="ln1173"> </a>
<a name="ln1174">Preview::Preview()</a>
<a name="ln1175">	:</a>
<a name="ln1176">	BControl(&quot;PreView&quot;, NULL, NULL, B_WILL_DRAW | B_SUBPIXEL_PRECISE)</a>
<a name="ln1177">{</a>
<a name="ln1178">	float aspectRatio = BScreen().Frame().Width() / BScreen().Frame().Height();</a>
<a name="ln1179">	float previewWidth = 120.0f * std::max(1.0f, be_plain_font-&gt;Size() / 12.0f);</a>
<a name="ln1180">	float previewHeight = ceil(previewWidth / aspectRatio);</a>
<a name="ln1181"> </a>
<a name="ln1182">	ResizeTo(previewWidth, previewHeight);</a>
<a name="ln1183">	SetExplicitMinSize(BSize(previewWidth, previewHeight));</a>
<a name="ln1184">	SetExplicitMaxSize(BSize(previewWidth, previewHeight));</a>
<a name="ln1185">}</a>
<a name="ln1186"> </a>
<a name="ln1187"> </a>
<a name="ln1188">void</a>
<a name="ln1189">Preview::AttachedToWindow()</a>
<a name="ln1190">{</a>
<a name="ln1191">	rgb_color color = ViewColor();</a>
<a name="ln1192">	BControl::AttachedToWindow();</a>
<a name="ln1193">	SetViewColor(color);</a>
<a name="ln1194">}</a>
<a name="ln1195"> </a>
<a name="ln1196"> </a>
<a name="ln1197">void</a>
<a name="ln1198">Preview::MouseDown(BPoint point)</a>
<a name="ln1199">{</a>
<a name="ln1200">	if (IsEnabled() &amp;&amp; Bounds().Contains(point)) {</a>
<a name="ln1201">		uint32 buttons;</a>
<a name="ln1202">		GetMouse(&amp;point, &amp;buttons);</a>
<a name="ln1203">		if (buttons &amp; B_PRIMARY_MOUSE_BUTTON) {</a>
<a name="ln1204">			fOldPoint = point;</a>
<a name="ln1205">			SetTracking(true);</a>
<a name="ln1206">			BScreen().GetMode(&amp;fMode);</a>
<a name="ln1207">			fXRatio = Bounds().Width() / fMode.virtual_width;</a>
<a name="ln1208">			fYRatio = Bounds().Height() / fMode.virtual_height;</a>
<a name="ln1209">			SetMouseEventMask(B_POINTER_EVENTS,</a>
<a name="ln1210">				B_LOCK_WINDOW_FOCUS | B_NO_POINTER_HISTORY);</a>
<a name="ln1211"> </a>
<a name="ln1212">			BCursor grabbingCursor(B_CURSOR_ID_GRABBING);</a>
<a name="ln1213">			SetViewCursor(&amp;grabbingCursor);</a>
<a name="ln1214">		}</a>
<a name="ln1215">	}</a>
<a name="ln1216">}</a>
<a name="ln1217"> </a>
<a name="ln1218"> </a>
<a name="ln1219">void</a>
<a name="ln1220">Preview::MouseUp(BPoint point)</a>
<a name="ln1221">{</a>
<a name="ln1222">	if (IsTracking()) {</a>
<a name="ln1223">		SetTracking(false);</a>
<a name="ln1224">		BCursor grabCursor(B_CURSOR_ID_GRAB);</a>
<a name="ln1225">		SetViewCursor(&amp;grabCursor);</a>
<a name="ln1226">	}</a>
<a name="ln1227">}</a>
<a name="ln1228"> </a>
<a name="ln1229"> </a>
<a name="ln1230">void</a>
<a name="ln1231">Preview::MouseMoved(BPoint point, uint32 transit, const BMessage* message)</a>
<a name="ln1232">{</a>
<a name="ln1233">	if (!IsTracking()) {</a>
<a name="ln1234">		BCursor cursor(IsEnabled()</a>
<a name="ln1235">			? B_CURSOR_ID_GRAB : B_CURSOR_ID_SYSTEM_DEFAULT);</a>
<a name="ln1236">		SetViewCursor(&amp;cursor);</a>
<a name="ln1237">	} else {</a>
<a name="ln1238">		float x, y;</a>
<a name="ln1239">		x = fPoint.x + (point.x - fOldPoint.x) / fXRatio;</a>
<a name="ln1240">		y = fPoint.y + (point.y - fOldPoint.y) / fYRatio;</a>
<a name="ln1241">		bool min, max, mustSend = false;</a>
<a name="ln1242">		min = (x &gt; -fImageBounds.Width());</a>
<a name="ln1243">		max = (x &lt; fMode.virtual_width);</a>
<a name="ln1244">		if (min &amp;&amp; max) {</a>
<a name="ln1245">			fOldPoint.x = point.x;</a>
<a name="ln1246">			fPoint.x = x;</a>
<a name="ln1247">			mustSend = true;</a>
<a name="ln1248">		} else {</a>
<a name="ln1249">			if (!min &amp;&amp; fPoint.x &gt; -fImageBounds.Width()) {</a>
<a name="ln1250">				fPoint.x = -fImageBounds.Width();</a>
<a name="ln1251">				fOldPoint.x = point.x - (x - fPoint.x) * fXRatio;</a>
<a name="ln1252">				mustSend = true;</a>
<a name="ln1253">			}</a>
<a name="ln1254">			if (!max &amp;&amp; fPoint.x &lt; fMode.virtual_width) {</a>
<a name="ln1255">				fPoint.x = fMode.virtual_width;</a>
<a name="ln1256">				fOldPoint.x = point.x - (x - fPoint.x) * fXRatio;</a>
<a name="ln1257">				mustSend = true;</a>
<a name="ln1258">			}</a>
<a name="ln1259">		}</a>
<a name="ln1260"> </a>
<a name="ln1261">		min = (y &gt; -fImageBounds.Height());</a>
<a name="ln1262">		max = (y &lt; fMode.virtual_height);</a>
<a name="ln1263">		if (min &amp;&amp; max) {</a>
<a name="ln1264">			fOldPoint.y = point.y;</a>
<a name="ln1265">			fPoint.y = y;</a>
<a name="ln1266">			mustSend = true;</a>
<a name="ln1267">		} else {</a>
<a name="ln1268">			if (!min &amp;&amp; fPoint.y &gt; -fImageBounds.Height()) {</a>
<a name="ln1269">				fPoint.y = -fImageBounds.Height();</a>
<a name="ln1270">				fOldPoint.y = point.y - (y - fPoint.y) * fYRatio;</a>
<a name="ln1271">				mustSend = true;</a>
<a name="ln1272">			}</a>
<a name="ln1273">			if (!max &amp;&amp; fPoint.y &lt; fMode.virtual_height) {</a>
<a name="ln1274">				fPoint.y = fMode.virtual_height;</a>
<a name="ln1275">				fOldPoint.y = point.y - (y - fPoint.y) * fYRatio;</a>
<a name="ln1276">				mustSend = true;</a>
<a name="ln1277">			}</a>
<a name="ln1278">		}</a>
<a name="ln1279"> </a>
<a name="ln1280">		if (mustSend) {</a>
<a name="ln1281">			BMessenger messenger(Parent());</a>
<a name="ln1282">			messenger.SendMessage(kMsgUpdatePreviewPlacement);</a>
<a name="ln1283">		}</a>
<a name="ln1284">	}</a>
<a name="ln1285"> </a>
<a name="ln1286">	BControl::MouseMoved(point, transit, message);</a>
<a name="ln1287">}</a>
<a name="ln1288"> </a>
<a name="ln1289"> </a>
<a name="ln1290">//	#pragma mark -</a>
<a name="ln1291"> </a>
<a name="ln1292"> </a>
<a name="ln1293">BGImageMenuItem::BGImageMenuItem(const char* label, int32 imageIndex,</a>
<a name="ln1294">	BMessage* message, char shortcut, uint32 modifiers)</a>
<a name="ln1295">	: BMenuItem(label, message, shortcut, modifiers),</a>
<a name="ln1296">	fImageIndex(imageIndex)</a>
<a name="ln1297">{</a>
<a name="ln1298">}</a>
<a name="ln1299"> </a>
<a name="ln1300"> </a>
<a name="ln1301">//	#pragma mark -</a>
<a name="ln1302"> </a>
<a name="ln1303"> </a>
<a name="ln1304">FramePart::FramePart(int32 part)</a>
<a name="ln1305">	:</a>
<a name="ln1306">	BView(NULL, B_WILL_DRAW | B_FRAME_EVENTS),</a>
<a name="ln1307">	fFramePart(part),</a>
<a name="ln1308">	fIsDesktop(true)</a>
<a name="ln1309">{</a>
<a name="ln1310">	_SetSizeAndAlignment();</a>
<a name="ln1311">}</a>
<a name="ln1312"> </a>
<a name="ln1313"> </a>
<a name="ln1314">void</a>
<a name="ln1315">FramePart::Draw(BRect rect)</a>
<a name="ln1316">{</a>
<a name="ln1317">	rgb_color color = HighColor();</a>
<a name="ln1318">	SetDrawingMode(B_OP_COPY);</a>
<a name="ln1319">	SetHighColor(Parent()-&gt;ViewColor());</a>
<a name="ln1320"> </a>
<a name="ln1321">	if (fIsDesktop) {</a>
<a name="ln1322">		switch (fFramePart) {</a>
<a name="ln1323">			case FRAME_TOP_LEFT:</a>
<a name="ln1324">				FillRect(rect);</a>
<a name="ln1325">				SetHighColor(160, 160, 160);</a>
<a name="ln1326">				FillRoundRect(BRect(0, 0, 8, 8), 3, 3);</a>
<a name="ln1327">				SetHighColor(96, 96, 96);</a>
<a name="ln1328">				StrokeRoundRect(BRect(0, 0, 8, 8), 3, 3);</a>
<a name="ln1329">				break;</a>
<a name="ln1330"> </a>
<a name="ln1331">			case FRAME_TOP:</a>
<a name="ln1332">				SetHighColor(160, 160, 160);</a>
<a name="ln1333">				FillRect(BRect(0, 1, rect.right, 3));</a>
<a name="ln1334">				SetHighColor(96, 96, 96);</a>
<a name="ln1335">				StrokeLine(BPoint(0, 0), BPoint(rect.right, 0));</a>
<a name="ln1336">				SetHighColor(0, 0, 0);</a>
<a name="ln1337">				StrokeLine(BPoint(0, 4), BPoint(rect.right, 4));</a>
<a name="ln1338">				break;</a>
<a name="ln1339"> </a>
<a name="ln1340">			case FRAME_TOP_RIGHT:</a>
<a name="ln1341">				FillRect(rect);</a>
<a name="ln1342">				SetHighColor(160, 160, 160);</a>
<a name="ln1343">				FillRoundRect(BRect(-4, 0, 4, 8), 3, 3);</a>
<a name="ln1344">				SetHighColor(96, 96, 96);</a>
<a name="ln1345">				StrokeRoundRect(BRect(-4, 0, 4, 8), 3, 3);</a>
<a name="ln1346">				break;</a>
<a name="ln1347"> </a>
<a name="ln1348">			case FRAME_LEFT_SIDE:</a>
<a name="ln1349">				SetHighColor(160, 160, 160);</a>
<a name="ln1350">				FillRect(BRect(1, 0, 3, rect.bottom));</a>
<a name="ln1351">				SetHighColor(96, 96, 96);</a>
<a name="ln1352">				StrokeLine(BPoint(0, 0), BPoint(0, rect.bottom));</a>
<a name="ln1353">				SetHighColor(0, 0, 0);</a>
<a name="ln1354">				StrokeLine(BPoint(4, 0), BPoint(4, rect.bottom));</a>
<a name="ln1355">				break;</a>
<a name="ln1356"> </a>
<a name="ln1357">			case FRAME_RIGHT_SIDE:</a>
<a name="ln1358">				SetHighColor(160, 160, 160);</a>
<a name="ln1359">				FillRect(BRect(1, 0, 3, rect.bottom));</a>
<a name="ln1360">				SetHighColor(0, 0, 0);</a>
<a name="ln1361">				StrokeLine(BPoint(0, 0), BPoint(0, rect.bottom));</a>
<a name="ln1362">				SetHighColor(96, 96, 96);</a>
<a name="ln1363">				StrokeLine(BPoint(4, 0), BPoint(4, rect.bottom));</a>
<a name="ln1364">				break;</a>
<a name="ln1365"> </a>
<a name="ln1366">			case FRAME_BOTTOM_LEFT:</a>
<a name="ln1367">				FillRect(rect);</a>
<a name="ln1368">				SetHighColor(160, 160, 160);</a>
<a name="ln1369">				FillRoundRect(BRect(0, -4, 8, 4), 3, 3);</a>
<a name="ln1370">				SetHighColor(96, 96, 96);</a>
<a name="ln1371">				StrokeRoundRect(BRect(0, -4, 8, 4), 3, 3);</a>
<a name="ln1372">				break;</a>
<a name="ln1373"> </a>
<a name="ln1374">			case FRAME_BOTTOM:</a>
<a name="ln1375">				SetHighColor(160, 160, 160);</a>
<a name="ln1376">				FillRect(BRect(0, 1, rect.right, 3));</a>
<a name="ln1377">				SetHighColor(0, 0, 0);</a>
<a name="ln1378">				StrokeLine(BPoint(0, 0), BPoint(rect.right, 0));</a>
<a name="ln1379">				SetHighColor(96, 96, 96);</a>
<a name="ln1380">				StrokeLine(BPoint(0, 4), BPoint(rect.right, 4));</a>
<a name="ln1381">				SetHighColor(228, 0, 0);</a>
<a name="ln1382">				StrokeLine(BPoint(5, 2), BPoint(7, 2));</a>
<a name="ln1383">				break;</a>
<a name="ln1384"> </a>
<a name="ln1385">			case FRAME_BOTTOM_RIGHT:</a>
<a name="ln1386">				FillRect(rect);</a>
<a name="ln1387">				SetHighColor(160, 160, 160);</a>
<a name="ln1388">				FillRoundRect(BRect(-4, -4, 4, 4), 3, 3);</a>
<a name="ln1389">				SetHighColor(96, 96, 96);</a>
<a name="ln1390">				StrokeRoundRect(BRect(-4, -4, 4, 4), 3, 3);</a>
<a name="ln1391">				break;</a>
<a name="ln1392"> </a>
<a name="ln1393">			default:</a>
<a name="ln1394">				break;</a>
<a name="ln1395">		}</a>
<a name="ln1396">	} else {</a>
<a name="ln1397">		switch (fFramePart) {</a>
<a name="ln1398">			case FRAME_TOP_LEFT:</a>
<a name="ln1399">				SetHighColor(152, 152, 152);</a>
<a name="ln1400">				StrokeLine(BPoint(0, 0), BPoint(0, 12));</a>
<a name="ln1401">				StrokeLine(BPoint(0, 0), BPoint(4, 0));</a>
<a name="ln1402">				StrokeLine(BPoint(3, 12), BPoint(3, 12));</a>
<a name="ln1403">				SetHighColor(255, 203, 0);</a>
<a name="ln1404">				FillRect(BRect(1, 1, 3, 9));</a>
<a name="ln1405">				SetHighColor(240, 240, 240);</a>
<a name="ln1406">				StrokeLine(BPoint(1, 12), BPoint(1, 10));</a>
<a name="ln1407">				StrokeLine(BPoint(2, 10), BPoint(3, 10));</a>
<a name="ln1408">				SetHighColor(200, 200, 200);</a>
<a name="ln1409">				StrokeLine(BPoint(2, 12), BPoint(2, 11));</a>
<a name="ln1410">				StrokeLine(BPoint(3, 11), BPoint(3, 11));</a>
<a name="ln1411">				break;</a>
<a name="ln1412"> </a>
<a name="ln1413">			case FRAME_TOP:</a>
<a name="ln1414">				FillRect(BRect(54, 0, rect.right, 8));</a>
<a name="ln1415">				SetHighColor(255, 203, 0);</a>
<a name="ln1416">				FillRect(BRect(0, 1, 52, 9));</a>
<a name="ln1417">				SetHighColor(152, 152, 152);</a>
<a name="ln1418">				StrokeLine(BPoint(0, 0), BPoint(53, 0));</a>
<a name="ln1419">				StrokeLine(BPoint(53, 1), BPoint(53, 9));</a>
<a name="ln1420">				StrokeLine(BPoint(54, 9), BPoint(rect.right, 9));</a>
<a name="ln1421">				SetHighColor(240, 240, 240);</a>
<a name="ln1422">				StrokeLine(BPoint(0, 10), BPoint(rect.right, 10));</a>
<a name="ln1423">				SetHighColor(200, 200, 200);</a>
<a name="ln1424">				StrokeLine(BPoint(0, 11), BPoint(rect.right, 11));</a>
<a name="ln1425">				SetHighColor(152, 152, 152);</a>
<a name="ln1426">				StrokeLine(BPoint(0, 12), BPoint(rect.right, 12));</a>
<a name="ln1427">				break;</a>
<a name="ln1428"> </a>
<a name="ln1429">			case FRAME_TOP_RIGHT:</a>
<a name="ln1430">				FillRect(BRect(0, 0, 3, 8));</a>
<a name="ln1431">				SetHighColor(152, 152, 152);</a>
<a name="ln1432">				StrokeLine(BPoint(0, 12), BPoint(0, 12));</a>
<a name="ln1433">				StrokeLine(BPoint(0, 9), BPoint(3, 9));</a>
<a name="ln1434">				StrokeLine(BPoint(3, 12), BPoint(3, 9));</a>
<a name="ln1435">				SetHighColor(240, 240, 240);</a>
<a name="ln1436">				StrokeLine(BPoint(0, 10), BPoint(2, 10));</a>
<a name="ln1437">				StrokeLine(BPoint(1, 12), BPoint(1, 12));</a>
<a name="ln1438">				SetHighColor(200, 200, 200);</a>
<a name="ln1439">				StrokeLine(BPoint(2, 12), BPoint(2, 12));</a>
<a name="ln1440">				StrokeLine(BPoint(0, 11), BPoint(2, 11));</a>
<a name="ln1441">				break;</a>
<a name="ln1442"> </a>
<a name="ln1443">			case FRAME_LEFT_SIDE:</a>
<a name="ln1444">			case FRAME_RIGHT_SIDE:</a>
<a name="ln1445">				SetHighColor(152, 152, 152);</a>
<a name="ln1446">				StrokeLine(BPoint(0, 0), BPoint(0, rect.bottom));</a>
<a name="ln1447">				SetHighColor(240, 240, 240);</a>
<a name="ln1448">				StrokeLine(BPoint(1, 0), BPoint(1, rect.bottom));</a>
<a name="ln1449">				SetHighColor(200, 200, 200);</a>
<a name="ln1450">				StrokeLine(BPoint(2, 0), BPoint(2, rect.bottom));</a>
<a name="ln1451">				SetHighColor(152, 152, 152);</a>
<a name="ln1452">				StrokeLine(BPoint(3, 0), BPoint(3, rect.bottom));</a>
<a name="ln1453">				break;</a>
<a name="ln1454"> </a>
<a name="ln1455">			case FRAME_BOTTOM_LEFT:</a>
<a name="ln1456">				SetHighColor(152, 152, 152);</a>
<a name="ln1457">				StrokeLine(BPoint(0, 0), BPoint(0, 3));</a>
<a name="ln1458">				StrokeLine(BPoint(0, 3), BPoint(3, 3));</a>
<a name="ln1459">				StrokeLine(BPoint(3, 0), BPoint(3, 0));</a>
<a name="ln1460">				SetHighColor(240, 240, 240);</a>
<a name="ln1461">				StrokeLine(BPoint(1, 0), BPoint(1, 2));</a>
<a name="ln1462">				StrokeLine(BPoint(3, 1), BPoint(3, 1));</a>
<a name="ln1463">				SetHighColor(200, 200, 200);</a>
<a name="ln1464">				StrokeLine(BPoint(2, 0), BPoint(2, 2));</a>
<a name="ln1465">				StrokeLine(BPoint(3, 2), BPoint(3, 2));</a>
<a name="ln1466">				break;</a>
<a name="ln1467"> </a>
<a name="ln1468">			case FRAME_BOTTOM:</a>
<a name="ln1469">				SetHighColor(152, 152, 152);</a>
<a name="ln1470">				StrokeLine(BPoint(0, 0), BPoint(rect.right, 0));</a>
<a name="ln1471">				SetHighColor(240, 240, 240);</a>
<a name="ln1472">				StrokeLine(BPoint(0, 1), BPoint(rect.right, 1));</a>
<a name="ln1473">				SetHighColor(200, 200, 200);</a>
<a name="ln1474">				StrokeLine(BPoint(0, 2), BPoint(rect.right, 2));</a>
<a name="ln1475">				SetHighColor(152, 152, 152);</a>
<a name="ln1476">				StrokeLine(BPoint(0, 3), BPoint(rect.right, 3));</a>
<a name="ln1477">				break;</a>
<a name="ln1478"> </a>
<a name="ln1479">			case FRAME_BOTTOM_RIGHT:</a>
<a name="ln1480">				SetHighColor(152, 152, 152);</a>
<a name="ln1481">				StrokeLine(BPoint(0, 0), BPoint(0, 0));</a>
<a name="ln1482">				SetHighColor(240, 240, 240);</a>
<a name="ln1483">				StrokeLine(BPoint(1, 0), BPoint(1, 1));</a>
<a name="ln1484">				StrokeLine(BPoint(0, 1), BPoint(0, 1));</a>
<a name="ln1485">				SetHighColor(200, 200, 200);</a>
<a name="ln1486">				StrokeLine(BPoint(2, 0), BPoint(2, 2));</a>
<a name="ln1487">				StrokeLine(BPoint(0, 2), BPoint(1, 2));</a>
<a name="ln1488">				SetHighColor(152, 152, 152);</a>
<a name="ln1489">				StrokeLine(BPoint(3, 0), BPoint(3, 3));</a>
<a name="ln1490">				StrokeLine(BPoint(0, 3), BPoint(2, 3));</a>
<a name="ln1491">				break;</a>
<a name="ln1492"> </a>
<a name="ln1493">			default:</a>
<a name="ln1494">				break;</a>
<a name="ln1495">		}</a>
<a name="ln1496">	}</a>
<a name="ln1497"> </a>
<a name="ln1498">	SetHighColor(color);</a>
<a name="ln1499">}</a>
<a name="ln1500"> </a>
<a name="ln1501"> </a>
<a name="ln1502">void</a>
<a name="ln1503">FramePart::SetDesktop(bool isDesktop)</a>
<a name="ln1504">{</a>
<a name="ln1505">	fIsDesktop = isDesktop;</a>
<a name="ln1506"> </a>
<a name="ln1507">	_SetSizeAndAlignment();</a>
<a name="ln1508">	Invalidate();</a>
<a name="ln1509">}</a>
<a name="ln1510"> </a>
<a name="ln1511"> </a>
<a name="ln1512">void</a>
<a name="ln1513">FramePart::_SetSizeAndAlignment()</a>
<a name="ln1514">{</a>
<a name="ln1515">	if (fIsDesktop) {</a>
<a name="ln1516">		switch (fFramePart) {</a>
<a name="ln1517">			case FRAME_TOP_LEFT:</a>
<a name="ln1518">				SetExplicitMinSize(BSize(4, 4));</a>
<a name="ln1519">				SetExplicitMaxSize(BSize(4, 4));</a>
<a name="ln1520">				break;</a>
<a name="ln1521"> </a>
<a name="ln1522">			case FRAME_TOP:</a>
<a name="ln1523">				SetExplicitMinSize(BSize(1, 4));</a>
<a name="ln1524">				SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, 4));</a>
<a name="ln1525">				break;</a>
<a name="ln1526"> </a>
<a name="ln1527">			case FRAME_TOP_RIGHT:</a>
<a name="ln1528">				SetExplicitMinSize(BSize(4, 4));</a>
<a name="ln1529">				SetExplicitMaxSize(BSize(4, 4));</a>
<a name="ln1530">				break;</a>
<a name="ln1531"> </a>
<a name="ln1532">			case FRAME_LEFT_SIDE:</a>
<a name="ln1533">				SetExplicitMinSize(BSize(4, 1));</a>
<a name="ln1534">				SetExplicitMaxSize(BSize(4, B_SIZE_UNLIMITED));</a>
<a name="ln1535">				break;</a>
<a name="ln1536"> </a>
<a name="ln1537">			case FRAME_RIGHT_SIDE:</a>
<a name="ln1538">				SetExplicitMinSize(BSize(4, 1));</a>
<a name="ln1539">				SetExplicitMaxSize(BSize(4, B_SIZE_UNLIMITED));</a>
<a name="ln1540">				break;</a>
<a name="ln1541"> </a>
<a name="ln1542">			case FRAME_BOTTOM_LEFT:</a>
<a name="ln1543">				SetExplicitMinSize(BSize(4, 4));</a>
<a name="ln1544">				SetExplicitMaxSize(BSize(4, 4));</a>
<a name="ln1545">				break;</a>
<a name="ln1546"> </a>
<a name="ln1547">			case FRAME_BOTTOM:</a>
<a name="ln1548">				SetExplicitMinSize(BSize(1, 4));</a>
<a name="ln1549">				SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, 4));</a>
<a name="ln1550">				break;</a>
<a name="ln1551"> </a>
<a name="ln1552">			case FRAME_BOTTOM_RIGHT:</a>
<a name="ln1553">				SetExplicitMaxSize(BSize(4, 4));</a>
<a name="ln1554">				SetExplicitMinSize(BSize(4, 4));</a>
<a name="ln1555">				break;</a>
<a name="ln1556"> </a>
<a name="ln1557">			default:</a>
<a name="ln1558">				break;</a>
<a name="ln1559">		}</a>
<a name="ln1560">	} else {</a>
<a name="ln1561">		switch (fFramePart) {</a>
<a name="ln1562">			case FRAME_TOP_LEFT:</a>
<a name="ln1563">				SetExplicitMinSize(BSize(3, 12));</a>
<a name="ln1564">				SetExplicitMaxSize(BSize(3, 12));</a>
<a name="ln1565">				break;</a>
<a name="ln1566"> </a>
<a name="ln1567">			case FRAME_TOP:</a>
<a name="ln1568">				SetExplicitMinSize(BSize(1, 12));</a>
<a name="ln1569">				SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, 12));</a>
<a name="ln1570">				break;</a>
<a name="ln1571"> </a>
<a name="ln1572">			case FRAME_TOP_RIGHT:</a>
<a name="ln1573">				SetExplicitMinSize(BSize(3, 12));</a>
<a name="ln1574">				SetExplicitMaxSize(BSize(3, 12));</a>
<a name="ln1575">				break;</a>
<a name="ln1576"> </a>
<a name="ln1577">			case FRAME_LEFT_SIDE:</a>
<a name="ln1578">				SetExplicitMinSize(BSize(3, 1));</a>
<a name="ln1579">				SetExplicitMaxSize(BSize(3, B_SIZE_UNLIMITED));</a>
<a name="ln1580">				break;</a>
<a name="ln1581"> </a>
<a name="ln1582">			case FRAME_RIGHT_SIDE:</a>
<a name="ln1583">				SetExplicitMinSize(BSize(3, 1));</a>
<a name="ln1584">				SetExplicitMaxSize(BSize(3, B_SIZE_UNLIMITED));</a>
<a name="ln1585">				break;</a>
<a name="ln1586"> </a>
<a name="ln1587">			case FRAME_BOTTOM_LEFT:</a>
<a name="ln1588">				SetExplicitMinSize(BSize(3, 3));</a>
<a name="ln1589">				SetExplicitMaxSize(BSize(3, 3));</a>
<a name="ln1590">				break;</a>
<a name="ln1591"> </a>
<a name="ln1592">			case FRAME_BOTTOM:</a>
<a name="ln1593">				SetExplicitMinSize(BSize(1, 3));</a>
<a name="ln1594">				SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, 3));</a>
<a name="ln1595">				break;</a>
<a name="ln1596"> </a>
<a name="ln1597">			case FRAME_BOTTOM_RIGHT:</a>
<a name="ln1598">				SetExplicitMaxSize(BSize(3, 3));</a>
<a name="ln1599">				SetExplicitMinSize(BSize(3, 3));</a>
<a name="ln1600">				break;</a>
<a name="ln1601"> </a>
<a name="ln1602">			default:</a>
<a name="ln1603">				break;</a>
<a name="ln1604">		}</a>
<a name="ln1605">	}</a>
<a name="ln1606"> </a>
<a name="ln1607">	switch (fFramePart) {</a>
<a name="ln1608">		case FRAME_TOP_LEFT:</a>
<a name="ln1609">			SetExplicitAlignment(BAlignment(B_ALIGN_RIGHT, B_ALIGN_BOTTOM));</a>
<a name="ln1610">			break;</a>
<a name="ln1611"> </a>
<a name="ln1612">		case FRAME_TOP:</a>
<a name="ln1613">			SetExplicitAlignment(BAlignment(B_ALIGN_CENTER, B_ALIGN_BOTTOM));</a>
<a name="ln1614">			break;</a>
<a name="ln1615"> </a>
<a name="ln1616">		case FRAME_TOP_RIGHT:</a>
<a name="ln1617">			SetExplicitAlignment(BAlignment(B_ALIGN_LEFT, B_ALIGN_BOTTOM));</a>
<a name="ln1618">			break;</a>
<a name="ln1619"> </a>
<a name="ln1620">		case FRAME_LEFT_SIDE:</a>
<a name="ln1621">			SetExplicitAlignment(BAlignment(B_ALIGN_RIGHT, B_ALIGN_MIDDLE));</a>
<a name="ln1622">			break;</a>
<a name="ln1623"> </a>
<a name="ln1624">		case FRAME_RIGHT_SIDE:</a>
<a name="ln1625">			SetExplicitAlignment(BAlignment(B_ALIGN_LEFT, B_ALIGN_MIDDLE));</a>
<a name="ln1626">			break;</a>
<a name="ln1627"> </a>
<a name="ln1628">		case FRAME_BOTTOM_LEFT:</a>
<a name="ln1629">			SetExplicitAlignment(BAlignment(B_ALIGN_RIGHT, B_ALIGN_TOP));</a>
<a name="ln1630">			break;</a>
<a name="ln1631"> </a>
<a name="ln1632">		case FRAME_BOTTOM:</a>
<a name="ln1633">			SetExplicitAlignment(BAlignment(B_ALIGN_CENTER, B_ALIGN_TOP));</a>
<a name="ln1634">			break;</a>
<a name="ln1635"> </a>
<a name="ln1636">		case FRAME_BOTTOM_RIGHT:</a>
<a name="ln1637">			SetExplicitAlignment(BAlignment(B_ALIGN_LEFT, B_ALIGN_TOP));</a>
<a name="ln1638">			break;</a>
<a name="ln1639"> </a>
<a name="ln1640">		default:</a>
<a name="ln1641">			break;</a>
<a name="ln1642">	}</a>
<a name="ln1643">}</a>
<a name="ln1644"> </a>

</code></pre>
<div class="balloon" rel="245"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'imageMenuField' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="245"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'placementMenuField' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="665"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
