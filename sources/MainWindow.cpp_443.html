
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>MainWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2015, Axel Dörfler, &lt;axeld@pinc-software.de&gt;.</a>
<a name="ln3"> * Copyright 2013-2014, Stephan Aßmus &lt;superstippi@gmx.de&gt;.</a>
<a name="ln4"> * Copyright 2013, Rene Gollent, rene@gollent.com.</a>
<a name="ln5"> * Copyright 2013, Ingo Weinhold, ingo_weinhold@gmx.de.</a>
<a name="ln6"> * Copyright 2016-2019, Andrew Lindesay &lt;apl@lindesay.co.nz&gt;.</a>
<a name="ln7"> * Copyright 2017, Julian Harnath &lt;julian.harnath@rwth-aachen.de&gt;.</a>
<a name="ln8"> * All rights reserved. Distributed under the terms of the MIT License.</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;MainWindow.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;map&gt;</a>
<a name="ln15">#include &lt;vector&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;stdio.h&gt;</a>
<a name="ln18">#include &lt;Alert.h&gt;</a>
<a name="ln19">#include &lt;Autolock.h&gt;</a>
<a name="ln20">#include &lt;Application.h&gt;</a>
<a name="ln21">#include &lt;Button.h&gt;</a>
<a name="ln22">#include &lt;Catalog.h&gt;</a>
<a name="ln23">#include &lt;CardLayout.h&gt;</a>
<a name="ln24">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln25">#include &lt;MenuBar.h&gt;</a>
<a name="ln26">#include &lt;MenuItem.h&gt;</a>
<a name="ln27">#include &lt;Messenger.h&gt;</a>
<a name="ln28">#include &lt;Roster.h&gt;</a>
<a name="ln29">#include &lt;Screen.h&gt;</a>
<a name="ln30">#include &lt;ScrollView.h&gt;</a>
<a name="ln31">#include &lt;StringList.h&gt;</a>
<a name="ln32">#include &lt;StringView.h&gt;</a>
<a name="ln33">#include &lt;TabView.h&gt;</a>
<a name="ln34"> </a>
<a name="ln35">#include &quot;AppUtils.h&quot;</a>
<a name="ln36">#include &quot;AutoDeleter.h&quot;</a>
<a name="ln37">#include &quot;AutoLocker.h&quot;</a>
<a name="ln38">#include &quot;DecisionProvider.h&quot;</a>
<a name="ln39">#include &quot;FeaturedPackagesView.h&quot;</a>
<a name="ln40">#include &quot;FilterView.h&quot;</a>
<a name="ln41">#include &quot;Logger.h&quot;</a>
<a name="ln42">#include &quot;PackageInfoView.h&quot;</a>
<a name="ln43">#include &quot;PackageListView.h&quot;</a>
<a name="ln44">#include &quot;PackageManager.h&quot;</a>
<a name="ln45">#include &quot;ProcessCoordinator.h&quot;</a>
<a name="ln46">#include &quot;ProcessCoordinatorFactory.h&quot;</a>
<a name="ln47">#include &quot;RatePackageWindow.h&quot;</a>
<a name="ln48">#include &quot;support.h&quot;</a>
<a name="ln49">#include &quot;ScreenshotWindow.h&quot;</a>
<a name="ln50">#include &quot;UserLoginWindow.h&quot;</a>
<a name="ln51">#include &quot;WorkStatusView.h&quot;</a>
<a name="ln52"> </a>
<a name="ln53"> </a>
<a name="ln54">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln55">#define B_TRANSLATION_CONTEXT &quot;MainWindow&quot;</a>
<a name="ln56"> </a>
<a name="ln57"> </a>
<a name="ln58">enum {</a>
<a name="ln59">	MSG_BULK_LOAD_DONE		= 'mmwd',</a>
<a name="ln60">	MSG_REFRESH_REPOS			= 'mrrp',</a>
<a name="ln61">	MSG_MANAGE_REPOS			= 'mmrp',</a>
<a name="ln62">	MSG_SOFTWARE_UPDATER		= 'mswu',</a>
<a name="ln63">	MSG_LOG_IN					= 'lgin',</a>
<a name="ln64">	MSG_LOG_OUT					= 'lgot',</a>
<a name="ln65">	MSG_AUTHORIZATION_CHANGED	= 'athc',</a>
<a name="ln66">	MSG_CATEGORIES_LIST_CHANGED	= 'clic',</a>
<a name="ln67">	MSG_PACKAGE_CHANGED			= 'pchd',</a>
<a name="ln68">	MSG_WORK_STATUS_CHANGE		= 'wsch',</a>
<a name="ln69">	MSG_WORK_STATUS_CLEAR		= 'wscl',</a>
<a name="ln70"> </a>
<a name="ln71">	MSG_SHOW_FEATURED_PACKAGES	= 'sofp',</a>
<a name="ln72">	MSG_SHOW_AVAILABLE_PACKAGES	= 'savl',</a>
<a name="ln73">	MSG_SHOW_INSTALLED_PACKAGES	= 'sins',</a>
<a name="ln74">	MSG_SHOW_SOURCE_PACKAGES	= 'ssrc',</a>
<a name="ln75">	MSG_SHOW_DEVELOP_PACKAGES	= 'sdvl'</a>
<a name="ln76">};</a>
<a name="ln77"> </a>
<a name="ln78"> </a>
<a name="ln79">using namespace BPackageKit;</a>
<a name="ln80">using namespace BPackageKit::BManager::BPrivate;</a>
<a name="ln81"> </a>
<a name="ln82"> </a>
<a name="ln83">typedef std::map&lt;BString, PackageInfoRef&gt; PackageInfoMap;</a>
<a name="ln84"> </a>
<a name="ln85"> </a>
<a name="ln86">struct RefreshWorkerParameters {</a>
<a name="ln87">	MainWindow* window;</a>
<a name="ln88">	bool forceRefresh;</a>
<a name="ln89"> </a>
<a name="ln90">	RefreshWorkerParameters(MainWindow* window, bool forceRefresh)</a>
<a name="ln91">		:</a>
<a name="ln92">		window(window),</a>
<a name="ln93">		forceRefresh(forceRefresh)</a>
<a name="ln94">	{</a>
<a name="ln95">	}</a>
<a name="ln96">};</a>
<a name="ln97"> </a>
<a name="ln98"> </a>
<a name="ln99">class MainWindowModelListener : public ModelListener {</a>
<a name="ln100">public:</a>
<a name="ln101">	MainWindowModelListener(const BMessenger&amp; messenger)</a>
<a name="ln102">		:</a>
<a name="ln103">		fMessenger(messenger)</a>
<a name="ln104">	{</a>
<a name="ln105">	}</a>
<a name="ln106"> </a>
<a name="ln107">	virtual void AuthorizationChanged()</a>
<a name="ln108">	{</a>
<a name="ln109">		if (fMessenger.IsValid())</a>
<a name="ln110">			fMessenger.SendMessage(MSG_AUTHORIZATION_CHANGED);</a>
<a name="ln111">	}</a>
<a name="ln112"> </a>
<a name="ln113">	virtual void CategoryListChanged()</a>
<a name="ln114">	{</a>
<a name="ln115">		if (fMessenger.IsValid())</a>
<a name="ln116">			fMessenger.SendMessage(MSG_CATEGORIES_LIST_CHANGED);</a>
<a name="ln117">	}</a>
<a name="ln118"> </a>
<a name="ln119">private:</a>
<a name="ln120">	BMessenger	fMessenger;</a>
<a name="ln121">};</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">MainWindow::MainWindow(const BMessage&amp; settings)</a>
<a name="ln125">	:</a>
<a name="ln126">	BWindow(BRect(50, 50, 650, 550), B_TRANSLATE_SYSTEM_NAME(&quot;HaikuDepot&quot;),</a>
<a name="ln127">		B_DOCUMENT_WINDOW_LOOK, B_NORMAL_WINDOW_FEEL,</a>
<a name="ln128">		B_ASYNCHRONOUS_CONTROLS | B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln129">	fScreenshotWindow(NULL),</a>
<a name="ln130">	fUserMenu(NULL),</a>
<a name="ln131">	fLogInItem(NULL),</a>
<a name="ln132">	fLogOutItem(NULL),</a>
<a name="ln133">	fModelListener(new MainWindowModelListener(BMessenger(this)), true),</a>
<a name="ln134">	fBulkLoadProcessCoordinator(NULL),</a>
<a name="ln135">	fSinglePackageMode(false)</a>
<a name="ln136">{</a>
<a name="ln137">	BMenuBar* menuBar = new BMenuBar(&quot;Main Menu&quot;);</a>
<a name="ln138">	_BuildMenu(menuBar);</a>
<a name="ln139"> </a>
<a name="ln140">	BMenuBar* userMenuBar = new BMenuBar(&quot;User Menu&quot;);</a>
<a name="ln141">	_BuildUserMenu(userMenuBar);</a>
<a name="ln142">	set_small_font(userMenuBar);</a>
<a name="ln143">	userMenuBar-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNSET,</a>
<a name="ln144">		menuBar-&gt;MaxSize().height));</a>
<a name="ln145"> </a>
<a name="ln146">	fFilterView = new FilterView();</a>
<a name="ln147">	fFeaturedPackagesView = new FeaturedPackagesView();</a>
<a name="ln148">	fPackageListView = new PackageListView(fModel.Lock());</a>
<a name="ln149">	fPackageInfoView = new PackageInfoView(fModel.Lock(), this);</a>
<a name="ln150"> </a>
<a name="ln151">	fSplitView = new BSplitView(B_VERTICAL, 5.0f);</a>
<a name="ln152"> </a>
<a name="ln153">	fWorkStatusView = new WorkStatusView(&quot;work status&quot;);</a>
<a name="ln154">	fPackageListView-&gt;AttachWorkStatusView(fWorkStatusView);</a>
<a name="ln155"> </a>
<a name="ln156">	fListTabs = new TabView(BMessenger(this),</a>
<a name="ln157">		BMessage(MSG_SHOW_FEATURED_PACKAGES), &quot;list tabs&quot;);</a>
<a name="ln158">	fListTabs-&gt;AddTab(fFeaturedPackagesView);</a>
<a name="ln159">	fListTabs-&gt;AddTab(fPackageListView);</a>
<a name="ln160"> </a>
<a name="ln161">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0.0f)</a>
<a name="ln162">		.AddGroup(B_HORIZONTAL, 0.0f)</a>
<a name="ln163">			.Add(menuBar, 1.0f)</a>
<a name="ln164">			.Add(userMenuBar, 0.0f)</a>
<a name="ln165">		.End()</a>
<a name="ln166">		.Add(fFilterView)</a>
<a name="ln167">		.AddSplit(fSplitView)</a>
<a name="ln168">			.AddGroup(B_VERTICAL)</a>
<a name="ln169">				.Add(fListTabs)</a>
<a name="ln170">				.SetInsets(</a>
<a name="ln171">					B_USE_DEFAULT_SPACING, 0.0f,</a>
<a name="ln172">					B_USE_DEFAULT_SPACING, 0.0f)</a>
<a name="ln173">			.End()</a>
<a name="ln174">			.Add(fPackageInfoView)</a>
<a name="ln175">		.End()</a>
<a name="ln176">		.Add(fWorkStatusView)</a>
<a name="ln177">	;</a>
<a name="ln178"> </a>
<a name="ln179">	fSplitView-&gt;SetCollapsible(0, false);</a>
<a name="ln180">	fSplitView-&gt;SetCollapsible(1, false);</a>
<a name="ln181"> </a>
<a name="ln182">	fModel.AddListener(fModelListener);</a>
<a name="ln183"> </a>
<a name="ln184">	// Restore settings</a>
<a name="ln185">	BMessage columnSettings;</a>
<a name="ln186">	if (settings.FindMessage(&quot;column settings&quot;, &amp;columnSettings) == B_OK)</a>
<a name="ln187">		fPackageListView-&gt;LoadState(&amp;columnSettings);</a>
<a name="ln188"> </a>
<a name="ln189">	bool showOption;</a>
<a name="ln190">	if (settings.FindBool(&quot;show featured packages&quot;, &amp;showOption) == B_OK)</a>
<a name="ln191">		fModel.SetShowFeaturedPackages(showOption);</a>
<a name="ln192">	if (settings.FindBool(&quot;show available packages&quot;, &amp;showOption) == B_OK)</a>
<a name="ln193">		fModel.SetShowAvailablePackages(showOption);</a>
<a name="ln194">	if (settings.FindBool(&quot;show installed packages&quot;, &amp;showOption) == B_OK)</a>
<a name="ln195">		fModel.SetShowInstalledPackages(showOption);</a>
<a name="ln196">	if (settings.FindBool(&quot;show develop packages&quot;, &amp;showOption) == B_OK)</a>
<a name="ln197">		fModel.SetShowDevelopPackages(showOption);</a>
<a name="ln198">	if (settings.FindBool(&quot;show source packages&quot;, &amp;showOption) == B_OK)</a>
<a name="ln199">		fModel.SetShowSourcePackages(showOption);</a>
<a name="ln200"> </a>
<a name="ln201">	if (fModel.ShowFeaturedPackages())</a>
<a name="ln202">		fListTabs-&gt;Select(0);</a>
<a name="ln203">	else</a>
<a name="ln204">		fListTabs-&gt;Select(1);</a>
<a name="ln205"> </a>
<a name="ln206">	_RestoreUserName(settings);</a>
<a name="ln207">	_RestoreWindowFrame(settings);</a>
<a name="ln208"> </a>
<a name="ln209">	atomic_set(&amp;fPackagesToShowListID, 0);</a>
<a name="ln210"> </a>
<a name="ln211">	// start worker threads</a>
<a name="ln212">	BPackageRoster().StartWatching(this,</a>
<a name="ln213">		B_WATCH_PACKAGE_INSTALLATION_LOCATIONS);</a>
<a name="ln214"> </a>
<a name="ln215">	_StartBulkLoad();</a>
<a name="ln216"> </a>
<a name="ln217">	_InitWorkerThreads();</a>
<a name="ln218">}</a>
<a name="ln219"> </a>
<a name="ln220"> </a>
<a name="ln221">MainWindow::MainWindow(const BMessage&amp; settings, const PackageInfoRef&amp; package)</a>
<a name="ln222">	:</a>
<a name="ln223">	BWindow(BRect(50, 50, 650, 350), B_TRANSLATE_SYSTEM_NAME(&quot;HaikuDepot&quot;),</a>
<a name="ln224">		B_DOCUMENT_WINDOW_LOOK, B_NORMAL_WINDOW_FEEL,</a>
<a name="ln225">		B_ASYNCHRONOUS_CONTROLS | B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln226">	fWorkStatusView(NULL),</a>
<a name="ln227">	fScreenshotWindow(NULL),</a>
<a name="ln228">	fUserMenu(NULL),</a>
<a name="ln229">	fLogInItem(NULL),</a>
<a name="ln230">	fLogOutItem(NULL),</a>
<a name="ln231">	fModelListener(new MainWindowModelListener(BMessenger(this)), true),</a>
<a name="ln232">	fBulkLoadProcessCoordinator(NULL),</a>
<a name="ln233">	fSinglePackageMode(true)</a>
<a name="ln234">{</a>
<a name="ln235">	fFilterView = new FilterView();</a>
<a name="ln236">	fPackageListView = new PackageListView(fModel.Lock());</a>
<a name="ln237">	fPackageInfoView = new PackageInfoView(fModel.Lock(), this);</a>
<a name="ln238"> </a>
<a name="ln239">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL)</a>
<a name="ln240">		.Add(fPackageInfoView)</a>
<a name="ln241">		.SetInsets(0, B_USE_WINDOW_INSETS, 0, 0)</a>
<a name="ln242">	;</a>
<a name="ln243"> </a>
<a name="ln244">	fModel.AddListener(fModelListener);</a>
<a name="ln245"> </a>
<a name="ln246">	// Restore settings</a>
<a name="ln247">	_RestoreUserName(settings);</a>
<a name="ln248">	_RestoreWindowFrame(settings);</a>
<a name="ln249"> </a>
<a name="ln250">	fPackageInfoView-&gt;SetPackage(package);</a>
<a name="ln251"> </a>
<a name="ln252">	_InitWorkerThreads();</a>
<a name="ln253">}</a>
<a name="ln254"> </a>
<a name="ln255"> </a>
<a name="ln256">MainWindow::~MainWindow()</a>
<a name="ln257">{</a>
<a name="ln258">	BPackageRoster().StopWatching(this);</a>
<a name="ln259"> </a>
<a name="ln260">	delete_sem(fPendingActionsSem);</a>
<a name="ln261">	if (fPendingActionsWorker &gt;= 0)</a>
<a name="ln262">		wait_for_thread(fPendingActionsWorker, NULL);</a>
<a name="ln263"> </a>
<a name="ln264">	delete_sem(fPackageToPopulateSem);</a>
<a name="ln265">	if (fPopulatePackageWorker &gt;= 0)</a>
<a name="ln266">		wait_for_thread(fPopulatePackageWorker, NULL);</a>
<a name="ln267"> </a>
<a name="ln268">	delete_sem(fNewPackagesToShowSem);</a>
<a name="ln269">	delete_sem(fShowPackagesAcknowledgeSem);</a>
<a name="ln270">	if (fShowPackagesWorker &gt;= 0)</a>
<a name="ln271">		wait_for_thread(fShowPackagesWorker, NULL);</a>
<a name="ln272"> </a>
<a name="ln273">	if (fScreenshotWindow != NULL &amp;&amp; fScreenshotWindow-&gt;Lock())</a>
<a name="ln274">		fScreenshotWindow-&gt;Quit();</a>
<a name="ln275">}</a>
<a name="ln276"> </a>
<a name="ln277"> </a>
<a name="ln278">bool</a>
<a name="ln279">MainWindow::QuitRequested()</a>
<a name="ln280">{</a>
<a name="ln281">	BMessage settings;</a>
<a name="ln282">	StoreSettings(settings);</a>
<a name="ln283"> </a>
<a name="ln284">	BMessage message(MSG_MAIN_WINDOW_CLOSED);</a>
<a name="ln285">	message.AddMessage(KEY_WINDOW_SETTINGS, &amp;settings);</a>
<a name="ln286"> </a>
<a name="ln287">	be_app-&gt;PostMessage(&amp;message);</a>
<a name="ln288"> </a>
<a name="ln289">	_StopBulkLoad();</a>
<a name="ln290"> </a>
<a name="ln291">	return true;</a>
<a name="ln292">}</a>
<a name="ln293"> </a>
<a name="ln294"> </a>
<a name="ln295">void</a>
<a name="ln296">MainWindow::MessageReceived(BMessage* message)</a>
<a name="ln297">{</a>
<a name="ln298">	switch (message-&gt;what) {</a>
<a name="ln299">		case MSG_BULK_LOAD_DONE:</a>
<a name="ln300">			_BulkLoadCompleteReceived();</a>
<a name="ln301">			break;</a>
<a name="ln302">		case B_SIMPLE_DATA:</a>
<a name="ln303">		case B_REFS_RECEIVED:</a>
<a name="ln304">			// TODO: ?</a>
<a name="ln305">			break;</a>
<a name="ln306"> </a>
<a name="ln307">		case B_PACKAGE_UPDATE:</a>
<a name="ln308">			// TODO: We should do a more selective update depending on the</a>
<a name="ln309">			// &quot;event&quot;, &quot;location&quot;, and &quot;change count&quot; fields!</a>
<a name="ln310">			_StartBulkLoad(false);</a>
<a name="ln311">			break;</a>
<a name="ln312"> </a>
<a name="ln313">		case MSG_REFRESH_REPOS:</a>
<a name="ln314">			_StartBulkLoad(true);</a>
<a name="ln315">			break;</a>
<a name="ln316"> </a>
<a name="ln317">		case MSG_WORK_STATUS_CHANGE:</a>
<a name="ln318">			_HandleWorkStatusChangeMessageReceived(message);</a>
<a name="ln319">			break;</a>
<a name="ln320"> </a>
<a name="ln321">		case MSG_MANAGE_REPOS:</a>
<a name="ln322">			be_roster-&gt;Launch(&quot;application/x-vnd.Haiku-Repositories&quot;);</a>
<a name="ln323">			break;</a>
<a name="ln324"> </a>
<a name="ln325">		case MSG_SOFTWARE_UPDATER:</a>
<a name="ln326">			be_roster-&gt;Launch(&quot;application/x-vnd.haiku-softwareupdater&quot;);</a>
<a name="ln327">			break;</a>
<a name="ln328"> </a>
<a name="ln329">		case MSG_LOG_IN:</a>
<a name="ln330">			_OpenLoginWindow(BMessage());</a>
<a name="ln331">			break;</a>
<a name="ln332"> </a>
<a name="ln333">		case MSG_LOG_OUT:</a>
<a name="ln334">			fModel.SetUsername(&quot;&quot;);</a>
<a name="ln335">			break;</a>
<a name="ln336"> </a>
<a name="ln337">		case MSG_AUTHORIZATION_CHANGED:</a>
<a name="ln338">			_UpdateAuthorization();</a>
<a name="ln339">			break;</a>
<a name="ln340"> </a>
<a name="ln341">		case MSG_CATEGORIES_LIST_CHANGED:</a>
<a name="ln342">			fFilterView-&gt;AdoptModel(fModel);</a>
<a name="ln343">			break;</a>
<a name="ln344"> </a>
<a name="ln345">		case MSG_SHOW_FEATURED_PACKAGES:</a>
<a name="ln346">			// check to see if we aren't already on the current tab</a>
<a name="ln347">			if (fListTabs-&gt;Selection() ==</a>
<a name="ln348">					(fModel.ShowFeaturedPackages() ? 0 : 1))</a>
<a name="ln349">				break;</a>
<a name="ln350">			{</a>
<a name="ln351">				BAutolock locker(fModel.Lock());</a>
<a name="ln352">				fModel.SetShowFeaturedPackages(</a>
<a name="ln353">					fListTabs-&gt;Selection() == 0);</a>
<a name="ln354">			}</a>
<a name="ln355">			_AdoptModel();</a>
<a name="ln356">			break;</a>
<a name="ln357"> </a>
<a name="ln358">		case MSG_SHOW_AVAILABLE_PACKAGES:</a>
<a name="ln359">			{</a>
<a name="ln360">				BAutolock locker(fModel.Lock());</a>
<a name="ln361">				fModel.SetShowAvailablePackages(</a>
<a name="ln362">					!fModel.ShowAvailablePackages());</a>
<a name="ln363">			}</a>
<a name="ln364">			_AdoptModel();</a>
<a name="ln365">			break;</a>
<a name="ln366"> </a>
<a name="ln367">		case MSG_SHOW_INSTALLED_PACKAGES:</a>
<a name="ln368">			{</a>
<a name="ln369">				BAutolock locker(fModel.Lock());</a>
<a name="ln370">				fModel.SetShowInstalledPackages(</a>
<a name="ln371">					!fModel.ShowInstalledPackages());</a>
<a name="ln372">			}</a>
<a name="ln373">			_AdoptModel();</a>
<a name="ln374">			break;</a>
<a name="ln375"> </a>
<a name="ln376">		case MSG_SHOW_SOURCE_PACKAGES:</a>
<a name="ln377">			{</a>
<a name="ln378">				BAutolock locker(fModel.Lock());</a>
<a name="ln379">				fModel.SetShowSourcePackages(!fModel.ShowSourcePackages());</a>
<a name="ln380">			}</a>
<a name="ln381">			_AdoptModel();</a>
<a name="ln382">			break;</a>
<a name="ln383"> </a>
<a name="ln384">		case MSG_SHOW_DEVELOP_PACKAGES:</a>
<a name="ln385">			{</a>
<a name="ln386">				BAutolock locker(fModel.Lock());</a>
<a name="ln387">				fModel.SetShowDevelopPackages(!fModel.ShowDevelopPackages());</a>
<a name="ln388">			}</a>
<a name="ln389">			_AdoptModel();</a>
<a name="ln390">			break;</a>
<a name="ln391"> </a>
<a name="ln392">			// this may be triggered by, for example, a user rating being added</a>
<a name="ln393">			// or having been altered.</a>
<a name="ln394">		case MSG_SERVER_DATA_CHANGED:</a>
<a name="ln395">		{</a>
<a name="ln396">			BString name;</a>
<a name="ln397">			if (message-&gt;FindString(&quot;name&quot;, &amp;name) == B_OK) {</a>
<a name="ln398">				BAutolock locker(fModel.Lock());</a>
<a name="ln399">				if (fPackageInfoView-&gt;Package()-&gt;Name() == name) {</a>
<a name="ln400">					_PopulatePackageAsync(true);</a>
<a name="ln401">				} else {</a>
<a name="ln402">					if (Logger::IsDebugEnabled()) {</a>
<a name="ln403">						printf(&quot;pkg [%s] is updated on the server, but is &quot;</a>
<a name="ln404">							&quot;not selected so will not be updated.\n&quot;,</a>
<a name="ln405">							name.String());</a>
<a name="ln406">					}</a>
<a name="ln407">				}</a>
<a name="ln408">			}</a>
<a name="ln409">        	break;</a>
<a name="ln410">        }</a>
<a name="ln411"> </a>
<a name="ln412">		case MSG_PACKAGE_SELECTED:</a>
<a name="ln413">		{</a>
<a name="ln414">			BString name;</a>
<a name="ln415">			if (message-&gt;FindString(&quot;name&quot;, &amp;name) == B_OK) {</a>
<a name="ln416">				BAutolock locker(fModel.Lock());</a>
<a name="ln417">				int count = fVisiblePackages.CountItems();</a>
<a name="ln418">				for (int i = 0; i &lt; count; i++) {</a>
<a name="ln419">					const PackageInfoRef&amp; package</a>
<a name="ln420">						= fVisiblePackages.ItemAtFast(i);</a>
<a name="ln421">					if (package.Get() != NULL &amp;&amp; package-&gt;Name() == name) {</a>
<a name="ln422">						locker.Unlock();</a>
<a name="ln423">						_AdoptPackage(package);</a>
<a name="ln424">						break;</a>
<a name="ln425">					}</a>
<a name="ln426">				}</a>
<a name="ln427">			} else {</a>
<a name="ln428">				_ClearPackage();</a>
<a name="ln429">			}</a>
<a name="ln430">			break;</a>
<a name="ln431">		}</a>
<a name="ln432"> </a>
<a name="ln433">		case MSG_CATEGORY_SELECTED:</a>
<a name="ln434">		{</a>
<a name="ln435">			BString code;</a>
<a name="ln436">			if (message-&gt;FindString(&quot;code&quot;, &amp;code) != B_OK)</a>
<a name="ln437">				code = &quot;&quot;;</a>
<a name="ln438">			{</a>
<a name="ln439">				BAutolock locker(fModel.Lock());</a>
<a name="ln440">				fModel.SetCategory(code);</a>
<a name="ln441">			}</a>
<a name="ln442">			_AdoptModel();</a>
<a name="ln443">			break;</a>
<a name="ln444">		}</a>
<a name="ln445"> </a>
<a name="ln446">		case MSG_DEPOT_SELECTED:</a>
<a name="ln447">		{</a>
<a name="ln448">			BString name;</a>
<a name="ln449">			if (message-&gt;FindString(&quot;name&quot;, &amp;name) != B_OK)</a>
<a name="ln450">				name = &quot;&quot;;</a>
<a name="ln451">			{</a>
<a name="ln452">				BAutolock locker(fModel.Lock());</a>
<a name="ln453">				fModel.SetDepot(name);</a>
<a name="ln454">			}</a>
<a name="ln455">			_AdoptModel();</a>
<a name="ln456">			_UpdateAvailableRepositories();</a>
<a name="ln457">			break;</a>
<a name="ln458">		}</a>
<a name="ln459"> </a>
<a name="ln460">		case MSG_SEARCH_TERMS_MODIFIED:</a>
<a name="ln461">		{</a>
<a name="ln462">			// TODO: Do this with a delay!</a>
<a name="ln463">			BString searchTerms;</a>
<a name="ln464">			if (message-&gt;FindString(&quot;search terms&quot;, &amp;searchTerms) != B_OK)</a>
<a name="ln465">				searchTerms = &quot;&quot;;</a>
<a name="ln466">			{</a>
<a name="ln467">				BAutolock locker(fModel.Lock());</a>
<a name="ln468">				fModel.SetSearchTerms(searchTerms);</a>
<a name="ln469">			}</a>
<a name="ln470">			_AdoptModel();</a>
<a name="ln471">			break;</a>
<a name="ln472">		}</a>
<a name="ln473"> </a>
<a name="ln474">		case MSG_PACKAGE_CHANGED:</a>
<a name="ln475">		{</a>
<a name="ln476">			PackageInfo* info;</a>
<a name="ln477">			if (message-&gt;FindPointer(&quot;package&quot;, (void**)&amp;info) == B_OK) {</a>
<a name="ln478">				PackageInfoRef ref(info, true);</a>
<a name="ln479">				uint32 changes;</a>
<a name="ln480">				if (message-&gt;FindUInt32(&quot;changes&quot;, &amp;changes) != B_OK)</a>
<a name="ln481">					changes = 0;</a>
<a name="ln482">				if ((changes &amp; PKG_CHANGED_STATE) != 0) {</a>
<a name="ln483">					BAutolock locker(fModel.Lock());</a>
<a name="ln484">					fModel.SetPackageState(ref, ref-&gt;State());</a>
<a name="ln485">				}</a>
<a name="ln486"> </a>
<a name="ln487">				// Asynchronous updates to the package information</a>
<a name="ln488">				// can mean that the package needs to be added or</a>
<a name="ln489">				// removed to/from the visible packages when the current</a>
<a name="ln490">				// filter parameters are re-evaluated on this package.</a>
<a name="ln491">				bool wasVisible = fVisiblePackages.Contains(ref);</a>
<a name="ln492">				bool isVisible;</a>
<a name="ln493">				{</a>
<a name="ln494">					BAutolock locker(fModel.Lock());</a>
<a name="ln495">					// The package didn't get a chance yet to be in the</a>
<a name="ln496">					// visible package list</a>
<a name="ln497">					isVisible = fModel.MatchesFilter(ref);</a>
<a name="ln498"> </a>
<a name="ln499">					// Transfer this single package, otherwise we miss</a>
<a name="ln500">					// other packages if they appear or disappear along</a>
<a name="ln501">					// with this one before receive a notification for</a>
<a name="ln502">					// them.</a>
<a name="ln503">					if (isVisible) {</a>
<a name="ln504">						fVisiblePackages.Add(ref);</a>
<a name="ln505">					} else if (wasVisible)</a>
<a name="ln506">						fVisiblePackages.Remove(ref);</a>
<a name="ln507">				}</a>
<a name="ln508"> </a>
<a name="ln509">				if (wasVisible != isVisible) {</a>
<a name="ln510">					if (!isVisible) {</a>
<a name="ln511">						fPackageListView-&gt;RemovePackage(ref);</a>
<a name="ln512">						fFeaturedPackagesView-&gt;RemovePackage(ref);</a>
<a name="ln513">					} else {</a>
<a name="ln514">						fPackageListView-&gt;AddPackage(ref);</a>
<a name="ln515">						if (ref-&gt;IsProminent())</a>
<a name="ln516">							fFeaturedPackagesView-&gt;AddPackage(ref);</a>
<a name="ln517">					}</a>
<a name="ln518">				}</a>
<a name="ln519"> </a>
<a name="ln520">				if (!fSinglePackageMode &amp;&amp; (changes &amp; PKG_CHANGED_STATE) != 0)</a>
<a name="ln521">					fWorkStatusView-&gt;PackageStatusChanged(ref);</a>
<a name="ln522">			}</a>
<a name="ln523">			break;</a>
<a name="ln524">		}</a>
<a name="ln525"> </a>
<a name="ln526">		case MSG_RATE_PACKAGE:</a>
<a name="ln527">			_RatePackage();</a>
<a name="ln528">			break;</a>
<a name="ln529"> </a>
<a name="ln530">		case MSG_SHOW_SCREENSHOT:</a>
<a name="ln531">			_ShowScreenshot();</a>
<a name="ln532">			break;</a>
<a name="ln533"> </a>
<a name="ln534">		case MSG_PACKAGE_WORKER_BUSY:</a>
<a name="ln535">		{</a>
<a name="ln536">			BString reason;</a>
<a name="ln537">			status_t status = message-&gt;FindString(&quot;reason&quot;, &amp;reason);</a>
<a name="ln538">			if (status != B_OK)</a>
<a name="ln539">				break;</a>
<a name="ln540">			if (!fSinglePackageMode)</a>
<a name="ln541">				fWorkStatusView-&gt;SetBusy(reason);</a>
<a name="ln542">			break;</a>
<a name="ln543">		}</a>
<a name="ln544"> </a>
<a name="ln545">		case MSG_PACKAGE_WORKER_IDLE:</a>
<a name="ln546">			if (!fSinglePackageMode)</a>
<a name="ln547">				fWorkStatusView-&gt;SetIdle();</a>
<a name="ln548">			break;</a>
<a name="ln549"> </a>
<a name="ln550">		case MSG_ADD_VISIBLE_PACKAGES:</a>
<a name="ln551">		{</a>
<a name="ln552">			struct SemaphoreReleaser {</a>
<a name="ln553">				SemaphoreReleaser(sem_id semaphore)</a>
<a name="ln554">					:</a>
<a name="ln555">					fSemaphore(semaphore)</a>
<a name="ln556">				{ }</a>
<a name="ln557"> </a>
<a name="ln558">				~SemaphoreReleaser() { release_sem(fSemaphore); }</a>
<a name="ln559"> </a>
<a name="ln560">				sem_id fSemaphore;</a>
<a name="ln561">			};</a>
<a name="ln562"> </a>
<a name="ln563">			// Make sure acknowledge semaphore is released even on error,</a>
<a name="ln564">			// so the worker thread won't be blocked</a>
<a name="ln565">			SemaphoreReleaser acknowledger(fShowPackagesAcknowledgeSem);</a>
<a name="ln566"> </a>
<a name="ln567">			int32 numPackages = 0;</a>
<a name="ln568">			type_code unused;</a>
<a name="ln569">			status_t status = message-&gt;GetInfo(&quot;package_ref&quot;, &amp;unused,</a>
<a name="ln570">				&amp;numPackages);</a>
<a name="ln571">			if (status != B_OK || numPackages == 0)</a>
<a name="ln572">				break;</a>
<a name="ln573"> </a>
<a name="ln574">			int32 listID = 0;</a>
<a name="ln575">			status = message-&gt;FindInt32(&quot;list_id&quot;, &amp;listID);</a>
<a name="ln576">			if (status != B_OK)</a>
<a name="ln577">				break;</a>
<a name="ln578">			if (listID != atomic_get(&amp;fPackagesToShowListID)) {</a>
<a name="ln579">				// list is outdated, ignore</a>
<a name="ln580">				break;</a>
<a name="ln581">			}</a>
<a name="ln582"> </a>
<a name="ln583">			for (int i = 0; i &lt; numPackages; i++) {</a>
<a name="ln584">				PackageInfo* packageRaw = NULL;</a>
<a name="ln585">				status = message-&gt;FindPointer(&quot;package_ref&quot;, i,</a>
<a name="ln586">					(void**)&amp;packageRaw);</a>
<a name="ln587">				if (status != B_OK)</a>
<a name="ln588">					break;</a>
<a name="ln589">				PackageInfoRef package(packageRaw, true);</a>
<a name="ln590"> </a>
<a name="ln591">				fPackageListView-&gt;AddPackage(package);</a>
<a name="ln592">				if (package-&gt;IsProminent())</a>
<a name="ln593">					fFeaturedPackagesView-&gt;AddPackage(package);</a>
<a name="ln594">			}</a>
<a name="ln595">			break;</a>
<a name="ln596">		}</a>
<a name="ln597"> </a>
<a name="ln598">		case MSG_UPDATE_SELECTED_PACKAGE:</a>
<a name="ln599">		{</a>
<a name="ln600">			const PackageInfoRef&amp; selectedPackage = fPackageInfoView-&gt;Package();</a>
<a name="ln601">			fFeaturedPackagesView-&gt;SelectPackage(selectedPackage, true);</a>
<a name="ln602">			fPackageListView-&gt;SelectPackage(selectedPackage);</a>
<a name="ln603"> </a>
<a name="ln604">			AutoLocker&lt;BLocker&gt; modelLocker(fModel.Lock());</a>
<a name="ln605">			if (!fVisiblePackages.Contains(fPackageInfoView-&gt;Package()))</a>
<a name="ln606">				fPackageInfoView-&gt;Clear();</a>
<a name="ln607">			break;</a>
<a name="ln608">		}</a>
<a name="ln609"> </a>
<a name="ln610">		default:</a>
<a name="ln611">			BWindow::MessageReceived(message);</a>
<a name="ln612">			break;</a>
<a name="ln613">	}</a>
<a name="ln614">}</a>
<a name="ln615"> </a>
<a name="ln616"> </a>
<a name="ln617">void</a>
<a name="ln618">MainWindow::StoreSettings(BMessage&amp; settings) const</a>
<a name="ln619">{</a>
<a name="ln620">	settings.AddRect(_WindowFrameName(), Frame());</a>
<a name="ln621">	if (!fSinglePackageMode) {</a>
<a name="ln622">		settings.AddRect(&quot;window frame&quot;, Frame());</a>
<a name="ln623"> </a>
<a name="ln624">		BMessage columnSettings;</a>
<a name="ln625">		fPackageListView-&gt;SaveState(&amp;columnSettings);</a>
<a name="ln626"> </a>
<a name="ln627">		settings.AddMessage(&quot;column settings&quot;, &amp;columnSettings);</a>
<a name="ln628"> </a>
<a name="ln629">		settings.AddBool(&quot;show featured packages&quot;,</a>
<a name="ln630">			fModel.ShowFeaturedPackages());</a>
<a name="ln631">		settings.AddBool(&quot;show available packages&quot;,</a>
<a name="ln632">			fModel.ShowAvailablePackages());</a>
<a name="ln633">		settings.AddBool(&quot;show installed packages&quot;,</a>
<a name="ln634">			fModel.ShowInstalledPackages());</a>
<a name="ln635">		settings.AddBool(&quot;show develop packages&quot;, fModel.ShowDevelopPackages());</a>
<a name="ln636">		settings.AddBool(&quot;show source packages&quot;, fModel.ShowSourcePackages());</a>
<a name="ln637">	}</a>
<a name="ln638"> </a>
<a name="ln639">	settings.AddString(&quot;username&quot;, fModel.Username());</a>
<a name="ln640">}</a>
<a name="ln641"> </a>
<a name="ln642"> </a>
<a name="ln643">void</a>
<a name="ln644">MainWindow::PackageChanged(const PackageInfoEvent&amp; event)</a>
<a name="ln645">{</a>
<a name="ln646">	uint32 watchedChanges = PKG_CHANGED_STATE | PKG_CHANGED_PROMINENCE;</a>
<a name="ln647">	if ((event.Changes() &amp; watchedChanges) != 0) {</a>
<a name="ln648">		PackageInfoRef ref(event.Package());</a>
<a name="ln649">		BMessage message(MSG_PACKAGE_CHANGED);</a>
<a name="ln650">		message.AddPointer(&quot;package&quot;, ref.Get());</a>
<a name="ln651">		message.AddUInt32(&quot;changes&quot;, event.Changes());</a>
<a name="ln652">		ref.Detach();</a>
<a name="ln653">			// reference needs to be released by MessageReceived();</a>
<a name="ln654">		PostMessage(&amp;message);</a>
<a name="ln655">	}</a>
<a name="ln656">}</a>
<a name="ln657"> </a>
<a name="ln658"> </a>
<a name="ln659">status_t</a>
<a name="ln660">MainWindow::SchedulePackageActions(PackageActionList&amp; list)</a>
<a name="ln661">{</a>
<a name="ln662">	AutoLocker&lt;BLocker&gt; lock(&amp;fPendingActionsLock);</a>
<a name="ln663">	for (int32 i = 0; i &lt; list.CountItems(); i++) {</a>
<a name="ln664">		if (!fPendingActions.Add(list.ItemAtFast(i)))</a>
<a name="ln665">			return B_NO_MEMORY;</a>
<a name="ln666">	}</a>
<a name="ln667"> </a>
<a name="ln668">	return release_sem_etc(fPendingActionsSem, list.CountItems(), 0);</a>
<a name="ln669">}</a>
<a name="ln670"> </a>
<a name="ln671"> </a>
<a name="ln672">Model*</a>
<a name="ln673">MainWindow::GetModel()</a>
<a name="ln674">{</a>
<a name="ln675">	return &amp;fModel;</a>
<a name="ln676">}</a>
<a name="ln677"> </a>
<a name="ln678"> </a>
<a name="ln679">void</a>
<a name="ln680">MainWindow::_BuildMenu(BMenuBar* menuBar)</a>
<a name="ln681">{</a>
<a name="ln682">	BMenu* menu = new BMenu(B_TRANSLATE(&quot;Tools&quot;));</a>
<a name="ln683">	fRefreshRepositoriesItem = new BMenuItem(</a>
<a name="ln684">		B_TRANSLATE(&quot;Refresh repositories&quot;), new BMessage(MSG_REFRESH_REPOS));</a>
<a name="ln685">	menu-&gt;AddItem(fRefreshRepositoriesItem);</a>
<a name="ln686">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Manage repositories&quot;</a>
<a name="ln687">		B_UTF8_ELLIPSIS), new BMessage(MSG_MANAGE_REPOS)));</a>
<a name="ln688">	menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Check for updates&quot;</a>
<a name="ln689">		B_UTF8_ELLIPSIS), new BMessage(MSG_SOFTWARE_UPDATER)));</a>
<a name="ln690"> </a>
<a name="ln691">	menuBar-&gt;AddItem(menu);</a>
<a name="ln692"> </a>
<a name="ln693">	fRepositoryMenu = new BMenu(B_TRANSLATE(&quot;Repositories&quot;));</a>
<a name="ln694">	menuBar-&gt;AddItem(fRepositoryMenu);</a>
<a name="ln695"> </a>
<a name="ln696">	menu = new BMenu(B_TRANSLATE(&quot;Show&quot;));</a>
<a name="ln697"> </a>
<a name="ln698">	fShowAvailablePackagesItem = new BMenuItem(</a>
<a name="ln699">		B_TRANSLATE(&quot;Available packages&quot;),</a>
<a name="ln700">		new BMessage(MSG_SHOW_AVAILABLE_PACKAGES));</a>
<a name="ln701">	menu-&gt;AddItem(fShowAvailablePackagesItem);</a>
<a name="ln702"> </a>
<a name="ln703">	fShowInstalledPackagesItem = new BMenuItem(</a>
<a name="ln704">		B_TRANSLATE(&quot;Installed packages&quot;),</a>
<a name="ln705">		new BMessage(MSG_SHOW_INSTALLED_PACKAGES));</a>
<a name="ln706">	menu-&gt;AddItem(fShowInstalledPackagesItem);</a>
<a name="ln707"> </a>
<a name="ln708">	menu-&gt;AddSeparatorItem();</a>
<a name="ln709"> </a>
<a name="ln710">	fShowDevelopPackagesItem = new BMenuItem(</a>
<a name="ln711">		B_TRANSLATE(&quot;Develop packages&quot;),</a>
<a name="ln712">		new BMessage(MSG_SHOW_DEVELOP_PACKAGES));</a>
<a name="ln713">	menu-&gt;AddItem(fShowDevelopPackagesItem);</a>
<a name="ln714"> </a>
<a name="ln715">	fShowSourcePackagesItem = new BMenuItem(</a>
<a name="ln716">		B_TRANSLATE(&quot;Source packages&quot;),</a>
<a name="ln717">		new BMessage(MSG_SHOW_SOURCE_PACKAGES));</a>
<a name="ln718">	menu-&gt;AddItem(fShowSourcePackagesItem);</a>
<a name="ln719"> </a>
<a name="ln720">	menuBar-&gt;AddItem(menu);</a>
<a name="ln721">}</a>
<a name="ln722"> </a>
<a name="ln723"> </a>
<a name="ln724">void</a>
<a name="ln725">MainWindow::_BuildUserMenu(BMenuBar* menuBar)</a>
<a name="ln726">{</a>
<a name="ln727">	fUserMenu = new BMenu(B_TRANSLATE(&quot;Not logged in&quot;));</a>
<a name="ln728"> </a>
<a name="ln729">	fLogInItem = new BMenuItem(B_TRANSLATE(&quot;Log in&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln730">		new BMessage(MSG_LOG_IN));</a>
<a name="ln731">	fUserMenu-&gt;AddItem(fLogInItem);</a>
<a name="ln732"> </a>
<a name="ln733">	fLogOutItem = new BMenuItem(B_TRANSLATE(&quot;Log out&quot;),</a>
<a name="ln734">		new BMessage(MSG_LOG_OUT));</a>
<a name="ln735">	fUserMenu-&gt;AddItem(fLogOutItem);</a>
<a name="ln736"> </a>
<a name="ln737">	menuBar-&gt;AddItem(fUserMenu);</a>
<a name="ln738">}</a>
<a name="ln739"> </a>
<a name="ln740"> </a>
<a name="ln741">void</a>
<a name="ln742">MainWindow::_RestoreUserName(const BMessage&amp; settings)</a>
<a name="ln743">{</a>
<a name="ln744">	BString username;</a>
<a name="ln745">	if (settings.FindString(&quot;username&quot;, &amp;username) == B_OK</a>
<a name="ln746">		&amp;&amp; username.Length() &gt; 0) {</a>
<a name="ln747">		fModel.SetUsername(username);</a>
<a name="ln748">	}</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751"> </a>
<a name="ln752">const char*</a>
<a name="ln753">MainWindow::_WindowFrameName() const</a>
<a name="ln754">{</a>
<a name="ln755">	if (fSinglePackageMode)</a>
<a name="ln756">		return &quot;small window frame&quot;;</a>
<a name="ln757"> </a>
<a name="ln758">	return &quot;window frame&quot;;</a>
<a name="ln759">}</a>
<a name="ln760"> </a>
<a name="ln761"> </a>
<a name="ln762">void</a>
<a name="ln763">MainWindow::_RestoreWindowFrame(const BMessage&amp; settings)</a>
<a name="ln764">{</a>
<a name="ln765">	BRect frame = Frame();</a>
<a name="ln766"> </a>
<a name="ln767">	BRect windowFrame;</a>
<a name="ln768">	bool fromSettings = false;</a>
<a name="ln769">	if (settings.FindRect(_WindowFrameName(), &amp;windowFrame) == B_OK) {</a>
<a name="ln770">		frame = windowFrame;</a>
<a name="ln771">		fromSettings = true;</a>
<a name="ln772">	} else if (!fSinglePackageMode) {</a>
<a name="ln773">		// Resize to occupy a certain screen size</a>
<a name="ln774">		BRect screenFrame = BScreen(this).Frame();</a>
<a name="ln775">		float width = frame.Width();</a>
<a name="ln776">		float height = frame.Height();</a>
<a name="ln777">		if (width &lt; screenFrame.Width() * .666f</a>
<a name="ln778">			&amp;&amp; height &lt; screenFrame.Height() * .666f) {</a>
<a name="ln779">			frame.bottom = frame.top + screenFrame.Height() * .666f;</a>
<a name="ln780">			frame.right = frame.left</a>
<a name="ln781">				+ std::min(screenFrame.Width() * .666f, height * 7 / 5);</a>
<a name="ln782">		}</a>
<a name="ln783">	}</a>
<a name="ln784"> </a>
<a name="ln785">	MoveTo(frame.LeftTop());</a>
<a name="ln786">	ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln787"> </a>
<a name="ln788">	if (fromSettings)</a>
<a name="ln789">		MoveOnScreen();</a>
<a name="ln790">	else</a>
<a name="ln791">		CenterOnScreen();</a>
<a name="ln792">}</a>
<a name="ln793"> </a>
<a name="ln794"> </a>
<a name="ln795">void</a>
<a name="ln796">MainWindow::_InitWorkerThreads()</a>
<a name="ln797">{</a>
<a name="ln798">	fPendingActionsSem = create_sem(0, &quot;PendingPackageActions&quot;);</a>
<a name="ln799">	if (fPendingActionsSem &gt;= 0) {</a>
<a name="ln800">		fPendingActionsWorker = spawn_thread(&amp;_PackageActionWorker,</a>
<a name="ln801">			&quot;Planet Express&quot;, B_NORMAL_PRIORITY, this);</a>
<a name="ln802">		if (fPendingActionsWorker &gt;= 0)</a>
<a name="ln803">			resume_thread(fPendingActionsWorker);</a>
<a name="ln804">	} else</a>
<a name="ln805">		fPendingActionsWorker = -1;</a>
<a name="ln806"> </a>
<a name="ln807">	fPackageToPopulateSem = create_sem(0, &quot;PopulatePackage&quot;);</a>
<a name="ln808">	if (fPackageToPopulateSem &gt;= 0) {</a>
<a name="ln809">		fPopulatePackageWorker = spawn_thread(&amp;_PopulatePackageWorker,</a>
<a name="ln810">			&quot;Package Populator&quot;, B_NORMAL_PRIORITY, this);</a>
<a name="ln811">		if (fPopulatePackageWorker &gt;= 0)</a>
<a name="ln812">			resume_thread(fPopulatePackageWorker);</a>
<a name="ln813">	} else</a>
<a name="ln814">		fPopulatePackageWorker = -1;</a>
<a name="ln815"> </a>
<a name="ln816">	fNewPackagesToShowSem = create_sem(0, &quot;ShowPackages&quot;);</a>
<a name="ln817">	fShowPackagesAcknowledgeSem = create_sem(0, &quot;ShowPackagesAck&quot;);</a>
<a name="ln818">	if (fNewPackagesToShowSem &gt;= 0 &amp;&amp; fShowPackagesAcknowledgeSem &gt;= 0) {</a>
<a name="ln819">		fShowPackagesWorker = spawn_thread(&amp;_PackagesToShowWorker,</a>
<a name="ln820">			&quot;Good news everyone&quot;, B_NORMAL_PRIORITY, this);</a>
<a name="ln821">		if (fShowPackagesWorker &gt;= 0)</a>
<a name="ln822">			resume_thread(fShowPackagesWorker);</a>
<a name="ln823">	} else</a>
<a name="ln824">		fShowPackagesWorker = -1;</a>
<a name="ln825">}</a>
<a name="ln826"> </a>
<a name="ln827"> </a>
<a name="ln828">void</a>
<a name="ln829">MainWindow::_AdoptModel()</a>
<a name="ln830">{</a>
<a name="ln831">	{</a>
<a name="ln832">		AutoLocker&lt;BLocker&gt; modelLocker(fModel.Lock());</a>
<a name="ln833">		fVisiblePackages = fModel.CreatePackageList();</a>
<a name="ln834">		AutoLocker&lt;BLocker&gt; listLocker(fPackagesToShowListLock);</a>
<a name="ln835">		fPackagesToShowList = fVisiblePackages;</a>
<a name="ln836">		atomic_add(&amp;fPackagesToShowListID, 1);</a>
<a name="ln837">	}</a>
<a name="ln838"> </a>
<a name="ln839">	fFeaturedPackagesView-&gt;Clear();</a>
<a name="ln840">	fPackageListView-&gt;Clear();</a>
<a name="ln841"> </a>
<a name="ln842">	release_sem(fNewPackagesToShowSem);</a>
<a name="ln843"> </a>
<a name="ln844">	BAutolock locker(fModel.Lock());</a>
<a name="ln845">	fShowAvailablePackagesItem-&gt;SetMarked(fModel.ShowAvailablePackages());</a>
<a name="ln846">	fShowInstalledPackagesItem-&gt;SetMarked(fModel.ShowInstalledPackages());</a>
<a name="ln847">	fShowSourcePackagesItem-&gt;SetMarked(fModel.ShowSourcePackages());</a>
<a name="ln848">	fShowDevelopPackagesItem-&gt;SetMarked(fModel.ShowDevelopPackages());</a>
<a name="ln849"> </a>
<a name="ln850">	if (fModel.ShowFeaturedPackages())</a>
<a name="ln851">		fListTabs-&gt;Select(0);</a>
<a name="ln852">	else</a>
<a name="ln853">		fListTabs-&gt;Select(1);</a>
<a name="ln854"> </a>
<a name="ln855">	fFilterView-&gt;AdoptModel(fModel);</a>
<a name="ln856">}</a>
<a name="ln857"> </a>
<a name="ln858"> </a>
<a name="ln859">void</a>
<a name="ln860">MainWindow::_AdoptPackage(const PackageInfoRef&amp; package)</a>
<a name="ln861">{</a>
<a name="ln862">	{</a>
<a name="ln863">		BAutolock locker(fModel.Lock());</a>
<a name="ln864">		fPackageInfoView-&gt;SetPackage(package);</a>
<a name="ln865"> </a>
<a name="ln866">		if (fFeaturedPackagesView != NULL)</a>
<a name="ln867">			fFeaturedPackagesView-&gt;SelectPackage(package);</a>
<a name="ln868">		if (fPackageListView != NULL)</a>
<a name="ln869">			fPackageListView-&gt;SelectPackage(package);</a>
<a name="ln870">	}</a>
<a name="ln871"> </a>
<a name="ln872">	_PopulatePackageAsync(false);</a>
<a name="ln873">}</a>
<a name="ln874"> </a>
<a name="ln875"> </a>
<a name="ln876">void</a>
<a name="ln877">MainWindow::_ClearPackage()</a>
<a name="ln878">{</a>
<a name="ln879">	fPackageInfoView-&gt;Clear();</a>
<a name="ln880">}</a>
<a name="ln881"> </a>
<a name="ln882"> </a>
<a name="ln883">void</a>
<a name="ln884">MainWindow::_StopBulkLoad()</a>
<a name="ln885">{</a>
<a name="ln886">	AutoLocker&lt;BLocker&gt; lock(&amp;fBulkLoadProcessCoordinatorLock);</a>
<a name="ln887"> </a>
<a name="ln888">	if (fBulkLoadProcessCoordinator != NULL) {</a>
<a name="ln889">		printf(&quot;will stop full update process coordinator\n&quot;);</a>
<a name="ln890">		fBulkLoadProcessCoordinator-&gt;Stop();</a>
<a name="ln891">	}</a>
<a name="ln892">}</a>
<a name="ln893"> </a>
<a name="ln894"> </a>
<a name="ln895">void</a>
<a name="ln896">MainWindow::_StartBulkLoad(bool force)</a>
<a name="ln897">{</a>
<a name="ln898">	AutoLocker&lt;BLocker&gt; lock(&amp;fBulkLoadProcessCoordinatorLock);</a>
<a name="ln899"> </a>
<a name="ln900">	if (fBulkLoadProcessCoordinator == NULL) {</a>
<a name="ln901">		fBulkLoadProcessCoordinator</a>
<a name="ln902">			= ProcessCoordinatorFactory::CreateBulkLoadCoordinator(</a>
<a name="ln903">				this,</a>
<a name="ln904">					// PackageInfoListener</a>
<a name="ln905">				this,</a>
<a name="ln906">					// ProcessCoordinatorListener</a>
<a name="ln907">				&amp;fModel, force);</a>
<a name="ln908">		fBulkLoadProcessCoordinator-&gt;Start();</a>
<a name="ln909">		fRefreshRepositoriesItem-&gt;SetEnabled(false);</a>
<a name="ln910">	}</a>
<a name="ln911">}</a>
<a name="ln912"> </a>
<a name="ln913"> </a>
<a name="ln914">/*! This method is called when there is some change in the bulk load process.</a>
<a name="ln915">    A change may mean that a new process has started / stopped etc... or it</a>
<a name="ln916">    may mean that the entire coordinator has finished.</a>
<a name="ln917">*/</a>
<a name="ln918"> </a>
<a name="ln919">void</a>
<a name="ln920">MainWindow::CoordinatorChanged(ProcessCoordinatorState&amp; coordinatorState)</a>
<a name="ln921">{</a>
<a name="ln922">	AutoLocker&lt;BLocker&gt; lock(&amp;fBulkLoadProcessCoordinatorLock);</a>
<a name="ln923"> </a>
<a name="ln924">	if (fBulkLoadProcessCoordinator == coordinatorState.Coordinator()) {</a>
<a name="ln925">		if (!coordinatorState.IsRunning())</a>
<a name="ln926">			_BulkLoadProcessCoordinatorFinished(coordinatorState);</a>
<a name="ln927">		else {</a>
<a name="ln928">			_NotifyWorkStatusChange(coordinatorState.Message(),</a>
<a name="ln929">				coordinatorState.Progress());</a>
<a name="ln930">				// show the progress to the user.</a>
<a name="ln931">		}</a>
<a name="ln932">	} else {</a>
<a name="ln933">		if (Logger::IsInfoEnabled()) {</a>
<a name="ln934">			printf(&quot;unknown process coordinator changed\n&quot;);</a>
<a name="ln935">		}</a>
<a name="ln936">	}</a>
<a name="ln937">}</a>
<a name="ln938"> </a>
<a name="ln939"> </a>
<a name="ln940">void</a>
<a name="ln941">MainWindow::_BulkLoadProcessCoordinatorFinished(</a>
<a name="ln942">	ProcessCoordinatorState&amp; coordinatorState)</a>
<a name="ln943">{</a>
<a name="ln944">	if (coordinatorState.ErrorStatus() != B_OK) {</a>
<a name="ln945">		AppUtils::NotifySimpleError(</a>
<a name="ln946">			B_TRANSLATE(&quot;Package Update Error&quot;),</a>
<a name="ln947">			B_TRANSLATE(&quot;While updating package data, a problem has arisen &quot;</a>
<a name="ln948">				&quot;that may cause data to be outdated or missing from the &quot;</a>
<a name="ln949">				&quot;application's display.  Additional details regarding this &quot;</a>
<a name="ln950">				&quot;problem may be able to be obtained from the application &quot;</a>
<a name="ln951">				&quot;logs.&quot;));</a>
<a name="ln952">	}</a>
<a name="ln953">	BMessenger messenger(this);</a>
<a name="ln954">	messenger.SendMessage(MSG_BULK_LOAD_DONE);</a>
<a name="ln955">	// it is safe to delete the coordinator here because it is already known</a>
<a name="ln956">	// that all of the processes have completed and their threads will have</a>
<a name="ln957">	// exited safely by this point.</a>
<a name="ln958">	delete fBulkLoadProcessCoordinator;</a>
<a name="ln959">	fBulkLoadProcessCoordinator = NULL;</a>
<a name="ln960">	fRefreshRepositoriesItem-&gt;SetEnabled(true);</a>
<a name="ln961">}</a>
<a name="ln962"> </a>
<a name="ln963"> </a>
<a name="ln964">void</a>
<a name="ln965">MainWindow::_BulkLoadCompleteReceived()</a>
<a name="ln966">{</a>
<a name="ln967">	_AdoptModel();</a>
<a name="ln968">	_UpdateAvailableRepositories();</a>
<a name="ln969">	fWorkStatusView-&gt;SetIdle();</a>
<a name="ln970">}</a>
<a name="ln971"> </a>
<a name="ln972"> </a>
<a name="ln973">/*! Sends off a message to the Window so that it can change the status view</a>
<a name="ln974">    on the front-end in the UI thread.</a>
<a name="ln975">*/</a>
<a name="ln976"> </a>
<a name="ln977">void</a>
<a name="ln978">MainWindow::_NotifyWorkStatusChange(const BString&amp; text, float progress)</a>
<a name="ln979">{</a>
<a name="ln980">	BMessage message(MSG_WORK_STATUS_CHANGE);</a>
<a name="ln981"> </a>
<a name="ln982">	if (!text.IsEmpty())</a>
<a name="ln983">		message.AddString(KEY_WORK_STATUS_TEXT, text);</a>
<a name="ln984">	message.AddFloat(KEY_WORK_STATUS_PROGRESS, progress);</a>
<a name="ln985"> </a>
<a name="ln986">	this-&gt;PostMessage(&amp;message, this);</a>
<a name="ln987">}</a>
<a name="ln988"> </a>
<a name="ln989"> </a>
<a name="ln990">void</a>
<a name="ln991">MainWindow::_HandleWorkStatusChangeMessageReceived(const BMessage* message)</a>
<a name="ln992">{</a>
<a name="ln993">	BString text;</a>
<a name="ln994">	float progress;</a>
<a name="ln995"> </a>
<a name="ln996">	if (message-&gt;FindString(KEY_WORK_STATUS_TEXT, &amp;text) == B_OK)</a>
<a name="ln997">		fWorkStatusView-&gt;SetText(text);</a>
<a name="ln998"> </a>
<a name="ln999">	if (message-&gt;FindFloat(KEY_WORK_STATUS_PROGRESS, &amp;progress) == B_OK)</a>
<a name="ln1000">		fWorkStatusView-&gt;SetProgress(progress);</a>
<a name="ln1001">}</a>
<a name="ln1002"> </a>
<a name="ln1003"> </a>
<a name="ln1004">status_t</a>
<a name="ln1005">MainWindow::_PackageActionWorker(void* arg)</a>
<a name="ln1006">{</a>
<a name="ln1007">	MainWindow* window = reinterpret_cast&lt;MainWindow*&gt;(arg);</a>
<a name="ln1008"> </a>
<a name="ln1009">	while (acquire_sem(window-&gt;fPendingActionsSem) == B_OK) {</a>
<a name="ln1010">		PackageActionRef ref;</a>
<a name="ln1011">		{</a>
<a name="ln1012">			AutoLocker&lt;BLocker&gt; lock(&amp;window-&gt;fPendingActionsLock);</a>
<a name="ln1013">			ref = window-&gt;fPendingActions.ItemAt(0);</a>
<a name="ln1014">			if (ref.Get() == NULL)</a>
<a name="ln1015">				break;</a>
<a name="ln1016">			window-&gt;fPendingActions.Remove(0);</a>
<a name="ln1017">		}</a>
<a name="ln1018"> </a>
<a name="ln1019">		BMessenger messenger(window);</a>
<a name="ln1020">		BMessage busyMessage(MSG_PACKAGE_WORKER_BUSY);</a>
<a name="ln1021">		BString text(ref-&gt;Label());</a>
<a name="ln1022">		text &lt;&lt; B_UTF8_ELLIPSIS;</a>
<a name="ln1023">		busyMessage.AddString(&quot;reason&quot;, text);</a>
<a name="ln1024"> </a>
<a name="ln1025">		messenger.SendMessage(&amp;busyMessage);</a>
<a name="ln1026">		ref-&gt;Perform();</a>
<a name="ln1027">		messenger.SendMessage(MSG_PACKAGE_WORKER_IDLE);</a>
<a name="ln1028">	}</a>
<a name="ln1029"> </a>
<a name="ln1030">	return 0;</a>
<a name="ln1031">}</a>
<a name="ln1032"> </a>
<a name="ln1033"> </a>
<a name="ln1034">/*! This method will cause the package to have its data refreshed from</a>
<a name="ln1035">    the server application.  The refresh happens in the background; this method</a>
<a name="ln1036">    is asynchronous.</a>
<a name="ln1037">*/</a>
<a name="ln1038"> </a>
<a name="ln1039">void</a>
<a name="ln1040">MainWindow::_PopulatePackageAsync(bool forcePopulate)</a>
<a name="ln1041">{</a>
<a name="ln1042">		// Trigger asynchronous package population from the web-app</a>
<a name="ln1043">	{</a>
<a name="ln1044">		AutoLocker&lt;BLocker&gt; lock(&amp;fPackageToPopulateLock);</a>
<a name="ln1045">		fPackageToPopulate = fPackageInfoView-&gt;Package();</a>
<a name="ln1046">		fForcePopulatePackage = forcePopulate;</a>
<a name="ln1047">	}</a>
<a name="ln1048">	release_sem_etc(fPackageToPopulateSem, 1, 0);</a>
<a name="ln1049"> </a>
<a name="ln1050">	if (Logger::IsDebugEnabled()) {</a>
<a name="ln1051">		printf(&quot;pkg [%s] will be updated from the server.\n&quot;,</a>
<a name="ln1052">			fPackageToPopulate-&gt;Name().String());</a>
<a name="ln1053">	}</a>
<a name="ln1054">}</a>
<a name="ln1055"> </a>
<a name="ln1056"> </a>
<a name="ln1057">/*! This method will run in the background.  The thread will block until there</a>
<a name="ln1058">    is a package to be updated.  When the thread unblocks, it will update the</a>
<a name="ln1059">    package with information from the server.</a>
<a name="ln1060">*/</a>
<a name="ln1061"> </a>
<a name="ln1062">status_t</a>
<a name="ln1063">MainWindow::_PopulatePackageWorker(void* arg)</a>
<a name="ln1064">{</a>
<a name="ln1065">	MainWindow* window = reinterpret_cast&lt;MainWindow*&gt;(arg);</a>
<a name="ln1066"> </a>
<a name="ln1067">	while (acquire_sem(window-&gt;fPackageToPopulateSem) == B_OK) {</a>
<a name="ln1068">		PackageInfoRef package;</a>
<a name="ln1069">		bool force;</a>
<a name="ln1070">		{</a>
<a name="ln1071">			AutoLocker&lt;BLocker&gt; lock(&amp;window-&gt;fPackageToPopulateLock);</a>
<a name="ln1072">			package = window-&gt;fPackageToPopulate;</a>
<a name="ln1073">			force = window-&gt;fForcePopulatePackage;</a>
<a name="ln1074">		}</a>
<a name="ln1075"> </a>
<a name="ln1076">		if (package.Get() != NULL) {</a>
<a name="ln1077">			uint32 populateFlags = Model::POPULATE_USER_RATINGS</a>
<a name="ln1078">				| Model::POPULATE_SCREEN_SHOTS</a>
<a name="ln1079">				| Model::POPULATE_CHANGELOG;</a>
<a name="ln1080"> </a>
<a name="ln1081">			if (force)</a>
<a name="ln1082">				populateFlags |= Model::POPULATE_FORCE;</a>
<a name="ln1083"> </a>
<a name="ln1084">			window-&gt;fModel.PopulatePackage(package, populateFlags);</a>
<a name="ln1085"> </a>
<a name="ln1086">			if (Logger::IsDebugEnabled()) {</a>
<a name="ln1087">				printf(&quot;populating package [%s]\n&quot;,</a>
<a name="ln1088">					package-&gt;Name().String());</a>
<a name="ln1089">			}</a>
<a name="ln1090">		}</a>
<a name="ln1091">	}</a>
<a name="ln1092"> </a>
<a name="ln1093">	return 0;</a>
<a name="ln1094">}</a>
<a name="ln1095"> </a>
<a name="ln1096"> </a>
<a name="ln1097">/* static */ status_t</a>
<a name="ln1098">MainWindow::_PackagesToShowWorker(void* arg)</a>
<a name="ln1099">{</a>
<a name="ln1100">	MainWindow* window = reinterpret_cast&lt;MainWindow*&gt;(arg);</a>
<a name="ln1101"> </a>
<a name="ln1102">	while (acquire_sem(window-&gt;fNewPackagesToShowSem) == B_OK) {</a>
<a name="ln1103">		PackageList packageList;</a>
<a name="ln1104">		int32 listID = 0;</a>
<a name="ln1105">		{</a>
<a name="ln1106">			AutoLocker&lt;BLocker&gt; lock(&amp;window-&gt;fPackagesToShowListLock);</a>
<a name="ln1107">			packageList = window-&gt;fPackagesToShowList;</a>
<a name="ln1108">			listID = atomic_get(&amp;window-&gt;fPackagesToShowListID);</a>
<a name="ln1109">			window-&gt;fPackagesToShowList.Clear();</a>
<a name="ln1110">		}</a>
<a name="ln1111"> </a>
<a name="ln1112">		// Add packages to list views in batches of kPackagesPerUpdate so we</a>
<a name="ln1113">		// don't block the window thread for long with each iteration</a>
<a name="ln1114">		enum {</a>
<a name="ln1115">			kPackagesPerUpdate = 20</a>
<a name="ln1116">		};</a>
<a name="ln1117">		uint32 packagesInMessage = 0;</a>
<a name="ln1118">		BMessage message(MSG_ADD_VISIBLE_PACKAGES);</a>
<a name="ln1119">		BMessenger messenger(window);</a>
<a name="ln1120">		bool listIsOutdated = false;</a>
<a name="ln1121"> </a>
<a name="ln1122">		for (int i = 0; i &lt; packageList.CountItems(); i++) {</a>
<a name="ln1123">			const PackageInfoRef&amp; package = packageList.ItemAtFast(i);</a>
<a name="ln1124"> </a>
<a name="ln1125">			if (packagesInMessage &gt;= kPackagesPerUpdate) {</a>
<a name="ln1126">				if (listID != atomic_get(&amp;window-&gt;fPackagesToShowListID)) {</a>
<a name="ln1127">					// The model was changed again in the meantime, and thus</a>
<a name="ln1128">					// our package list isn't current anymore. Send no further</a>
<a name="ln1129">					// messags based on this list and go back to start.</a>
<a name="ln1130">					listIsOutdated = true;</a>
<a name="ln1131">					break;</a>
<a name="ln1132">				}</a>
<a name="ln1133"> </a>
<a name="ln1134">				message.AddInt32(&quot;list_id&quot;, listID);</a>
<a name="ln1135">				messenger.SendMessage(&amp;message);</a>
<a name="ln1136">				message.MakeEmpty();</a>
<a name="ln1137">				packagesInMessage = 0;</a>
<a name="ln1138"> </a>
<a name="ln1139">				// Don't spam the window's message queue, which would make it</a>
<a name="ln1140">				// unresponsive (i.e. allows UI messages to get in between our</a>
<a name="ln1141">				// messages). When it has processed the message we just sent,</a>
<a name="ln1142">				// it will let us know by releasing the semaphore.</a>
<a name="ln1143">				acquire_sem(window-&gt;fShowPackagesAcknowledgeSem);</a>
<a name="ln1144">			}</a>
<a name="ln1145">			package-&gt;AcquireReference();</a>
<a name="ln1146">			message.AddPointer(&quot;package_ref&quot;, package.Get());</a>
<a name="ln1147">			packagesInMessage++;</a>
<a name="ln1148">		}</a>
<a name="ln1149"> </a>
<a name="ln1150">		if (listIsOutdated)</a>
<a name="ln1151">			continue;</a>
<a name="ln1152"> </a>
<a name="ln1153">		// Send remaining package infos, if any, which didn't make it into</a>
<a name="ln1154">		// the last message (count &lt; kPackagesPerUpdate)</a>
<a name="ln1155">		if (packagesInMessage &gt; 0) {</a>
<a name="ln1156">			message.AddInt32(&quot;list_id&quot;, listID);</a>
<a name="ln1157">			messenger.SendMessage(&amp;message);</a>
<a name="ln1158">			acquire_sem(window-&gt;fShowPackagesAcknowledgeSem);</a>
<a name="ln1159">		}</a>
<a name="ln1160"> </a>
<a name="ln1161">		// Update selected package in list views</a>
<a name="ln1162">		messenger.SendMessage(MSG_UPDATE_SELECTED_PACKAGE);</a>
<a name="ln1163">	}</a>
<a name="ln1164"> </a>
<a name="ln1165">	return 0;</a>
<a name="ln1166">}</a>
<a name="ln1167"> </a>
<a name="ln1168"> </a>
<a name="ln1169">void</a>
<a name="ln1170">MainWindow::_OpenLoginWindow(const BMessage&amp; onSuccessMessage)</a>
<a name="ln1171">{</a>
<a name="ln1172">	UserLoginWindow* window = new UserLoginWindow(this,</a>
<a name="ln1173">		BRect(0, 0, 500, 400), fModel);</a>
<a name="ln1174"> </a>
<a name="ln1175">	if (onSuccessMessage.what != 0)</a>
<a name="ln1176">		window-&gt;SetOnSuccessMessage(BMessenger(this), onSuccessMessage);</a>
<a name="ln1177"> </a>
<a name="ln1178">	window-&gt;Show();</a>
<a name="ln1179">}</a>
<a name="ln1180"> </a>
<a name="ln1181"> </a>
<a name="ln1182">void</a>
<a name="ln1183">MainWindow::_UpdateAuthorization()</a>
<a name="ln1184">{</a>
<a name="ln1185">	BString username(fModel.Username());</a>
<a name="ln1186">	bool hasUser = !username.IsEmpty();</a>
<a name="ln1187"> </a>
<a name="ln1188">	if (fLogOutItem != NULL)</a>
<a name="ln1189">		fLogOutItem-&gt;SetEnabled(hasUser);</a>
<a name="ln1190">	if (fLogInItem != NULL) {</a>
<a name="ln1191">		if (hasUser)</a>
<a name="ln1192">			fLogInItem-&gt;SetLabel(B_TRANSLATE(&quot;Switch account&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln1193">		else</a>
<a name="ln1194">			fLogInItem-&gt;SetLabel(B_TRANSLATE(&quot;Log in&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln1195">	}</a>
<a name="ln1196"> </a>
<a name="ln1197">	if (fUserMenu != NULL) {</a>
<a name="ln1198">		BString label;</a>
<a name="ln1199">		if (username.Length() == 0) {</a>
<a name="ln1200">			label = B_TRANSLATE(&quot;Not logged in&quot;);</a>
<a name="ln1201">		} else {</a>
<a name="ln1202">			label = B_TRANSLATE(&quot;Logged in as %User%&quot;);</a>
<a name="ln1203">			label.ReplaceAll(&quot;%User%&quot;, username);</a>
<a name="ln1204">		}</a>
<a name="ln1205">		fUserMenu-&gt;Superitem()-&gt;SetLabel(label);</a>
<a name="ln1206">	}</a>
<a name="ln1207">}</a>
<a name="ln1208"> </a>
<a name="ln1209"> </a>
<a name="ln1210">void</a>
<a name="ln1211">MainWindow::_UpdateAvailableRepositories()</a>
<a name="ln1212">{</a>
<a name="ln1213">	fRepositoryMenu-&gt;RemoveItems(0, fRepositoryMenu-&gt;CountItems(), true);</a>
<a name="ln1214"> </a>
<a name="ln1215">	fRepositoryMenu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;All repositories&quot;),</a>
<a name="ln1216">		new BMessage(MSG_DEPOT_SELECTED)));</a>
<a name="ln1217"> </a>
<a name="ln1218">	fRepositoryMenu-&gt;AddItem(new BSeparatorItem());</a>
<a name="ln1219"> </a>
<a name="ln1220">	bool foundSelectedDepot = false;</a>
<a name="ln1221">	const DepotList&amp; depots = fModel.Depots();</a>
<a name="ln1222">	for (int i = 0; i &lt; depots.CountItems(); i++) {</a>
<a name="ln1223">		const DepotInfo&amp; depot = depots.ItemAtFast(i);</a>
<a name="ln1224"> </a>
<a name="ln1225">		if (depot.Name().Length() != 0) {</a>
<a name="ln1226">			BMessage* message = new BMessage(MSG_DEPOT_SELECTED);</a>
<a name="ln1227">			message-&gt;AddString(&quot;name&quot;, depot.Name());</a>
<a name="ln1228">			BMenuItem* item = new BMenuItem(depot.Name(), message);</a>
<a name="ln1229">			fRepositoryMenu-&gt;AddItem(item);</a>
<a name="ln1230"> </a>
<a name="ln1231">			if (depot.Name() == fModel.Depot()) {</a>
<a name="ln1232">				item-&gt;SetMarked(true);</a>
<a name="ln1233">				foundSelectedDepot = true;</a>
<a name="ln1234">			}</a>
<a name="ln1235">		}</a>
<a name="ln1236">	}</a>
<a name="ln1237"> </a>
<a name="ln1238">	if (!foundSelectedDepot)</a>
<a name="ln1239">		fRepositoryMenu-&gt;ItemAt(0)-&gt;SetMarked(true);</a>
<a name="ln1240">}</a>
<a name="ln1241"> </a>
<a name="ln1242"> </a>
<a name="ln1243">bool</a>
<a name="ln1244">MainWindow::_SelectedPackageHasWebAppRepositoryCode()</a>
<a name="ln1245">{</a>
<a name="ln1246">	const PackageInfoRef&amp; package = fPackageInfoView-&gt;Package();</a>
<a name="ln1247">	const BString depotName = package-&gt;DepotName();</a>
<a name="ln1248"> </a>
<a name="ln1249">	if (depotName.IsEmpty()) {</a>
<a name="ln1250">		if (Logger::IsDebugEnabled()) {</a>
<a name="ln1251">			printf(&quot;the package [%s] has no depot name\n&quot;,</a>
<a name="ln1252">				package-&gt;Name().String());</a>
<a name="ln1253">		}</a>
<a name="ln1254">	} else {</a>
<a name="ln1255">		const DepotInfo* depot = fModel.DepotForName(depotName);</a>
<a name="ln1256"> </a>
<a name="ln1257">		if (depot == NULL) {</a>
<a name="ln1258">			printf(&quot;the depot [%s] was not able to be found\n&quot;,</a>
<a name="ln1259">				depotName.String());</a>
<a name="ln1260">		} else {</a>
<a name="ln1261">			BString repositoryCode = depot-&gt;WebAppRepositoryCode();</a>
<a name="ln1262"> </a>
<a name="ln1263">			if (repositoryCode.IsEmpty()) {</a>
<a name="ln1264">				printf(&quot;the depot [%s] has no web app repository code\n&quot;,</a>
<a name="ln1265">					depotName.String());</a>
<a name="ln1266">			} else {</a>
<a name="ln1267">				return true;</a>
<a name="ln1268">			}</a>
<a name="ln1269">		}</a>
<a name="ln1270">	}</a>
<a name="ln1271"> </a>
<a name="ln1272">	return false;</a>
<a name="ln1273">}</a>
<a name="ln1274"> </a>
<a name="ln1275"> </a>
<a name="ln1276">void</a>
<a name="ln1277">MainWindow::_RatePackage()</a>
<a name="ln1278">{</a>
<a name="ln1279">	if (!_SelectedPackageHasWebAppRepositoryCode()) {</a>
<a name="ln1280">		BAlert* alert = new(std::nothrow) BAlert(</a>
<a name="ln1281">			B_TRANSLATE(&quot;Rating not possible&quot;),</a>
<a name="ln1282">			B_TRANSLATE(&quot;This package doesn't seem to be on the HaikuDepot &quot;</a>
<a name="ln1283">				&quot;Server, so it's not possible to create a new rating &quot;</a>
<a name="ln1284">				&quot;or edit an existing rating.&quot;),</a>
<a name="ln1285">			B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln1286">		alert-&gt;Go();</a>
<a name="ln1287">    	return;</a>
<a name="ln1288">	}</a>
<a name="ln1289"> </a>
<a name="ln1290">	if (fModel.Username().IsEmpty()) {</a>
<a name="ln1291">		BAlert* alert = new(std::nothrow) BAlert(</a>
<a name="ln1292">			B_TRANSLATE(&quot;Not logged in&quot;),</a>
<a name="ln1293">			B_TRANSLATE(&quot;You need to be logged into an account before you &quot;</a>
<a name="ln1294">				&quot;can rate packages.&quot;),</a>
<a name="ln1295">			B_TRANSLATE(&quot;Cancel&quot;),</a>
<a name="ln1296">			B_TRANSLATE(&quot;Login or Create account&quot;));</a>
<a name="ln1297"> </a>
<a name="ln1298">		if (alert == NULL)</a>
<a name="ln1299">			return;</a>
<a name="ln1300"> </a>
<a name="ln1301">		int32 choice = alert-&gt;Go();</a>
<a name="ln1302">		if (choice == 1)</a>
<a name="ln1303">			_OpenLoginWindow(BMessage(MSG_RATE_PACKAGE));</a>
<a name="ln1304">		return;</a>
<a name="ln1305">	}</a>
<a name="ln1306"> </a>
<a name="ln1307">	// TODO: Allow only one RatePackageWindow</a>
<a name="ln1308">	// TODO: Mechanism for remembering the window frame</a>
<a name="ln1309">	RatePackageWindow* window = new RatePackageWindow(this,</a>
<a name="ln1310">		BRect(0, 0, 500, 400), fModel);</a>
<a name="ln1311">	window-&gt;SetPackage(fPackageInfoView-&gt;Package());</a>
<a name="ln1312">	window-&gt;Show();</a>
<a name="ln1313">}</a>
<a name="ln1314"> </a>
<a name="ln1315"> </a>
<a name="ln1316">void</a>
<a name="ln1317">MainWindow::_ShowScreenshot()</a>
<a name="ln1318">{</a>
<a name="ln1319">	// TODO: Mechanism for remembering the window frame</a>
<a name="ln1320">	if (fScreenshotWindow == NULL)</a>
<a name="ln1321">		fScreenshotWindow = new ScreenshotWindow(this, BRect(0, 0, 500, 400));</a>
<a name="ln1322"> </a>
<a name="ln1323">	if (fScreenshotWindow-&gt;LockWithTimeout(1000) != B_OK)</a>
<a name="ln1324">		return;</a>
<a name="ln1325"> </a>
<a name="ln1326">	fScreenshotWindow-&gt;SetPackage(fPackageInfoView-&gt;Package());</a>
<a name="ln1327"> </a>
<a name="ln1328">	if (fScreenshotWindow-&gt;IsHidden())</a>
<a name="ln1329">		fScreenshotWindow-&gt;Show();</a>
<a name="ln1330">	else</a>
<a name="ln1331">		fScreenshotWindow-&gt;Activate();</a>
<a name="ln1332"> </a>
<a name="ln1333">	fScreenshotWindow-&gt;Unlock();</a>
<a name="ln1334">}</a>

</code></pre>
<div class="balloon" rel="1304"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="1287"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
