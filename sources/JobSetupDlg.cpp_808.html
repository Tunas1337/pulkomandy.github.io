
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>JobSetupDlg.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * JobSetupDlg.cpp</a>
<a name="ln3"> * Copyright 1999-2000 Y.Takagi. All Rights Reserved.</a>
<a name="ln4"> */</a>
<a name="ln5"> </a>
<a name="ln6">#include &lt;cstdio&gt;</a>
<a name="ln7">#include &lt;cstring&gt;</a>
<a name="ln8">#include &lt;cstdlib&gt;</a>
<a name="ln9">#include &lt;string&gt;</a>
<a name="ln10">#include &lt;fcntl.h&gt;</a>
<a name="ln11">#include &lt;unistd.h&gt;</a>
<a name="ln12">#include &lt;sys/stat.h&gt;</a>
<a name="ln13">#include &lt;math.h&gt;</a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;Alert.h&gt;</a>
<a name="ln16">#include &lt;Bitmap.h&gt;</a>
<a name="ln17">#include &lt;Box.h&gt;</a>
<a name="ln18">#include &lt;Button.h&gt;</a>
<a name="ln19">#include &lt;CheckBox.h&gt;</a>
<a name="ln20">#include &lt;Debug.h&gt;</a>
<a name="ln21">#include &lt;GridView.h&gt;</a>
<a name="ln22">#include &lt;GroupLayout.h&gt;</a>
<a name="ln23">#include &lt;GroupLayoutBuilder.h&gt;</a>
<a name="ln24">#include &lt;Looper.h&gt;</a>
<a name="ln25">#include &lt;MessageFilter.h&gt;</a>
<a name="ln26">#include &lt;MenuField.h&gt;</a>
<a name="ln27">#include &lt;MenuItem.h&gt;</a>
<a name="ln28">#include &lt;Message.h&gt;</a>
<a name="ln29">#include &lt;Point.h&gt;</a>
<a name="ln30">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln31">#include &lt;PrintJob.h&gt;</a>
<a name="ln32">#include &lt;RadioButton.h&gt;</a>
<a name="ln33">#include &lt;Rect.h&gt;</a>
<a name="ln34">#include &lt;Slider.h&gt;</a>
<a name="ln35">#include &lt;String.h&gt;</a>
<a name="ln36">#include &lt;TextControl.h&gt;</a>
<a name="ln37">#include &lt;TextView.h&gt;</a>
<a name="ln38">#include &lt;View.h&gt;</a>
<a name="ln39"> </a>
<a name="ln40">#include &quot;HalftoneView.h&quot;</a>
<a name="ln41">#include &quot;JobSetupDlg.h&quot;</a>
<a name="ln42">#include &quot;JobData.h&quot;</a>
<a name="ln43">#include &quot;JSDSlider.h&quot;</a>
<a name="ln44">#include &quot;PagesView.h&quot;</a>
<a name="ln45">#include &quot;PrinterData.h&quot;</a>
<a name="ln46">#include &quot;PrinterCap.h&quot;</a>
<a name="ln47">#include &quot;DbgMsg.h&quot;</a>
<a name="ln48"> </a>
<a name="ln49"> </a>
<a name="ln50">using namespace std;</a>
<a name="ln51"> </a>
<a name="ln52"> </a>
<a name="ln53">struct NupCap : public EnumCap {</a>
<a name="ln54">	NupCap(const string &amp;label, bool isDefault, int nup)</a>
<a name="ln55">		:</a>
<a name="ln56">		EnumCap(label, isDefault),</a>
<a name="ln57">		fNup(nup)</a>
<a name="ln58">	{}</a>
<a name="ln59"> </a>
<a name="ln60">	int32	ID() const { return fNup; }</a>
<a name="ln61"> </a>
<a name="ln62">	int	fNup;</a>
<a name="ln63">};</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">struct DitherCap : public EnumCap {</a>
<a name="ln67">	DitherCap(const string &amp;label, bool isDefault,</a>
<a name="ln68">		Halftone::DitherType ditherType)</a>
<a name="ln69">		:</a>
<a name="ln70">		EnumCap(label, isDefault),</a>
<a name="ln71">		fDitherType(ditherType)</a>
<a name="ln72">	{}</a>
<a name="ln73"> </a>
<a name="ln74">	int32	ID() const { return fDitherType; }</a>
<a name="ln75"> </a>
<a name="ln76">	Halftone::DitherType fDitherType;</a>
<a name="ln77">};</a>
<a name="ln78"> </a>
<a name="ln79"> </a>
<a name="ln80">static const NupCap gNup1(&quot;1&quot;, true,  1);</a>
<a name="ln81">static const NupCap gNup2(&quot;2&quot;,   false, 2);</a>
<a name="ln82">static const NupCap gNup4(&quot;4&quot;,   false, 4);</a>
<a name="ln83">static const NupCap gNup8(&quot;8&quot;,   false, 8);</a>
<a name="ln84">static const NupCap gNup9(&quot;9&quot;,   false, 9);</a>
<a name="ln85">static const NupCap gNup16(&quot;16&quot;, false, 16);</a>
<a name="ln86">static const NupCap gNup25(&quot;25&quot;, false, 25);</a>
<a name="ln87">static const NupCap gNup32(&quot;32&quot;, false, 32);</a>
<a name="ln88">static const NupCap gNup36(&quot;36&quot;, false, 36);</a>
<a name="ln89"> </a>
<a name="ln90"> </a>
<a name="ln91">static const DitherCap gDitherType1(&quot;Crosshatch&quot;, false, Halftone::kType1);</a>
<a name="ln92">static const DitherCap gDitherType2(&quot;Grid&quot;, false, Halftone::kType2);</a>
<a name="ln93">static const DitherCap gDitherType3(&quot;Stipple&quot;, false, Halftone::kType3);</a>
<a name="ln94">static const DitherCap gDitherFloydSteinberg(&quot;Floyd-Steinberg&quot;, false,</a>
<a name="ln95">	Halftone::kTypeFloydSteinberg);</a>
<a name="ln96"> </a>
<a name="ln97"> </a>
<a name="ln98">const BaseCap *gNups[] = {</a>
<a name="ln99">	&amp;gNup1,</a>
<a name="ln100">	&amp;gNup2,</a>
<a name="ln101">	&amp;gNup4,</a>
<a name="ln102">	&amp;gNup8,</a>
<a name="ln103">	&amp;gNup9,</a>
<a name="ln104">	&amp;gNup16,</a>
<a name="ln105">	&amp;gNup25,</a>
<a name="ln106">	&amp;gNup32,</a>
<a name="ln107">	&amp;gNup36</a>
<a name="ln108">};</a>
<a name="ln109"> </a>
<a name="ln110"> </a>
<a name="ln111">const BaseCap *gDitherTypes[] = {</a>
<a name="ln112">	&amp;gDitherType1,</a>
<a name="ln113">	&amp;gDitherType2,</a>
<a name="ln114">	&amp;gDitherType3,</a>
<a name="ln115">	&amp;gDitherFloydSteinberg</a>
<a name="ln116">};</a>
<a name="ln117"> </a>
<a name="ln118"> </a>
<a name="ln119">static const char* kCategoryID = &quot;id&quot;;</a>
<a name="ln120"> </a>
<a name="ln121"> </a>
<a name="ln122">enum {</a>
<a name="ln123">	kMsgRangeAll = 'JSdl',</a>
<a name="ln124">	kMsgRangeSelection,</a>
<a name="ln125">	kMsgCancel,</a>
<a name="ln126">	kMsgOK,</a>
<a name="ln127">	kMsgQuality,</a>
<a name="ln128">	kMsgCollateChanged,</a>
<a name="ln129">	kMsgReverseChanged,</a>
<a name="ln130">	kMsgDuplexChanged,</a>
<a name="ln131">	kMsgIntSliderChanged,</a>
<a name="ln132">	kMsgDoubleSliderChanged,</a>
<a name="ln133">	kMsgNone = 0</a>
<a name="ln134">};</a>
<a name="ln135"> </a>
<a name="ln136"> </a>
<a name="ln137">JobSetupView::JobSetupView(JobData* jobData, PrinterData* printerData,</a>
<a name="ln138">	const PrinterCap *printerCap)</a>
<a name="ln139">	:</a>
<a name="ln140">	BView(&quot;jobSetup&quot;, B_WILL_DRAW),</a>
<a name="ln141">	fCopies(NULL),</a>
<a name="ln142">	fFromPage(NULL),</a>
<a name="ln143">	fToPage(NULL),</a>
<a name="ln144">	fJobData(jobData),</a>
<a name="ln145">	fPrinterData(printerData),</a>
<a name="ln146">	fPrinterCap(printerCap),</a>
<a name="ln147">	fColorType(NULL),</a>
<a name="ln148">	fDitherType(NULL),</a>
<a name="ln149">	fGamma(NULL),</a>
<a name="ln150">	fInkDensity(NULL),</a>
<a name="ln151">	fHalftone(NULL),</a>
<a name="ln152">	fAll(NULL),</a>
<a name="ln153">	fCollate(NULL),</a>
<a name="ln154">	fReverse(NULL),</a>
<a name="ln155">	fPages(NULL),</a>
<a name="ln156">	fPaperFeed(NULL),</a>
<a name="ln157">	fDuplex(NULL),</a>
<a name="ln158">	fNup(NULL),</a>
<a name="ln159">	fAllPages(NULL),</a>
<a name="ln160">	fOddNumberedPages(NULL),</a>
<a name="ln161">	fEvenNumberedPages(NULL)</a>
<a name="ln162">{</a>
<a name="ln163">	SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln164">}</a>
<a name="ln165"> </a>
<a name="ln166"> </a>
<a name="ln167">BRadioButton*</a>
<a name="ln168">JobSetupView::CreatePageSelectionItem(const char* name, const char* label,</a>
<a name="ln169">	JobData::PageSelection pageSelection)</a>
<a name="ln170">{</a>
<a name="ln171">	BRadioButton* button = new BRadioButton(name, label, NULL);</a>
<a name="ln172">	if (fJobData-&gt;GetPageSelection() == pageSelection) {</a>
<a name="ln173">		button-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln174">	}</a>
<a name="ln175">	return button;</a>
<a name="ln176">}</a>
<a name="ln177"> </a>
<a name="ln178"> </a>
<a name="ln179">void</a>
<a name="ln180">JobSetupView::AllowOnlyDigits(BTextView* textView, int maxDigits)</a>
<a name="ln181">{</a>
<a name="ln182">	int num;</a>
<a name="ln183">	for (num = 0; num &lt;= 255; num++) {</a>
<a name="ln184">		textView-&gt;DisallowChar(num);</a>
<a name="ln185">	}</a>
<a name="ln186">	for (num = 0; num &lt;= 9; num++) {</a>
<a name="ln187">		textView-&gt;AllowChar('0' + num);</a>
<a name="ln188">	}</a>
<a name="ln189">	textView-&gt;SetMaxBytes(maxDigits);</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192"> </a>
<a name="ln193">void</a>
<a name="ln194">JobSetupView::AttachedToWindow()</a>
<a name="ln195">{</a>
<a name="ln196">	// quality</a>
<a name="ln197">	BBox* qualityBox = new BBox(&quot;quality&quot;);</a>
<a name="ln198">	qualityBox-&gt;SetLabel(&quot;Quality&quot;);</a>
<a name="ln199"> </a>
<a name="ln200">	// color</a>
<a name="ln201">	fColorType = new BPopUpMenu(&quot;color&quot;);</a>
<a name="ln202">	fColorType-&gt;SetRadioMode(true);</a>
<a name="ln203">	FillCapabilityMenu(fColorType, kMsgQuality, PrinterCap::kColor,</a>
<a name="ln204">		fJobData-&gt;GetColor());</a>
<a name="ln205">	BMenuField* colorMenuField = new BMenuField(&quot;color&quot;, &quot;Color:&quot;, fColorType);</a>
<a name="ln206">	fColorType-&gt;SetTargetForItems(this);</a>
<a name="ln207"> </a>
<a name="ln208">	if (IsHalftoneConfigurationNeeded())</a>
<a name="ln209">		CreateHalftoneConfigurationUI();</a>
<a name="ln210"> </a>
<a name="ln211">	// page range</a>
<a name="ln212"> </a>
<a name="ln213">	BBox* pageRangeBox = new BBox(&quot;pageRange&quot;);</a>
<a name="ln214">	pageRangeBox-&gt;SetLabel(&quot;Page range&quot;);</a>
<a name="ln215"> </a>
<a name="ln216">	fAll = new BRadioButton(&quot;all&quot;, &quot;Print all Pages&quot;, new BMessage(kMsgRangeAll));</a>
<a name="ln217"> </a>
<a name="ln218">	BRadioButton *range = new BRadioButton(&quot;selection&quot;, &quot;Print selected Pages:&quot;,</a>
<a name="ln219">		new BMessage(kMsgRangeSelection));</a>
<a name="ln220"> </a>
<a name="ln221">	fFromPage = new BTextControl(&quot;from&quot;, &quot;From:&quot;, &quot;&quot;, NULL);</a>
<a name="ln222">	fFromPage-&gt;SetAlignment(B_ALIGN_LEFT, B_ALIGN_RIGHT);</a>
<a name="ln223">	AllowOnlyDigits(fFromPage-&gt;TextView(), 6);</a>
<a name="ln224"> </a>
<a name="ln225">	fToPage = new BTextControl(&quot;to&quot;, &quot;To:&quot;, &quot;&quot;, NULL);</a>
<a name="ln226">	fToPage-&gt;SetAlignment(B_ALIGN_LEFT, B_ALIGN_RIGHT);</a>
<a name="ln227">	AllowOnlyDigits(fToPage-&gt;TextView(), 6);</a>
<a name="ln228"> </a>
<a name="ln229">	int first_page = fJobData-&gt;GetFirstPage();</a>
<a name="ln230">	int last_page  = fJobData-&gt;GetLastPage();</a>
<a name="ln231"> </a>
<a name="ln232">	if (first_page &lt;= 1 &amp;&amp; last_page &lt;= 0) {</a>
<a name="ln233">		fAll-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln234">	} else {</a>
<a name="ln235">		range-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln236">		if (first_page &lt; 1)</a>
<a name="ln237">			first_page = 1;</a>
<a name="ln238">		if (first_page &gt; last_page)</a>
<a name="ln239">			last_page = -1;</a>
<a name="ln240"> </a>
<a name="ln241">		BString oss1;</a>
<a name="ln242">		oss1 &lt;&lt; first_page;</a>
<a name="ln243">		fFromPage-&gt;SetText(oss1.String());</a>
<a name="ln244"> </a>
<a name="ln245">		BString oss2;</a>
<a name="ln246">		oss2 &lt;&lt; last_page;</a>
<a name="ln247">		fToPage-&gt;SetText(oss2.String());</a>
<a name="ln248">	}</a>
<a name="ln249"> </a>
<a name="ln250">	fAll-&gt;SetTarget(this);</a>
<a name="ln251">	range-&gt;SetTarget(this);</a>
<a name="ln252"> </a>
<a name="ln253">	// paper source</a>
<a name="ln254">	fPaperFeed = new BPopUpMenu(&quot;&quot;);</a>
<a name="ln255">	fPaperFeed-&gt;SetRadioMode(true);</a>
<a name="ln256">	FillCapabilityMenu(fPaperFeed, kMsgNone, PrinterCap::kPaperSource,</a>
<a name="ln257">		fJobData-&gt;GetPaperSource());</a>
<a name="ln258">	BMenuField* paperSourceMenufield = new BMenuField(&quot;paperSource&quot;,</a>
<a name="ln259">		&quot;Paper source:&quot;, fPaperFeed);</a>
<a name="ln260"> </a>
<a name="ln261">	// Pages per sheet</a>
<a name="ln262">	fNup = new BPopUpMenu(&quot;&quot;);</a>
<a name="ln263">	fNup-&gt;SetRadioMode(true);</a>
<a name="ln264">	FillCapabilityMenu(fNup, kMsgNone, gNups,</a>
<a name="ln265">		sizeof(gNups) / sizeof(gNups[0]), (int)fJobData-&gt;GetNup());</a>
<a name="ln266">	BMenuField* pagesPerSheet = new BMenuField(&quot;pagesPerSheet&quot;,</a>
<a name="ln267">		&quot;Pages per sheet:&quot;, fNup);</a>
<a name="ln268"> </a>
<a name="ln269">	// duplex</a>
<a name="ln270">	if (fPrinterCap-&gt;Supports(PrinterCap::kPrintStyle)) {</a>
<a name="ln271">		fDuplex = new BCheckBox(&quot;duplex&quot;, &quot;Duplex&quot;,</a>
<a name="ln272">			new BMessage(kMsgDuplexChanged));</a>
<a name="ln273">		if (fJobData-&gt;GetPrintStyle() != JobData::kSimplex) {</a>
<a name="ln274">			fDuplex-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln275">		}</a>
<a name="ln276">		fDuplex-&gt;SetTarget(this);</a>
<a name="ln277">	} else {</a>
<a name="ln278">		fDuplex = NULL;</a>
<a name="ln279">	}</a>
<a name="ln280"> </a>
<a name="ln281">	// copies</a>
<a name="ln282">	fCopies = new BTextControl(&quot;copies&quot;, &quot;Number of copies:&quot;, &quot;&quot;, NULL);</a>
<a name="ln283">	AllowOnlyDigits(fCopies-&gt;TextView(), 3);</a>
<a name="ln284"> </a>
<a name="ln285">	BString copies;</a>
<a name="ln286">	copies &lt;&lt; fJobData-&gt;GetCopies();</a>
<a name="ln287">	fCopies-&gt;SetText(copies.String());</a>
<a name="ln288"> </a>
<a name="ln289">	// collate</a>
<a name="ln290">	fCollate = new BCheckBox(&quot;collate&quot;, &quot;Collate&quot;,</a>
<a name="ln291">		new BMessage(kMsgCollateChanged));</a>
<a name="ln292">	if (fJobData-&gt;GetCollate()) {</a>
<a name="ln293">		fCollate-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln294">	}</a>
<a name="ln295">	fCollate-&gt;SetTarget(this);</a>
<a name="ln296"> </a>
<a name="ln297">	// reverse</a>
<a name="ln298">	fReverse = new BCheckBox(&quot;reverse&quot;, &quot;Reverse order&quot;,</a>
<a name="ln299">		new BMessage(kMsgReverseChanged));</a>
<a name="ln300">	if (fJobData-&gt;GetReverse()) {</a>
<a name="ln301">		fReverse-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln302">	}</a>
<a name="ln303">	fReverse-&gt;SetTarget(this);</a>
<a name="ln304"> </a>
<a name="ln305">	// pages view</a>
<a name="ln306">	// TODO make layout API compatible</a>
<a name="ln307">	fPages = new PagesView(BRect(0, 0, 150, 40), &quot;pages&quot;, B_FOLLOW_ALL,</a>
<a name="ln308">		B_WILL_DRAW);</a>
<a name="ln309">	fPages-&gt;SetCollate(fJobData-&gt;GetCollate());</a>
<a name="ln310">	fPages-&gt;SetReverse(fJobData-&gt;GetReverse());</a>
<a name="ln311">	fPages-&gt;SetExplicitMinSize(BSize(150, 40));</a>
<a name="ln312">	fPages-&gt;SetExplicitMaxSize(BSize(150, 40));</a>
<a name="ln313"> </a>
<a name="ln314">	// page selection</a>
<a name="ln315">	BBox* pageSelectionBox = new BBox(&quot;pageSelection&quot;);</a>
<a name="ln316">	pageSelectionBox-&gt;SetLabel(&quot;Page selection&quot;);</a>
<a name="ln317"> </a>
<a name="ln318">	fAllPages = CreatePageSelectionItem(&quot;allPages&quot;, &quot;All pages&quot;,</a>
<a name="ln319">		JobData::kAllPages);</a>
<a name="ln320">	fOddNumberedPages = CreatePageSelectionItem(&quot;oddPages&quot;,</a>
<a name="ln321">		&quot;Odd-numbered pages&quot;, JobData::kOddNumberedPages);</a>
<a name="ln322">	fEvenNumberedPages = CreatePageSelectionItem(&quot;evenPages&quot;,</a>
<a name="ln323">		&quot;Even-numbered pages&quot;, JobData::kEvenNumberedPages);</a>
<a name="ln324"> </a>
<a name="ln325">	fPreview = new BCheckBox(&quot;preview&quot;, &quot;Show preview before printing&quot;, NULL);</a>
<a name="ln326">	if (fJobData-&gt;GetShowPreview())</a>
<a name="ln327">		fPreview-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln328"> </a>
<a name="ln329">	// separator line</a>
<a name="ln330">	BBox *separator = new BBox(&quot;separator&quot;);</a>
<a name="ln331">	separator-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, 1));</a>
<a name="ln332"> </a>
<a name="ln333">	// buttons</a>
<a name="ln334">	BButton* cancel = new BButton(&quot;cancel&quot;, &quot;Cancel&quot;,</a>
<a name="ln335">		new BMessage(kMsgCancel));</a>
<a name="ln336">	BButton* ok = new BButton(&quot;ok&quot;, &quot;OK&quot;, new BMessage(kMsgOK));</a>
<a name="ln337">	ok-&gt;MakeDefault(true);</a>
<a name="ln338"> </a>
<a name="ln339">	if (IsHalftoneConfigurationNeeded()) {</a>
<a name="ln340">		BGroupView* halftoneGroup = new BGroupView(B_VERTICAL, 0);</a>
<a name="ln341">		BGroupLayout* halftoneLayout = halftoneGroup-&gt;GroupLayout();</a>
<a name="ln342">		halftoneLayout-&gt;AddView(fHalftone);</a>
<a name="ln343">		fHalftoneBox-&gt;AddChild(halftoneGroup);</a>
<a name="ln344">	}</a>
<a name="ln345"> </a>
<a name="ln346">	BGridView* qualityGrid = new BGridView();</a>
<a name="ln347">	BGridLayout* qualityGridLayout = qualityGrid-&gt;GridLayout();</a>
<a name="ln348">	qualityGridLayout-&gt;AddItem(colorMenuField-&gt;CreateLabelLayoutItem(), 0, 0);</a>
<a name="ln349">	qualityGridLayout-&gt;AddItem(colorMenuField-&gt;CreateMenuBarLayoutItem(), 1, 0);</a>
<a name="ln350">	if (IsHalftoneConfigurationNeeded()) {</a>
<a name="ln351">		qualityGridLayout-&gt;AddItem(fDitherMenuField-&gt;CreateLabelLayoutItem(),</a>
<a name="ln352">			0, 1);</a>
<a name="ln353">		qualityGridLayout-&gt;AddItem(fDitherMenuField-&gt;CreateMenuBarLayoutItem(),</a>
<a name="ln354">			1, 1);</a>
<a name="ln355">		qualityGridLayout-&gt;AddView(fGamma, 0, 2, 2);</a>
<a name="ln356">		qualityGridLayout-&gt;AddView(fInkDensity, 0, 3, 2);</a>
<a name="ln357">		qualityGridLayout-&gt;AddView(fHalftoneBox, 0, 4, 2);</a>
<a name="ln358">	} else {</a>
<a name="ln359">		AddDriverSpecificSettings(qualityGridLayout, 1);</a>
<a name="ln360">	}</a>
<a name="ln361">	qualityGridLayout-&gt;SetSpacing(0, 0);</a>
<a name="ln362">	qualityGridLayout-&gt;SetInsets(5, 5, 5, 5);</a>
<a name="ln363">	qualityBox-&gt;AddChild(qualityGrid);</a>
<a name="ln364">	// TODO put qualityGrid in a scroll view</a>
<a name="ln365">	// the layout of the box surrounding the scroll view using the following</a>
<a name="ln366">	// code is not correct; the box still has the size of the qualityGird;</a>
<a name="ln367">	// and the scroll view is vertically centered inside the box!</a>
<a name="ln368">	//BScrollView* qualityScroller = new BScrollView(&quot;qualityScroller&quot;,</a>
<a name="ln369">	//	qualityGrid, 0, false, true);</a>
<a name="ln370">	//qualityScroller-&gt;SetExplicitMaxSize(BSize(500, 500));</a>
<a name="ln371">	//qualityBox-&gt;AddChild(qualityScroller);</a>
<a name="ln372"> </a>
<a name="ln373">	BGridView* pageRangeGrid = new BGridView();</a>
<a name="ln374">	BGridLayout* pageRangeLayout = pageRangeGrid-&gt;GridLayout();</a>
<a name="ln375">	pageRangeLayout-&gt;AddItem(fFromPage-&gt;CreateLabelLayoutItem(), 0, 0);</a>
<a name="ln376">	pageRangeLayout-&gt;AddItem(fFromPage-&gt;CreateTextViewLayoutItem(), 1, 0);</a>
<a name="ln377">	pageRangeLayout-&gt;AddItem(fToPage-&gt;CreateLabelLayoutItem(), 0, 1);</a>
<a name="ln378">	pageRangeLayout-&gt;AddItem(fToPage-&gt;CreateTextViewLayoutItem(), 1, 1);</a>
<a name="ln379">	pageRangeLayout-&gt;SetInsets(0, 0, 0, 0);</a>
<a name="ln380">	pageRangeLayout-&gt;SetSpacing(0, 0);</a>
<a name="ln381"> </a>
<a name="ln382">	BGroupView* pageRangeGroup = new BGroupView(B_VERTICAL, 0);</a>
<a name="ln383">	BGroupLayout* pageRangeGroupLayout = pageRangeGroup-&gt;GroupLayout();</a>
<a name="ln384">	pageRangeGroupLayout-&gt;AddView(fAll);</a>
<a name="ln385">	pageRangeGroupLayout-&gt;AddView(range);</a>
<a name="ln386">	pageRangeGroupLayout-&gt;AddView(pageRangeGrid);</a>
<a name="ln387">	pageRangeGroupLayout-&gt;SetInsets(5, 5, 5, 5);</a>
<a name="ln388">	pageRangeBox-&gt;AddChild(pageRangeGroup);</a>
<a name="ln389"> </a>
<a name="ln390">	BGridView* settings = new BGridView();</a>
<a name="ln391">	BGridLayout* settingsLayout = settings-&gt;GridLayout();</a>
<a name="ln392">	settingsLayout-&gt;AddItem(paperSourceMenufield-&gt;CreateLabelLayoutItem(), 0,</a>
<a name="ln393">		0);</a>
<a name="ln394">	settingsLayout-&gt;AddItem(paperSourceMenufield-&gt;CreateMenuBarLayoutItem(), 1,</a>
<a name="ln395">		0);</a>
<a name="ln396">	settingsLayout-&gt;AddItem(pagesPerSheet-&gt;CreateLabelLayoutItem(), 0, 1);</a>
<a name="ln397">	settingsLayout-&gt;AddItem(pagesPerSheet-&gt;CreateMenuBarLayoutItem(), 1, 1);</a>
<a name="ln398">	int row = 2;</a>
<a name="ln399">	if (fDuplex != NULL) {</a>
<a name="ln400">		settingsLayout-&gt;AddView(fDuplex, 0, row, 2);</a>
<a name="ln401">		row ++;</a>
<a name="ln402">	}</a>
<a name="ln403">	settingsLayout-&gt;AddItem(fCopies-&gt;CreateLabelLayoutItem(), 0, row);</a>
<a name="ln404">	settingsLayout-&gt;AddItem(fCopies-&gt;CreateTextViewLayoutItem(), 1, row);</a>
<a name="ln405">	settingsLayout-&gt;SetSpacing(0, 0);</a>
<a name="ln406"> </a>
<a name="ln407"> </a>
<a name="ln408">	BGroupView* pageSelectionGroup = new BGroupView(B_VERTICAL, 0);</a>
<a name="ln409">	BGroupLayout* groupLayout = pageSelectionGroup-&gt;GroupLayout();</a>
<a name="ln410">	groupLayout-&gt;AddView(fAllPages);</a>
<a name="ln411">	groupLayout-&gt;AddView(fOddNumberedPages);</a>
<a name="ln412">	groupLayout-&gt;AddView(fEvenNumberedPages);</a>
<a name="ln413">	groupLayout-&gt;SetInsets(5, 5, 5, 5);</a>
<a name="ln414">	pageSelectionBox-&gt;AddChild(pageSelectionGroup);</a>
<a name="ln415"> </a>
<a name="ln416">	SetLayout(new BGroupLayout(B_VERTICAL));</a>
<a name="ln417">	AddChild(BGroupLayoutBuilder(B_VERTICAL, 0)</a>
<a name="ln418">		.AddGroup(B_HORIZONTAL, 10, 1.0f)</a>
<a name="ln419">			.AddGroup(B_VERTICAL, 10, 1.0f)</a>
<a name="ln420">				.Add(qualityBox)</a>
<a name="ln421">				.Add(pageRangeBox)</a>
<a name="ln422">				.AddGlue()</a>
<a name="ln423">			.End()</a>
<a name="ln424">			.AddGroup(B_VERTICAL, 0, 1.0f)</a>
<a name="ln425">				.Add(settings)</a>
<a name="ln426">				.AddStrut(5)</a>
<a name="ln427">				.Add(fCollate)</a>
<a name="ln428">				.Add(fReverse)</a>
<a name="ln429">				.Add(fPages)</a>
<a name="ln430">				.AddStrut(5)</a>
<a name="ln431">				.Add(pageSelectionBox)</a>
<a name="ln432">				.AddGlue()</a>
<a name="ln433">			.End()</a>
<a name="ln434">		.End()</a>
<a name="ln435">		.Add(fPreview)</a>
<a name="ln436">		.AddGlue()</a>
<a name="ln437">		.Add(separator)</a>
<a name="ln438">		.AddGroup(B_HORIZONTAL, 10, 1.0f)</a>
<a name="ln439">			.AddGlue()</a>
<a name="ln440">			.Add(cancel)</a>
<a name="ln441">			.Add(ok)</a>
<a name="ln442">		.End()</a>
<a name="ln443">		.SetInsets(0, 0, 0, 0)</a>
<a name="ln444">	);</a>
<a name="ln445"> </a>
<a name="ln446">	UpdateHalftonePreview();</a>
<a name="ln447"> </a>
<a name="ln448">	UpdateButtonEnabledState();</a>
<a name="ln449">}</a>
<a name="ln450"> </a>
<a name="ln451"> </a>
<a name="ln452">bool</a>
<a name="ln453">JobSetupView::IsHalftoneConfigurationNeeded()</a>
<a name="ln454">{</a>
<a name="ln455">	return fPrinterCap-&gt;Supports(PrinterCap::kHalftone);</a>
<a name="ln456">}</a>
<a name="ln457"> </a>
<a name="ln458"> </a>
<a name="ln459">void</a>
<a name="ln460">JobSetupView::CreateHalftoneConfigurationUI()</a>
<a name="ln461">{</a>
<a name="ln462">	// dither type</a>
<a name="ln463">	fDitherType = new BPopUpMenu(&quot;&quot;);</a>
<a name="ln464">	fDitherType-&gt;SetRadioMode(true);</a>
<a name="ln465">	FillCapabilityMenu(fDitherType, kMsgQuality, gDitherTypes,</a>
<a name="ln466">		sizeof(gDitherTypes) / sizeof(gDitherTypes[0]),</a>
<a name="ln467">		(int)fJobData-&gt;GetDitherType());</a>
<a name="ln468">	fDitherMenuField = new BMenuField(&quot;dithering&quot;, &quot;Dot Pattern:&quot;,</a>
<a name="ln469">		fDitherType);</a>
<a name="ln470">	fDitherType-&gt;SetTargetForItems(this);</a>
<a name="ln471"> </a>
<a name="ln472">	// halftone preview view</a>
<a name="ln473">	fHalftoneBox = new BBox(&quot;halftoneBox&quot;);</a>
<a name="ln474">	fHalftoneBox-&gt;SetBorder(B_PLAIN_BORDER);</a>
<a name="ln475"> </a>
<a name="ln476">	// TODO make layout compatible</a>
<a name="ln477">	BSize size(240, 14 * 4);</a>
<a name="ln478">	BRect rect(0, 0, size.width, size.height);</a>
<a name="ln479">	fHalftone = new HalftoneView(rect, &quot;halftone&quot;,</a>
<a name="ln480">		B_FOLLOW_ALL, B_WILL_DRAW);</a>
<a name="ln481">	fHalftone-&gt;SetExplicitMinSize(size);</a>
<a name="ln482">	fHalftone-&gt;SetExplicitMaxSize(size);</a>
<a name="ln483"> </a>
<a name="ln484">	// gamma</a>
<a name="ln485">	fGamma = new JSDSlider(&quot;gamma&quot;, &quot;Gamma&quot;, new BMessage(kMsgQuality),</a>
<a name="ln486">		-300, 300);</a>
<a name="ln487"> </a>
<a name="ln488">	fGamma-&gt;SetLimitLabels(&quot;Lighter&quot;, &quot;Darker&quot;);</a>
<a name="ln489">	fGamma-&gt;SetValue((int32)(100 * log(fJobData-&gt;GetGamma()) / log(2.0)));</a>
<a name="ln490">	fGamma-&gt;SetHashMarks(B_HASH_MARKS_BOTH);</a>
<a name="ln491">	fGamma-&gt;SetHashMarkCount(7);</a>
<a name="ln492">	fGamma-&gt;SetModificationMessage(new BMessage(kMsgQuality));</a>
<a name="ln493">	fGamma-&gt;SetTarget(this);</a>
<a name="ln494"> </a>
<a name="ln495">	// ink density</a>
<a name="ln496">	fInkDensity = new JSDSlider(&quot;inkDensity&quot;, &quot;Ink usage&quot;,</a>
<a name="ln497">		new BMessage(kMsgQuality), 0, 127);</a>
<a name="ln498"> </a>
<a name="ln499">	fInkDensity-&gt;SetLimitLabels(&quot;Min&quot;, &quot;Max&quot;);</a>
<a name="ln500">	fInkDensity-&gt;SetValue((int32)fJobData-&gt;GetInkDensity());</a>
<a name="ln501">	fInkDensity-&gt;SetHashMarks(B_HASH_MARKS_BOTH);</a>
<a name="ln502">	fInkDensity-&gt;SetHashMarkCount(10);</a>
<a name="ln503">	fInkDensity-&gt;SetModificationMessage(new BMessage(kMsgQuality));</a>
<a name="ln504">	fInkDensity-&gt;SetTarget(this);</a>
<a name="ln505">}</a>
<a name="ln506"> </a>
<a name="ln507"> </a>
<a name="ln508">void</a>
<a name="ln509">JobSetupView::AddDriverSpecificSettings(BGridLayout* gridLayout, int row)</a>
<a name="ln510">{</a>
<a name="ln511">	if (!fPrinterCap-&gt;Supports(PrinterCap::kDriverSpecificCapabilities))</a>
<a name="ln512">		return;</a>
<a name="ln513"> </a>
<a name="ln514">	int count = fPrinterCap-&gt;CountCap(PrinterCap::kDriverSpecificCapabilities);</a>
<a name="ln515">	const BaseCap** capabilities = fPrinterCap-&gt;GetCaps(</a>
<a name="ln516">		PrinterCap::kDriverSpecificCapabilities);</a>
<a name="ln517"> </a>
<a name="ln518">	for (int i = 0; i &lt; count; i ++) {</a>
<a name="ln519">		const DriverSpecificCap* capability =</a>
<a name="ln520">			static_cast&lt;const DriverSpecificCap*&gt;(capabilities[i]);</a>
<a name="ln521"> </a>
<a name="ln522">		switch (capability-&gt;fType) {</a>
<a name="ln523">			case DriverSpecificCap::kList:</a>
<a name="ln524">				AddPopUpMenu(capability, gridLayout, row);</a>
<a name="ln525">				break;</a>
<a name="ln526">			case DriverSpecificCap::kBoolean:</a>
<a name="ln527">				AddCheckBox(capability, gridLayout, row);</a>
<a name="ln528">				break;</a>
<a name="ln529">			case DriverSpecificCap::kIntRange:</a>
<a name="ln530">			case DriverSpecificCap::kIntDimension:</a>
<a name="ln531">				AddIntSlider(capability, gridLayout, row);</a>
<a name="ln532">				break;</a>
<a name="ln533">			case DriverSpecificCap::kDoubleRange:</a>
<a name="ln534">				AddDoubleSlider(capability, gridLayout, row);</a>
<a name="ln535">				break;</a>
<a name="ln536"> </a>
<a name="ln537">		}</a>
<a name="ln538">	}</a>
<a name="ln539">}</a>
<a name="ln540"> </a>
<a name="ln541"> </a>
<a name="ln542">void</a>
<a name="ln543">JobSetupView::AddPopUpMenu(const DriverSpecificCap* capability,</a>
<a name="ln544">	BGridLayout* gridLayout, int&amp; row)</a>
<a name="ln545">{</a>
<a name="ln546">	const char* label = capability-&gt;fLabel.c_str();</a>
<a name="ln547">	BPopUpMenu* popUpMenu = new BPopUpMenu(label);</a>
<a name="ln548">	popUpMenu-&gt;SetRadioMode(true);</a>
<a name="ln549"> </a>
<a name="ln550">	PrinterCap::CapID category = static_cast&lt;PrinterCap::CapID&gt;(</a>
<a name="ln551">		capability-&gt;ID());</a>
<a name="ln552"> </a>
<a name="ln553">	const BaseCap** categoryCapabilities = fPrinterCap-&gt;GetCaps(category);</a>
<a name="ln554"> </a>
<a name="ln555">	int categoryCount = fPrinterCap-&gt;CountCap(category);</a>
<a name="ln556"> </a>
<a name="ln557">	string value = GetDriverSpecificValue(category, capability-&gt;Key());</a>
<a name="ln558">	PrinterCap::KeyPredicate predicate(value.c_str());</a>
<a name="ln559"> </a>
<a name="ln560">	FillCapabilityMenu(popUpMenu, kMsgNone, categoryCapabilities,</a>
<a name="ln561">		categoryCount, predicate);</a>
<a name="ln562"> </a>
<a name="ln563">	BString menuLabel = label;</a>
<a name="ln564">	menuLabel &lt;&lt; &quot;:&quot;;</a>
<a name="ln565">	BMenuField* menuField = new BMenuField(label, menuLabel.String(),</a>
<a name="ln566">		popUpMenu);</a>
<a name="ln567">	popUpMenu-&gt;SetTargetForItems(this);</a>
<a name="ln568"> </a>
<a name="ln569">	gridLayout-&gt;AddItem(menuField-&gt;CreateLabelLayoutItem(),</a>
<a name="ln570">		0, row);</a>
<a name="ln571">	gridLayout-&gt;AddItem(menuField-&gt;CreateMenuBarLayoutItem(),</a>
<a name="ln572">		1, row);</a>
<a name="ln573">	row ++;</a>
<a name="ln574"> </a>
<a name="ln575">	fDriverSpecificPopUpMenus[category] = popUpMenu;</a>
<a name="ln576">}</a>
<a name="ln577"> </a>
<a name="ln578"> </a>
<a name="ln579">void</a>
<a name="ln580">JobSetupView::AddCheckBox(const DriverSpecificCap* capability,</a>
<a name="ln581">	BGridLayout* gridLayout, int&amp; row)</a>
<a name="ln582">{</a>
<a name="ln583">	PrinterCap::CapID category = static_cast&lt;PrinterCap::CapID&gt;(</a>
<a name="ln584">		capability-&gt;ID());</a>
<a name="ln585">	const BooleanCap* booleanCap = fPrinterCap-&gt;FindBooleanCap(category);</a>
<a name="ln586">	if (booleanCap == NULL) {</a>
<a name="ln587">		fprintf(stderr, &quot;Internal error: BooleanCap for '%s' not found!\n&quot;,</a>
<a name="ln588">			capability-&gt;Label());</a>
<a name="ln589">		return;</a>
<a name="ln590">	}</a>
<a name="ln591"> </a>
<a name="ln592">	const char* key = capability-&gt;Key();</a>
<a name="ln593">	BString name;</a>
<a name="ln594">	name &lt;&lt; &quot;pds_&quot; &lt;&lt; key;</a>
<a name="ln595">	BCheckBox* checkBox = new BCheckBox(name.String(), capability-&gt;Label(),</a>
<a name="ln596">		NULL);</a>
<a name="ln597"> </a>
<a name="ln598">	bool value = booleanCap-&gt;DefaultValue();</a>
<a name="ln599">	if (fJobData-&gt;Settings().HasBoolean(key))</a>
<a name="ln600">		value = fJobData-&gt;Settings().GetBoolean(key);</a>
<a name="ln601">	if (value)</a>
<a name="ln602">		checkBox-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln603"> </a>
<a name="ln604">	gridLayout-&gt;AddView(checkBox, 0, row, 2);</a>
<a name="ln605">	row ++;</a>
<a name="ln606"> </a>
<a name="ln607">	fDriverSpecificCheckBoxes[capability-&gt;Key()] = checkBox;</a>
<a name="ln608">}</a>
<a name="ln609"> </a>
<a name="ln610"> </a>
<a name="ln611">void</a>
<a name="ln612">JobSetupView::AddIntSlider(const DriverSpecificCap* capability,</a>
<a name="ln613">	BGridLayout* gridLayout, int&amp; row)</a>
<a name="ln614">{</a>
<a name="ln615">	PrinterCap::CapID category = static_cast&lt;PrinterCap::CapID&gt;(</a>
<a name="ln616">		capability-&gt;ID());</a>
<a name="ln617">	const IntRangeCap* range = fPrinterCap-&gt;FindIntRangeCap(category);</a>
<a name="ln618">	if (range == NULL) {</a>
<a name="ln619">		fprintf(stderr, &quot;Internal error: IntRangeCap for '%s' not found!\n&quot;,</a>
<a name="ln620">			capability-&gt;Label());</a>
<a name="ln621">		return;</a>
<a name="ln622">	}</a>
<a name="ln623"> </a>
<a name="ln624">	const char* label = capability-&gt;Label();</a>
<a name="ln625">	const char* key = capability-&gt;Key();</a>
<a name="ln626">	BString name;</a>
<a name="ln627">	name &lt;&lt; &quot;pds_&quot; &lt;&lt; key;</a>
<a name="ln628">	BMessage* message = new BMessage(kMsgIntSliderChanged);</a>
<a name="ln629">	message-&gt;AddInt32(kCategoryID, category);</a>
<a name="ln630">	BSlider* slider = new BSlider(name.String(), label,</a>
<a name="ln631">		message, 0, 1000, B_HORIZONTAL);</a>
<a name="ln632">	slider-&gt;SetModificationMessage(new BMessage(*message));</a>
<a name="ln633">	slider-&gt;SetTarget(this);</a>
<a name="ln634"> </a>
<a name="ln635">	int32 value = range-&gt;DefaultValue();</a>
<a name="ln636">	if (fJobData-&gt;Settings().HasInt(key))</a>
<a name="ln637">		value = fJobData-&gt;Settings().GetInt(key);</a>
<a name="ln638">	float position = (value - range-&gt;Lower()) /</a>
<a name="ln639">		(range-&gt;Upper() - range-&gt;Lower());</a>
<a name="ln640">	slider-&gt;SetPosition(position);</a>
<a name="ln641"> </a>
<a name="ln642">	gridLayout-&gt;AddView(slider, 0, row, 2);</a>
<a name="ln643">	row ++;</a>
<a name="ln644"> </a>
<a name="ln645">	IntRange intRange(label, key, range, slider);</a>
<a name="ln646">	fDriverSpecificIntSliders[category] = intRange;</a>
<a name="ln647">	intRange.UpdateLabel();</a>
<a name="ln648">}</a>
<a name="ln649"> </a>
<a name="ln650"> </a>
<a name="ln651">void</a>
<a name="ln652">JobSetupView::AddDoubleSlider(const DriverSpecificCap* capability,</a>
<a name="ln653">	BGridLayout* gridLayout, int&amp; row)</a>
<a name="ln654">{</a>
<a name="ln655">	PrinterCap::CapID category = static_cast&lt;PrinterCap::CapID&gt;(</a>
<a name="ln656">		capability-&gt;ID());</a>
<a name="ln657">	const DoubleRangeCap* range = fPrinterCap-&gt;FindDoubleRangeCap(category);</a>
<a name="ln658">	if (range == NULL) {</a>
<a name="ln659">		fprintf(stderr, &quot;Internal error: DoubleRangeCap for '%s' not found!\n&quot;,</a>
<a name="ln660">			capability-&gt;Label());</a>
<a name="ln661">		return;</a>
<a name="ln662">	}</a>
<a name="ln663"> </a>
<a name="ln664">	const char* label = capability-&gt;Label();</a>
<a name="ln665">	const char* key = capability-&gt;Key();</a>
<a name="ln666">	BString name;</a>
<a name="ln667">	name &lt;&lt; &quot;pds_&quot; &lt;&lt; key;</a>
<a name="ln668">	BMessage* message = new BMessage(kMsgDoubleSliderChanged);</a>
<a name="ln669">	message-&gt;AddInt32(kCategoryID, category);</a>
<a name="ln670">	BSlider* slider = new BSlider(name.String(), label,</a>
<a name="ln671">		message, 0, 1000, B_HORIZONTAL);</a>
<a name="ln672">	slider-&gt;SetModificationMessage(new BMessage(*message));</a>
<a name="ln673">	slider-&gt;SetTarget(this);</a>
<a name="ln674"> </a>
<a name="ln675">	double value = range-&gt;DefaultValue();</a>
<a name="ln676">	if (fJobData-&gt;Settings().HasDouble(key))</a>
<a name="ln677">		value = fJobData-&gt;Settings().GetDouble(key);</a>
<a name="ln678">	float position = static_cast&lt;float&gt;((value - range-&gt;Lower()) /</a>
<a name="ln679">		(range-&gt;Upper() - range-&gt;Lower()));</a>
<a name="ln680">	slider-&gt;SetPosition(position);</a>
<a name="ln681"> </a>
<a name="ln682">	gridLayout-&gt;AddView(slider, 0, row, 2);</a>
<a name="ln683">	row ++;</a>
<a name="ln684"> </a>
<a name="ln685">	DoubleRange doubleRange(label, key, range, slider);</a>
<a name="ln686">	fDriverSpecificDoubleSliders[category] = doubleRange;</a>
<a name="ln687">	doubleRange.UpdateLabel();</a>
<a name="ln688">}</a>
<a name="ln689"> </a>
<a name="ln690"> </a>
<a name="ln691">string</a>
<a name="ln692">JobSetupView::GetDriverSpecificValue(PrinterCap::CapID category,</a>
<a name="ln693">	const char* key)</a>
<a name="ln694">{</a>
<a name="ln695">	if (fJobData-&gt;Settings().HasString(key))</a>
<a name="ln696">		return fJobData-&gt;Settings().GetString(key);</a>
<a name="ln697"> </a>
<a name="ln698">	const EnumCap* defaultCapability = fPrinterCap-&gt;GetDefaultCap(category);</a>
<a name="ln699">	return defaultCapability-&gt;fKey;</a>
<a name="ln700">}</a>
<a name="ln701"> </a>
<a name="ln702"> </a>
<a name="ln703">template&lt;typename Predicate&gt;</a>
<a name="ln704">void</a>
<a name="ln705">JobSetupView::FillCapabilityMenu(BPopUpMenu* menu, uint32 message,</a>
<a name="ln706">	const BaseCap** capabilities, int count, Predicate&amp; predicate)</a>
<a name="ln707">{</a>
<a name="ln708">	bool marked = false;</a>
<a name="ln709"> </a>
<a name="ln710">	BMenuItem* firstItem = NULL;</a>
<a name="ln711">	BMenuItem* defaultItem = NULL;</a>
<a name="ln712">	BMenuItem* item = NULL;</a>
<a name="ln713">	while (count--) {</a>
<a name="ln714">		const EnumCap* capability = dynamic_cast&lt;const EnumCap*&gt;(*capabilities);</a>
<a name="ln715">		if (message != kMsgNone)</a>
<a name="ln716">			item = new BMenuItem(capability-&gt;fLabel.c_str(),</a>
<a name="ln717">				new BMessage(message));</a>
<a name="ln718">		else</a>
<a name="ln719">			item = new BMenuItem(capability-&gt;fLabel.c_str(), NULL);</a>
<a name="ln720"> </a>
<a name="ln721">		menu-&gt;AddItem(item);</a>
<a name="ln722"> </a>
<a name="ln723">		if (firstItem == NULL)</a>
<a name="ln724">			firstItem = item;</a>
<a name="ln725"> </a>
<a name="ln726">		if (capability-&gt;fIsDefault)</a>
<a name="ln727">			defaultItem = item;</a>
<a name="ln728"> </a>
<a name="ln729"> </a>
<a name="ln730">		if (predicate(capability)) {</a>
<a name="ln731">			item-&gt;SetMarked(true);</a>
<a name="ln732">			marked = true;</a>
<a name="ln733">		}</a>
<a name="ln734"> </a>
<a name="ln735">		capabilities++;</a>
<a name="ln736">	}</a>
<a name="ln737"> </a>
<a name="ln738">	if (marked)</a>
<a name="ln739">		return;</a>
<a name="ln740"> </a>
<a name="ln741">	if (defaultItem != NULL)</a>
<a name="ln742">		defaultItem-&gt;SetMarked(true);</a>
<a name="ln743">	else if (firstItem != NULL)</a>
<a name="ln744">		firstItem-&gt;SetMarked(true);</a>
<a name="ln745">}</a>
<a name="ln746"> </a>
<a name="ln747"> </a>
<a name="ln748">void</a>
<a name="ln749">JobSetupView::FillCapabilityMenu(BPopUpMenu* menu, uint32 message,</a>
<a name="ln750">	PrinterCap::CapID category, int id)</a>
<a name="ln751">{</a>
<a name="ln752">	PrinterCap::IDPredicate predicate(id);</a>
<a name="ln753">	int count = fPrinterCap-&gt;CountCap(category);</a>
<a name="ln754">	const BaseCap **capabilities = fPrinterCap-&gt;GetCaps(category);</a>
<a name="ln755">	FillCapabilityMenu(menu, message, capabilities, count, predicate);</a>
<a name="ln756">}</a>
<a name="ln757"> </a>
<a name="ln758"> </a>
<a name="ln759">void</a>
<a name="ln760">JobSetupView::FillCapabilityMenu(BPopUpMenu* menu, uint32 message,</a>
<a name="ln761">	const BaseCap** capabilities, int count, int id)</a>
<a name="ln762">{</a>
<a name="ln763">	PrinterCap::IDPredicate predicate(id);</a>
<a name="ln764">	FillCapabilityMenu(menu, message, capabilities, count, predicate);</a>
<a name="ln765">}</a>
<a name="ln766"> </a>
<a name="ln767"> </a>
<a name="ln768">int</a>
<a name="ln769">JobSetupView::GetID(const BaseCap** capabilities, int count, const char* label,</a>
<a name="ln770">	int defaultValue)</a>
<a name="ln771">{</a>
<a name="ln772">	while (count--) {</a>
<a name="ln773">		const EnumCap* capability =</a>
<a name="ln774">			dynamic_cast&lt;const EnumCap*&gt;(*capabilities);</a>
<a name="ln775">		if (capability == NULL)</a>
<a name="ln776">			break;</a>
<a name="ln777"> </a>
<a name="ln778">		if (capability-&gt;fLabel == label)</a>
<a name="ln779">			return capability-&gt;ID();</a>
<a name="ln780">	}</a>
<a name="ln781">	return defaultValue;</a>
<a name="ln782">}</a>
<a name="ln783"> </a>
<a name="ln784"> </a>
<a name="ln785">void</a>
<a name="ln786">JobSetupView::UpdateButtonEnabledState()</a>
<a name="ln787">{</a>
<a name="ln788">	bool pageRangeEnabled = fAll-&gt;Value() != B_CONTROL_ON;</a>
<a name="ln789">	fFromPage-&gt;SetEnabled(pageRangeEnabled);</a>
<a name="ln790">	fToPage-&gt;SetEnabled(pageRangeEnabled);</a>
<a name="ln791"> </a>
<a name="ln792">	bool pageSelectionEnabled = fDuplex == NULL ||</a>
<a name="ln793">		fDuplex-&gt;Value() != B_CONTROL_ON;</a>
<a name="ln794">	fAllPages-&gt;SetEnabled(pageSelectionEnabled);</a>
<a name="ln795">	fOddNumberedPages-&gt;SetEnabled(pageSelectionEnabled);</a>
<a name="ln796">	fEvenNumberedPages-&gt;SetEnabled(pageSelectionEnabled);</a>
<a name="ln797">}</a>
<a name="ln798"> </a>
<a name="ln799"> </a>
<a name="ln800">void</a>
<a name="ln801">JobSetupView::MessageReceived(BMessage* message)</a>
<a name="ln802">{</a>
<a name="ln803">	switch (message-&gt;what) {</a>
<a name="ln804">	case kMsgRangeAll:</a>
<a name="ln805">	case kMsgRangeSelection:</a>
<a name="ln806">	case kMsgDuplexChanged:</a>
<a name="ln807">		UpdateButtonEnabledState();</a>
<a name="ln808">		break;</a>
<a name="ln809"> </a>
<a name="ln810">	case kMsgQuality:</a>
<a name="ln811">		UpdateHalftonePreview();</a>
<a name="ln812">		break;</a>
<a name="ln813"> </a>
<a name="ln814">	case kMsgCollateChanged:</a>
<a name="ln815">		fPages-&gt;SetCollate(fCollate-&gt;Value() == B_CONTROL_ON);</a>
<a name="ln816">		break;</a>
<a name="ln817"> </a>
<a name="ln818">	case kMsgReverseChanged:</a>
<a name="ln819">		fPages-&gt;SetReverse(fReverse-&gt;Value() == B_CONTROL_ON);</a>
<a name="ln820">		break;</a>
<a name="ln821"> </a>
<a name="ln822">	case kMsgIntSliderChanged:</a>
<a name="ln823">		UpdateIntSlider(message);</a>
<a name="ln824">		break;</a>
<a name="ln825"> </a>
<a name="ln826">	case kMsgDoubleSliderChanged:</a>
<a name="ln827">		UpdateDoubleSlider(message);</a>
<a name="ln828">		break;</a>
<a name="ln829">	}</a>
<a name="ln830">}</a>
<a name="ln831"> </a>
<a name="ln832"> </a>
<a name="ln833">void</a>
<a name="ln834">JobSetupView::UpdateHalftonePreview()</a>
<a name="ln835">{</a>
<a name="ln836">	if (!IsHalftoneConfigurationNeeded())</a>
<a name="ln837">		return;</a>
<a name="ln838"> </a>
<a name="ln839">	fHalftone-&gt;Preview(Gamma(), InkDensity(), DitherType(),</a>
<a name="ln840">		Color() != JobData::kMonochrome);</a>
<a name="ln841">}</a>
<a name="ln842"> </a>
<a name="ln843"> </a>
<a name="ln844">void</a>
<a name="ln845">JobSetupView::UpdateIntSlider(BMessage* message)</a>
<a name="ln846">{</a>
<a name="ln847">	int32 id;</a>
<a name="ln848">	if (message-&gt;FindInt32(kCategoryID, &amp;id) != B_OK)</a>
<a name="ln849">		return;</a>
<a name="ln850">	PrinterCap::CapID capID = static_cast&lt;PrinterCap::CapID&gt;(id);</a>
<a name="ln851">	fDriverSpecificIntSliders[capID].UpdateLabel();</a>
<a name="ln852">}</a>
<a name="ln853"> </a>
<a name="ln854"> </a>
<a name="ln855">void</a>
<a name="ln856">JobSetupView::UpdateDoubleSlider(BMessage* message)</a>
<a name="ln857">{</a>
<a name="ln858">	int32 id;</a>
<a name="ln859">	if (message-&gt;FindInt32(kCategoryID, &amp;id) != B_OK)</a>
<a name="ln860">		return;</a>
<a name="ln861">	PrinterCap::CapID capID = static_cast&lt;PrinterCap::CapID&gt;(id);</a>
<a name="ln862">	fDriverSpecificDoubleSliders[capID].UpdateLabel();</a>
<a name="ln863">}</a>
<a name="ln864"> </a>
<a name="ln865"> </a>
<a name="ln866">JobData::Color</a>
<a name="ln867">JobSetupView::Color()</a>
<a name="ln868">{</a>
<a name="ln869">	const char *label = fColorType-&gt;FindMarked()-&gt;Label();</a>
<a name="ln870">	const BaseCap* capability = fPrinterCap-&gt;FindCap(PrinterCap::kColor, label);</a>
<a name="ln871">	if (capability == NULL)</a>
<a name="ln872">		return JobData::kMonochrome;</a>
<a name="ln873"> </a>
<a name="ln874">	const ColorCap* colorCap = static_cast&lt;const ColorCap*&gt;(capability);</a>
<a name="ln875">	return colorCap-&gt;fColor;</a>
<a name="ln876">}</a>
<a name="ln877"> </a>
<a name="ln878"> </a>
<a name="ln879">Halftone::DitherType</a>
<a name="ln880">JobSetupView::DitherType()</a>
<a name="ln881">{</a>
<a name="ln882">	const char *label = fDitherType-&gt;FindMarked()-&gt;Label();</a>
<a name="ln883">	int id = GetID(gDitherTypes, sizeof(gDitherTypes) / sizeof(gDitherTypes[0]),</a>
<a name="ln884">		label, Halftone::kTypeFloydSteinberg);</a>
<a name="ln885">	return static_cast&lt;Halftone::DitherType&gt;(id);</a>
<a name="ln886">}</a>
<a name="ln887"> </a>
<a name="ln888">float</a>
<a name="ln889">JobSetupView::Gamma()</a>
<a name="ln890">{</a>
<a name="ln891">	const float value = (float)fGamma-&gt;Value();</a>
<a name="ln892">	return pow(2.0, value / 100.0);</a>
<a name="ln893">}</a>
<a name="ln894"> </a>
<a name="ln895"> </a>
<a name="ln896">float</a>
<a name="ln897">JobSetupView::InkDensity()</a>
<a name="ln898">{</a>
<a name="ln899">	const float value = (float)(127 - fInkDensity-&gt;Value());</a>
<a name="ln900">	return value;</a>
<a name="ln901">}</a>
<a name="ln902"> </a>
<a name="ln903"> </a>
<a name="ln904">JobData::PaperSource</a>
<a name="ln905">JobSetupView::PaperSource()</a>
<a name="ln906">{</a>
<a name="ln907">	const char *label = fPaperFeed-&gt;FindMarked()-&gt;Label();</a>
<a name="ln908">	const BaseCap* capability = fPrinterCap-&gt;FindCap(PrinterCap::kPaperSource,</a>
<a name="ln909">		label);</a>
<a name="ln910"> </a>
<a name="ln911">	if (capability == NULL)</a>
<a name="ln912">		capability = fPrinterCap-&gt;GetDefaultCap(PrinterCap::kPaperSource);</a>
<a name="ln913">	return static_cast&lt;const PaperSourceCap*&gt;(capability)-&gt;fPaperSource;</a>
<a name="ln914"> </a>
<a name="ln915">}</a>
<a name="ln916"> </a>
<a name="ln917">bool</a>
<a name="ln918">JobSetupView::UpdateJobData()</a>
<a name="ln919">{</a>
<a name="ln920">	fJobData-&gt;SetShowPreview(fPreview-&gt;Value() == B_CONTROL_ON);</a>
<a name="ln921">	fJobData-&gt;SetColor(Color());</a>
<a name="ln922">	if (IsHalftoneConfigurationNeeded()) {</a>
<a name="ln923">		fJobData-&gt;SetGamma(Gamma());</a>
<a name="ln924">		fJobData-&gt;SetInkDensity(InkDensity());</a>
<a name="ln925">		fJobData-&gt;SetDitherType(DitherType());</a>
<a name="ln926">	}</a>
<a name="ln927"> </a>
<a name="ln928">	int first_page;</a>
<a name="ln929">	int last_page;</a>
<a name="ln930"> </a>
<a name="ln931">	if (B_CONTROL_ON == fAll-&gt;Value()) {</a>
<a name="ln932">		first_page = 1;</a>
<a name="ln933">		last_page  = -1;</a>
<a name="ln934">	} else {</a>
<a name="ln935">		first_page = atoi(fFromPage-&gt;Text());</a>
<a name="ln936">		last_page  = atoi(fToPage-&gt;Text());</a>
<a name="ln937">	}</a>
<a name="ln938"> </a>
<a name="ln939">	fJobData-&gt;SetFirstPage(first_page);</a>
<a name="ln940">	fJobData-&gt;SetLastPage(last_page);</a>
<a name="ln941"> </a>
<a name="ln942">	fJobData-&gt;SetPaperSource(PaperSource());</a>
<a name="ln943"> </a>
<a name="ln944">	fJobData-&gt;SetNup(GetID(gNups, sizeof(gNups) / sizeof(gNups[0]),</a>
<a name="ln945">		fNup-&gt;FindMarked()-&gt;Label(), 1));</a>
<a name="ln946"> </a>
<a name="ln947">	if (fPrinterCap-&gt;Supports(PrinterCap::kPrintStyle)) {</a>
<a name="ln948">		fJobData-&gt;SetPrintStyle((B_CONTROL_ON == fDuplex-&gt;Value())</a>
<a name="ln949">			? JobData::kDuplex : JobData::kSimplex);</a>
<a name="ln950">	}</a>
<a name="ln951"> </a>
<a name="ln952">	fJobData-&gt;SetCopies(atoi(fCopies-&gt;Text()));</a>
<a name="ln953"> </a>
<a name="ln954">	fJobData-&gt;SetCollate(B_CONTROL_ON == fCollate-&gt;Value());</a>
<a name="ln955">	fJobData-&gt;SetReverse(B_CONTROL_ON == fReverse-&gt;Value());</a>
<a name="ln956"> </a>
<a name="ln957">	JobData::PageSelection pageSelection = JobData::kAllPages;</a>
<a name="ln958">	if (fOddNumberedPages-&gt;Value() == B_CONTROL_ON)</a>
<a name="ln959">		pageSelection = JobData::kOddNumberedPages;</a>
<a name="ln960">	if (fEvenNumberedPages-&gt;Value() == B_CONTROL_ON)</a>
<a name="ln961">		pageSelection = JobData::kEvenNumberedPages;</a>
<a name="ln962">	fJobData-&gt;SetPageSelection(pageSelection);</a>
<a name="ln963"> </a>
<a name="ln964">	{</a>
<a name="ln965">		std::map&lt;PrinterCap::CapID, BPopUpMenu*&gt;::iterator it =</a>
<a name="ln966">			fDriverSpecificPopUpMenus.begin();</a>
<a name="ln967">		for(; it != fDriverSpecificPopUpMenus.end(); it++) {</a>
<a name="ln968">			PrinterCap::CapID category = it-&gt;first;</a>
<a name="ln969">			BPopUpMenu* popUpMenu = it-&gt;second;</a>
<a name="ln970">			const char* key = fPrinterCap-&gt;FindCap(</a>
<a name="ln971">				PrinterCap::kDriverSpecificCapabilities, (int)category)-&gt;Key();</a>
<a name="ln972">			const char* label = popUpMenu-&gt;FindMarked()-&gt;Label();</a>
<a name="ln973">			const char* value = static_cast&lt;const EnumCap*&gt;(fPrinterCap-&gt;</a>
<a name="ln974">				FindCap(category, label))-&gt;Key();</a>
<a name="ln975">			fJobData-&gt;Settings().SetString(key, value);</a>
<a name="ln976">		}</a>
<a name="ln977">	}</a>
<a name="ln978"> </a>
<a name="ln979">	{</a>
<a name="ln980">		std::map&lt;string, BCheckBox*&gt;::iterator it =</a>
<a name="ln981">			fDriverSpecificCheckBoxes.begin();</a>
<a name="ln982">		for(; it != fDriverSpecificCheckBoxes.end(); it++) {</a>
<a name="ln983">			const char* key = it-&gt;first.c_str();</a>
<a name="ln984">			BCheckBox* checkBox = it-&gt;second;</a>
<a name="ln985">			bool value = checkBox-&gt;Value() == B_CONTROL_ON;</a>
<a name="ln986">			fJobData-&gt;Settings().SetBoolean(key, value);</a>
<a name="ln987">		}</a>
<a name="ln988">	}</a>
<a name="ln989"> </a>
<a name="ln990">	{</a>
<a name="ln991">		std::map&lt;PrinterCap::CapID, IntRange&gt;::iterator it =</a>
<a name="ln992">			fDriverSpecificIntSliders.begin();</a>
<a name="ln993">		for(; it != fDriverSpecificIntSliders.end(); it++) {</a>
<a name="ln994">			IntRange&amp; range = it-&gt;second;</a>
<a name="ln995">			fJobData-&gt;Settings().SetInt(range.Key(), range.Value());</a>
<a name="ln996">		}</a>
<a name="ln997">	}</a>
<a name="ln998"> </a>
<a name="ln999">	{</a>
<a name="ln1000">		std::map&lt;PrinterCap::CapID, DoubleRange&gt;::iterator it =</a>
<a name="ln1001">			fDriverSpecificDoubleSliders.begin();</a>
<a name="ln1002">		for(; it != fDriverSpecificDoubleSliders.end(); it++) {</a>
<a name="ln1003">			DoubleRange&amp; range = it-&gt;second;</a>
<a name="ln1004">			fJobData-&gt;Settings().SetDouble(range.Key(), range.Value());</a>
<a name="ln1005">		}</a>
<a name="ln1006">	}</a>
<a name="ln1007"> </a>
<a name="ln1008">	fJobData-&gt;Save();</a>
<a name="ln1009">	return true;</a>
<a name="ln1010">}</a>
<a name="ln1011"> </a>
<a name="ln1012"> </a>
<a name="ln1013">JobSetupDlg::JobSetupDlg(JobData* jobData, PrinterData* printerData,</a>
<a name="ln1014">	const PrinterCap* printerCap)</a>
<a name="ln1015">	:</a>
<a name="ln1016">	DialogWindow(BRect(100, 100, 200, 200), &quot;Print job setup&quot;,</a>
<a name="ln1017">		B_TITLED_WINDOW_LOOK, B_MODAL_APP_WINDOW_FEEL,</a>
<a name="ln1018">		B_NOT_RESIZABLE | B_NOT_MINIMIZABLE | B_NOT_ZOOMABLE</a>
<a name="ln1019">			| B_ASYNCHRONOUS_CONTROLS | B_AUTO_UPDATE_SIZE_LIMITS</a>
<a name="ln1020">			| B_CLOSE_ON_ESCAPE)</a>
<a name="ln1021">{</a>
<a name="ln1022">	SetResult(B_ERROR);</a>
<a name="ln1023">	AddShortcut('W', B_COMMAND_KEY, new BMessage(B_QUIT_REQUESTED));</a>
<a name="ln1024"> </a>
<a name="ln1025">	fJobSetup = new JobSetupView(jobData, printerData, printerCap);</a>
<a name="ln1026">	SetLayout(new BGroupLayout(B_VERTICAL));</a>
<a name="ln1027">	AddChild(BGroupLayoutBuilder(B_VERTICAL, 0)</a>
<a name="ln1028">		.Add(fJobSetup)</a>
<a name="ln1029">		.SetInsets(10, 10, 10, 10)</a>
<a name="ln1030">	);</a>
<a name="ln1031">}</a>
<a name="ln1032"> </a>
<a name="ln1033"> </a>
<a name="ln1034">void</a>
<a name="ln1035">JobSetupDlg::MessageReceived(BMessage* message)</a>
<a name="ln1036">{</a>
<a name="ln1037">	switch (message-&gt;what) {</a>
<a name="ln1038">	case kMsgOK:</a>
<a name="ln1039">		fJobSetup-&gt;UpdateJobData();</a>
<a name="ln1040">		SetResult(B_NO_ERROR);</a>
<a name="ln1041">		PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln1042">		break;</a>
<a name="ln1043"> </a>
<a name="ln1044">	case kMsgCancel:</a>
<a name="ln1045">		PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln1046">		break;</a>
<a name="ln1047"> </a>
<a name="ln1048">	default:</a>
<a name="ln1049">		DialogWindow::MessageReceived(message);</a>
<a name="ln1050">		break;</a>
<a name="ln1051">	}</a>
<a name="ln1052">}</a>

</code></pre>
<div class="balloon" rel="449"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'pagesPerSheet' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="449"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'paperSourceMenufield' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="137"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: fDitherMenuField, fHalftoneBox, fPreview.</p></div>
<div class="balloon" rel="449"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'colorMenuField' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
