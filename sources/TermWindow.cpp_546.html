
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>TermWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2007-2015, Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Copyright (c) 2004 Daniel Furrer &lt;assimil8or@users.sourceforge.net&gt;</a>
<a name="ln4"> * Copyright (c) 2003-2004 Kian Duffy &lt;myob@users.sourceforge.net&gt;</a>
<a name="ln5"> * Copyright (C) 1998,99 Kazuho Okui and Takashi Murai.</a>
<a name="ln6"> *</a>
<a name="ln7"> * Distributed under the terms of the MIT license.</a>
<a name="ln8"> *</a>
<a name="ln9"> * Authors:</a>
<a name="ln10"> *		Kian Duffy, myob@users.sourceforge.net</a>
<a name="ln11"> *		Daniel Furrer, assimil8or@users.sourceforge.net</a>
<a name="ln12"> *		John Scipione, jscipione@gmail.com</a>
<a name="ln13"> *		Siarzhuk Zharski, zharik@gmx.li</a>
<a name="ln14"> */</a>
<a name="ln15"> </a>
<a name="ln16"> </a>
<a name="ln17">#include &quot;TermWindow.h&quot;</a>
<a name="ln18"> </a>
<a name="ln19">#include &lt;new&gt;</a>
<a name="ln20">#include &lt;stdio.h&gt;</a>
<a name="ln21">#include &lt;stdlib.h&gt;</a>
<a name="ln22">#include &lt;strings.h&gt;</a>
<a name="ln23">#include &lt;time.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;Alert.h&gt;</a>
<a name="ln26">#include &lt;Application.h&gt;</a>
<a name="ln27">#include &lt;Catalog.h&gt;</a>
<a name="ln28">#include &lt;CharacterSet.h&gt;</a>
<a name="ln29">#include &lt;CharacterSetRoster.h&gt;</a>
<a name="ln30">#include &lt;Clipboard.h&gt;</a>
<a name="ln31">#include &lt;Dragger.h&gt;</a>
<a name="ln32">#include &lt;File.h&gt;</a>
<a name="ln33">#include &lt;FindDirectory.h&gt;</a>
<a name="ln34">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln35">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln36">#include &lt;Locale.h&gt;</a>
<a name="ln37">#include &lt;Menu.h&gt;</a>
<a name="ln38">#include &lt;MenuBar.h&gt;</a>
<a name="ln39">#include &lt;MenuItem.h&gt;</a>
<a name="ln40">#include &lt;Path.h&gt;</a>
<a name="ln41">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln42">#include &lt;PrintJob.h&gt;</a>
<a name="ln43">#include &lt;Rect.h&gt;</a>
<a name="ln44">#include &lt;Roster.h&gt;</a>
<a name="ln45">#include &lt;Screen.h&gt;</a>
<a name="ln46">#include &lt;ScrollBar.h&gt;</a>
<a name="ln47">#include &lt;ScrollView.h&gt;</a>
<a name="ln48">#include &lt;String.h&gt;</a>
<a name="ln49">#include &lt;UTF8.h&gt;</a>
<a name="ln50"> </a>
<a name="ln51">#include &lt;AutoLocker.h&gt;</a>
<a name="ln52"> </a>
<a name="ln53">#include &quot;ActiveProcessInfo.h&quot;</a>
<a name="ln54">#include &quot;Arguments.h&quot;</a>
<a name="ln55">#include &quot;AppearPrefView.h&quot;</a>
<a name="ln56">#include &quot;FindWindow.h&quot;</a>
<a name="ln57">#include &quot;Globals.h&quot;</a>
<a name="ln58">#include &quot;PrefWindow.h&quot;</a>
<a name="ln59">#include &quot;PrefHandler.h&quot;</a>
<a name="ln60">#include &quot;SetTitleDialog.h&quot;</a>
<a name="ln61">#include &quot;ShellParameters.h&quot;</a>
<a name="ln62">#include &quot;TermConst.h&quot;</a>
<a name="ln63">#include &quot;TermScrollView.h&quot;</a>
<a name="ln64">#include &quot;TitlePlaceholderMapper.h&quot;</a>
<a name="ln65"> </a>
<a name="ln66"> </a>
<a name="ln67">const static int32 kTermViewOffset = 3;</a>
<a name="ln68"> </a>
<a name="ln69">const static int32 kMinimumFontSize = 8;</a>
<a name="ln70">const static int32 kMaximumFontSize = 36;</a>
<a name="ln71"> </a>
<a name="ln72">// messages constants</a>
<a name="ln73">static const uint32 kNewTab = 'NTab';</a>
<a name="ln74">static const uint32 kCloseView = 'ClVw';</a>
<a name="ln75">static const uint32 kCloseOtherViews = 'CloV';</a>
<a name="ln76">static const uint32 kIncreaseFontSize = 'InFs';</a>
<a name="ln77">static const uint32 kDecreaseFontSize = 'DcFs';</a>
<a name="ln78">static const uint32 kSetActiveTab = 'STab';</a>
<a name="ln79">static const uint32 kUpdateTitles = 'UPti';</a>
<a name="ln80">static const uint32 kEditTabTitle = 'ETti';</a>
<a name="ln81">static const uint32 kEditWindowTitle = 'EWti';</a>
<a name="ln82">static const uint32 kTabTitleChanged = 'TTch';</a>
<a name="ln83">static const uint32 kWindowTitleChanged = 'WTch';</a>
<a name="ln84">static const uint32 kUpdateSwitchTerminalsMenuItem = 'Ustm';</a>
<a name="ln85"> </a>
<a name="ln86">using namespace BPrivate ; // BCharacterSet stuff</a>
<a name="ln87"> </a>
<a name="ln88">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln89">#define B_TRANSLATION_CONTEXT &quot;Terminal TermWindow&quot;</a>
<a name="ln90"> </a>
<a name="ln91">// actually an arrow</a>
<a name="ln92">#define UTF8_ENTER &quot;\xe2\x86\xb5&quot;</a>
<a name="ln93"> </a>
<a name="ln94"> </a>
<a name="ln95">// #pragma mark - TermViewContainerView</a>
<a name="ln96"> </a>
<a name="ln97"> </a>
<a name="ln98">class TermViewContainerView : public BView {</a>
<a name="ln99">public:</a>
<a name="ln100">	TermViewContainerView(TermView* termView)</a>
<a name="ln101">		:</a>
<a name="ln102">		BView(BRect(), &quot;term view container&quot;, B_FOLLOW_ALL, 0),</a>
<a name="ln103">		fTermView(termView)</a>
<a name="ln104">	{</a>
<a name="ln105">		termView-&gt;MoveTo(kTermViewOffset, kTermViewOffset);</a>
<a name="ln106">		BRect frame(termView-&gt;Frame());</a>
<a name="ln107">		ResizeTo(frame.right + kTermViewOffset, frame.bottom + kTermViewOffset);</a>
<a name="ln108">		AddChild(termView);</a>
<a name="ln109">	}</a>
<a name="ln110"> </a>
<a name="ln111">	TermView* GetTermView() const	{ return fTermView; }</a>
<a name="ln112"> </a>
<a name="ln113">	virtual void GetPreferredSize(float* _width, float* _height)</a>
<a name="ln114">	{</a>
<a name="ln115">		float width, height;</a>
<a name="ln116">		fTermView-&gt;GetPreferredSize(&amp;width, &amp;height);</a>
<a name="ln117">		*_width = width + 2 * kTermViewOffset;</a>
<a name="ln118">		*_height = height + 2 * kTermViewOffset;</a>
<a name="ln119">	}</a>
<a name="ln120"> </a>
<a name="ln121">private:</a>
<a name="ln122">	TermView*	fTermView;</a>
<a name="ln123">};</a>
<a name="ln124"> </a>
<a name="ln125"> </a>
<a name="ln126">// #pragma mark - SessionID</a>
<a name="ln127"> </a>
<a name="ln128"> </a>
<a name="ln129">TermWindow::SessionID::SessionID(int32 id)</a>
<a name="ln130">	:</a>
<a name="ln131">	fID(id)</a>
<a name="ln132">{</a>
<a name="ln133">}</a>
<a name="ln134"> </a>
<a name="ln135"> </a>
<a name="ln136">TermWindow::SessionID::SessionID(const BMessage&amp; message, const char* field)</a>
<a name="ln137">{</a>
<a name="ln138">	if (message.FindInt32(field, &amp;fID) != B_OK)</a>
<a name="ln139">		fID = -1;</a>
<a name="ln140">}</a>
<a name="ln141"> </a>
<a name="ln142"> </a>
<a name="ln143">status_t</a>
<a name="ln144">TermWindow::SessionID::AddToMessage(BMessage&amp; message, const char* field) const</a>
<a name="ln145">{</a>
<a name="ln146">	return message.AddInt32(field, fID);</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149"> </a>
<a name="ln150">// #pragma mark - Session</a>
<a name="ln151"> </a>
<a name="ln152"> </a>
<a name="ln153">struct TermWindow::Session {</a>
<a name="ln154">	SessionID				id;</a>
<a name="ln155">	int32					index;</a>
<a name="ln156">	Title					title;</a>
<a name="ln157">	TermViewContainerView*	containerView;</a>
<a name="ln158"> </a>
<a name="ln159">	Session(SessionID id, int32 index, TermViewContainerView* containerView)</a>
<a name="ln160">		:</a>
<a name="ln161">		id(id),</a>
<a name="ln162">		index(index),</a>
<a name="ln163">		containerView(containerView)</a>
<a name="ln164">	{</a>
<a name="ln165">		title.title = B_TRANSLATE(&quot;Shell &quot;);</a>
<a name="ln166">		title.title &lt;&lt; index;</a>
<a name="ln167">		title.patternUserDefined = false;</a>
<a name="ln168">	}</a>
<a name="ln169">};</a>
<a name="ln170"> </a>
<a name="ln171"> </a>
<a name="ln172">// #pragma mark - TermWindow</a>
<a name="ln173"> </a>
<a name="ln174"> </a>
<a name="ln175">TermWindow::TermWindow(const BString&amp; title, Arguments* args)</a>
<a name="ln176">	:</a>
<a name="ln177">	BWindow(BRect(0, 0, 0, 0), title, B_DOCUMENT_WINDOW,</a>
<a name="ln178">		B_CURRENT_WORKSPACE | B_QUIT_ON_WINDOW_CLOSE),</a>
<a name="ln179">	fTitleUpdateRunner(this, BMessage(kUpdateTitles), 1000000),</a>
<a name="ln180">	fNextSessionID(0),</a>
<a name="ln181">	fTabView(NULL),</a>
<a name="ln182">	fMenuBar(NULL),</a>
<a name="ln183">	fSwitchTerminalsMenuItem(NULL),</a>
<a name="ln184">	fEncodingMenu(NULL),</a>
<a name="ln185">	fPrintSettings(NULL),</a>
<a name="ln186">	fPrefWindow(NULL),</a>
<a name="ln187">	fFindPanel(NULL),</a>
<a name="ln188">	fSavedFrame(0, 0, -1, -1),</a>
<a name="ln189">	fSetWindowTitleDialog(NULL),</a>
<a name="ln190">	fSetTabTitleDialog(NULL),</a>
<a name="ln191">	fFindString(&quot;&quot;),</a>
<a name="ln192">	fFindNextMenuItem(NULL),</a>
<a name="ln193">	fFindPreviousMenuItem(NULL),</a>
<a name="ln194">	fFindSelection(false),</a>
<a name="ln195">	fForwardSearch(false),</a>
<a name="ln196">	fMatchCase(false),</a>
<a name="ln197">	fMatchWord(false),</a>
<a name="ln198">	fFullScreen(false)</a>
<a name="ln199">{</a>
<a name="ln200">	// register this terminal</a>
<a name="ln201">	fTerminalRoster.Register(Team(), this);</a>
<a name="ln202">	fTerminalRoster.SetListener(this);</a>
<a name="ln203">	int32 id = fTerminalRoster.ID();</a>
<a name="ln204"> </a>
<a name="ln205">	// apply the title settings</a>
<a name="ln206">	fTitle.pattern = title;</a>
<a name="ln207">	if (fTitle.pattern.Length() == 0) {</a>
<a name="ln208">		fTitle.pattern = B_TRANSLATE_SYSTEM_NAME(&quot;Terminal&quot;);</a>
<a name="ln209"> </a>
<a name="ln210">		if (id &gt;= 0)</a>
<a name="ln211">			fTitle.pattern &lt;&lt; &quot; &quot; &lt;&lt; id + 1;</a>
<a name="ln212"> </a>
<a name="ln213">		fTitle.patternUserDefined = false;</a>
<a name="ln214">	} else</a>
<a name="ln215">		fTitle.patternUserDefined = true;</a>
<a name="ln216"> </a>
<a name="ln217">	fTitle.title = fTitle.pattern;</a>
<a name="ln218">	fTitle.pattern = title;</a>
<a name="ln219"> </a>
<a name="ln220">	_TitleSettingsChanged();</a>
<a name="ln221"> </a>
<a name="ln222">	// get the saved window position and workspaces</a>
<a name="ln223">	BRect frame;</a>
<a name="ln224">	uint32 workspaces;</a>
<a name="ln225">	if (_LoadWindowPosition(&amp;frame, &amp;workspaces) == B_OK) {</a>
<a name="ln226">		// make sure the window is still on screen</a>
<a name="ln227">		// (for example if there was a resolution change)</a>
<a name="ln228">		BRect screenFrame = BScreen(this).Frame();</a>
<a name="ln229">		if (frame.Width() &lt;= screenFrame.Width()</a>
<a name="ln230">			&amp;&amp; frame.Height() &lt;= screenFrame.Height())</a>
<a name="ln231">			ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln232"> </a>
<a name="ln233">		MoveTo(frame.LeftTop());</a>
<a name="ln234">		MoveOnScreen(B_MOVE_IF_PARTIALLY_OFFSCREEN);</a>
<a name="ln235"> </a>
<a name="ln236">		SetWorkspaces(workspaces);</a>
<a name="ln237">	} else {</a>
<a name="ln238">		// use computed defaults</a>
<a name="ln239">		int row = id / 16;</a>
<a name="ln240">		int column = id % 16;</a>
<a name="ln241">		int x = (column * 16) + (row * 64) + 50;</a>
<a name="ln242">		int y = (column * 16) + 50;</a>
<a name="ln243"> </a>
<a name="ln244">		MoveTo(x, y);</a>
<a name="ln245">	}</a>
<a name="ln246"> </a>
<a name="ln247">	// init the GUI and add a tab</a>
<a name="ln248">	_InitWindow();</a>
<a name="ln249">	_AddTab(args);</a>
<a name="ln250"> </a>
<a name="ln251">	// Announce our window as no longer minimized. That's not true, since it's</a>
<a name="ln252">	// still hidden at this point, but it will be shown very soon.</a>
<a name="ln253">	fTerminalRoster.SetWindowInfo(false, Workspaces());</a>
<a name="ln254">}</a>
<a name="ln255"> </a>
<a name="ln256"> </a>
<a name="ln257">TermWindow::~TermWindow()</a>
<a name="ln258">{</a>
<a name="ln259">	fTerminalRoster.Unregister();</a>
<a name="ln260"> </a>
<a name="ln261">	_FinishTitleDialog();</a>
<a name="ln262"> </a>
<a name="ln263">	if (fPrefWindow)</a>
<a name="ln264">		fPrefWindow-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln265"> </a>
<a name="ln266">	if (fFindPanel &amp;&amp; fFindPanel-&gt;Lock()) {</a>
<a name="ln267">		fFindPanel-&gt;Quit();</a>
<a name="ln268">		fFindPanel = NULL;</a>
<a name="ln269">	}</a>
<a name="ln270"> </a>
<a name="ln271">	PrefHandler::DeleteDefault();</a>
<a name="ln272"> </a>
<a name="ln273">	for (int32 i = 0; Session* session = _SessionAt(i); i++)</a>
<a name="ln274">		delete session;</a>
<a name="ln275">}</a>
<a name="ln276"> </a>
<a name="ln277"> </a>
<a name="ln278">void</a>
<a name="ln279">TermWindow::SessionChanged()</a>
<a name="ln280">{</a>
<a name="ln281">	_UpdateSessionTitle(fTabView-&gt;Selection());</a>
<a name="ln282">}</a>
<a name="ln283"> </a>
<a name="ln284"> </a>
<a name="ln285">void</a>
<a name="ln286">TermWindow::_InitWindow()</a>
<a name="ln287">{</a>
<a name="ln288">	// make menu bar</a>
<a name="ln289">	_SetupMenu();</a>
<a name="ln290"> </a>
<a name="ln291">	// shortcuts to switch tabs</a>
<a name="ln292">	for (int32 i = 0; i &lt; 9; i++) {</a>
<a name="ln293">		BMessage* message = new BMessage(kSetActiveTab);</a>
<a name="ln294">		message-&gt;AddInt32(&quot;index&quot;, i);</a>
<a name="ln295">		AddShortcut('1' + i, B_COMMAND_KEY, message);</a>
<a name="ln296">	}</a>
<a name="ln297"> </a>
<a name="ln298">	AddShortcut(B_LEFT_ARROW, B_COMMAND_KEY | B_SHIFT_KEY,</a>
<a name="ln299">		new BMessage(MSG_MOVE_TAB_LEFT));</a>
<a name="ln300">	AddShortcut(B_RIGHT_ARROW, B_COMMAND_KEY | B_SHIFT_KEY,</a>
<a name="ln301">		new BMessage(MSG_MOVE_TAB_RIGHT));</a>
<a name="ln302"> </a>
<a name="ln303">	BRect textFrame = Bounds();</a>
<a name="ln304">	textFrame.top = fMenuBar-&gt;Bounds().bottom + 1.0;</a>
<a name="ln305"> </a>
<a name="ln306">	fTabView = new SmartTabView(textFrame, &quot;tab view&quot;, B_WIDTH_FROM_LABEL);</a>
<a name="ln307">	fTabView-&gt;SetListener(this);</a>
<a name="ln308">	AddChild(fTabView);</a>
<a name="ln309"> </a>
<a name="ln310">	// Make the scroll view one pixel wider than the tab view container view, so</a>
<a name="ln311">	// the scroll bar will look good.</a>
<a name="ln312">	fTabView-&gt;SetInsets(0, 0, -1, 0);</a>
<a name="ln313">}</a>
<a name="ln314"> </a>
<a name="ln315"> </a>
<a name="ln316">bool</a>
<a name="ln317">TermWindow::_CanClose(int32 index)</a>
<a name="ln318">{</a>
<a name="ln319">	bool warnOnExit = PrefHandler::Default()-&gt;getBool(PREF_WARN_ON_EXIT);</a>
<a name="ln320"> </a>
<a name="ln321">	if (!warnOnExit)</a>
<a name="ln322">		return true;</a>
<a name="ln323"> </a>
<a name="ln324">	uint32 busyProcessCount = 0;</a>
<a name="ln325">	BString busyProcessNames;</a>
<a name="ln326">		// all names, separated by &quot;\n\t&quot;</a>
<a name="ln327"> </a>
<a name="ln328">	if (index != -1) {</a>
<a name="ln329">		ShellInfo shellInfo;</a>
<a name="ln330">		ActiveProcessInfo info;</a>
<a name="ln331">		TermView* termView = _TermViewAt(index);</a>
<a name="ln332">		if (termView-&gt;GetShellInfo(shellInfo)</a>
<a name="ln333">			&amp;&amp; termView-&gt;GetActiveProcessInfo(info)</a>
<a name="ln334">			&amp;&amp; (info.ID() != shellInfo.ProcessID()</a>
<a name="ln335">				|| !shellInfo.IsDefaultShell())) {</a>
<a name="ln336">			busyProcessCount++;</a>
<a name="ln337">			busyProcessNames = info.Name();</a>
<a name="ln338">		}</a>
<a name="ln339">	} else {</a>
<a name="ln340">		for (int32 i = 0; i &lt; fSessions.CountItems(); i++) {</a>
<a name="ln341">			ShellInfo shellInfo;</a>
<a name="ln342">			ActiveProcessInfo info;</a>
<a name="ln343">			TermView* termView = _TermViewAt(i);</a>
<a name="ln344">			if (termView-&gt;GetShellInfo(shellInfo)</a>
<a name="ln345">				&amp;&amp; termView-&gt;GetActiveProcessInfo(info)</a>
<a name="ln346">				&amp;&amp; (info.ID() != shellInfo.ProcessID()</a>
<a name="ln347">					|| !shellInfo.IsDefaultShell())) {</a>
<a name="ln348">				if (++busyProcessCount &gt; 1)</a>
<a name="ln349">					busyProcessNames &lt;&lt; &quot;\n\t&quot;;</a>
<a name="ln350">				busyProcessNames &lt;&lt; info.Name();</a>
<a name="ln351">			}</a>
<a name="ln352">		}</a>
<a name="ln353">	}</a>
<a name="ln354"> </a>
<a name="ln355">	if (busyProcessCount == 0)</a>
<a name="ln356">		return true;</a>
<a name="ln357"> </a>
<a name="ln358">	BString alertMessage;</a>
<a name="ln359">	if (busyProcessCount == 1) {</a>
<a name="ln360">		// Only one pending process. Select the alert text depending on whether</a>
<a name="ln361">		// the terminal will be closed.</a>
<a name="ln362">		alertMessage = index == -1 || fSessions.CountItems() == 1</a>
<a name="ln363">			? B_TRANSLATE(&quot;The process \&quot;%1\&quot; is still running.\n&quot;</a>
<a name="ln364">				&quot;If you close the Terminal, the process will be killed.&quot;)</a>
<a name="ln365">			: B_TRANSLATE(&quot;The process \&quot;%1\&quot; is still running.\n&quot;</a>
<a name="ln366">				&quot;If you close the tab, the process will be killed.&quot;);</a>
<a name="ln367">	} else {</a>
<a name="ln368">		// multiple pending processes</a>
<a name="ln369">		alertMessage = B_TRANSLATE(</a>
<a name="ln370">			&quot;The following processes are still running:\n\n&quot;</a>
<a name="ln371">			&quot;\t%1\n\n&quot;</a>
<a name="ln372">			&quot;If you close the Terminal, the processes will be killed.&quot;);</a>
<a name="ln373">	}</a>
<a name="ln374"> </a>
<a name="ln375">	alertMessage.ReplaceFirst(&quot;%1&quot;, busyProcessNames);</a>
<a name="ln376"> </a>
<a name="ln377">	BAlert* alert = new BAlert(B_TRANSLATE(&quot;Really close?&quot;),</a>
<a name="ln378">		alertMessage, B_TRANSLATE(&quot;Close&quot;), B_TRANSLATE(&quot;Cancel&quot;), NULL,</a>
<a name="ln379">		B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln380">	alert-&gt;SetShortcut(1, B_ESCAPE);</a>
<a name="ln381">	return alert-&gt;Go() == 0;</a>
<a name="ln382">}</a>
<a name="ln383"> </a>
<a name="ln384"> </a>
<a name="ln385">bool</a>
<a name="ln386">TermWindow::QuitRequested()</a>
<a name="ln387">{</a>
<a name="ln388">	_FinishTitleDialog();</a>
<a name="ln389"> </a>
<a name="ln390">	if (!_CanClose(-1))</a>
<a name="ln391">		return false;</a>
<a name="ln392"> </a>
<a name="ln393">	_SaveWindowPosition();</a>
<a name="ln394"> </a>
<a name="ln395">	return BWindow::QuitRequested();</a>
<a name="ln396">}</a>
<a name="ln397"> </a>
<a name="ln398"> </a>
<a name="ln399">void</a>
<a name="ln400">TermWindow::MenusBeginning()</a>
<a name="ln401">{</a>
<a name="ln402">	TermView* view = _ActiveTermView();</a>
<a name="ln403"> </a>
<a name="ln404">	// Syncronize Encode Menu Pop-up menu and Preference.</a>
<a name="ln405">	const BCharacterSet* charset</a>
<a name="ln406">		= BCharacterSetRoster::GetCharacterSetByConversionID(view-&gt;Encoding());</a>
<a name="ln407">	if (charset != NULL) {</a>
<a name="ln408">		BString name(charset-&gt;GetPrintName());</a>
<a name="ln409">		const char* mime = charset-&gt;GetMIMEName();</a>
<a name="ln410">		if (mime)</a>
<a name="ln411">			name &lt;&lt; &quot; (&quot; &lt;&lt; mime &lt;&lt; &quot;)&quot;;</a>
<a name="ln412"> </a>
<a name="ln413">		BMenuItem* item = fEncodingMenu-&gt;FindItem(name);</a>
<a name="ln414">		if (item != NULL)</a>
<a name="ln415">			item-&gt;SetMarked(true);</a>
<a name="ln416">	}</a>
<a name="ln417"> </a>
<a name="ln418">	BFont font;</a>
<a name="ln419">	view-&gt;GetTermFont(&amp;font);</a>
<a name="ln420"> </a>
<a name="ln421">	float size = font.Size();</a>
<a name="ln422"> </a>
<a name="ln423">	fDecreaseFontSizeMenuItem-&gt;SetEnabled(size &gt; kMinimumFontSize);</a>
<a name="ln424">	fIncreaseFontSizeMenuItem-&gt;SetEnabled(size &lt; kMaximumFontSize);</a>
<a name="ln425"> </a>
<a name="ln426">	BWindow::MenusBeginning();</a>
<a name="ln427">}</a>
<a name="ln428"> </a>
<a name="ln429"> </a>
<a name="ln430">/* static */ void</a>
<a name="ln431">TermWindow::MakeEncodingMenu(BMenu* menu)</a>
<a name="ln432">{</a>
<a name="ln433">	BCharacterSetRoster roster;</a>
<a name="ln434">	BCharacterSet charset;</a>
<a name="ln435">	while (roster.GetNextCharacterSet(&amp;charset) == B_OK) {</a>
<a name="ln436">		int encoding = M_UTF8;</a>
<a name="ln437">		const char* mime = charset.GetMIMEName();</a>
<a name="ln438">		if (mime == NULL || strcasecmp(mime, &quot;UTF-8&quot;) != 0)</a>
<a name="ln439">			encoding = charset.GetConversionID();</a>
<a name="ln440"> </a>
<a name="ln441">		// filter out currently (???) not supported USC-2 and UTF-16</a>
<a name="ln442">		if (encoding == B_UTF16_CONVERSION || encoding == B_UNICODE_CONVERSION)</a>
<a name="ln443">			continue;</a>
<a name="ln444"> </a>
<a name="ln445">		BString name(charset.GetPrintName());</a>
<a name="ln446">		if (mime)</a>
<a name="ln447">			name &lt;&lt; &quot; (&quot; &lt;&lt; mime &lt;&lt; &quot;)&quot;;</a>
<a name="ln448"> </a>
<a name="ln449">		BMessage *message = new BMessage(MENU_ENCODING);</a>
<a name="ln450">		if (message != NULL) {</a>
<a name="ln451">			message-&gt;AddInt32(&quot;op&quot;, (int32)encoding);</a>
<a name="ln452">			menu-&gt;AddItem(new BMenuItem(name, message));</a>
<a name="ln453">		}</a>
<a name="ln454">	}</a>
<a name="ln455"> </a>
<a name="ln456">	menu-&gt;SetRadioMode(true);</a>
<a name="ln457">}</a>
<a name="ln458"> </a>
<a name="ln459"> </a>
<a name="ln460">void</a>
<a name="ln461">TermWindow::_SetupMenu()</a>
<a name="ln462">{</a>
<a name="ln463">	fFontSizeMenu = _MakeFontSizeMenu(MSG_HALF_SIZE_CHANGED,</a>
<a name="ln464">		PrefHandler::Default()-&gt;getInt32(PREF_HALF_FONT_SIZE));</a>
<a name="ln465">	fIncreaseFontSizeMenuItem = new BMenuItem(B_TRANSLATE(&quot;Increase&quot;),</a>
<a name="ln466">		new BMessage(kIncreaseFontSize), '+', B_COMMAND_KEY);</a>
<a name="ln467">	fDecreaseFontSizeMenuItem = new BMenuItem(B_TRANSLATE(&quot;Decrease&quot;),</a>
<a name="ln468">		new BMessage(kDecreaseFontSize), '-', B_COMMAND_KEY);</a>
<a name="ln469">	fFontSizeMenu-&gt;AddSeparatorItem();</a>
<a name="ln470">	fFontSizeMenu-&gt;AddItem(fIncreaseFontSizeMenuItem);</a>
<a name="ln471">	fFontSizeMenu-&gt;AddItem(fDecreaseFontSizeMenuItem);</a>
<a name="ln472"> </a>
<a name="ln473">	BMenu* windowSize = new(std::nothrow) BMenu(B_TRANSLATE(&quot;Window size&quot;));</a>
<a name="ln474">	if (windowSize != NULL) {</a>
<a name="ln475">		MakeWindowSizeMenu(windowSize);</a>
<a name="ln476">		windowSize-&gt;AddSeparatorItem();</a>
<a name="ln477">		windowSize-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Full screen&quot;),</a>
<a name="ln478">			new BMessage(FULLSCREEN), B_ENTER));</a>
<a name="ln479">	}</a>
<a name="ln480"> </a>
<a name="ln481">	fEncodingMenu = new(std::nothrow) BMenu(B_TRANSLATE(&quot;Text encoding&quot;));</a>
<a name="ln482">	if (fEncodingMenu != NULL)</a>
<a name="ln483">		MakeEncodingMenu(fEncodingMenu);</a>
<a name="ln484"> </a>
<a name="ln485">	BLayoutBuilder::Menu&lt;&gt;(fMenuBar = new BMenuBar(Bounds(), &quot;mbar&quot;))</a>
<a name="ln486">		// Terminal</a>
<a name="ln487">		.AddMenu(B_TRANSLATE_COMMENT(&quot;Terminal&quot;, &quot;The title for the main window&quot;</a>
<a name="ln488">				&quot; menubar entry related to terminal sessions&quot;))</a>
<a name="ln489">			.AddItem(B_TRANSLATE(&quot;Switch Terminals&quot;), MENU_SWITCH_TERM, B_TAB)</a>
<a name="ln490">				.GetItem(fSwitchTerminalsMenuItem)</a>
<a name="ln491">			.AddItem(B_TRANSLATE(&quot;New Terminal&quot;), MENU_NEW_TERM, 'N')</a>
<a name="ln492">			.AddItem(B_TRANSLATE(&quot;New tab&quot;), kNewTab, 'T')</a>
<a name="ln493">			.AddSeparator()</a>
<a name="ln494">			.AddItem(B_TRANSLATE(&quot;Page setup&quot; B_UTF8_ELLIPSIS), MENU_PAGE_SETUP)</a>
<a name="ln495">			.AddItem(B_TRANSLATE(&quot;Print&quot;), MENU_PRINT, 'P')</a>
<a name="ln496">			.AddSeparator()</a>
<a name="ln497">			.AddItem(B_TRANSLATE(&quot;Close window&quot;), B_QUIT_REQUESTED, 'W',</a>
<a name="ln498">				B_SHIFT_KEY)</a>
<a name="ln499">			.AddItem(B_TRANSLATE(&quot;Close active tab&quot;), kCloseView, 'W')</a>
<a name="ln500">			.AddItem(B_TRANSLATE(&quot;Quit&quot;), B_QUIT_REQUESTED, 'Q')</a>
<a name="ln501">		.End()</a>
<a name="ln502"> </a>
<a name="ln503">		// Edit</a>
<a name="ln504">		.AddMenu(B_TRANSLATE(&quot;Edit&quot;))</a>
<a name="ln505">			.AddItem(B_TRANSLATE(&quot;Copy&quot;), B_COPY, 'C')</a>
<a name="ln506">			.AddItem(B_TRANSLATE(&quot;Paste&quot;), B_PASTE, 'V')</a>
<a name="ln507">			.AddSeparator()</a>
<a name="ln508">			.AddItem(B_TRANSLATE(&quot;Select all&quot;), B_SELECT_ALL, 'A')</a>
<a name="ln509">			.AddItem(B_TRANSLATE(&quot;Clear all&quot;), MENU_CLEAR_ALL, 'L')</a>
<a name="ln510">			.AddSeparator()</a>
<a name="ln511">			.AddItem(B_TRANSLATE(&quot;Find&quot; B_UTF8_ELLIPSIS), MENU_FIND_STRING, 'F')</a>
<a name="ln512">			.AddItem(B_TRANSLATE(&quot;Find previous&quot;), MENU_FIND_PREVIOUS, 'G',</a>
<a name="ln513">					B_SHIFT_KEY)</a>
<a name="ln514">				.GetItem(fFindPreviousMenuItem)</a>
<a name="ln515">				.SetEnabled(false)</a>
<a name="ln516">			.AddItem(B_TRANSLATE(&quot;Find next&quot;), MENU_FIND_NEXT, 'G')</a>
<a name="ln517">				.GetItem(fFindNextMenuItem)</a>
<a name="ln518">				.SetEnabled(false)</a>
<a name="ln519">		.End()</a>
<a name="ln520"> </a>
<a name="ln521">		// Settings</a>
<a name="ln522">		.AddMenu(B_TRANSLATE(&quot;Settings&quot;))</a>
<a name="ln523">			.AddItem(B_TRANSLATE(&quot;Window title&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln524">				kEditWindowTitle)</a>
<a name="ln525">			.AddItem(windowSize)</a>
<a name="ln526">			.AddItem(fEncodingMenu)</a>
<a name="ln527">			.AddItem(fFontSizeMenu)</a>
<a name="ln528">			.AddItem(B_TRANSLATE(&quot;Save as default&quot;), MSG_SAVE_AS_DEFAULT)</a>
<a name="ln529">			.AddSeparator()</a>
<a name="ln530">			.AddItem(B_TRANSLATE(&quot;Settings&quot; B_UTF8_ELLIPSIS), MENU_PREF_OPEN)</a>
<a name="ln531">		.End();</a>
<a name="ln532"> </a>
<a name="ln533">	AddChild(fMenuBar);</a>
<a name="ln534"> </a>
<a name="ln535">	_UpdateSwitchTerminalsMenuItem();</a>
<a name="ln536"> </a>
<a name="ln537">#ifdef USE_DEBUG_SNAPSHOTS</a>
<a name="ln538">	AddShortcut('S', B_COMMAND_KEY | B_CONTROL_KEY,</a>
<a name="ln539">		new BMessage(SHORTCUT_DEBUG_SNAPSHOTS));</a>
<a name="ln540">	AddShortcut('C', B_COMMAND_KEY | B_CONTROL_KEY,</a>
<a name="ln541">		new BMessage(SHORTCUT_DEBUG_CAPTURE));</a>
<a name="ln542">#endif</a>
<a name="ln543">}</a>
<a name="ln544"> </a>
<a name="ln545"> </a>
<a name="ln546">status_t</a>
<a name="ln547">TermWindow::_GetWindowPositionFile(BFile* file, uint32 openMode)</a>
<a name="ln548">{</a>
<a name="ln549">	BPath path;</a>
<a name="ln550">	status_t status = find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path, true);</a>
<a name="ln551">	if (status != B_OK)</a>
<a name="ln552">		return status;</a>
<a name="ln553"> </a>
<a name="ln554">	status = path.Append(&quot;Terminal&quot;);</a>
<a name="ln555">	if (status != B_OK)</a>
<a name="ln556">		return status;</a>
<a name="ln557"> </a>
<a name="ln558">	status = path.Append(&quot;Windows&quot;);</a>
<a name="ln559">	if (status != B_OK)</a>
<a name="ln560">		return status;</a>
<a name="ln561"> </a>
<a name="ln562">	return file-&gt;SetTo(path.Path(), openMode);</a>
<a name="ln563">}</a>
<a name="ln564"> </a>
<a name="ln565"> </a>
<a name="ln566">status_t</a>
<a name="ln567">TermWindow::_LoadWindowPosition(BRect* frame, uint32* workspaces)</a>
<a name="ln568">{</a>
<a name="ln569">	status_t status;</a>
<a name="ln570">	BMessage position;</a>
<a name="ln571"> </a>
<a name="ln572">	BFile file;</a>
<a name="ln573">	status = _GetWindowPositionFile(&amp;file, B_READ_ONLY);</a>
<a name="ln574">	if (status != B_OK)</a>
<a name="ln575">		return status;</a>
<a name="ln576"> </a>
<a name="ln577">	status = position.Unflatten(&amp;file);</a>
<a name="ln578"> </a>
<a name="ln579">	file.Unset();</a>
<a name="ln580"> </a>
<a name="ln581">	if (status != B_OK)</a>
<a name="ln582">		return status;</a>
<a name="ln583"> </a>
<a name="ln584">	int32 id = fTerminalRoster.ID();</a>
<a name="ln585">	status = position.FindRect(&quot;rect&quot;, id, frame);</a>
<a name="ln586">	if (status != B_OK)</a>
<a name="ln587">		return status;</a>
<a name="ln588"> </a>
<a name="ln589">	int32 _workspaces;</a>
<a name="ln590">	status = position.FindInt32(&quot;workspaces&quot;, id, &amp;_workspaces);</a>
<a name="ln591">	if (status != B_OK)</a>
<a name="ln592">		return status;</a>
<a name="ln593">	if (modifiers() &amp; B_SHIFT_KEY)</a>
<a name="ln594">		*workspaces = _workspaces;</a>
<a name="ln595">	else</a>
<a name="ln596">		*workspaces = B_CURRENT_WORKSPACE;</a>
<a name="ln597"> </a>
<a name="ln598">	return B_OK;</a>
<a name="ln599">}</a>
<a name="ln600"> </a>
<a name="ln601"> </a>
<a name="ln602">status_t</a>
<a name="ln603">TermWindow::_SaveWindowPosition()</a>
<a name="ln604">{</a>
<a name="ln605">	BFile file;</a>
<a name="ln606">	BMessage originalSettings;</a>
<a name="ln607"> </a>
<a name="ln608">	// Read the settings file if it exists and is a valid BMessage.</a>
<a name="ln609">	status_t status = _GetWindowPositionFile(&amp;file, B_READ_ONLY);</a>
<a name="ln610">	if (status == B_OK) {</a>
<a name="ln611">		status = originalSettings.Unflatten(&amp;file);</a>
<a name="ln612">		file.Unset();</a>
<a name="ln613"> </a>
<a name="ln614">		if (status != B_OK)</a>
<a name="ln615">			status = originalSettings.MakeEmpty();</a>
<a name="ln616"> </a>
<a name="ln617">		if (status != B_OK)</a>
<a name="ln618">			return status;</a>
<a name="ln619">	}</a>
<a name="ln620"> </a>
<a name="ln621">	// Replace the settings</a>
<a name="ln622">	int32 id = fTerminalRoster.ID();</a>
<a name="ln623">	BRect rect(Frame());</a>
<a name="ln624">	if (originalSettings.ReplaceRect(&quot;rect&quot;, id, rect) != B_OK)</a>
<a name="ln625">		originalSettings.AddRect(&quot;rect&quot;, rect);</a>
<a name="ln626"> </a>
<a name="ln627">	int32 workspaces = Workspaces();</a>
<a name="ln628">	if (originalSettings.ReplaceInt32(&quot;workspaces&quot;, id, workspaces) != B_OK)</a>
<a name="ln629">		originalSettings.AddInt32(&quot;workspaces&quot;, workspaces);</a>
<a name="ln630"> </a>
<a name="ln631">	// Resave the whole thing</a>
<a name="ln632">	status = _GetWindowPositionFile (&amp;file,</a>
<a name="ln633">		B_WRITE_ONLY | B_CREATE_FILE | B_ERASE_FILE);</a>
<a name="ln634">	if (status != B_OK)</a>
<a name="ln635">		return status;</a>
<a name="ln636"> </a>
<a name="ln637">	return originalSettings.Flatten(&amp;file);</a>
<a name="ln638">}</a>
<a name="ln639"> </a>
<a name="ln640"> </a>
<a name="ln641">void</a>
<a name="ln642">TermWindow::_GetPreferredFont(BFont&amp; font)</a>
<a name="ln643">{</a>
<a name="ln644">	// Default to be_fixed_font</a>
<a name="ln645">	font = be_fixed_font;</a>
<a name="ln646"> </a>
<a name="ln647">	const char* family</a>
<a name="ln648">		= PrefHandler::Default()-&gt;getString(PREF_HALF_FONT_FAMILY);</a>
<a name="ln649">	const char* style</a>
<a name="ln650">		= PrefHandler::Default()-&gt;getString(PREF_HALF_FONT_STYLE);</a>
<a name="ln651">	const char* size = PrefHandler::Default()-&gt;getString(PREF_HALF_FONT_SIZE);</a>
<a name="ln652"> </a>
<a name="ln653">	font.SetFamilyAndStyle(family, style);</a>
<a name="ln654">	font.SetSize(atoi(size));</a>
<a name="ln655"> </a>
<a name="ln656">	// mark the font size menu item</a>
<a name="ln657">	for (int32 i = 0; i &lt; fFontSizeMenu-&gt;CountItems(); i++) {</a>
<a name="ln658">		BMenuItem* item = fFontSizeMenu-&gt;ItemAt(i);</a>
<a name="ln659">		if (item == NULL)</a>
<a name="ln660">			continue;</a>
<a name="ln661"> </a>
<a name="ln662">		item-&gt;SetMarked(false);</a>
<a name="ln663">		if (strcmp(item-&gt;Label(), size) == 0)</a>
<a name="ln664">			item-&gt;SetMarked(true);</a>
<a name="ln665">	}</a>
<a name="ln666">}</a>
<a name="ln667"> </a>
<a name="ln668"> </a>
<a name="ln669">void</a>
<a name="ln670">TermWindow::MessageReceived(BMessage *message)</a>
<a name="ln671">{</a>
<a name="ln672">	int32 encodingId;</a>
<a name="ln673">	bool findresult;</a>
<a name="ln674"> </a>
<a name="ln675">	switch (message-&gt;what) {</a>
<a name="ln676">		case B_COPY:</a>
<a name="ln677">			_ActiveTermView()-&gt;Copy(be_clipboard);</a>
<a name="ln678">			break;</a>
<a name="ln679"> </a>
<a name="ln680">		case B_PASTE:</a>
<a name="ln681">			_ActiveTermView()-&gt;Paste(be_clipboard);</a>
<a name="ln682">			break;</a>
<a name="ln683"> </a>
<a name="ln684">#ifdef USE_DEBUG_SNAPSHOTS</a>
<a name="ln685">		case SHORTCUT_DEBUG_SNAPSHOTS:</a>
<a name="ln686">			_ActiveTermView()-&gt;MakeDebugSnapshots();</a>
<a name="ln687">			break;</a>
<a name="ln688"> </a>
<a name="ln689">		case SHORTCUT_DEBUG_CAPTURE:</a>
<a name="ln690">			_ActiveTermView()-&gt;StartStopDebugCapture();</a>
<a name="ln691">			break;</a>
<a name="ln692">#endif</a>
<a name="ln693"> </a>
<a name="ln694">		case B_SELECT_ALL:</a>
<a name="ln695">			_ActiveTermView()-&gt;SelectAll();</a>
<a name="ln696">			break;</a>
<a name="ln697"> </a>
<a name="ln698">		case MENU_CLEAR_ALL:</a>
<a name="ln699">			_ActiveTermView()-&gt;Clear();</a>
<a name="ln700">			break;</a>
<a name="ln701"> </a>
<a name="ln702">		case MENU_SWITCH_TERM:</a>
<a name="ln703">			_SwitchTerminal();</a>
<a name="ln704">			break;</a>
<a name="ln705"> </a>
<a name="ln706">		case MENU_NEW_TERM:</a>
<a name="ln707">		{</a>
<a name="ln708">			// Set our current working directory to that of the active tab, so</a>
<a name="ln709">			// that the new terminal and its shell inherit it.</a>
<a name="ln710">			// Note: That's a bit lame. We should rather fork() and change the</a>
<a name="ln711">			// CWD in the child, but since ATM there aren't any side effects of</a>
<a name="ln712">			// changing our CWD, we save ourselves the trouble.</a>
<a name="ln713">			ActiveProcessInfo activeProcessInfo;</a>
<a name="ln714">			if (_ActiveTermView()-&gt;GetActiveProcessInfo(activeProcessInfo))</a>
<a name="ln715">				chdir(activeProcessInfo.CurrentDirectory());</a>
<a name="ln716"> </a>
<a name="ln717">			app_info info;</a>
<a name="ln718">			be_app-&gt;GetAppInfo(&amp;info);</a>
<a name="ln719"> </a>
<a name="ln720">			// try launching two different ways to work around possible problems</a>
<a name="ln721">			if (be_roster-&gt;Launch(&amp;info.ref) != B_OK)</a>
<a name="ln722">				be_roster-&gt;Launch(TERM_SIGNATURE);</a>
<a name="ln723">			break;</a>
<a name="ln724">		}</a>
<a name="ln725"> </a>
<a name="ln726">		case MENU_PREF_OPEN:</a>
<a name="ln727">			if (!fPrefWindow) {</a>
<a name="ln728">				fPrefWindow = new PrefWindow(this);</a>
<a name="ln729">			} else</a>
<a name="ln730">				fPrefWindow-&gt;Activate();</a>
<a name="ln731">			break;</a>
<a name="ln732"> </a>
<a name="ln733">		case MSG_PREF_CLOSED:</a>
<a name="ln734">			fPrefWindow = NULL;</a>
<a name="ln735">			break;</a>
<a name="ln736"> </a>
<a name="ln737">		case MSG_WINDOW_TITLE_SETTING_CHANGED:</a>
<a name="ln738">		case MSG_TAB_TITLE_SETTING_CHANGED:</a>
<a name="ln739">			_TitleSettingsChanged();</a>
<a name="ln740">			break;</a>
<a name="ln741"> </a>
<a name="ln742">		case MENU_FIND_STRING:</a>
<a name="ln743">			if (fFindPanel == NULL) {</a>
<a name="ln744">				fFindPanel = new FindWindow(this, fFindString, fFindSelection,</a>
<a name="ln745">					fMatchWord, fMatchCase, fForwardSearch);</a>
<a name="ln746"> </a>
<a name="ln747">				fFindPanel-&gt;CenterIn(Frame());</a>
<a name="ln748">				_MoveWindowInScreen(fFindPanel);</a>
<a name="ln749">				fFindPanel-&gt;Show();</a>
<a name="ln750">			} else</a>
<a name="ln751">				fFindPanel-&gt;Activate();</a>
<a name="ln752">			break;</a>
<a name="ln753"> </a>
<a name="ln754">		case MSG_FIND:</a>
<a name="ln755">		{</a>
<a name="ln756">			fFindPanel-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln757">			message-&gt;FindBool(&quot;findselection&quot;, &amp;fFindSelection);</a>
<a name="ln758">			if (!fFindSelection)</a>
<a name="ln759">				message-&gt;FindString(&quot;findstring&quot;, &amp;fFindString);</a>
<a name="ln760">			else</a>
<a name="ln761">				_ActiveTermView()-&gt;GetSelection(fFindString);</a>
<a name="ln762"> </a>
<a name="ln763">			if (fFindString.Length() == 0) {</a>
<a name="ln764">				const char* errorMsg = !fFindSelection</a>
<a name="ln765">					? B_TRANSLATE(&quot;No search string was entered.&quot;)</a>
<a name="ln766">					: B_TRANSLATE(&quot;Nothing is selected.&quot;);</a>
<a name="ln767">				BAlert* alert = new BAlert(B_TRANSLATE(&quot;Find failed&quot;),</a>
<a name="ln768">					errorMsg, B_TRANSLATE(&quot;OK&quot;), NULL, NULL,</a>
<a name="ln769">					B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln770">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln771"> </a>
<a name="ln772">				alert-&gt;Go();</a>
<a name="ln773">				fFindPreviousMenuItem-&gt;SetEnabled(false);</a>
<a name="ln774">				fFindNextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln775">				break;</a>
<a name="ln776">			}</a>
<a name="ln777"> </a>
<a name="ln778">			message-&gt;FindBool(&quot;forwardsearch&quot;, &amp;fForwardSearch);</a>
<a name="ln779">			message-&gt;FindBool(&quot;matchcase&quot;, &amp;fMatchCase);</a>
<a name="ln780">			message-&gt;FindBool(&quot;matchword&quot;, &amp;fMatchWord);</a>
<a name="ln781">			findresult = _ActiveTermView()-&gt;Find(fFindString, fForwardSearch,</a>
<a name="ln782">				fMatchCase, fMatchWord);</a>
<a name="ln783"> </a>
<a name="ln784">			if (!findresult) {</a>
<a name="ln785">				BAlert* alert = new BAlert(B_TRANSLATE(&quot;Find failed&quot;),</a>
<a name="ln786">					B_TRANSLATE(&quot;Text not found.&quot;),</a>
<a name="ln787">					B_TRANSLATE(&quot;OK&quot;), NULL, NULL,</a>
<a name="ln788">					B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln789">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln790">				alert-&gt;Go();</a>
<a name="ln791">				fFindPreviousMenuItem-&gt;SetEnabled(false);</a>
<a name="ln792">				fFindNextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln793">				break;</a>
<a name="ln794">			}</a>
<a name="ln795"> </a>
<a name="ln796">			// Enable the menu items Find Next and Find Previous</a>
<a name="ln797">			fFindPreviousMenuItem-&gt;SetEnabled(true);</a>
<a name="ln798">			fFindNextMenuItem-&gt;SetEnabled(true);</a>
<a name="ln799">			break;</a>
<a name="ln800">		}</a>
<a name="ln801"> </a>
<a name="ln802">		case MENU_FIND_NEXT:</a>
<a name="ln803">		case MENU_FIND_PREVIOUS:</a>
<a name="ln804">			findresult = _ActiveTermView()-&gt;Find(fFindString,</a>
<a name="ln805">				(message-&gt;what == MENU_FIND_NEXT) == fForwardSearch,</a>
<a name="ln806">				fMatchCase, fMatchWord);</a>
<a name="ln807">			if (!findresult) {</a>
<a name="ln808">				BAlert* alert = new BAlert(B_TRANSLATE(&quot;Find failed&quot;),</a>
<a name="ln809">					B_TRANSLATE(&quot;Not found.&quot;), B_TRANSLATE(&quot;OK&quot;),</a>
<a name="ln810">					NULL, NULL, B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln811">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln812">				alert-&gt;Go();</a>
<a name="ln813">			}</a>
<a name="ln814">			break;</a>
<a name="ln815"> </a>
<a name="ln816">		case MSG_FIND_CLOSED:</a>
<a name="ln817">			fFindPanel = NULL;</a>
<a name="ln818">			break;</a>
<a name="ln819"> </a>
<a name="ln820">		case MENU_ENCODING:</a>
<a name="ln821">			if (message-&gt;FindInt32(&quot;op&quot;, &amp;encodingId) == B_OK)</a>
<a name="ln822">				_ActiveTermView()-&gt;SetEncoding(encodingId);</a>
<a name="ln823">			break;</a>
<a name="ln824"> </a>
<a name="ln825">		case MSG_COLS_CHANGED:</a>
<a name="ln826">		{</a>
<a name="ln827">			int32 columns, rows;</a>
<a name="ln828">			if (message-&gt;FindInt32(&quot;columns&quot;, &amp;columns) != B_OK</a>
<a name="ln829">				|| message-&gt;FindInt32(&quot;rows&quot;, &amp;rows) != B_OK) {</a>
<a name="ln830">				break;</a>
<a name="ln831">			}</a>
<a name="ln832"> </a>
<a name="ln833">			for (int32 i = 0; i &lt; fTabView-&gt;CountTabs(); i++) {</a>
<a name="ln834">				TermView* view = _TermViewAt(i);</a>
<a name="ln835">				view-&gt;SetTermSize(rows, columns, true);</a>
<a name="ln836">				_ResizeView(view);</a>
<a name="ln837">			}</a>
<a name="ln838">			break;</a>
<a name="ln839">		}</a>
<a name="ln840"> </a>
<a name="ln841">		case MSG_BLINK_CURSOR_CHANGED:</a>
<a name="ln842">		{</a>
<a name="ln843">			bool blinkingCursor</a>
<a name="ln844">				= PrefHandler::Default()-&gt;getBool(PREF_BLINK_CURSOR);</a>
<a name="ln845"> </a>
<a name="ln846">			for (int32 i = 0; i &lt; fTabView-&gt;CountTabs(); i++) {</a>
<a name="ln847">				TermView* view = _TermViewAt(i);</a>
<a name="ln848">				view-&gt;SwitchCursorBlinking(blinkingCursor);</a>
<a name="ln849">			}</a>
<a name="ln850">			break;</a>
<a name="ln851">		}</a>
<a name="ln852"> </a>
<a name="ln853">		case MSG_HALF_FONT_CHANGED:</a>
<a name="ln854">		case MSG_FULL_FONT_CHANGED:</a>
<a name="ln855">		case MSG_ALLOW_BOLD_CHANGED:</a>
<a name="ln856">		{</a>
<a name="ln857">			BFont font;</a>
<a name="ln858">			_GetPreferredFont(font);</a>
<a name="ln859">			for (int32 i = 0; i &lt; fTabView-&gt;CountTabs(); i++) {</a>
<a name="ln860">				TermView* view = _TermViewAt(i);</a>
<a name="ln861">				view-&gt;SetTermFont(&amp;font);</a>
<a name="ln862">				_ResizeView(view);</a>
<a name="ln863">			}</a>
<a name="ln864">			break;</a>
<a name="ln865">		}</a>
<a name="ln866"> </a>
<a name="ln867">		case MSG_HALF_SIZE_CHANGED:</a>
<a name="ln868">		case MSG_FULL_SIZE_CHANGED:</a>
<a name="ln869">		{</a>
<a name="ln870">			const char* size = NULL;</a>
<a name="ln871">			if (message-&gt;FindString(&quot;font_size&quot;, &amp;size) != B_OK)</a>
<a name="ln872">				break;</a>
<a name="ln873"> </a>
<a name="ln874">			// mark the font size menu item</a>
<a name="ln875">			for (int32 i = 0; i &lt; fFontSizeMenu-&gt;CountItems(); i++) {</a>
<a name="ln876">				BMenuItem* item = fFontSizeMenu-&gt;ItemAt(i);</a>
<a name="ln877">				if (item == NULL)</a>
<a name="ln878">					continue;</a>
<a name="ln879"> </a>
<a name="ln880">				item-&gt;SetMarked(false);</a>
<a name="ln881">				if (strcmp(item-&gt;Label(), size) == 0)</a>
<a name="ln882">					item-&gt;SetMarked(true);</a>
<a name="ln883">			}</a>
<a name="ln884"> </a>
<a name="ln885">			BFont font;</a>
<a name="ln886">			_ActiveTermView()-&gt;GetTermFont(&amp;font);</a>
<a name="ln887">			font.SetSize(atoi(size));</a>
<a name="ln888">			PrefHandler::Default()-&gt;setInt32(PREF_HALF_FONT_SIZE,</a>
<a name="ln889">				(int32)atoi(size));</a>
<a name="ln890">			for (int32 i = 0; i &lt; fTabView-&gt;CountTabs(); i++) {</a>
<a name="ln891">				TermView* view = _TermViewAt(i);</a>
<a name="ln892">				_TermViewAt(i)-&gt;SetTermFont(&amp;font);</a>
<a name="ln893">				_ResizeView(view);</a>
<a name="ln894">			}</a>
<a name="ln895">			break;</a>
<a name="ln896">		}</a>
<a name="ln897"> </a>
<a name="ln898">		case FULLSCREEN:</a>
<a name="ln899">			if (!fSavedFrame.IsValid()) { // go fullscreen</a>
<a name="ln900">				_ActiveTermView()-&gt;DisableResizeView();</a>
<a name="ln901">				float mbHeight = fMenuBar-&gt;Bounds().Height() + 1;</a>
<a name="ln902">				fSavedFrame = Frame();</a>
<a name="ln903">				BScreen screen(this);</a>
<a name="ln904"> </a>
<a name="ln905">				for (int32 i = fTabView-&gt;CountTabs() - 1; i &gt;= 0 ; i--)</a>
<a name="ln906">					_TermViewAt(i)-&gt;ScrollBar()-&gt;ResizeBy(0,</a>
<a name="ln907">						(B_H_SCROLL_BAR_HEIGHT - 1));</a>
<a name="ln908"> </a>
<a name="ln909">				fMenuBar-&gt;Hide();</a>
<a name="ln910">				fTabView-&gt;ResizeBy(0, mbHeight);</a>
<a name="ln911">				fTabView-&gt;MoveBy(0, -mbHeight);</a>
<a name="ln912">				fSavedLook = Look();</a>
<a name="ln913">				// done before ResizeTo to work around a Dano bug</a>
<a name="ln914">				// (not erasing the decor)</a>
<a name="ln915">				SetLook(B_NO_BORDER_WINDOW_LOOK);</a>
<a name="ln916">				ResizeTo(screen.Frame().Width() + 1, screen.Frame().Height() + 1);</a>
<a name="ln917">				MoveTo(screen.Frame().left, screen.Frame().top);</a>
<a name="ln918">				SetFlags(Flags() | (B_NOT_RESIZABLE | B_NOT_MOVABLE));</a>
<a name="ln919">				fFullScreen = true;</a>
<a name="ln920">			} else { // exit fullscreen</a>
<a name="ln921">				_ActiveTermView()-&gt;DisableResizeView();</a>
<a name="ln922">				float mbHeight = fMenuBar-&gt;Bounds().Height() + 1;</a>
<a name="ln923">				fMenuBar-&gt;Show();</a>
<a name="ln924"> </a>
<a name="ln925">				for (int32 i = fTabView-&gt;CountTabs() - 1; i &gt;= 0 ; i--)</a>
<a name="ln926">					_TermViewAt(i)-&gt;ScrollBar()-&gt;ResizeBy(0,</a>
<a name="ln927">						-(B_H_SCROLL_BAR_HEIGHT - 1));</a>
<a name="ln928"> </a>
<a name="ln929">				ResizeTo(fSavedFrame.Width(), fSavedFrame.Height());</a>
<a name="ln930">				MoveTo(fSavedFrame.left, fSavedFrame.top);</a>
<a name="ln931">				fTabView-&gt;ResizeBy(0, -mbHeight);</a>
<a name="ln932">				fTabView-&gt;MoveBy(0, mbHeight);</a>
<a name="ln933">				SetLook(fSavedLook);</a>
<a name="ln934">				fSavedFrame = BRect(0, 0, -1, -1);</a>
<a name="ln935">				SetFlags(Flags() &amp; ~(B_NOT_RESIZABLE | B_NOT_MOVABLE));</a>
<a name="ln936">				fFullScreen = false;</a>
<a name="ln937">			}</a>
<a name="ln938">			break;</a>
<a name="ln939"> </a>
<a name="ln940">		case MSG_FONT_CHANGED:</a>
<a name="ln941">			PostMessage(MSG_HALF_FONT_CHANGED);</a>
<a name="ln942">			break;</a>
<a name="ln943"> </a>
<a name="ln944">		case MSG_COLOR_CHANGED:</a>
<a name="ln945">		case MSG_COLOR_SCHEME_CHANGED:</a>
<a name="ln946">		{</a>
<a name="ln947">			_SetTermColors(_ActiveTermViewContainerView());</a>
<a name="ln948">			_ActiveTermViewContainerView()-&gt;Invalidate();</a>
<a name="ln949">			_ActiveTermView()-&gt;Invalidate();</a>
<a name="ln950">			break;</a>
<a name="ln951">		}</a>
<a name="ln952">		case MSG_SAVE_AS_DEFAULT:</a>
<a name="ln953">		{</a>
<a name="ln954">			BPath path;</a>
<a name="ln955">			if (PrefHandler::GetDefaultPath(path) == B_OK) {</a>
<a name="ln956">				PrefHandler::Default()-&gt;SaveAsText(path.Path(),</a>
<a name="ln957">					PREFFILE_MIMETYPE);</a>
<a name="ln958">			}</a>
<a name="ln959">			break;</a>
<a name="ln960">		}</a>
<a name="ln961"> </a>
<a name="ln962">		case MENU_PAGE_SETUP:</a>
<a name="ln963">			_DoPageSetup();</a>
<a name="ln964">			break;</a>
<a name="ln965"> </a>
<a name="ln966">		case MENU_PRINT:</a>
<a name="ln967">			_DoPrint();</a>
<a name="ln968">			break;</a>
<a name="ln969"> </a>
<a name="ln970">		case MSG_CHECK_CHILDREN:</a>
<a name="ln971">			_CheckChildren();</a>
<a name="ln972">			break;</a>
<a name="ln973"> </a>
<a name="ln974">		case MSG_MOVE_TAB_LEFT:</a>
<a name="ln975">		case MSG_MOVE_TAB_RIGHT:</a>
<a name="ln976">			_NavigateTab(_IndexOfTermView(_ActiveTermView()),</a>
<a name="ln977">				message-&gt;what == MSG_MOVE_TAB_LEFT ? -1 : 1, true);</a>
<a name="ln978">			break;</a>
<a name="ln979"> </a>
<a name="ln980">		case kTabTitleChanged:</a>
<a name="ln981">		{</a>
<a name="ln982">			// tab title changed message from SetTitleDialog</a>
<a name="ln983">			SessionID sessionID(*message, &quot;session&quot;);</a>
<a name="ln984">			if (Session* session = _SessionForID(sessionID)) {</a>
<a name="ln985">				BString title;</a>
<a name="ln986">				if (message-&gt;FindString(&quot;title&quot;, &amp;title) == B_OK) {</a>
<a name="ln987">					session-&gt;title.pattern = title;</a>
<a name="ln988">					session-&gt;title.patternUserDefined = true;</a>
<a name="ln989">				} else {</a>
<a name="ln990">					session-&gt;title.pattern.Truncate(0);</a>
<a name="ln991">					session-&gt;title.patternUserDefined = false;</a>
<a name="ln992">				}</a>
<a name="ln993">				_UpdateSessionTitle(_IndexOfSession(session));</a>
<a name="ln994">			}</a>
<a name="ln995">			break;</a>
<a name="ln996">		}</a>
<a name="ln997"> </a>
<a name="ln998">		case kWindowTitleChanged:</a>
<a name="ln999">		{</a>
<a name="ln1000">			// window title changed message from SetTitleDialog</a>
<a name="ln1001">			BString title;</a>
<a name="ln1002">			if (message-&gt;FindString(&quot;title&quot;, &amp;title) == B_OK) {</a>
<a name="ln1003">				fTitle.pattern = title;</a>
<a name="ln1004">				fTitle.patternUserDefined = true;</a>
<a name="ln1005">			} else {</a>
<a name="ln1006">				fTitle.pattern</a>
<a name="ln1007">					= PrefHandler::Default()-&gt;getString(PREF_WINDOW_TITLE);</a>
<a name="ln1008">				fTitle.patternUserDefined = false;</a>
<a name="ln1009">			}</a>
<a name="ln1010"> </a>
<a name="ln1011">			_UpdateSessionTitle(fTabView-&gt;Selection());</a>
<a name="ln1012">				// updates the window title as a side effect</a>
<a name="ln1013"> </a>
<a name="ln1014">			break;</a>
<a name="ln1015">		}</a>
<a name="ln1016"> </a>
<a name="ln1017">		case kSetActiveTab:</a>
<a name="ln1018">		{</a>
<a name="ln1019">			int32 index;</a>
<a name="ln1020">			if (message-&gt;FindInt32(&quot;index&quot;, &amp;index) == B_OK</a>
<a name="ln1021">					&amp;&amp; index &gt;= 0 &amp;&amp; index &lt; fSessions.CountItems()) {</a>
<a name="ln1022">				fTabView-&gt;Select(index);</a>
<a name="ln1023">			}</a>
<a name="ln1024">			break;</a>
<a name="ln1025">		}</a>
<a name="ln1026"> </a>
<a name="ln1027">		case kNewTab:</a>
<a name="ln1028">			_NewTab();</a>
<a name="ln1029">			break;</a>
<a name="ln1030"> </a>
<a name="ln1031">		case kCloseView:</a>
<a name="ln1032">		{</a>
<a name="ln1033">			int32 index = -1;</a>
<a name="ln1034">			SessionID sessionID(*message, &quot;session&quot;);</a>
<a name="ln1035">			if (sessionID.IsValid()) {</a>
<a name="ln1036">				if (Session* session = _SessionForID(sessionID))</a>
<a name="ln1037">					index = _IndexOfSession(session);</a>
<a name="ln1038">			} else</a>
<a name="ln1039">				index = _IndexOfTermView(_ActiveTermView());</a>
<a name="ln1040"> </a>
<a name="ln1041">			if (index &gt;= 0)</a>
<a name="ln1042">				_RemoveTab(index);</a>
<a name="ln1043"> </a>
<a name="ln1044">			break;</a>
<a name="ln1045">		}</a>
<a name="ln1046"> </a>
<a name="ln1047">		case kCloseOtherViews:</a>
<a name="ln1048">		{</a>
<a name="ln1049">			Session* session = _SessionForID(SessionID(*message, &quot;session&quot;));</a>
<a name="ln1050">			if (session == NULL)</a>
<a name="ln1051">				break;</a>
<a name="ln1052"> </a>
<a name="ln1053">			int32 count = fSessions.CountItems();</a>
<a name="ln1054">			for (int32 i = count - 1; i &gt;= 0; i--) {</a>
<a name="ln1055">				if (_SessionAt(i) != session)</a>
<a name="ln1056">					_RemoveTab(i);</a>
<a name="ln1057">			}</a>
<a name="ln1058"> </a>
<a name="ln1059">			break;</a>
<a name="ln1060">		}</a>
<a name="ln1061"> </a>
<a name="ln1062">		case kIncreaseFontSize:</a>
<a name="ln1063">		case kDecreaseFontSize:</a>
<a name="ln1064">		{</a>
<a name="ln1065">			BFont font;</a>
<a name="ln1066">			_ActiveTermView()-&gt;GetTermFont(&amp;font);</a>
<a name="ln1067">			float size = font.Size();</a>
<a name="ln1068"> </a>
<a name="ln1069">			if (message-&gt;what == kIncreaseFontSize) {</a>
<a name="ln1070">				if (size &lt; 12)</a>
<a name="ln1071">					size += 1;</a>
<a name="ln1072">				else if (size &lt; 24)</a>
<a name="ln1073">					size += 2;</a>
<a name="ln1074">				else</a>
<a name="ln1075">					size += 4;</a>
<a name="ln1076">			} else {</a>
<a name="ln1077">				if (size &lt;= 12)</a>
<a name="ln1078">					size -= 1;</a>
<a name="ln1079">				else if (size &lt;= 24)</a>
<a name="ln1080">					size -= 2;</a>
<a name="ln1081">				else</a>
<a name="ln1082">					size -= 4;</a>
<a name="ln1083">			}</a>
<a name="ln1084"> </a>
<a name="ln1085">			// constrain the font size</a>
<a name="ln1086">			if (size &lt; kMinimumFontSize)</a>
<a name="ln1087">				size = kMinimumFontSize;</a>
<a name="ln1088">			if (size &gt; kMaximumFontSize)</a>
<a name="ln1089">				size = kMaximumFontSize;</a>
<a name="ln1090"> </a>
<a name="ln1091">			// mark the font size menu item</a>
<a name="ln1092">			for (int32 i = 0; i &lt; fFontSizeMenu-&gt;CountItems(); i++) {</a>
<a name="ln1093">				BMenuItem* item = fFontSizeMenu-&gt;ItemAt(i);</a>
<a name="ln1094">				if (item == NULL)</a>
<a name="ln1095">					continue;</a>
<a name="ln1096"> </a>
<a name="ln1097">				item-&gt;SetMarked(false);</a>
<a name="ln1098">				if (atoi(item-&gt;Label()) == size)</a>
<a name="ln1099">					item-&gt;SetMarked(true);</a>
<a name="ln1100">			}</a>
<a name="ln1101"> </a>
<a name="ln1102">			font.SetSize(size);</a>
<a name="ln1103">			PrefHandler::Default()-&gt;setInt32(PREF_HALF_FONT_SIZE, (int32)size);</a>
<a name="ln1104">			for (int32 i = 0; i &lt; fTabView-&gt;CountTabs(); i++) {</a>
<a name="ln1105">				TermView* view = _TermViewAt(i);</a>
<a name="ln1106">				_TermViewAt(i)-&gt;SetTermFont(&amp;font);</a>
<a name="ln1107">				_ResizeView(view);</a>
<a name="ln1108">			}</a>
<a name="ln1109">			break;</a>
<a name="ln1110">		}</a>
<a name="ln1111"> </a>
<a name="ln1112">		case kUpdateTitles:</a>
<a name="ln1113">			_UpdateTitles();</a>
<a name="ln1114">			break;</a>
<a name="ln1115"> </a>
<a name="ln1116">		case kEditTabTitle:</a>
<a name="ln1117">		{</a>
<a name="ln1118">			SessionID sessionID(*message, &quot;session&quot;);</a>
<a name="ln1119">			if (Session* session = _SessionForID(sessionID))</a>
<a name="ln1120">				_OpenSetTabTitleDialog(_IndexOfSession(session));</a>
<a name="ln1121">			break;</a>
<a name="ln1122">		}</a>
<a name="ln1123"> </a>
<a name="ln1124">		case kEditWindowTitle:</a>
<a name="ln1125">			_OpenSetWindowTitleDialog();</a>
<a name="ln1126">			break;</a>
<a name="ln1127"> </a>
<a name="ln1128">		case kUpdateSwitchTerminalsMenuItem:</a>
<a name="ln1129">			_UpdateSwitchTerminalsMenuItem();</a>
<a name="ln1130">			break;</a>
<a name="ln1131"> </a>
<a name="ln1132">		default:</a>
<a name="ln1133">			BWindow::MessageReceived(message);</a>
<a name="ln1134">			break;</a>
<a name="ln1135">	}</a>
<a name="ln1136">}</a>
<a name="ln1137"> </a>
<a name="ln1138"> </a>
<a name="ln1139">void</a>
<a name="ln1140">TermWindow::WindowActivated(bool activated)</a>
<a name="ln1141">{</a>
<a name="ln1142">	if (activated)</a>
<a name="ln1143">		_UpdateSwitchTerminalsMenuItem();</a>
<a name="ln1144">}</a>
<a name="ln1145"> </a>
<a name="ln1146"> </a>
<a name="ln1147">void</a>
<a name="ln1148">TermWindow::_SetTermColors(TermViewContainerView* containerView)</a>
<a name="ln1149">{</a>
<a name="ln1150">	PrefHandler* handler = PrefHandler::Default();</a>
<a name="ln1151">	rgb_color background = handler-&gt;getRGB(PREF_TEXT_BACK_COLOR);</a>
<a name="ln1152"> </a>
<a name="ln1153">	containerView-&gt;SetViewColor(background);</a>
<a name="ln1154"> </a>
<a name="ln1155">	TermView *termView = containerView-&gt;GetTermView();</a>
<a name="ln1156">	termView-&gt;SetTextColor(handler-&gt;getRGB(PREF_TEXT_FORE_COLOR), background);</a>
<a name="ln1157"> </a>
<a name="ln1158">	termView-&gt;SetCursorColor(handler-&gt;getRGB(PREF_CURSOR_FORE_COLOR),</a>
<a name="ln1159">		handler-&gt;getRGB(PREF_CURSOR_BACK_COLOR));</a>
<a name="ln1160">	termView-&gt;SetSelectColor(handler-&gt;getRGB(PREF_SELECT_FORE_COLOR),</a>
<a name="ln1161">		handler-&gt;getRGB(PREF_SELECT_BACK_COLOR));</a>
<a name="ln1162">}</a>
<a name="ln1163"> </a>
<a name="ln1164"> </a>
<a name="ln1165">status_t</a>
<a name="ln1166">TermWindow::_DoPageSetup()</a>
<a name="ln1167">{</a>
<a name="ln1168">	BPrintJob job(&quot;PageSetup&quot;);</a>
<a name="ln1169"> </a>
<a name="ln1170">	// display the page configure panel</a>
<a name="ln1171">	status_t status = job.ConfigPage();</a>
<a name="ln1172"> </a>
<a name="ln1173">	// save a pointer to the settings</a>
<a name="ln1174">	fPrintSettings = job.Settings();</a>
<a name="ln1175"> </a>
<a name="ln1176">	return status;</a>
<a name="ln1177">}</a>
<a name="ln1178"> </a>
<a name="ln1179"> </a>
<a name="ln1180">void</a>
<a name="ln1181">TermWindow::_DoPrint()</a>
<a name="ln1182">{</a>
<a name="ln1183">	BPrintJob job(&quot;Print&quot;);</a>
<a name="ln1184">	if (fPrintSettings)</a>
<a name="ln1185">		job.SetSettings(new BMessage(*fPrintSettings));</a>
<a name="ln1186"> </a>
<a name="ln1187">	if (job.ConfigJob() != B_OK)</a>
<a name="ln1188">		return;</a>
<a name="ln1189"> </a>
<a name="ln1190">	BRect pageRect = job.PrintableRect();</a>
<a name="ln1191">	BRect curPageRect = pageRect;</a>
<a name="ln1192"> </a>
<a name="ln1193">	int pHeight = (int)pageRect.Height();</a>
<a name="ln1194">	int pWidth = (int)pageRect.Width();</a>
<a name="ln1195">	float w, h;</a>
<a name="ln1196">	_ActiveTermView()-&gt;GetFrameSize(&amp;w, &amp;h);</a>
<a name="ln1197">	int xPages = (int)ceil(w / pWidth);</a>
<a name="ln1198">	int yPages = (int)ceil(h / pHeight);</a>
<a name="ln1199"> </a>
<a name="ln1200">	job.BeginJob();</a>
<a name="ln1201"> </a>
<a name="ln1202">	// loop through and draw each page, and write to spool</a>
<a name="ln1203">	for (int x = 0; x &lt; xPages; x++) {</a>
<a name="ln1204">		for (int y = 0; y &lt; yPages; y++) {</a>
<a name="ln1205">			curPageRect.OffsetTo(x * pWidth, y * pHeight);</a>
<a name="ln1206">			job.DrawView(_ActiveTermView(), curPageRect, B_ORIGIN);</a>
<a name="ln1207">			job.SpoolPage();</a>
<a name="ln1208"> </a>
<a name="ln1209">			if (!job.CanContinue()) {</a>
<a name="ln1210">				// It is likely that the only way that the job was cancelled is</a>
<a name="ln1211">				// because the user hit 'Cancel' in the page setup window, in</a>
<a name="ln1212">				// which case, the user does *not* need to be told that it was</a>
<a name="ln1213">				// cancelled.</a>
<a name="ln1214">				// He/she will simply expect that it was done.</a>
<a name="ln1215">				return;</a>
<a name="ln1216">			}</a>
<a name="ln1217">		}</a>
<a name="ln1218">	}</a>
<a name="ln1219"> </a>
<a name="ln1220">	job.CommitJob();</a>
<a name="ln1221">}</a>
<a name="ln1222"> </a>
<a name="ln1223"> </a>
<a name="ln1224">void</a>
<a name="ln1225">TermWindow::_NewTab()</a>
<a name="ln1226">{</a>
<a name="ln1227">	ActiveProcessInfo info;</a>
<a name="ln1228">	if (_ActiveTermView()-&gt;GetActiveProcessInfo(info))</a>
<a name="ln1229">		_AddTab(NULL, info.CurrentDirectory());</a>
<a name="ln1230">	else</a>
<a name="ln1231">		_AddTab(NULL);</a>
<a name="ln1232">}</a>
<a name="ln1233"> </a>
<a name="ln1234"> </a>
<a name="ln1235">void</a>
<a name="ln1236">TermWindow::_AddTab(Arguments* args, const BString&amp; currentDirectory)</a>
<a name="ln1237">{</a>
<a name="ln1238">	int argc = 0;</a>
<a name="ln1239">	const char* const* argv = NULL;</a>
<a name="ln1240">	if (args != NULL)</a>
<a name="ln1241">		args-&gt;GetShellArguments(argc, argv);</a>
<a name="ln1242">	ShellParameters shellParameters(argc, argv, currentDirectory);</a>
<a name="ln1243"> </a>
<a name="ln1244">	try {</a>
<a name="ln1245">		TermView* view = new TermView(</a>
<a name="ln1246">			PrefHandler::Default()-&gt;getInt32(PREF_ROWS),</a>
<a name="ln1247">			PrefHandler::Default()-&gt;getInt32(PREF_COLS),</a>
<a name="ln1248">			shellParameters,</a>
<a name="ln1249">			PrefHandler::Default()-&gt;getInt32(PREF_HISTORY_SIZE));</a>
<a name="ln1250">		view-&gt;SetListener(this);</a>
<a name="ln1251"> </a>
<a name="ln1252">		TermViewContainerView* containerView = new TermViewContainerView(view);</a>
<a name="ln1253">		BScrollView* scrollView = new TermScrollView(&quot;scrollView&quot;,</a>
<a name="ln1254">			containerView, view, fSessions.IsEmpty());</a>
<a name="ln1255">		if (!fFullScreen)</a>
<a name="ln1256">			scrollView-&gt;ScrollBar(B_VERTICAL)</a>
<a name="ln1257">				-&gt;ResizeBy(0, -(B_H_SCROLL_BAR_HEIGHT - 1));</a>
<a name="ln1258"> </a>
<a name="ln1259">		if (fSessions.IsEmpty())</a>
<a name="ln1260">			fTabView-&gt;SetScrollView(scrollView);</a>
<a name="ln1261"> </a>
<a name="ln1262">		Session* session = new Session(_NewSessionID(), _NewSessionIndex(),</a>
<a name="ln1263">			containerView);</a>
<a name="ln1264">		fSessions.AddItem(session);</a>
<a name="ln1265"> </a>
<a name="ln1266">		BFont font;</a>
<a name="ln1267">		_GetPreferredFont(font);</a>
<a name="ln1268">		view-&gt;SetTermFont(&amp;font);</a>
<a name="ln1269"> </a>
<a name="ln1270">		float width, height;</a>
<a name="ln1271">		view-&gt;GetFontSize(&amp;width, &amp;height);</a>
<a name="ln1272"> </a>
<a name="ln1273">		float minimumHeight = -1;</a>
<a name="ln1274">		if (fMenuBar != NULL)</a>
<a name="ln1275">			minimumHeight += fMenuBar-&gt;Bounds().Height() + 1;</a>
<a name="ln1276"> </a>
<a name="ln1277">		if (fTabView != NULL &amp;&amp; fTabView-&gt;CountTabs() &gt; 0)</a>
<a name="ln1278">			minimumHeight += fTabView-&gt;TabHeight() + 1;</a>
<a name="ln1279"> </a>
<a name="ln1280">		SetSizeLimits(MIN_COLS * width - 1, MAX_COLS * width - 1,</a>
<a name="ln1281">			minimumHeight + MIN_ROWS * height - 1,</a>
<a name="ln1282">			minimumHeight + MAX_ROWS * height - 1);</a>
<a name="ln1283">			// TODO: The size limit computation is apparently broken, since</a>
<a name="ln1284">			// the terminal can be resized smaller than MIN_ROWS/MIN_COLS!</a>
<a name="ln1285"> </a>
<a name="ln1286">		// If it's the first time we're called, setup the window</a>
<a name="ln1287">		if (fTabView != NULL &amp;&amp; fTabView-&gt;CountTabs() == 0) {</a>
<a name="ln1288">			float viewWidth, viewHeight;</a>
<a name="ln1289">			containerView-&gt;GetPreferredSize(&amp;viewWidth, &amp;viewHeight);</a>
<a name="ln1290"> </a>
<a name="ln1291">			// Resize Window</a>
<a name="ln1292">			ResizeTo(viewWidth + B_V_SCROLL_BAR_WIDTH,</a>
<a name="ln1293">				viewHeight + fMenuBar-&gt;Bounds().Height() + 1);</a>
<a name="ln1294">				// NOTE: Width is one pixel too small, since the scroll view</a>
<a name="ln1295">				// is one pixel wider than its parent.</a>
<a name="ln1296">		}</a>
<a name="ln1297"> </a>
<a name="ln1298">		BTab* tab = new BTab;</a>
<a name="ln1299">		fTabView-&gt;AddTab(scrollView, tab);</a>
<a name="ln1300">		view-&gt;SetScrollBar(scrollView-&gt;ScrollBar(B_VERTICAL));</a>
<a name="ln1301">		view-&gt;SetMouseClipboard(gMouseClipboard);</a>
<a name="ln1302"> </a>
<a name="ln1303">		const BCharacterSet* charset</a>
<a name="ln1304">			= BCharacterSetRoster::FindCharacterSetByName(</a>
<a name="ln1305">				PrefHandler::Default()-&gt;getString(PREF_TEXT_ENCODING));</a>
<a name="ln1306">		if (charset != NULL)</a>
<a name="ln1307">			view-&gt;SetEncoding(charset-&gt;GetConversionID());</a>
<a name="ln1308"> </a>
<a name="ln1309">		_SetTermColors(containerView);</a>
<a name="ln1310"> </a>
<a name="ln1311">		int32 tabIndex = fTabView-&gt;CountTabs() - 1;</a>
<a name="ln1312">		fTabView-&gt;Select(tabIndex);</a>
<a name="ln1313"> </a>
<a name="ln1314">		_UpdateSessionTitle(tabIndex);</a>
<a name="ln1315">	} catch (...) {</a>
<a name="ln1316">		// most probably out of memory. That's bad.</a>
<a name="ln1317">		// TODO: Should cleanup, I guess</a>
<a name="ln1318"> </a>
<a name="ln1319">		// Quit the application if we don't have a shell already</a>
<a name="ln1320">		if (fTabView-&gt;CountTabs() == 0) {</a>
<a name="ln1321">			fprintf(stderr, &quot;Terminal couldn't open a shell\n&quot;);</a>
<a name="ln1322">			PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln1323">		}</a>
<a name="ln1324">	}</a>
<a name="ln1325">}</a>
<a name="ln1326"> </a>
<a name="ln1327"> </a>
<a name="ln1328">void</a>
<a name="ln1329">TermWindow::_RemoveTab(int32 index)</a>
<a name="ln1330">{</a>
<a name="ln1331">	_FinishTitleDialog();</a>
<a name="ln1332">		// always close to avoid confusion</a>
<a name="ln1333"> </a>
<a name="ln1334">	if (fSessions.CountItems() &gt; 1) {</a>
<a name="ln1335">		if (!_CanClose(index))</a>
<a name="ln1336">			return;</a>
<a name="ln1337">		if (Session* session = (Session*)fSessions.RemoveItem(index)) {</a>
<a name="ln1338">			if (fSessions.CountItems() == 1) {</a>
<a name="ln1339">				fTabView-&gt;SetScrollView(dynamic_cast&lt;BScrollView*&gt;(</a>
<a name="ln1340">					_SessionAt(0)-&gt;containerView-&gt;Parent()));</a>
<a name="ln1341">			}</a>
<a name="ln1342"> </a>
<a name="ln1343">			delete session;</a>
<a name="ln1344">			delete fTabView-&gt;RemoveTab(index);</a>
<a name="ln1345">		}</a>
<a name="ln1346">	} else</a>
<a name="ln1347">		PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln1348">}</a>
<a name="ln1349"> </a>
<a name="ln1350"> </a>
<a name="ln1351">void</a>
<a name="ln1352">TermWindow::_NavigateTab(int32 index, int32 direction, bool move)</a>
<a name="ln1353">{</a>
<a name="ln1354">	int32 count = fSessions.CountItems();</a>
<a name="ln1355">	if (count &lt;= 1 || index &lt; 0 || index &gt;= count)</a>
<a name="ln1356">		return;</a>
<a name="ln1357"> </a>
<a name="ln1358">	int32 newIndex = (index + direction + count) % count;</a>
<a name="ln1359">	if (newIndex == index)</a>
<a name="ln1360">		return;</a>
<a name="ln1361"> </a>
<a name="ln1362">	if (move) {</a>
<a name="ln1363">		// move the given tab to the new index</a>
<a name="ln1364">		Session* session = (Session*)fSessions.RemoveItem(index);</a>
<a name="ln1365">		fSessions.AddItem(session, newIndex);</a>
<a name="ln1366">		fTabView-&gt;MoveTab(index, newIndex);</a>
<a name="ln1367">	}</a>
<a name="ln1368"> </a>
<a name="ln1369">	// activate the respective tab</a>
<a name="ln1370">	fTabView-&gt;Select(newIndex);</a>
<a name="ln1371">}</a>
<a name="ln1372"> </a>
<a name="ln1373"> </a>
<a name="ln1374">TermViewContainerView*</a>
<a name="ln1375">TermWindow::_ActiveTermViewContainerView() const</a>
<a name="ln1376">{</a>
<a name="ln1377">	return _TermViewContainerViewAt(fTabView-&gt;Selection());</a>
<a name="ln1378">}</a>
<a name="ln1379"> </a>
<a name="ln1380"> </a>
<a name="ln1381">TermViewContainerView*</a>
<a name="ln1382">TermWindow::_TermViewContainerViewAt(int32 index) const</a>
<a name="ln1383">{</a>
<a name="ln1384">	if (Session* session = _SessionAt(index))</a>
<a name="ln1385">		return session-&gt;containerView;</a>
<a name="ln1386">	return NULL;</a>
<a name="ln1387">}</a>
<a name="ln1388"> </a>
<a name="ln1389"> </a>
<a name="ln1390">TermView*</a>
<a name="ln1391">TermWindow::_ActiveTermView() const</a>
<a name="ln1392">{</a>
<a name="ln1393">	return _ActiveTermViewContainerView()-&gt;GetTermView();</a>
<a name="ln1394">}</a>
<a name="ln1395"> </a>
<a name="ln1396"> </a>
<a name="ln1397">TermView*</a>
<a name="ln1398">TermWindow::_TermViewAt(int32 index) const</a>
<a name="ln1399">{</a>
<a name="ln1400">	TermViewContainerView* view = _TermViewContainerViewAt(index);</a>
<a name="ln1401">	return view != NULL ? view-&gt;GetTermView() : NULL;</a>
<a name="ln1402">}</a>
<a name="ln1403"> </a>
<a name="ln1404"> </a>
<a name="ln1405">int32</a>
<a name="ln1406">TermWindow::_IndexOfTermView(TermView* termView) const</a>
<a name="ln1407">{</a>
<a name="ln1408">	if (!termView)</a>
<a name="ln1409">		return -1;</a>
<a name="ln1410"> </a>
<a name="ln1411">	// find the view</a>
<a name="ln1412">	int32 count = fTabView-&gt;CountTabs();</a>
<a name="ln1413">	for (int32 i = count - 1; i &gt;= 0; i--) {</a>
<a name="ln1414">		if (termView == _TermViewAt(i))</a>
<a name="ln1415">			return i;</a>
<a name="ln1416">	}</a>
<a name="ln1417"> </a>
<a name="ln1418">	return -1;</a>
<a name="ln1419">}</a>
<a name="ln1420"> </a>
<a name="ln1421"> </a>
<a name="ln1422">TermWindow::Session*</a>
<a name="ln1423">TermWindow::_SessionAt(int32 index) const</a>
<a name="ln1424">{</a>
<a name="ln1425">	return (Session*)fSessions.ItemAt(index);</a>
<a name="ln1426">}</a>
<a name="ln1427"> </a>
<a name="ln1428"> </a>
<a name="ln1429">TermWindow::Session*</a>
<a name="ln1430">TermWindow::_SessionForID(const SessionID&amp; sessionID) const</a>
<a name="ln1431">{</a>
<a name="ln1432">	for (int32 i = 0; Session* session = _SessionAt(i); i++) {</a>
<a name="ln1433">		if (session-&gt;id == sessionID)</a>
<a name="ln1434">			return session;</a>
<a name="ln1435">	}</a>
<a name="ln1436"> </a>
<a name="ln1437">	return NULL;</a>
<a name="ln1438">}</a>
<a name="ln1439"> </a>
<a name="ln1440"> </a>
<a name="ln1441">int32</a>
<a name="ln1442">TermWindow::_IndexOfSession(Session* session) const</a>
<a name="ln1443">{</a>
<a name="ln1444">	return fSessions.IndexOf(session);</a>
<a name="ln1445">}</a>
<a name="ln1446"> </a>
<a name="ln1447"> </a>
<a name="ln1448">void</a>
<a name="ln1449">TermWindow::_CheckChildren()</a>
<a name="ln1450">{</a>
<a name="ln1451">	int32 count = fSessions.CountItems();</a>
<a name="ln1452">	for (int32 i = count - 1; i &gt;= 0; i--) {</a>
<a name="ln1453">		Session* session = _SessionAt(i);</a>
<a name="ln1454">		if (session-&gt;containerView-&gt;GetTermView()-&gt;CheckShellGone())</a>
<a name="ln1455">			NotifyTermViewQuit(session-&gt;containerView-&gt;GetTermView(), 0);</a>
<a name="ln1456">	}</a>
<a name="ln1457">}</a>
<a name="ln1458"> </a>
<a name="ln1459"> </a>
<a name="ln1460">void</a>
<a name="ln1461">TermWindow::Zoom(BPoint leftTop, float width, float height)</a>
<a name="ln1462">{</a>
<a name="ln1463">	_ActiveTermView()-&gt;DisableResizeView();</a>
<a name="ln1464">	BWindow::Zoom(leftTop, width, height);</a>
<a name="ln1465">}</a>
<a name="ln1466"> </a>
<a name="ln1467"> </a>
<a name="ln1468">void</a>
<a name="ln1469">TermWindow::FrameResized(float newWidth, float newHeight)</a>
<a name="ln1470">{</a>
<a name="ln1471">	BWindow::FrameResized(newWidth, newHeight);</a>
<a name="ln1472"> </a>
<a name="ln1473">	TermView* view = _ActiveTermView();</a>
<a name="ln1474">	PrefHandler::Default()-&gt;setInt32(PREF_COLS, view-&gt;Columns());</a>
<a name="ln1475">	PrefHandler::Default()-&gt;setInt32(PREF_ROWS, view-&gt;Rows());</a>
<a name="ln1476">}</a>
<a name="ln1477"> </a>
<a name="ln1478"> </a>
<a name="ln1479">void</a>
<a name="ln1480">TermWindow::WorkspacesChanged(uint32 oldWorkspaces, uint32 newWorkspaces)</a>
<a name="ln1481">{</a>
<a name="ln1482">	fTerminalRoster.SetWindowInfo(IsMinimized(), Workspaces());</a>
<a name="ln1483">}</a>
<a name="ln1484"> </a>
<a name="ln1485"> </a>
<a name="ln1486">void</a>
<a name="ln1487">TermWindow::WorkspaceActivated(int32 workspace, bool state)</a>
<a name="ln1488">{</a>
<a name="ln1489">	fTerminalRoster.SetWindowInfo(IsMinimized(), Workspaces());</a>
<a name="ln1490">}</a>
<a name="ln1491"> </a>
<a name="ln1492"> </a>
<a name="ln1493">void</a>
<a name="ln1494">TermWindow::Minimize(bool minimize)</a>
<a name="ln1495">{</a>
<a name="ln1496">	BWindow::Minimize(minimize);</a>
<a name="ln1497">	fTerminalRoster.SetWindowInfo(IsMinimized(), Workspaces());</a>
<a name="ln1498">}</a>
<a name="ln1499"> </a>
<a name="ln1500"> </a>
<a name="ln1501">void</a>
<a name="ln1502">TermWindow::TabSelected(SmartTabView* tabView, int32 index)</a>
<a name="ln1503">{</a>
<a name="ln1504">	SessionChanged();</a>
<a name="ln1505">}</a>
<a name="ln1506"> </a>
<a name="ln1507"> </a>
<a name="ln1508">void</a>
<a name="ln1509">TermWindow::TabDoubleClicked(SmartTabView* tabView, BPoint point, int32 index)</a>
<a name="ln1510">{</a>
<a name="ln1511">	if (index &gt;= 0) {</a>
<a name="ln1512">		// clicked on a tab -- open the title dialog</a>
<a name="ln1513">		_OpenSetTabTitleDialog(index);</a>
<a name="ln1514">	} else {</a>
<a name="ln1515">		// not clicked on a tab -- create a new one</a>
<a name="ln1516">		_NewTab();</a>
<a name="ln1517">	}</a>
<a name="ln1518">}</a>
<a name="ln1519"> </a>
<a name="ln1520"> </a>
<a name="ln1521">void</a>
<a name="ln1522">TermWindow::TabMiddleClicked(SmartTabView* tabView, BPoint point, int32 index)</a>
<a name="ln1523">{</a>
<a name="ln1524">	if (index &gt;= 0)</a>
<a name="ln1525">		_RemoveTab(index);</a>
<a name="ln1526">}</a>
<a name="ln1527"> </a>
<a name="ln1528"> </a>
<a name="ln1529">void</a>
<a name="ln1530">TermWindow::TabRightClicked(SmartTabView* tabView, BPoint point, int32 index)</a>
<a name="ln1531">{</a>
<a name="ln1532">	if (index &lt; 0)</a>
<a name="ln1533">		return;</a>
<a name="ln1534"> </a>
<a name="ln1535">	TermView* termView = _TermViewAt(index);</a>
<a name="ln1536">	if (termView == NULL)</a>
<a name="ln1537">		return;</a>
<a name="ln1538"> </a>
<a name="ln1539">	BMessage* closeMessage = new BMessage(kCloseView);</a>
<a name="ln1540">	_SessionAt(index)-&gt;id.AddToMessage(*closeMessage, &quot;session&quot;);</a>
<a name="ln1541"> </a>
<a name="ln1542">	BMessage* closeOthersMessage = new BMessage(kCloseOtherViews);</a>
<a name="ln1543">	_SessionAt(index)-&gt;id.AddToMessage(*closeOthersMessage, &quot;session&quot;);</a>
<a name="ln1544"> </a>
<a name="ln1545">	BMessage* editTitleMessage = new BMessage(kEditTabTitle);</a>
<a name="ln1546">	_SessionAt(index)-&gt;id.AddToMessage(*editTitleMessage, &quot;session&quot;);</a>
<a name="ln1547"> </a>
<a name="ln1548">	BPopUpMenu* popUpMenu = new BPopUpMenu(&quot;tab menu&quot;);</a>
<a name="ln1549">	BLayoutBuilder::Menu&lt;&gt;(popUpMenu)</a>
<a name="ln1550">		.AddItem(B_TRANSLATE(&quot;Close tab&quot;), closeMessage)</a>
<a name="ln1551">		.AddItem(B_TRANSLATE(&quot;Close other tabs&quot;), closeOthersMessage)</a>
<a name="ln1552">		.AddSeparator()</a>
<a name="ln1553">		.AddItem(B_TRANSLATE(&quot;Edit tab title&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln1554">			editTitleMessage)</a>
<a name="ln1555">	;</a>
<a name="ln1556"> </a>
<a name="ln1557">	popUpMenu-&gt;SetAsyncAutoDestruct(true);</a>
<a name="ln1558">	popUpMenu-&gt;SetTargetForItems(BMessenger(this));</a>
<a name="ln1559"> </a>
<a name="ln1560">	BPoint screenWhere = tabView-&gt;ConvertToScreen(point);</a>
<a name="ln1561">	BRect mouseRect(screenWhere, screenWhere);</a>
<a name="ln1562">	mouseRect.InsetBy(-4.0, -4.0);</a>
<a name="ln1563">	popUpMenu-&gt;Go(screenWhere, true, true, mouseRect, true);</a>
<a name="ln1564">}</a>
<a name="ln1565"> </a>
<a name="ln1566"> </a>
<a name="ln1567">void</a>
<a name="ln1568">TermWindow::NotifyTermViewQuit(TermView* view, int32 reason)</a>
<a name="ln1569">{</a>
<a name="ln1570">	// Since the notification can come from the view, we send a message to</a>
<a name="ln1571">	// ourselves to avoid deleting the caller synchronously.</a>
<a name="ln1572">	if (Session* session = _SessionAt(_IndexOfTermView(view))) {</a>
<a name="ln1573">		BMessage message(kCloseView);</a>
<a name="ln1574">		session-&gt;id.AddToMessage(message, &quot;session&quot;);</a>
<a name="ln1575">		message.AddInt32(&quot;reason&quot;, reason);</a>
<a name="ln1576">		PostMessage(&amp;message);</a>
<a name="ln1577">	}</a>
<a name="ln1578">}</a>
<a name="ln1579"> </a>
<a name="ln1580"> </a>
<a name="ln1581">void</a>
<a name="ln1582">TermWindow::SetTermViewTitle(TermView* view, const char* title)</a>
<a name="ln1583">{</a>
<a name="ln1584">	int32 index = _IndexOfTermView(view);</a>
<a name="ln1585">	if (Session* session = _SessionAt(index)) {</a>
<a name="ln1586">		session-&gt;title.pattern = title;</a>
<a name="ln1587">		session-&gt;title.patternUserDefined = true;</a>
<a name="ln1588">		_UpdateSessionTitle(index);</a>
<a name="ln1589">	}</a>
<a name="ln1590">}</a>
<a name="ln1591"> </a>
<a name="ln1592"> </a>
<a name="ln1593">void</a>
<a name="ln1594">TermWindow::TitleChanged(SetTitleDialog* dialog, const BString&amp; title,</a>
<a name="ln1595">	bool titleUserDefined)</a>
<a name="ln1596">{</a>
<a name="ln1597">	if (dialog == fSetTabTitleDialog) {</a>
<a name="ln1598">		// tab title</a>
<a name="ln1599">		BMessage message(kTabTitleChanged);</a>
<a name="ln1600">		fSetTabTitleSession.AddToMessage(message, &quot;session&quot;);</a>
<a name="ln1601">		if (titleUserDefined)</a>
<a name="ln1602">			message.AddString(&quot;title&quot;, title);</a>
<a name="ln1603"> </a>
<a name="ln1604">		PostMessage(&amp;message);</a>
<a name="ln1605">	} else if (dialog == fSetWindowTitleDialog) {</a>
<a name="ln1606">		// window title</a>
<a name="ln1607">		BMessage message(kWindowTitleChanged);</a>
<a name="ln1608">		if (titleUserDefined)</a>
<a name="ln1609">			message.AddString(&quot;title&quot;, title);</a>
<a name="ln1610"> </a>
<a name="ln1611">		PostMessage(&amp;message);</a>
<a name="ln1612">	}</a>
<a name="ln1613">}</a>
<a name="ln1614"> </a>
<a name="ln1615"> </a>
<a name="ln1616">void</a>
<a name="ln1617">TermWindow::SetTitleDialogDone(SetTitleDialog* dialog)</a>
<a name="ln1618">{</a>
<a name="ln1619">	if (dialog == fSetTabTitleDialog) {</a>
<a name="ln1620">		fSetTabTitleSession = SessionID();</a>
<a name="ln1621">		fSetTabTitleDialog = NULL;</a>
<a name="ln1622">			// assuming this is atomic</a>
<a name="ln1623">	}</a>
<a name="ln1624">}</a>
<a name="ln1625"> </a>
<a name="ln1626"> </a>
<a name="ln1627">void</a>
<a name="ln1628">TermWindow::TerminalInfosUpdated(TerminalRoster* roster)</a>
<a name="ln1629">{</a>
<a name="ln1630">	PostMessage(kUpdateSwitchTerminalsMenuItem);</a>
<a name="ln1631">}</a>
<a name="ln1632"> </a>
<a name="ln1633"> </a>
<a name="ln1634">void</a>
<a name="ln1635">TermWindow::PreviousTermView(TermView* view)</a>
<a name="ln1636">{</a>
<a name="ln1637">	_NavigateTab(_IndexOfTermView(view), -1, false);</a>
<a name="ln1638">}</a>
<a name="ln1639"> </a>
<a name="ln1640"> </a>
<a name="ln1641">void</a>
<a name="ln1642">TermWindow::NextTermView(TermView* view)</a>
<a name="ln1643">{</a>
<a name="ln1644">	_NavigateTab(_IndexOfTermView(view), 1, false);</a>
<a name="ln1645">}</a>
<a name="ln1646"> </a>
<a name="ln1647"> </a>
<a name="ln1648">void</a>
<a name="ln1649">TermWindow::_ResizeView(TermView *view)</a>
<a name="ln1650">{</a>
<a name="ln1651">	float fontWidth, fontHeight;</a>
<a name="ln1652">	view-&gt;GetFontSize(&amp;fontWidth, &amp;fontHeight);</a>
<a name="ln1653"> </a>
<a name="ln1654">	float minimumHeight = -1;</a>
<a name="ln1655">	if (fMenuBar != NULL)</a>
<a name="ln1656">		minimumHeight += fMenuBar-&gt;Bounds().Height() + 1;</a>
<a name="ln1657"> </a>
<a name="ln1658">	if (fTabView != NULL &amp;&amp; fTabView-&gt;CountTabs() &gt; 1)</a>
<a name="ln1659">		minimumHeight += fTabView-&gt;TabHeight() + 1;</a>
<a name="ln1660"> </a>
<a name="ln1661">	SetSizeLimits(MIN_COLS * fontWidth - 1, MAX_COLS * fontWidth - 1,</a>
<a name="ln1662">		minimumHeight + MIN_ROWS * fontHeight - 1,</a>
<a name="ln1663">		minimumHeight + MAX_ROWS * fontHeight - 1);</a>
<a name="ln1664"> </a>
<a name="ln1665">	float width;</a>
<a name="ln1666">	float height;</a>
<a name="ln1667">	view-&gt;Parent()-&gt;GetPreferredSize(&amp;width, &amp;height);</a>
<a name="ln1668"> </a>
<a name="ln1669">	width += B_V_SCROLL_BAR_WIDTH;</a>
<a name="ln1670">		// NOTE: Width is one pixel too small, since the scroll view</a>
<a name="ln1671">		// is one pixel wider than its parent.</a>
<a name="ln1672">	if (fMenuBar != NULL)</a>
<a name="ln1673">		height += fMenuBar-&gt;Bounds().Height() + 1;</a>
<a name="ln1674">	if (fTabView != NULL &amp;&amp; fTabView-&gt;CountTabs() &gt; 1)</a>
<a name="ln1675">		height += fTabView-&gt;TabHeight() + 1;</a>
<a name="ln1676"> </a>
<a name="ln1677">	ResizeTo(width, height);</a>
<a name="ln1678">	view-&gt;Invalidate();</a>
<a name="ln1679">}</a>
<a name="ln1680"> </a>
<a name="ln1681"> </a>
<a name="ln1682">/* static */ void</a>
<a name="ln1683">TermWindow::MakeWindowSizeMenu(BMenu* menu)</a>
<a name="ln1684">{</a>
<a name="ln1685">	const int32 windowSizes[4][2] = {</a>
<a name="ln1686">		{ 80, 25 },</a>
<a name="ln1687">		{ 80, 40 },</a>
<a name="ln1688">		{ 132, 25 },</a>
<a name="ln1689">		{ 132, 40 }</a>
<a name="ln1690">	};</a>
<a name="ln1691"> </a>
<a name="ln1692">	const int32 sizeNum = sizeof(windowSizes) / sizeof(windowSizes[0]);</a>
<a name="ln1693">	for (int32 i = 0; i &lt; sizeNum; i++) {</a>
<a name="ln1694">		char label[32];</a>
<a name="ln1695">		int32 columns = windowSizes[i][0];</a>
<a name="ln1696">		int32 rows = windowSizes[i][1];</a>
<a name="ln1697">		snprintf(label, sizeof(label), &quot;%&quot; B_PRId32 &quot;x%&quot; B_PRId32, columns,</a>
<a name="ln1698">			rows);</a>
<a name="ln1699">		BMessage* message = new BMessage(MSG_COLS_CHANGED);</a>
<a name="ln1700">		message-&gt;AddInt32(&quot;columns&quot;, columns);</a>
<a name="ln1701">		message-&gt;AddInt32(&quot;rows&quot;, rows);</a>
<a name="ln1702">		menu-&gt;AddItem(new BMenuItem(label, message));</a>
<a name="ln1703">	}</a>
<a name="ln1704">}</a>
<a name="ln1705"> </a>
<a name="ln1706"> </a>
<a name="ln1707">/*static*/ BMenu*</a>
<a name="ln1708">TermWindow::_MakeFontSizeMenu(uint32 command, uint8 defaultSize)</a>
<a name="ln1709">{</a>
<a name="ln1710">	BMenu* menu = new (std::nothrow) BMenu(B_TRANSLATE(&quot;Font size&quot;));</a>
<a name="ln1711">	if (menu == NULL)</a>
<a name="ln1712">		return NULL;</a>
<a name="ln1713"> </a>
<a name="ln1714">	int32 sizes[] = {</a>
<a name="ln1715">		8, 9, 10, 11, 12, 14, 16, 18, 20, 22, 24, 28, 32, 36, 0</a>
<a name="ln1716">	};</a>
<a name="ln1717"> </a>
<a name="ln1718">	bool found = false;</a>
<a name="ln1719"> </a>
<a name="ln1720">	for (uint32 i = 0; sizes[i]; i++) {</a>
<a name="ln1721">		BString string;</a>
<a name="ln1722">		string &lt;&lt; sizes[i];</a>
<a name="ln1723">		BMessage* message = new BMessage(command);</a>
<a name="ln1724">		message-&gt;AddString(&quot;font_size&quot;, string);</a>
<a name="ln1725">		BMenuItem* item = new BMenuItem(string.String(), message);</a>
<a name="ln1726">		menu-&gt;AddItem(item);</a>
<a name="ln1727">		if (sizes[i] == defaultSize) {</a>
<a name="ln1728">			item-&gt;SetMarked(true);</a>
<a name="ln1729">			found = true;</a>
<a name="ln1730">		}</a>
<a name="ln1731">	}</a>
<a name="ln1732"> </a>
<a name="ln1733">	if (!found) {</a>
<a name="ln1734">		for (uint32 i = 0; sizes[i]; i++) {</a>
<a name="ln1735">			if (sizes[i] &gt; defaultSize) {</a>
<a name="ln1736">				BString string;</a>
<a name="ln1737">				string &lt;&lt; defaultSize;</a>
<a name="ln1738">				BMessage* message = new BMessage(command);</a>
<a name="ln1739">				message-&gt;AddString(&quot;font_size&quot;, string);</a>
<a name="ln1740">				BMenuItem* item = new BMenuItem(string.String(), message);</a>
<a name="ln1741">				item-&gt;SetMarked(true);</a>
<a name="ln1742">				menu-&gt;AddItem(item, i);</a>
<a name="ln1743">				break;</a>
<a name="ln1744">			}</a>
<a name="ln1745">		}</a>
<a name="ln1746">	}</a>
<a name="ln1747"> </a>
<a name="ln1748">	return menu;</a>
<a name="ln1749">}</a>
<a name="ln1750"> </a>
<a name="ln1751"> </a>
<a name="ln1752">void</a>
<a name="ln1753">TermWindow::_UpdateSwitchTerminalsMenuItem()</a>
<a name="ln1754">{</a>
<a name="ln1755">	fSwitchTerminalsMenuItem-&gt;SetEnabled(_FindSwitchTerminalTarget() &gt;= 0);</a>
<a name="ln1756">}</a>
<a name="ln1757"> </a>
<a name="ln1758"> </a>
<a name="ln1759">void</a>
<a name="ln1760">TermWindow::_TitleSettingsChanged()</a>
<a name="ln1761">{</a>
<a name="ln1762">	if (!fTitle.patternUserDefined)</a>
<a name="ln1763">		fTitle.pattern = PrefHandler::Default()-&gt;getString(PREF_WINDOW_TITLE);</a>
<a name="ln1764"> </a>
<a name="ln1765">	fSessionTitlePattern = PrefHandler::Default()-&gt;getString(PREF_TAB_TITLE);</a>
<a name="ln1766"> </a>
<a name="ln1767">	_UpdateTitles();</a>
<a name="ln1768">}</a>
<a name="ln1769"> </a>
<a name="ln1770"> </a>
<a name="ln1771">void</a>
<a name="ln1772">TermWindow::_UpdateTitles()</a>
<a name="ln1773">{</a>
<a name="ln1774">	int32 sessionCount = fSessions.CountItems();</a>
<a name="ln1775">	for (int32 i = 0; i &lt; sessionCount; i++)</a>
<a name="ln1776">		_UpdateSessionTitle(i);</a>
<a name="ln1777">}</a>
<a name="ln1778"> </a>
<a name="ln1779"> </a>
<a name="ln1780">void</a>
<a name="ln1781">TermWindow::_UpdateSessionTitle(int32 index)</a>
<a name="ln1782">{</a>
<a name="ln1783">	Session* session = _SessionAt(index);</a>
<a name="ln1784">	if (session == NULL)</a>
<a name="ln1785">		return;</a>
<a name="ln1786"> </a>
<a name="ln1787">	// get the shell and active process infos</a>
<a name="ln1788">	ShellInfo shellInfo;</a>
<a name="ln1789">	ActiveProcessInfo activeProcessInfo;</a>
<a name="ln1790">	TermView* termView = _TermViewAt(index);</a>
<a name="ln1791">	if (!termView-&gt;GetShellInfo(shellInfo)</a>
<a name="ln1792">		|| !termView-&gt;GetActiveProcessInfo(activeProcessInfo)) {</a>
<a name="ln1793">		return;</a>
<a name="ln1794">	}</a>
<a name="ln1795"> </a>
<a name="ln1796">	// evaluate the session title pattern</a>
<a name="ln1797">	BString sessionTitlePattern = session-&gt;title.patternUserDefined</a>
<a name="ln1798">		? session-&gt;title.pattern : fSessionTitlePattern;</a>
<a name="ln1799">	TabTitlePlaceholderMapper tabMapper(shellInfo, activeProcessInfo,</a>
<a name="ln1800">		session-&gt;index);</a>
<a name="ln1801">	const BString&amp; sessionTitle = PatternEvaluator::Evaluate(</a>
<a name="ln1802">		sessionTitlePattern, tabMapper);</a>
<a name="ln1803"> </a>
<a name="ln1804">	// set the tab title</a>
<a name="ln1805">	if (sessionTitle != session-&gt;title.title) {</a>
<a name="ln1806">		session-&gt;title.title = sessionTitle;</a>
<a name="ln1807">		fTabView-&gt;TabAt(index)-&gt;SetLabel(session-&gt;title.title);</a>
<a name="ln1808">		fTabView-&gt;Invalidate();</a>
<a name="ln1809">			// Invalidate the complete tab view, since other tabs might change</a>
<a name="ln1810">			// their positions.</a>
<a name="ln1811">	}</a>
<a name="ln1812"> </a>
<a name="ln1813">	// If this is the active tab, also recompute the window title.</a>
<a name="ln1814">	if (index != fTabView-&gt;Selection())</a>
<a name="ln1815">		return;</a>
<a name="ln1816"> </a>
<a name="ln1817">	// evaluate the window title pattern</a>
<a name="ln1818">	WindowTitlePlaceholderMapper windowMapper(shellInfo, activeProcessInfo,</a>
<a name="ln1819">		fTerminalRoster.CountTerminals() &gt; 1</a>
<a name="ln1820">			? fTerminalRoster.ID() + 1 : 0, sessionTitle);</a>
<a name="ln1821">	const BString&amp; windowTitle = PatternEvaluator::Evaluate(fTitle.pattern,</a>
<a name="ln1822">		windowMapper);</a>
<a name="ln1823"> </a>
<a name="ln1824">	// set the window title</a>
<a name="ln1825">	if (windowTitle != fTitle.title) {</a>
<a name="ln1826">		fTitle.title = windowTitle;</a>
<a name="ln1827">		SetTitle(fTitle.title);</a>
<a name="ln1828">	}</a>
<a name="ln1829">}</a>
<a name="ln1830"> </a>
<a name="ln1831"> </a>
<a name="ln1832">void</a>
<a name="ln1833">TermWindow::_OpenSetTabTitleDialog(int32 index)</a>
<a name="ln1834">{</a>
<a name="ln1835">	// If a dialog is active, finish it.</a>
<a name="ln1836">	_FinishTitleDialog();</a>
<a name="ln1837"> </a>
<a name="ln1838">	BString toolTip = BString(B_TRANSLATE(</a>
<a name="ln1839">		&quot;The pattern specifying the current tab title. The following &quot;</a>
<a name="ln1840">			&quot;placeholders\n&quot;</a>
<a name="ln1841">		&quot;can be used:\n&quot;)) &lt;&lt; kTooTipSetTabTitlePlaceholders;</a>
<a name="ln1842">	fSetTabTitleDialog = new SetTitleDialog(</a>
<a name="ln1843">		B_TRANSLATE(&quot;Set tab title&quot;), B_TRANSLATE(&quot;Tab title:&quot;),</a>
<a name="ln1844">		toolTip);</a>
<a name="ln1845"> </a>
<a name="ln1846">	Session* session = _SessionAt(index);</a>
<a name="ln1847">	bool userDefined = session-&gt;title.patternUserDefined;</a>
<a name="ln1848">	const BString&amp; title = userDefined</a>
<a name="ln1849">		? session-&gt;title.pattern : fSessionTitlePattern;</a>
<a name="ln1850">	fSetTabTitleSession = session-&gt;id;</a>
<a name="ln1851"> </a>
<a name="ln1852">	// place the dialog window directly under the tab, but keep it on screen</a>
<a name="ln1853">	BPoint location = fTabView-&gt;ConvertToScreen(</a>
<a name="ln1854">		fTabView-&gt;TabFrame(index).LeftBottom() + BPoint(0, 1));</a>
<a name="ln1855">	fSetTabTitleDialog-&gt;MoveTo(location);</a>
<a name="ln1856">	_MoveWindowInScreen(fSetTabTitleDialog);</a>
<a name="ln1857"> </a>
<a name="ln1858">	fSetTabTitleDialog-&gt;Go(title, userDefined, this);</a>
<a name="ln1859">}</a>
<a name="ln1860"> </a>
<a name="ln1861"> </a>
<a name="ln1862">void</a>
<a name="ln1863">TermWindow::_OpenSetWindowTitleDialog()</a>
<a name="ln1864">{</a>
<a name="ln1865">	// If a dialog is active, finish it.</a>
<a name="ln1866">	_FinishTitleDialog();</a>
<a name="ln1867"> </a>
<a name="ln1868">	BString toolTip = BString(B_TRANSLATE(</a>
<a name="ln1869">		&quot;The pattern specifying the window title. The following placeholders\n&quot;</a>
<a name="ln1870">		&quot;can be used:\n&quot;)) &lt;&lt; kTooTipSetTabTitlePlaceholders;</a>
<a name="ln1871">	fSetWindowTitleDialog = new SetTitleDialog(B_TRANSLATE(&quot;Set window title&quot;),</a>
<a name="ln1872">		B_TRANSLATE(&quot;Window title:&quot;), toolTip);</a>
<a name="ln1873"> </a>
<a name="ln1874">	// center the dialog in the window frame, but keep it on screen</a>
<a name="ln1875">	fSetWindowTitleDialog-&gt;CenterIn(Frame());</a>
<a name="ln1876">	_MoveWindowInScreen(fSetWindowTitleDialog);</a>
<a name="ln1877"> </a>
<a name="ln1878">	fSetWindowTitleDialog-&gt;Go(fTitle.pattern, fTitle.patternUserDefined, this);</a>
<a name="ln1879">}</a>
<a name="ln1880"> </a>
<a name="ln1881"> </a>
<a name="ln1882">void</a>
<a name="ln1883">TermWindow::_FinishTitleDialog()</a>
<a name="ln1884">{</a>
<a name="ln1885">	SetTitleDialog* oldDialog = fSetTabTitleDialog;</a>
<a name="ln1886">	if (oldDialog != NULL &amp;&amp; oldDialog-&gt;Lock()) {</a>
<a name="ln1887">		// might have been unset in the meantime, so recheck</a>
<a name="ln1888">		if (fSetTabTitleDialog == oldDialog) {</a>
<a name="ln1889">			oldDialog-&gt;Finish();</a>
<a name="ln1890">				// this also unsets the variables</a>
<a name="ln1891">		}</a>
<a name="ln1892">		oldDialog-&gt;Unlock();</a>
<a name="ln1893">		return;</a>
<a name="ln1894">	}</a>
<a name="ln1895"> </a>
<a name="ln1896">	oldDialog = fSetWindowTitleDialog;</a>
<a name="ln1897">	if (oldDialog != NULL &amp;&amp; oldDialog-&gt;Lock()) {</a>
<a name="ln1898">		// might have been unset in the meantime, so recheck</a>
<a name="ln1899">		if (fSetWindowTitleDialog == oldDialog) {</a>
<a name="ln1900">			oldDialog-&gt;Finish();</a>
<a name="ln1901">				// this also unsets the variable</a>
<a name="ln1902">		}</a>
<a name="ln1903">		oldDialog-&gt;Unlock();</a>
<a name="ln1904">		return;</a>
<a name="ln1905">	}</a>
<a name="ln1906">}</a>
<a name="ln1907"> </a>
<a name="ln1908"> </a>
<a name="ln1909">void</a>
<a name="ln1910">TermWindow::_SwitchTerminal()</a>
<a name="ln1911">{</a>
<a name="ln1912">	team_id teamID = _FindSwitchTerminalTarget();</a>
<a name="ln1913">	if (teamID &lt; 0)</a>
<a name="ln1914">		return;</a>
<a name="ln1915"> </a>
<a name="ln1916">	BMessenger app(TERM_SIGNATURE, teamID);</a>
<a name="ln1917">	app.SendMessage(MSG_ACTIVATE_TERM);</a>
<a name="ln1918">}</a>
<a name="ln1919"> </a>
<a name="ln1920"> </a>
<a name="ln1921">team_id</a>
<a name="ln1922">TermWindow::_FindSwitchTerminalTarget()</a>
<a name="ln1923">{</a>
<a name="ln1924">	AutoLocker&lt;TerminalRoster&gt; rosterLocker(fTerminalRoster);</a>
<a name="ln1925"> </a>
<a name="ln1926">	team_id myTeamID = Team();</a>
<a name="ln1927"> </a>
<a name="ln1928">	int32 numTerms = fTerminalRoster.CountTerminals();</a>
<a name="ln1929">	if (numTerms &lt;= 1)</a>
<a name="ln1930">		return -1;</a>
<a name="ln1931"> </a>
<a name="ln1932">	// Find our position in the Terminal teams.</a>
<a name="ln1933">	int32 i;</a>
<a name="ln1934"> </a>
<a name="ln1935">	for (i = 0; i &lt; numTerms; i++) {</a>
<a name="ln1936">		if (myTeamID == fTerminalRoster.TerminalAt(i)-&gt;team)</a>
<a name="ln1937">			break;</a>
<a name="ln1938">	}</a>
<a name="ln1939"> </a>
<a name="ln1940">	if (i == numTerms) {</a>
<a name="ln1941">		// we didn't find ourselves -- that shouldn't happen</a>
<a name="ln1942">		return -1;</a>
<a name="ln1943">	}</a>
<a name="ln1944"> </a>
<a name="ln1945">	uint32 currentWorkspace = 1L &lt;&lt; current_workspace();</a>
<a name="ln1946"> </a>
<a name="ln1947">	while (true) {</a>
<a name="ln1948">		if (--i &lt; 0)</a>
<a name="ln1949">			i = numTerms - 1;</a>
<a name="ln1950"> </a>
<a name="ln1951">		const TerminalRoster::Info* info = fTerminalRoster.TerminalAt(i);</a>
<a name="ln1952">		if (info-&gt;team == myTeamID) {</a>
<a name="ln1953">			// That's ourselves again. We've run through the complete list.</a>
<a name="ln1954">			return -1;</a>
<a name="ln1955">		}</a>
<a name="ln1956"> </a>
<a name="ln1957">		if (!info-&gt;minimized &amp;&amp; (info-&gt;workspaces &amp; currentWorkspace) != 0)</a>
<a name="ln1958">			return info-&gt;team;</a>
<a name="ln1959">	}</a>
<a name="ln1960">}</a>
<a name="ln1961"> </a>
<a name="ln1962"> </a>
<a name="ln1963">TermWindow::SessionID</a>
<a name="ln1964">TermWindow::_NewSessionID()</a>
<a name="ln1965">{</a>
<a name="ln1966">	return fNextSessionID++;</a>
<a name="ln1967">}</a>
<a name="ln1968"> </a>
<a name="ln1969"> </a>
<a name="ln1970">int32</a>
<a name="ln1971">TermWindow::_NewSessionIndex()</a>
<a name="ln1972">{</a>
<a name="ln1973">	for (int32 id = 1; ; id++) {</a>
<a name="ln1974">		bool used = false;</a>
<a name="ln1975"> </a>
<a name="ln1976">		for (int32 i = 0;</a>
<a name="ln1977">			Session* session = _SessionAt(i); i++) {</a>
<a name="ln1978">			if (id == session-&gt;index) {</a>
<a name="ln1979">				used = true;</a>
<a name="ln1980">				break;</a>
<a name="ln1981">			}</a>
<a name="ln1982">		}</a>
<a name="ln1983"> </a>
<a name="ln1984">		if (!used)</a>
<a name="ln1985">			return id;</a>
<a name="ln1986">	}</a>
<a name="ln1987">}</a>
<a name="ln1988"> </a>
<a name="ln1989"> </a>
<a name="ln1990">void</a>
<a name="ln1991">TermWindow::_MoveWindowInScreen(BWindow* window)</a>
<a name="ln1992">{</a>
<a name="ln1993">	BRect frame = window-&gt;Frame();</a>
<a name="ln1994">	BSize screenSize(BScreen(window).Frame().Size());</a>
<a name="ln1995">	window-&gt;MoveTo(BLayoutUtils::MoveIntoFrame(frame, screenSize).LeftTop());</a>
<a name="ln1996">}</a>

</code></pre>
<div class="balloon" rel="1260"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'fTabView' pointer was utilized before it was verified against nullptr. Check lines: 1260, 1277.</p></div>
<div class="balloon" rel="813"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
