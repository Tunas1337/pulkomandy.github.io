
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>MainWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2002-2013 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT license.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Ithamar R. Adema &lt;ithamar@unet.nl&gt;</a>
<a name="ln7"> *		Stephan Aßmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln8"> *		Axel Dörfler, axeld@pinc-software.de.</a>
<a name="ln9"> *		Erik Jaesler &lt;ejakowatz@users.sourceforge.net&gt;</a>
<a name="ln10"> *		Ingo Weinhold &lt;ingo_weinhold@gmx.de&gt;</a>
<a name="ln11"> */</a>
<a name="ln12"> </a>
<a name="ln13"> </a>
<a name="ln14">#include &quot;MainWindow.h&quot;</a>
<a name="ln15"> </a>
<a name="ln16">#include &lt;stdio.h&gt;</a>
<a name="ln17">#include &lt;string.h&gt;</a>
<a name="ln18"> </a>
<a name="ln19">#include &lt;Alert.h&gt;</a>
<a name="ln20">#include &lt;Application.h&gt;</a>
<a name="ln21">#include &lt;Catalog.h&gt;</a>
<a name="ln22">#include &lt;ColumnListView.h&gt;</a>
<a name="ln23">#include &lt;ColumnTypes.h&gt;</a>
<a name="ln24">#include &lt;Debug.h&gt;</a>
<a name="ln25">#include &lt;DiskDevice.h&gt;</a>
<a name="ln26">#include &lt;DiskDeviceVisitor.h&gt;</a>
<a name="ln27">#include &lt;DiskDeviceTypes.h&gt;</a>
<a name="ln28">#include &lt;DiskSystem.h&gt;</a>
<a name="ln29">#include &lt;Locale.h&gt;</a>
<a name="ln30">#include &lt;MenuItem.h&gt;</a>
<a name="ln31">#include &lt;MenuBar.h&gt;</a>
<a name="ln32">#include &lt;Menu.h&gt;</a>
<a name="ln33">#include &lt;Path.h&gt;</a>
<a name="ln34">#include &lt;Partition.h&gt;</a>
<a name="ln35">#include &lt;PartitioningInfo.h&gt;</a>
<a name="ln36">#include &lt;Roster.h&gt;</a>
<a name="ln37">#include &lt;Screen.h&gt;</a>
<a name="ln38">#include &lt;ScrollBar.h&gt;</a>
<a name="ln39">#include &lt;Volume.h&gt;</a>
<a name="ln40">#include &lt;VolumeRoster.h&gt;</a>
<a name="ln41"> </a>
<a name="ln42">#include &lt;fs_volume.h&gt;</a>
<a name="ln43">#include &lt;tracker_private.h&gt;</a>
<a name="ln44"> </a>
<a name="ln45">#include &quot;ChangeParametersPanel.h&quot;</a>
<a name="ln46">#include &quot;ColumnListView.h&quot;</a>
<a name="ln47">#include &quot;CreateParametersPanel.h&quot;</a>
<a name="ln48">#include &quot;DiskView.h&quot;</a>
<a name="ln49">#include &quot;InitParametersPanel.h&quot;</a>
<a name="ln50">#include &quot;PartitionList.h&quot;</a>
<a name="ln51">#include &quot;Support.h&quot;</a>
<a name="ln52"> </a>
<a name="ln53"> </a>
<a name="ln54">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln55">#define B_TRANSLATION_CONTEXT &quot;MainWindow&quot;</a>
<a name="ln56"> </a>
<a name="ln57"> </a>
<a name="ln58">enum {</a>
<a name="ln59">	MSG_MOUNT_ALL				= 'mnta',</a>
<a name="ln60">	MSG_MOUNT					= 'mnts',</a>
<a name="ln61">	MSG_UNMOUNT					= 'unmt',</a>
<a name="ln62">	MSG_FORMAT					= 'frmt',</a>
<a name="ln63">	MSG_CREATE					= 'crtp',</a>
<a name="ln64">	MSG_CHANGE					= 'chgp',</a>
<a name="ln65">	MSG_INITIALIZE				= 'init',</a>
<a name="ln66">	MSG_DELETE					= 'delt',</a>
<a name="ln67">	MSG_EJECT					= 'ejct',</a>
<a name="ln68">	MSG_OPEN_DISKPROBE			= 'opdp',</a>
<a name="ln69">	MSG_SURFACE_TEST			= 'sfct',</a>
<a name="ln70">	MSG_RESCAN					= 'rscn',</a>
<a name="ln71"> </a>
<a name="ln72">	MSG_PARTITION_ROW_SELECTED	= 'prsl',</a>
<a name="ln73">};</a>
<a name="ln74"> </a>
<a name="ln75"> </a>
<a name="ln76">class ListPopulatorVisitor : public BDiskDeviceVisitor {</a>
<a name="ln77">public:</a>
<a name="ln78">	ListPopulatorVisitor(PartitionListView* list, int32&amp; diskCount,</a>
<a name="ln79">			SpaceIDMap&amp; spaceIDMap)</a>
<a name="ln80">		:</a>
<a name="ln81">		fPartitionList(list),</a>
<a name="ln82">		fDiskCount(diskCount),</a>
<a name="ln83">		fSpaceIDMap(spaceIDMap)</a>
<a name="ln84">	{</a>
<a name="ln85">		fDiskCount = 0;</a>
<a name="ln86">		fSpaceIDMap.Clear();</a>
<a name="ln87">		// start with an empty list</a>
<a name="ln88">		int32 rows = fPartitionList-&gt;CountRows();</a>
<a name="ln89">		for (int32 i = rows - 1; i &gt;= 0; i--) {</a>
<a name="ln90">			BRow* row = fPartitionList-&gt;RowAt(i);</a>
<a name="ln91">			fPartitionList-&gt;RemoveRow(row);</a>
<a name="ln92">			delete row;</a>
<a name="ln93">		}</a>
<a name="ln94">	}</a>
<a name="ln95"> </a>
<a name="ln96">	virtual bool Visit(BDiskDevice* device)</a>
<a name="ln97">	{</a>
<a name="ln98">		fDiskCount++;</a>
<a name="ln99">		// if we don't prepare the device for modifications,</a>
<a name="ln100">		// we cannot get information about available empty</a>
<a name="ln101">		// regions on the device or child partitions</a>
<a name="ln102">		device-&gt;PrepareModifications();</a>
<a name="ln103">		_AddPartition(device);</a>
<a name="ln104">		return false; // Don't stop yet!</a>
<a name="ln105">	}</a>
<a name="ln106"> </a>
<a name="ln107">	virtual bool Visit(BPartition* partition, int32 level)</a>
<a name="ln108">	{</a>
<a name="ln109">		_AddPartition(partition);</a>
<a name="ln110">		return false; // Don't stop yet!</a>
<a name="ln111">	}</a>
<a name="ln112"> </a>
<a name="ln113">private:</a>
<a name="ln114">	void _AddPartition(BPartition* partition) const</a>
<a name="ln115">	{</a>
<a name="ln116">		// add the partition itself</a>
<a name="ln117">		fPartitionList-&gt;AddPartition(partition);</a>
<a name="ln118"> </a>
<a name="ln119">		// add any available space on it</a>
<a name="ln120">		BPartitioningInfo info;</a>
<a name="ln121">		status_t status = partition-&gt;GetPartitioningInfo(&amp;info);</a>
<a name="ln122">		if (status &gt;= B_OK) {</a>
<a name="ln123">			partition_id parentID = partition-&gt;ID();</a>
<a name="ln124">			off_t offset;</a>
<a name="ln125">			off_t size;</a>
<a name="ln126">			for (int32 i = 0;</a>
<a name="ln127">					info.GetPartitionableSpaceAt(i, &amp;offset, &amp;size) &gt;= B_OK;</a>
<a name="ln128">					i++) {</a>
<a name="ln129">				// TODO: remove again once Disk Device API is fixed</a>
<a name="ln130">				if (!is_valid_partitionable_space(size))</a>
<a name="ln131">					continue;</a>
<a name="ln132">				//</a>
<a name="ln133">				partition_id id = fSpaceIDMap.SpaceIDFor(parentID, offset);</a>
<a name="ln134">				fPartitionList-&gt;AddSpace(parentID, id, offset, size);</a>
<a name="ln135">			}</a>
<a name="ln136">		}</a>
<a name="ln137">	}</a>
<a name="ln138"> </a>
<a name="ln139">	PartitionListView*	fPartitionList;</a>
<a name="ln140">	int32&amp;				fDiskCount;</a>
<a name="ln141">	SpaceIDMap&amp;			fSpaceIDMap;</a>
<a name="ln142">	BDiskDevice*		fLastPreparedDevice;</a>
<a name="ln143">};</a>
<a name="ln144"> </a>
<a name="ln145"> </a>
<a name="ln146">class MountAllVisitor : public BDiskDeviceVisitor {</a>
<a name="ln147">public:</a>
<a name="ln148">	MountAllVisitor()</a>
<a name="ln149">	{</a>
<a name="ln150">	}</a>
<a name="ln151"> </a>
<a name="ln152">	virtual bool Visit(BDiskDevice* device)</a>
<a name="ln153">	{</a>
<a name="ln154">		if (device-&gt;ContainsFileSystem())</a>
<a name="ln155">			device-&gt;Mount();</a>
<a name="ln156"> </a>
<a name="ln157">		return false; // Don't stop yet!</a>
<a name="ln158">	}</a>
<a name="ln159"> </a>
<a name="ln160">	virtual bool Visit(BPartition* partition, int32 level)</a>
<a name="ln161">	{</a>
<a name="ln162">		partition-&gt;Mount();</a>
<a name="ln163">		return false; // Don't stop yet!</a>
<a name="ln164">	}</a>
<a name="ln165"> </a>
<a name="ln166">private:</a>
<a name="ln167">	PartitionListView* fPartitionList;</a>
<a name="ln168">};</a>
<a name="ln169"> </a>
<a name="ln170"> </a>
<a name="ln171">class ModificationPreparer {</a>
<a name="ln172">public:</a>
<a name="ln173">	ModificationPreparer(BDiskDevice* disk)</a>
<a name="ln174">		:</a>
<a name="ln175">		fDisk(disk),</a>
<a name="ln176">		fModificationStatus(fDisk-&gt;PrepareModifications())</a>
<a name="ln177">	{</a>
<a name="ln178">	}</a>
<a name="ln179">	~ModificationPreparer()</a>
<a name="ln180">	{</a>
<a name="ln181">		if (fModificationStatus == B_OK)</a>
<a name="ln182">			fDisk-&gt;CancelModifications();</a>
<a name="ln183">	}</a>
<a name="ln184">	status_t ModificationStatus() const</a>
<a name="ln185">	{</a>
<a name="ln186">		return fModificationStatus;</a>
<a name="ln187">	}</a>
<a name="ln188">	status_t CommitModifications()</a>
<a name="ln189">	{</a>
<a name="ln190">		status_t status = fDisk-&gt;CommitModifications();</a>
<a name="ln191">		if (status == B_OK)</a>
<a name="ln192">			fModificationStatus = B_ERROR;</a>
<a name="ln193"> </a>
<a name="ln194">		return status;</a>
<a name="ln195">	}</a>
<a name="ln196"> </a>
<a name="ln197">private:</a>
<a name="ln198">	BDiskDevice*	fDisk;</a>
<a name="ln199">	status_t		fModificationStatus;</a>
<a name="ln200">};</a>
<a name="ln201"> </a>
<a name="ln202"> </a>
<a name="ln203">// #pragma mark -</a>
<a name="ln204"> </a>
<a name="ln205"> </a>
<a name="ln206">MainWindow::MainWindow()</a>
<a name="ln207">	:</a>
<a name="ln208">	BWindow(BRect(50, 50, 600, 500), B_TRANSLATE_SYSTEM_NAME(&quot;DriveSetup&quot;),</a>
<a name="ln209">		B_DOCUMENT_WINDOW, B_ASYNCHRONOUS_CONTROLS),</a>
<a name="ln210">	fCurrentDisk(NULL),</a>
<a name="ln211">	fCurrentPartitionID(-1),</a>
<a name="ln212">	fSpaceIDMap()</a>
<a name="ln213">{</a>
<a name="ln214">	fMenuBar = new BMenuBar(Bounds(), &quot;root menu&quot;);</a>
<a name="ln215"> </a>
<a name="ln216">	// create all the menu items</a>
<a name="ln217">	fWipeMenuItem = new BMenuItem(B_TRANSLATE(&quot;Wipe (not implemented)&quot;),</a>
<a name="ln218">		new BMessage(MSG_FORMAT));</a>
<a name="ln219">	fEjectMenuItem = new BMenuItem(B_TRANSLATE(&quot;Eject&quot;),</a>
<a name="ln220">		new BMessage(MSG_EJECT), 'E');</a>
<a name="ln221">	fOpenDiskProbeMenuItem = new BMenuItem(B_TRANSLATE(&quot;Open with DiskProbe&quot;),</a>
<a name="ln222">		new BMessage(MSG_OPEN_DISKPROBE));</a>
<a name="ln223"> </a>
<a name="ln224">	fSurfaceTestMenuItem = new BMenuItem(</a>
<a name="ln225">		B_TRANSLATE(&quot;Surface test (not implemented)&quot;),</a>
<a name="ln226">		new BMessage(MSG_SURFACE_TEST));</a>
<a name="ln227">	fRescanMenuItem = new BMenuItem(B_TRANSLATE(&quot;Rescan&quot;),</a>
<a name="ln228">		new BMessage(MSG_RESCAN));</a>
<a name="ln229"> </a>
<a name="ln230">	fCreateMenuItem = new BMenuItem(B_TRANSLATE(&quot;Create&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln231">		new BMessage(MSG_CREATE), 'C');</a>
<a name="ln232">	fChangeMenuItem = new BMenuItem(</a>
<a name="ln233">		B_TRANSLATE(&quot;Change parameters&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln234">		new BMessage(MSG_CHANGE));</a>
<a name="ln235">	fDeleteMenuItem = new BMenuItem(B_TRANSLATE(&quot;Delete&quot;),</a>
<a name="ln236">		new BMessage(MSG_DELETE), 'D');</a>
<a name="ln237"> </a>
<a name="ln238">	fMountMenuItem = new BMenuItem(B_TRANSLATE(&quot;Mount&quot;),</a>
<a name="ln239">		new BMessage(MSG_MOUNT), 'M');</a>
<a name="ln240">	fUnmountMenuItem = new BMenuItem(B_TRANSLATE(&quot;Unmount&quot;),</a>
<a name="ln241">		new BMessage(MSG_UNMOUNT), 'U');</a>
<a name="ln242">	fMountAllMenuItem = new BMenuItem(B_TRANSLATE(&quot;Mount all&quot;),</a>
<a name="ln243">		new BMessage(MSG_MOUNT_ALL), 'M', B_SHIFT_KEY);</a>
<a name="ln244"> </a>
<a name="ln245">	// Disk menu</a>
<a name="ln246">	fDiskMenu = new BMenu(B_TRANSLATE(&quot;Disk&quot;));</a>
<a name="ln247"> </a>
<a name="ln248">	// fDiskMenu-&gt;AddItem(fWipeMenuItem);</a>
<a name="ln249">	fDiskInitMenu = new BMenu(B_TRANSLATE(&quot;Initialize&quot;));</a>
<a name="ln250">	fDiskMenu-&gt;AddItem(fDiskInitMenu);</a>
<a name="ln251"> </a>
<a name="ln252">	fDiskMenu-&gt;AddSeparatorItem();</a>
<a name="ln253"> </a>
<a name="ln254">	fDiskMenu-&gt;AddItem(fEjectMenuItem);</a>
<a name="ln255">	// fDiskMenu-&gt;AddItem(fSurfaceTestMenuItem);</a>
<a name="ln256">	fDiskMenu-&gt;AddItem(fRescanMenuItem);</a>
<a name="ln257"> </a>
<a name="ln258">	fMenuBar-&gt;AddItem(fDiskMenu);</a>
<a name="ln259"> </a>
<a name="ln260">	// Parition menu</a>
<a name="ln261">	fPartitionMenu = new BMenu(B_TRANSLATE(&quot;Partition&quot;));</a>
<a name="ln262">	fPartitionMenu-&gt;AddItem(fCreateMenuItem);</a>
<a name="ln263"> </a>
<a name="ln264">	fFormatMenu = new BMenu(B_TRANSLATE(&quot;Format&quot;));</a>
<a name="ln265">	fPartitionMenu-&gt;AddItem(fFormatMenu);</a>
<a name="ln266"> </a>
<a name="ln267">	fPartitionMenu-&gt;AddItem(fChangeMenuItem);</a>
<a name="ln268">	fPartitionMenu-&gt;AddItem(fDeleteMenuItem);</a>
<a name="ln269"> </a>
<a name="ln270">	fPartitionMenu-&gt;AddSeparatorItem();</a>
<a name="ln271"> </a>
<a name="ln272">	fPartitionMenu-&gt;AddItem(fMountMenuItem);</a>
<a name="ln273">	fPartitionMenu-&gt;AddItem(fUnmountMenuItem);</a>
<a name="ln274"> </a>
<a name="ln275">	fPartitionMenu-&gt;AddSeparatorItem();</a>
<a name="ln276"> </a>
<a name="ln277">	fPartitionMenu-&gt;AddItem(fMountAllMenuItem);</a>
<a name="ln278"> </a>
<a name="ln279">	fPartitionMenu-&gt;AddSeparatorItem();</a>
<a name="ln280"> </a>
<a name="ln281">	fPartitionMenu-&gt;AddItem(fOpenDiskProbeMenuItem);</a>
<a name="ln282">	fMenuBar-&gt;AddItem(fPartitionMenu);</a>
<a name="ln283"> </a>
<a name="ln284">	AddChild(fMenuBar);</a>
<a name="ln285"> </a>
<a name="ln286">	// Partition / Drives context menu</a>
<a name="ln287">	fContextMenu = new BPopUpMenu(&quot;Partition&quot;, false, false);</a>
<a name="ln288">	fCreateContextMenuItem = new BMenuItem(B_TRANSLATE(&quot;Create&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln289">		new BMessage(MSG_CREATE), 'C');</a>
<a name="ln290">	fChangeContextMenuItem = new BMenuItem(</a>
<a name="ln291">		B_TRANSLATE(&quot;Change parameters&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln292">		new BMessage(MSG_CHANGE));</a>
<a name="ln293">	fDeleteContextMenuItem = new BMenuItem(B_TRANSLATE(&quot;Delete&quot;),</a>
<a name="ln294">		new BMessage(MSG_DELETE), 'D');</a>
<a name="ln295">	fMountContextMenuItem = new BMenuItem(B_TRANSLATE(&quot;Mount&quot;),</a>
<a name="ln296">		new BMessage(MSG_MOUNT), 'M');</a>
<a name="ln297">	fUnmountContextMenuItem = new BMenuItem(B_TRANSLATE(&quot;Unmount&quot;),</a>
<a name="ln298">		new BMessage(MSG_UNMOUNT), 'U');</a>
<a name="ln299">	fOpenDiskProbeContextMenuItem = new BMenuItem(B_TRANSLATE(&quot;Open with DiskProbe&quot;),</a>
<a name="ln300">		new BMessage(MSG_OPEN_DISKPROBE));</a>
<a name="ln301">	fFormatContextMenuItem = new BMenu(B_TRANSLATE(&quot;Format&quot;));</a>
<a name="ln302"> </a>
<a name="ln303">	fContextMenu-&gt;AddItem(fCreateContextMenuItem);</a>
<a name="ln304">	fContextMenu-&gt;AddItem(fFormatContextMenuItem);</a>
<a name="ln305">	fContextMenu-&gt;AddItem(fChangeContextMenuItem);</a>
<a name="ln306">	fContextMenu-&gt;AddItem(fDeleteContextMenuItem);</a>
<a name="ln307">	fContextMenu-&gt;AddSeparatorItem();</a>
<a name="ln308">	fContextMenu-&gt;AddItem(fMountContextMenuItem);</a>
<a name="ln309">	fContextMenu-&gt;AddItem(fUnmountContextMenuItem);</a>
<a name="ln310">	fContextMenu-&gt;AddSeparatorItem();</a>
<a name="ln311">	fContextMenu-&gt;AddItem(fOpenDiskProbeContextMenuItem);</a>
<a name="ln312">	fContextMenu-&gt;SetTargetForItems(this);</a>
<a name="ln313"> </a>
<a name="ln314">	// add DiskView</a>
<a name="ln315">	BRect r(Bounds());</a>
<a name="ln316">	r.top = fMenuBar-&gt;Frame().bottom + 1;</a>
<a name="ln317">	r.bottom = floorf(r.top + r.Height() * 0.33);</a>
<a name="ln318">	fDiskView = new DiskView(r, B_FOLLOW_LEFT_RIGHT | B_FOLLOW_TOP,</a>
<a name="ln319">		fSpaceIDMap);</a>
<a name="ln320">	AddChild(fDiskView);</a>
<a name="ln321"> </a>
<a name="ln322">	// add PartitionListView</a>
<a name="ln323">	r.top = r.bottom + 2;</a>
<a name="ln324">	r.bottom = Bounds().bottom;</a>
<a name="ln325">	r.InsetBy(-1, -1);</a>
<a name="ln326">	fListView = new PartitionListView(r, B_FOLLOW_ALL);</a>
<a name="ln327">	AddChild(fListView);</a>
<a name="ln328"> </a>
<a name="ln329">	// configure PartitionListView</a>
<a name="ln330">	fListView-&gt;SetSelectionMode(B_SINGLE_SELECTION_LIST);</a>
<a name="ln331">	fListView-&gt;SetSelectionMessage(new BMessage(MSG_PARTITION_ROW_SELECTED));</a>
<a name="ln332">	fListView-&gt;SetTarget(this);</a>
<a name="ln333">	fListView-&gt;MakeFocus(true);</a>
<a name="ln334"> </a>
<a name="ln335">	status_t status = fDiskDeviceRoster.StartWatching(BMessenger(this));</a>
<a name="ln336">	if (status != B_OK) {</a>
<a name="ln337">		fprintf(stderr, &quot;Failed to start watching for device changes: %s\n&quot;,</a>
<a name="ln338">			strerror(status));</a>
<a name="ln339">	}</a>
<a name="ln340"> </a>
<a name="ln341">	// visit all disks in the system and show their contents</a>
<a name="ln342">	_ScanDrives();</a>
<a name="ln343"> </a>
<a name="ln344">	if (!be_roster-&gt;IsRunning(kDeskbarSignature))</a>
<a name="ln345">		SetFlags(Flags() | B_NOT_MINIMIZABLE);</a>
<a name="ln346">}</a>
<a name="ln347"> </a>
<a name="ln348"> </a>
<a name="ln349">MainWindow::~MainWindow()</a>
<a name="ln350">{</a>
<a name="ln351">	BDiskDeviceRoster().StopWatching(this);</a>
<a name="ln352">	delete fCurrentDisk;</a>
<a name="ln353">	delete fContextMenu;</a>
<a name="ln354">}</a>
<a name="ln355"> </a>
<a name="ln356"> </a>
<a name="ln357">void</a>
<a name="ln358">MainWindow::MessageReceived(BMessage* message)</a>
<a name="ln359">{</a>
<a name="ln360">	switch (message-&gt;what) {</a>
<a name="ln361">		case MSG_MOUNT_ALL:</a>
<a name="ln362">			_MountAll();</a>
<a name="ln363">			break;</a>
<a name="ln364">		case MSG_MOUNT:</a>
<a name="ln365">			_Mount(fCurrentDisk, fCurrentPartitionID);</a>
<a name="ln366">			break;</a>
<a name="ln367">		case MSG_UNMOUNT:</a>
<a name="ln368">			_Unmount(fCurrentDisk, fCurrentPartitionID);</a>
<a name="ln369">			break;</a>
<a name="ln370"> </a>
<a name="ln371">		case MSG_FORMAT:</a>
<a name="ln372">			printf(&quot;MSG_FORMAT\n&quot;);</a>
<a name="ln373">			break;</a>
<a name="ln374"> </a>
<a name="ln375">		case MSG_CREATE:</a>
<a name="ln376">			_Create(fCurrentDisk, fCurrentPartitionID);</a>
<a name="ln377">			break;</a>
<a name="ln378"> </a>
<a name="ln379">		case MSG_INITIALIZE: {</a>
<a name="ln380">			BString diskSystemName;</a>
<a name="ln381">			if (message-&gt;FindString(&quot;disk system&quot;, &amp;diskSystemName) != B_OK)</a>
<a name="ln382">				break;</a>
<a name="ln383">			_Initialize(fCurrentDisk, fCurrentPartitionID, diskSystemName);</a>
<a name="ln384">			break;</a>
<a name="ln385">		}</a>
<a name="ln386"> </a>
<a name="ln387">		case MSG_CHANGE:</a>
<a name="ln388">			_ChangeParameters(fCurrentDisk, fCurrentPartitionID);</a>
<a name="ln389">			break;</a>
<a name="ln390"> </a>
<a name="ln391">		case MSG_DELETE:</a>
<a name="ln392">			_Delete(fCurrentDisk, fCurrentPartitionID);</a>
<a name="ln393">			break;</a>
<a name="ln394"> </a>
<a name="ln395">		case MSG_EJECT:</a>
<a name="ln396">			// TODO: completely untested, especially interesting</a>
<a name="ln397">			// if partition list behaves when partitions disappear</a>
<a name="ln398">			if (fCurrentDisk) {</a>
<a name="ln399">				// TODO: only if no partitions are mounted anymore?</a>
<a name="ln400">				fCurrentDisk-&gt;Eject(true);</a>
<a name="ln401">				_ScanDrives();</a>
<a name="ln402">			}</a>
<a name="ln403">			break;</a>
<a name="ln404">		case MSG_OPEN_DISKPROBE:</a>
<a name="ln405">		{</a>
<a name="ln406">			PartitionListRow* row = dynamic_cast&lt;PartitionListRow*&gt;(</a>
<a name="ln407">				fListView-&gt;CurrentSelection());</a>
<a name="ln408">			const char* args[] = { row-&gt;DevicePath(), NULL };</a>
<a name="ln409"> </a>
<a name="ln410">			be_roster-&gt;Launch(&quot;application/x-vnd.Haiku-DiskProbe&quot;, 1,</a>
<a name="ln411">				(char**)args);</a>
<a name="ln412"> </a>
<a name="ln413">			break;</a>
<a name="ln414">		}</a>
<a name="ln415">		case MSG_SURFACE_TEST:</a>
<a name="ln416">			printf(&quot;MSG_SURFACE_TEST\n&quot;);</a>
<a name="ln417">			break;</a>
<a name="ln418"> </a>
<a name="ln419">		// TODO: this could probably be done better!</a>
<a name="ln420">		case B_DEVICE_UPDATE:</a>
<a name="ln421">			printf(&quot;B_DEVICE_UPDATE\n&quot;);</a>
<a name="ln422">		case MSG_RESCAN:</a>
<a name="ln423">			_ScanDrives();</a>
<a name="ln424">			break;</a>
<a name="ln425"> </a>
<a name="ln426">		case MSG_PARTITION_ROW_SELECTED: {</a>
<a name="ln427">			// selection of partitions via list view</a>
<a name="ln428">			_AdaptToSelectedPartition();</a>
<a name="ln429"> </a>
<a name="ln430">			BPoint where;</a>
<a name="ln431">			uint32 buttons;</a>
<a name="ln432">			fListView-&gt;GetMouse(&amp;where, &amp;buttons);</a>
<a name="ln433">			where.x += 2; // to prevent occasional select</a>
<a name="ln434">			if (buttons &amp; B_SECONDARY_MOUSE_BUTTON)</a>
<a name="ln435">				fContextMenu-&gt;Go(fListView-&gt;ConvertToScreen(where),</a>
<a name="ln436">					true, false, true);</a>
<a name="ln437">			break;</a>
<a name="ln438">		}</a>
<a name="ln439">		case MSG_SELECTED_PARTITION_ID: {</a>
<a name="ln440">			// selection of partitions via disk view</a>
<a name="ln441">			partition_id id;</a>
<a name="ln442">			if (message-&gt;FindInt32(&quot;partition_id&quot;, &amp;id) == B_OK) {</a>
<a name="ln443">				if (BRow* row = fListView-&gt;FindRow(id)) {</a>
<a name="ln444">					fListView-&gt;DeselectAll();</a>
<a name="ln445">					fListView-&gt;AddToSelection(row);</a>
<a name="ln446">					_AdaptToSelectedPartition();</a>
<a name="ln447">				}</a>
<a name="ln448">			}</a>
<a name="ln449">			BPoint where;</a>
<a name="ln450">			uint32 buttons;</a>
<a name="ln451">			fListView-&gt;GetMouse(&amp;where, &amp;buttons);</a>
<a name="ln452">			where.x += 2; // to prevent occasional select</a>
<a name="ln453">			if (buttons &amp; B_SECONDARY_MOUSE_BUTTON)</a>
<a name="ln454">				fContextMenu-&gt;Go(fListView-&gt;ConvertToScreen(where),</a>
<a name="ln455">					true, false, true);</a>
<a name="ln456">			break;</a>
<a name="ln457">		}</a>
<a name="ln458"> </a>
<a name="ln459">		case MSG_UPDATE_ZOOM_LIMITS:</a>
<a name="ln460">			_UpdateWindowZoomLimits();</a>
<a name="ln461">			break;</a>
<a name="ln462"> </a>
<a name="ln463">		default:</a>
<a name="ln464">			BWindow::MessageReceived(message);</a>
<a name="ln465">			break;</a>
<a name="ln466">	}</a>
<a name="ln467">}</a>
<a name="ln468"> </a>
<a name="ln469"> </a>
<a name="ln470">bool</a>
<a name="ln471">MainWindow::QuitRequested()</a>
<a name="ln472">{</a>
<a name="ln473">	// TODO: ask about any unsaved changes</a>
<a name="ln474">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln475">	Hide();</a>
<a name="ln476">	return false;</a>
<a name="ln477">}</a>
<a name="ln478"> </a>
<a name="ln479"> </a>
<a name="ln480">// #pragma mark -</a>
<a name="ln481"> </a>
<a name="ln482"> </a>
<a name="ln483">status_t</a>
<a name="ln484">MainWindow::StoreSettings(BMessage* archive) const</a>
<a name="ln485">{</a>
<a name="ln486">	if (archive-&gt;ReplaceRect(&quot;window frame&quot;, Frame()) &lt; B_OK)</a>
<a name="ln487">		archive-&gt;AddRect(&quot;window frame&quot;, Frame());</a>
<a name="ln488"> </a>
<a name="ln489">	BMessage columnSettings;</a>
<a name="ln490">	fListView-&gt;SaveState(&amp;columnSettings);</a>
<a name="ln491">	if (archive-&gt;ReplaceMessage(&quot;column settings&quot;, &amp;columnSettings) &lt; B_OK)</a>
<a name="ln492">		archive-&gt;AddMessage(&quot;column settings&quot;, &amp;columnSettings);</a>
<a name="ln493"> </a>
<a name="ln494">	return B_OK;</a>
<a name="ln495">}</a>
<a name="ln496"> </a>
<a name="ln497"> </a>
<a name="ln498">status_t</a>
<a name="ln499">MainWindow::RestoreSettings(BMessage* archive)</a>
<a name="ln500">{</a>
<a name="ln501">	BRect frame;</a>
<a name="ln502">	if (archive-&gt;FindRect(&quot;window frame&quot;, &amp;frame) == B_OK) {</a>
<a name="ln503">		BScreen screen(this);</a>
<a name="ln504">		if (frame.Intersects(screen.Frame())) {</a>
<a name="ln505">			MoveTo(frame.LeftTop());</a>
<a name="ln506">			ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln507">		}</a>
<a name="ln508">	}</a>
<a name="ln509"> </a>
<a name="ln510">	BMessage columnSettings;</a>
<a name="ln511">	if (archive-&gt;FindMessage(&quot;column settings&quot;, &amp;columnSettings) == B_OK)</a>
<a name="ln512">		fListView-&gt;LoadState(&amp;columnSettings);</a>
<a name="ln513"> </a>
<a name="ln514">	return B_OK;</a>
<a name="ln515">}</a>
<a name="ln516"> </a>
<a name="ln517"> </a>
<a name="ln518">void</a>
<a name="ln519">MainWindow::ApplyDefaultSettings()</a>
<a name="ln520">{</a>
<a name="ln521">	if (!Lock())</a>
<a name="ln522">		return;</a>
<a name="ln523"> </a>
<a name="ln524">	fListView-&gt;ResizeAllColumnsToPreferred();</a>
<a name="ln525"> </a>
<a name="ln526">	// Adjust window size for convenience</a>
<a name="ln527">	BScreen screen(this);</a>
<a name="ln528">	float windowWidth = Frame().Width();</a>
<a name="ln529">	float windowHeight = Frame().Height();</a>
<a name="ln530"> </a>
<a name="ln531">	float enlargeWidthBy = fListView-&gt;PreferredSize().width</a>
<a name="ln532">		- fListView-&gt;Bounds().Width();</a>
<a name="ln533">	float enlargeHeightBy = fListView-&gt;PreferredSize().height</a>
<a name="ln534">		- fListView-&gt;Bounds().Height();</a>
<a name="ln535"> </a>
<a name="ln536">	if (enlargeWidthBy &gt; 0.0f)</a>
<a name="ln537">		windowWidth += enlargeWidthBy;</a>
<a name="ln538">	if (enlargeHeightBy &gt; 0.0f)</a>
<a name="ln539">		windowHeight += enlargeHeightBy;</a>
<a name="ln540"> </a>
<a name="ln541">	if (windowWidth &gt; screen.Frame().Width() - 20.0f)</a>
<a name="ln542">		windowWidth = screen.Frame().Width() - 20.0f;</a>
<a name="ln543">	if (windowHeight &gt; screen.Frame().Height() - 20.0f)</a>
<a name="ln544">		windowHeight = screen.Frame().Height() - 20.0f;</a>
<a name="ln545"> </a>
<a name="ln546">	ResizeTo(windowWidth, windowHeight);</a>
<a name="ln547">	CenterOnScreen();</a>
<a name="ln548"> </a>
<a name="ln549">	Unlock();</a>
<a name="ln550">}</a>
<a name="ln551"> </a>
<a name="ln552"> </a>
<a name="ln553">// #pragma mark -</a>
<a name="ln554"> </a>
<a name="ln555"> </a>
<a name="ln556">void</a>
<a name="ln557">MainWindow::_ScanDrives()</a>
<a name="ln558">{</a>
<a name="ln559">	fSpaceIDMap.Clear();</a>
<a name="ln560">	int32 diskCount = 0;</a>
<a name="ln561">	ListPopulatorVisitor driveVisitor(fListView, diskCount, fSpaceIDMap);</a>
<a name="ln562">	fDiskDeviceRoster.VisitEachPartition(&amp;driveVisitor);</a>
<a name="ln563">	fDiskView-&gt;SetDiskCount(diskCount);</a>
<a name="ln564"> </a>
<a name="ln565">	// restore selection</a>
<a name="ln566">	PartitionListRow* previousSelection</a>
<a name="ln567">		= fListView-&gt;FindRow(fCurrentPartitionID);</a>
<a name="ln568">	if (previousSelection) {</a>
<a name="ln569">		fListView-&gt;AddToSelection(previousSelection);</a>
<a name="ln570">		_UpdateMenus(fCurrentDisk, fCurrentPartitionID,</a>
<a name="ln571">			previousSelection-&gt;ParentID());</a>
<a name="ln572">		fDiskView-&gt;ForceUpdate();</a>
<a name="ln573">	} else {</a>
<a name="ln574">		_UpdateMenus(NULL, -1, -1);</a>
<a name="ln575">	}</a>
<a name="ln576"> </a>
<a name="ln577">	PostMessage(MSG_UPDATE_ZOOM_LIMITS);</a>
<a name="ln578">}</a>
<a name="ln579"> </a>
<a name="ln580"> </a>
<a name="ln581">// #pragma mark -</a>
<a name="ln582"> </a>
<a name="ln583"> </a>
<a name="ln584">void</a>
<a name="ln585">MainWindow::_AdaptToSelectedPartition()</a>
<a name="ln586">{</a>
<a name="ln587">	partition_id diskID = -1;</a>
<a name="ln588">	partition_id partitionID = -1;</a>
<a name="ln589">	partition_id parentID = -1;</a>
<a name="ln590"> </a>
<a name="ln591">	BRow* _selectedRow = fListView-&gt;CurrentSelection();</a>
<a name="ln592">	if (_selectedRow) {</a>
<a name="ln593">		// go up to top level row</a>
<a name="ln594">		BRow* _topLevelRow = _selectedRow;</a>
<a name="ln595">		BRow* parent = NULL;</a>
<a name="ln596">		while (fListView-&gt;FindParent(_topLevelRow, &amp;parent, NULL))</a>
<a name="ln597">			_topLevelRow = parent;</a>
<a name="ln598"> </a>
<a name="ln599">		PartitionListRow* topLevelRow</a>
<a name="ln600">			= dynamic_cast&lt;PartitionListRow*&gt;(_topLevelRow);</a>
<a name="ln601">		PartitionListRow* selectedRow</a>
<a name="ln602">			= dynamic_cast&lt;PartitionListRow*&gt;(_selectedRow);</a>
<a name="ln603"> </a>
<a name="ln604">		if (topLevelRow)</a>
<a name="ln605">			diskID = topLevelRow-&gt;ID();</a>
<a name="ln606">		if (selectedRow) {</a>
<a name="ln607">			partitionID = selectedRow-&gt;ID();</a>
<a name="ln608">			parentID = selectedRow-&gt;ParentID();</a>
<a name="ln609">		}</a>
<a name="ln610">	}</a>
<a name="ln611"> </a>
<a name="ln612">	_SetToDiskAndPartition(diskID, partitionID, parentID);</a>
<a name="ln613">}</a>
<a name="ln614"> </a>
<a name="ln615"> </a>
<a name="ln616">void</a>
<a name="ln617">MainWindow::_SetToDiskAndPartition(partition_id disk, partition_id partition,</a>
<a name="ln618">	partition_id parent)</a>
<a name="ln619">{</a>
<a name="ln620">//printf(&quot;MainWindow::_SetToDiskAndPartition(disk: %ld, partition: %ld, &quot;</a>
<a name="ln621">//	&quot;parent: %ld)\n&quot;, disk, partition, parent);</a>
<a name="ln622"> </a>
<a name="ln623">	BDiskDevice* oldDisk = NULL;</a>
<a name="ln624">	if (!fCurrentDisk || fCurrentDisk-&gt;ID() != disk) {</a>
<a name="ln625">		oldDisk = fCurrentDisk;</a>
<a name="ln626">		fCurrentDisk = NULL;</a>
<a name="ln627">		if (disk &gt;= 0) {</a>
<a name="ln628">			BDiskDevice* newDisk = new BDiskDevice();</a>
<a name="ln629">			status_t status = newDisk-&gt;SetTo(disk);</a>
<a name="ln630">			if (status != B_OK) {</a>
<a name="ln631">				printf(&quot;error switching disks: %s\n&quot;, strerror(status));</a>
<a name="ln632">				delete newDisk;</a>
<a name="ln633">			} else</a>
<a name="ln634">				fCurrentDisk = newDisk;</a>
<a name="ln635">		}</a>
<a name="ln636">	}</a>
<a name="ln637"> </a>
<a name="ln638">	fCurrentPartitionID = partition;</a>
<a name="ln639"> </a>
<a name="ln640">	fDiskView-&gt;SetDisk(fCurrentDisk, fCurrentPartitionID);</a>
<a name="ln641">	_UpdateMenus(fCurrentDisk, fCurrentPartitionID, parent);</a>
<a name="ln642"> </a>
<a name="ln643">	delete oldDisk;</a>
<a name="ln644">}</a>
<a name="ln645"> </a>
<a name="ln646"> </a>
<a name="ln647">void</a>
<a name="ln648">MainWindow::_UpdateMenus(BDiskDevice* disk,</a>
<a name="ln649">	partition_id selectedPartition, partition_id parentID)</a>
<a name="ln650">{</a>
<a name="ln651">	while (BMenuItem* item = fFormatMenu-&gt;RemoveItem((int32)0))</a>
<a name="ln652">		delete item;</a>
<a name="ln653">	while (BMenuItem* item = fDiskInitMenu-&gt;RemoveItem((int32)0))</a>
<a name="ln654">		delete item;</a>
<a name="ln655">	while (BMenuItem* item = fFormatContextMenuItem-&gt;RemoveItem((int32)0))</a>
<a name="ln656">		delete item;</a>
<a name="ln657"> </a>
<a name="ln658">	fCreateMenuItem-&gt;SetEnabled(false);</a>
<a name="ln659">	fUnmountMenuItem-&gt;SetEnabled(false);</a>
<a name="ln660">	fDiskInitMenu-&gt;SetEnabled(false);</a>
<a name="ln661">	fFormatMenu-&gt;SetEnabled(false);</a>
<a name="ln662"> </a>
<a name="ln663">	fCreateContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln664">	fUnmountContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln665">	fFormatContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln666"> </a>
<a name="ln667">	if (!disk) {</a>
<a name="ln668">		fWipeMenuItem-&gt;SetEnabled(false);</a>
<a name="ln669">		fEjectMenuItem-&gt;SetEnabled(false);</a>
<a name="ln670">		fSurfaceTestMenuItem-&gt;SetEnabled(false);</a>
<a name="ln671">		fOpenDiskProbeMenuItem-&gt;SetEnabled(false);</a>
<a name="ln672">		fOpenDiskProbeContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln673">	} else {</a>
<a name="ln674">//		fWipeMenuItem-&gt;SetEnabled(true);</a>
<a name="ln675">		fWipeMenuItem-&gt;SetEnabled(false);</a>
<a name="ln676">		fEjectMenuItem-&gt;SetEnabled(disk-&gt;IsRemovableMedia());</a>
<a name="ln677">//		fSurfaceTestMenuItem-&gt;SetEnabled(true);</a>
<a name="ln678">		fSurfaceTestMenuItem-&gt;SetEnabled(false);</a>
<a name="ln679"> </a>
<a name="ln680">		// Create menu and items</a>
<a name="ln681">		BPartition* parentPartition = NULL;</a>
<a name="ln682">		if (selectedPartition &lt;= -2) {</a>
<a name="ln683">			// a partitionable space item is selected</a>
<a name="ln684">			parentPartition = disk-&gt;FindDescendant(parentID);</a>
<a name="ln685">		}</a>
<a name="ln686"> </a>
<a name="ln687">		if (parentPartition &amp;&amp; parentPartition-&gt;ContainsPartitioningSystem()) {</a>
<a name="ln688">			fCreateMenuItem-&gt;SetEnabled(true);</a>
<a name="ln689">			fCreateContextMenuItem-&gt;SetEnabled(true);</a>
<a name="ln690">		}</a>
<a name="ln691">		bool prepared = disk-&gt;PrepareModifications() == B_OK;</a>
<a name="ln692"> </a>
<a name="ln693">		fFormatMenu-&gt;SetEnabled(prepared);</a>
<a name="ln694">		fDeleteMenuItem-&gt;SetEnabled(prepared);</a>
<a name="ln695">		fChangeMenuItem-&gt;SetEnabled(prepared);</a>
<a name="ln696"> </a>
<a name="ln697">		fChangeContextMenuItem-&gt;SetEnabled(prepared);</a>
<a name="ln698">		fDeleteContextMenuItem-&gt;SetEnabled(prepared);</a>
<a name="ln699">		fFormatContextMenuItem-&gt;SetEnabled(prepared);</a>
<a name="ln700"> </a>
<a name="ln701">		BPartition* partition = disk-&gt;FindDescendant(selectedPartition);</a>
<a name="ln702"> </a>
<a name="ln703">		BDiskSystem diskSystem;</a>
<a name="ln704">		fDiskDeviceRoster.RewindDiskSystems();</a>
<a name="ln705">		while (fDiskDeviceRoster.GetNextDiskSystem(&amp;diskSystem) == B_OK) {</a>
<a name="ln706">			if (!diskSystem.SupportsInitializing())</a>
<a name="ln707">				continue;</a>
<a name="ln708"> </a>
<a name="ln709">			BMessage* message = new BMessage(MSG_INITIALIZE);</a>
<a name="ln710">			message-&gt;AddInt32(&quot;parent id&quot;, parentID);</a>
<a name="ln711">			message-&gt;AddString(&quot;disk system&quot;, diskSystem.PrettyName());</a>
<a name="ln712"> </a>
<a name="ln713">			BString label = diskSystem.PrettyName();</a>
<a name="ln714">			label &lt;&lt; B_UTF8_ELLIPSIS;</a>
<a name="ln715">			BMenuItem* item = new BMenuItem(label.String(), message);</a>
<a name="ln716"> </a>
<a name="ln717">			// TODO: Very unintuitive that we have to use PrettyName (vs Name)</a>
<a name="ln718">			item-&gt;SetEnabled(partition != NULL</a>
<a name="ln719">				&amp;&amp; partition-&gt;CanInitialize(diskSystem.PrettyName()));</a>
<a name="ln720"> </a>
<a name="ln721">			if (disk-&gt;ID() == selectedPartition</a>
<a name="ln722">				&amp;&amp; !diskSystem.IsFileSystem()) {</a>
<a name="ln723">				// Disk is selected, and DiskSystem is a partition map</a>
<a name="ln724">				fDiskInitMenu-&gt;AddItem(item);</a>
<a name="ln725">			} else if (diskSystem.IsFileSystem()) {</a>
<a name="ln726">				// Otherwise a filesystem</a>
<a name="ln727">				fFormatMenu-&gt;AddItem(item);</a>
<a name="ln728"> </a>
<a name="ln729">				// Context menu</a>
<a name="ln730">				BMessage* message = new BMessage(MSG_INITIALIZE);</a>
<a name="ln731">				message-&gt;AddInt32(&quot;parent id&quot;, parentID);</a>
<a name="ln732">				message-&gt;AddString(&quot;disk system&quot;, diskSystem.PrettyName());</a>
<a name="ln733">				BMenuItem* popUpItem = new BMenuItem(label.String(), message);</a>
<a name="ln734">				popUpItem-&gt;SetEnabled(partition != NULL</a>
<a name="ln735">					&amp;&amp; partition-&gt;CanInitialize(diskSystem.PrettyName()));</a>
<a name="ln736">				fFormatContextMenuItem-&gt;AddItem(popUpItem);</a>
<a name="ln737">				fFormatContextMenuItem-&gt;SetTargetForItems(this);</a>
<a name="ln738">			}</a>
<a name="ln739">		}</a>
<a name="ln740"> </a>
<a name="ln741">		// Mount items</a>
<a name="ln742">		if (partition != NULL) {</a>
<a name="ln743">			bool notMountedAndWritable = !partition-&gt;IsMounted()</a>
<a name="ln744">				&amp;&amp; !partition-&gt;IsReadOnly()</a>
<a name="ln745">				&amp;&amp; partition-&gt;Device()-&gt;HasMedia();</a>
<a name="ln746"> </a>
<a name="ln747">			fFormatMenu-&gt;SetEnabled(notMountedAndWritable</a>
<a name="ln748">				&amp;&amp; fFormatMenu-&gt;CountItems() &gt; 0);</a>
<a name="ln749"> </a>
<a name="ln750">			fDiskInitMenu-&gt;SetEnabled(notMountedAndWritable</a>
<a name="ln751">				&amp;&amp; partition-&gt;IsDevice()</a>
<a name="ln752">				&amp;&amp; fDiskInitMenu-&gt;CountItems() &gt; 0);</a>
<a name="ln753"> </a>
<a name="ln754">			fChangeMenuItem-&gt;SetEnabled(notMountedAndWritable);</a>
<a name="ln755"> </a>
<a name="ln756">			fDeleteMenuItem-&gt;SetEnabled(notMountedAndWritable</a>
<a name="ln757">				&amp;&amp; !partition-&gt;IsDevice());</a>
<a name="ln758"> </a>
<a name="ln759">			fMountMenuItem-&gt;SetEnabled(!partition-&gt;IsMounted());</a>
<a name="ln760"> </a>
<a name="ln761">			fFormatContextMenuItem-&gt;SetEnabled(notMountedAndWritable</a>
<a name="ln762">				&amp;&amp; fFormatContextMenuItem-&gt;CountItems() &gt; 0);</a>
<a name="ln763">			fChangeContextMenuItem-&gt;SetEnabled(notMountedAndWritable);</a>
<a name="ln764">			fDeleteContextMenuItem-&gt;SetEnabled(notMountedAndWritable</a>
<a name="ln765">				&amp;&amp; !partition-&gt;IsDevice());</a>
<a name="ln766">			fMountContextMenuItem-&gt;SetEnabled(notMountedAndWritable);</a>
<a name="ln767"> </a>
<a name="ln768">			bool unMountable = false;</a>
<a name="ln769">			if (partition-&gt;IsMounted()) {</a>
<a name="ln770">				// see if this partition is the boot volume</a>
<a name="ln771">				BVolume volume;</a>
<a name="ln772">				BVolume bootVolume;</a>
<a name="ln773">				if (BVolumeRoster().GetBootVolume(&amp;bootVolume) == B_OK</a>
<a name="ln774">					&amp;&amp; partition-&gt;GetVolume(&amp;volume) == B_OK) {</a>
<a name="ln775">					unMountable = volume != bootVolume;</a>
<a name="ln776">				} else</a>
<a name="ln777">					unMountable = true;</a>
<a name="ln778">			}</a>
<a name="ln779">			fUnmountMenuItem-&gt;SetEnabled(unMountable);</a>
<a name="ln780">			fUnmountContextMenuItem-&gt;SetEnabled(unMountable);</a>
<a name="ln781">		} else {</a>
<a name="ln782">			fDeleteMenuItem-&gt;SetEnabled(false);</a>
<a name="ln783">			fChangeMenuItem-&gt;SetEnabled(false);</a>
<a name="ln784">			fMountMenuItem-&gt;SetEnabled(false);</a>
<a name="ln785">			fFormatMenu-&gt;SetEnabled(false);</a>
<a name="ln786">			fDiskInitMenu-&gt;SetEnabled(false);</a>
<a name="ln787"> </a>
<a name="ln788">			fDeleteContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln789">			fChangeContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln790">			fMountContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln791">			fFormatContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln792">		}</a>
<a name="ln793"> </a>
<a name="ln794">		fOpenDiskProbeMenuItem-&gt;SetEnabled(true);</a>
<a name="ln795">		fOpenDiskProbeContextMenuItem-&gt;SetEnabled(true);</a>
<a name="ln796"> </a>
<a name="ln797">		if (prepared)</a>
<a name="ln798">			disk-&gt;CancelModifications();</a>
<a name="ln799"> </a>
<a name="ln800">		fMountAllMenuItem-&gt;SetEnabled(true);</a>
<a name="ln801">	}</a>
<a name="ln802">	if (selectedPartition &lt; 0) {</a>
<a name="ln803">		fDeleteMenuItem-&gt;SetEnabled(false);</a>
<a name="ln804">		fChangeMenuItem-&gt;SetEnabled(false);</a>
<a name="ln805">		fMountMenuItem-&gt;SetEnabled(false);</a>
<a name="ln806"> </a>
<a name="ln807">		fDeleteContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln808">		fChangeContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln809">		fMountContextMenuItem-&gt;SetEnabled(false);</a>
<a name="ln810">	}</a>
<a name="ln811">}</a>
<a name="ln812"> </a>
<a name="ln813"> </a>
<a name="ln814">void</a>
<a name="ln815">MainWindow::_DisplayPartitionError(BString _message,</a>
<a name="ln816">	const BPartition* partition, status_t error) const</a>
<a name="ln817">{</a>
<a name="ln818">	char message[1024];</a>
<a name="ln819"> </a>
<a name="ln820">	if (partition &amp;&amp; _message.FindFirst(&quot;%s&quot;) &gt;= 0) {</a>
<a name="ln821">		BString name;</a>
<a name="ln822">		name &lt;&lt; &quot;\&quot;&quot; &lt;&lt; partition-&gt;ContentName() &lt;&lt; &quot;\&quot;&quot;;</a>
<a name="ln823">		snprintf(message, sizeof(message), _message.String(), name.String());</a>
<a name="ln824">	} else {</a>
<a name="ln825">		_message.ReplaceAll(&quot;%s&quot;, &quot;&quot;);</a>
<a name="ln826">		snprintf(message, sizeof(message), _message.String());</a>
<a name="ln827">	}</a>
<a name="ln828"> </a>
<a name="ln829">	if (error &lt; B_OK) {</a>
<a name="ln830">		BString helper = message;</a>
<a name="ln831">		const char* errorString</a>
<a name="ln832">			= B_TRANSLATE_COMMENT(&quot;Error: &quot;, &quot;in any error alert&quot;);</a>
<a name="ln833">		snprintf(message, sizeof(message), &quot;%s\n\n%s%s&quot;, helper.String(),</a>
<a name="ln834">			errorString, strerror(error));</a>
<a name="ln835">	}</a>
<a name="ln836"> </a>
<a name="ln837">	BAlert* alert = new BAlert(&quot;error&quot;, message, B_TRANSLATE(&quot;OK&quot;), NULL, NULL,</a>
<a name="ln838">		B_WIDTH_FROM_WIDEST, error &lt; B_OK ? B_STOP_ALERT : B_INFO_ALERT);</a>
<a name="ln839">	alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln840">	alert-&gt;Go(NULL);</a>
<a name="ln841">}</a>
<a name="ln842"> </a>
<a name="ln843"> </a>
<a name="ln844">// #pragma mark -</a>
<a name="ln845"> </a>
<a name="ln846"> </a>
<a name="ln847">void</a>
<a name="ln848">MainWindow::_Mount(BDiskDevice* disk, partition_id selectedPartition)</a>
<a name="ln849">{</a>
<a name="ln850">	if (!disk || selectedPartition &lt; 0) {</a>
<a name="ln851">		_DisplayPartitionError(B_TRANSLATE(&quot;You need to select a partition &quot;</a>
<a name="ln852">			&quot;entry from the list.&quot;));</a>
<a name="ln853">		return;</a>
<a name="ln854">	}</a>
<a name="ln855"> </a>
<a name="ln856">	BPartition* partition = disk-&gt;FindDescendant(selectedPartition);</a>
<a name="ln857">	if (!partition) {</a>
<a name="ln858">		_DisplayPartitionError(B_TRANSLATE(&quot;Unable to find the selected &quot;</a>
<a name="ln859">			&quot;partition by ID.&quot;));</a>
<a name="ln860">		return;</a>
<a name="ln861">	}</a>
<a name="ln862"> </a>
<a name="ln863">	if (!partition-&gt;IsMounted()) {</a>
<a name="ln864">		status_t status = partition-&gt;Mount();</a>
<a name="ln865">		if (status != B_OK) {</a>
<a name="ln866">			_DisplayPartitionError(B_TRANSLATE(&quot;Could not mount partition %s.&quot;),</a>
<a name="ln867">				partition, status);</a>
<a name="ln868">		} else {</a>
<a name="ln869">			// successful mount, adapt to the changes</a>
<a name="ln870">			_ScanDrives();</a>
<a name="ln871">		}</a>
<a name="ln872">	} else {</a>
<a name="ln873">		_DisplayPartitionError(</a>
<a name="ln874">			B_TRANSLATE(&quot;The partition %s is already mounted.&quot;), partition);</a>
<a name="ln875">	}</a>
<a name="ln876">}</a>
<a name="ln877"> </a>
<a name="ln878"> </a>
<a name="ln879">void</a>
<a name="ln880">MainWindow::_Unmount(BDiskDevice* disk, partition_id selectedPartition)</a>
<a name="ln881">{</a>
<a name="ln882">	if (!disk || selectedPartition &lt; 0) {</a>
<a name="ln883">		_DisplayPartitionError(B_TRANSLATE(&quot;You need to select a partition &quot;</a>
<a name="ln884">			&quot;entry from the list.&quot;));</a>
<a name="ln885">		return;</a>
<a name="ln886">	}</a>
<a name="ln887"> </a>
<a name="ln888">	BPartition* partition = disk-&gt;FindDescendant(selectedPartition);</a>
<a name="ln889">	if (!partition) {</a>
<a name="ln890">		_DisplayPartitionError(B_TRANSLATE(&quot;Unable to find the selected &quot;</a>
<a name="ln891">			&quot;partition by ID.&quot;));</a>
<a name="ln892">		return;</a>
<a name="ln893">	}</a>
<a name="ln894"> </a>
<a name="ln895">	if (partition-&gt;IsMounted()) {</a>
<a name="ln896">		BPath path;</a>
<a name="ln897">		partition-&gt;GetMountPoint(&amp;path);</a>
<a name="ln898">		status_t status = partition-&gt;Unmount();</a>
<a name="ln899">		if (status != B_OK) {</a>
<a name="ln900">			BString message = B_TRANSLATE(&quot;Could not unmount partition&quot;);</a>
<a name="ln901">			message &lt;&lt; &quot; \&quot;&quot; &lt;&lt; partition-&gt;ContentName() &lt;&lt; &quot;\&quot;:\n\t&quot;</a>
<a name="ln902">				&lt;&lt; strerror(status) &lt;&lt; &quot;\n\n&quot;</a>
<a name="ln903">				&lt;&lt; B_TRANSLATE(&quot;Should unmounting be forced?\n\n&quot;</a>
<a name="ln904">				&quot;Note: If an application is currently writing to the volume, &quot;</a>
<a name="ln905">				&quot;unmounting it now might result in loss of data.\n&quot;);</a>
<a name="ln906"> </a>
<a name="ln907">			BAlert* alert = new BAlert(B_TRANSLATE(&quot;Force unmount&quot;), message,</a>
<a name="ln908">				B_TRANSLATE(&quot;Cancel&quot;), B_TRANSLATE(&quot;Force unmount&quot;), NULL,</a>
<a name="ln909">				B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln910">			alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln911"> </a>
<a name="ln912">			if (alert-&gt;Go() == 1)</a>
<a name="ln913">				status = partition-&gt;Unmount(B_FORCE_UNMOUNT);</a>
<a name="ln914">			else</a>
<a name="ln915">				return;</a>
<a name="ln916">		}</a>
<a name="ln917"> </a>
<a name="ln918">		if (status != B_OK) {</a>
<a name="ln919">			_DisplayPartitionError(</a>
<a name="ln920">				B_TRANSLATE(&quot;Could not unmount partition %s.&quot;),</a>
<a name="ln921">				partition, status);</a>
<a name="ln922">		} else {</a>
<a name="ln923">			if (dev_for_path(path.Path()) == dev_for_path(&quot;/&quot;))</a>
<a name="ln924">				rmdir(path.Path());</a>
<a name="ln925">			// successful unmount, adapt to the changes</a>
<a name="ln926">			_ScanDrives();</a>
<a name="ln927">		}</a>
<a name="ln928">	} else {</a>
<a name="ln929">		_DisplayPartitionError(</a>
<a name="ln930">			B_TRANSLATE(&quot;The partition %s is already unmounted.&quot;),</a>
<a name="ln931">			partition);</a>
<a name="ln932">	}</a>
<a name="ln933">}</a>
<a name="ln934"> </a>
<a name="ln935"> </a>
<a name="ln936">void</a>
<a name="ln937">MainWindow::_MountAll()</a>
<a name="ln938">{</a>
<a name="ln939">	MountAllVisitor visitor;</a>
<a name="ln940">	fDiskDeviceRoster.VisitEachPartition(&amp;visitor);</a>
<a name="ln941">}</a>
<a name="ln942"> </a>
<a name="ln943"> </a>
<a name="ln944">// #pragma mark -</a>
<a name="ln945"> </a>
<a name="ln946"> </a>
<a name="ln947">void</a>
<a name="ln948">MainWindow::_Initialize(BDiskDevice* disk, partition_id selectedPartition,</a>
<a name="ln949">	const BString&amp; diskSystemName)</a>
<a name="ln950">{</a>
<a name="ln951">	if (!disk || selectedPartition &lt; 0) {</a>
<a name="ln952">		_DisplayPartitionError(B_TRANSLATE(&quot;You need to select a partition &quot;</a>
<a name="ln953">			&quot;entry from the list.&quot;));</a>
<a name="ln954">		return;</a>
<a name="ln955">	}</a>
<a name="ln956"> </a>
<a name="ln957">	if (disk-&gt;IsReadOnly()) {</a>
<a name="ln958">		_DisplayPartitionError(B_TRANSLATE(&quot;The selected disk is read-only.&quot;));</a>
<a name="ln959">		return;</a>
<a name="ln960">	}</a>
<a name="ln961"> </a>
<a name="ln962">	BPartition* partition = disk-&gt;FindDescendant(selectedPartition);</a>
<a name="ln963">	if (!partition) {</a>
<a name="ln964">		_DisplayPartitionError(B_TRANSLATE(&quot;Unable to find the selected &quot;</a>
<a name="ln965">			&quot;partition by ID.&quot;));</a>
<a name="ln966">		return;</a>
<a name="ln967">	}</a>
<a name="ln968"> </a>
<a name="ln969">	if (partition-&gt;IsMounted()) {</a>
<a name="ln970">		_DisplayPartitionError(</a>
<a name="ln971">			B_TRANSLATE(&quot;The partition %s is currently mounted.&quot;));</a>
<a name="ln972">		// TODO: option to unmount and continue on success to unmount</a>
<a name="ln973">		return;</a>
<a name="ln974">	}</a>
<a name="ln975"> </a>
<a name="ln976">	BDiskSystem diskSystem;</a>
<a name="ln977">	fDiskDeviceRoster.RewindDiskSystems();</a>
<a name="ln978">	bool found = false;</a>
<a name="ln979">	while (fDiskDeviceRoster.GetNextDiskSystem(&amp;diskSystem) == B_OK) {</a>
<a name="ln980">		if (diskSystem.SupportsInitializing()) {</a>
<a name="ln981">			if (diskSystemName == diskSystem.PrettyName()) {</a>
<a name="ln982">				found = true;</a>
<a name="ln983">				break;</a>
<a name="ln984">			}</a>
<a name="ln985">		}</a>
<a name="ln986">	}</a>
<a name="ln987"> </a>
<a name="ln988">	char message[512];</a>
<a name="ln989"> </a>
<a name="ln990">	if (!found) {</a>
<a name="ln991">		snprintf(message, sizeof(message), B_TRANSLATE(&quot;Disk system \&quot;%s\&quot; &quot;</a>
<a name="ln992">			&quot;not found!&quot;));</a>
<a name="ln993">		_DisplayPartitionError(message);</a>
<a name="ln994">		return;</a>
<a name="ln995">	}</a>
<a name="ln996"> </a>
<a name="ln997">	if (diskSystem.IsFileSystem()) {</a>
<a name="ln998">		BString intelExtendedPartition = &quot;Intel Extended Partition&quot;;</a>
<a name="ln999">		if (disk-&gt;ID() == selectedPartition) {</a>
<a name="ln1000">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1001">				&quot;want to format a raw disk? (Most people initialize the disk &quot;</a>
<a name="ln1002">				&quot;with a partitioning system first) You will be asked &quot;</a>
<a name="ln1003">				&quot;again before changes are written to the disk.&quot;));</a>
<a name="ln1004">		} else if (partition-&gt;ContentName()</a>
<a name="ln1005">			&amp;&amp; strlen(partition-&gt;ContentName()) &gt; 0) {</a>
<a name="ln1006">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1007">				&quot;want to format the partition \&quot;%s\&quot;? You will be asked &quot;</a>
<a name="ln1008">				&quot;again before changes are written to the disk.&quot;),</a>
<a name="ln1009">				partition-&gt;ContentName());</a>
<a name="ln1010">		} else if (partition-&gt;Type() == intelExtendedPartition) {</a>
<a name="ln1011">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1012">				&quot;want to format the Intel Extended Partition? Any &quot;</a>
<a name="ln1013">				&quot;subpartitions it contains will be overwritten if you &quot;</a>
<a name="ln1014">				&quot;continue. You will be asked again before changes are &quot;</a>
<a name="ln1015">				&quot;written to the disk.&quot;));</a>
<a name="ln1016">		} else {</a>
<a name="ln1017">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1018">				&quot;want to format the partition? You will be asked again &quot;</a>
<a name="ln1019">				&quot;before changes are written to the disk.&quot;));</a>
<a name="ln1020">		}</a>
<a name="ln1021">	} else {</a>
<a name="ln1022">		snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1023">			&quot;want to initialize the selected disk? All data will be lost. &quot;</a>
<a name="ln1024">			&quot;You will be asked again before changes are written to the &quot;</a>
<a name="ln1025">			&quot;disk.\n&quot;));</a>
<a name="ln1026">	}</a>
<a name="ln1027">	BAlert* alert = new BAlert(&quot;first notice&quot;, message,</a>
<a name="ln1028">		B_TRANSLATE(&quot;Continue&quot;), B_TRANSLATE(&quot;Cancel&quot;), NULL,</a>
<a name="ln1029">		B_WIDTH_FROM_WIDEST, B_WARNING_ALERT);</a>
<a name="ln1030">	alert-&gt;SetShortcut(1, B_ESCAPE);</a>
<a name="ln1031">	int32 choice = alert-&gt;Go();</a>
<a name="ln1032"> </a>
<a name="ln1033">	if (choice == 1)</a>
<a name="ln1034">		return;</a>
<a name="ln1035"> </a>
<a name="ln1036">	ModificationPreparer modificationPreparer(disk);</a>
<a name="ln1037">	status_t status = modificationPreparer.ModificationStatus();</a>
<a name="ln1038">	if (status != B_OK) {</a>
<a name="ln1039">		_DisplayPartitionError(B_TRANSLATE(&quot;There was an error preparing the &quot;</a>
<a name="ln1040">			&quot;disk for modifications.&quot;), NULL, status);</a>
<a name="ln1041">		return;</a>
<a name="ln1042">	}</a>
<a name="ln1043"> </a>
<a name="ln1044">	BString name;</a>
<a name="ln1045">	BString parameters;</a>
<a name="ln1046">	InitParametersPanel* panel = new InitParametersPanel(this, diskSystemName,</a>
<a name="ln1047">		partition);</a>
<a name="ln1048">	if (panel-&gt;Go(name, parameters) != B_OK)</a>
<a name="ln1049">		return;</a>
<a name="ln1050"> </a>
<a name="ln1051">	bool supportsName = diskSystem.SupportsContentName();</a>
<a name="ln1052">	BString validatedName(name);</a>
<a name="ln1053">	status = partition-&gt;ValidateInitialize(diskSystem.PrettyName(),</a>
<a name="ln1054">		supportsName ? &amp;validatedName : NULL, parameters.String());</a>
<a name="ln1055">	if (status != B_OK) {</a>
<a name="ln1056">		_DisplayPartitionError(B_TRANSLATE(&quot;Validation of the given &quot;</a>
<a name="ln1057">			&quot;initialization parameters failed.&quot;), partition, status);</a>
<a name="ln1058">		return;</a>
<a name="ln1059">	}</a>
<a name="ln1060"> </a>
<a name="ln1061">	BString previousName = partition-&gt;ContentName();</a>
<a name="ln1062"> </a>
<a name="ln1063">	status = partition-&gt;Initialize(diskSystem.PrettyName(),</a>
<a name="ln1064">		supportsName ? validatedName.String() : NULL, parameters.String());</a>
<a name="ln1065">	if (status != B_OK) {</a>
<a name="ln1066">		_DisplayPartitionError(B_TRANSLATE(&quot;Initialization of the partition &quot;</a>
<a name="ln1067">			&quot;%s failed. (Nothing has been written to disk.)&quot;), partition,</a>
<a name="ln1068">			status);</a>
<a name="ln1069">		return;</a>
<a name="ln1070">	}</a>
<a name="ln1071"> </a>
<a name="ln1072">	// Also set the partition name in the partition table if supported</a>
<a name="ln1073">	if (partition-&gt;CanSetName()</a>
<a name="ln1074">		&amp;&amp; partition-&gt;ValidateSetName(&amp;validatedName) == B_OK) {</a>
<a name="ln1075">		partition-&gt;SetName(validatedName.String());</a>
<a name="ln1076">	}</a>
<a name="ln1077"> </a>
<a name="ln1078">	// everything looks fine, we are ready to actually write the changes</a>
<a name="ln1079">	// to disk</a>
<a name="ln1080"> </a>
<a name="ln1081">	// Warn the user one more time...</a>
<a name="ln1082">	if (previousName.Length() &gt; 0) {</a>
<a name="ln1083">		if (partition-&gt;IsDevice()) {</a>
<a name="ln1084">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1085">				&quot;want to write the changes back to disk now?\n\n&quot;</a>
<a name="ln1086">				&quot;All data on the disk %s will be irretrievably lost if you &quot;</a>
<a name="ln1087">				&quot;do so!&quot;), previousName.String());</a>
<a name="ln1088">		} else {</a>
<a name="ln1089">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1090">				&quot;want to write the changes back to disk now?\n\n&quot;</a>
<a name="ln1091">				&quot;All data on the partition %s will be irretrievably lost if you &quot;</a>
<a name="ln1092">				&quot;do so!&quot;), previousName.String());</a>
<a name="ln1093">		}</a>
<a name="ln1094">	} else {</a>
<a name="ln1095">		if (partition-&gt;IsDevice()) {</a>
<a name="ln1096">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1097">				&quot;want to write the changes back to disk now?\n\n&quot;</a>
<a name="ln1098">				&quot;All data on the selected disk will be irretrievably lost if &quot;</a>
<a name="ln1099">				&quot;you do so!&quot;));</a>
<a name="ln1100">		} else {</a>
<a name="ln1101">			snprintf(message, sizeof(message), B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1102">				&quot;want to write the changes back to disk now?\n\n&quot;</a>
<a name="ln1103">				&quot;All data on the selected partition will be irretrievably lost &quot;</a>
<a name="ln1104">				&quot;if you do so!&quot;));</a>
<a name="ln1105">		}</a>
<a name="ln1106">	}</a>
<a name="ln1107">	alert = new BAlert(&quot;final notice&quot;, message,</a>
<a name="ln1108">		B_TRANSLATE(&quot;Write changes&quot;), B_TRANSLATE(&quot;Cancel&quot;), NULL,</a>
<a name="ln1109">		B_WIDTH_FROM_WIDEST, B_WARNING_ALERT);</a>
<a name="ln1110">	alert-&gt;SetShortcut(1, B_ESCAPE);</a>
<a name="ln1111">	choice = alert-&gt;Go();</a>
<a name="ln1112"> </a>
<a name="ln1113">	if (choice == 1)</a>
<a name="ln1114">		return;</a>
<a name="ln1115"> </a>
<a name="ln1116">	// commit</a>
<a name="ln1117">	status = modificationPreparer.CommitModifications();</a>
<a name="ln1118"> </a>
<a name="ln1119">	// The partition pointer is toast now! Use the partition ID to</a>
<a name="ln1120">	// retrieve it again.</a>
<a name="ln1121">	partition = disk-&gt;FindDescendant(selectedPartition);</a>
<a name="ln1122"> </a>
<a name="ln1123">	if (status == B_OK) {</a>
<a name="ln1124">		if (diskSystem.IsFileSystem()) {</a>
<a name="ln1125">			_DisplayPartitionError(B_TRANSLATE(&quot;The partition %s has been &quot;</a>
<a name="ln1126">				&quot;successfully formatted.\n&quot;), partition);</a>
<a name="ln1127">		} else {</a>
<a name="ln1128">			_DisplayPartitionError(B_TRANSLATE(&quot;The disk has been &quot;</a>
<a name="ln1129">				&quot;successfully initialized.\n&quot;), partition);</a>
<a name="ln1130">		}</a>
<a name="ln1131">	} else {</a>
<a name="ln1132">		if (diskSystem.IsFileSystem()) {</a>
<a name="ln1133">			_DisplayPartitionError(B_TRANSLATE(&quot;Failed to format the &quot;</a>
<a name="ln1134">				&quot;partition %s!\n&quot;), partition, status);</a>
<a name="ln1135">		} else {</a>
<a name="ln1136">			_DisplayPartitionError(B_TRANSLATE(&quot;Failed to initialize the &quot;</a>
<a name="ln1137">				&quot;disk %s!\n&quot;), partition, status);</a>
<a name="ln1138">		}</a>
<a name="ln1139">	}</a>
<a name="ln1140"> </a>
<a name="ln1141">	_ScanDrives();</a>
<a name="ln1142">}</a>
<a name="ln1143"> </a>
<a name="ln1144"> </a>
<a name="ln1145">void</a>
<a name="ln1146">MainWindow::_Create(BDiskDevice* disk, partition_id selectedPartition)</a>
<a name="ln1147">{</a>
<a name="ln1148">	if (!disk || selectedPartition &gt; -2) {</a>
<a name="ln1149">		_DisplayPartitionError(B_TRANSLATE(&quot;The currently selected partition &quot;</a>
<a name="ln1150">			&quot;is not empty.&quot;));</a>
<a name="ln1151">		return;</a>
<a name="ln1152">	}</a>
<a name="ln1153"> </a>
<a name="ln1154">	if (disk-&gt;IsReadOnly()) {</a>
<a name="ln1155">		_DisplayPartitionError(B_TRANSLATE(&quot;The selected disk is read-only.&quot;));</a>
<a name="ln1156">		return;</a>
<a name="ln1157">	}</a>
<a name="ln1158"> </a>
<a name="ln1159">	PartitionListRow* currentSelection = dynamic_cast&lt;PartitionListRow*&gt;(</a>
<a name="ln1160">		fListView-&gt;CurrentSelection());</a>
<a name="ln1161">	if (!currentSelection) {</a>
<a name="ln1162">		_DisplayPartitionError(B_TRANSLATE(&quot;There was an error acquiring the &quot;</a>
<a name="ln1163">			&quot;partition row.&quot;));</a>
<a name="ln1164">		return;</a>
<a name="ln1165">	}</a>
<a name="ln1166"> </a>
<a name="ln1167">	BPartition* parent = disk-&gt;FindDescendant(currentSelection-&gt;ParentID());</a>
<a name="ln1168">	if (!parent) {</a>
<a name="ln1169">		_DisplayPartitionError(B_TRANSLATE(&quot;The currently selected partition &quot;</a>
<a name="ln1170">			&quot;does not have a parent partition.&quot;));</a>
<a name="ln1171">		return;</a>
<a name="ln1172">	}</a>
<a name="ln1173"> </a>
<a name="ln1174">	if (!parent-&gt;ContainsPartitioningSystem()) {</a>
<a name="ln1175">		_DisplayPartitionError(B_TRANSLATE(&quot;The selected partition does not &quot;</a>
<a name="ln1176">			&quot;contain a partitioning system.&quot;));</a>
<a name="ln1177">		return;</a>
<a name="ln1178">	}</a>
<a name="ln1179"> </a>
<a name="ln1180">	ModificationPreparer modificationPreparer(disk);</a>
<a name="ln1181">	status_t status = modificationPreparer.ModificationStatus();</a>
<a name="ln1182">	if (status != B_OK) {</a>
<a name="ln1183">		_DisplayPartitionError(B_TRANSLATE(&quot;There was an error preparing the &quot;</a>
<a name="ln1184">			&quot;disk for modifications.&quot;), NULL, status);</a>
<a name="ln1185">		return;</a>
<a name="ln1186">	}</a>
<a name="ln1187"> </a>
<a name="ln1188">	// get partitioning info</a>
<a name="ln1189">	BPartitioningInfo partitioningInfo;</a>
<a name="ln1190">	status_t error = parent-&gt;GetPartitioningInfo(&amp;partitioningInfo);</a>
<a name="ln1191">	if (error != B_OK) {</a>
<a name="ln1192">		_DisplayPartitionError(B_TRANSLATE(&quot;Could not acquire partitioning &quot;</a>
<a name="ln1193">			&quot;information.&quot;));</a>
<a name="ln1194">		return;</a>
<a name="ln1195">	}</a>
<a name="ln1196"> </a>
<a name="ln1197">	int32 spacesCount = partitioningInfo.CountPartitionableSpaces();</a>
<a name="ln1198">	if (spacesCount == 0) {</a>
<a name="ln1199">		_DisplayPartitionError(B_TRANSLATE(&quot;There's no space on the partition &quot;</a>
<a name="ln1200">			&quot;where a child partition could be created.&quot;));</a>
<a name="ln1201">		return;</a>
<a name="ln1202">	}</a>
<a name="ln1203"> </a>
<a name="ln1204">	BString name, type, parameters;</a>
<a name="ln1205">	off_t offset = currentSelection-&gt;Offset();</a>
<a name="ln1206">	off_t size = currentSelection-&gt;Size();</a>
<a name="ln1207"> </a>
<a name="ln1208">	CreateParametersPanel* panel = new CreateParametersPanel(this, parent,</a>
<a name="ln1209">		offset, size);</a>
<a name="ln1210">	status = panel-&gt;Go(offset, size, name, type, parameters);</a>
<a name="ln1211">	if (status != B_OK) {</a>
<a name="ln1212">		if (status != B_CANCELED) {</a>
<a name="ln1213">			_DisplayPartitionError(B_TRANSLATE(&quot;The panel could not return &quot;</a>
<a name="ln1214">				&quot;successfully.&quot;), NULL, status);</a>
<a name="ln1215">		}</a>
<a name="ln1216">		return;</a>
<a name="ln1217">	}</a>
<a name="ln1218"> </a>
<a name="ln1219">	status = parent-&gt;ValidateCreateChild(&amp;offset, &amp;size, type.String(),</a>
<a name="ln1220">		&amp;name, parameters.String());</a>
<a name="ln1221"> </a>
<a name="ln1222">	if (status != B_OK) {</a>
<a name="ln1223">		_DisplayPartitionError(B_TRANSLATE(&quot;Validation of the given creation &quot;</a>
<a name="ln1224">			&quot;parameters failed.&quot;), NULL, status);</a>
<a name="ln1225">		return;</a>
<a name="ln1226">	}</a>
<a name="ln1227"> </a>
<a name="ln1228">	// Warn the user one more time...</a>
<a name="ln1229">	BAlert* alert = new BAlert(&quot;final notice&quot;, B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1230">		&quot;want to write the changes back to disk now?\n\n&quot;</a>
<a name="ln1231">		&quot;All data on the partition will be irretrievably lost if you do &quot;</a>
<a name="ln1232">		&quot;so!&quot;), B_TRANSLATE(&quot;Write changes&quot;), B_TRANSLATE(&quot;Cancel&quot;), NULL,</a>
<a name="ln1233">		B_WIDTH_FROM_WIDEST, B_WARNING_ALERT);</a>
<a name="ln1234">	alert-&gt;SetShortcut(1, B_ESCAPE);</a>
<a name="ln1235">	int32 choice = alert-&gt;Go();</a>
<a name="ln1236"> </a>
<a name="ln1237">	if (choice == 1)</a>
<a name="ln1238">		return;</a>
<a name="ln1239"> </a>
<a name="ln1240">	status = parent-&gt;CreateChild(offset, size, type.String(), name.String(),</a>
<a name="ln1241">		parameters.String());</a>
<a name="ln1242"> </a>
<a name="ln1243">	if (status != B_OK) {</a>
<a name="ln1244">		_DisplayPartitionError(B_TRANSLATE(&quot;Creation of the partition has &quot;</a>
<a name="ln1245">			&quot;failed.&quot;), NULL, status);</a>
<a name="ln1246">		return;</a>
<a name="ln1247">	}</a>
<a name="ln1248"> </a>
<a name="ln1249">	// commit</a>
<a name="ln1250">	status = modificationPreparer.CommitModifications();</a>
<a name="ln1251"> </a>
<a name="ln1252">	if (status != B_OK) {</a>
<a name="ln1253">		_DisplayPartitionError(B_TRANSLATE(&quot;Failed to format the &quot;</a>
<a name="ln1254">			&quot;partition. No changes have been written to disk.&quot;), NULL, status);</a>
<a name="ln1255">		return;</a>
<a name="ln1256">	}</a>
<a name="ln1257"> </a>
<a name="ln1258">	// The disk layout has changed, update disk information</a>
<a name="ln1259">	bool updated;</a>
<a name="ln1260">	status = disk-&gt;Update(&amp;updated);</a>
<a name="ln1261"> </a>
<a name="ln1262">	_ScanDrives();</a>
<a name="ln1263">	fDiskView-&gt;ForceUpdate();</a>
<a name="ln1264">}</a>
<a name="ln1265"> </a>
<a name="ln1266"> </a>
<a name="ln1267">void</a>
<a name="ln1268">MainWindow::_Delete(BDiskDevice* disk, partition_id selectedPartition)</a>
<a name="ln1269">{</a>
<a name="ln1270">	if (!disk || selectedPartition &lt; 0) {</a>
<a name="ln1271">		_DisplayPartitionError(B_TRANSLATE(&quot;You need to select a partition &quot;</a>
<a name="ln1272">			&quot;entry from the list.&quot;));</a>
<a name="ln1273">		return;</a>
<a name="ln1274">	}</a>
<a name="ln1275"> </a>
<a name="ln1276">	if (disk-&gt;IsReadOnly()) {</a>
<a name="ln1277">		_DisplayPartitionError(B_TRANSLATE(&quot;The selected disk is read-only.&quot;));</a>
<a name="ln1278">		return;</a>
<a name="ln1279">	}</a>
<a name="ln1280"> </a>
<a name="ln1281">	BPartition* partition = disk-&gt;FindDescendant(selectedPartition);</a>
<a name="ln1282">	if (!partition) {</a>
<a name="ln1283">		_DisplayPartitionError(B_TRANSLATE(&quot;Unable to find the selected &quot;</a>
<a name="ln1284">			&quot;partition by ID.&quot;));</a>
<a name="ln1285">		return;</a>
<a name="ln1286">	}</a>
<a name="ln1287"> </a>
<a name="ln1288">	BPartition* parent = partition-&gt;Parent();</a>
<a name="ln1289">	if (!parent) {</a>
<a name="ln1290">		_DisplayPartitionError(B_TRANSLATE(&quot;The currently selected partition &quot;</a>
<a name="ln1291">			&quot;does not have a parent partition.&quot;));</a>
<a name="ln1292">		return;</a>
<a name="ln1293">	}</a>
<a name="ln1294"> </a>
<a name="ln1295">	ModificationPreparer modificationPreparer(disk);</a>
<a name="ln1296">	status_t status = modificationPreparer.ModificationStatus();</a>
<a name="ln1297">	if (status != B_OK) {</a>
<a name="ln1298">		_DisplayPartitionError(B_TRANSLATE(&quot;There was an error preparing the &quot;</a>
<a name="ln1299">			&quot;disk for modifications.&quot;), NULL, status);</a>
<a name="ln1300">		return;</a>
<a name="ln1301">	}</a>
<a name="ln1302"> </a>
<a name="ln1303">	if (!parent-&gt;CanDeleteChild(partition-&gt;Index())) {</a>
<a name="ln1304">		_DisplayPartitionError(</a>
<a name="ln1305">			B_TRANSLATE(&quot;Cannot delete the selected partition.&quot;));</a>
<a name="ln1306">		return;</a>
<a name="ln1307">	}</a>
<a name="ln1308"> </a>
<a name="ln1309">	// Warn the user one more time...</a>
<a name="ln1310">	BAlert* alert = new BAlert(&quot;final notice&quot;, B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1311">		&quot;want to delete the selected partition?\n\n&quot;</a>
<a name="ln1312">		&quot;All data on the partition will be irretrievably lost if you &quot;</a>
<a name="ln1313">		&quot;do so!&quot;), B_TRANSLATE(&quot;Delete partition&quot;), B_TRANSLATE(&quot;Cancel&quot;), NULL,</a>
<a name="ln1314">		B_WIDTH_FROM_WIDEST, B_WARNING_ALERT);</a>
<a name="ln1315">	alert-&gt;SetShortcut(1, B_ESCAPE);</a>
<a name="ln1316">	int32 choice = alert-&gt;Go();</a>
<a name="ln1317"> </a>
<a name="ln1318">	if (choice == 1)</a>
<a name="ln1319">		return;</a>
<a name="ln1320"> </a>
<a name="ln1321">	status = parent-&gt;DeleteChild(partition-&gt;Index());</a>
<a name="ln1322">	if (status != B_OK) {</a>
<a name="ln1323">		_DisplayPartitionError(B_TRANSLATE(&quot;Could not delete the selected &quot;</a>
<a name="ln1324">			&quot;partition.&quot;), NULL, status);</a>
<a name="ln1325">		return;</a>
<a name="ln1326">	}</a>
<a name="ln1327"> </a>
<a name="ln1328">	status = modificationPreparer.CommitModifications();</a>
<a name="ln1329"> </a>
<a name="ln1330">	if (status != B_OK) {</a>
<a name="ln1331">		_DisplayPartitionError(B_TRANSLATE(&quot;Failed to delete the partition. &quot;</a>
<a name="ln1332">			&quot;No changes have been written to disk.&quot;), NULL, status);</a>
<a name="ln1333">		return;</a>
<a name="ln1334">	}</a>
<a name="ln1335"> </a>
<a name="ln1336">	_ScanDrives();</a>
<a name="ln1337">	fDiskView-&gt;ForceUpdate();</a>
<a name="ln1338">}</a>
<a name="ln1339"> </a>
<a name="ln1340"> </a>
<a name="ln1341">void</a>
<a name="ln1342">MainWindow::_ChangeParameters(BDiskDevice* disk, partition_id selectedPartition)</a>
<a name="ln1343">{</a>
<a name="ln1344">	if (disk == NULL || selectedPartition &lt; 0) {</a>
<a name="ln1345">		_DisplayPartitionError(B_TRANSLATE(&quot;You need to select a partition &quot;</a>
<a name="ln1346">			&quot;entry from the list.&quot;));</a>
<a name="ln1347">		return;</a>
<a name="ln1348">	}</a>
<a name="ln1349"> </a>
<a name="ln1350">	if (disk-&gt;IsReadOnly()) {</a>
<a name="ln1351">		_DisplayPartitionError(B_TRANSLATE(&quot;The selected disk is read-only.&quot;));</a>
<a name="ln1352">		return;</a>
<a name="ln1353">	}</a>
<a name="ln1354"> </a>
<a name="ln1355">	BPartition* partition = disk-&gt;FindDescendant(selectedPartition);</a>
<a name="ln1356">	if (partition == NULL) {</a>
<a name="ln1357">		_DisplayPartitionError(B_TRANSLATE(&quot;Unable to find the selected &quot;</a>
<a name="ln1358">			&quot;partition by ID.&quot;));</a>
<a name="ln1359">		return;</a>
<a name="ln1360">	}</a>
<a name="ln1361"> </a>
<a name="ln1362">	ModificationPreparer modificationPreparer(disk);</a>
<a name="ln1363">	status_t status = modificationPreparer.ModificationStatus();</a>
<a name="ln1364">	if (status != B_OK) {</a>
<a name="ln1365">		_DisplayPartitionError(B_TRANSLATE(&quot;There was an error preparing the &quot;</a>
<a name="ln1366">			&quot;disk for modifications.&quot;), NULL, status);</a>
<a name="ln1367">		return;</a>
<a name="ln1368">	}</a>
<a name="ln1369"> </a>
<a name="ln1370">	ChangeParametersPanel* panel = new ChangeParametersPanel(this, partition);</a>
<a name="ln1371"> </a>
<a name="ln1372">	BString name, type, parameters;</a>
<a name="ln1373">	status = panel-&gt;Go(name, type, parameters);</a>
<a name="ln1374">	if (status != B_OK) {</a>
<a name="ln1375">		if (status != B_CANCELED) {</a>
<a name="ln1376">			_DisplayPartitionError(B_TRANSLATE(&quot;The panel experienced a &quot;</a>
<a name="ln1377">				&quot;problem!&quot;), NULL, status);</a>
<a name="ln1378">		}</a>
<a name="ln1379">		// TODO: disk systems without an editor and support for name/type</a>
<a name="ln1380">		// changing will return B_CANCELED here -- we need to check this</a>
<a name="ln1381">		// before, and disable the menu entry instead</a>
<a name="ln1382">		return;</a>
<a name="ln1383">	}</a>
<a name="ln1384"> </a>
<a name="ln1385">	if (partition-&gt;CanSetType())</a>
<a name="ln1386">		status = partition-&gt;ValidateSetType(type.String());</a>
<a name="ln1387">	if (status == B_OK &amp;&amp; partition-&gt;CanSetName())</a>
<a name="ln1388">		status = partition-&gt;ValidateSetName(&amp;name);</a>
<a name="ln1389">	if (status != B_OK) {</a>
<a name="ln1390">		_DisplayPartitionError(B_TRANSLATE(&quot;Validation of the given parameters &quot;</a>
<a name="ln1391">			&quot;failed.&quot;));</a>
<a name="ln1392">		return;</a>
<a name="ln1393">	}</a>
<a name="ln1394"> </a>
<a name="ln1395">	// Warn the user one more time...</a>
<a name="ln1396">	BAlert* alert = new BAlert(&quot;final notice&quot;, B_TRANSLATE(&quot;Are you sure you &quot;</a>
<a name="ln1397">		&quot;want to change parameters of the selected partition?\n\n&quot;</a>
<a name="ln1398">		&quot;The partition may no longer be recognized by other operating systems &quot;</a>
<a name="ln1399">		&quot;anymore!&quot;), B_TRANSLATE(&quot;Change parameters&quot;), B_TRANSLATE(&quot;Cancel&quot;),</a>
<a name="ln1400">		NULL, B_WIDTH_FROM_WIDEST, B_WARNING_ALERT);</a>
<a name="ln1401">	alert-&gt;SetShortcut(1, B_ESCAPE);</a>
<a name="ln1402">	int32 choice = alert-&gt;Go();</a>
<a name="ln1403"> </a>
<a name="ln1404">	if (choice == 1)</a>
<a name="ln1405">		return;</a>
<a name="ln1406"> </a>
<a name="ln1407">	if (partition-&gt;CanSetType())</a>
<a name="ln1408">		status = partition-&gt;SetType(type.String());</a>
<a name="ln1409">	if (status == B_OK &amp;&amp; partition-&gt;CanSetName())</a>
<a name="ln1410">		status = partition-&gt;SetName(name.String());</a>
<a name="ln1411">	if (status == B_OK &amp;&amp; partition-&gt;CanEditParameters())</a>
<a name="ln1412">		status = partition-&gt;SetParameters(parameters.String());</a>
<a name="ln1413"> </a>
<a name="ln1414">	if (status != B_OK) {</a>
<a name="ln1415">		_DisplayPartitionError(</a>
<a name="ln1416">			B_TRANSLATE(&quot;Could not change the parameters of the selected &quot;</a>
<a name="ln1417">				&quot;partition.&quot;), NULL, status);</a>
<a name="ln1418">		return;</a>
<a name="ln1419">	}</a>
<a name="ln1420"> </a>
<a name="ln1421">	status = modificationPreparer.CommitModifications();</a>
<a name="ln1422"> </a>
<a name="ln1423">	if (status != B_OK) {</a>
<a name="ln1424">		_DisplayPartitionError(B_TRANSLATE(&quot;Failed to change the parameters &quot;</a>
<a name="ln1425">			&quot;of the partition. No changes have been written to disk.&quot;), NULL,</a>
<a name="ln1426">			status);</a>
<a name="ln1427">		return;</a>
<a name="ln1428">	}</a>
<a name="ln1429"> </a>
<a name="ln1430">	_ScanDrives();</a>
<a name="ln1431">	fDiskView-&gt;ForceUpdate();</a>
<a name="ln1432">}</a>
<a name="ln1433"> </a>
<a name="ln1434"> </a>
<a name="ln1435">float</a>
<a name="ln1436">MainWindow::_ColumnListViewHeight(BColumnListView* list, BRow* currentRow)</a>
<a name="ln1437">{</a>
<a name="ln1438">	float height = 0;</a>
<a name="ln1439">	int32 rows = list-&gt;CountRows(currentRow);</a>
<a name="ln1440">	for (int32 i = 0; i &lt; rows; i++) {</a>
<a name="ln1441">		BRow* row = list-&gt;RowAt(i, currentRow);</a>
<a name="ln1442">		height += row-&gt;Height() + 1;</a>
<a name="ln1443">		if (row-&gt;IsExpanded() &amp;&amp; list-&gt;CountRows(row) &gt; 0)</a>
<a name="ln1444">			height += _ColumnListViewHeight(list, row);</a>
<a name="ln1445">	}</a>
<a name="ln1446">	return height;</a>
<a name="ln1447">}</a>
<a name="ln1448"> </a>
<a name="ln1449"> </a>
<a name="ln1450">void</a>
<a name="ln1451">MainWindow::_UpdateWindowZoomLimits()</a>
<a name="ln1452">{</a>
<a name="ln1453">	float maxHeight = 0;</a>
<a name="ln1454">	int32 numColumns = fListView-&gt;CountColumns();</a>
<a name="ln1455">	BRow* parentRow = fListView-&gt;RowAt(0, NULL);</a>
<a name="ln1456">	BColumn* column = NULL;</a>
<a name="ln1457"> </a>
<a name="ln1458">	maxHeight += _ColumnListViewHeight(fListView, NULL);</a>
<a name="ln1459"> </a>
<a name="ln1460">	float maxWidth = fListView-&gt;LatchWidth();</a>
<a name="ln1461">	for (int32 i = 0; i &lt; numColumns; i++) {</a>
<a name="ln1462">		column = fListView-&gt;ColumnAt(i);</a>
<a name="ln1463">		maxWidth += column-&gt;Width();</a>
<a name="ln1464">	}</a>
<a name="ln1465"> </a>
<a name="ln1466">	maxHeight += B_H_SCROLL_BAR_HEIGHT;</a>
<a name="ln1467">	maxHeight += 1.5 * parentRow-&gt;Height();	// the label row</a>
<a name="ln1468">	maxHeight += fDiskView-&gt;Bounds().Height();</a>
<a name="ln1469">	maxHeight += fMenuBar-&gt;Bounds().Height();</a>
<a name="ln1470">	maxWidth += 1.5 * B_V_SCROLL_BAR_WIDTH;	// scroll bar &amp; borders</a>
<a name="ln1471"> </a>
<a name="ln1472">	SetZoomLimits(maxWidth, maxHeight);</a>
<a name="ln1473">}</a>
<a name="ln1474"> </a>

</code></pre>
<div class="balloon" rel="1238"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="1114"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="841"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="915"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="78"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: fLastPreparedDevice.</p></div>
<div class="balloon" rel="1319"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="1405"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="1034"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
