
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>KernelRequestHandler.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2001-2009, Ingo Weinhold, ingo_weinhold@gmx.de.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> */</a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;Compatibility.h&quot;</a>
<a name="ln7">#include &quot;Debug.h&quot;</a>
<a name="ln8">#include &quot;FileSystem.h&quot;</a>
<a name="ln9">#include &quot;KernelRequestHandler.h&quot;</a>
<a name="ln10">#include &quot;RequestPort.h&quot;</a>
<a name="ln11">#include &quot;Requests.h&quot;</a>
<a name="ln12">#include &quot;SingleReplyRequestHandler.h&quot;</a>
<a name="ln13">#include &quot;Volume.h&quot;</a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;NodeMonitor.h&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;AutoDeleter.h&gt;</a>
<a name="ln18"> </a>
<a name="ln19"> </a>
<a name="ln20">// VolumePutter</a>
<a name="ln21">class VolumePutter {</a>
<a name="ln22">public:</a>
<a name="ln23">	VolumePutter(Volume* volume) : fVolume(volume) {}</a>
<a name="ln24">	~VolumePutter()</a>
<a name="ln25">	{</a>
<a name="ln26">		if (fVolume)</a>
<a name="ln27">			fVolume-&gt;ReleaseReference();</a>
<a name="ln28">	}</a>
<a name="ln29"> </a>
<a name="ln30">private:</a>
<a name="ln31">	Volume	*fVolume;</a>
<a name="ln32">};</a>
<a name="ln33"> </a>
<a name="ln34">// constructor</a>
<a name="ln35">KernelRequestHandler::KernelRequestHandler(Volume* volume, uint32 expectedReply)</a>
<a name="ln36">	: RequestHandler(),</a>
<a name="ln37">	  fFileSystem(volume-&gt;GetFileSystem()),</a>
<a name="ln38">	  fVolume(volume),</a>
<a name="ln39">	  fExpectedReply(expectedReply)</a>
<a name="ln40">{</a>
<a name="ln41">}</a>
<a name="ln42"> </a>
<a name="ln43">// constructor</a>
<a name="ln44">KernelRequestHandler::KernelRequestHandler(FileSystem* fileSystem,</a>
<a name="ln45">	uint32 expectedReply)</a>
<a name="ln46">	: RequestHandler(),</a>
<a name="ln47">	  fFileSystem(fileSystem),</a>
<a name="ln48">	  fVolume(NULL),</a>
<a name="ln49">	  fExpectedReply(expectedReply)</a>
<a name="ln50">{</a>
<a name="ln51">}</a>
<a name="ln52"> </a>
<a name="ln53">// destructor</a>
<a name="ln54">KernelRequestHandler::~KernelRequestHandler()</a>
<a name="ln55">{</a>
<a name="ln56">}</a>
<a name="ln57"> </a>
<a name="ln58">// HandleRequest</a>
<a name="ln59">status_t</a>
<a name="ln60">KernelRequestHandler::HandleRequest(Request* request)</a>
<a name="ln61">{</a>
<a name="ln62">	if (request-&gt;GetType() == fExpectedReply) {</a>
<a name="ln63">		fDone = true;</a>
<a name="ln64">		return B_OK;</a>
<a name="ln65">	}</a>
<a name="ln66">	switch (request-&gt;GetType()) {</a>
<a name="ln67">		// notifications</a>
<a name="ln68">		case NOTIFY_LISTENER_REQUEST:</a>
<a name="ln69">			return _HandleRequest((NotifyListenerRequest*)request);</a>
<a name="ln70">		case NOTIFY_SELECT_EVENT_REQUEST:</a>
<a name="ln71">			return _HandleRequest((NotifySelectEventRequest*)request);</a>
<a name="ln72">		case NOTIFY_QUERY_REQUEST:</a>
<a name="ln73">			return _HandleRequest((NotifyQueryRequest*)request);</a>
<a name="ln74">		// vnodes</a>
<a name="ln75">		case GET_VNODE_REQUEST:</a>
<a name="ln76">			return _HandleRequest((GetVNodeRequest*)request);</a>
<a name="ln77">		case PUT_VNODE_REQUEST:</a>
<a name="ln78">			return _HandleRequest((PutVNodeRequest*)request);</a>
<a name="ln79">		case ACQUIRE_VNODE_REQUEST:</a>
<a name="ln80">			return _HandleRequest((AcquireVNodeRequest*)request);</a>
<a name="ln81">		case NEW_VNODE_REQUEST:</a>
<a name="ln82">			return _HandleRequest((NewVNodeRequest*)request);</a>
<a name="ln83">		case PUBLISH_VNODE_REQUEST:</a>
<a name="ln84">			return _HandleRequest((PublishVNodeRequest*)request);</a>
<a name="ln85">		case REMOVE_VNODE_REQUEST:</a>
<a name="ln86">			return _HandleRequest((RemoveVNodeRequest*)request);</a>
<a name="ln87">		case UNREMOVE_VNODE_REQUEST:</a>
<a name="ln88">			return _HandleRequest((UnremoveVNodeRequest*)request);</a>
<a name="ln89">		case GET_VNODE_REMOVED_REQUEST:</a>
<a name="ln90">			return _HandleRequest((GetVNodeRemovedRequest*)request);</a>
<a name="ln91">		// file cache</a>
<a name="ln92">		case FILE_CACHE_CREATE_REQUEST:</a>
<a name="ln93">			return _HandleRequest((FileCacheCreateRequest*)request);</a>
<a name="ln94">		case FILE_CACHE_DELETE_REQUEST:</a>
<a name="ln95">			return _HandleRequest((FileCacheDeleteRequest*)request);</a>
<a name="ln96">		case FILE_CACHE_SET_ENABLED_REQUEST:</a>
<a name="ln97">			return _HandleRequest((FileCacheSetEnabledRequest*)request);</a>
<a name="ln98">		case FILE_CACHE_SET_SIZE_REQUEST:</a>
<a name="ln99">			return _HandleRequest((FileCacheSetSizeRequest*)request);</a>
<a name="ln100">		case FILE_CACHE_SYNC_REQUEST:</a>
<a name="ln101">			return _HandleRequest((FileCacheSyncRequest*)request);</a>
<a name="ln102">		case FILE_CACHE_READ_REQUEST:</a>
<a name="ln103">			return _HandleRequest((FileCacheReadRequest*)request);</a>
<a name="ln104">		case FILE_CACHE_WRITE_REQUEST:</a>
<a name="ln105">			return _HandleRequest((FileCacheWriteRequest*)request);</a>
<a name="ln106">		// I/O</a>
<a name="ln107">		case DO_ITERATIVE_FD_IO_REQUEST:</a>
<a name="ln108">			return _HandleRequest((DoIterativeFDIORequest*)request);</a>
<a name="ln109">		case READ_FROM_IO_REQUEST_REQUEST:</a>
<a name="ln110">			return _HandleRequest((ReadFromIORequestRequest*)request);</a>
<a name="ln111">		case WRITE_TO_IO_REQUEST_REQUEST:</a>
<a name="ln112">			return _HandleRequest((WriteToIORequestRequest*)request);</a>
<a name="ln113">		case NOTIFY_IO_REQUEST_REQUEST:</a>
<a name="ln114">			return _HandleRequest((NotifyIORequestRequest*)request);</a>
<a name="ln115">		// node monitoring</a>
<a name="ln116">		case ADD_NODE_LISTENER_REQUEST:</a>
<a name="ln117">			return _HandleRequest((AddNodeListenerRequest*)request);</a>
<a name="ln118">		case REMOVE_NODE_LISTENER_REQUEST:</a>
<a name="ln119">			return _HandleRequest((RemoveNodeListenerRequest*)request);</a>
<a name="ln120">	}</a>
<a name="ln121"> </a>
<a name="ln122">	PRINT((&quot;KernelRequestHandler::HandleRequest(): unexpected request: %&quot;</a>
<a name="ln123">		B_PRIu32 &quot;\n&quot;, request-&gt;GetType()));</a>
<a name="ln124">	return B_BAD_DATA;</a>
<a name="ln125">}</a>
<a name="ln126"> </a>
<a name="ln127">// #pragma mark -</a>
<a name="ln128">// #pragma mark ----- notifications -----</a>
<a name="ln129"> </a>
<a name="ln130">// _HandleRequest</a>
<a name="ln131">status_t</a>
<a name="ln132">KernelRequestHandler::_HandleRequest(NotifyListenerRequest* request)</a>
<a name="ln133">{</a>
<a name="ln134">	// check and execute the request</a>
<a name="ln135">	status_t result = B_OK;</a>
<a name="ln136">	if (fVolume &amp;&amp; request-&gt;device != fVolume-&gt;GetID())</a>
<a name="ln137">		result = B_BAD_VALUE;</a>
<a name="ln138"> </a>
<a name="ln139">	// get the names</a>
<a name="ln140">	// name</a>
<a name="ln141">	char* name = (char*)request-&gt;name.GetData();</a>
<a name="ln142">	int32 nameLen = request-&gt;name.GetSize();</a>
<a name="ln143">	if (name &amp;&amp; (nameLen &lt;= 0))</a>
<a name="ln144">		name = NULL;</a>
<a name="ln145">	else if (name)</a>
<a name="ln146">		name[nameLen - 1] = '\0';	// NULL-terminate to be safe</a>
<a name="ln147"> </a>
<a name="ln148">	// old name</a>
<a name="ln149">	char* oldName = (char*)request-&gt;oldName.GetData();</a>
<a name="ln150">	int32 oldNameLen = request-&gt;oldName.GetSize();</a>
<a name="ln151">	if (oldName &amp;&amp; (oldNameLen &lt;= 0))</a>
<a name="ln152">		oldName = NULL;</a>
<a name="ln153">	else if (oldName)</a>
<a name="ln154">		oldName[oldNameLen - 1] = '\0';	// NULL-terminate to be safe</a>
<a name="ln155"> </a>
<a name="ln156">	// check the names</a>
<a name="ln157">	if (result == B_OK) {</a>
<a name="ln158">		switch (request-&gt;operation) {</a>
<a name="ln159">			case B_ENTRY_MOVED:</a>
<a name="ln160">				if (!oldName) {</a>
<a name="ln161">					ERROR((&quot;NotifyListenerRequest: NULL oldName for &quot;</a>
<a name="ln162">						&quot;B_ENTRY_MOVED\n&quot;));</a>
<a name="ln163">					result = B_BAD_VALUE;</a>
<a name="ln164">					break;</a>
<a name="ln165">				}</a>
<a name="ln166">				// fall through...</a>
<a name="ln167">			case B_ENTRY_CREATED:</a>
<a name="ln168">			case B_ENTRY_REMOVED:</a>
<a name="ln169">			case B_ATTR_CHANGED:</a>
<a name="ln170">				if (!name) {</a>
<a name="ln171">					ERROR((&quot;NotifyListenerRequest: NULL name for opcode: %&quot;</a>
<a name="ln172">						B_PRId32 &quot;\n&quot;, request-&gt;operation));</a>
<a name="ln173">					result = B_BAD_VALUE;</a>
<a name="ln174">				}</a>
<a name="ln175">				break;</a>
<a name="ln176">			case B_STAT_CHANGED:</a>
<a name="ln177">				break;</a>
<a name="ln178">		}</a>
<a name="ln179">	}</a>
<a name="ln180"> </a>
<a name="ln181">	// execute the request</a>
<a name="ln182">	if (result == B_OK) {</a>
<a name="ln183">		switch (request-&gt;operation) {</a>
<a name="ln184">			case B_ENTRY_CREATED:</a>
<a name="ln185">				PRINT((&quot;notify_entry_created(%&quot; B_PRId32 &quot;, %&quot; B_PRId64 &quot;, &quot;</a>
<a name="ln186">					&quot;\&quot;%s\&quot;, %&quot; B_PRId64 &quot;)\n&quot;, request-&gt;device,</a>
<a name="ln187">					request-&gt;directory, name, request-&gt;node));</a>
<a name="ln188">				result = notify_entry_created(request-&gt;device,</a>
<a name="ln189">					request-&gt;directory, name, request-&gt;node);</a>
<a name="ln190">				break;</a>
<a name="ln191"> </a>
<a name="ln192">			case B_ENTRY_REMOVED:</a>
<a name="ln193">				PRINT((&quot;notify_entry_removed(%&quot; B_PRId32 &quot;, %&quot; B_PRId64 &quot;, &quot;</a>
<a name="ln194">					&quot;\&quot;%s\&quot;, %&quot; B_PRId64 &quot;)\n&quot;, request-&gt;device,</a>
<a name="ln195">					request-&gt;directory, name, request-&gt;node));</a>
<a name="ln196">				result = notify_entry_removed(request-&gt;device,</a>
<a name="ln197">					request-&gt;directory, name, request-&gt;node);</a>
<a name="ln198">				break;</a>
<a name="ln199"> </a>
<a name="ln200">			case B_ENTRY_MOVED:</a>
<a name="ln201">				PRINT((&quot;notify_entry_moved(%&quot; B_PRId32 &quot;, %&quot; B_PRId64 &quot;, &quot;</a>
<a name="ln202">					&quot;\&quot;%s\&quot;, %&quot; B_PRId64 &quot;, \&quot;%s\&quot;, %&quot; B_PRId64 &quot;)\n&quot;,</a>
<a name="ln203">					request-&gt;device, request-&gt;oldDirectory, oldName,</a>
<a name="ln204">					request-&gt;directory, name, request-&gt;node));</a>
<a name="ln205">				result = notify_entry_moved(request-&gt;device,</a>
<a name="ln206">					request-&gt;oldDirectory, oldName, request-&gt;directory, name,</a>
<a name="ln207">					request-&gt;node);</a>
<a name="ln208">				break;</a>
<a name="ln209"> </a>
<a name="ln210">			case B_STAT_CHANGED:</a>
<a name="ln211">				PRINT((&quot;notify_stat_changed(%&quot; B_PRId32 &quot;, %&quot; B_PRId64 &quot;, &quot;</a>
<a name="ln212">					&quot;0x%&quot; B_PRIx32 &quot;)\n&quot;, request-&gt;device, request-&gt;node,</a>
<a name="ln213">					request-&gt;details));</a>
<a name="ln214">				result = notify_stat_changed(request-&gt;device,</a>
<a name="ln215">					request-&gt;directory, request-&gt;node, request-&gt;details);</a>
<a name="ln216">				break;</a>
<a name="ln217"> </a>
<a name="ln218">			case B_ATTR_CHANGED:</a>
<a name="ln219">				PRINT((&quot;notify_attribute_changed(%&quot; B_PRId32 &quot;, %&quot; B_PRId64 &quot;, &quot;</a>
<a name="ln220">					&quot;\&quot;%s\&quot;, 0x%&quot; B_PRIx32 &quot;)\n&quot;, request-&gt;device,</a>
<a name="ln221">					request-&gt;node, name, (int32)request-&gt;details));</a>
<a name="ln222">				result = notify_attribute_changed(request-&gt;device,</a>
<a name="ln223">					request-&gt;directory, request-&gt;node, name,</a>
<a name="ln224">					(int32)request-&gt;details);</a>
<a name="ln225">				break;</a>
<a name="ln226"> </a>
<a name="ln227">			default:</a>
<a name="ln228">				ERROR((&quot;NotifyQueryRequest: unsupported operation: %&quot; B_PRId32</a>
<a name="ln229">					&quot;\n&quot;, request-&gt;operation));</a>
<a name="ln230">				result = B_BAD_VALUE;</a>
<a name="ln231">				break;</a>
<a name="ln232">		}</a>
<a name="ln233">	}</a>
<a name="ln234"> </a>
<a name="ln235">	// prepare the reply</a>
<a name="ln236">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln237">	NotifyListenerReply* reply;</a>
<a name="ln238">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln239">	if (error != B_OK)</a>
<a name="ln240">		return error;</a>
<a name="ln241"> </a>
<a name="ln242">	reply-&gt;error = result;</a>
<a name="ln243"> </a>
<a name="ln244">	// send the reply</a>
<a name="ln245">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln246">}</a>
<a name="ln247"> </a>
<a name="ln248">// _HandleRequest</a>
<a name="ln249">status_t</a>
<a name="ln250">KernelRequestHandler::_HandleRequest(NotifySelectEventRequest* request)</a>
<a name="ln251">{</a>
<a name="ln252">	// check and execute the request</a>
<a name="ln253">	status_t result = B_OK;</a>
<a name="ln254">	if (fFileSystem-&gt;KnowsSelectSyncEntry(request-&gt;sync)) {</a>
<a name="ln255">		if (request-&gt;unspecifiedEvent) {</a>
<a name="ln256">			// old style add-ons can't provide an event argument; we shoot</a>
<a name="ln257">			// all events</a>
<a name="ln258">			notify_select_event(request-&gt;sync, B_SELECT_READ);</a>
<a name="ln259">			notify_select_event(request-&gt;sync, B_SELECT_WRITE);</a>
<a name="ln260">			notify_select_event(request-&gt;sync, B_SELECT_ERROR);</a>
<a name="ln261">		} else {</a>
<a name="ln262">			PRINT((&quot;notify_select_event(%p, %d)\n&quot;, request-&gt;sync,</a>
<a name="ln263">				(int)request-&gt;event));</a>
<a name="ln264">			notify_select_event(request-&gt;sync, request-&gt;event);</a>
<a name="ln265">		}</a>
<a name="ln266">	} else</a>
<a name="ln267">		result = B_BAD_VALUE;</a>
<a name="ln268"> </a>
<a name="ln269">	// prepare the reply</a>
<a name="ln270">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln271">	NotifySelectEventReply* reply;</a>
<a name="ln272">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln273">	if (error != B_OK)</a>
<a name="ln274">		return error;</a>
<a name="ln275"> </a>
<a name="ln276">	reply-&gt;error = result;</a>
<a name="ln277"> </a>
<a name="ln278">	// send the reply</a>
<a name="ln279">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln280">}</a>
<a name="ln281"> </a>
<a name="ln282">// _HandleRequest</a>
<a name="ln283">status_t</a>
<a name="ln284">KernelRequestHandler::_HandleRequest(NotifyQueryRequest* request)</a>
<a name="ln285">{</a>
<a name="ln286">	// check and execute the request</a>
<a name="ln287">	status_t result = B_OK;</a>
<a name="ln288">	if (fVolume &amp;&amp; request-&gt;device != fVolume-&gt;GetID())</a>
<a name="ln289">		result = B_BAD_VALUE;</a>
<a name="ln290"> </a>
<a name="ln291">	// check the name</a>
<a name="ln292">	char* name = (char*)request-&gt;name.GetData();</a>
<a name="ln293">	int32 nameLen = request-&gt;name.GetSize();</a>
<a name="ln294">	if (!name || nameLen &lt;= 0) {</a>
<a name="ln295">		ERROR((&quot;NotifyQueryRequest: NULL name!\n&quot;));</a>
<a name="ln296">		result = B_BAD_VALUE;</a>
<a name="ln297">	} else</a>
<a name="ln298">		name[nameLen - 1] = '\0';	// NULL-terminate to be safe</a>
<a name="ln299"> </a>
<a name="ln300">	// execute the request</a>
<a name="ln301">	if (result == B_OK) {</a>
<a name="ln302">		switch (request-&gt;operation) {</a>
<a name="ln303">			case B_ENTRY_CREATED:</a>
<a name="ln304">				PRINT((&quot;notify_query_entry_created(%&quot; B_PRId32 &quot;, %&quot; B_PRId32</a>
<a name="ln305">					&quot;, %&quot; B_PRId32 &quot;, %&quot; B_PRId64 &quot;, \&quot;%s\&quot;, %&quot; B_PRId64 &quot;)\n&quot;,</a>
<a name="ln306">					request-&gt;port, request-&gt;token, request-&gt;device,</a>
<a name="ln307">					request-&gt;directory, name, request-&gt;node));</a>
<a name="ln308">				result = notify_query_entry_created(request-&gt;port,</a>
<a name="ln309">					request-&gt;token, request-&gt;device, request-&gt;directory, name,</a>
<a name="ln310">					request-&gt;node);</a>
<a name="ln311">				break;</a>
<a name="ln312"> </a>
<a name="ln313">			case B_ENTRY_REMOVED:</a>
<a name="ln314">				PRINT((&quot;notify_query_entry_removed(%&quot; B_PRId32 &quot;, %&quot; B_PRId32</a>
<a name="ln315">					&quot;, %&quot; B_PRId32 &quot;, %&quot; B_PRId64 &quot;, \&quot;%s\&quot;, %&quot; B_PRId64 &quot;)\n&quot;,</a>
<a name="ln316">					request-&gt;port, request-&gt;token, request-&gt;device,</a>
<a name="ln317">					request-&gt;directory, name, request-&gt;node));</a>
<a name="ln318">				result = notify_query_entry_removed(request-&gt;port,</a>
<a name="ln319">					request-&gt;token, request-&gt;device, request-&gt;directory, name,</a>
<a name="ln320">					request-&gt;node);</a>
<a name="ln321">				break;</a>
<a name="ln322"> </a>
<a name="ln323">			case B_ENTRY_MOVED:</a>
<a name="ln324">			default:</a>
<a name="ln325">				ERROR((&quot;NotifyQueryRequest: unsupported operation: %&quot; B_PRId32</a>
<a name="ln326">					&quot;\n&quot;, request-&gt;operation));</a>
<a name="ln327">				result = B_BAD_VALUE;</a>
<a name="ln328">				break;</a>
<a name="ln329">		}</a>
<a name="ln330">	}</a>
<a name="ln331"> </a>
<a name="ln332">	// prepare the reply</a>
<a name="ln333">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln334">	NotifyQueryReply* reply;</a>
<a name="ln335">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln336">	if (error != B_OK)</a>
<a name="ln337">		return error;</a>
<a name="ln338"> </a>
<a name="ln339">	reply-&gt;error = result;</a>
<a name="ln340"> </a>
<a name="ln341">	// send the reply</a>
<a name="ln342">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln343">}</a>
<a name="ln344"> </a>
<a name="ln345">// #pragma mark -</a>
<a name="ln346">// #pragma mark ----- vnodes -----</a>
<a name="ln347"> </a>
<a name="ln348">// _HandleRequest</a>
<a name="ln349">status_t</a>
<a name="ln350">KernelRequestHandler::_HandleRequest(GetVNodeRequest* request)</a>
<a name="ln351">{</a>
<a name="ln352">	// check and execute the request</a>
<a name="ln353">	Volume* volume = NULL;</a>
<a name="ln354">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln355">	VolumePutter _(volume);</a>
<a name="ln356">	void* node;</a>
<a name="ln357">	if (result == B_OK)</a>
<a name="ln358">		result = volume-&gt;GetVNode(request-&gt;vnid, &amp;node);</a>
<a name="ln359">	// prepare the reply</a>
<a name="ln360">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln361">	GetVNodeReply* reply;</a>
<a name="ln362">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln363">	if (error != B_OK)</a>
<a name="ln364">		return error;</a>
<a name="ln365">	reply-&gt;error = result;</a>
<a name="ln366">	reply-&gt;node = node;</a>
<a name="ln367">	// send the reply</a>
<a name="ln368">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln369">}</a>
<a name="ln370"> </a>
<a name="ln371">// _HandleRequest</a>
<a name="ln372">status_t</a>
<a name="ln373">KernelRequestHandler::_HandleRequest(PutVNodeRequest* request)</a>
<a name="ln374">{</a>
<a name="ln375">	// check and execute the request</a>
<a name="ln376">	Volume* volume = NULL;</a>
<a name="ln377">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln378">	VolumePutter _(volume);</a>
<a name="ln379">	if (result == B_OK)</a>
<a name="ln380">		result = volume-&gt;PutVNode(request-&gt;vnid);</a>
<a name="ln381">	// prepare the reply</a>
<a name="ln382">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln383">	PutVNodeReply* reply;</a>
<a name="ln384">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln385">	if (error != B_OK)</a>
<a name="ln386">		return error;</a>
<a name="ln387">	reply-&gt;error = result;</a>
<a name="ln388">	// send the reply</a>
<a name="ln389">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln390">}</a>
<a name="ln391"> </a>
<a name="ln392"> </a>
<a name="ln393">// _HandleRequest</a>
<a name="ln394">status_t</a>
<a name="ln395">KernelRequestHandler::_HandleRequest(AcquireVNodeRequest* request)</a>
<a name="ln396">{</a>
<a name="ln397">	// check and execute the request</a>
<a name="ln398">	Volume* volume = NULL;</a>
<a name="ln399">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln400">	VolumePutter _(volume);</a>
<a name="ln401">	if (result == B_OK)</a>
<a name="ln402">		result = volume-&gt;AcquireVNode(request-&gt;vnid);</a>
<a name="ln403"> </a>
<a name="ln404">	// prepare the reply</a>
<a name="ln405">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln406">	AcquireVNodeReply* reply;</a>
<a name="ln407">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln408">	if (error != B_OK)</a>
<a name="ln409">		return error;</a>
<a name="ln410">	reply-&gt;error = result;</a>
<a name="ln411"> </a>
<a name="ln412">	// send the reply</a>
<a name="ln413">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln414">}</a>
<a name="ln415"> </a>
<a name="ln416"> </a>
<a name="ln417">// _HandleRequest</a>
<a name="ln418">status_t</a>
<a name="ln419">KernelRequestHandler::_HandleRequest(NewVNodeRequest* request)</a>
<a name="ln420">{</a>
<a name="ln421">	// check and execute the request</a>
<a name="ln422">	Volume* volume = NULL;</a>
<a name="ln423">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln424">	VolumePutter _(volume);</a>
<a name="ln425">	if (result == B_OK) {</a>
<a name="ln426">		result = volume-&gt;NewVNode(request-&gt;vnid, request-&gt;node,</a>
<a name="ln427">			request-&gt;capabilities);</a>
<a name="ln428">	}</a>
<a name="ln429"> </a>
<a name="ln430">	// prepare the reply</a>
<a name="ln431">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln432">	NewVNodeReply* reply;</a>
<a name="ln433">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln434">	if (error != B_OK)</a>
<a name="ln435">		return error;</a>
<a name="ln436">	reply-&gt;error = result;</a>
<a name="ln437"> </a>
<a name="ln438">	// send the reply</a>
<a name="ln439">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln440">}</a>
<a name="ln441"> </a>
<a name="ln442">// _HandleRequest</a>
<a name="ln443">status_t</a>
<a name="ln444">KernelRequestHandler::_HandleRequest(PublishVNodeRequest* request)</a>
<a name="ln445">{</a>
<a name="ln446">	// check and execute the request</a>
<a name="ln447">	Volume* volume = NULL;</a>
<a name="ln448">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln449">	VolumePutter _(volume);</a>
<a name="ln450">	if (result == B_OK) {</a>
<a name="ln451">		result = volume-&gt;PublishVNode(request-&gt;vnid, request-&gt;node,</a>
<a name="ln452">			request-&gt;type, request-&gt;flags, request-&gt;capabilities);</a>
<a name="ln453">	}</a>
<a name="ln454"> </a>
<a name="ln455">	// prepare the reply</a>
<a name="ln456">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln457">	PublishVNodeReply* reply;</a>
<a name="ln458">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln459">	if (error != B_OK)</a>
<a name="ln460">		return error;</a>
<a name="ln461"> </a>
<a name="ln462">	reply-&gt;error = result;</a>
<a name="ln463"> </a>
<a name="ln464">	// send the reply</a>
<a name="ln465">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln466">}</a>
<a name="ln467"> </a>
<a name="ln468">// _HandleRequest</a>
<a name="ln469">status_t</a>
<a name="ln470">KernelRequestHandler::_HandleRequest(RemoveVNodeRequest* request)</a>
<a name="ln471">{</a>
<a name="ln472">	// check and execute the request</a>
<a name="ln473">	Volume* volume = NULL;</a>
<a name="ln474">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln475">	VolumePutter _(volume);</a>
<a name="ln476">	if (result == B_OK)</a>
<a name="ln477">		result = volume-&gt;RemoveVNode(request-&gt;vnid);</a>
<a name="ln478">	// prepare the reply</a>
<a name="ln479">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln480">	RemoveVNodeReply* reply;</a>
<a name="ln481">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln482">	if (error != B_OK)</a>
<a name="ln483">		return error;</a>
<a name="ln484">	reply-&gt;error = result;</a>
<a name="ln485">	// send the reply</a>
<a name="ln486">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln487">}</a>
<a name="ln488"> </a>
<a name="ln489">// _HandleRequest</a>
<a name="ln490">status_t</a>
<a name="ln491">KernelRequestHandler::_HandleRequest(UnremoveVNodeRequest* request)</a>
<a name="ln492">{</a>
<a name="ln493">	// check and execute the request</a>
<a name="ln494">	Volume* volume = NULL;</a>
<a name="ln495">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln496">	VolumePutter _(volume);</a>
<a name="ln497">	if (result == B_OK)</a>
<a name="ln498">		result = volume-&gt;UnremoveVNode(request-&gt;vnid);</a>
<a name="ln499">	// prepare the reply</a>
<a name="ln500">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln501">	UnremoveVNodeReply* reply;</a>
<a name="ln502">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln503">	if (error != B_OK)</a>
<a name="ln504">		return error;</a>
<a name="ln505">	reply-&gt;error = result;</a>
<a name="ln506">	// send the reply</a>
<a name="ln507">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln508">}</a>
<a name="ln509"> </a>
<a name="ln510">// _HandleRequest</a>
<a name="ln511">status_t</a>
<a name="ln512">KernelRequestHandler::_HandleRequest(GetVNodeRemovedRequest* request)</a>
<a name="ln513">{</a>
<a name="ln514">	// check and execute the request</a>
<a name="ln515">	Volume* volume = NULL;</a>
<a name="ln516">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln517">	VolumePutter _(volume);</a>
<a name="ln518">	bool removed = false;</a>
<a name="ln519">	if (result == B_OK)</a>
<a name="ln520">		result = volume-&gt;GetVNodeRemoved(request-&gt;vnid, &amp;removed);</a>
<a name="ln521"> </a>
<a name="ln522">	// prepare the reply</a>
<a name="ln523">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln524">	GetVNodeRemovedReply* reply;</a>
<a name="ln525">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln526">	if (error != B_OK)</a>
<a name="ln527">		return error;</a>
<a name="ln528"> </a>
<a name="ln529">	reply-&gt;error = result;</a>
<a name="ln530">	reply-&gt;removed = removed;</a>
<a name="ln531"> </a>
<a name="ln532">	// send the reply</a>
<a name="ln533">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln534">}</a>
<a name="ln535"> </a>
<a name="ln536"> </a>
<a name="ln537">// _HandleRequest</a>
<a name="ln538">status_t</a>
<a name="ln539">KernelRequestHandler::_HandleRequest(FileCacheCreateRequest* request)</a>
<a name="ln540">{</a>
<a name="ln541">	// check and execute the request</a>
<a name="ln542">	Volume* volume = NULL;</a>
<a name="ln543">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln544">	VolumePutter _(volume);</a>
<a name="ln545"> </a>
<a name="ln546">	if (result == B_OK)</a>
<a name="ln547">		result = volume-&gt;CreateFileCache(request-&gt;vnid, request-&gt;size);</a>
<a name="ln548"> </a>
<a name="ln549">	// prepare the reply</a>
<a name="ln550">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln551">	FileCacheCreateReply* reply;</a>
<a name="ln552">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln553">	if (error != B_OK)</a>
<a name="ln554">		return error;</a>
<a name="ln555">	reply-&gt;error = result;</a>
<a name="ln556"> </a>
<a name="ln557">	// send the reply</a>
<a name="ln558">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln559">}</a>
<a name="ln560"> </a>
<a name="ln561"> </a>
<a name="ln562">// _HandleRequest</a>
<a name="ln563">status_t</a>
<a name="ln564">KernelRequestHandler::_HandleRequest(FileCacheDeleteRequest* request)</a>
<a name="ln565">{</a>
<a name="ln566">	// check and execute the request</a>
<a name="ln567">	Volume* volume = NULL;</a>
<a name="ln568">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln569">	VolumePutter _(volume);</a>
<a name="ln570"> </a>
<a name="ln571">	if (result == B_OK)</a>
<a name="ln572">		result = volume-&gt;DeleteFileCache(request-&gt;vnid);</a>
<a name="ln573"> </a>
<a name="ln574">	// prepare the reply</a>
<a name="ln575">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln576">	FileCacheDeleteReply* reply;</a>
<a name="ln577">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln578">	if (error != B_OK)</a>
<a name="ln579">		return error;</a>
<a name="ln580">	reply-&gt;error = result;</a>
<a name="ln581"> </a>
<a name="ln582">	// send the reply</a>
<a name="ln583">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln584">}</a>
<a name="ln585"> </a>
<a name="ln586"> </a>
<a name="ln587">// _HandleRequest</a>
<a name="ln588">status_t</a>
<a name="ln589">KernelRequestHandler::_HandleRequest(FileCacheSetEnabledRequest* request)</a>
<a name="ln590">{</a>
<a name="ln591">	// check and execute the request</a>
<a name="ln592">	Volume* volume = NULL;</a>
<a name="ln593">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln594">	VolumePutter _(volume);</a>
<a name="ln595"> </a>
<a name="ln596">	if (result == B_OK)</a>
<a name="ln597">		result = volume-&gt;SetFileCacheEnabled(request-&gt;vnid, request-&gt;enabled);</a>
<a name="ln598"> </a>
<a name="ln599">	// prepare the reply</a>
<a name="ln600">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln601">	FileCacheSetEnabledReply* reply;</a>
<a name="ln602">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln603">	if (error != B_OK)</a>
<a name="ln604">		return error;</a>
<a name="ln605">	reply-&gt;error = result;</a>
<a name="ln606"> </a>
<a name="ln607">	// send the reply</a>
<a name="ln608">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln609">}</a>
<a name="ln610"> </a>
<a name="ln611"> </a>
<a name="ln612">// _HandleRequest</a>
<a name="ln613">status_t</a>
<a name="ln614">KernelRequestHandler::_HandleRequest(FileCacheSetSizeRequest* request)</a>
<a name="ln615">{</a>
<a name="ln616">	// check and execute the request</a>
<a name="ln617">	Volume* volume = NULL;</a>
<a name="ln618">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln619">	VolumePutter _(volume);</a>
<a name="ln620"> </a>
<a name="ln621">	if (result == B_OK)</a>
<a name="ln622">		result = volume-&gt;SetFileCacheSize(request-&gt;vnid, request-&gt;size);</a>
<a name="ln623"> </a>
<a name="ln624">	// prepare the reply</a>
<a name="ln625">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln626">	FileCacheSetSizeReply* reply;</a>
<a name="ln627">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln628">	if (error != B_OK)</a>
<a name="ln629">		return error;</a>
<a name="ln630">	reply-&gt;error = result;</a>
<a name="ln631"> </a>
<a name="ln632">	// send the reply</a>
<a name="ln633">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln634">}</a>
<a name="ln635"> </a>
<a name="ln636"> </a>
<a name="ln637">// _HandleRequest</a>
<a name="ln638">status_t</a>
<a name="ln639">KernelRequestHandler::_HandleRequest(FileCacheSyncRequest* request)</a>
<a name="ln640">{</a>
<a name="ln641">	// check and execute the request</a>
<a name="ln642">	Volume* volume = NULL;</a>
<a name="ln643">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln644">	VolumePutter _(volume);</a>
<a name="ln645"> </a>
<a name="ln646">	if (result == B_OK)</a>
<a name="ln647">		result = volume-&gt;SyncFileCache(request-&gt;vnid);</a>
<a name="ln648"> </a>
<a name="ln649">	// prepare the reply</a>
<a name="ln650">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln651">	FileCacheSyncReply* reply;</a>
<a name="ln652">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln653">	if (error != B_OK)</a>
<a name="ln654">		return error;</a>
<a name="ln655">	reply-&gt;error = result;</a>
<a name="ln656"> </a>
<a name="ln657">	// send the reply</a>
<a name="ln658">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln659">}</a>
<a name="ln660"> </a>
<a name="ln661"> </a>
<a name="ln662">// _HandleRequest</a>
<a name="ln663">status_t</a>
<a name="ln664">KernelRequestHandler::_HandleRequest(FileCacheReadRequest* request)</a>
<a name="ln665">{</a>
<a name="ln666">	// check the request</a>
<a name="ln667">	Volume* volume = NULL;</a>
<a name="ln668">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln669">	VolumePutter _(volume);</a>
<a name="ln670"> </a>
<a name="ln671">	size_t size = request-&gt;size;</a>
<a name="ln672"> </a>
<a name="ln673">	// allocate the reply</a>
<a name="ln674">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln675">	FileCacheReadReply* reply;</a>
<a name="ln676">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln677">	if (error != B_OK)</a>
<a name="ln678">		RETURN_ERROR(error);</a>
<a name="ln679"> </a>
<a name="ln680">	void* buffer;</a>
<a name="ln681">	if (result == B_OK) {</a>
<a name="ln682">		result = allocator.AllocateAddress(reply-&gt;buffer, size, 1, &amp;buffer,</a>
<a name="ln683">			true);</a>
<a name="ln684">	}</a>
<a name="ln685"> </a>
<a name="ln686">	// execute the request</a>
<a name="ln687">	if (result == B_OK) {</a>
<a name="ln688">		result = volume-&gt;ReadFileCache(request-&gt;vnid, request-&gt;cookie,</a>
<a name="ln689">			request-&gt;pos, buffer, &amp;size);</a>
<a name="ln690">	}</a>
<a name="ln691"> </a>
<a name="ln692">	// prepare the reply</a>
<a name="ln693">	reply-&gt;error = result;</a>
<a name="ln694">	reply-&gt;bytesRead = size;</a>
<a name="ln695"> </a>
<a name="ln696">	// send the reply</a>
<a name="ln697">	if (reply-&gt;error == B_OK &amp;&amp; reply-&gt;bytesRead &gt; 0) {</a>
<a name="ln698">		SingleReplyRequestHandler handler(RECEIPT_ACK_REPLY);</a>
<a name="ln699">		return fPort-&gt;SendRequest(&amp;allocator, &amp;handler);</a>
<a name="ln700">	}</a>
<a name="ln701"> </a>
<a name="ln702">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln703">}</a>
<a name="ln704"> </a>
<a name="ln705"> </a>
<a name="ln706">// _HandleRequest</a>
<a name="ln707">status_t</a>
<a name="ln708">KernelRequestHandler::_HandleRequest(FileCacheWriteRequest* request)</a>
<a name="ln709">{</a>
<a name="ln710">	// check and execute the request</a>
<a name="ln711">	Volume* volume = NULL;</a>
<a name="ln712">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln713">	VolumePutter _(volume);</a>
<a name="ln714"> </a>
<a name="ln715">	size_t size = 0;</a>
<a name="ln716">	if (result == B_OK) {</a>
<a name="ln717">		const void* data = request-&gt;buffer.GetData();</a>
<a name="ln718">		size = request-&gt;size;</a>
<a name="ln719">		if (data != NULL) {</a>
<a name="ln720">			if (size != (size_t)request-&gt;buffer.GetSize())</a>
<a name="ln721">				result = B_BAD_DATA;</a>
<a name="ln722">		}</a>
<a name="ln723"> </a>
<a name="ln724">		if (result == B_OK) {</a>
<a name="ln725">			result = volume-&gt;WriteFileCache(request-&gt;vnid, request-&gt;cookie,</a>
<a name="ln726">				request-&gt;pos, data, &amp;size);</a>
<a name="ln727">		}</a>
<a name="ln728">	}</a>
<a name="ln729"> </a>
<a name="ln730">	// prepare the reply</a>
<a name="ln731">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln732">	FileCacheWriteReply* reply;</a>
<a name="ln733">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln734">	if (error != B_OK)</a>
<a name="ln735">		return error;</a>
<a name="ln736">	reply-&gt;error = result;</a>
<a name="ln737">	reply-&gt;bytesWritten = size;</a>
<a name="ln738"> </a>
<a name="ln739">	// send the reply</a>
<a name="ln740">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln741">}</a>
<a name="ln742"> </a>
<a name="ln743"> </a>
<a name="ln744">// _HandleRequest</a>
<a name="ln745">status_t</a>
<a name="ln746">KernelRequestHandler::_HandleRequest(DoIterativeFDIORequest* request)</a>
<a name="ln747">{</a>
<a name="ln748">	// check and execute the request</a>
<a name="ln749">	Volume* volume = NULL;</a>
<a name="ln750">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln751">	VolumePutter _(volume);</a>
<a name="ln752"> </a>
<a name="ln753">	uint32 vecCount = request-&gt;vecCount;</a>
<a name="ln754">	if (result == B_OK &amp;&amp; vecCount &gt; DoIterativeFDIORequest::MAX_VECS)</a>
<a name="ln755">		result = B_BAD_VALUE;</a>
<a name="ln756"> </a>
<a name="ln757">	if (result == B_OK) {</a>
<a name="ln758">		result = volume-&gt;DoIterativeFDIO(request-&gt;fd, request-&gt;request,</a>
<a name="ln759">			request-&gt;cookie, request-&gt;vecs, vecCount);</a>
<a name="ln760">	}</a>
<a name="ln761"> </a>
<a name="ln762">	// prepare the reply</a>
<a name="ln763">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln764">	DoIterativeFDIOReply* reply;</a>
<a name="ln765">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln766">	if (error != B_OK)</a>
<a name="ln767">		return error;</a>
<a name="ln768">	reply-&gt;error = result;</a>
<a name="ln769"> </a>
<a name="ln770">	// send the reply</a>
<a name="ln771">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln772">}</a>
<a name="ln773"> </a>
<a name="ln774"> </a>
<a name="ln775">status_t</a>
<a name="ln776">KernelRequestHandler::_HandleRequest(ReadFromIORequestRequest* request)</a>
<a name="ln777">{</a>
<a name="ln778">	// check the request</a>
<a name="ln779">	Volume* volume = NULL;</a>
<a name="ln780">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln781">	VolumePutter _(volume);</a>
<a name="ln782"> </a>
<a name="ln783">	size_t size = request-&gt;size;</a>
<a name="ln784"> </a>
<a name="ln785">	// allocate the reply</a>
<a name="ln786">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln787">	ReadFromIORequestReply* reply;</a>
<a name="ln788">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln789">	if (error != B_OK)</a>
<a name="ln790">		RETURN_ERROR(error);</a>
<a name="ln791"> </a>
<a name="ln792">	void* buffer;</a>
<a name="ln793">	if (result == B_OK) {</a>
<a name="ln794">		result = allocator.AllocateAddress(reply-&gt;buffer, size, 1, &amp;buffer,</a>
<a name="ln795">			true);</a>
<a name="ln796">	}</a>
<a name="ln797"> </a>
<a name="ln798">	// execute the request</a>
<a name="ln799">	if (result == B_OK)</a>
<a name="ln800">		result = volume-&gt;ReadFromIORequest(request-&gt;request, buffer, size);</a>
<a name="ln801"> </a>
<a name="ln802">	// prepare the reply</a>
<a name="ln803">	reply-&gt;error = result;</a>
<a name="ln804"> </a>
<a name="ln805">	// send the reply</a>
<a name="ln806">	if (reply-&gt;error == B_OK &amp;&amp; size &gt; 0) {</a>
<a name="ln807">		SingleReplyRequestHandler handler(RECEIPT_ACK_REPLY);</a>
<a name="ln808">		return fPort-&gt;SendRequest(&amp;allocator, &amp;handler);</a>
<a name="ln809">	}</a>
<a name="ln810"> </a>
<a name="ln811">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln812">}</a>
<a name="ln813"> </a>
<a name="ln814"> </a>
<a name="ln815">status_t</a>
<a name="ln816">KernelRequestHandler::_HandleRequest(WriteToIORequestRequest* request)</a>
<a name="ln817">{</a>
<a name="ln818">	// check and execute the request</a>
<a name="ln819">	Volume* volume = NULL;</a>
<a name="ln820">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln821">	VolumePutter _(volume);</a>
<a name="ln822"> </a>
<a name="ln823">	if (result == B_OK) {</a>
<a name="ln824">		result = volume-&gt;WriteToIORequest(request-&gt;request,</a>
<a name="ln825">			request-&gt;buffer.GetData(), request-&gt;buffer.GetSize());</a>
<a name="ln826">	}</a>
<a name="ln827"> </a>
<a name="ln828">	// prepare the reply</a>
<a name="ln829">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln830">	WriteToIORequestReply* reply;</a>
<a name="ln831">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln832">	if (error != B_OK)</a>
<a name="ln833">		return error;</a>
<a name="ln834">	reply-&gt;error = result;</a>
<a name="ln835"> </a>
<a name="ln836">	// send the reply</a>
<a name="ln837">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln838">}</a>
<a name="ln839"> </a>
<a name="ln840"> </a>
<a name="ln841">// _HandleRequest</a>
<a name="ln842">status_t</a>
<a name="ln843">KernelRequestHandler::_HandleRequest(NotifyIORequestRequest* request)</a>
<a name="ln844">{</a>
<a name="ln845">	// check and execute the request</a>
<a name="ln846">	Volume* volume = NULL;</a>
<a name="ln847">	status_t result = _GetVolume(request-&gt;nsid, &amp;volume);</a>
<a name="ln848">	VolumePutter _(volume);</a>
<a name="ln849"> </a>
<a name="ln850">	if (result == B_OK)</a>
<a name="ln851">		result = volume-&gt;NotifyIORequest(request-&gt;request, request-&gt;status);</a>
<a name="ln852"> </a>
<a name="ln853">	// prepare the reply</a>
<a name="ln854">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln855">	NotifyIORequestReply* reply;</a>
<a name="ln856">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln857">	if (error != B_OK)</a>
<a name="ln858">		return error;</a>
<a name="ln859">	reply-&gt;error = result;</a>
<a name="ln860"> </a>
<a name="ln861">	// send the reply</a>
<a name="ln862">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln863">}</a>
<a name="ln864"> </a>
<a name="ln865"> </a>
<a name="ln866">status_t</a>
<a name="ln867">KernelRequestHandler::_HandleRequest(AddNodeListenerRequest* request)</a>
<a name="ln868">{</a>
<a name="ln869">	// check and execute the request</a>
<a name="ln870">	status_t result = fFileSystem-&gt;AddNodeListener(request-&gt;device,</a>
<a name="ln871">		request-&gt;node, request-&gt;flags, request-&gt;listener);</a>
<a name="ln872"> </a>
<a name="ln873">	// prepare the reply</a>
<a name="ln874">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln875">	AddNodeListenerReply* reply;</a>
<a name="ln876">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln877">	if (error != B_OK)</a>
<a name="ln878">		return error;</a>
<a name="ln879"> </a>
<a name="ln880">	reply-&gt;error = result;</a>
<a name="ln881"> </a>
<a name="ln882">	// send the reply</a>
<a name="ln883">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln884">}</a>
<a name="ln885"> </a>
<a name="ln886"> </a>
<a name="ln887">status_t</a>
<a name="ln888">KernelRequestHandler::_HandleRequest(RemoveNodeListenerRequest* request)</a>
<a name="ln889">{</a>
<a name="ln890">	// check and execute the request</a>
<a name="ln891">	status_t result = fFileSystem-&gt;RemoveNodeListener(request-&gt;device,</a>
<a name="ln892">		request-&gt;node, request-&gt;listener);</a>
<a name="ln893"> </a>
<a name="ln894">	// prepare the reply</a>
<a name="ln895">	RequestAllocator allocator(fPort-&gt;GetPort());</a>
<a name="ln896">	RemoveNodeListenerReply* reply;</a>
<a name="ln897">	status_t error = AllocateRequest(allocator, &amp;reply);</a>
<a name="ln898">	if (error != B_OK)</a>
<a name="ln899">		return error;</a>
<a name="ln900"> </a>
<a name="ln901">	reply-&gt;error = result;</a>
<a name="ln902"> </a>
<a name="ln903">	// send the reply</a>
<a name="ln904">	return fPort-&gt;SendRequest(&amp;allocator);</a>
<a name="ln905">}</a>
<a name="ln906"> </a>
<a name="ln907"> </a>
<a name="ln908">// _GetVolume</a>
<a name="ln909">status_t</a>
<a name="ln910">KernelRequestHandler::_GetVolume(dev_t id, Volume** volume)</a>
<a name="ln911">{</a>
<a name="ln912">	if (fVolume) {</a>
<a name="ln913">		if (fVolume-&gt;GetID() != id) {</a>
<a name="ln914">			*volume = NULL;</a>
<a name="ln915">			return B_BAD_VALUE;</a>
<a name="ln916">		}</a>
<a name="ln917">		fVolume-&gt;AcquireReference();</a>
<a name="ln918">		*volume = fVolume;</a>
<a name="ln919">		return B_OK;</a>
<a name="ln920">	}</a>
<a name="ln921">	*volume = fFileSystem-&gt;GetVolume(id);</a>
<a name="ln922">	return (*volume ? B_OK : B_BAD_VALUE);</a>
<a name="ln923">}</a>
<a name="ln924"> </a>

</code></pre>
<div class="balloon" rel="366"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v614/" target="_blank">V614</a> Potentially uninitialized pointer 'node' used.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
