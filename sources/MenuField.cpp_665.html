
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>MenuField.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2006-2016 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Stephan AÃŸmus, superstippi@gmx.de</a>
<a name="ln7"> *		Marc Flerackers, mflerackers@androme.be</a>
<a name="ln8"> *		John Scipione, jscipione@gmail.com</a>
<a name="ln9"> *		Ingo Weinhold, bonefish@cs.tu-berlin.de</a>
<a name="ln10"> */</a>
<a name="ln11"> </a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;MenuField.h&gt;</a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;algorithm&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;stdio.h&gt;</a>
<a name="ln18">	// for printf in TRACE</a>
<a name="ln19">#include &lt;stdlib.h&gt;</a>
<a name="ln20">#include &lt;string.h&gt;</a>
<a name="ln21"> </a>
<a name="ln22">#include &lt;AbstractLayoutItem.h&gt;</a>
<a name="ln23">#include &lt;Archivable.h&gt;</a>
<a name="ln24">#include &lt;BMCPrivate.h&gt;</a>
<a name="ln25">#include &lt;ControlLook.h&gt;</a>
<a name="ln26">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln27">#include &lt;MenuBar.h&gt;</a>
<a name="ln28">#include &lt;MenuItem.h&gt;</a>
<a name="ln29">#include &lt;MenuItemPrivate.h&gt;</a>
<a name="ln30">#include &lt;MenuPrivate.h&gt;</a>
<a name="ln31">#include &lt;Message.h&gt;</a>
<a name="ln32">#include &lt;MessageFilter.h&gt;</a>
<a name="ln33">#include &lt;Thread.h&gt;</a>
<a name="ln34">#include &lt;Window.h&gt;</a>
<a name="ln35"> </a>
<a name="ln36">#include &lt;binary_compatibility/Interface.h&gt;</a>
<a name="ln37">#include &lt;binary_compatibility/Support.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39"> </a>
<a name="ln40">#ifdef CALLED</a>
<a name="ln41">#	undef CALLED</a>
<a name="ln42">#endif</a>
<a name="ln43">#ifdef TRACE</a>
<a name="ln44">#	undef TRACE</a>
<a name="ln45">#endif</a>
<a name="ln46"> </a>
<a name="ln47">//#define TRACE_MENU_FIELD</a>
<a name="ln48">#ifdef TRACE_MENU_FIELD</a>
<a name="ln49">#	include &lt;FunctionTracer.h&gt;</a>
<a name="ln50">	static int32 sFunctionDepth = -1;</a>
<a name="ln51">#	define CALLED(x...)	FunctionTracer _ft(&quot;BMenuField&quot;, __FUNCTION__, \</a>
<a name="ln52">							sFunctionDepth)</a>
<a name="ln53">#	define TRACE(x...)	{ BString _to; \</a>
<a name="ln54">							_to.Append(' ', (sFunctionDepth + 1) * 2); \</a>
<a name="ln55">							printf(&quot;%s&quot;, _to.String()); printf(x); }</a>
<a name="ln56">#else</a>
<a name="ln57">#	define CALLED(x...)</a>
<a name="ln58">#	define TRACE(x...)</a>
<a name="ln59">#endif</a>
<a name="ln60"> </a>
<a name="ln61"> </a>
<a name="ln62">static const float kMinMenuBarWidth = 20.0f;</a>
<a name="ln63">	// found by experimenting on BeOS R5</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">namespace {</a>
<a name="ln67">	const char* const kFrameField = &quot;BMenuField:layoutItem:frame&quot;;</a>
<a name="ln68">	const char* const kMenuBarItemField = &quot;BMenuField:barItem&quot;;</a>
<a name="ln69">	const char* const kLabelItemField = &quot;BMenuField:labelItem&quot;;</a>
<a name="ln70">}</a>
<a name="ln71"> </a>
<a name="ln72"> </a>
<a name="ln73">//	#pragma mark - LabelLayoutItem</a>
<a name="ln74"> </a>
<a name="ln75"> </a>
<a name="ln76">class BMenuField::LabelLayoutItem : public BAbstractLayoutItem {</a>
<a name="ln77">public:</a>
<a name="ln78">								LabelLayoutItem(BMenuField* parent);</a>
<a name="ln79">								LabelLayoutItem(BMessage* archive);</a>
<a name="ln80"> </a>
<a name="ln81">			BRect				FrameInParent() const;</a>
<a name="ln82"> </a>
<a name="ln83">	virtual	bool				IsVisible();</a>
<a name="ln84">	virtual	void				SetVisible(bool visible);</a>
<a name="ln85"> </a>
<a name="ln86">	virtual	BRect				Frame();</a>
<a name="ln87">	virtual	void				SetFrame(BRect frame);</a>
<a name="ln88"> </a>
<a name="ln89">			void				SetParent(BMenuField* parent);</a>
<a name="ln90">	virtual	BView*				View();</a>
<a name="ln91"> </a>
<a name="ln92">	virtual	BSize				BaseMinSize();</a>
<a name="ln93">	virtual	BSize				BaseMaxSize();</a>
<a name="ln94">	virtual	BSize				BasePreferredSize();</a>
<a name="ln95">	virtual	BAlignment			BaseAlignment();</a>
<a name="ln96"> </a>
<a name="ln97">	virtual status_t			Archive(BMessage* into, bool deep = true) const;</a>
<a name="ln98">	static	BArchivable*		Instantiate(BMessage* from);</a>
<a name="ln99"> </a>
<a name="ln100">private:</a>
<a name="ln101">			BMenuField*			fParent;</a>
<a name="ln102">			BRect				fFrame;</a>
<a name="ln103">};</a>
<a name="ln104"> </a>
<a name="ln105"> </a>
<a name="ln106">//	#pragma mark - MenuBarLayoutItem</a>
<a name="ln107"> </a>
<a name="ln108"> </a>
<a name="ln109">class BMenuField::MenuBarLayoutItem : public BAbstractLayoutItem {</a>
<a name="ln110">public:</a>
<a name="ln111">								MenuBarLayoutItem(BMenuField* parent);</a>
<a name="ln112">								MenuBarLayoutItem(BMessage* from);</a>
<a name="ln113"> </a>
<a name="ln114">			BRect				FrameInParent() const;</a>
<a name="ln115"> </a>
<a name="ln116">	virtual	bool				IsVisible();</a>
<a name="ln117">	virtual	void				SetVisible(bool visible);</a>
<a name="ln118"> </a>
<a name="ln119">	virtual	BRect				Frame();</a>
<a name="ln120">	virtual	void				SetFrame(BRect frame);</a>
<a name="ln121"> </a>
<a name="ln122">			void				SetParent(BMenuField* parent);</a>
<a name="ln123">	virtual	BView*				View();</a>
<a name="ln124"> </a>
<a name="ln125">	virtual	BSize				BaseMinSize();</a>
<a name="ln126">	virtual	BSize				BaseMaxSize();</a>
<a name="ln127">	virtual	BSize				BasePreferredSize();</a>
<a name="ln128">	virtual	BAlignment			BaseAlignment();</a>
<a name="ln129"> </a>
<a name="ln130">	virtual status_t			Archive(BMessage* into, bool deep = true) const;</a>
<a name="ln131">	static	BArchivable*		Instantiate(BMessage* from);</a>
<a name="ln132"> </a>
<a name="ln133">private:</a>
<a name="ln134">			BMenuField*			fParent;</a>
<a name="ln135">			BRect				fFrame;</a>
<a name="ln136">};</a>
<a name="ln137"> </a>
<a name="ln138"> </a>
<a name="ln139">//	#pragma mark - LayoutData</a>
<a name="ln140"> </a>
<a name="ln141"> </a>
<a name="ln142">struct BMenuField::LayoutData {</a>
<a name="ln143">	LayoutData()</a>
<a name="ln144">		:</a>
<a name="ln145">		label_layout_item(NULL),</a>
<a name="ln146">		menu_bar_layout_item(NULL),</a>
<a name="ln147">		previous_height(-1),</a>
<a name="ln148">		valid(false)</a>
<a name="ln149">	{</a>
<a name="ln150">	}</a>
<a name="ln151"> </a>
<a name="ln152">	LabelLayoutItem*	label_layout_item;</a>
<a name="ln153">	MenuBarLayoutItem*	menu_bar_layout_item;</a>
<a name="ln154">	float				previous_height;	// used in FrameResized() for</a>
<a name="ln155">											// invalidation</a>
<a name="ln156">	font_height			font_info;</a>
<a name="ln157">	float				label_width;</a>
<a name="ln158">	float				label_height;</a>
<a name="ln159">	BSize				min;</a>
<a name="ln160">	BSize				menu_bar_min;</a>
<a name="ln161">	bool				valid;</a>
<a name="ln162">};</a>
<a name="ln163"> </a>
<a name="ln164"> </a>
<a name="ln165">// #pragma mark - MouseDownFilter</a>
<a name="ln166"> </a>
<a name="ln167"> </a>
<a name="ln168">class MouseDownFilter : public BMessageFilter</a>
<a name="ln169">{</a>
<a name="ln170">public:</a>
<a name="ln171">								MouseDownFilter();</a>
<a name="ln172">	virtual						~MouseDownFilter();</a>
<a name="ln173"> </a>
<a name="ln174">	virtual	filter_result		Filter(BMessage* message, BHandler** target);</a>
<a name="ln175">};</a>
<a name="ln176"> </a>
<a name="ln177"> </a>
<a name="ln178">MouseDownFilter::MouseDownFilter()</a>
<a name="ln179">	:</a>
<a name="ln180">	BMessageFilter(B_ANY_DELIVERY, B_ANY_SOURCE)</a>
<a name="ln181">{</a>
<a name="ln182">}</a>
<a name="ln183"> </a>
<a name="ln184"> </a>
<a name="ln185">MouseDownFilter::~MouseDownFilter()</a>
<a name="ln186">{</a>
<a name="ln187">}</a>
<a name="ln188"> </a>
<a name="ln189"> </a>
<a name="ln190">filter_result</a>
<a name="ln191">MouseDownFilter::Filter(BMessage* message, BHandler** target)</a>
<a name="ln192">{</a>
<a name="ln193">	return message-&gt;what == B_MOUSE_DOWN ? B_SKIP_MESSAGE : B_DISPATCH_MESSAGE;</a>
<a name="ln194">}</a>
<a name="ln195"> </a>
<a name="ln196"> </a>
<a name="ln197">// #pragma mark - BMenuField</a>
<a name="ln198"> </a>
<a name="ln199"> </a>
<a name="ln200">BMenuField::BMenuField(BRect frame, const char* name, const char* label,</a>
<a name="ln201">	BMenu* menu, uint32 resizingMode, uint32 flags)</a>
<a name="ln202">	:</a>
<a name="ln203">	BView(frame, name, resizingMode, flags)</a>
<a name="ln204">{</a>
<a name="ln205">	CALLED();</a>
<a name="ln206"> </a>
<a name="ln207">	TRACE(&quot;frame.width: %.2f, height: %.2f\n&quot;, frame.Width(), frame.Height());</a>
<a name="ln208"> </a>
<a name="ln209">	InitObject(label);</a>
<a name="ln210"> </a>
<a name="ln211">	frame.OffsetTo(B_ORIGIN);</a>
<a name="ln212">	_InitMenuBar(menu, frame, false);</a>
<a name="ln213"> </a>
<a name="ln214">	InitObject2();</a>
<a name="ln215">}</a>
<a name="ln216"> </a>
<a name="ln217"> </a>
<a name="ln218">BMenuField::BMenuField(BRect frame, const char* name, const char* label,</a>
<a name="ln219">	BMenu* menu, bool fixedSize, uint32 resizingMode, uint32 flags)</a>
<a name="ln220">	:</a>
<a name="ln221">	BView(frame, name, resizingMode, flags)</a>
<a name="ln222">{</a>
<a name="ln223">	InitObject(label);</a>
<a name="ln224"> </a>
<a name="ln225">	fFixedSizeMB = fixedSize;</a>
<a name="ln226"> </a>
<a name="ln227">	frame.OffsetTo(B_ORIGIN);</a>
<a name="ln228">	_InitMenuBar(menu, frame, fixedSize);</a>
<a name="ln229"> </a>
<a name="ln230">	InitObject2();</a>
<a name="ln231">}</a>
<a name="ln232"> </a>
<a name="ln233"> </a>
<a name="ln234">BMenuField::BMenuField(const char* name, const char* label, BMenu* menu,</a>
<a name="ln235">	uint32 flags)</a>
<a name="ln236">	:</a>
<a name="ln237">	BView(name, flags | B_FRAME_EVENTS)</a>
<a name="ln238">{</a>
<a name="ln239">	InitObject(label);</a>
<a name="ln240"> </a>
<a name="ln241">	_InitMenuBar(menu, BRect(0, 0, 100, 15), true);</a>
<a name="ln242"> </a>
<a name="ln243">	InitObject2();</a>
<a name="ln244">}</a>
<a name="ln245"> </a>
<a name="ln246"> </a>
<a name="ln247">BMenuField::BMenuField(const char* label, BMenu* menu, uint32 flags)</a>
<a name="ln248">	:</a>
<a name="ln249">	BView(NULL, flags | B_FRAME_EVENTS)</a>
<a name="ln250">{</a>
<a name="ln251">	InitObject(label);</a>
<a name="ln252"> </a>
<a name="ln253">	_InitMenuBar(menu, BRect(0, 0, 100, 15), true);</a>
<a name="ln254"> </a>
<a name="ln255">	InitObject2();</a>
<a name="ln256">}</a>
<a name="ln257"> </a>
<a name="ln258"> </a>
<a name="ln259">//! Copy&amp;Paste error, should be removed at some point (already private)</a>
<a name="ln260">BMenuField::BMenuField(const char* name, const char* label, BMenu* menu,</a>
<a name="ln261">		BMessage* message, uint32 flags)</a>
<a name="ln262">	:</a>
<a name="ln263">	BView(name, flags | B_FRAME_EVENTS)</a>
<a name="ln264">{</a>
<a name="ln265">	InitObject(label);</a>
<a name="ln266"> </a>
<a name="ln267">	_InitMenuBar(menu, BRect(0, 0, 100, 15), true);</a>
<a name="ln268"> </a>
<a name="ln269">	InitObject2();</a>
<a name="ln270">}</a>
<a name="ln271"> </a>
<a name="ln272"> </a>
<a name="ln273">//! Copy&amp;Paste error, should be removed at some point (already private)</a>
<a name="ln274">BMenuField::BMenuField(const char* label, BMenu* menu, BMessage* message)</a>
<a name="ln275">	:</a>
<a name="ln276">	BView(NULL, B_WILL_DRAW | B_NAVIGABLE | B_FRAME_EVENTS)</a>
<a name="ln277">{</a>
<a name="ln278">	InitObject(label);</a>
<a name="ln279"> </a>
<a name="ln280">	_InitMenuBar(menu, BRect(0, 0, 100, 15), true);</a>
<a name="ln281"> </a>
<a name="ln282">	InitObject2();</a>
<a name="ln283">}</a>
<a name="ln284"> </a>
<a name="ln285"> </a>
<a name="ln286">BMenuField::BMenuField(BMessage* data)</a>
<a name="ln287">	:</a>
<a name="ln288">	BView(BUnarchiver::PrepareArchive(data))</a>
<a name="ln289">{</a>
<a name="ln290">	BUnarchiver unarchiver(data);</a>
<a name="ln291">	const char* label = NULL;</a>
<a name="ln292">	data-&gt;FindString(&quot;_label&quot;, &amp;label);</a>
<a name="ln293"> </a>
<a name="ln294">	InitObject(label);</a>
<a name="ln295"> </a>
<a name="ln296">	data-&gt;FindFloat(&quot;_divide&quot;, &amp;fDivider);</a>
<a name="ln297"> </a>
<a name="ln298">	int32 align;</a>
<a name="ln299">	if (data-&gt;FindInt32(&quot;_align&quot;, &amp;align) == B_OK)</a>
<a name="ln300">		SetAlignment((alignment)align);</a>
<a name="ln301"> </a>
<a name="ln302">	if (!BUnarchiver::IsArchiveManaged(data))</a>
<a name="ln303">		_InitMenuBar(data);</a>
<a name="ln304"> </a>
<a name="ln305">	unarchiver.Finish();</a>
<a name="ln306">}</a>
<a name="ln307"> </a>
<a name="ln308"> </a>
<a name="ln309">BMenuField::~BMenuField()</a>
<a name="ln310">{</a>
<a name="ln311">	free(fLabel);</a>
<a name="ln312"> </a>
<a name="ln313">	status_t dummy;</a>
<a name="ln314">	if (fMenuTaskID &gt;= 0)</a>
<a name="ln315">		wait_for_thread(fMenuTaskID, &amp;dummy);</a>
<a name="ln316"> </a>
<a name="ln317">	delete fLayoutData;</a>
<a name="ln318">	delete fMouseDownFilter;</a>
<a name="ln319">}</a>
<a name="ln320"> </a>
<a name="ln321"> </a>
<a name="ln322">BArchivable*</a>
<a name="ln323">BMenuField::Instantiate(BMessage* data)</a>
<a name="ln324">{</a>
<a name="ln325">	if (validate_instantiation(data, &quot;BMenuField&quot;))</a>
<a name="ln326">		return new BMenuField(data);</a>
<a name="ln327"> </a>
<a name="ln328">	return NULL;</a>
<a name="ln329">}</a>
<a name="ln330"> </a>
<a name="ln331"> </a>
<a name="ln332">status_t</a>
<a name="ln333">BMenuField::Archive(BMessage* data, bool deep) const</a>
<a name="ln334">{</a>
<a name="ln335">	BArchiver archiver(data);</a>
<a name="ln336">	status_t ret = BView::Archive(data, deep);</a>
<a name="ln337"> </a>
<a name="ln338">	if (ret == B_OK &amp;&amp; Label())</a>
<a name="ln339">		ret = data-&gt;AddString(&quot;_label&quot;, Label());</a>
<a name="ln340"> </a>
<a name="ln341">	if (ret == B_OK &amp;&amp; !IsEnabled())</a>
<a name="ln342">		ret = data-&gt;AddBool(&quot;_disable&quot;, true);</a>
<a name="ln343"> </a>
<a name="ln344">	if (ret == B_OK)</a>
<a name="ln345">		ret = data-&gt;AddInt32(&quot;_align&quot;, Alignment());</a>
<a name="ln346">	if (ret == B_OK)</a>
<a name="ln347">		ret = data-&gt;AddFloat(&quot;_divide&quot;, Divider());</a>
<a name="ln348"> </a>
<a name="ln349">	if (ret == B_OK &amp;&amp; fFixedSizeMB)</a>
<a name="ln350">		ret = data-&gt;AddBool(&quot;be:fixeds&quot;, true);</a>
<a name="ln351"> </a>
<a name="ln352">	bool dmark = false;</a>
<a name="ln353">	if (_BMCMenuBar_* menuBar = dynamic_cast&lt;_BMCMenuBar_*&gt;(fMenuBar))</a>
<a name="ln354">		dmark = menuBar-&gt;IsPopUpMarkerShown();</a>
<a name="ln355"> </a>
<a name="ln356">	data-&gt;AddBool(&quot;be:dmark&quot;, dmark);</a>
<a name="ln357"> </a>
<a name="ln358">	return archiver.Finish(ret);</a>
<a name="ln359">}</a>
<a name="ln360"> </a>
<a name="ln361"> </a>
<a name="ln362">status_t</a>
<a name="ln363">BMenuField::AllArchived(BMessage* into) const</a>
<a name="ln364">{</a>
<a name="ln365">	status_t err;</a>
<a name="ln366">	if ((err = BView::AllArchived(into)) != B_OK)</a>
<a name="ln367">		return err;</a>
<a name="ln368"> </a>
<a name="ln369">	BArchiver archiver(into);</a>
<a name="ln370"> </a>
<a name="ln371">	BArchivable* menuBarItem = fLayoutData-&gt;menu_bar_layout_item;</a>
<a name="ln372">	if (archiver.IsArchived(menuBarItem))</a>
<a name="ln373">		err = archiver.AddArchivable(kMenuBarItemField, menuBarItem);</a>
<a name="ln374"> </a>
<a name="ln375">	if (err != B_OK)</a>
<a name="ln376">		return err;</a>
<a name="ln377"> </a>
<a name="ln378">	BArchivable* labelBarItem = fLayoutData-&gt;label_layout_item;</a>
<a name="ln379">	if (archiver.IsArchived(labelBarItem))</a>
<a name="ln380">		err = archiver.AddArchivable(kLabelItemField, labelBarItem);</a>
<a name="ln381"> </a>
<a name="ln382">	return err;</a>
<a name="ln383">}</a>
<a name="ln384"> </a>
<a name="ln385"> </a>
<a name="ln386">status_t</a>
<a name="ln387">BMenuField::AllUnarchived(const BMessage* from)</a>
<a name="ln388">{</a>
<a name="ln389">	BUnarchiver unarchiver(from);</a>
<a name="ln390"> </a>
<a name="ln391">	status_t err = B_OK;</a>
<a name="ln392">	if ((err = BView::AllUnarchived(from)) != B_OK)</a>
<a name="ln393">		return err;</a>
<a name="ln394"> </a>
<a name="ln395">	_InitMenuBar(from);</a>
<a name="ln396"> </a>
<a name="ln397">	if (unarchiver.IsInstantiated(kMenuBarItemField)) {</a>
<a name="ln398">		MenuBarLayoutItem*&amp; menuItem = fLayoutData-&gt;menu_bar_layout_item;</a>
<a name="ln399">		err = unarchiver.FindObject(kMenuBarItemField,</a>
<a name="ln400">			BUnarchiver::B_DONT_ASSUME_OWNERSHIP, menuItem);</a>
<a name="ln401"> </a>
<a name="ln402">		if (err == B_OK)</a>
<a name="ln403">			menuItem-&gt;SetParent(this);</a>
<a name="ln404">		else</a>
<a name="ln405">			return err;</a>
<a name="ln406">	}</a>
<a name="ln407"> </a>
<a name="ln408">	if (unarchiver.IsInstantiated(kLabelItemField)) {</a>
<a name="ln409">		LabelLayoutItem*&amp; labelItem = fLayoutData-&gt;label_layout_item;</a>
<a name="ln410">		err = unarchiver.FindObject(kLabelItemField,</a>
<a name="ln411">			BUnarchiver::B_DONT_ASSUME_OWNERSHIP, labelItem);</a>
<a name="ln412"> </a>
<a name="ln413">		if (err == B_OK)</a>
<a name="ln414">			labelItem-&gt;SetParent(this);</a>
<a name="ln415">	}</a>
<a name="ln416"> </a>
<a name="ln417">	return err;</a>
<a name="ln418">}</a>
<a name="ln419"> </a>
<a name="ln420"> </a>
<a name="ln421">void</a>
<a name="ln422">BMenuField::Draw(BRect updateRect)</a>
<a name="ln423">{</a>
<a name="ln424">	_DrawLabel(updateRect);</a>
<a name="ln425">	_DrawMenuBar(updateRect);</a>
<a name="ln426">}</a>
<a name="ln427"> </a>
<a name="ln428"> </a>
<a name="ln429">void</a>
<a name="ln430">BMenuField::AttachedToWindow()</a>
<a name="ln431">{</a>
<a name="ln432">	CALLED();</a>
<a name="ln433"> </a>
<a name="ln434">	// Our low color must match the parent's view color.</a>
<a name="ln435">	if (Parent() != NULL) {</a>
<a name="ln436">		AdoptParentColors();</a>
<a name="ln437"> </a>
<a name="ln438">		float tint = B_NO_TINT;</a>
<a name="ln439">		color_which which = ViewUIColor(&amp;tint);</a>
<a name="ln440"> </a>
<a name="ln441">		if (which == B_NO_COLOR)</a>
<a name="ln442">			SetLowColor(ViewColor());</a>
<a name="ln443">		else</a>
<a name="ln444">			SetLowUIColor(which, tint);</a>
<a name="ln445">	} else</a>
<a name="ln446">		AdoptSystemColors();</a>
<a name="ln447">}</a>
<a name="ln448"> </a>
<a name="ln449"> </a>
<a name="ln450">void</a>
<a name="ln451">BMenuField::AllAttached()</a>
<a name="ln452">{</a>
<a name="ln453">	CALLED();</a>
<a name="ln454"> </a>
<a name="ln455">	TRACE(&quot;width: %.2f, height: %.2f\n&quot;, Frame().Width(), Frame().Height());</a>
<a name="ln456"> </a>
<a name="ln457">	float width = Bounds().Width();</a>
<a name="ln458">	if (!fFixedSizeMB &amp;&amp; _MenuBarWidth() &lt; kMinMenuBarWidth) {</a>
<a name="ln459">		// The menu bar is too narrow, resize it to fit the menu items</a>
<a name="ln460">		BMenuItem* item = fMenuBar-&gt;ItemAt(0);</a>
<a name="ln461">		if (item != NULL) {</a>
<a name="ln462">			float right;</a>
<a name="ln463">			fMenuBar-&gt;GetItemMargins(NULL, NULL, &amp;right, NULL);</a>
<a name="ln464">			width = item-&gt;Frame().Width() + kVMargin + _MenuBarOffset() + right;</a>
<a name="ln465">		}</a>
<a name="ln466">	}</a>
<a name="ln467"> </a>
<a name="ln468">	ResizeTo(width, fMenuBar-&gt;Bounds().Height() + kVMargin * 2);</a>
<a name="ln469"> </a>
<a name="ln470">	TRACE(&quot;width: %.2f, height: %.2f\n&quot;, Frame().Width(), Frame().Height());</a>
<a name="ln471">}</a>
<a name="ln472"> </a>
<a name="ln473"> </a>
<a name="ln474">void</a>
<a name="ln475">BMenuField::MouseDown(BPoint where)</a>
<a name="ln476">{</a>
<a name="ln477">	BRect bounds = fMenuBar-&gt;ConvertFromParent(Bounds());</a>
<a name="ln478"> </a>
<a name="ln479">	fMenuBar-&gt;StartMenuBar(-1, false, true, &amp;bounds);</a>
<a name="ln480"> </a>
<a name="ln481">	fMenuTaskID = spawn_thread((thread_func)_thread_entry,</a>
<a name="ln482">		&quot;_m_task_&quot;, B_NORMAL_PRIORITY, this);</a>
<a name="ln483">	if (fMenuTaskID &gt;= 0 &amp;&amp; resume_thread(fMenuTaskID) == B_OK) {</a>
<a name="ln484">		if (fMouseDownFilter-&gt;Looper() == NULL)</a>
<a name="ln485">			Window()-&gt;AddCommonFilter(fMouseDownFilter);</a>
<a name="ln486"> </a>
<a name="ln487">		MouseDownThread&lt;BMenuField&gt;::TrackMouse(this, &amp;BMenuField::_DoneTracking,</a>
<a name="ln488">			&amp;BMenuField::_Track);</a>
<a name="ln489">	}</a>
<a name="ln490">}</a>
<a name="ln491"> </a>
<a name="ln492"> </a>
<a name="ln493">void</a>
<a name="ln494">BMenuField::KeyDown(const char* bytes, int32 numBytes)</a>
<a name="ln495">{</a>
<a name="ln496">	switch (bytes[0]) {</a>
<a name="ln497">		case B_SPACE:</a>
<a name="ln498">		case B_RIGHT_ARROW:</a>
<a name="ln499">		case B_DOWN_ARROW:</a>
<a name="ln500">		{</a>
<a name="ln501">			if (!IsEnabled())</a>
<a name="ln502">				break;</a>
<a name="ln503"> </a>
<a name="ln504">			BRect bounds = fMenuBar-&gt;ConvertFromParent(Bounds());</a>
<a name="ln505"> </a>
<a name="ln506">			fMenuBar-&gt;StartMenuBar(0, true, true, &amp;bounds);</a>
<a name="ln507"> </a>
<a name="ln508">			bounds = Bounds();</a>
<a name="ln509">			bounds.right = fDivider;</a>
<a name="ln510"> </a>
<a name="ln511">			Invalidate(bounds);</a>
<a name="ln512">		}</a>
<a name="ln513"> </a>
<a name="ln514">		default:</a>
<a name="ln515">			BView::KeyDown(bytes, numBytes);</a>
<a name="ln516">	}</a>
<a name="ln517">}</a>
<a name="ln518"> </a>
<a name="ln519"> </a>
<a name="ln520">void</a>
<a name="ln521">BMenuField::MakeFocus(bool focused)</a>
<a name="ln522">{</a>
<a name="ln523">	if (IsFocus() == focused)</a>
<a name="ln524">		return;</a>
<a name="ln525"> </a>
<a name="ln526">	BView::MakeFocus(focused);</a>
<a name="ln527"> </a>
<a name="ln528">	if (Window() != NULL)</a>
<a name="ln529">		Invalidate(); // TODO: use fLayoutData-&gt;label_width</a>
<a name="ln530">}</a>
<a name="ln531"> </a>
<a name="ln532"> </a>
<a name="ln533">void</a>
<a name="ln534">BMenuField::MessageReceived(BMessage* message)</a>
<a name="ln535">{</a>
<a name="ln536">	BView::MessageReceived(message);</a>
<a name="ln537">}</a>
<a name="ln538"> </a>
<a name="ln539"> </a>
<a name="ln540">void</a>
<a name="ln541">BMenuField::WindowActivated(bool active)</a>
<a name="ln542">{</a>
<a name="ln543">	BView::WindowActivated(active);</a>
<a name="ln544"> </a>
<a name="ln545">	if (IsFocus())</a>
<a name="ln546">		Invalidate();</a>
<a name="ln547">}</a>
<a name="ln548"> </a>
<a name="ln549"> </a>
<a name="ln550">void</a>
<a name="ln551">BMenuField::MouseMoved(BPoint point, uint32 code, const BMessage* message)</a>
<a name="ln552">{</a>
<a name="ln553">	BView::MouseMoved(point, code, message);</a>
<a name="ln554">}</a>
<a name="ln555"> </a>
<a name="ln556"> </a>
<a name="ln557">void</a>
<a name="ln558">BMenuField::MouseUp(BPoint where)</a>
<a name="ln559">{</a>
<a name="ln560">	BView::MouseUp(where);</a>
<a name="ln561">}</a>
<a name="ln562"> </a>
<a name="ln563"> </a>
<a name="ln564">void</a>
<a name="ln565">BMenuField::DetachedFromWindow()</a>
<a name="ln566">{</a>
<a name="ln567">	BView::DetachedFromWindow();</a>
<a name="ln568">}</a>
<a name="ln569"> </a>
<a name="ln570"> </a>
<a name="ln571">void</a>
<a name="ln572">BMenuField::AllDetached()</a>
<a name="ln573">{</a>
<a name="ln574">	BView::AllDetached();</a>
<a name="ln575">}</a>
<a name="ln576"> </a>
<a name="ln577"> </a>
<a name="ln578">void</a>
<a name="ln579">BMenuField::FrameMoved(BPoint newPosition)</a>
<a name="ln580">{</a>
<a name="ln581">	BView::FrameMoved(newPosition);</a>
<a name="ln582">}</a>
<a name="ln583"> </a>
<a name="ln584"> </a>
<a name="ln585">void</a>
<a name="ln586">BMenuField::FrameResized(float newWidth, float newHeight)</a>
<a name="ln587">{</a>
<a name="ln588">	BView::FrameResized(newWidth, newHeight);</a>
<a name="ln589"> </a>
<a name="ln590">	if (fFixedSizeMB) {</a>
<a name="ln591">		// we have let the menubar resize itself, but</a>
<a name="ln592">		// in fixed size mode, the menubar is supposed to</a>
<a name="ln593">		// be at the right end of the view always. Since</a>
<a name="ln594">		// the menu bar is in follow left/right mode then,</a>
<a name="ln595">		// resizing ourselfs might have caused the menubar</a>
<a name="ln596">		// to be outside now</a>
<a name="ln597">		fMenuBar-&gt;ResizeTo(_MenuBarWidth(), fMenuBar-&gt;Frame().Height());</a>
<a name="ln598">	}</a>
<a name="ln599"> </a>
<a name="ln600">	if (newHeight != fLayoutData-&gt;previous_height &amp;&amp; Label()) {</a>
<a name="ln601">		// The height changed, which means the label has to move and we</a>
<a name="ln602">		// probably also invalidate a part of the borders around the menu bar.</a>
<a name="ln603">		// So don't be shy and invalidate the whole thing.</a>
<a name="ln604">		Invalidate();</a>
<a name="ln605">	}</a>
<a name="ln606"> </a>
<a name="ln607">	fLayoutData-&gt;previous_height = newHeight;</a>
<a name="ln608">}</a>
<a name="ln609"> </a>
<a name="ln610"> </a>
<a name="ln611">BMenu*</a>
<a name="ln612">BMenuField::Menu() const</a>
<a name="ln613">{</a>
<a name="ln614">	return fMenu;</a>
<a name="ln615">}</a>
<a name="ln616"> </a>
<a name="ln617"> </a>
<a name="ln618">BMenuBar*</a>
<a name="ln619">BMenuField::MenuBar() const</a>
<a name="ln620">{</a>
<a name="ln621">	return fMenuBar;</a>
<a name="ln622">}</a>
<a name="ln623"> </a>
<a name="ln624"> </a>
<a name="ln625">BMenuItem*</a>
<a name="ln626">BMenuField::MenuItem() const</a>
<a name="ln627">{</a>
<a name="ln628">	return fMenuBar-&gt;ItemAt(0);</a>
<a name="ln629">}</a>
<a name="ln630"> </a>
<a name="ln631"> </a>
<a name="ln632">void</a>
<a name="ln633">BMenuField::SetLabel(const char* label)</a>
<a name="ln634">{</a>
<a name="ln635">	if (fLabel) {</a>
<a name="ln636">		if (label &amp;&amp; strcmp(fLabel, label) == 0)</a>
<a name="ln637">			return;</a>
<a name="ln638"> </a>
<a name="ln639">		free(fLabel);</a>
<a name="ln640">	}</a>
<a name="ln641"> </a>
<a name="ln642">	fLabel = strdup(label);</a>
<a name="ln643"> </a>
<a name="ln644">	if (Window())</a>
<a name="ln645">		Invalidate();</a>
<a name="ln646"> </a>
<a name="ln647">	InvalidateLayout();</a>
<a name="ln648">}</a>
<a name="ln649"> </a>
<a name="ln650"> </a>
<a name="ln651">const char*</a>
<a name="ln652">BMenuField::Label() const</a>
<a name="ln653">{</a>
<a name="ln654">	return fLabel;</a>
<a name="ln655">}</a>
<a name="ln656"> </a>
<a name="ln657"> </a>
<a name="ln658">void</a>
<a name="ln659">BMenuField::SetEnabled(bool on)</a>
<a name="ln660">{</a>
<a name="ln661">	if (fEnabled == on)</a>
<a name="ln662">		return;</a>
<a name="ln663"> </a>
<a name="ln664">	fEnabled = on;</a>
<a name="ln665">	fMenuBar-&gt;SetEnabled(on);</a>
<a name="ln666"> </a>
<a name="ln667">	if (Window()) {</a>
<a name="ln668">		fMenuBar-&gt;Invalidate(fMenuBar-&gt;Bounds());</a>
<a name="ln669">		Invalidate(Bounds());</a>
<a name="ln670">	}</a>
<a name="ln671">}</a>
<a name="ln672"> </a>
<a name="ln673"> </a>
<a name="ln674">bool</a>
<a name="ln675">BMenuField::IsEnabled() const</a>
<a name="ln676">{</a>
<a name="ln677">	return fEnabled;</a>
<a name="ln678">}</a>
<a name="ln679"> </a>
<a name="ln680"> </a>
<a name="ln681">void</a>
<a name="ln682">BMenuField::SetAlignment(alignment label)</a>
<a name="ln683">{</a>
<a name="ln684">	fAlign = label;</a>
<a name="ln685">}</a>
<a name="ln686"> </a>
<a name="ln687"> </a>
<a name="ln688">alignment</a>
<a name="ln689">BMenuField::Alignment() const</a>
<a name="ln690">{</a>
<a name="ln691">	return fAlign;</a>
<a name="ln692">}</a>
<a name="ln693"> </a>
<a name="ln694"> </a>
<a name="ln695">void</a>
<a name="ln696">BMenuField::SetDivider(float position)</a>
<a name="ln697">{</a>
<a name="ln698">	position = roundf(position);</a>
<a name="ln699"> </a>
<a name="ln700">	float delta = fDivider - position;</a>
<a name="ln701">	if (delta == 0.0f)</a>
<a name="ln702">		return;</a>
<a name="ln703"> </a>
<a name="ln704">	fDivider = position;</a>
<a name="ln705"> </a>
<a name="ln706">	if ((Flags() &amp; B_SUPPORTS_LAYOUT) != 0) {</a>
<a name="ln707">		// We should never get here, since layout support means, we also</a>
<a name="ln708">		// layout the divider, and don't use this method at all.</a>
<a name="ln709">		Relayout();</a>
<a name="ln710">	} else {</a>
<a name="ln711">		BRect dirty(fMenuBar-&gt;Frame());</a>
<a name="ln712"> </a>
<a name="ln713">		fMenuBar-&gt;MoveTo(_MenuBarOffset(), kVMargin);</a>
<a name="ln714"> </a>
<a name="ln715">		if (fFixedSizeMB)</a>
<a name="ln716">			fMenuBar-&gt;ResizeTo(_MenuBarWidth(), dirty.Height());</a>
<a name="ln717"> </a>
<a name="ln718">		dirty = dirty | fMenuBar-&gt;Frame();</a>
<a name="ln719">		dirty.InsetBy(-kVMargin, -kVMargin);</a>
<a name="ln720"> </a>
<a name="ln721">		Invalidate(dirty);</a>
<a name="ln722">	}</a>
<a name="ln723">}</a>
<a name="ln724"> </a>
<a name="ln725"> </a>
<a name="ln726">float</a>
<a name="ln727">BMenuField::Divider() const</a>
<a name="ln728">{</a>
<a name="ln729">	return fDivider;</a>
<a name="ln730">}</a>
<a name="ln731"> </a>
<a name="ln732"> </a>
<a name="ln733">void</a>
<a name="ln734">BMenuField::ShowPopUpMarker()</a>
<a name="ln735">{</a>
<a name="ln736">	if (_BMCMenuBar_* menuBar = dynamic_cast&lt;_BMCMenuBar_*&gt;(fMenuBar)) {</a>
<a name="ln737">		menuBar-&gt;TogglePopUpMarker(true);</a>
<a name="ln738">		menuBar-&gt;Invalidate();</a>
<a name="ln739">	}</a>
<a name="ln740">}</a>
<a name="ln741"> </a>
<a name="ln742"> </a>
<a name="ln743">void</a>
<a name="ln744">BMenuField::HidePopUpMarker()</a>
<a name="ln745">{</a>
<a name="ln746">	if (_BMCMenuBar_* menuBar = dynamic_cast&lt;_BMCMenuBar_*&gt;(fMenuBar)) {</a>
<a name="ln747">		menuBar-&gt;TogglePopUpMarker(false);</a>
<a name="ln748">		menuBar-&gt;Invalidate();</a>
<a name="ln749">	}</a>
<a name="ln750">}</a>
<a name="ln751"> </a>
<a name="ln752"> </a>
<a name="ln753">BHandler*</a>
<a name="ln754">BMenuField::ResolveSpecifier(BMessage* message, int32 index,</a>
<a name="ln755">	BMessage* specifier, int32 form, const char* property)</a>
<a name="ln756">{</a>
<a name="ln757">	return BView::ResolveSpecifier(message, index, specifier, form, property);</a>
<a name="ln758">}</a>
<a name="ln759"> </a>
<a name="ln760"> </a>
<a name="ln761">status_t</a>
<a name="ln762">BMenuField::GetSupportedSuites(BMessage* data)</a>
<a name="ln763">{</a>
<a name="ln764">	return BView::GetSupportedSuites(data);</a>
<a name="ln765">}</a>
<a name="ln766"> </a>
<a name="ln767"> </a>
<a name="ln768">void</a>
<a name="ln769">BMenuField::ResizeToPreferred()</a>
<a name="ln770">{</a>
<a name="ln771">	CALLED();</a>
<a name="ln772"> </a>
<a name="ln773">	TRACE(&quot;fMenuBar-&gt;Frame().width: %.2f, height: %.2f\n&quot;,</a>
<a name="ln774">		fMenuBar-&gt;Frame().Width(), fMenuBar-&gt;Frame().Height());</a>
<a name="ln775"> </a>
<a name="ln776">	fMenuBar-&gt;ResizeToPreferred();</a>
<a name="ln777"> </a>
<a name="ln778">	TRACE(&quot;fMenuBar-&gt;Frame().width: %.2f, height: %.2f\n&quot;,</a>
<a name="ln779">		fMenuBar-&gt;Frame().Width(), fMenuBar-&gt;Frame().Height());</a>
<a name="ln780"> </a>
<a name="ln781">	BView::ResizeToPreferred();</a>
<a name="ln782"> </a>
<a name="ln783">	Invalidate();</a>
<a name="ln784">}</a>
<a name="ln785"> </a>
<a name="ln786"> </a>
<a name="ln787">void</a>
<a name="ln788">BMenuField::GetPreferredSize(float* _width, float* _height)</a>
<a name="ln789">{</a>
<a name="ln790">	CALLED();</a>
<a name="ln791"> </a>
<a name="ln792">	_ValidateLayoutData();</a>
<a name="ln793"> </a>
<a name="ln794">	if (_width)</a>
<a name="ln795">		*_width = fLayoutData-&gt;min.width;</a>
<a name="ln796"> </a>
<a name="ln797">	if (_height)</a>
<a name="ln798">		*_height = fLayoutData-&gt;min.height;</a>
<a name="ln799">}</a>
<a name="ln800"> </a>
<a name="ln801"> </a>
<a name="ln802">BSize</a>
<a name="ln803">BMenuField::MinSize()</a>
<a name="ln804">{</a>
<a name="ln805">	CALLED();</a>
<a name="ln806"> </a>
<a name="ln807">	_ValidateLayoutData();</a>
<a name="ln808">	return BLayoutUtils::ComposeSize(ExplicitMinSize(), fLayoutData-&gt;min);</a>
<a name="ln809">}</a>
<a name="ln810"> </a>
<a name="ln811"> </a>
<a name="ln812">BSize</a>
<a name="ln813">BMenuField::MaxSize()</a>
<a name="ln814">{</a>
<a name="ln815">	CALLED();</a>
<a name="ln816"> </a>
<a name="ln817">	_ValidateLayoutData();</a>
<a name="ln818"> </a>
<a name="ln819">	BSize max = fLayoutData-&gt;min;</a>
<a name="ln820">	max.width = B_SIZE_UNLIMITED;</a>
<a name="ln821"> </a>
<a name="ln822">	return BLayoutUtils::ComposeSize(ExplicitMaxSize(), max);</a>
<a name="ln823">}</a>
<a name="ln824"> </a>
<a name="ln825"> </a>
<a name="ln826">BSize</a>
<a name="ln827">BMenuField::PreferredSize()</a>
<a name="ln828">{</a>
<a name="ln829">	CALLED();</a>
<a name="ln830"> </a>
<a name="ln831">	_ValidateLayoutData();</a>
<a name="ln832">	return BLayoutUtils::ComposeSize(ExplicitPreferredSize(), fLayoutData-&gt;min);</a>
<a name="ln833">}</a>
<a name="ln834"> </a>
<a name="ln835"> </a>
<a name="ln836">BLayoutItem*</a>
<a name="ln837">BMenuField::CreateLabelLayoutItem()</a>
<a name="ln838">{</a>
<a name="ln839">	if (fLayoutData-&gt;label_layout_item == NULL)</a>
<a name="ln840">		fLayoutData-&gt;label_layout_item = new LabelLayoutItem(this);</a>
<a name="ln841"> </a>
<a name="ln842">	return fLayoutData-&gt;label_layout_item;</a>
<a name="ln843">}</a>
<a name="ln844"> </a>
<a name="ln845"> </a>
<a name="ln846">BLayoutItem*</a>
<a name="ln847">BMenuField::CreateMenuBarLayoutItem()</a>
<a name="ln848">{</a>
<a name="ln849">	if (fLayoutData-&gt;menu_bar_layout_item == NULL) {</a>
<a name="ln850">		// align the menu bar in the full available space</a>
<a name="ln851">		fMenuBar-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_USE_FULL_WIDTH,</a>
<a name="ln852">			B_ALIGN_VERTICAL_UNSET));</a>
<a name="ln853">		fLayoutData-&gt;menu_bar_layout_item = new MenuBarLayoutItem(this);</a>
<a name="ln854">	}</a>
<a name="ln855"> </a>
<a name="ln856">	return fLayoutData-&gt;menu_bar_layout_item;</a>
<a name="ln857">}</a>
<a name="ln858"> </a>
<a name="ln859"> </a>
<a name="ln860">status_t</a>
<a name="ln861">BMenuField::Perform(perform_code code, void* _data)</a>
<a name="ln862">{</a>
<a name="ln863">	switch (code) {</a>
<a name="ln864">		case PERFORM_CODE_MIN_SIZE:</a>
<a name="ln865">			((perform_data_min_size*)_data)-&gt;return_value</a>
<a name="ln866">				= BMenuField::MinSize();</a>
<a name="ln867">			return B_OK;</a>
<a name="ln868"> </a>
<a name="ln869">		case PERFORM_CODE_MAX_SIZE:</a>
<a name="ln870">			((perform_data_max_size*)_data)-&gt;return_value</a>
<a name="ln871">				= BMenuField::MaxSize();</a>
<a name="ln872">			return B_OK;</a>
<a name="ln873"> </a>
<a name="ln874">		case PERFORM_CODE_PREFERRED_SIZE:</a>
<a name="ln875">			((perform_data_preferred_size*)_data)-&gt;return_value</a>
<a name="ln876">				= BMenuField::PreferredSize();</a>
<a name="ln877">			return B_OK;</a>
<a name="ln878"> </a>
<a name="ln879">		case PERFORM_CODE_LAYOUT_ALIGNMENT:</a>
<a name="ln880">			((perform_data_layout_alignment*)_data)-&gt;return_value</a>
<a name="ln881">				= BMenuField::LayoutAlignment();</a>
<a name="ln882">			return B_OK;</a>
<a name="ln883"> </a>
<a name="ln884">		case PERFORM_CODE_HAS_HEIGHT_FOR_WIDTH:</a>
<a name="ln885">			((perform_data_has_height_for_width*)_data)-&gt;return_value</a>
<a name="ln886">				= BMenuField::HasHeightForWidth();</a>
<a name="ln887">			return B_OK;</a>
<a name="ln888"> </a>
<a name="ln889">		case PERFORM_CODE_GET_HEIGHT_FOR_WIDTH:</a>
<a name="ln890">		{</a>
<a name="ln891">			perform_data_get_height_for_width* data</a>
<a name="ln892">				= (perform_data_get_height_for_width*)_data;</a>
<a name="ln893">			BMenuField::GetHeightForWidth(data-&gt;width, &amp;data-&gt;min, &amp;data-&gt;max,</a>
<a name="ln894">				&amp;data-&gt;preferred);</a>
<a name="ln895">			return B_OK;</a>
<a name="ln896">		}</a>
<a name="ln897"> </a>
<a name="ln898">		case PERFORM_CODE_SET_LAYOUT:</a>
<a name="ln899">		{</a>
<a name="ln900">			perform_data_set_layout* data = (perform_data_set_layout*)_data;</a>
<a name="ln901">			BMenuField::SetLayout(data-&gt;layout);</a>
<a name="ln902">			return B_OK;</a>
<a name="ln903">		}</a>
<a name="ln904"> </a>
<a name="ln905">		case PERFORM_CODE_LAYOUT_INVALIDATED:</a>
<a name="ln906">		{</a>
<a name="ln907">			perform_data_layout_invalidated* data</a>
<a name="ln908">				= (perform_data_layout_invalidated*)_data;</a>
<a name="ln909">			BMenuField::LayoutInvalidated(data-&gt;descendants);</a>
<a name="ln910">			return B_OK;</a>
<a name="ln911">		}</a>
<a name="ln912"> </a>
<a name="ln913">		case PERFORM_CODE_DO_LAYOUT:</a>
<a name="ln914">		{</a>
<a name="ln915">			BMenuField::DoLayout();</a>
<a name="ln916">			return B_OK;</a>
<a name="ln917">		}</a>
<a name="ln918"> </a>
<a name="ln919">		case PERFORM_CODE_ALL_UNARCHIVED:</a>
<a name="ln920">		{</a>
<a name="ln921">			perform_data_all_unarchived* data</a>
<a name="ln922">				= (perform_data_all_unarchived*)_data;</a>
<a name="ln923">			data-&gt;return_value = BMenuField::AllUnarchived(data-&gt;archive);</a>
<a name="ln924">			return B_OK;</a>
<a name="ln925">		}</a>
<a name="ln926"> </a>
<a name="ln927">		case PERFORM_CODE_ALL_ARCHIVED:</a>
<a name="ln928">		{</a>
<a name="ln929">			perform_data_all_archived* data</a>
<a name="ln930">				= (perform_data_all_archived*)_data;</a>
<a name="ln931">			data-&gt;return_value = BMenuField::AllArchived(data-&gt;archive);</a>
<a name="ln932">			return B_OK;</a>
<a name="ln933">		}</a>
<a name="ln934">	}</a>
<a name="ln935"> </a>
<a name="ln936">	return BView::Perform(code, _data);</a>
<a name="ln937">}</a>
<a name="ln938"> </a>
<a name="ln939"> </a>
<a name="ln940">void</a>
<a name="ln941">BMenuField::LayoutInvalidated(bool descendants)</a>
<a name="ln942">{</a>
<a name="ln943">	CALLED();</a>
<a name="ln944"> </a>
<a name="ln945">	fLayoutData-&gt;valid = false;</a>
<a name="ln946">}</a>
<a name="ln947"> </a>
<a name="ln948"> </a>
<a name="ln949">void</a>
<a name="ln950">BMenuField::DoLayout()</a>
<a name="ln951">{</a>
<a name="ln952">	// Bail out, if we shan't do layout.</a>
<a name="ln953">	if ((Flags() &amp; B_SUPPORTS_LAYOUT) == 0)</a>
<a name="ln954">		return;</a>
<a name="ln955"> </a>
<a name="ln956">	CALLED();</a>
<a name="ln957"> </a>
<a name="ln958">	// If the user set a layout, we let the base class version call its</a>
<a name="ln959">	// hook.</a>
<a name="ln960">	if (GetLayout() != NULL) {</a>
<a name="ln961">		BView::DoLayout();</a>
<a name="ln962">		return;</a>
<a name="ln963">	}</a>
<a name="ln964"> </a>
<a name="ln965">	_ValidateLayoutData();</a>
<a name="ln966"> </a>
<a name="ln967">	// validate current size</a>
<a name="ln968">	BSize size(Bounds().Size());</a>
<a name="ln969">	if (size.width &lt; fLayoutData-&gt;min.width)</a>
<a name="ln970">		size.width = fLayoutData-&gt;min.width;</a>
<a name="ln971"> </a>
<a name="ln972">	if (size.height &lt; fLayoutData-&gt;min.height)</a>
<a name="ln973">		size.height = fLayoutData-&gt;min.height;</a>
<a name="ln974"> </a>
<a name="ln975">	// divider</a>
<a name="ln976">	float divider = 0;</a>
<a name="ln977">	if (fLayoutData-&gt;label_layout_item != NULL</a>
<a name="ln978">		&amp;&amp; fLayoutData-&gt;menu_bar_layout_item != NULL</a>
<a name="ln979">		&amp;&amp; fLayoutData-&gt;label_layout_item-&gt;Frame().IsValid()</a>
<a name="ln980">		&amp;&amp; fLayoutData-&gt;menu_bar_layout_item-&gt;Frame().IsValid()) {</a>
<a name="ln981">		// We have valid layout items, they define the divider location.</a>
<a name="ln982">		divider = fabs(fLayoutData-&gt;menu_bar_layout_item-&gt;Frame().left</a>
<a name="ln983">			- fLayoutData-&gt;label_layout_item-&gt;Frame().left);</a>
<a name="ln984">	} else if (fLayoutData-&gt;label_width &gt; 0) {</a>
<a name="ln985">		divider = fLayoutData-&gt;label_width</a>
<a name="ln986">			+ be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln987">	}</a>
<a name="ln988"> </a>
<a name="ln989">	// menu bar</a>
<a name="ln990">	BRect dirty(fMenuBar-&gt;Frame());</a>
<a name="ln991">	BRect menuBarFrame(divider + kVMargin, kVMargin, size.width - kVMargin,</a>
<a name="ln992">		size.height - kVMargin);</a>
<a name="ln993"> </a>
<a name="ln994">	// place the menu bar and set the divider</a>
<a name="ln995">	BLayoutUtils::AlignInFrame(fMenuBar, menuBarFrame);</a>
<a name="ln996"> </a>
<a name="ln997">	fDivider = divider;</a>
<a name="ln998"> </a>
<a name="ln999">	// invalidate dirty region</a>
<a name="ln1000">	dirty = dirty | fMenuBar-&gt;Frame();</a>
<a name="ln1001">	dirty.InsetBy(-kVMargin, -kVMargin);</a>
<a name="ln1002"> </a>
<a name="ln1003">	Invalidate(dirty);</a>
<a name="ln1004">}</a>
<a name="ln1005"> </a>
<a name="ln1006"> </a>
<a name="ln1007">void BMenuField::_ReservedMenuField1() {}</a>
<a name="ln1008">void BMenuField::_ReservedMenuField2() {}</a>
<a name="ln1009">void BMenuField::_ReservedMenuField3() {}</a>
<a name="ln1010"> </a>
<a name="ln1011"> </a>
<a name="ln1012">void</a>
<a name="ln1013">BMenuField::InitObject(const char* label)</a>
<a name="ln1014">{</a>
<a name="ln1015">	CALLED();</a>
<a name="ln1016"> </a>
<a name="ln1017">	fLabel = NULL;</a>
<a name="ln1018">	fMenu = NULL;</a>
<a name="ln1019">	fMenuBar = NULL;</a>
<a name="ln1020">	fAlign = B_ALIGN_LEFT;</a>
<a name="ln1021">	fEnabled = true;</a>
<a name="ln1022">	fFixedSizeMB = false;</a>
<a name="ln1023">	fMenuTaskID = -1;</a>
<a name="ln1024">	fLayoutData = new LayoutData;</a>
<a name="ln1025">	fMouseDownFilter = new MouseDownFilter();</a>
<a name="ln1026"> </a>
<a name="ln1027">	SetLabel(label);</a>
<a name="ln1028"> </a>
<a name="ln1029">	if (label)</a>
<a name="ln1030">		fDivider = floorf(Frame().Width() / 2.0f);</a>
<a name="ln1031">	else</a>
<a name="ln1032">		fDivider = 0;</a>
<a name="ln1033">}</a>
<a name="ln1034"> </a>
<a name="ln1035"> </a>
<a name="ln1036">void</a>
<a name="ln1037">BMenuField::InitObject2()</a>
<a name="ln1038">{</a>
<a name="ln1039">	CALLED();</a>
<a name="ln1040"> </a>
<a name="ln1041">	if (!fFixedSizeMB) {</a>
<a name="ln1042">		float height;</a>
<a name="ln1043">		fMenuBar-&gt;GetPreferredSize(NULL, &amp;height);</a>
<a name="ln1044">		fMenuBar-&gt;ResizeTo(_MenuBarWidth(), height);</a>
<a name="ln1045">	}</a>
<a name="ln1046"> </a>
<a name="ln1047">	TRACE(&quot;frame(%.1f, %.1f, %.1f, %.1f) (%.2f, %.2f)\n&quot;,</a>
<a name="ln1048">		fMenuBar-&gt;Frame().left, fMenuBar-&gt;Frame().top,</a>
<a name="ln1049">		fMenuBar-&gt;Frame().right, fMenuBar-&gt;Frame().bottom,</a>
<a name="ln1050">		fMenuBar-&gt;Frame().Width(), fMenuBar-&gt;Frame().Height());</a>
<a name="ln1051"> </a>
<a name="ln1052">	fMenuBar-&gt;AddFilter(new _BMCFilter_(this, B_MOUSE_DOWN));</a>
<a name="ln1053">}</a>
<a name="ln1054"> </a>
<a name="ln1055"> </a>
<a name="ln1056">void</a>
<a name="ln1057">BMenuField::_DrawLabel(BRect updateRect)</a>
<a name="ln1058">{</a>
<a name="ln1059">	CALLED();</a>
<a name="ln1060"> </a>
<a name="ln1061">	_ValidateLayoutData();</a>
<a name="ln1062"> </a>
<a name="ln1063">	const char* label = Label();</a>
<a name="ln1064">	if (label == NULL)</a>
<a name="ln1065">		return;</a>
<a name="ln1066"> </a>
<a name="ln1067">	BRect rect;</a>
<a name="ln1068">	if (fLayoutData-&gt;label_layout_item != NULL)</a>
<a name="ln1069">		rect = fLayoutData-&gt;label_layout_item-&gt;FrameInParent();</a>
<a name="ln1070">	else {</a>
<a name="ln1071">		rect = Bounds();</a>
<a name="ln1072">		rect.right = fDivider;</a>
<a name="ln1073">	}</a>
<a name="ln1074"> </a>
<a name="ln1075">	if (!rect.IsValid() || !rect.Intersects(updateRect))</a>
<a name="ln1076">		return;</a>
<a name="ln1077"> </a>
<a name="ln1078">	uint32 flags = 0;</a>
<a name="ln1079">	if (!IsEnabled())</a>
<a name="ln1080">		flags |= BControlLook::B_DISABLED;</a>
<a name="ln1081"> </a>
<a name="ln1082">	// save the current low color</a>
<a name="ln1083">	PushState();</a>
<a name="ln1084">	rgb_color textColor;</a>
<a name="ln1085"> </a>
<a name="ln1086">	BPrivate::MenuPrivate menuPrivate(fMenuBar);</a>
<a name="ln1087">	if (menuPrivate.State() != MENU_STATE_CLOSED) {</a>
<a name="ln1088">		// highlight the background of the label grey (like BeOS R5)</a>
<a name="ln1089">		SetLowColor(ui_color(B_MENU_SELECTED_BACKGROUND_COLOR));</a>
<a name="ln1090">		BRect fillRect(rect.InsetByCopy(0, kVMargin));</a>
<a name="ln1091">		FillRect(fillRect, B_SOLID_LOW);</a>
<a name="ln1092">		textColor = ui_color(B_MENU_SELECTED_ITEM_TEXT_COLOR);</a>
<a name="ln1093">	} else</a>
<a name="ln1094">		textColor = ui_color(B_PANEL_TEXT_COLOR);</a>
<a name="ln1095"> </a>
<a name="ln1096">	be_control_look-&gt;DrawLabel(this, label, rect, updateRect, LowColor(), flags,</a>
<a name="ln1097">		BAlignment(fAlign, B_ALIGN_MIDDLE), &amp;textColor);</a>
<a name="ln1098"> </a>
<a name="ln1099">	// restore the previous low color</a>
<a name="ln1100">	PopState();</a>
<a name="ln1101">}</a>
<a name="ln1102"> </a>
<a name="ln1103"> </a>
<a name="ln1104">void</a>
<a name="ln1105">BMenuField::_DrawMenuBar(BRect updateRect)</a>
<a name="ln1106">{</a>
<a name="ln1107">	CALLED();</a>
<a name="ln1108"> </a>
<a name="ln1109">	BRect rect(fMenuBar-&gt;Frame().InsetByCopy(-kVMargin, -kVMargin));</a>
<a name="ln1110">	if (!rect.IsValid() || !rect.Intersects(updateRect))</a>
<a name="ln1111">		return;</a>
<a name="ln1112"> </a>
<a name="ln1113">	uint32 flags = 0;</a>
<a name="ln1114">	if (!IsEnabled())</a>
<a name="ln1115">		flags |= BControlLook::B_DISABLED;</a>
<a name="ln1116"> </a>
<a name="ln1117">	if (IsFocus() &amp;&amp; Window()-&gt;IsActive())</a>
<a name="ln1118">		flags |= BControlLook::B_FOCUSED;</a>
<a name="ln1119"> </a>
<a name="ln1120">	be_control_look-&gt;DrawMenuFieldFrame(this, rect, updateRect,</a>
<a name="ln1121">		fMenuBar-&gt;LowColor(), LowColor(), flags);</a>
<a name="ln1122">}</a>
<a name="ln1123"> </a>
<a name="ln1124"> </a>
<a name="ln1125">void</a>
<a name="ln1126">BMenuField::InitMenu(BMenu* menu)</a>
<a name="ln1127">{</a>
<a name="ln1128">	menu-&gt;SetFont(be_plain_font);</a>
<a name="ln1129"> </a>
<a name="ln1130">	int32 index = 0;</a>
<a name="ln1131">	BMenu* subMenu;</a>
<a name="ln1132"> </a>
<a name="ln1133">	while ((subMenu = menu-&gt;SubmenuAt(index++)) != NULL)</a>
<a name="ln1134">		InitMenu(subMenu);</a>
<a name="ln1135">}</a>
<a name="ln1136"> </a>
<a name="ln1137"> </a>
<a name="ln1138">/*static*/ int32</a>
<a name="ln1139">BMenuField::_thread_entry(void* arg)</a>
<a name="ln1140">{</a>
<a name="ln1141">	return static_cast&lt;BMenuField*&gt;(arg)-&gt;_MenuTask();</a>
<a name="ln1142">}</a>
<a name="ln1143"> </a>
<a name="ln1144"> </a>
<a name="ln1145">int32</a>
<a name="ln1146">BMenuField::_MenuTask()</a>
<a name="ln1147">{</a>
<a name="ln1148">	if (!LockLooper())</a>
<a name="ln1149">		return 0;</a>
<a name="ln1150"> </a>
<a name="ln1151">	Invalidate();</a>
<a name="ln1152">	UnlockLooper();</a>
<a name="ln1153"> </a>
<a name="ln1154">	bool tracking;</a>
<a name="ln1155">	do {</a>
<a name="ln1156">		snooze(20000);</a>
<a name="ln1157">		if (!LockLooper())</a>
<a name="ln1158">			return 0;</a>
<a name="ln1159"> </a>
<a name="ln1160">		tracking = fMenuBar-&gt;fTracking;</a>
<a name="ln1161"> </a>
<a name="ln1162">		UnlockLooper();</a>
<a name="ln1163">	} while (tracking);</a>
<a name="ln1164"> </a>
<a name="ln1165">	if (LockLooper()) {</a>
<a name="ln1166">		Invalidate();</a>
<a name="ln1167">		UnlockLooper();</a>
<a name="ln1168">	}</a>
<a name="ln1169"> </a>
<a name="ln1170">	return 0;</a>
<a name="ln1171">}</a>
<a name="ln1172"> </a>
<a name="ln1173"> </a>
<a name="ln1174">void</a>
<a name="ln1175">BMenuField::_UpdateFrame()</a>
<a name="ln1176">{</a>
<a name="ln1177">	CALLED();</a>
<a name="ln1178"> </a>
<a name="ln1179">	if (fLayoutData-&gt;label_layout_item == NULL</a>
<a name="ln1180">		|| fLayoutData-&gt;menu_bar_layout_item == NULL) {</a>
<a name="ln1181">		return;</a>
<a name="ln1182">	}</a>
<a name="ln1183"> </a>
<a name="ln1184">	BRect labelFrame = fLayoutData-&gt;label_layout_item-&gt;Frame();</a>
<a name="ln1185">	BRect menuFrame = fLayoutData-&gt;menu_bar_layout_item-&gt;Frame();</a>
<a name="ln1186"> </a>
<a name="ln1187">	if (!labelFrame.IsValid() || !menuFrame.IsValid())</a>
<a name="ln1188">		return;</a>
<a name="ln1189"> </a>
<a name="ln1190">	// update divider</a>
<a name="ln1191">	fDivider = menuFrame.left - labelFrame.left;</a>
<a name="ln1192"> </a>
<a name="ln1193">	// update our frame</a>
<a name="ln1194">	MoveTo(labelFrame.left, labelFrame.top);</a>
<a name="ln1195">	BSize oldSize = Bounds().Size();</a>
<a name="ln1196">	ResizeTo(menuFrame.left + menuFrame.Width() - labelFrame.left,</a>
<a name="ln1197">		menuFrame.top + menuFrame.Height() - labelFrame.top);</a>
<a name="ln1198">	BSize newSize = Bounds().Size();</a>
<a name="ln1199"> </a>
<a name="ln1200">	// If the size changes, ResizeTo() will trigger a relayout, otherwise</a>
<a name="ln1201">	// we need to do that explicitly.</a>
<a name="ln1202">	if (newSize != oldSize)</a>
<a name="ln1203">		Relayout();</a>
<a name="ln1204">}</a>
<a name="ln1205"> </a>
<a name="ln1206"> </a>
<a name="ln1207">void</a>
<a name="ln1208">BMenuField::_InitMenuBar(BMenu* menu, BRect frame, bool fixedSize)</a>
<a name="ln1209">{</a>
<a name="ln1210">	CALLED();</a>
<a name="ln1211"> </a>
<a name="ln1212">	if ((Flags() &amp; B_SUPPORTS_LAYOUT) != 0) {</a>
<a name="ln1213">		fMenuBar = new _BMCMenuBar_(this);</a>
<a name="ln1214">	} else {</a>
<a name="ln1215">		frame.left = _MenuBarOffset();</a>
<a name="ln1216">		frame.top = kVMargin;</a>
<a name="ln1217">		frame.right -= kVMargin;</a>
<a name="ln1218">		frame.bottom -= kVMargin;</a>
<a name="ln1219"> </a>
<a name="ln1220">		TRACE(&quot;frame(%.1f, %.1f, %.1f, %.1f) (%.2f, %.2f)\n&quot;,</a>
<a name="ln1221">			frame.left, frame.top, frame.right, frame.bottom,</a>
<a name="ln1222">			frame.Width(), frame.Height());</a>
<a name="ln1223"> </a>
<a name="ln1224">		fMenuBar = new _BMCMenuBar_(frame, fixedSize, this);</a>
<a name="ln1225">	}</a>
<a name="ln1226"> </a>
<a name="ln1227">	if (fixedSize) {</a>
<a name="ln1228">		// align the menu bar in the full available space</a>
<a name="ln1229">		fMenuBar-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_USE_FULL_WIDTH,</a>
<a name="ln1230">			B_ALIGN_VERTICAL_UNSET));</a>
<a name="ln1231">	} else {</a>
<a name="ln1232">		// align the menu bar left in the available space</a>
<a name="ln1233">		fMenuBar-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln1234">			B_ALIGN_VERTICAL_UNSET));</a>
<a name="ln1235">	}</a>
<a name="ln1236"> </a>
<a name="ln1237">	AddChild(fMenuBar);</a>
<a name="ln1238"> </a>
<a name="ln1239">	_AddMenu(menu);</a>
<a name="ln1240"> </a>
<a name="ln1241">	fMenuBar-&gt;SetFont(be_plain_font);</a>
<a name="ln1242">}</a>
<a name="ln1243"> </a>
<a name="ln1244"> </a>
<a name="ln1245">void</a>
<a name="ln1246">BMenuField::_InitMenuBar(const BMessage* archive)</a>
<a name="ln1247">{</a>
<a name="ln1248">	bool fixed;</a>
<a name="ln1249">	if (archive-&gt;FindBool(&quot;be:fixeds&quot;, &amp;fixed) == B_OK)</a>
<a name="ln1250">		fFixedSizeMB = fixed;</a>
<a name="ln1251"> </a>
<a name="ln1252">	fMenuBar = (BMenuBar*)FindView(&quot;_mc_mb_&quot;);</a>
<a name="ln1253">	if (fMenuBar == NULL) {</a>
<a name="ln1254">		_InitMenuBar(new BMenu(&quot;&quot;), BRect(0, 0, 100, 15), fFixedSizeMB);</a>
<a name="ln1255">		InitObject2();</a>
<a name="ln1256">	} else {</a>
<a name="ln1257">		fMenuBar-&gt;AddFilter(new _BMCFilter_(this, B_MOUSE_DOWN));</a>
<a name="ln1258">			// this is normally done in InitObject2()</a>
<a name="ln1259">	}</a>
<a name="ln1260"> </a>
<a name="ln1261">	_AddMenu(fMenuBar-&gt;SubmenuAt(0));</a>
<a name="ln1262"> </a>
<a name="ln1263">	bool disable;</a>
<a name="ln1264">	if (archive-&gt;FindBool(&quot;_disable&quot;, &amp;disable) == B_OK)</a>
<a name="ln1265">		SetEnabled(!disable);</a>
<a name="ln1266"> </a>
<a name="ln1267">	bool dmark = false;</a>
<a name="ln1268">	archive-&gt;FindBool(&quot;be:dmark&quot;, &amp;dmark);</a>
<a name="ln1269">	_BMCMenuBar_* menuBar = dynamic_cast&lt;_BMCMenuBar_*&gt;(fMenuBar);</a>
<a name="ln1270">	if (menuBar != NULL)</a>
<a name="ln1271">		menuBar-&gt;TogglePopUpMarker(dmark);</a>
<a name="ln1272">}</a>
<a name="ln1273"> </a>
<a name="ln1274"> </a>
<a name="ln1275">void</a>
<a name="ln1276">BMenuField::_AddMenu(BMenu* menu)</a>
<a name="ln1277">{</a>
<a name="ln1278">	if (menu == NULL || fMenuBar == NULL)</a>
<a name="ln1279">		return;</a>
<a name="ln1280"> </a>
<a name="ln1281">	fMenu = menu;</a>
<a name="ln1282">	InitMenu(menu);</a>
<a name="ln1283"> </a>
<a name="ln1284">	BMenuItem* item = NULL;</a>
<a name="ln1285">	if (!menu-&gt;IsRadioMode() || (item = menu-&gt;FindMarked()) == NULL) {</a>
<a name="ln1286">		// find the first enabled non-seperator item</a>
<a name="ln1287">		int32 itemCount = menu-&gt;CountItems();</a>
<a name="ln1288">		for (int32 i = 0; i &lt; itemCount; i++) {</a>
<a name="ln1289">			item = menu-&gt;ItemAt((int32)i);</a>
<a name="ln1290">			if (item == NULL || !item-&gt;IsEnabled()</a>
<a name="ln1291">				|| dynamic_cast&lt;BSeparatorItem*&gt;(item) != NULL) {</a>
<a name="ln1292">				item = NULL;</a>
<a name="ln1293">				continue;</a>
<a name="ln1294">			}</a>
<a name="ln1295">			break;</a>
<a name="ln1296">		}</a>
<a name="ln1297">	}</a>
<a name="ln1298"> </a>
<a name="ln1299">	if (item == NULL) {</a>
<a name="ln1300">		fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1301">		return;</a>
<a name="ln1302">	}</a>
<a name="ln1303"> </a>
<a name="ln1304">	// build an empty copy of item</a>
<a name="ln1305"> </a>
<a name="ln1306">	BMessage data;</a>
<a name="ln1307">	status_t result = item-&gt;Archive(&amp;data, false);</a>
<a name="ln1308">	if (result != B_OK) {</a>
<a name="ln1309">		fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1310">		return;</a>
<a name="ln1311">	}</a>
<a name="ln1312"> </a>
<a name="ln1313">	BArchivable* object = instantiate_object(&amp;data);</a>
<a name="ln1314">	if (object == NULL) {</a>
<a name="ln1315">		fMenuBar-&gt;AddItem(menu);</a>
<a name="ln1316">		return;</a>
<a name="ln1317">	}</a>
<a name="ln1318"> </a>
<a name="ln1319">	BMenuItem* newItem = static_cast&lt;BMenuItem*&gt;(object);</a>
<a name="ln1320"> </a>
<a name="ln1321">	// unset parameters</a>
<a name="ln1322">	BPrivate::MenuItemPrivate newMenuItemPrivate(newItem);</a>
<a name="ln1323">	newMenuItemPrivate.Uninstall();</a>
<a name="ln1324"> </a>
<a name="ln1325">	// set the menu</a>
<a name="ln1326">	newMenuItemPrivate.SetSubmenu(menu);</a>
<a name="ln1327">	fMenuBar-&gt;AddItem(newItem);</a>
<a name="ln1328">}</a>
<a name="ln1329"> </a>
<a name="ln1330"> </a>
<a name="ln1331">void</a>
<a name="ln1332">BMenuField::_ValidateLayoutData()</a>
<a name="ln1333">{</a>
<a name="ln1334">	CALLED();</a>
<a name="ln1335"> </a>
<a name="ln1336">	if (fLayoutData-&gt;valid)</a>
<a name="ln1337">		return;</a>
<a name="ln1338"> </a>
<a name="ln1339">	// cache font height</a>
<a name="ln1340">	font_height&amp; fh = fLayoutData-&gt;font_info;</a>
<a name="ln1341">	GetFontHeight(&amp;fh);</a>
<a name="ln1342"> </a>
<a name="ln1343">	const char* label = Label();</a>
<a name="ln1344">	if (label != NULL) {</a>
<a name="ln1345">		fLayoutData-&gt;label_width = ceilf(StringWidth(label));</a>
<a name="ln1346">		fLayoutData-&gt;label_height = ceilf(fh.ascent) + ceilf(fh.descent);</a>
<a name="ln1347">	} else {</a>
<a name="ln1348">		fLayoutData-&gt;label_width = 0;</a>
<a name="ln1349">		fLayoutData-&gt;label_height = 0;</a>
<a name="ln1350">	}</a>
<a name="ln1351"> </a>
<a name="ln1352">	// compute the minimal divider</a>
<a name="ln1353">	float divider = 0;</a>
<a name="ln1354">	if (fLayoutData-&gt;label_width &gt; 0) {</a>
<a name="ln1355">		divider = fLayoutData-&gt;label_width</a>
<a name="ln1356">			+ be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln1357">	}</a>
<a name="ln1358"> </a>
<a name="ln1359">	// If we shan't do real layout, we let the current divider take influence.</a>
<a name="ln1360">	if ((Flags() &amp; B_SUPPORTS_LAYOUT) == 0)</a>
<a name="ln1361">		divider = std::max(divider, fDivider);</a>
<a name="ln1362"> </a>
<a name="ln1363">	// get the minimal (== preferred) menu bar size</a>
<a name="ln1364">	// TODO: BMenu::MinSize() is using the ResizeMode() to decide the</a>
<a name="ln1365">	// minimum width. If the mode is B_FOLLOW_LEFT_RIGHT, it will use the</a>
<a name="ln1366">	// parent's frame width or window's frame width. So at least the returned</a>
<a name="ln1367">	// size is wrong, but apparantly it doesn't have much bad effect.</a>
<a name="ln1368">	fLayoutData-&gt;menu_bar_min = fMenuBar-&gt;MinSize();</a>
<a name="ln1369"> </a>
<a name="ln1370">	TRACE(&quot;menu bar min width: %.2f\n&quot;, fLayoutData-&gt;menu_bar_min.width);</a>
<a name="ln1371"> </a>
<a name="ln1372">	// compute our minimal (== preferred) size</a>
<a name="ln1373">	BSize min(fLayoutData-&gt;menu_bar_min);</a>
<a name="ln1374">	min.width += 2 * kVMargin;</a>
<a name="ln1375">	min.height += 2 * kVMargin;</a>
<a name="ln1376"> </a>
<a name="ln1377">	if (divider &gt; 0)</a>
<a name="ln1378">		min.width += divider;</a>
<a name="ln1379"> </a>
<a name="ln1380">	if (fLayoutData-&gt;label_height &gt; min.height)</a>
<a name="ln1381">		min.height = fLayoutData-&gt;label_height;</a>
<a name="ln1382"> </a>
<a name="ln1383">	fLayoutData-&gt;min = min;</a>
<a name="ln1384"> </a>
<a name="ln1385">	fLayoutData-&gt;valid = true;</a>
<a name="ln1386">	ResetLayoutInvalidation();</a>
<a name="ln1387"> </a>
<a name="ln1388">	TRACE(&quot;width: %.2f, height: %.2f\n&quot;, min.width, min.height);</a>
<a name="ln1389">}</a>
<a name="ln1390"> </a>
<a name="ln1391"> </a>
<a name="ln1392">float</a>
<a name="ln1393">BMenuField::_MenuBarOffset() const</a>
<a name="ln1394">{</a>
<a name="ln1395">	return std::max(fDivider + kVMargin, kVMargin);</a>
<a name="ln1396">}</a>
<a name="ln1397"> </a>
<a name="ln1398"> </a>
<a name="ln1399">float</a>
<a name="ln1400">BMenuField::_MenuBarWidth() const</a>
<a name="ln1401">{</a>
<a name="ln1402">	return Bounds().Width() - (_MenuBarOffset() + kVMargin);</a>
<a name="ln1403">}</a>
<a name="ln1404"> </a>
<a name="ln1405"> </a>
<a name="ln1406">void</a>
<a name="ln1407">BMenuField::_DoneTracking(BPoint point)</a>
<a name="ln1408">{</a>
<a name="ln1409">	Window()-&gt;RemoveCommonFilter(fMouseDownFilter);</a>
<a name="ln1410">}</a>
<a name="ln1411"> </a>
<a name="ln1412"> </a>
<a name="ln1413">void</a>
<a name="ln1414">BMenuField::_Track(BPoint point, uint32)</a>
<a name="ln1415">{</a>
<a name="ln1416">}</a>
<a name="ln1417"> </a>
<a name="ln1418"> </a>
<a name="ln1419">// #pragma mark - BMenuField::LabelLayoutItem</a>
<a name="ln1420"> </a>
<a name="ln1421"> </a>
<a name="ln1422">BMenuField::LabelLayoutItem::LabelLayoutItem(BMenuField* parent)</a>
<a name="ln1423">	:</a>
<a name="ln1424">	fParent(parent),</a>
<a name="ln1425">	fFrame()</a>
<a name="ln1426">{</a>
<a name="ln1427">}</a>
<a name="ln1428"> </a>
<a name="ln1429"> </a>
<a name="ln1430">BMenuField::LabelLayoutItem::LabelLayoutItem(BMessage* from)</a>
<a name="ln1431">	:</a>
<a name="ln1432">	BAbstractLayoutItem(from),</a>
<a name="ln1433">	fParent(NULL),</a>
<a name="ln1434">	fFrame()</a>
<a name="ln1435">{</a>
<a name="ln1436">	from-&gt;FindRect(kFrameField, &amp;fFrame);</a>
<a name="ln1437">}</a>
<a name="ln1438"> </a>
<a name="ln1439"> </a>
<a name="ln1440">BRect</a>
<a name="ln1441">BMenuField::LabelLayoutItem::FrameInParent() const</a>
<a name="ln1442">{</a>
<a name="ln1443">	return fFrame.OffsetByCopy(-fParent-&gt;Frame().left, -fParent-&gt;Frame().top);</a>
<a name="ln1444">}</a>
<a name="ln1445"> </a>
<a name="ln1446"> </a>
<a name="ln1447">bool</a>
<a name="ln1448">BMenuField::LabelLayoutItem::IsVisible()</a>
<a name="ln1449">{</a>
<a name="ln1450">	return !fParent-&gt;IsHidden(fParent);</a>
<a name="ln1451">}</a>
<a name="ln1452"> </a>
<a name="ln1453"> </a>
<a name="ln1454">void</a>
<a name="ln1455">BMenuField::LabelLayoutItem::SetVisible(bool visible)</a>
<a name="ln1456">{</a>
<a name="ln1457">	// not allowed</a>
<a name="ln1458">}</a>
<a name="ln1459"> </a>
<a name="ln1460"> </a>
<a name="ln1461">BRect</a>
<a name="ln1462">BMenuField::LabelLayoutItem::Frame()</a>
<a name="ln1463">{</a>
<a name="ln1464">	return fFrame;</a>
<a name="ln1465">}</a>
<a name="ln1466"> </a>
<a name="ln1467"> </a>
<a name="ln1468">void</a>
<a name="ln1469">BMenuField::LabelLayoutItem::SetFrame(BRect frame)</a>
<a name="ln1470">{</a>
<a name="ln1471">	fFrame = frame;</a>
<a name="ln1472">	fParent-&gt;_UpdateFrame();</a>
<a name="ln1473">}</a>
<a name="ln1474"> </a>
<a name="ln1475"> </a>
<a name="ln1476">void</a>
<a name="ln1477">BMenuField::LabelLayoutItem::SetParent(BMenuField* parent)</a>
<a name="ln1478">{</a>
<a name="ln1479">	fParent = parent;</a>
<a name="ln1480">}</a>
<a name="ln1481"> </a>
<a name="ln1482"> </a>
<a name="ln1483">BView*</a>
<a name="ln1484">BMenuField::LabelLayoutItem::View()</a>
<a name="ln1485">{</a>
<a name="ln1486">	return fParent;</a>
<a name="ln1487">}</a>
<a name="ln1488"> </a>
<a name="ln1489"> </a>
<a name="ln1490">BSize</a>
<a name="ln1491">BMenuField::LabelLayoutItem::BaseMinSize()</a>
<a name="ln1492">{</a>
<a name="ln1493">	fParent-&gt;_ValidateLayoutData();</a>
<a name="ln1494"> </a>
<a name="ln1495">	if (fParent-&gt;Label() == NULL)</a>
<a name="ln1496">		return BSize(-1, -1);</a>
<a name="ln1497"> </a>
<a name="ln1498">	return BSize(fParent-&gt;fLayoutData-&gt;label_width</a>
<a name="ln1499">			+ be_control_look-&gt;DefaultLabelSpacing(),</a>
<a name="ln1500">		fParent-&gt;fLayoutData-&gt;label_height);</a>
<a name="ln1501">}</a>
<a name="ln1502"> </a>
<a name="ln1503"> </a>
<a name="ln1504">BSize</a>
<a name="ln1505">BMenuField::LabelLayoutItem::BaseMaxSize()</a>
<a name="ln1506">{</a>
<a name="ln1507">	return BaseMinSize();</a>
<a name="ln1508">}</a>
<a name="ln1509"> </a>
<a name="ln1510"> </a>
<a name="ln1511">BSize</a>
<a name="ln1512">BMenuField::LabelLayoutItem::BasePreferredSize()</a>
<a name="ln1513">{</a>
<a name="ln1514">	return BaseMinSize();</a>
<a name="ln1515">}</a>
<a name="ln1516"> </a>
<a name="ln1517"> </a>
<a name="ln1518">BAlignment</a>
<a name="ln1519">BMenuField::LabelLayoutItem::BaseAlignment()</a>
<a name="ln1520">{</a>
<a name="ln1521">	return BAlignment(B_ALIGN_USE_FULL_WIDTH, B_ALIGN_USE_FULL_HEIGHT);</a>
<a name="ln1522">}</a>
<a name="ln1523"> </a>
<a name="ln1524"> </a>
<a name="ln1525">status_t</a>
<a name="ln1526">BMenuField::LabelLayoutItem::Archive(BMessage* into, bool deep) const</a>
<a name="ln1527">{</a>
<a name="ln1528">	BArchiver archiver(into);</a>
<a name="ln1529">	status_t err = BAbstractLayoutItem::Archive(into, deep);</a>
<a name="ln1530"> </a>
<a name="ln1531">	if (err == B_OK)</a>
<a name="ln1532">		err = into-&gt;AddRect(kFrameField, fFrame);</a>
<a name="ln1533"> </a>
<a name="ln1534">	return archiver.Finish(err);</a>
<a name="ln1535">}</a>
<a name="ln1536"> </a>
<a name="ln1537"> </a>
<a name="ln1538">BArchivable*</a>
<a name="ln1539">BMenuField::LabelLayoutItem::Instantiate(BMessage* from)</a>
<a name="ln1540">{</a>
<a name="ln1541">	if (validate_instantiation(from, &quot;BMenuField::LabelLayoutItem&quot;))</a>
<a name="ln1542">		return new LabelLayoutItem(from);</a>
<a name="ln1543"> </a>
<a name="ln1544">	return NULL;</a>
<a name="ln1545">}</a>
<a name="ln1546"> </a>
<a name="ln1547"> </a>
<a name="ln1548">// #pragma mark - BMenuField::MenuBarLayoutItem</a>
<a name="ln1549"> </a>
<a name="ln1550"> </a>
<a name="ln1551">BMenuField::MenuBarLayoutItem::MenuBarLayoutItem(BMenuField* parent)</a>
<a name="ln1552">	:</a>
<a name="ln1553">	fParent(parent),</a>
<a name="ln1554">	fFrame()</a>
<a name="ln1555">{</a>
<a name="ln1556">	// by default the part right of the divider shall have an unlimited maximum</a>
<a name="ln1557">	// width</a>
<a name="ln1558">	SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln1559">}</a>
<a name="ln1560"> </a>
<a name="ln1561"> </a>
<a name="ln1562">BMenuField::MenuBarLayoutItem::MenuBarLayoutItem(BMessage* from)</a>
<a name="ln1563">	:</a>
<a name="ln1564">	BAbstractLayoutItem(from),</a>
<a name="ln1565">	fParent(NULL),</a>
<a name="ln1566">	fFrame()</a>
<a name="ln1567">{</a>
<a name="ln1568">	from-&gt;FindRect(kFrameField, &amp;fFrame);</a>
<a name="ln1569">}</a>
<a name="ln1570"> </a>
<a name="ln1571"> </a>
<a name="ln1572">BRect</a>
<a name="ln1573">BMenuField::MenuBarLayoutItem::FrameInParent() const</a>
<a name="ln1574">{</a>
<a name="ln1575">	return fFrame.OffsetByCopy(-fParent-&gt;Frame().left, -fParent-&gt;Frame().top);</a>
<a name="ln1576">}</a>
<a name="ln1577"> </a>
<a name="ln1578"> </a>
<a name="ln1579">bool</a>
<a name="ln1580">BMenuField::MenuBarLayoutItem::IsVisible()</a>
<a name="ln1581">{</a>
<a name="ln1582">	return !fParent-&gt;IsHidden(fParent);</a>
<a name="ln1583">}</a>
<a name="ln1584"> </a>
<a name="ln1585"> </a>
<a name="ln1586">void</a>
<a name="ln1587">BMenuField::MenuBarLayoutItem::SetVisible(bool visible)</a>
<a name="ln1588">{</a>
<a name="ln1589">	// not allowed</a>
<a name="ln1590">}</a>
<a name="ln1591"> </a>
<a name="ln1592"> </a>
<a name="ln1593">BRect</a>
<a name="ln1594">BMenuField::MenuBarLayoutItem::Frame()</a>
<a name="ln1595">{</a>
<a name="ln1596">	return fFrame;</a>
<a name="ln1597">}</a>
<a name="ln1598"> </a>
<a name="ln1599"> </a>
<a name="ln1600">void</a>
<a name="ln1601">BMenuField::MenuBarLayoutItem::SetFrame(BRect frame)</a>
<a name="ln1602">{</a>
<a name="ln1603">	fFrame = frame;</a>
<a name="ln1604">	fParent-&gt;_UpdateFrame();</a>
<a name="ln1605">}</a>
<a name="ln1606"> </a>
<a name="ln1607"> </a>
<a name="ln1608">void</a>
<a name="ln1609">BMenuField::MenuBarLayoutItem::SetParent(BMenuField* parent)</a>
<a name="ln1610">{</a>
<a name="ln1611">	fParent = parent;</a>
<a name="ln1612">}</a>
<a name="ln1613"> </a>
<a name="ln1614"> </a>
<a name="ln1615">BView*</a>
<a name="ln1616">BMenuField::MenuBarLayoutItem::View()</a>
<a name="ln1617">{</a>
<a name="ln1618">	return fParent;</a>
<a name="ln1619">}</a>
<a name="ln1620"> </a>
<a name="ln1621"> </a>
<a name="ln1622">BSize</a>
<a name="ln1623">BMenuField::MenuBarLayoutItem::BaseMinSize()</a>
<a name="ln1624">{</a>
<a name="ln1625">	fParent-&gt;_ValidateLayoutData();</a>
<a name="ln1626"> </a>
<a name="ln1627">	BSize size = fParent-&gt;fLayoutData-&gt;menu_bar_min;</a>
<a name="ln1628">	size.width += 2 * kVMargin;</a>
<a name="ln1629">	size.height += 2 * kVMargin;</a>
<a name="ln1630"> </a>
<a name="ln1631">	return size;</a>
<a name="ln1632">}</a>
<a name="ln1633"> </a>
<a name="ln1634"> </a>
<a name="ln1635">BSize</a>
<a name="ln1636">BMenuField::MenuBarLayoutItem::BaseMaxSize()</a>
<a name="ln1637">{</a>
<a name="ln1638">	BSize size(BaseMinSize());</a>
<a name="ln1639">	size.width = B_SIZE_UNLIMITED;</a>
<a name="ln1640"> </a>
<a name="ln1641">	return size;</a>
<a name="ln1642">}</a>
<a name="ln1643"> </a>
<a name="ln1644"> </a>
<a name="ln1645">BSize</a>
<a name="ln1646">BMenuField::MenuBarLayoutItem::BasePreferredSize()</a>
<a name="ln1647">{</a>
<a name="ln1648">	return BaseMinSize();</a>
<a name="ln1649">}</a>
<a name="ln1650"> </a>
<a name="ln1651"> </a>
<a name="ln1652">BAlignment</a>
<a name="ln1653">BMenuField::MenuBarLayoutItem::BaseAlignment()</a>
<a name="ln1654">{</a>
<a name="ln1655">	return BAlignment(B_ALIGN_USE_FULL_WIDTH, B_ALIGN_USE_FULL_HEIGHT);</a>
<a name="ln1656">}</a>
<a name="ln1657"> </a>
<a name="ln1658"> </a>
<a name="ln1659">status_t</a>
<a name="ln1660">BMenuField::MenuBarLayoutItem::Archive(BMessage* into, bool deep) const</a>
<a name="ln1661">{</a>
<a name="ln1662">	BArchiver archiver(into);</a>
<a name="ln1663">	status_t err = BAbstractLayoutItem::Archive(into, deep);</a>
<a name="ln1664"> </a>
<a name="ln1665">	if (err == B_OK)</a>
<a name="ln1666">		err = into-&gt;AddRect(kFrameField, fFrame);</a>
<a name="ln1667"> </a>
<a name="ln1668">	return archiver.Finish(err);</a>
<a name="ln1669">}</a>
<a name="ln1670"> </a>
<a name="ln1671"> </a>
<a name="ln1672">BArchivable*</a>
<a name="ln1673">BMenuField::MenuBarLayoutItem::Instantiate(BMessage* from)</a>
<a name="ln1674">{</a>
<a name="ln1675">	if (validate_instantiation(from, &quot;BMenuField::MenuBarLayoutItem&quot;))</a>
<a name="ln1676">		return new MenuBarLayoutItem(from);</a>
<a name="ln1677">	return NULL;</a>
<a name="ln1678">}</a>
<a name="ln1679"> </a>
<a name="ln1680"> </a>
<a name="ln1681">extern &quot;C&quot; void</a>
<a name="ln1682">B_IF_GCC_2(InvalidateLayout__10BMenuFieldb, _ZN10BMenuField16InvalidateLayoutEb)(</a>
<a name="ln1683">	BMenuField* field, bool descendants)</a>
<a name="ln1684">{</a>
<a name="ln1685">	perform_data_layout_invalidated data;</a>
<a name="ln1686">	data.descendants = descendants;</a>
<a name="ln1687"> </a>
<a name="ln1688">	field-&gt;Perform(PERFORM_CODE_LAYOUT_INVALIDATED, &amp;data);</a>
<a name="ln1689">}</a>

</code></pre>
<div class="balloon" rel="143"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: font_info, label_width, label_height.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
