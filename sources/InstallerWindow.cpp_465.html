
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>InstallerWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2009-2010, Stephan Aßmus &lt;superstippi@gmx.de&gt;</a>
<a name="ln3"> * Copyright 2005-2008, Jérôme DUVAL</a>
<a name="ln4"> * All rights reserved. Distributed under the terms of the MIT License.</a>
<a name="ln5"> */</a>
<a name="ln6"> </a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;InstallerWindow.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;stdio.h&gt;</a>
<a name="ln11">#include &lt;strings.h&gt;</a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;Alert.h&gt;</a>
<a name="ln14">#include &lt;Application.h&gt;</a>
<a name="ln15">#include &lt;Autolock.h&gt;</a>
<a name="ln16">#include &lt;Box.h&gt;</a>
<a name="ln17">#include &lt;Button.h&gt;</a>
<a name="ln18">#include &lt;Catalog.h&gt;</a>
<a name="ln19">#include &lt;ControlLook.h&gt;</a>
<a name="ln20">#include &lt;Directory.h&gt;</a>
<a name="ln21">#include &lt;FindDirectory.h&gt;</a>
<a name="ln22">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln23">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln24">#include &lt;Locale.h&gt;</a>
<a name="ln25">#include &lt;MenuBar.h&gt;</a>
<a name="ln26">#include &lt;MenuField.h&gt;</a>
<a name="ln27">#include &lt;Path.h&gt;</a>
<a name="ln28">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln29">#include &lt;Roster.h&gt;</a>
<a name="ln30">#include &lt;Screen.h&gt;</a>
<a name="ln31">#include &lt;ScrollView.h&gt;</a>
<a name="ln32">#include &lt;SeparatorView.h&gt;</a>
<a name="ln33">#include &lt;SpaceLayoutItem.h&gt;</a>
<a name="ln34">#include &lt;StatusBar.h&gt;</a>
<a name="ln35">#include &lt;String.h&gt;</a>
<a name="ln36">#include &lt;TextView.h&gt;</a>
<a name="ln37">#include &lt;TranslationUtils.h&gt;</a>
<a name="ln38">#include &lt;TranslatorFormats.h&gt;</a>
<a name="ln39"> </a>
<a name="ln40">#include &quot;tracker_private.h&quot;</a>
<a name="ln41"> </a>
<a name="ln42">#include &quot;DialogPane.h&quot;</a>
<a name="ln43">#include &quot;InstallerDefs.h&quot;</a>
<a name="ln44">#include &quot;PackageViews.h&quot;</a>
<a name="ln45">#include &quot;PartitionMenuItem.h&quot;</a>
<a name="ln46">#include &quot;WorkerThread.h&quot;</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln50">#define B_TRANSLATION_CONTEXT &quot;InstallerWindow&quot;</a>
<a name="ln51"> </a>
<a name="ln52"> </a>
<a name="ln53">static const char* kDriveSetupSignature = &quot;application/x-vnd.Haiku-DriveSetup&quot;;</a>
<a name="ln54">static const char* kBootManagerSignature</a>
<a name="ln55">	= &quot;application/x-vnd.Haiku-BootManager&quot;;</a>
<a name="ln56"> </a>
<a name="ln57">const uint32 BEGIN_MESSAGE = 'iBGN';</a>
<a name="ln58">const uint32 SHOW_BOTTOM_MESSAGE = 'iSBT';</a>
<a name="ln59">const uint32 LAUNCH_DRIVE_SETUP = 'iSEP';</a>
<a name="ln60">const uint32 LAUNCH_BOOTMAN = 'iWBM';</a>
<a name="ln61">const uint32 START_SCAN = 'iSSC';</a>
<a name="ln62">const uint32 PACKAGE_CHECKBOX = 'iPCB';</a>
<a name="ln63">const uint32 ENCOURAGE_DRIVESETUP = 'iENC';</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">class LogoView : public BView {</a>
<a name="ln67">public:</a>
<a name="ln68">								LogoView(const BRect&amp; frame);</a>
<a name="ln69">								LogoView();</a>
<a name="ln70">	virtual						~LogoView();</a>
<a name="ln71"> </a>
<a name="ln72">	virtual	void				Draw(BRect update);</a>
<a name="ln73"> </a>
<a name="ln74">	virtual	void				GetPreferredSize(float* _width,</a>
<a name="ln75">									float* _height);</a>
<a name="ln76"> </a>
<a name="ln77">private:</a>
<a name="ln78">			void				_Init();</a>
<a name="ln79"> </a>
<a name="ln80">			BBitmap*			fLogo;</a>
<a name="ln81">};</a>
<a name="ln82"> </a>
<a name="ln83"> </a>
<a name="ln84">LogoView::LogoView(const BRect&amp; frame)</a>
<a name="ln85">	:</a>
<a name="ln86">	BView(frame, &quot;logoview&quot;, B_FOLLOW_LEFT | B_FOLLOW_TOP,</a>
<a name="ln87">		B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE)</a>
<a name="ln88">{</a>
<a name="ln89">	_Init();</a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92"> </a>
<a name="ln93">LogoView::LogoView()</a>
<a name="ln94">	:</a>
<a name="ln95">	BView(&quot;logoview&quot;, B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE)</a>
<a name="ln96">{</a>
<a name="ln97">	_Init();</a>
<a name="ln98">}</a>
<a name="ln99"> </a>
<a name="ln100"> </a>
<a name="ln101">LogoView::~LogoView(void)</a>
<a name="ln102">{</a>
<a name="ln103">	delete fLogo;</a>
<a name="ln104">}</a>
<a name="ln105"> </a>
<a name="ln106"> </a>
<a name="ln107">void</a>
<a name="ln108">LogoView::Draw(BRect update)</a>
<a name="ln109">{</a>
<a name="ln110">	if (fLogo == NULL)</a>
<a name="ln111">		return;</a>
<a name="ln112"> </a>
<a name="ln113">	BRect bounds(Bounds());</a>
<a name="ln114">	BPoint placement;</a>
<a name="ln115">	placement.x = (bounds.left + bounds.right - fLogo-&gt;Bounds().Width()) / 2;</a>
<a name="ln116">	placement.y = (bounds.top + bounds.bottom - fLogo-&gt;Bounds().Height()) / 2;</a>
<a name="ln117"> </a>
<a name="ln118">	DrawBitmap(fLogo, placement);</a>
<a name="ln119">}</a>
<a name="ln120"> </a>
<a name="ln121"> </a>
<a name="ln122">void</a>
<a name="ln123">LogoView::GetPreferredSize(float* _width, float* _height)</a>
<a name="ln124">{</a>
<a name="ln125">	float width = 0.0;</a>
<a name="ln126">	float height = 0.0;</a>
<a name="ln127">	if (fLogo) {</a>
<a name="ln128">		width = fLogo-&gt;Bounds().Width();</a>
<a name="ln129">		height = fLogo-&gt;Bounds().Height();</a>
<a name="ln130">	}</a>
<a name="ln131">	if (_width)</a>
<a name="ln132">		*_width = width;</a>
<a name="ln133">	if (_height)</a>
<a name="ln134">		*_height = height;</a>
<a name="ln135">}</a>
<a name="ln136"> </a>
<a name="ln137"> </a>
<a name="ln138">void</a>
<a name="ln139">LogoView::_Init()</a>
<a name="ln140">{</a>
<a name="ln141">	fLogo = BTranslationUtils::GetBitmap(B_PNG_FORMAT, &quot;logo.png&quot;);</a>
<a name="ln142">}</a>
<a name="ln143"> </a>
<a name="ln144"> </a>
<a name="ln145">// #pragma mark -</a>
<a name="ln146"> </a>
<a name="ln147"> </a>
<a name="ln148">static BLayoutItem*</a>
<a name="ln149">layout_item_for(BView* view)</a>
<a name="ln150">{</a>
<a name="ln151">	BLayout* layout = view-&gt;Parent()-&gt;GetLayout();</a>
<a name="ln152">	int32 index = layout-&gt;IndexOfView(view);</a>
<a name="ln153">	return layout-&gt;ItemAt(index);</a>
<a name="ln154">}</a>
<a name="ln155"> </a>
<a name="ln156"> </a>
<a name="ln157">InstallerWindow::InstallerWindow()</a>
<a name="ln158">	:</a>
<a name="ln159">	BWindow(BRect(-2000, -2000, -1800, -1800),</a>
<a name="ln160">		B_TRANSLATE_SYSTEM_NAME(&quot;Installer&quot;), B_TITLED_WINDOW,</a>
<a name="ln161">		B_NOT_ZOOMABLE | B_AUTO_UPDATE_SIZE_LIMITS),</a>
<a name="ln162">	fEncouragedToSetupPartitions(false),</a>
<a name="ln163">	fDriveSetupLaunched(false),</a>
<a name="ln164">	fBootManagerLaunched(false),</a>
<a name="ln165">	fInstallStatus(kReadyForInstall),</a>
<a name="ln166">	fWorkerThread(new WorkerThread(this)),</a>
<a name="ln167">	fCopyEngineCancelSemaphore(-1)</a>
<a name="ln168">{</a>
<a name="ln169">	if (!be_roster-&gt;IsRunning(kTrackerSignature))</a>
<a name="ln170">		SetWorkspaces(B_ALL_WORKSPACES);</a>
<a name="ln171"> </a>
<a name="ln172">	LogoView* logoView = new LogoView();</a>
<a name="ln173"> </a>
<a name="ln174">	fStatusView = new BTextView(&quot;statusView&quot;, be_plain_font, NULL,</a>
<a name="ln175">		B_WILL_DRAW);</a>
<a name="ln176">	fStatusView-&gt;SetViewColor(255, 255, 255, 255);</a>
<a name="ln177">	fStatusView-&gt;SetInsets(10, 0, 10, 0);</a>
<a name="ln178">	fStatusView-&gt;MakeEditable(false);</a>
<a name="ln179">	fStatusView-&gt;MakeSelectable(false);</a>
<a name="ln180"> </a>
<a name="ln181">	BSize logoSize = logoView-&gt;MinSize();</a>
<a name="ln182">	logoView-&gt;SetExplicitMaxSize(logoSize);</a>
<a name="ln183">	fStatusView-&gt;SetExplicitMinSize(BSize(logoSize.width * 0.8,</a>
<a name="ln184">		logoSize.height));</a>
<a name="ln185"> </a>
<a name="ln186">	// Explicitly create group view to set the background white in case</a>
<a name="ln187">	// height resizing is needed for the status view</a>
<a name="ln188">	fLogoGroup = new BGroupView(B_HORIZONTAL, 0);</a>
<a name="ln189">	fLogoGroup-&gt;SetViewColor(255, 255, 255);</a>
<a name="ln190">	fLogoGroup-&gt;GroupLayout()-&gt;AddView(logoView);</a>
<a name="ln191">	fLogoGroup-&gt;GroupLayout()-&gt;AddView(fStatusView);</a>
<a name="ln192"> </a>
<a name="ln193">	fDestMenu = new BPopUpMenu(B_TRANSLATE(&quot;scanning&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln194">		true, false);</a>
<a name="ln195">	fSrcMenu = new BPopUpMenu(B_TRANSLATE(&quot;scanning&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln196">		true, false);</a>
<a name="ln197"> </a>
<a name="ln198">	fSrcMenuField = new BMenuField(&quot;srcMenuField&quot;,</a>
<a name="ln199">		B_TRANSLATE(&quot;Install from:&quot;), fSrcMenu);</a>
<a name="ln200">	fSrcMenuField-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln201"> </a>
<a name="ln202">	fDestMenuField = new BMenuField(&quot;destMenuField&quot;, B_TRANSLATE(&quot;Onto:&quot;),</a>
<a name="ln203">		fDestMenu);</a>
<a name="ln204">	fDestMenuField-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln205"> </a>
<a name="ln206">	fPackagesSwitch = new PaneSwitch(&quot;options_button&quot;);</a>
<a name="ln207">	fPackagesSwitch-&gt;SetLabels(B_TRANSLATE(&quot;Hide optional packages&quot;),</a>
<a name="ln208">		B_TRANSLATE(&quot;Show optional packages&quot;));</a>
<a name="ln209">	fPackagesSwitch-&gt;SetMessage(new BMessage(SHOW_BOTTOM_MESSAGE));</a>
<a name="ln210">	fPackagesSwitch-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED,</a>
<a name="ln211">		B_SIZE_UNSET));</a>
<a name="ln212">	fPackagesSwitch-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln213">		B_ALIGN_TOP));</a>
<a name="ln214"> </a>
<a name="ln215">	fPackagesView = new PackagesView(&quot;packages_view&quot;);</a>
<a name="ln216">	BScrollView* packagesScrollView = new BScrollView(&quot;packagesScroll&quot;,</a>
<a name="ln217">		fPackagesView, B_WILL_DRAW, false, true);</a>
<a name="ln218"> </a>
<a name="ln219">	const char* requiredDiskSpaceString</a>
<a name="ln220">		= B_TRANSLATE(&quot;Additional disk space required: 0.0 KiB&quot;);</a>
<a name="ln221">	fSizeView = new BStringView(&quot;size_view&quot;, requiredDiskSpaceString);</a>
<a name="ln222">	fSizeView-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln223">	fSizeView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNLIMITED));</a>
<a name="ln224">	fSizeView-&gt;SetExplicitAlignment(</a>
<a name="ln225">		BAlignment(B_ALIGN_RIGHT, B_ALIGN_MIDDLE));</a>
<a name="ln226"> </a>
<a name="ln227">	fProgressBar = new BStatusBar(&quot;progress&quot;,</a>
<a name="ln228">		B_TRANSLATE(&quot;Install progress:  &quot;));</a>
<a name="ln229">	fProgressBar-&gt;SetMaxValue(100.0);</a>
<a name="ln230"> </a>
<a name="ln231">	fBeginButton = new BButton(&quot;begin_button&quot;, B_TRANSLATE(&quot;Begin&quot;),</a>
<a name="ln232">		new BMessage(BEGIN_MESSAGE));</a>
<a name="ln233">	fBeginButton-&gt;MakeDefault(true);</a>
<a name="ln234">	fBeginButton-&gt;SetEnabled(false);</a>
<a name="ln235"> </a>
<a name="ln236">	fLaunchDriveSetupButton = new BButton(&quot;setup_button&quot;,</a>
<a name="ln237">		B_TRANSLATE(&quot;Set up partitions&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln238">		new BMessage(LAUNCH_DRIVE_SETUP));</a>
<a name="ln239"> </a>
<a name="ln240">	fLaunchBootManagerItem = new BMenuItem(B_TRANSLATE(&quot;Set up boot menu&quot;),</a>
<a name="ln241">		new BMessage(LAUNCH_BOOTMAN));</a>
<a name="ln242">	fLaunchBootManagerItem-&gt;SetEnabled(false);</a>
<a name="ln243"> </a>
<a name="ln244">	fMakeBootableItem = new BMenuItem(B_TRANSLATE(&quot;Write boot sector&quot;),</a>
<a name="ln245">		new BMessage(MSG_WRITE_BOOT_SECTOR));</a>
<a name="ln246">	fMakeBootableItem-&gt;SetEnabled(false);</a>
<a name="ln247">	BMenuBar* mainMenu = new BMenuBar(&quot;main menu&quot;);</a>
<a name="ln248">	BMenu* toolsMenu = new BMenu(B_TRANSLATE(&quot;Tools&quot;));</a>
<a name="ln249">	toolsMenu-&gt;AddItem(fLaunchBootManagerItem);</a>
<a name="ln250">	toolsMenu-&gt;AddItem(fMakeBootableItem);</a>
<a name="ln251">	mainMenu-&gt;AddItem(toolsMenu);</a>
<a name="ln252"> </a>
<a name="ln253">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln254">		.Add(mainMenu)</a>
<a name="ln255">		.Add(fLogoGroup)</a>
<a name="ln256">		.Add(new BSeparatorView(B_HORIZONTAL, B_PLAIN_BORDER))</a>
<a name="ln257">		.AddGroup(B_VERTICAL, B_USE_ITEM_SPACING)</a>
<a name="ln258">			.SetInsets(B_USE_WINDOW_SPACING)</a>
<a name="ln259">			.AddGrid(new BGridView(B_USE_ITEM_SPACING, B_USE_ITEM_SPACING))</a>
<a name="ln260">				.Add(fSrcMenuField-&gt;CreateLabelLayoutItem(), 0, 0)</a>
<a name="ln261">				.Add(fSrcMenuField-&gt;CreateMenuBarLayoutItem(), 1, 0)</a>
<a name="ln262">				.Add(fDestMenuField-&gt;CreateLabelLayoutItem(), 0, 1)</a>
<a name="ln263">				.Add(fDestMenuField-&gt;CreateMenuBarLayoutItem(), 1, 1)</a>
<a name="ln264"> </a>
<a name="ln265">				.Add(BSpaceLayoutItem::CreateVerticalStrut(5), 0, 2, 2)</a>
<a name="ln266"> </a>
<a name="ln267">				.Add(fPackagesSwitch, 0, 3, 2)</a>
<a name="ln268">				.Add(packagesScrollView, 0, 4, 2)</a>
<a name="ln269">				.Add(fProgressBar, 0, 5, 2)</a>
<a name="ln270">				.Add(fSizeView, 0, 6, 2)</a>
<a name="ln271">			.End()</a>
<a name="ln272"> </a>
<a name="ln273">			.AddGroup(B_HORIZONTAL, B_USE_WINDOW_SPACING)</a>
<a name="ln274">				.Add(fLaunchDriveSetupButton)</a>
<a name="ln275">				.AddGlue()</a>
<a name="ln276">				.Add(fBeginButton);</a>
<a name="ln277"> </a>
<a name="ln278">	// Make the optional packages and progress bar invisible on start</a>
<a name="ln279">	fPackagesLayoutItem = layout_item_for(packagesScrollView);</a>
<a name="ln280">	fPkgSwitchLayoutItem = layout_item_for(fPackagesSwitch);</a>
<a name="ln281">	fSizeViewLayoutItem = layout_item_for(fSizeView);</a>
<a name="ln282">	fProgressLayoutItem = layout_item_for(fProgressBar);</a>
<a name="ln283"> </a>
<a name="ln284">	fPackagesLayoutItem-&gt;SetVisible(false);</a>
<a name="ln285">	fSizeViewLayoutItem-&gt;SetVisible(false);</a>
<a name="ln286">	fProgressLayoutItem-&gt;SetVisible(false);</a>
<a name="ln287"> </a>
<a name="ln288">	// Setup tool tips for the non-obvious features</a>
<a name="ln289">	fLaunchDriveSetupButton-&gt;SetToolTip(</a>
<a name="ln290">		B_TRANSLATE(&quot;Launch the DriveSetup utility to partition\n&quot;</a>
<a name="ln291">		&quot;available hard drives and other media.\n&quot;</a>
<a name="ln292">		&quot;Partitions can be initialized with the\n&quot;</a>
<a name="ln293">		&quot;Be File System needed for a Haiku boot\n&quot;</a>
<a name="ln294">		&quot;partition.&quot;));</a>
<a name="ln295">//	fLaunchBootManagerItem-&gt;SetToolTip(</a>
<a name="ln296">//		B_TRANSLATE(&quot;Install or uninstall the Haiku boot menu, which allows &quot;</a>
<a name="ln297">//		&quot;to choose an operating system to boot when the computer starts.\n&quot;</a>
<a name="ln298">//		&quot;If this computer already has a boot manager such as GRUB installed, &quot;</a>
<a name="ln299">//		&quot;it is better to add Haiku to that menu than to overwrite it.&quot;));</a>
<a name="ln300">//	fMakeBootableItem-&gt;SetToolTip(</a>
<a name="ln301">//		B_TRANSLATE(&quot;Writes the Haiku boot code to the partition start\n&quot;</a>
<a name="ln302">//		&quot;sector. This step is automatically performed by\n&quot;</a>
<a name="ln303">//		&quot;the installation, but you can manually make a\n&quot;</a>
<a name="ln304">//		&quot;partition bootable in case you do not need to\n&quot;</a>
<a name="ln305">//		&quot;perform an installation.&quot;));</a>
<a name="ln306"> </a>
<a name="ln307">	// finish creating window</a>
<a name="ln308">	if (!be_roster-&gt;IsRunning(kDeskbarSignature))</a>
<a name="ln309">		SetFlags(Flags() | B_NOT_MINIMIZABLE);</a>
<a name="ln310"> </a>
<a name="ln311">	CenterOnScreen();</a>
<a name="ln312">	Show();</a>
<a name="ln313"> </a>
<a name="ln314">	// Register to receive notifications when apps launch or quit...</a>
<a name="ln315">	be_roster-&gt;StartWatching(this);</a>
<a name="ln316">	// ... and check the two we are interested in.</a>
<a name="ln317">	fDriveSetupLaunched = be_roster-&gt;IsRunning(kDriveSetupSignature);</a>
<a name="ln318">	fBootManagerLaunched = be_roster-&gt;IsRunning(kBootManagerSignature);</a>
<a name="ln319"> </a>
<a name="ln320">	if (Lock()) {</a>
<a name="ln321">		fLaunchDriveSetupButton-&gt;SetEnabled(!fDriveSetupLaunched);</a>
<a name="ln322">		fLaunchBootManagerItem-&gt;SetEnabled(!fBootManagerLaunched);</a>
<a name="ln323">		Unlock();</a>
<a name="ln324">	}</a>
<a name="ln325"> </a>
<a name="ln326">	PostMessage(START_SCAN);</a>
<a name="ln327">}</a>
<a name="ln328"> </a>
<a name="ln329"> </a>
<a name="ln330">InstallerWindow::~InstallerWindow()</a>
<a name="ln331">{</a>
<a name="ln332">	_SetCopyEngineCancelSemaphore(-1);</a>
<a name="ln333">	be_roster-&gt;StopWatching(this);</a>
<a name="ln334">}</a>
<a name="ln335"> </a>
<a name="ln336"> </a>
<a name="ln337">void</a>
<a name="ln338">InstallerWindow::MessageReceived(BMessage *msg)</a>
<a name="ln339">{</a>
<a name="ln340">	switch (msg-&gt;what) {</a>
<a name="ln341">		case MSG_RESET:</a>
<a name="ln342">		{</a>
<a name="ln343">			_SetCopyEngineCancelSemaphore(-1);</a>
<a name="ln344"> </a>
<a name="ln345">			status_t error;</a>
<a name="ln346">			if (msg-&gt;FindInt32(&quot;error&quot;, &amp;error) == B_OK) {</a>
<a name="ln347">				char errorMessage[2048];</a>
<a name="ln348">				snprintf(errorMessage, sizeof(errorMessage),</a>
<a name="ln349">					B_TRANSLATE(&quot;An error was encountered and the &quot;</a>
<a name="ln350">					&quot;installation was not completed:\n\n&quot;</a>
<a name="ln351">					&quot;Error:  %s&quot;), strerror(error));</a>
<a name="ln352">				BAlert* alert = new BAlert(&quot;error&quot;, errorMessage, B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln353">				alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln354">				alert-&gt;Go();</a>
<a name="ln355">			}</a>
<a name="ln356"> </a>
<a name="ln357">			_DisableInterface(false);</a>
<a name="ln358"> </a>
<a name="ln359">			fProgressLayoutItem-&gt;SetVisible(false);</a>
<a name="ln360">			fPkgSwitchLayoutItem-&gt;SetVisible(true);</a>
<a name="ln361">			_ShowOptionalPackages();</a>
<a name="ln362">			_UpdateControls();</a>
<a name="ln363">			break;</a>
<a name="ln364">		}</a>
<a name="ln365">		case START_SCAN:</a>
<a name="ln366">			_ScanPartitions();</a>
<a name="ln367">			break;</a>
<a name="ln368">		case BEGIN_MESSAGE:</a>
<a name="ln369">			switch (fInstallStatus) {</a>
<a name="ln370">				case kReadyForInstall:</a>
<a name="ln371">				{</a>
<a name="ln372">					// get source and target</a>
<a name="ln373">					PartitionMenuItem* targetItem</a>
<a name="ln374">						= (PartitionMenuItem*)fDestMenu-&gt;FindMarked();</a>
<a name="ln375">					PartitionMenuItem* srcItem</a>
<a name="ln376">						= (PartitionMenuItem*)fSrcMenu-&gt;FindMarked();</a>
<a name="ln377">					if (srcItem == NULL || targetItem == NULL)</a>
<a name="ln378">						break;</a>
<a name="ln379"> </a>
<a name="ln380">					_SetCopyEngineCancelSemaphore(create_sem(1,</a>
<a name="ln381">						&quot;copy engine cancel&quot;));</a>
<a name="ln382"> </a>
<a name="ln383">					BList* list = new BList();</a>
<a name="ln384">					int32 size = 0;</a>
<a name="ln385">					fPackagesView-&gt;GetPackagesToInstall(list, &amp;size);</a>
<a name="ln386">					fWorkerThread-&gt;SetLock(fCopyEngineCancelSemaphore);</a>
<a name="ln387">					fWorkerThread-&gt;SetPackagesList(list);</a>
<a name="ln388">					fWorkerThread-&gt;SetSpaceRequired(size);</a>
<a name="ln389">					fInstallStatus = kInstalling;</a>
<a name="ln390">					fWorkerThread-&gt;StartInstall(srcItem-&gt;ID(),</a>
<a name="ln391">						targetItem-&gt;ID());</a>
<a name="ln392">					fBeginButton-&gt;SetLabel(B_TRANSLATE(&quot;Stop&quot;));</a>
<a name="ln393">					_DisableInterface(true);</a>
<a name="ln394"> </a>
<a name="ln395">					fProgressBar-&gt;SetTo(0.0, NULL, NULL);</a>
<a name="ln396"> </a>
<a name="ln397">					fPkgSwitchLayoutItem-&gt;SetVisible(false);</a>
<a name="ln398">					fPackagesLayoutItem-&gt;SetVisible(false);</a>
<a name="ln399">					fSizeViewLayoutItem-&gt;SetVisible(false);</a>
<a name="ln400">					fProgressLayoutItem-&gt;SetVisible(true);</a>
<a name="ln401">					break;</a>
<a name="ln402">				}</a>
<a name="ln403">				case kInstalling:</a>
<a name="ln404">				{</a>
<a name="ln405">					_QuitCopyEngine(true);</a>
<a name="ln406">					break;</a>
<a name="ln407">				}</a>
<a name="ln408">				case kFinished:</a>
<a name="ln409">					PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln410">					break;</a>
<a name="ln411">				case kCancelled:</a>
<a name="ln412">					break;</a>
<a name="ln413">			}</a>
<a name="ln414">			break;</a>
<a name="ln415">		case SHOW_BOTTOM_MESSAGE:</a>
<a name="ln416">			_ShowOptionalPackages();</a>
<a name="ln417">			break;</a>
<a name="ln418">		case SOURCE_PARTITION:</a>
<a name="ln419">			_PublishPackages();</a>
<a name="ln420">			_UpdateControls();</a>
<a name="ln421">			break;</a>
<a name="ln422">		case TARGET_PARTITION:</a>
<a name="ln423">			_UpdateControls();</a>
<a name="ln424">			break;</a>
<a name="ln425">		case LAUNCH_DRIVE_SETUP:</a>
<a name="ln426">			_LaunchDriveSetup();</a>
<a name="ln427">			break;</a>
<a name="ln428">		case LAUNCH_BOOTMAN:</a>
<a name="ln429">			_LaunchBootManager();</a>
<a name="ln430">			break;</a>
<a name="ln431">		case PACKAGE_CHECKBOX:</a>
<a name="ln432">		{</a>
<a name="ln433">			char buffer[15];</a>
<a name="ln434">			fPackagesView-&gt;GetTotalSizeAsString(buffer, sizeof(buffer));</a>
<a name="ln435">			char string[256];</a>
<a name="ln436">			snprintf(string, sizeof(string),</a>
<a name="ln437">				B_TRANSLATE(&quot;Additional disk space required: %s&quot;), buffer);</a>
<a name="ln438">			fSizeView-&gt;SetText(string);</a>
<a name="ln439">			break;</a>
<a name="ln440">		}</a>
<a name="ln441">		case ENCOURAGE_DRIVESETUP:</a>
<a name="ln442">		{</a>
<a name="ln443">			BAlert* alert = new BAlert(&quot;use drive setup&quot;, B_TRANSLATE(&quot;No partitions have &quot;</a>
<a name="ln444">				&quot;been found that are suitable for installation. Please set &quot;</a>
<a name="ln445">				&quot;up partitions and initialize at least one partition with the &quot;</a>
<a name="ln446">				&quot;Be File System.&quot;), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln447">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln448">			alert-&gt;Go();</a>
<a name="ln449">			break;</a>
<a name="ln450">		}</a>
<a name="ln451">		case MSG_STATUS_MESSAGE:</a>
<a name="ln452">		{</a>
<a name="ln453">// TODO: Was this supposed to prevent status messages still arriving</a>
<a name="ln454">// after the copy engine was shut down?</a>
<a name="ln455">//			if (fInstallStatus != kInstalling)</a>
<a name="ln456">//				break;</a>
<a name="ln457">			float progress;</a>
<a name="ln458">			if (msg-&gt;FindFloat(&quot;progress&quot;, &amp;progress) == B_OK) {</a>
<a name="ln459">				const char* currentItem;</a>
<a name="ln460">				if (msg-&gt;FindString(&quot;item&quot;, &amp;currentItem) != B_OK) {</a>
<a name="ln461">					currentItem = B_TRANSLATE_COMMENT(&quot;???&quot;,</a>
<a name="ln462">						&quot;Unknown currently copied item&quot;);</a>
<a name="ln463">				}</a>
<a name="ln464">				BString trailingLabel;</a>
<a name="ln465">				int32 currentCount;</a>
<a name="ln466">				int32 maximumCount;</a>
<a name="ln467">				if (msg-&gt;FindInt32(&quot;current&quot;, &amp;currentCount) == B_OK</a>
<a name="ln468">					&amp;&amp; msg-&gt;FindInt32(&quot;maximum&quot;, &amp;maximumCount) == B_OK) {</a>
<a name="ln469">					char buffer[64];</a>
<a name="ln470">					snprintf(buffer, sizeof(buffer),</a>
<a name="ln471">						B_TRANSLATE_COMMENT(&quot;%1ld of %2ld&quot;,</a>
<a name="ln472">							&quot;number of files copied&quot;),</a>
<a name="ln473">						currentCount, maximumCount);</a>
<a name="ln474">					trailingLabel &lt;&lt; buffer;</a>
<a name="ln475">				} else {</a>
<a name="ln476">					trailingLabel &lt;&lt;</a>
<a name="ln477">						B_TRANSLATE_COMMENT(&quot;?? of ??&quot;, &quot;Unknown progress&quot;);</a>
<a name="ln478">				}</a>
<a name="ln479">				fProgressBar-&gt;SetTo(progress, currentItem,</a>
<a name="ln480">					trailingLabel.String());</a>
<a name="ln481">			} else {</a>
<a name="ln482">				const char *status;</a>
<a name="ln483">				if (msg-&gt;FindString(&quot;status&quot;, &amp;status) == B_OK) {</a>
<a name="ln484">					fLastStatus = fStatusView-&gt;Text();</a>
<a name="ln485">					_SetStatusMessage(status);</a>
<a name="ln486">				} else</a>
<a name="ln487">					_SetStatusMessage(fLastStatus.String());</a>
<a name="ln488">			}</a>
<a name="ln489">			break;</a>
<a name="ln490">		}</a>
<a name="ln491">		case MSG_INSTALL_FINISHED:</a>
<a name="ln492">		{</a>
<a name="ln493"> </a>
<a name="ln494">			_SetCopyEngineCancelSemaphore(-1);</a>
<a name="ln495"> </a>
<a name="ln496">			PartitionMenuItem* dstItem</a>
<a name="ln497">				= (PartitionMenuItem*)fDestMenu-&gt;FindMarked();</a>
<a name="ln498"> </a>
<a name="ln499">			BString status;</a>
<a name="ln500">			if (be_roster-&gt;IsRunning(kDeskbarSignature)) {</a>
<a name="ln501">				fBeginButton-&gt;SetLabel(B_TRANSLATE(&quot;Quit&quot;));</a>
<a name="ln502">				status.SetToFormat(B_TRANSLATE(&quot;Installation &quot;</a>
<a name="ln503">					&quot;completed. Boot sector has been written to '%s'. Press &quot;</a>
<a name="ln504">					&quot;Quit to leave the Installer or choose a new target &quot;</a>
<a name="ln505">					&quot;volume to perform another installation.&quot;),</a>
<a name="ln506">					dstItem ? dstItem-&gt;Name() : B_TRANSLATE_COMMENT(&quot;???&quot;,</a>
<a name="ln507">						&quot;Unknown partition name&quot;));</a>
<a name="ln508">			} else {</a>
<a name="ln509">				fBeginButton-&gt;SetLabel(B_TRANSLATE(&quot;Restart&quot;));</a>
<a name="ln510">				status.SetToFormat(B_TRANSLATE(&quot;Installation &quot;</a>
<a name="ln511">					&quot;completed. Boot sector has been written to '%s'. Press &quot;</a>
<a name="ln512">					&quot;Restart to restart the computer or choose a new target &quot;</a>
<a name="ln513">					&quot;volume to perform another installation.&quot;),</a>
<a name="ln514">					dstItem ? dstItem-&gt;Name() : B_TRANSLATE_COMMENT(&quot;???&quot;,</a>
<a name="ln515">						&quot;Unknown partition name&quot;));</a>
<a name="ln516">			}</a>
<a name="ln517"> </a>
<a name="ln518">			_SetStatusMessage(status.String());</a>
<a name="ln519">			fInstallStatus = kFinished;</a>
<a name="ln520">			_DisableInterface(false);</a>
<a name="ln521">			fProgressLayoutItem-&gt;SetVisible(false);</a>
<a name="ln522">			fPkgSwitchLayoutItem-&gt;SetVisible(true);</a>
<a name="ln523">			_ShowOptionalPackages();</a>
<a name="ln524">			break;</a>
<a name="ln525">		}</a>
<a name="ln526">		case B_SOME_APP_LAUNCHED:</a>
<a name="ln527">		case B_SOME_APP_QUIT:</a>
<a name="ln528">		{</a>
<a name="ln529">			const char *signature;</a>
<a name="ln530">			if (msg-&gt;FindString(&quot;be:signature&quot;, &amp;signature) != B_OK)</a>
<a name="ln531">				break;</a>
<a name="ln532">			bool isDriveSetup = !strcasecmp(signature, kDriveSetupSignature);</a>
<a name="ln533">			bool isBootManager = !strcasecmp(signature, kBootManagerSignature);</a>
<a name="ln534">			if (isDriveSetup || isBootManager) {</a>
<a name="ln535">				bool scanPartitions = false;</a>
<a name="ln536">				if (isDriveSetup) {</a>
<a name="ln537">					bool launched = msg-&gt;what == B_SOME_APP_LAUNCHED;</a>
<a name="ln538">					// We need to scan partitions if DriveSetup has quit.</a>
<a name="ln539">					scanPartitions = fDriveSetupLaunched &amp;&amp; !launched;</a>
<a name="ln540">					fDriveSetupLaunched = launched;</a>
<a name="ln541">				}</a>
<a name="ln542">				if (isBootManager)</a>
<a name="ln543">					fBootManagerLaunched = msg-&gt;what == B_SOME_APP_LAUNCHED;</a>
<a name="ln544"> </a>
<a name="ln545">				fBeginButton-&gt;SetEnabled(</a>
<a name="ln546">					!fDriveSetupLaunched &amp;&amp; !fBootManagerLaunched);</a>
<a name="ln547">				_DisableInterface(fDriveSetupLaunched || fBootManagerLaunched);</a>
<a name="ln548">				if (fDriveSetupLaunched &amp;&amp; fBootManagerLaunched) {</a>
<a name="ln549">					_SetStatusMessage(B_TRANSLATE(&quot;Running Boot Manager and &quot;</a>
<a name="ln550">						&quot;DriveSetup&quot; B_UTF8_ELLIPSIS</a>
<a name="ln551">						&quot;\n\nClose both applications to continue with the &quot;</a>
<a name="ln552">						&quot;installation.&quot;));</a>
<a name="ln553">				} else if (fDriveSetupLaunched) {</a>
<a name="ln554">					_SetStatusMessage(B_TRANSLATE(&quot;Running DriveSetup&quot;</a>
<a name="ln555">						B_UTF8_ELLIPSIS</a>
<a name="ln556">						&quot;\n\nClose DriveSetup to continue with the &quot;</a>
<a name="ln557">						&quot;installation.&quot;));</a>
<a name="ln558">				} else if (fBootManagerLaunched) {</a>
<a name="ln559">					_SetStatusMessage(B_TRANSLATE(&quot;Running Boot Manager&quot;</a>
<a name="ln560">						B_UTF8_ELLIPSIS</a>
<a name="ln561">						&quot;\n\nClose Boot Manager to continue with the &quot;</a>
<a name="ln562">						&quot;installation.&quot;));</a>
<a name="ln563">				} else {</a>
<a name="ln564">					// If neither DriveSetup nor Bootman is running, we need</a>
<a name="ln565">					// to scan partitions in case DriveSetup has quit, or</a>
<a name="ln566">					// we need to update the guidance message, unless install</a>
<a name="ln567">					// was already finished.</a>
<a name="ln568">					if (scanPartitions)</a>
<a name="ln569">						_ScanPartitions();</a>
<a name="ln570">					else if (fInstallStatus != kFinished)</a>
<a name="ln571">						_UpdateControls();</a>
<a name="ln572">					else</a>
<a name="ln573">						PostMessage(MSG_INSTALL_FINISHED);</a>
<a name="ln574">				}</a>
<a name="ln575">			}</a>
<a name="ln576">			break;</a>
<a name="ln577">		}</a>
<a name="ln578">		case MSG_WRITE_BOOT_SECTOR:</a>
<a name="ln579">			fWorkerThread-&gt;WriteBootSector(fDestMenu);</a>
<a name="ln580">			break;</a>
<a name="ln581"> </a>
<a name="ln582">		default:</a>
<a name="ln583">			BWindow::MessageReceived(msg);</a>
<a name="ln584">			break;</a>
<a name="ln585">	}</a>
<a name="ln586">}</a>
<a name="ln587"> </a>
<a name="ln588"> </a>
<a name="ln589">bool</a>
<a name="ln590">InstallerWindow::QuitRequested()</a>
<a name="ln591">{</a>
<a name="ln592">	if ((Flags() &amp; B_NOT_MINIMIZABLE) != 0) {</a>
<a name="ln593">		// This means Deskbar is not running, i.e. Installer is the only</a>
<a name="ln594">		// thing on the screen and we will reboot the machine once it quits.</a>
<a name="ln595"> </a>
<a name="ln596">		if (fDriveSetupLaunched &amp;&amp; fBootManagerLaunched) {</a>
<a name="ln597">			BAlert* alert = new BAlert(B_TRANSLATE(&quot;Quit Boot Manager and &quot;</a>
<a name="ln598">				&quot;DriveSetup&quot;),	B_TRANSLATE(&quot;Please close the Boot Manager &quot;</a>
<a name="ln599">				&quot;and DriveSetup windows before closing the Installer window.&quot;),</a>
<a name="ln600">				B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln601">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln602">			alert-&gt;Go();</a>
<a name="ln603">			return false;</a>
<a name="ln604">		}</a>
<a name="ln605">		if (fDriveSetupLaunched) {</a>
<a name="ln606">			BAlert* alert = new BAlert(B_TRANSLATE(&quot;Quit DriveSetup&quot;),</a>
<a name="ln607">				B_TRANSLATE(&quot;Please close the DriveSetup window before &quot;</a>
<a name="ln608">				&quot;closing the Installer window.&quot;), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln609">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln610">			alert-&gt;Go();</a>
<a name="ln611">			return false;</a>
<a name="ln612">		}</a>
<a name="ln613">		if (fBootManagerLaunched) {</a>
<a name="ln614">			BAlert* alert = new BAlert(B_TRANSLATE(&quot;Quit Boot Manager&quot;),</a>
<a name="ln615">				B_TRANSLATE(&quot;Please close the Boot Manager window before &quot;</a>
<a name="ln616">				&quot;closing the Installer window.&quot;), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln617">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln618">			alert-&gt;Go();</a>
<a name="ln619">			return false;</a>
<a name="ln620">		}</a>
<a name="ln621">		if (fInstallStatus != kFinished) {</a>
<a name="ln622">			BAlert* alert = new BAlert(B_TRANSLATE_SYSTEM_NAME(&quot;Installer&quot;),</a>
<a name="ln623">				B_TRANSLATE(&quot;Are you sure you want to abort the &quot;</a>
<a name="ln624">					&quot;installation and restart the system?&quot;),</a>
<a name="ln625">				B_TRANSLATE(&quot;Cancel&quot;), B_TRANSLATE(&quot;Restart system&quot;), NULL,</a>
<a name="ln626">				B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln627">			alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln628">			if (alert-&gt;Go() == 0)</a>
<a name="ln629">				return false;</a>
<a name="ln630">		}</a>
<a name="ln631">	} else if (fInstallStatus == kInstalling) {</a>
<a name="ln632">			BAlert* alert = new BAlert(B_TRANSLATE_SYSTEM_NAME(&quot;Installer&quot;),</a>
<a name="ln633">				B_TRANSLATE(&quot;Are you sure you want to abort the installation?&quot;),</a>
<a name="ln634">				B_TRANSLATE(&quot;Cancel&quot;), B_TRANSLATE(&quot;Abort&quot;), NULL,</a>
<a name="ln635">				B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln636">			alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln637">			if (alert-&gt;Go() == 0)</a>
<a name="ln638">				return false;</a>
<a name="ln639">	}</a>
<a name="ln640"> </a>
<a name="ln641">	_QuitCopyEngine(false);</a>
<a name="ln642">	fWorkerThread-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln643">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln644">	return true;</a>
<a name="ln645">}</a>
<a name="ln646"> </a>
<a name="ln647"> </a>
<a name="ln648">// #pragma mark -</a>
<a name="ln649"> </a>
<a name="ln650"> </a>
<a name="ln651">void</a>
<a name="ln652">InstallerWindow::_ShowOptionalPackages()</a>
<a name="ln653">{</a>
<a name="ln654">	if (fPackagesLayoutItem &amp;&amp; fSizeViewLayoutItem) {</a>
<a name="ln655">		fPackagesLayoutItem-&gt;SetVisible(fPackagesSwitch-&gt;Value());</a>
<a name="ln656">		fSizeViewLayoutItem-&gt;SetVisible(fPackagesSwitch-&gt;Value());</a>
<a name="ln657">	}</a>
<a name="ln658">}</a>
<a name="ln659"> </a>
<a name="ln660"> </a>
<a name="ln661">void</a>
<a name="ln662">InstallerWindow::_LaunchDriveSetup()</a>
<a name="ln663">{</a>
<a name="ln664">	if (be_roster-&gt;Launch(kDriveSetupSignature) != B_OK) {</a>
<a name="ln665">		// Try really hard to launch it. It's very likely that this fails,</a>
<a name="ln666">		// when we run from the CD and there is only an incomplete mime</a>
<a name="ln667">		// database for example...</a>
<a name="ln668">		BPath path;</a>
<a name="ln669">		if (find_directory(B_SYSTEM_APPS_DIRECTORY, &amp;path) != B_OK</a>
<a name="ln670">			|| path.Append(&quot;DriveSetup&quot;) != B_OK) {</a>
<a name="ln671">			path.SetTo(&quot;/boot/system/apps/DriveSetup&quot;);</a>
<a name="ln672">		}</a>
<a name="ln673">		BEntry entry(path.Path());</a>
<a name="ln674">		entry_ref ref;</a>
<a name="ln675">		if (entry.GetRef(&amp;ref) != B_OK || be_roster-&gt;Launch(&amp;ref) != B_OK) {</a>
<a name="ln676">			BAlert* alert = new BAlert(&quot;error&quot;, B_TRANSLATE(&quot;DriveSetup, the &quot;</a>
<a name="ln677">				&quot;application to configure disk partitions, could not be &quot;</a>
<a name="ln678">				&quot;launched.&quot;), B_TRANSLATE(&quot;OK&quot;));</a>
<a name="ln679">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln680">			alert-&gt;Go();</a>
<a name="ln681">		}</a>
<a name="ln682">	}</a>
<a name="ln683">}</a>
<a name="ln684"> </a>
<a name="ln685"> </a>
<a name="ln686">void</a>
<a name="ln687">InstallerWindow::_LaunchBootManager()</a>
<a name="ln688">{</a>
<a name="ln689">	// TODO: Currently BootManager always tries to install to the &quot;first&quot;</a>
<a name="ln690">	// harddisk. If/when it later supports being installed to a certain</a>
<a name="ln691">	// harddisk, we would have to pass it the disk that contains the target</a>
<a name="ln692">	// partition here.</a>
<a name="ln693">	if (be_roster-&gt;Launch(kBootManagerSignature) != B_OK) {</a>
<a name="ln694">		// Try really hard to launch it. It's very likely that this fails,</a>
<a name="ln695">		// when we run from the CD and there is only an incomplete mime</a>
<a name="ln696">		// database for example...</a>
<a name="ln697">		BPath path;</a>
<a name="ln698">		if (find_directory(B_SYSTEM_APPS_DIRECTORY, &amp;path) != B_OK</a>
<a name="ln699">			|| path.Append(&quot;BootManager&quot;) != B_OK) {</a>
<a name="ln700">			path.SetTo(&quot;/boot/system/apps/BootManager&quot;);</a>
<a name="ln701">		}</a>
<a name="ln702">		BEntry entry(path.Path());</a>
<a name="ln703">		entry_ref ref;</a>
<a name="ln704">		if (entry.GetRef(&amp;ref) != B_OK || be_roster-&gt;Launch(&amp;ref) != B_OK) {</a>
<a name="ln705">			BAlert* alert = new BAlert(</a>
<a name="ln706">				B_TRANSLATE(&quot;Failed to launch Boot Manager&quot;),</a>
<a name="ln707">				B_TRANSLATE(&quot;Boot Manager, the application to configure the &quot;</a>
<a name="ln708">					&quot;Haiku boot menu, could not be launched.&quot;),</a>
<a name="ln709">				B_TRANSLATE(&quot;OK&quot;), NULL, NULL, B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln710">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln711">			alert-&gt;Go();</a>
<a name="ln712">		}</a>
<a name="ln713">	}</a>
<a name="ln714">}</a>
<a name="ln715"> </a>
<a name="ln716"> </a>
<a name="ln717">void</a>
<a name="ln718">InstallerWindow::_DisableInterface(bool disable)</a>
<a name="ln719">{</a>
<a name="ln720">	fLaunchDriveSetupButton-&gt;SetEnabled(!disable);</a>
<a name="ln721">	fLaunchBootManagerItem-&gt;SetEnabled(!disable);</a>
<a name="ln722">	fMakeBootableItem-&gt;SetEnabled(!disable);</a>
<a name="ln723">	fSrcMenuField-&gt;SetEnabled(!disable);</a>
<a name="ln724">	fDestMenuField-&gt;SetEnabled(!disable);</a>
<a name="ln725">}</a>
<a name="ln726"> </a>
<a name="ln727"> </a>
<a name="ln728">void</a>
<a name="ln729">InstallerWindow::_ScanPartitions()</a>
<a name="ln730">{</a>
<a name="ln731">	_SetStatusMessage(B_TRANSLATE(&quot;Scanning for disks&quot; B_UTF8_ELLIPSIS));</a>
<a name="ln732"> </a>
<a name="ln733">	BMenuItem *item;</a>
<a name="ln734">	while ((item = fSrcMenu-&gt;RemoveItem((int32)0)))</a>
<a name="ln735">		delete item;</a>
<a name="ln736">	while ((item = fDestMenu-&gt;RemoveItem((int32)0)))</a>
<a name="ln737">		delete item;</a>
<a name="ln738"> </a>
<a name="ln739">	fWorkerThread-&gt;ScanDisksPartitions(fSrcMenu, fDestMenu);</a>
<a name="ln740"> </a>
<a name="ln741">	if (fSrcMenu-&gt;ItemAt(0) != NULL)</a>
<a name="ln742">		_PublishPackages();</a>
<a name="ln743"> </a>
<a name="ln744">	_UpdateControls();</a>
<a name="ln745">}</a>
<a name="ln746"> </a>
<a name="ln747"> </a>
<a name="ln748">void</a>
<a name="ln749">InstallerWindow::_UpdateControls()</a>
<a name="ln750">{</a>
<a name="ln751">	PartitionMenuItem* srcItem = (PartitionMenuItem*)fSrcMenu-&gt;FindMarked();</a>
<a name="ln752">	BString label;</a>
<a name="ln753">	if (srcItem) {</a>
<a name="ln754">		label = srcItem-&gt;MenuLabel();</a>
<a name="ln755">	} else {</a>
<a name="ln756">		if (fSrcMenu-&gt;CountItems() == 0)</a>
<a name="ln757">			label = B_TRANSLATE_COMMENT(&quot;&lt;none&gt;&quot;, &quot;No partition available&quot;);</a>
<a name="ln758">		else</a>
<a name="ln759">			label = ((PartitionMenuItem*)fSrcMenu-&gt;ItemAt(0))-&gt;MenuLabel();</a>
<a name="ln760">	}</a>
<a name="ln761">	fSrcMenuField-&gt;MenuItem()-&gt;SetLabel(label.String());</a>
<a name="ln762"> </a>
<a name="ln763">	// Disable any unsuitable target items, check if at least one partition</a>
<a name="ln764">	// is suitable.</a>
<a name="ln765">	bool foundOneSuitableTarget = false;</a>
<a name="ln766">	for (int32 i = fDestMenu-&gt;CountItems() - 1; i &gt;= 0; i--) {</a>
<a name="ln767">		PartitionMenuItem* dstItem</a>
<a name="ln768">			= (PartitionMenuItem*)fDestMenu-&gt;ItemAt(i);</a>
<a name="ln769">		if (srcItem != NULL &amp;&amp; dstItem-&gt;ID() == srcItem-&gt;ID()) {</a>
<a name="ln770">			// Prevent the user from having picked the same partition as source</a>
<a name="ln771">			// and destination.</a>
<a name="ln772">			dstItem-&gt;SetEnabled(false);</a>
<a name="ln773">			dstItem-&gt;SetMarked(false);</a>
<a name="ln774">		} else</a>
<a name="ln775">			dstItem-&gt;SetEnabled(dstItem-&gt;IsValidTarget());</a>
<a name="ln776"> </a>
<a name="ln777">		if (dstItem-&gt;IsEnabled())</a>
<a name="ln778">			foundOneSuitableTarget = true;</a>
<a name="ln779">	}</a>
<a name="ln780"> </a>
<a name="ln781">	PartitionMenuItem* dstItem = (PartitionMenuItem*)fDestMenu-&gt;FindMarked();</a>
<a name="ln782">	if (dstItem) {</a>
<a name="ln783">		label = dstItem-&gt;MenuLabel();</a>
<a name="ln784">	} else {</a>
<a name="ln785">		if (fDestMenu-&gt;CountItems() == 0)</a>
<a name="ln786">			label = B_TRANSLATE_COMMENT(&quot;&lt;none&gt;&quot;, &quot;No partition available&quot;);</a>
<a name="ln787">		else</a>
<a name="ln788">			label = B_TRANSLATE(&quot;Please choose target&quot;);</a>
<a name="ln789">	}</a>
<a name="ln790">	fDestMenuField-&gt;MenuItem()-&gt;SetLabel(label.String());</a>
<a name="ln791"> </a>
<a name="ln792">	if (srcItem != NULL &amp;&amp; dstItem != NULL) {</a>
<a name="ln793">		BString message;</a>
<a name="ln794">		message.SetToFormat(B_TRANSLATE(&quot;Press the Begin button to install &quot;</a>
<a name="ln795">			&quot;from '%1s' onto '%2s'.&quot;), srcItem-&gt;Name(), dstItem-&gt;Name());</a>
<a name="ln796">		_SetStatusMessage(message.String());</a>
<a name="ln797">	} else if (srcItem != NULL) {</a>
<a name="ln798">		_SetStatusMessage(B_TRANSLATE(&quot;Choose the disk you want to install &quot;</a>
<a name="ln799">			&quot;onto from the pop-up menu. Then click \&quot;Begin\&quot;.&quot;));</a>
<a name="ln800">	} else if (dstItem != NULL) {</a>
<a name="ln801">		_SetStatusMessage(B_TRANSLATE(&quot;Choose the source disk from the &quot;</a>
<a name="ln802">			&quot;pop-up menu. Then click \&quot;Begin\&quot;.&quot;));</a>
<a name="ln803">	} else {</a>
<a name="ln804">		_SetStatusMessage(B_TRANSLATE(&quot;Choose the source and destination disk &quot;</a>
<a name="ln805">			&quot;from the pop-up menus. Then click \&quot;Begin\&quot;.&quot;));</a>
<a name="ln806">	}</a>
<a name="ln807"> </a>
<a name="ln808">	fInstallStatus = kReadyForInstall;</a>
<a name="ln809">	fBeginButton-&gt;SetLabel(B_TRANSLATE(&quot;Begin&quot;));</a>
<a name="ln810">	fBeginButton-&gt;SetEnabled(srcItem &amp;&amp; dstItem);</a>
<a name="ln811"> </a>
<a name="ln812">	// adjust &quot;Write Boot Sector&quot; and &quot;Set up boot menu&quot; buttons</a>
<a name="ln813">	if (dstItem != NULL) {</a>
<a name="ln814">		char buffer[256];</a>
<a name="ln815">		snprintf(buffer, sizeof(buffer), B_TRANSLATE(&quot;Write boot sector to '%s'&quot;),</a>
<a name="ln816">			dstItem-&gt;Name());</a>
<a name="ln817">		label = buffer;</a>
<a name="ln818">	} else</a>
<a name="ln819">		label = B_TRANSLATE(&quot;Write boot sector&quot;);</a>
<a name="ln820">	fMakeBootableItem-&gt;SetEnabled(dstItem != NULL);</a>
<a name="ln821">	fMakeBootableItem-&gt;SetLabel(label.String());</a>
<a name="ln822">// TODO: Once bootman support writing to specific disks, enable this, since</a>
<a name="ln823">// we would pass it the disk which contains the target partition.</a>
<a name="ln824">//	fLaunchBootManagerItem-&gt;SetEnabled(dstItem != NULL);</a>
<a name="ln825"> </a>
<a name="ln826">	if (!fEncouragedToSetupPartitions &amp;&amp; !foundOneSuitableTarget) {</a>
<a name="ln827">		// Focus the users attention on the DriveSetup button</a>
<a name="ln828">		fEncouragedToSetupPartitions = true;</a>
<a name="ln829">		PostMessage(ENCOURAGE_DRIVESETUP);</a>
<a name="ln830">	}</a>
<a name="ln831">}</a>
<a name="ln832"> </a>
<a name="ln833"> </a>
<a name="ln834">void</a>
<a name="ln835">InstallerWindow::_PublishPackages()</a>
<a name="ln836">{</a>
<a name="ln837">	fPackagesView-&gt;Clean();</a>
<a name="ln838">	PartitionMenuItem *item = (PartitionMenuItem *)fSrcMenu-&gt;FindMarked();</a>
<a name="ln839">	if (item == NULL)</a>
<a name="ln840">		return;</a>
<a name="ln841"> </a>
<a name="ln842">	BPath directory;</a>
<a name="ln843">	BDiskDeviceRoster roster;</a>
<a name="ln844">	BDiskDevice device;</a>
<a name="ln845">	BPartition *partition;</a>
<a name="ln846">	if (roster.GetPartitionWithID(item-&gt;ID(), &amp;device, &amp;partition) == B_OK) {</a>
<a name="ln847">		if (partition-&gt;GetMountPoint(&amp;directory) != B_OK)</a>
<a name="ln848">			return;</a>
<a name="ln849">	} else if (roster.GetDeviceWithID(item-&gt;ID(), &amp;device) == B_OK) {</a>
<a name="ln850">		if (device.GetMountPoint(&amp;directory) != B_OK)</a>
<a name="ln851">			return;</a>
<a name="ln852">	} else</a>
<a name="ln853">		return; // shouldn't happen</a>
<a name="ln854"> </a>
<a name="ln855">	directory.Append(kPackagesDirectoryPath);</a>
<a name="ln856">	BDirectory dir(directory.Path());</a>
<a name="ln857">	if (dir.InitCheck() != B_OK)</a>
<a name="ln858">		return;</a>
<a name="ln859"> </a>
<a name="ln860">	BEntry packageEntry;</a>
<a name="ln861">	BList packages;</a>
<a name="ln862">	while (dir.GetNextEntry(&amp;packageEntry) == B_OK) {</a>
<a name="ln863">		Package* package = Package::PackageFromEntry(packageEntry);</a>
<a name="ln864">		if (package != NULL)</a>
<a name="ln865">			packages.AddItem(package);</a>
<a name="ln866">	}</a>
<a name="ln867">	packages.SortItems(_ComparePackages);</a>
<a name="ln868"> </a>
<a name="ln869">	fPackagesView-&gt;AddPackages(packages, new BMessage(PACKAGE_CHECKBOX));</a>
<a name="ln870">	PostMessage(PACKAGE_CHECKBOX);</a>
<a name="ln871">}</a>
<a name="ln872"> </a>
<a name="ln873"> </a>
<a name="ln874">void</a>
<a name="ln875">InstallerWindow::_SetStatusMessage(const char *text)</a>
<a name="ln876">{</a>
<a name="ln877">	fStatusView-&gt;SetText(text);</a>
<a name="ln878">	fLogoGroup-&gt;GroupLayout()-&gt;InvalidateLayout();</a>
<a name="ln879">}</a>
<a name="ln880"> </a>
<a name="ln881"> </a>
<a name="ln882">void</a>
<a name="ln883">InstallerWindow::_SetCopyEngineCancelSemaphore(sem_id id, bool alreadyLocked)</a>
<a name="ln884">{</a>
<a name="ln885">	if (fCopyEngineCancelSemaphore &gt;= 0) {</a>
<a name="ln886">		if (!alreadyLocked)</a>
<a name="ln887">			acquire_sem(fCopyEngineCancelSemaphore);</a>
<a name="ln888">		delete_sem(fCopyEngineCancelSemaphore);</a>
<a name="ln889">	}</a>
<a name="ln890">	fCopyEngineCancelSemaphore = id;</a>
<a name="ln891">}</a>
<a name="ln892"> </a>
<a name="ln893"> </a>
<a name="ln894">void</a>
<a name="ln895">InstallerWindow::_QuitCopyEngine(bool askUser)</a>
<a name="ln896">{</a>
<a name="ln897">	if (fCopyEngineCancelSemaphore &lt; 0)</a>
<a name="ln898">		return;</a>
<a name="ln899"> </a>
<a name="ln900">	// First of all block the copy engine, so that it doesn't continue</a>
<a name="ln901">	// while the alert is showing, which would be irritating.</a>
<a name="ln902">	acquire_sem(fCopyEngineCancelSemaphore);</a>
<a name="ln903"> </a>
<a name="ln904">	bool quit = true;</a>
<a name="ln905">	if (askUser) {</a>
<a name="ln906">		BAlert* alert = new BAlert(&quot;cancel&quot;,</a>
<a name="ln907">			B_TRANSLATE(&quot;Are you sure you want to to stop the installation?&quot;),</a>
<a name="ln908">			B_TRANSLATE_COMMENT(&quot;Continue&quot;, &quot;In alert after pressing Stop&quot;),</a>
<a name="ln909">			B_TRANSLATE_COMMENT(&quot;Stop&quot;, &quot;In alert after pressing Stop&quot;), 0,</a>
<a name="ln910">			B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln911">		alert-&gt;SetShortcut(1, B_ESCAPE);</a>
<a name="ln912">		quit = alert-&gt;Go() != 0;</a>
<a name="ln913">	}</a>
<a name="ln914"> </a>
<a name="ln915">	if (quit) {</a>
<a name="ln916">		// Make it quit by having it's lock fail...</a>
<a name="ln917">		_SetCopyEngineCancelSemaphore(-1, true);</a>
<a name="ln918">	} else</a>
<a name="ln919">		release_sem(fCopyEngineCancelSemaphore);</a>
<a name="ln920">}</a>
<a name="ln921"> </a>
<a name="ln922"> </a>
<a name="ln923">// #pragma mark -</a>
<a name="ln924"> </a>
<a name="ln925"> </a>
<a name="ln926">int</a>
<a name="ln927">InstallerWindow::_ComparePackages(const void* firstArg, const void* secondArg)</a>
<a name="ln928">{</a>
<a name="ln929">	const Group* group1 = *static_cast&lt;const Group* const *&gt;(firstArg);</a>
<a name="ln930">	const Group* group2 = *static_cast&lt;const Group* const *&gt;(secondArg);</a>
<a name="ln931">	const Package* package1 = dynamic_cast&lt;const Package*&gt;(group1);</a>
<a name="ln932">	const Package* package2 = dynamic_cast&lt;const Package*&gt;(group2);</a>
<a name="ln933">	int sameGroup = strcmp(group1-&gt;GroupName(), group2-&gt;GroupName());</a>
<a name="ln934">	if (sameGroup != 0)</a>
<a name="ln935">		return sameGroup;</a>
<a name="ln936">	if (package2 == NULL)</a>
<a name="ln937">		return -1;</a>
<a name="ln938">	if (package1 == NULL)</a>
<a name="ln939">		return 1;</a>
<a name="ln940">	return strcmp(package1-&gt;Name(), package2-&gt;Name());</a>
<a name="ln941">}</a>
<a name="ln942"> </a>
<a name="ln943"> </a>

</code></pre>
<div class="balloon" rel="681"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="638"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="355"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="712"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="913"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="629"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="619"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="611"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="603"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'alert' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
