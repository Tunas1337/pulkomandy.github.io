
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>AbstractSpinner.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2004 DarkWyrm &lt;darkwyrm@earthlink.net&gt;</a>
<a name="ln3"> * Copyright 2013 FeemanLou</a>
<a name="ln4"> * Copyright 2014-2015 Haiku, Inc. All rights reserved.</a>
<a name="ln5"> *</a>
<a name="ln6"> * Distributed under the terms of the MIT license.</a>
<a name="ln7"> *</a>
<a name="ln8"> * Originally written by DarkWyrm &lt;darkwyrm@earthlink.net&gt;</a>
<a name="ln9"> * Updated by FreemanLou as part of Google GCI 2013</a>
<a name="ln10"> *</a>
<a name="ln11"> * Authors:</a>
<a name="ln12"> *		DarkWyrm, darkwyrm@earthlink.net</a>
<a name="ln13"> *		FeemanLou</a>
<a name="ln14"> *		John Scipione, jscipione@gmail.com</a>
<a name="ln15"> */</a>
<a name="ln16"> </a>
<a name="ln17"> </a>
<a name="ln18">#include &lt;AbstractSpinner.h&gt;</a>
<a name="ln19"> </a>
<a name="ln20">#include &lt;algorithm&gt;</a>
<a name="ln21"> </a>
<a name="ln22">#include &lt;AbstractLayoutItem.h&gt;</a>
<a name="ln23">#include &lt;Alignment.h&gt;</a>
<a name="ln24">#include &lt;ControlLook.h&gt;</a>
<a name="ln25">#include &lt;Font.h&gt;</a>
<a name="ln26">#include &lt;GradientLinear.h&gt;</a>
<a name="ln27">#include &lt;LayoutItem.h&gt;</a>
<a name="ln28">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln29">#include &lt;Message.h&gt;</a>
<a name="ln30">#include &lt;MessageFilter.h&gt;</a>
<a name="ln31">#include &lt;Point.h&gt;</a>
<a name="ln32">#include &lt;PropertyInfo.h&gt;</a>
<a name="ln33">#include &lt;TextView.h&gt;</a>
<a name="ln34">#include &lt;View.h&gt;</a>
<a name="ln35">#include &lt;Window.h&gt;</a>
<a name="ln36"> </a>
<a name="ln37">#include &quot;Thread.h&quot;</a>
<a name="ln38"> </a>
<a name="ln39"> </a>
<a name="ln40">static const float kFrameMargin			= 2.0f;</a>
<a name="ln41"> </a>
<a name="ln42">const char* const kFrameField			= &quot;BAbstractSpinner:layoutItem:frame&quot;;</a>
<a name="ln43">const char* const kLabelItemField		= &quot;BAbstractSpinner:labelItem&quot;;</a>
<a name="ln44">const char* const kTextViewItemField	= &quot;BAbstractSpinner:textViewItem&quot;;</a>
<a name="ln45"> </a>
<a name="ln46"> </a>
<a name="ln47">static property_info sProperties[] = {</a>
<a name="ln48">	{</a>
<a name="ln49">		&quot;Align&quot;,</a>
<a name="ln50">		{ B_GET_PROPERTY, 0 },</a>
<a name="ln51">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln52">		&quot;Returns the alignment of the spinner label.&quot;,</a>
<a name="ln53">		0,</a>
<a name="ln54">		{ B_INT32_TYPE }</a>
<a name="ln55">	},</a>
<a name="ln56">	{</a>
<a name="ln57">		&quot;Align&quot;,</a>
<a name="ln58">		{ B_SET_PROPERTY, 0 },</a>
<a name="ln59">		{ B_DIRECT_SPECIFIER, 0},</a>
<a name="ln60">		&quot;Sets the alignment of the spinner label.&quot;,</a>
<a name="ln61">		0,</a>
<a name="ln62">		{ B_INT32_TYPE }</a>
<a name="ln63">	},</a>
<a name="ln64"> </a>
<a name="ln65">	{</a>
<a name="ln66">		&quot;ButtonStyle&quot;,</a>
<a name="ln67">		{ B_GET_PROPERTY, 0 },</a>
<a name="ln68">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln69">		&quot;Returns the style of the spinner buttons.&quot;,</a>
<a name="ln70">		0,</a>
<a name="ln71">		{ B_INT32_TYPE }</a>
<a name="ln72">	},</a>
<a name="ln73">	{</a>
<a name="ln74">		&quot;ButtonStyle&quot;,</a>
<a name="ln75">		{ B_SET_PROPERTY, 0 },</a>
<a name="ln76">		{ B_DIRECT_SPECIFIER, 0},</a>
<a name="ln77">		&quot;Sets the style of the spinner buttons.&quot;,</a>
<a name="ln78">		0,</a>
<a name="ln79">		{ B_INT32_TYPE }</a>
<a name="ln80">	},</a>
<a name="ln81"> </a>
<a name="ln82">	{</a>
<a name="ln83">		&quot;Divider&quot;,</a>
<a name="ln84">		{ B_GET_PROPERTY, 0 },</a>
<a name="ln85">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln86">		&quot;Returns the divider position of the spinner.&quot;,</a>
<a name="ln87">		0,</a>
<a name="ln88">		{ B_FLOAT_TYPE }</a>
<a name="ln89">	},</a>
<a name="ln90">	{</a>
<a name="ln91">		&quot;Divider&quot;,</a>
<a name="ln92">		{ B_SET_PROPERTY, 0 },</a>
<a name="ln93">		{ B_DIRECT_SPECIFIER, 0},</a>
<a name="ln94">		&quot;Sets the divider position of the spinner.&quot;,</a>
<a name="ln95">		0,</a>
<a name="ln96">		{ B_FLOAT_TYPE }</a>
<a name="ln97">	},</a>
<a name="ln98"> </a>
<a name="ln99">	{</a>
<a name="ln100">		&quot;Enabled&quot;,</a>
<a name="ln101">		{ B_GET_PROPERTY, 0 },</a>
<a name="ln102">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln103">		&quot;Returns whether or not the spinner is enabled.&quot;,</a>
<a name="ln104">		0,</a>
<a name="ln105">		{ B_BOOL_TYPE }</a>
<a name="ln106">	},</a>
<a name="ln107">	{</a>
<a name="ln108">		&quot;Enabled&quot;,</a>
<a name="ln109">		{ B_SET_PROPERTY, 0 },</a>
<a name="ln110">		{ B_DIRECT_SPECIFIER, 0},</a>
<a name="ln111">		&quot;Sets whether or not the spinner is enabled.&quot;,</a>
<a name="ln112">		0,</a>
<a name="ln113">		{ B_BOOL_TYPE }</a>
<a name="ln114">	},</a>
<a name="ln115"> </a>
<a name="ln116">	{</a>
<a name="ln117">		&quot;Label&quot;,</a>
<a name="ln118">		{ B_GET_PROPERTY, 0 },</a>
<a name="ln119">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln120">		&quot;Returns the spinner label.&quot;,</a>
<a name="ln121">		0,</a>
<a name="ln122">		{ B_STRING_TYPE }</a>
<a name="ln123">	},</a>
<a name="ln124">	{</a>
<a name="ln125">		&quot;Label&quot;,</a>
<a name="ln126">		{ B_SET_PROPERTY, 0 },</a>
<a name="ln127">		{ B_DIRECT_SPECIFIER, 0},</a>
<a name="ln128">		&quot;Sets the spinner label.&quot;,</a>
<a name="ln129">		0,</a>
<a name="ln130">		{ B_STRING_TYPE }</a>
<a name="ln131">	},</a>
<a name="ln132"> </a>
<a name="ln133">	{</a>
<a name="ln134">		&quot;Message&quot;,</a>
<a name="ln135">		{ B_GET_PROPERTY, 0 },</a>
<a name="ln136">		{ B_DIRECT_SPECIFIER, 0 },</a>
<a name="ln137">		&quot;Returns the spinner invocation message.&quot;,</a>
<a name="ln138">		0,</a>
<a name="ln139">		{ B_MESSAGE_TYPE }</a>
<a name="ln140">	},</a>
<a name="ln141">	{</a>
<a name="ln142">		&quot;Message&quot;,</a>
<a name="ln143">		{ B_SET_PROPERTY, 0 },</a>
<a name="ln144">		{ B_DIRECT_SPECIFIER, 0},</a>
<a name="ln145">		&quot;Sets the spinner invocation message.&quot;,</a>
<a name="ln146">		0,</a>
<a name="ln147">		{ B_MESSAGE_TYPE }</a>
<a name="ln148">	},</a>
<a name="ln149"> </a>
<a name="ln150">	{ 0 }</a>
<a name="ln151">};</a>
<a name="ln152"> </a>
<a name="ln153"> </a>
<a name="ln154">typedef enum {</a>
<a name="ln155">	SPINNER_INCREMENT,</a>
<a name="ln156">	SPINNER_DECREMENT</a>
<a name="ln157">} spinner_direction;</a>
<a name="ln158"> </a>
<a name="ln159"> </a>
<a name="ln160">class SpinnerButton : public BView {</a>
<a name="ln161">public:</a>
<a name="ln162">								SpinnerButton(BRect frame, const char* name,</a>
<a name="ln163">									spinner_direction direction);</a>
<a name="ln164">	virtual						~SpinnerButton();</a>
<a name="ln165"> </a>
<a name="ln166">	virtual	void				AttachedToWindow();</a>
<a name="ln167">	virtual	void				DetachedFromWindow();</a>
<a name="ln168">	virtual	void				Draw(BRect updateRect);</a>
<a name="ln169">	virtual	void				MouseDown(BPoint where);</a>
<a name="ln170">	virtual	void				MouseUp(BPoint where);</a>
<a name="ln171">	virtual	void				MouseMoved(BPoint where, uint32 transit,</a>
<a name="ln172">									const BMessage* message);</a>
<a name="ln173"> </a>
<a name="ln174">			bool				IsEnabled() const { return fIsEnabled; }</a>
<a name="ln175">	virtual	void				SetEnabled(bool enable) { fIsEnabled = enable; };</a>
<a name="ln176"> </a>
<a name="ln177">private:</a>
<a name="ln178">			void				_DoneTracking(BPoint where);</a>
<a name="ln179">			void				_Track(BPoint where, uint32);</a>
<a name="ln180"> </a>
<a name="ln181">			spinner_direction	fSpinnerDirection;</a>
<a name="ln182">			BAbstractSpinner*	fParent;</a>
<a name="ln183">			bool				fIsEnabled;</a>
<a name="ln184">			bool				fIsMouseDown;</a>
<a name="ln185">			bool				fIsMouseOver;</a>
<a name="ln186">			bigtime_t			fRepeatDelay;</a>
<a name="ln187">};</a>
<a name="ln188"> </a>
<a name="ln189"> </a>
<a name="ln190">class SpinnerTextView : public BTextView {</a>
<a name="ln191">public:</a>
<a name="ln192">								SpinnerTextView(BRect rect, BRect textRect);</a>
<a name="ln193">	virtual						~SpinnerTextView();</a>
<a name="ln194"> </a>
<a name="ln195">	virtual	void				AttachedToWindow();</a>
<a name="ln196">	virtual	void				DetachedFromWindow();</a>
<a name="ln197">	virtual	void				KeyDown(const char* bytes, int32 numBytes);</a>
<a name="ln198">	virtual	void				MakeFocus(bool focus);</a>
<a name="ln199"> </a>
<a name="ln200">private:</a>
<a name="ln201">			BAbstractSpinner*	fParent;</a>
<a name="ln202">};</a>
<a name="ln203"> </a>
<a name="ln204"> </a>
<a name="ln205">class BAbstractSpinner::LabelLayoutItem : public BAbstractLayoutItem {</a>
<a name="ln206">public:</a>
<a name="ln207">								LabelLayoutItem(BAbstractSpinner* parent);</a>
<a name="ln208">								LabelLayoutItem(BMessage* archive);</a>
<a name="ln209"> </a>
<a name="ln210">	virtual	bool				IsVisible();</a>
<a name="ln211">	virtual	void				SetVisible(bool visible);</a>
<a name="ln212"> </a>
<a name="ln213">	virtual	BRect				Frame();</a>
<a name="ln214">	virtual	void				SetFrame(BRect frame);</a>
<a name="ln215"> </a>
<a name="ln216">			void				SetParent(BAbstractSpinner* parent);</a>
<a name="ln217">	virtual	BView*				View();</a>
<a name="ln218"> </a>
<a name="ln219">	virtual	BSize				BaseMinSize();</a>
<a name="ln220">	virtual	BSize				BaseMaxSize();</a>
<a name="ln221">	virtual	BSize				BasePreferredSize();</a>
<a name="ln222">	virtual	BAlignment			BaseAlignment();</a>
<a name="ln223"> </a>
<a name="ln224">			BRect				FrameInParent() const;</a>
<a name="ln225"> </a>
<a name="ln226">	virtual status_t			Archive(BMessage* into, bool deep = true) const;</a>
<a name="ln227">	static	BArchivable*		Instantiate(BMessage* from);</a>
<a name="ln228"> </a>
<a name="ln229">private:</a>
<a name="ln230">			BAbstractSpinner*	fParent;</a>
<a name="ln231">			BRect				fFrame;</a>
<a name="ln232">};</a>
<a name="ln233"> </a>
<a name="ln234"> </a>
<a name="ln235">class BAbstractSpinner::TextViewLayoutItem : public BAbstractLayoutItem {</a>
<a name="ln236">public:</a>
<a name="ln237">								TextViewLayoutItem(BAbstractSpinner* parent);</a>
<a name="ln238">								TextViewLayoutItem(BMessage* archive);</a>
<a name="ln239"> </a>
<a name="ln240">	virtual	bool				IsVisible();</a>
<a name="ln241">	virtual	void				SetVisible(bool visible);</a>
<a name="ln242"> </a>
<a name="ln243">	virtual	BRect				Frame();</a>
<a name="ln244">	virtual	void				SetFrame(BRect frame);</a>
<a name="ln245"> </a>
<a name="ln246">			void				SetParent(BAbstractSpinner* parent);</a>
<a name="ln247">	virtual	BView*				View();</a>
<a name="ln248"> </a>
<a name="ln249">	virtual	BSize				BaseMinSize();</a>
<a name="ln250">	virtual	BSize				BaseMaxSize();</a>
<a name="ln251">	virtual	BSize				BasePreferredSize();</a>
<a name="ln252">	virtual	BAlignment			BaseAlignment();</a>
<a name="ln253"> </a>
<a name="ln254">			BRect				FrameInParent() const;</a>
<a name="ln255"> </a>
<a name="ln256">	virtual status_t			Archive(BMessage* into, bool deep = true) const;</a>
<a name="ln257">	static	BArchivable*		Instantiate(BMessage* from);</a>
<a name="ln258"> </a>
<a name="ln259">private:</a>
<a name="ln260">			BAbstractSpinner*	fParent;</a>
<a name="ln261">			BRect				fFrame;</a>
<a name="ln262">};</a>
<a name="ln263"> </a>
<a name="ln264"> </a>
<a name="ln265">struct BAbstractSpinner::LayoutData {</a>
<a name="ln266">	LayoutData(float width, float height)</a>
<a name="ln267">	:</a>
<a name="ln268">	label_layout_item(NULL),</a>
<a name="ln269">	text_view_layout_item(NULL),</a>
<a name="ln270">	label_width(0),</a>
<a name="ln271">	label_height(0),</a>
<a name="ln272">	text_view_width(0),</a>
<a name="ln273">	text_view_height(0),</a>
<a name="ln274">	previous_width(width),</a>
<a name="ln275">	previous_height(height),</a>
<a name="ln276">	valid(false)</a>
<a name="ln277">	{</a>
<a name="ln278">	}</a>
<a name="ln279"> </a>
<a name="ln280">	LabelLayoutItem* label_layout_item;</a>
<a name="ln281">	TextViewLayoutItem* text_view_layout_item;</a>
<a name="ln282"> </a>
<a name="ln283">	font_height font_info;</a>
<a name="ln284"> </a>
<a name="ln285">	float label_width;</a>
<a name="ln286">	float label_height;</a>
<a name="ln287">	float text_view_width;</a>
<a name="ln288">	float text_view_height;</a>
<a name="ln289"> </a>
<a name="ln290">	float previous_width;</a>
<a name="ln291">	float previous_height;</a>
<a name="ln292"> </a>
<a name="ln293">	BSize min;</a>
<a name="ln294">	BAlignment alignment;</a>
<a name="ln295"> </a>
<a name="ln296">	bool valid;</a>
<a name="ln297">};</a>
<a name="ln298"> </a>
<a name="ln299"> </a>
<a name="ln300">//	#pragma mark - SpinnerButton</a>
<a name="ln301"> </a>
<a name="ln302"> </a>
<a name="ln303">SpinnerButton::SpinnerButton(BRect frame, const char* name,</a>
<a name="ln304">	spinner_direction direction)</a>
<a name="ln305">	:</a>
<a name="ln306">	BView(frame, name, B_FOLLOW_RIGHT | B_FOLLOW_TOP, B_WILL_DRAW),</a>
<a name="ln307">	fSpinnerDirection(direction),</a>
<a name="ln308">	fParent(NULL),</a>
<a name="ln309">	fIsEnabled(true),</a>
<a name="ln310">	fIsMouseDown(false),</a>
<a name="ln311">	fIsMouseOver(false),</a>
<a name="ln312">	fRepeatDelay(100000)</a>
<a name="ln313">{</a>
<a name="ln314">}</a>
<a name="ln315"> </a>
<a name="ln316"> </a>
<a name="ln317">SpinnerButton::~SpinnerButton()</a>
<a name="ln318">{</a>
<a name="ln319">}</a>
<a name="ln320"> </a>
<a name="ln321"> </a>
<a name="ln322">void</a>
<a name="ln323">SpinnerButton::AttachedToWindow()</a>
<a name="ln324">{</a>
<a name="ln325">	fParent = static_cast&lt;BAbstractSpinner*&gt;(Parent());</a>
<a name="ln326"> </a>
<a name="ln327">	AdoptParentColors();</a>
<a name="ln328">	BView::AttachedToWindow();</a>
<a name="ln329">}</a>
<a name="ln330"> </a>
<a name="ln331"> </a>
<a name="ln332">void</a>
<a name="ln333">SpinnerButton::DetachedFromWindow()</a>
<a name="ln334">{</a>
<a name="ln335">	fParent = NULL;</a>
<a name="ln336"> </a>
<a name="ln337">	BView::DetachedFromWindow();</a>
<a name="ln338">}</a>
<a name="ln339"> </a>
<a name="ln340"> </a>
<a name="ln341">void</a>
<a name="ln342">SpinnerButton::Draw(BRect updateRect)</a>
<a name="ln343">{</a>
<a name="ln344">	BRect rect(Bounds());</a>
<a name="ln345">	if (!rect.IsValid() || !rect.Intersects(updateRect))</a>
<a name="ln346">		return;</a>
<a name="ln347"> </a>
<a name="ln348">	BView::Draw(updateRect);</a>
<a name="ln349"> </a>
<a name="ln350">	float frameTint = fIsEnabled ? B_DARKEN_1_TINT : B_NO_TINT;</a>
<a name="ln351"> </a>
<a name="ln352">	float fgTint;</a>
<a name="ln353">	if (!fIsEnabled)</a>
<a name="ln354">		fgTint = B_DARKEN_1_TINT;</a>
<a name="ln355">	else if (fIsMouseDown)</a>
<a name="ln356">		fgTint = B_DARKEN_MAX_TINT;</a>
<a name="ln357">	else</a>
<a name="ln358">		fgTint = 1.777f;	// 216 --&gt; 48.2 (48)</a>
<a name="ln359"> </a>
<a name="ln360">	float bgTint;</a>
<a name="ln361">	if (fIsEnabled &amp;&amp; fIsMouseOver)</a>
<a name="ln362">		bgTint = B_DARKEN_1_TINT;</a>
<a name="ln363">	else</a>
<a name="ln364">		bgTint = B_NO_TINT;</a>
<a name="ln365"> </a>
<a name="ln366">	rgb_color bgColor = ui_color(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln367">	if (bgColor.red + bgColor.green + bgColor.blue &lt;= 128 * 3) {</a>
<a name="ln368">		// if dark background make the tint lighter</a>
<a name="ln369">		frameTint = 2.0f - frameTint;</a>
<a name="ln370">		fgTint = 2.0f - fgTint;</a>
<a name="ln371">		bgTint = 2.0f - bgTint;</a>
<a name="ln372">	}</a>
<a name="ln373"> </a>
<a name="ln374">	uint32 borders = be_control_look-&gt;B_TOP_BORDER</a>
<a name="ln375">		| be_control_look-&gt;B_BOTTOM_BORDER;</a>
<a name="ln376"> </a>
<a name="ln377">	if (fSpinnerDirection == SPINNER_INCREMENT)</a>
<a name="ln378">		borders |= be_control_look-&gt;B_RIGHT_BORDER;</a>
<a name="ln379">	else</a>
<a name="ln380">		borders |= be_control_look-&gt;B_LEFT_BORDER;</a>
<a name="ln381"> </a>
<a name="ln382">	uint32 flags = fIsMouseDown ? BControlLook::B_ACTIVATED : 0;</a>
<a name="ln383">	flags |= !fIsEnabled ? BControlLook::B_DISABLED : 0;</a>
<a name="ln384"> </a>
<a name="ln385">	// draw the button</a>
<a name="ln386">	be_control_look-&gt;DrawButtonFrame(this, rect, updateRect,</a>
<a name="ln387">		tint_color(bgColor, frameTint), bgColor, flags, borders);</a>
<a name="ln388">	be_control_look-&gt;DrawButtonBackground(this, rect, updateRect,</a>
<a name="ln389">		tint_color(bgColor, bgTint), flags, borders);</a>
<a name="ln390"> </a>
<a name="ln391">	switch (fParent-&gt;ButtonStyle()) {</a>
<a name="ln392">		case SPINNER_BUTTON_HORIZONTAL_ARROWS:</a>
<a name="ln393">		{</a>
<a name="ln394">			int32 arrowDirection = fSpinnerDirection == SPINNER_INCREMENT</a>
<a name="ln395">				? be_control_look-&gt;B_RIGHT_ARROW</a>
<a name="ln396">				: be_control_look-&gt;B_LEFT_ARROW;</a>
<a name="ln397"> </a>
<a name="ln398">			rect.InsetBy(0.0f, 1.0f);</a>
<a name="ln399">			be_control_look-&gt;DrawArrowShape(this, rect, updateRect, bgColor,</a>
<a name="ln400">				arrowDirection, 0, fgTint);</a>
<a name="ln401">			break;</a>
<a name="ln402">		}</a>
<a name="ln403"> </a>
<a name="ln404">		case SPINNER_BUTTON_VERTICAL_ARROWS:</a>
<a name="ln405">		{</a>
<a name="ln406">			int32 arrowDirection = fSpinnerDirection == SPINNER_INCREMENT</a>
<a name="ln407">				? be_control_look-&gt;B_UP_ARROW</a>
<a name="ln408">				: be_control_look-&gt;B_DOWN_ARROW;</a>
<a name="ln409"> </a>
<a name="ln410">			rect.InsetBy(0.0f, 1.0f);</a>
<a name="ln411">			be_control_look-&gt;DrawArrowShape(this, rect, updateRect, bgColor,</a>
<a name="ln412">				arrowDirection, 0, fgTint);</a>
<a name="ln413">			break;</a>
<a name="ln414">		}</a>
<a name="ln415"> </a>
<a name="ln416">		default:</a>
<a name="ln417">		case SPINNER_BUTTON_PLUS_MINUS:</a>
<a name="ln418">		{</a>
<a name="ln419">			BFont font;</a>
<a name="ln420">			fParent-&gt;GetFont(&amp;font);</a>
<a name="ln421">			float inset = floorf(font.Size() / 4);</a>
<a name="ln422">			rect.InsetBy(inset, inset);</a>
<a name="ln423"> </a>
<a name="ln424">			if (rect.IntegerWidth() % 2 != 0)</a>
<a name="ln425">				rect.right -= 1;</a>
<a name="ln426"> </a>
<a name="ln427">			if (rect.IntegerHeight() % 2 != 0)</a>
<a name="ln428">				rect.bottom -= 1;</a>
<a name="ln429"> </a>
<a name="ln430">			SetHighColor(tint_color(bgColor, fgTint));</a>
<a name="ln431"> </a>
<a name="ln432">			// draw the +/-</a>
<a name="ln433">			float halfHeight = floorf(rect.Height() / 2);</a>
<a name="ln434">			StrokeLine(BPoint(rect.left, rect.top + halfHeight),</a>
<a name="ln435">				BPoint(rect.right, rect.top + halfHeight));</a>
<a name="ln436">			if (fSpinnerDirection == SPINNER_INCREMENT) {</a>
<a name="ln437">				float halfWidth = floorf(rect.Width() / 2);</a>
<a name="ln438">				StrokeLine(BPoint(rect.left + halfWidth, rect.top + 1),</a>
<a name="ln439">					BPoint(rect.left + halfWidth, rect.bottom - 1));</a>
<a name="ln440">			}</a>
<a name="ln441">		}</a>
<a name="ln442">	}</a>
<a name="ln443">}</a>
<a name="ln444"> </a>
<a name="ln445"> </a>
<a name="ln446">void</a>
<a name="ln447">SpinnerButton::MouseDown(BPoint where)</a>
<a name="ln448">{</a>
<a name="ln449">	if (fIsEnabled) {</a>
<a name="ln450">		fIsMouseDown = true;</a>
<a name="ln451">		Invalidate();</a>
<a name="ln452">		fRepeatDelay = 100000;</a>
<a name="ln453">		MouseDownThread&lt;SpinnerButton&gt;::TrackMouse(this,</a>
<a name="ln454">			&amp;SpinnerButton::_DoneTracking, &amp;SpinnerButton::_Track);</a>
<a name="ln455">	}</a>
<a name="ln456"> </a>
<a name="ln457">	BView::MouseDown(where);</a>
<a name="ln458">}</a>
<a name="ln459"> </a>
<a name="ln460"> </a>
<a name="ln461">void</a>
<a name="ln462">SpinnerButton::MouseMoved(BPoint where, uint32 transit,</a>
<a name="ln463">	const BMessage* message)</a>
<a name="ln464">{</a>
<a name="ln465">	switch (transit) {</a>
<a name="ln466">		case B_ENTERED_VIEW:</a>
<a name="ln467">		case B_INSIDE_VIEW:</a>
<a name="ln468">		{</a>
<a name="ln469">			BPoint where;</a>
<a name="ln470">			uint32 buttons;</a>
<a name="ln471">			GetMouse(&amp;where, &amp;buttons);</a>
<a name="ln472">			fIsMouseOver = Bounds().Contains(where) &amp;&amp; buttons == 0;</a>
<a name="ln473">			if (!fIsMouseDown)</a>
<a name="ln474">				Invalidate();</a>
<a name="ln475"> </a>
<a name="ln476">			break;</a>
<a name="ln477">		}</a>
<a name="ln478"> </a>
<a name="ln479">		case B_EXITED_VIEW:</a>
<a name="ln480">		case B_OUTSIDE_VIEW:</a>
<a name="ln481">			fIsMouseOver = false;</a>
<a name="ln482">			MouseUp(Bounds().LeftTop());</a>
<a name="ln483">			break;</a>
<a name="ln484">	}</a>
<a name="ln485"> </a>
<a name="ln486">	BView::MouseMoved(where, transit, message);</a>
<a name="ln487">}</a>
<a name="ln488"> </a>
<a name="ln489"> </a>
<a name="ln490">void</a>
<a name="ln491">SpinnerButton::MouseUp(BPoint where)</a>
<a name="ln492">{</a>
<a name="ln493">	fIsMouseDown = false;</a>
<a name="ln494">	Invalidate();</a>
<a name="ln495"> </a>
<a name="ln496">	BView::MouseUp(where);</a>
<a name="ln497">}</a>
<a name="ln498"> </a>
<a name="ln499"> </a>
<a name="ln500">//	#pragma mark  - SpinnerButton private methods</a>
<a name="ln501"> </a>
<a name="ln502"> </a>
<a name="ln503">void</a>
<a name="ln504">SpinnerButton::_DoneTracking(BPoint where)</a>
<a name="ln505">{</a>
<a name="ln506">	if (fIsMouseDown || !Bounds().Contains(where))</a>
<a name="ln507">		fIsMouseDown = false;</a>
<a name="ln508">}</a>
<a name="ln509"> </a>
<a name="ln510"> </a>
<a name="ln511">void</a>
<a name="ln512">SpinnerButton::_Track(BPoint where, uint32)</a>
<a name="ln513">{</a>
<a name="ln514">	if (fParent == NULL || !Bounds().Contains(where)) {</a>
<a name="ln515">		fIsMouseDown = false;</a>
<a name="ln516">		return;</a>
<a name="ln517">	}</a>
<a name="ln518">	fIsMouseDown = true;</a>
<a name="ln519"> </a>
<a name="ln520">	fSpinnerDirection == SPINNER_INCREMENT</a>
<a name="ln521">		? fParent-&gt;Increment()</a>
<a name="ln522">		: fParent-&gt;Decrement();</a>
<a name="ln523"> </a>
<a name="ln524">	snooze(fRepeatDelay);</a>
<a name="ln525">	fRepeatDelay = 10000;</a>
<a name="ln526">}</a>
<a name="ln527"> </a>
<a name="ln528"> </a>
<a name="ln529">//	#pragma mark - SpinnerTextView</a>
<a name="ln530"> </a>
<a name="ln531"> </a>
<a name="ln532">SpinnerTextView::SpinnerTextView(BRect rect, BRect textRect)</a>
<a name="ln533">	:</a>
<a name="ln534">	BTextView(rect, &quot;textview&quot;, textRect, B_FOLLOW_ALL,</a>
<a name="ln535">		B_WILL_DRAW | B_NAVIGABLE),</a>
<a name="ln536">	fParent(NULL)</a>
<a name="ln537">{</a>
<a name="ln538">	MakeResizable(true);</a>
<a name="ln539">}</a>
<a name="ln540"> </a>
<a name="ln541"> </a>
<a name="ln542">SpinnerTextView::~SpinnerTextView()</a>
<a name="ln543">{</a>
<a name="ln544">}</a>
<a name="ln545"> </a>
<a name="ln546"> </a>
<a name="ln547">void</a>
<a name="ln548">SpinnerTextView::AttachedToWindow()</a>
<a name="ln549">{</a>
<a name="ln550">	fParent = static_cast&lt;BAbstractSpinner*&gt;(Parent());</a>
<a name="ln551"> </a>
<a name="ln552">	BTextView::AttachedToWindow();</a>
<a name="ln553">}</a>
<a name="ln554"> </a>
<a name="ln555"> </a>
<a name="ln556">void</a>
<a name="ln557">SpinnerTextView::DetachedFromWindow()</a>
<a name="ln558">{</a>
<a name="ln559">	fParent = NULL;</a>
<a name="ln560"> </a>
<a name="ln561">	BTextView::DetachedFromWindow();</a>
<a name="ln562">}</a>
<a name="ln563"> </a>
<a name="ln564"> </a>
<a name="ln565">void</a>
<a name="ln566">SpinnerTextView::KeyDown(const char* bytes, int32 numBytes)</a>
<a name="ln567">{</a>
<a name="ln568">	if (fParent == NULL) {</a>
<a name="ln569">		BTextView::KeyDown(bytes, numBytes);</a>
<a name="ln570">		return;</a>
<a name="ln571">	}</a>
<a name="ln572"> </a>
<a name="ln573">	switch (bytes[0]) {</a>
<a name="ln574">		case B_ENTER:</a>
<a name="ln575">		case B_SPACE:</a>
<a name="ln576">			fParent-&gt;SetValueFromText();</a>
<a name="ln577">			break;</a>
<a name="ln578"> </a>
<a name="ln579">		case B_TAB:</a>
<a name="ln580">			fParent-&gt;KeyDown(bytes, numBytes);</a>
<a name="ln581">			break;</a>
<a name="ln582"> </a>
<a name="ln583">		case B_LEFT_ARROW:</a>
<a name="ln584">			if (fParent-&gt;ButtonStyle() == SPINNER_BUTTON_HORIZONTAL_ARROWS</a>
<a name="ln585">				&amp;&amp; (modifiers() &amp; B_CONTROL_KEY) != 0) {</a>
<a name="ln586">				// need to hold down control, otherwise can't move cursor</a>
<a name="ln587">				fParent-&gt;Decrement();</a>
<a name="ln588">			} else</a>
<a name="ln589">				BTextView::KeyDown(bytes, numBytes);</a>
<a name="ln590">			break;</a>
<a name="ln591"> </a>
<a name="ln592">		case B_UP_ARROW:</a>
<a name="ln593">			if (fParent-&gt;ButtonStyle() != SPINNER_BUTTON_HORIZONTAL_ARROWS)</a>
<a name="ln594">				fParent-&gt;Increment();</a>
<a name="ln595">			else</a>
<a name="ln596">				BTextView::KeyDown(bytes, numBytes);</a>
<a name="ln597">			break;</a>
<a name="ln598"> </a>
<a name="ln599">		case B_RIGHT_ARROW:</a>
<a name="ln600">			if (fParent-&gt;ButtonStyle() == SPINNER_BUTTON_HORIZONTAL_ARROWS</a>
<a name="ln601">				&amp;&amp; (modifiers() &amp; B_CONTROL_KEY) != 0) {</a>
<a name="ln602">				// need to hold down control, otherwise can't move cursor</a>
<a name="ln603">				fParent-&gt;Increment();</a>
<a name="ln604">			} else</a>
<a name="ln605">				BTextView::KeyDown(bytes, numBytes);</a>
<a name="ln606">			break;</a>
<a name="ln607"> </a>
<a name="ln608">		case B_DOWN_ARROW:</a>
<a name="ln609">			if (fParent-&gt;ButtonStyle() != SPINNER_BUTTON_HORIZONTAL_ARROWS)</a>
<a name="ln610">				fParent-&gt;Decrement();</a>
<a name="ln611">			else</a>
<a name="ln612">				BTextView::KeyDown(bytes, numBytes);</a>
<a name="ln613">			break;</a>
<a name="ln614"> </a>
<a name="ln615">		default:</a>
<a name="ln616">			BTextView::KeyDown(bytes, numBytes);</a>
<a name="ln617">			break;</a>
<a name="ln618">	}</a>
<a name="ln619">}</a>
<a name="ln620"> </a>
<a name="ln621"> </a>
<a name="ln622">void</a>
<a name="ln623">SpinnerTextView::MakeFocus(bool focus)</a>
<a name="ln624">{</a>
<a name="ln625">	BTextView::MakeFocus(focus);</a>
<a name="ln626"> </a>
<a name="ln627">	if (fParent == NULL)</a>
<a name="ln628">		return;</a>
<a name="ln629"> </a>
<a name="ln630">	if (focus)</a>
<a name="ln631">		SelectAll();</a>
<a name="ln632">	else</a>
<a name="ln633">		fParent-&gt;SetValueFromText();</a>
<a name="ln634"> </a>
<a name="ln635">	fParent-&gt;_DrawTextView(fParent-&gt;Bounds());</a>
<a name="ln636">}</a>
<a name="ln637"> </a>
<a name="ln638"> </a>
<a name="ln639">//	#pragma mark - BAbstractSpinner::LabelLayoutItem</a>
<a name="ln640"> </a>
<a name="ln641"> </a>
<a name="ln642">BAbstractSpinner::LabelLayoutItem::LabelLayoutItem(BAbstractSpinner* parent)</a>
<a name="ln643">	:</a>
<a name="ln644">	fParent(parent),</a>
<a name="ln645">	fFrame()</a>
<a name="ln646">{</a>
<a name="ln647">}</a>
<a name="ln648"> </a>
<a name="ln649"> </a>
<a name="ln650">BAbstractSpinner::LabelLayoutItem::LabelLayoutItem(BMessage* from)</a>
<a name="ln651">	:</a>
<a name="ln652">	BAbstractLayoutItem(from),</a>
<a name="ln653">	fParent(NULL),</a>
<a name="ln654">	fFrame()</a>
<a name="ln655">{</a>
<a name="ln656">	from-&gt;FindRect(kFrameField, &amp;fFrame);</a>
<a name="ln657">}</a>
<a name="ln658"> </a>
<a name="ln659"> </a>
<a name="ln660">bool</a>
<a name="ln661">BAbstractSpinner::LabelLayoutItem::IsVisible()</a>
<a name="ln662">{</a>
<a name="ln663">	return !fParent-&gt;IsHidden(fParent);</a>
<a name="ln664">}</a>
<a name="ln665"> </a>
<a name="ln666"> </a>
<a name="ln667">void</a>
<a name="ln668">BAbstractSpinner::LabelLayoutItem::SetVisible(bool visible)</a>
<a name="ln669">{</a>
<a name="ln670">}</a>
<a name="ln671"> </a>
<a name="ln672"> </a>
<a name="ln673">BRect</a>
<a name="ln674">BAbstractSpinner::LabelLayoutItem::Frame()</a>
<a name="ln675">{</a>
<a name="ln676">	return fFrame;</a>
<a name="ln677">}</a>
<a name="ln678"> </a>
<a name="ln679"> </a>
<a name="ln680">void</a>
<a name="ln681">BAbstractSpinner::LabelLayoutItem::SetFrame(BRect frame)</a>
<a name="ln682">{</a>
<a name="ln683">	fFrame = frame;</a>
<a name="ln684">	fParent-&gt;_UpdateFrame();</a>
<a name="ln685">}</a>
<a name="ln686"> </a>
<a name="ln687"> </a>
<a name="ln688">void</a>
<a name="ln689">BAbstractSpinner::LabelLayoutItem::SetParent(BAbstractSpinner* parent)</a>
<a name="ln690">{</a>
<a name="ln691">	fParent = parent;</a>
<a name="ln692">}</a>
<a name="ln693"> </a>
<a name="ln694"> </a>
<a name="ln695">BView*</a>
<a name="ln696">BAbstractSpinner::LabelLayoutItem::View()</a>
<a name="ln697">{</a>
<a name="ln698">	return fParent;</a>
<a name="ln699">}</a>
<a name="ln700"> </a>
<a name="ln701"> </a>
<a name="ln702">BSize</a>
<a name="ln703">BAbstractSpinner::LabelLayoutItem::BaseMinSize()</a>
<a name="ln704">{</a>
<a name="ln705">	fParent-&gt;_ValidateLayoutData();</a>
<a name="ln706"> </a>
<a name="ln707">	if (fParent-&gt;Label() == NULL)</a>
<a name="ln708">		return BSize(-1.0f, -1.0f);</a>
<a name="ln709"> </a>
<a name="ln710">	return BSize(fParent-&gt;fLayoutData-&gt;label_width</a>
<a name="ln711">			+ be_control_look-&gt;DefaultLabelSpacing(),</a>
<a name="ln712">		fParent-&gt;fLayoutData-&gt;label_height);</a>
<a name="ln713">}</a>
<a name="ln714"> </a>
<a name="ln715"> </a>
<a name="ln716">BSize</a>
<a name="ln717">BAbstractSpinner::LabelLayoutItem::BaseMaxSize()</a>
<a name="ln718">{</a>
<a name="ln719">	return BaseMinSize();</a>
<a name="ln720">}</a>
<a name="ln721"> </a>
<a name="ln722"> </a>
<a name="ln723">BSize</a>
<a name="ln724">BAbstractSpinner::LabelLayoutItem::BasePreferredSize()</a>
<a name="ln725">{</a>
<a name="ln726">	return BaseMinSize();</a>
<a name="ln727">}</a>
<a name="ln728"> </a>
<a name="ln729"> </a>
<a name="ln730">BAlignment</a>
<a name="ln731">BAbstractSpinner::LabelLayoutItem::BaseAlignment()</a>
<a name="ln732">{</a>
<a name="ln733">	return BAlignment(B_ALIGN_USE_FULL_WIDTH, B_ALIGN_USE_FULL_HEIGHT);</a>
<a name="ln734">}</a>
<a name="ln735"> </a>
<a name="ln736"> </a>
<a name="ln737">BRect</a>
<a name="ln738">BAbstractSpinner::LabelLayoutItem::FrameInParent() const</a>
<a name="ln739">{</a>
<a name="ln740">	return fFrame.OffsetByCopy(-fParent-&gt;Frame().left, -fParent-&gt;Frame().top);</a>
<a name="ln741">}</a>
<a name="ln742"> </a>
<a name="ln743"> </a>
<a name="ln744">status_t</a>
<a name="ln745">BAbstractSpinner::LabelLayoutItem::Archive(BMessage* into, bool deep) const</a>
<a name="ln746">{</a>
<a name="ln747">	BArchiver archiver(into);</a>
<a name="ln748">	status_t result = BAbstractLayoutItem::Archive(into, deep);</a>
<a name="ln749"> </a>
<a name="ln750">	if (result == B_OK)</a>
<a name="ln751">		result = into-&gt;AddRect(kFrameField, fFrame);</a>
<a name="ln752"> </a>
<a name="ln753">	return archiver.Finish(result);</a>
<a name="ln754">}</a>
<a name="ln755"> </a>
<a name="ln756"> </a>
<a name="ln757">BArchivable*</a>
<a name="ln758">BAbstractSpinner::LabelLayoutItem::Instantiate(BMessage* from)</a>
<a name="ln759">{</a>
<a name="ln760">	if (validate_instantiation(from, &quot;BAbstractSpinner::LabelLayoutItem&quot;))</a>
<a name="ln761">		return new LabelLayoutItem(from);</a>
<a name="ln762"> </a>
<a name="ln763">	return NULL;</a>
<a name="ln764">}</a>
<a name="ln765"> </a>
<a name="ln766"> </a>
<a name="ln767">//	#pragma mark - BAbstractSpinner::TextViewLayoutItem</a>
<a name="ln768"> </a>
<a name="ln769"> </a>
<a name="ln770">BAbstractSpinner::TextViewLayoutItem::TextViewLayoutItem(BAbstractSpinner* parent)</a>
<a name="ln771">	:</a>
<a name="ln772">	fParent(parent),</a>
<a name="ln773">	fFrame()</a>
<a name="ln774">{</a>
<a name="ln775">	SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln776">}</a>
<a name="ln777"> </a>
<a name="ln778"> </a>
<a name="ln779">BAbstractSpinner::TextViewLayoutItem::TextViewLayoutItem(BMessage* from)</a>
<a name="ln780">	:</a>
<a name="ln781">	BAbstractLayoutItem(from),</a>
<a name="ln782">	fParent(NULL),</a>
<a name="ln783">	fFrame()</a>
<a name="ln784">{</a>
<a name="ln785">	from-&gt;FindRect(kFrameField, &amp;fFrame);</a>
<a name="ln786">}</a>
<a name="ln787"> </a>
<a name="ln788"> </a>
<a name="ln789">bool</a>
<a name="ln790">BAbstractSpinner::TextViewLayoutItem::IsVisible()</a>
<a name="ln791">{</a>
<a name="ln792">	return !fParent-&gt;IsHidden(fParent);</a>
<a name="ln793">}</a>
<a name="ln794"> </a>
<a name="ln795"> </a>
<a name="ln796">void</a>
<a name="ln797">BAbstractSpinner::TextViewLayoutItem::SetVisible(bool visible)</a>
<a name="ln798">{</a>
<a name="ln799">	// not allowed</a>
<a name="ln800">}</a>
<a name="ln801"> </a>
<a name="ln802"> </a>
<a name="ln803">BRect</a>
<a name="ln804">BAbstractSpinner::TextViewLayoutItem::Frame()</a>
<a name="ln805">{</a>
<a name="ln806">	return fFrame;</a>
<a name="ln807">}</a>
<a name="ln808"> </a>
<a name="ln809"> </a>
<a name="ln810">void</a>
<a name="ln811">BAbstractSpinner::TextViewLayoutItem::SetFrame(BRect frame)</a>
<a name="ln812">{</a>
<a name="ln813">	fFrame = frame;</a>
<a name="ln814">	fParent-&gt;_UpdateFrame();</a>
<a name="ln815">}</a>
<a name="ln816"> </a>
<a name="ln817"> </a>
<a name="ln818">void</a>
<a name="ln819">BAbstractSpinner::TextViewLayoutItem::SetParent(BAbstractSpinner* parent)</a>
<a name="ln820">{</a>
<a name="ln821">	fParent = parent;</a>
<a name="ln822">}</a>
<a name="ln823"> </a>
<a name="ln824"> </a>
<a name="ln825">BView*</a>
<a name="ln826">BAbstractSpinner::TextViewLayoutItem::View()</a>
<a name="ln827">{</a>
<a name="ln828">	return fParent;</a>
<a name="ln829">}</a>
<a name="ln830"> </a>
<a name="ln831"> </a>
<a name="ln832">BSize</a>
<a name="ln833">BAbstractSpinner::TextViewLayoutItem::BaseMinSize()</a>
<a name="ln834">{</a>
<a name="ln835">	fParent-&gt;_ValidateLayoutData();</a>
<a name="ln836"> </a>
<a name="ln837">	BSize size(fParent-&gt;fLayoutData-&gt;text_view_width,</a>
<a name="ln838">		fParent-&gt;fLayoutData-&gt;text_view_height);</a>
<a name="ln839"> </a>
<a name="ln840">	return size;</a>
<a name="ln841">}</a>
<a name="ln842"> </a>
<a name="ln843"> </a>
<a name="ln844">BSize</a>
<a name="ln845">BAbstractSpinner::TextViewLayoutItem::BaseMaxSize()</a>
<a name="ln846">{</a>
<a name="ln847">	return BaseMinSize();</a>
<a name="ln848">}</a>
<a name="ln849"> </a>
<a name="ln850"> </a>
<a name="ln851">BSize</a>
<a name="ln852">BAbstractSpinner::TextViewLayoutItem::BasePreferredSize()</a>
<a name="ln853">{</a>
<a name="ln854">	return BaseMinSize();</a>
<a name="ln855">}</a>
<a name="ln856"> </a>
<a name="ln857"> </a>
<a name="ln858">BAlignment</a>
<a name="ln859">BAbstractSpinner::TextViewLayoutItem::BaseAlignment()</a>
<a name="ln860">{</a>
<a name="ln861">	return BAlignment(B_ALIGN_USE_FULL_WIDTH, B_ALIGN_USE_FULL_HEIGHT);</a>
<a name="ln862">}</a>
<a name="ln863"> </a>
<a name="ln864"> </a>
<a name="ln865">BRect</a>
<a name="ln866">BAbstractSpinner::TextViewLayoutItem::FrameInParent() const</a>
<a name="ln867">{</a>
<a name="ln868">	return fFrame.OffsetByCopy(-fParent-&gt;Frame().left, -fParent-&gt;Frame().top);</a>
<a name="ln869">}</a>
<a name="ln870"> </a>
<a name="ln871"> </a>
<a name="ln872">status_t</a>
<a name="ln873">BAbstractSpinner::TextViewLayoutItem::Archive(BMessage* into, bool deep) const</a>
<a name="ln874">{</a>
<a name="ln875">	BArchiver archiver(into);</a>
<a name="ln876">	status_t result = BAbstractLayoutItem::Archive(into, deep);</a>
<a name="ln877"> </a>
<a name="ln878">	if (result == B_OK)</a>
<a name="ln879">		result = into-&gt;AddRect(kFrameField, fFrame);</a>
<a name="ln880"> </a>
<a name="ln881">	return archiver.Finish(result);</a>
<a name="ln882">}</a>
<a name="ln883"> </a>
<a name="ln884"> </a>
<a name="ln885">BArchivable*</a>
<a name="ln886">BAbstractSpinner::TextViewLayoutItem::Instantiate(BMessage* from)</a>
<a name="ln887">{</a>
<a name="ln888">	if (validate_instantiation(from, &quot;BAbstractSpinner::TextViewLayoutItem&quot;))</a>
<a name="ln889">		return new LabelLayoutItem(from);</a>
<a name="ln890"> </a>
<a name="ln891">	return NULL;</a>
<a name="ln892">}</a>
<a name="ln893"> </a>
<a name="ln894"> </a>
<a name="ln895">//	#pragma mark - BAbstractSpinner</a>
<a name="ln896"> </a>
<a name="ln897"> </a>
<a name="ln898">BAbstractSpinner::BAbstractSpinner(BRect frame, const char* name, const char* label,</a>
<a name="ln899">	BMessage* message, uint32 resizingMode, uint32 flags)</a>
<a name="ln900">	:</a>
<a name="ln901">	BControl(frame, name, label, message, resizingMode,</a>
<a name="ln902">		flags | B_WILL_DRAW | B_FRAME_EVENTS)</a>
<a name="ln903">{</a>
<a name="ln904">	_InitObject();</a>
<a name="ln905">}</a>
<a name="ln906"> </a>
<a name="ln907"> </a>
<a name="ln908">BAbstractSpinner::BAbstractSpinner(const char* name, const char* label, BMessage* message,</a>
<a name="ln909">	uint32 flags)</a>
<a name="ln910">	:</a>
<a name="ln911">	BControl(name, label, message, flags | B_WILL_DRAW | B_FRAME_EVENTS)</a>
<a name="ln912">{</a>
<a name="ln913">	_InitObject();</a>
<a name="ln914">}</a>
<a name="ln915"> </a>
<a name="ln916"> </a>
<a name="ln917">BAbstractSpinner::BAbstractSpinner(BMessage* data)</a>
<a name="ln918">	:</a>
<a name="ln919">	BControl(data),</a>
<a name="ln920">	fButtonStyle(SPINNER_BUTTON_PLUS_MINUS)</a>
<a name="ln921">{</a>
<a name="ln922">	_InitObject();</a>
<a name="ln923"> </a>
<a name="ln924">	if (data-&gt;FindInt32(&quot;_align&quot;) != B_OK)</a>
<a name="ln925">		fAlignment = B_ALIGN_LEFT;</a>
<a name="ln926"> </a>
<a name="ln927">	if (data-&gt;FindInt32(&quot;_button_style&quot;) != B_OK)</a>
<a name="ln928">		fButtonStyle = SPINNER_BUTTON_PLUS_MINUS;</a>
<a name="ln929"> </a>
<a name="ln930">	if (data-&gt;FindInt32(&quot;_divider&quot;) != B_OK)</a>
<a name="ln931">		fDivider = 0.0f;</a>
<a name="ln932">}</a>
<a name="ln933"> </a>
<a name="ln934"> </a>
<a name="ln935">BAbstractSpinner::~BAbstractSpinner()</a>
<a name="ln936">{</a>
<a name="ln937">	delete fLayoutData;</a>
<a name="ln938">	fLayoutData = NULL;</a>
<a name="ln939">}</a>
<a name="ln940"> </a>
<a name="ln941"> </a>
<a name="ln942">BArchivable*</a>
<a name="ln943">BAbstractSpinner::Instantiate(BMessage* data)</a>
<a name="ln944">{</a>
<a name="ln945">	// cannot instantiate an abstract spinner</a>
<a name="ln946">	return NULL;</a>
<a name="ln947">}</a>
<a name="ln948"> </a>
<a name="ln949"> </a>
<a name="ln950">status_t</a>
<a name="ln951">BAbstractSpinner::Archive(BMessage* data, bool deep) const</a>
<a name="ln952">{</a>
<a name="ln953">	status_t status = BControl::Archive(data, deep);</a>
<a name="ln954">	data-&gt;AddString(&quot;class&quot;, &quot;Spinner&quot;);</a>
<a name="ln955"> </a>
<a name="ln956">	if (status == B_OK)</a>
<a name="ln957">		status = data-&gt;AddInt32(&quot;_align&quot;, fAlignment);</a>
<a name="ln958"> </a>
<a name="ln959">	if (status == B_OK)</a>
<a name="ln960">		data-&gt;AddInt32(&quot;_button_style&quot;, fButtonStyle);</a>
<a name="ln961"> </a>
<a name="ln962">	if (status == B_OK)</a>
<a name="ln963">		status = data-&gt;AddFloat(&quot;_divider&quot;, fDivider);</a>
<a name="ln964"> </a>
<a name="ln965">	return status;</a>
<a name="ln966">}</a>
<a name="ln967"> </a>
<a name="ln968"> </a>
<a name="ln969">status_t</a>
<a name="ln970">BAbstractSpinner::GetSupportedSuites(BMessage* message)</a>
<a name="ln971">{</a>
<a name="ln972">	message-&gt;AddString(&quot;suites&quot;, &quot;suite/vnd.Haiku-spinner&quot;);</a>
<a name="ln973"> </a>
<a name="ln974">	BPropertyInfo prop_info(sProperties);</a>
<a name="ln975">	message-&gt;AddFlat(&quot;messages&quot;, &amp;prop_info);</a>
<a name="ln976"> </a>
<a name="ln977">	return BView::GetSupportedSuites(message);</a>
<a name="ln978">}</a>
<a name="ln979"> </a>
<a name="ln980"> </a>
<a name="ln981">BHandler*</a>
<a name="ln982">BAbstractSpinner::ResolveSpecifier(BMessage* message, int32 index, BMessage* specifier,</a>
<a name="ln983">	int32 form, const char* property)</a>
<a name="ln984">{</a>
<a name="ln985">	return BView::ResolveSpecifier(message, index, specifier, form,</a>
<a name="ln986">		property);</a>
<a name="ln987">}</a>
<a name="ln988"> </a>
<a name="ln989"> </a>
<a name="ln990">void</a>
<a name="ln991">BAbstractSpinner::AttachedToWindow()</a>
<a name="ln992">{</a>
<a name="ln993">	if (!Messenger().IsValid())</a>
<a name="ln994">		SetTarget(Window());</a>
<a name="ln995"> </a>
<a name="ln996">	BControl::SetValue(Value());</a>
<a name="ln997">		// sets the text and enables or disables the arrows</a>
<a name="ln998"> </a>
<a name="ln999">	_UpdateTextViewColors(IsEnabled());</a>
<a name="ln1000">	fTextView-&gt;MakeEditable(IsEnabled());</a>
<a name="ln1001"> </a>
<a name="ln1002">	BView::AttachedToWindow();</a>
<a name="ln1003">}</a>
<a name="ln1004"> </a>
<a name="ln1005"> </a>
<a name="ln1006">void</a>
<a name="ln1007">BAbstractSpinner::Draw(BRect updateRect)</a>
<a name="ln1008">{</a>
<a name="ln1009">	_DrawLabel(updateRect);</a>
<a name="ln1010">	_DrawTextView(updateRect);</a>
<a name="ln1011">	fIncrement-&gt;Invalidate();</a>
<a name="ln1012">	fDecrement-&gt;Invalidate();</a>
<a name="ln1013">}</a>
<a name="ln1014"> </a>
<a name="ln1015"> </a>
<a name="ln1016">void</a>
<a name="ln1017">BAbstractSpinner::FrameResized(float width, float height)</a>
<a name="ln1018">{</a>
<a name="ln1019">	BView::FrameResized(width, height);</a>
<a name="ln1020"> </a>
<a name="ln1021">	// TODO: this causes flickering still...</a>
<a name="ln1022"> </a>
<a name="ln1023">	// changes in width</a>
<a name="ln1024"> </a>
<a name="ln1025">	BRect bounds = Bounds();</a>
<a name="ln1026"> </a>
<a name="ln1027">	if (bounds.Width() &gt; fLayoutData-&gt;previous_width) {</a>
<a name="ln1028">		// invalidate the region between the old and the new right border</a>
<a name="ln1029">		BRect rect = bounds;</a>
<a name="ln1030">		rect.left += fLayoutData-&gt;previous_width - kFrameMargin;</a>
<a name="ln1031">		rect.right--;</a>
<a name="ln1032">		Invalidate(rect);</a>
<a name="ln1033">	} else if (bounds.Width() &lt; fLayoutData-&gt;previous_width) {</a>
<a name="ln1034">		// invalidate the region of the new right border</a>
<a name="ln1035">		BRect rect = bounds;</a>
<a name="ln1036">		rect.left = rect.right - kFrameMargin;</a>
<a name="ln1037">		Invalidate(rect);</a>
<a name="ln1038">	}</a>
<a name="ln1039"> </a>
<a name="ln1040">	// changes in height</a>
<a name="ln1041"> </a>
<a name="ln1042">	if (bounds.Height() &gt; fLayoutData-&gt;previous_height) {</a>
<a name="ln1043">		// invalidate the region between the old and the new bottom border</a>
<a name="ln1044">		BRect rect = bounds;</a>
<a name="ln1045">		rect.top += fLayoutData-&gt;previous_height - kFrameMargin;</a>
<a name="ln1046">		rect.bottom--;</a>
<a name="ln1047">		Invalidate(rect);</a>
<a name="ln1048">		// invalidate label area</a>
<a name="ln1049">		rect = bounds;</a>
<a name="ln1050">		rect.right = fDivider;</a>
<a name="ln1051">		Invalidate(rect);</a>
<a name="ln1052">	} else if (bounds.Height() &lt; fLayoutData-&gt;previous_height) {</a>
<a name="ln1053">		// invalidate the region of the new bottom border</a>
<a name="ln1054">		BRect rect = bounds;</a>
<a name="ln1055">		rect.top = rect.bottom - kFrameMargin;</a>
<a name="ln1056">		Invalidate(rect);</a>
<a name="ln1057">		// invalidate label area</a>
<a name="ln1058">		rect = bounds;</a>
<a name="ln1059">		rect.right = fDivider;</a>
<a name="ln1060">		Invalidate(rect);</a>
<a name="ln1061">	}</a>
<a name="ln1062"> </a>
<a name="ln1063">	fLayoutData-&gt;previous_width = bounds.Width();</a>
<a name="ln1064">	fLayoutData-&gt;previous_height = bounds.Height();</a>
<a name="ln1065">}</a>
<a name="ln1066"> </a>
<a name="ln1067"> </a>
<a name="ln1068">void</a>
<a name="ln1069">BAbstractSpinner::ValueChanged()</a>
<a name="ln1070">{</a>
<a name="ln1071">	// hook method - does nothing</a>
<a name="ln1072">}</a>
<a name="ln1073"> </a>
<a name="ln1074"> </a>
<a name="ln1075">void</a>
<a name="ln1076">BAbstractSpinner::MessageReceived(BMessage* message)</a>
<a name="ln1077">{</a>
<a name="ln1078">	if (!IsEnabled() &amp;&amp; message-&gt;what == B_COLORS_UPDATED)</a>
<a name="ln1079">		_UpdateTextViewColors(false);</a>
<a name="ln1080"> </a>
<a name="ln1081">	BControl::MessageReceived(message);</a>
<a name="ln1082">}</a>
<a name="ln1083"> </a>
<a name="ln1084"> </a>
<a name="ln1085">void</a>
<a name="ln1086">BAbstractSpinner::MakeFocus(bool focus)</a>
<a name="ln1087">{</a>
<a name="ln1088">	fTextView-&gt;MakeFocus(focus);</a>
<a name="ln1089">}</a>
<a name="ln1090"> </a>
<a name="ln1091"> </a>
<a name="ln1092">void</a>
<a name="ln1093">BAbstractSpinner::ResizeToPreferred()</a>
<a name="ln1094">{</a>
<a name="ln1095">	BView::ResizeToPreferred();</a>
<a name="ln1096"> </a>
<a name="ln1097">	const char* label = Label();</a>
<a name="ln1098">	if (label != NULL) {</a>
<a name="ln1099">		fDivider = ceilf(StringWidth(label))</a>
<a name="ln1100">			+ be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln1101">	} else</a>
<a name="ln1102">		fDivider = 0.0f;</a>
<a name="ln1103"> </a>
<a name="ln1104">	_LayoutTextView();</a>
<a name="ln1105">}</a>
<a name="ln1106"> </a>
<a name="ln1107"> </a>
<a name="ln1108">void</a>
<a name="ln1109">BAbstractSpinner::SetFlags(uint32 flags)</a>
<a name="ln1110">{</a>
<a name="ln1111">	// If the textview is navigable, set it to not navigable if needed,</a>
<a name="ln1112">	// else if it is not navigable, set it to navigable if needed</a>
<a name="ln1113">	if (fTextView-&gt;Flags() &amp; B_NAVIGABLE) {</a>
<a name="ln1114">		if (!(flags &amp; B_NAVIGABLE))</a>
<a name="ln1115">			fTextView-&gt;SetFlags(fTextView-&gt;Flags() &amp; ~B_NAVIGABLE);</a>
<a name="ln1116">	} else {</a>
<a name="ln1117">		if (flags &amp; B_NAVIGABLE)</a>
<a name="ln1118">			fTextView-&gt;SetFlags(fTextView-&gt;Flags() | B_NAVIGABLE);</a>
<a name="ln1119">	}</a>
<a name="ln1120"> </a>
<a name="ln1121">	// Don't make this one navigable</a>
<a name="ln1122">	flags &amp;= ~B_NAVIGABLE;</a>
<a name="ln1123"> </a>
<a name="ln1124">	BView::SetFlags(flags);</a>
<a name="ln1125">}</a>
<a name="ln1126"> </a>
<a name="ln1127"> </a>
<a name="ln1128">void</a>
<a name="ln1129">BAbstractSpinner::WindowActivated(bool active)</a>
<a name="ln1130">{</a>
<a name="ln1131">	_DrawTextView(fTextView-&gt;Frame());</a>
<a name="ln1132">}</a>
<a name="ln1133"> </a>
<a name="ln1134"> </a>
<a name="ln1135">void</a>
<a name="ln1136">BAbstractSpinner::SetAlignment(alignment align)</a>
<a name="ln1137">{</a>
<a name="ln1138">	fAlignment = align;</a>
<a name="ln1139">}</a>
<a name="ln1140"> </a>
<a name="ln1141"> </a>
<a name="ln1142">void</a>
<a name="ln1143">BAbstractSpinner::SetButtonStyle(spinner_button_style buttonStyle)</a>
<a name="ln1144">{</a>
<a name="ln1145">	fButtonStyle = buttonStyle;</a>
<a name="ln1146">}</a>
<a name="ln1147"> </a>
<a name="ln1148"> </a>
<a name="ln1149">void</a>
<a name="ln1150">BAbstractSpinner::SetDivider(float position)</a>
<a name="ln1151">{</a>
<a name="ln1152">	position = roundf(position);</a>
<a name="ln1153"> </a>
<a name="ln1154">	float delta = fDivider - position;</a>
<a name="ln1155">	if (delta == 0.0f)</a>
<a name="ln1156">		return;</a>
<a name="ln1157"> </a>
<a name="ln1158">	fDivider = position;</a>
<a name="ln1159"> </a>
<a name="ln1160">	if ((Flags() &amp; B_SUPPORTS_LAYOUT) != 0) {</a>
<a name="ln1161">		// We should never get here, since layout support means, we also</a>
<a name="ln1162">		// layout the divider, and don't use this method at all.</a>
<a name="ln1163">		Relayout();</a>
<a name="ln1164">	} else {</a>
<a name="ln1165">		_LayoutTextView();</a>
<a name="ln1166">		Invalidate();</a>
<a name="ln1167">	}</a>
<a name="ln1168">}</a>
<a name="ln1169"> </a>
<a name="ln1170"> </a>
<a name="ln1171">void</a>
<a name="ln1172">BAbstractSpinner::SetEnabled(bool enable)</a>
<a name="ln1173">{</a>
<a name="ln1174">	if (IsEnabled() == enable)</a>
<a name="ln1175">		return;</a>
<a name="ln1176"> </a>
<a name="ln1177">	BControl::SetEnabled(enable);</a>
<a name="ln1178"> </a>
<a name="ln1179">	fTextView-&gt;MakeEditable(enable);</a>
<a name="ln1180">	if (enable)</a>
<a name="ln1181">		fTextView-&gt;SetFlags(fTextView-&gt;Flags() | B_NAVIGABLE);</a>
<a name="ln1182">	else</a>
<a name="ln1183">		fTextView-&gt;SetFlags(fTextView-&gt;Flags() &amp; ~B_NAVIGABLE);</a>
<a name="ln1184"> </a>
<a name="ln1185">	_UpdateTextViewColors(enable);</a>
<a name="ln1186">	fTextView-&gt;Invalidate();</a>
<a name="ln1187"> </a>
<a name="ln1188">	_LayoutTextView();</a>
<a name="ln1189">	Invalidate();</a>
<a name="ln1190">	if (Window() != NULL)</a>
<a name="ln1191">		Window()-&gt;UpdateIfNeeded();</a>
<a name="ln1192">}</a>
<a name="ln1193"> </a>
<a name="ln1194"> </a>
<a name="ln1195">void</a>
<a name="ln1196">BAbstractSpinner::SetLabel(const char* label)</a>
<a name="ln1197">{</a>
<a name="ln1198">	BControl::SetLabel(label);</a>
<a name="ln1199"> </a>
<a name="ln1200">	if (Window() != NULL)</a>
<a name="ln1201">		Window()-&gt;UpdateIfNeeded();</a>
<a name="ln1202">}</a>
<a name="ln1203"> </a>
<a name="ln1204"> </a>
<a name="ln1205">bool</a>
<a name="ln1206">BAbstractSpinner::IsDecrementEnabled() const</a>
<a name="ln1207">{</a>
<a name="ln1208">	return fDecrement-&gt;IsEnabled();</a>
<a name="ln1209">}</a>
<a name="ln1210"> </a>
<a name="ln1211"> </a>
<a name="ln1212">void</a>
<a name="ln1213">BAbstractSpinner::SetDecrementEnabled(bool enable)</a>
<a name="ln1214">{</a>
<a name="ln1215">	if (IsDecrementEnabled() == enable)</a>
<a name="ln1216">		return;</a>
<a name="ln1217"> </a>
<a name="ln1218">	fDecrement-&gt;SetEnabled(enable);</a>
<a name="ln1219">	fDecrement-&gt;Invalidate();</a>
<a name="ln1220">}</a>
<a name="ln1221"> </a>
<a name="ln1222"> </a>
<a name="ln1223">bool</a>
<a name="ln1224">BAbstractSpinner::IsIncrementEnabled() const</a>
<a name="ln1225">{</a>
<a name="ln1226">	return fIncrement-&gt;IsEnabled();</a>
<a name="ln1227">}</a>
<a name="ln1228"> </a>
<a name="ln1229"> </a>
<a name="ln1230">void</a>
<a name="ln1231">BAbstractSpinner::SetIncrementEnabled(bool enable)</a>
<a name="ln1232">{</a>
<a name="ln1233">	if (IsIncrementEnabled() == enable)</a>
<a name="ln1234">		return;</a>
<a name="ln1235"> </a>
<a name="ln1236">	fIncrement-&gt;SetEnabled(enable);</a>
<a name="ln1237">	fIncrement-&gt;Invalidate();</a>
<a name="ln1238">}</a>
<a name="ln1239"> </a>
<a name="ln1240"> </a>
<a name="ln1241">BSize</a>
<a name="ln1242">BAbstractSpinner::MinSize()</a>
<a name="ln1243">{</a>
<a name="ln1244">	_ValidateLayoutData();</a>
<a name="ln1245">	return BLayoutUtils::ComposeSize(ExplicitMinSize(), fLayoutData-&gt;min);</a>
<a name="ln1246">}</a>
<a name="ln1247"> </a>
<a name="ln1248"> </a>
<a name="ln1249">BSize</a>
<a name="ln1250">BAbstractSpinner::MaxSize()</a>
<a name="ln1251">{</a>
<a name="ln1252">	_ValidateLayoutData();</a>
<a name="ln1253"> </a>
<a name="ln1254">	BSize max = fLayoutData-&gt;min;</a>
<a name="ln1255">	max.width = B_SIZE_UNLIMITED;</a>
<a name="ln1256"> </a>
<a name="ln1257">	return BLayoutUtils::ComposeSize(ExplicitMaxSize(), max);</a>
<a name="ln1258">}</a>
<a name="ln1259"> </a>
<a name="ln1260"> </a>
<a name="ln1261">BSize</a>
<a name="ln1262">BAbstractSpinner::PreferredSize()</a>
<a name="ln1263">{</a>
<a name="ln1264">	_ValidateLayoutData();</a>
<a name="ln1265">	return BLayoutUtils::ComposeSize(ExplicitPreferredSize(),</a>
<a name="ln1266">		fLayoutData-&gt;min);</a>
<a name="ln1267">}</a>
<a name="ln1268"> </a>
<a name="ln1269"> </a>
<a name="ln1270">BAlignment</a>
<a name="ln1271">BAbstractSpinner::LayoutAlignment()</a>
<a name="ln1272">{</a>
<a name="ln1273">	_ValidateLayoutData();</a>
<a name="ln1274">	return BLayoutUtils::ComposeAlignment(ExplicitAlignment(),</a>
<a name="ln1275">		BAlignment(B_ALIGN_LEFT, B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln1276">}</a>
<a name="ln1277"> </a>
<a name="ln1278"> </a>
<a name="ln1279">BLayoutItem*</a>
<a name="ln1280">BAbstractSpinner::CreateLabelLayoutItem()</a>
<a name="ln1281">{</a>
<a name="ln1282">	if (fLayoutData-&gt;label_layout_item == NULL)</a>
<a name="ln1283">		fLayoutData-&gt;label_layout_item = new LabelLayoutItem(this);</a>
<a name="ln1284"> </a>
<a name="ln1285">	return fLayoutData-&gt;label_layout_item;</a>
<a name="ln1286">}</a>
<a name="ln1287"> </a>
<a name="ln1288"> </a>
<a name="ln1289">BLayoutItem*</a>
<a name="ln1290">BAbstractSpinner::CreateTextViewLayoutItem()</a>
<a name="ln1291">{</a>
<a name="ln1292">	if (fLayoutData-&gt;text_view_layout_item == NULL)</a>
<a name="ln1293">		fLayoutData-&gt;text_view_layout_item = new TextViewLayoutItem(this);</a>
<a name="ln1294"> </a>
<a name="ln1295">	return fLayoutData-&gt;text_view_layout_item;</a>
<a name="ln1296">}</a>
<a name="ln1297"> </a>
<a name="ln1298"> </a>
<a name="ln1299">BTextView*</a>
<a name="ln1300">BAbstractSpinner::TextView() const</a>
<a name="ln1301">{</a>
<a name="ln1302">	return dynamic_cast&lt;BTextView*&gt;(fTextView);</a>
<a name="ln1303">}</a>
<a name="ln1304"> </a>
<a name="ln1305"> </a>
<a name="ln1306">//	#pragma mark - BAbstractSpinner protected methods</a>
<a name="ln1307"> </a>
<a name="ln1308"> </a>
<a name="ln1309">status_t</a>
<a name="ln1310">BAbstractSpinner::AllArchived(BMessage* into) const</a>
<a name="ln1311">{</a>
<a name="ln1312">	status_t result;</a>
<a name="ln1313">	if ((result = BControl::AllArchived(into)) != B_OK)</a>
<a name="ln1314">		return result;</a>
<a name="ln1315"> </a>
<a name="ln1316">	BArchiver archiver(into);</a>
<a name="ln1317"> </a>
<a name="ln1318">	BArchivable* textViewItem = fLayoutData-&gt;text_view_layout_item;</a>
<a name="ln1319">	if (archiver.IsArchived(textViewItem))</a>
<a name="ln1320">		result = archiver.AddArchivable(kTextViewItemField, textViewItem);</a>
<a name="ln1321"> </a>
<a name="ln1322">	if (result != B_OK)</a>
<a name="ln1323">		return result;</a>
<a name="ln1324"> </a>
<a name="ln1325">	BArchivable* labelBarItem = fLayoutData-&gt;label_layout_item;</a>
<a name="ln1326">	if (archiver.IsArchived(labelBarItem))</a>
<a name="ln1327">		result = archiver.AddArchivable(kLabelItemField, labelBarItem);</a>
<a name="ln1328"> </a>
<a name="ln1329">	return result;</a>
<a name="ln1330">}</a>
<a name="ln1331"> </a>
<a name="ln1332"> </a>
<a name="ln1333">status_t</a>
<a name="ln1334">BAbstractSpinner::AllUnarchived(const BMessage* from)</a>
<a name="ln1335">{</a>
<a name="ln1336">	BUnarchiver unarchiver(from);</a>
<a name="ln1337"> </a>
<a name="ln1338">	status_t result = B_OK;</a>
<a name="ln1339">	if ((result = BControl::AllUnarchived(from)) != B_OK)</a>
<a name="ln1340">		return result;</a>
<a name="ln1341"> </a>
<a name="ln1342">	if (unarchiver.IsInstantiated(kTextViewItemField)) {</a>
<a name="ln1343">		TextViewLayoutItem*&amp; textViewItem</a>
<a name="ln1344">			= fLayoutData-&gt;text_view_layout_item;</a>
<a name="ln1345">		result = unarchiver.FindObject(kTextViewItemField,</a>
<a name="ln1346">			BUnarchiver::B_DONT_ASSUME_OWNERSHIP, textViewItem);</a>
<a name="ln1347"> </a>
<a name="ln1348">		if (result == B_OK)</a>
<a name="ln1349">			textViewItem-&gt;SetParent(this);</a>
<a name="ln1350">		else</a>
<a name="ln1351">			return result;</a>
<a name="ln1352">	}</a>
<a name="ln1353"> </a>
<a name="ln1354">	if (unarchiver.IsInstantiated(kLabelItemField)) {</a>
<a name="ln1355">		LabelLayoutItem*&amp; labelItem = fLayoutData-&gt;label_layout_item;</a>
<a name="ln1356">		result = unarchiver.FindObject(kLabelItemField,</a>
<a name="ln1357">			BUnarchiver::B_DONT_ASSUME_OWNERSHIP, labelItem);</a>
<a name="ln1358"> </a>
<a name="ln1359">		if (result == B_OK)</a>
<a name="ln1360">			labelItem-&gt;SetParent(this);</a>
<a name="ln1361">	}</a>
<a name="ln1362"> </a>
<a name="ln1363">	return result;</a>
<a name="ln1364">}</a>
<a name="ln1365"> </a>
<a name="ln1366"> </a>
<a name="ln1367">void</a>
<a name="ln1368">BAbstractSpinner::DoLayout()</a>
<a name="ln1369">{</a>
<a name="ln1370">	if ((Flags() &amp; B_SUPPORTS_LAYOUT) == 0)</a>
<a name="ln1371">		return;</a>
<a name="ln1372"> </a>
<a name="ln1373">	if (GetLayout()) {</a>
<a name="ln1374">		BControl::DoLayout();</a>
<a name="ln1375">		return;</a>
<a name="ln1376">	}</a>
<a name="ln1377"> </a>
<a name="ln1378">	_ValidateLayoutData();</a>
<a name="ln1379"> </a>
<a name="ln1380">	BSize size(Bounds().Size());</a>
<a name="ln1381">	if (size.width &lt; fLayoutData-&gt;min.width)</a>
<a name="ln1382">		size.width = fLayoutData-&gt;min.width;</a>
<a name="ln1383"> </a>
<a name="ln1384">	if (size.height &lt; fLayoutData-&gt;min.height)</a>
<a name="ln1385">		size.height = fLayoutData-&gt;min.height;</a>
<a name="ln1386"> </a>
<a name="ln1387">	float divider = 0;</a>
<a name="ln1388">	if (fLayoutData-&gt;label_layout_item != NULL</a>
<a name="ln1389">		&amp;&amp; fLayoutData-&gt;text_view_layout_item != NULL</a>
<a name="ln1390">		&amp;&amp; fLayoutData-&gt;label_layout_item-&gt;Frame().IsValid()</a>
<a name="ln1391">		&amp;&amp; fLayoutData-&gt;text_view_layout_item-&gt;Frame().IsValid()) {</a>
<a name="ln1392">		divider = fLayoutData-&gt;text_view_layout_item-&gt;Frame().left</a>
<a name="ln1393">			- fLayoutData-&gt;label_layout_item-&gt;Frame().left;</a>
<a name="ln1394">	} else if (fLayoutData-&gt;label_width &gt; 0) {</a>
<a name="ln1395">		divider = fLayoutData-&gt;label_width</a>
<a name="ln1396">			+ be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln1397">	}</a>
<a name="ln1398">	fDivider = divider;</a>
<a name="ln1399"> </a>
<a name="ln1400">	BRect dirty(fTextView-&gt;Frame());</a>
<a name="ln1401">	_LayoutTextView();</a>
<a name="ln1402"> </a>
<a name="ln1403">	// invalidate dirty region</a>
<a name="ln1404">	dirty = dirty | fTextView-&gt;Frame();</a>
<a name="ln1405">	dirty = dirty | fIncrement-&gt;Frame();</a>
<a name="ln1406">	dirty = dirty | fDecrement-&gt;Frame();</a>
<a name="ln1407"> </a>
<a name="ln1408">	Invalidate(dirty);</a>
<a name="ln1409">}</a>
<a name="ln1410"> </a>
<a name="ln1411"> </a>
<a name="ln1412">void</a>
<a name="ln1413">BAbstractSpinner::LayoutInvalidated(bool descendants)</a>
<a name="ln1414">{</a>
<a name="ln1415">	if (fLayoutData != NULL)</a>
<a name="ln1416">		fLayoutData-&gt;valid = false;</a>
<a name="ln1417">}</a>
<a name="ln1418"> </a>
<a name="ln1419"> </a>
<a name="ln1420">//	#pragma mark - BAbstractSpinner private methods</a>
<a name="ln1421"> </a>
<a name="ln1422"> </a>
<a name="ln1423">void</a>
<a name="ln1424">BAbstractSpinner::_DrawLabel(BRect updateRect)</a>
<a name="ln1425">{</a>
<a name="ln1426">	BRect rect(Bounds());</a>
<a name="ln1427">	rect.right = fDivider;</a>
<a name="ln1428">	if (!rect.IsValid() || !rect.Intersects(updateRect))</a>
<a name="ln1429">		return;</a>
<a name="ln1430"> </a>
<a name="ln1431">	_ValidateLayoutData();</a>
<a name="ln1432"> </a>
<a name="ln1433">	const char* label = Label();</a>
<a name="ln1434">	if (label == NULL)</a>
<a name="ln1435">		return;</a>
<a name="ln1436"> </a>
<a name="ln1437">	// horizontal position</a>
<a name="ln1438">	float x;</a>
<a name="ln1439">	switch (fAlignment) {</a>
<a name="ln1440">		case B_ALIGN_RIGHT:</a>
<a name="ln1441">			x = fDivider - fLayoutData-&gt;label_width - 3.0f;</a>
<a name="ln1442">			break;</a>
<a name="ln1443"> </a>
<a name="ln1444">		case B_ALIGN_CENTER:</a>
<a name="ln1445">			x = fDivider - roundf(fLayoutData-&gt;label_width / 2.0f);</a>
<a name="ln1446">			break;</a>
<a name="ln1447"> </a>
<a name="ln1448">		default:</a>
<a name="ln1449">			x = 0.0f;</a>
<a name="ln1450">			break;</a>
<a name="ln1451">	}</a>
<a name="ln1452"> </a>
<a name="ln1453">	// vertical position</a>
<a name="ln1454">	font_height&amp; fontHeight = fLayoutData-&gt;font_info;</a>
<a name="ln1455">	float y = rect.top</a>
<a name="ln1456">		+ roundf((rect.Height() + 1.0f - fontHeight.ascent</a>
<a name="ln1457">			- fontHeight.descent) / 2.0f)</a>
<a name="ln1458">		+ fontHeight.ascent;</a>
<a name="ln1459"> </a>
<a name="ln1460">	uint32 flags = be_control_look-&gt;Flags(this);</a>
<a name="ln1461"> </a>
<a name="ln1462">	// erase the is control flag before drawing the label so that the label</a>
<a name="ln1463">	// will get drawn using B_PANEL_TEXT_COLOR.</a>
<a name="ln1464">	flags &amp;= ~BControlLook::B_IS_CONTROL;</a>
<a name="ln1465"> </a>
<a name="ln1466">	be_control_look-&gt;DrawLabel(this, label, LowColor(), flags, BPoint(x, y));</a>
<a name="ln1467">}</a>
<a name="ln1468"> </a>
<a name="ln1469"> </a>
<a name="ln1470">void</a>
<a name="ln1471">BAbstractSpinner::_DrawTextView(BRect updateRect)</a>
<a name="ln1472">{</a>
<a name="ln1473">	BRect rect = fTextView-&gt;Frame();</a>
<a name="ln1474">	rect.InsetBy(-kFrameMargin, -kFrameMargin);</a>
<a name="ln1475">	if (!rect.IsValid() || !rect.Intersects(updateRect))</a>
<a name="ln1476">		return;</a>
<a name="ln1477"> </a>
<a name="ln1478">	rgb_color base = ui_color(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln1479">	uint32 flags = 0;</a>
<a name="ln1480">	if (!IsEnabled())</a>
<a name="ln1481">		flags |= BControlLook::B_DISABLED;</a>
<a name="ln1482"> </a>
<a name="ln1483">	if (fTextView-&gt;IsFocus() &amp;&amp; Window()-&gt;IsActive())</a>
<a name="ln1484">		flags |= BControlLook::B_FOCUSED;</a>
<a name="ln1485"> </a>
<a name="ln1486">	be_control_look-&gt;DrawTextControlBorder(this, rect, updateRect, base,</a>
<a name="ln1487">		flags);</a>
<a name="ln1488">}</a>
<a name="ln1489"> </a>
<a name="ln1490"> </a>
<a name="ln1491">void</a>
<a name="ln1492">BAbstractSpinner::_InitObject()</a>
<a name="ln1493">{</a>
<a name="ln1494">	fAlignment = B_ALIGN_LEFT;</a>
<a name="ln1495">	fButtonStyle = SPINNER_BUTTON_PLUS_MINUS;</a>
<a name="ln1496"> </a>
<a name="ln1497">	if (Label() != NULL) {</a>
<a name="ln1498">		fDivider = StringWidth(Label())</a>
<a name="ln1499">			+ be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln1500">	} else</a>
<a name="ln1501">		fDivider = 0.0f;</a>
<a name="ln1502"> </a>
<a name="ln1503">	BControl::SetEnabled(true);</a>
<a name="ln1504">	BControl::SetValue(0);</a>
<a name="ln1505"> </a>
<a name="ln1506">	BRect rect(Bounds());</a>
<a name="ln1507">	fLayoutData = new LayoutData(rect.Width(), rect.Height());</a>
<a name="ln1508"> </a>
<a name="ln1509">	rect.left = fDivider;</a>
<a name="ln1510">	rect.InsetBy(kFrameMargin, kFrameMargin);</a>
<a name="ln1511">	rect.right -= rect.Height() * 2 + kFrameMargin * 2 + 1.0f;</a>
<a name="ln1512">	BRect textRect(rect.OffsetToCopy(B_ORIGIN));</a>
<a name="ln1513"> </a>
<a name="ln1514">	fTextView = new SpinnerTextView(rect, textRect);</a>
<a name="ln1515">	AddChild(fTextView);</a>
<a name="ln1516"> </a>
<a name="ln1517">	rect.InsetBy(0.0f, -kFrameMargin);</a>
<a name="ln1518"> </a>
<a name="ln1519">	rect.left = rect.right + kFrameMargin * 2;</a>
<a name="ln1520">	rect.right = rect.left + rect.Height() - kFrameMargin * 2;</a>
<a name="ln1521"> </a>
<a name="ln1522">	fDecrement = new SpinnerButton(rect, &quot;decrement&quot;, SPINNER_DECREMENT);</a>
<a name="ln1523">	AddChild(fDecrement);</a>
<a name="ln1524"> </a>
<a name="ln1525">	rect.left = rect.right + 1.0f;</a>
<a name="ln1526">	rect.right = rect.left + rect.Height() - kFrameMargin * 2;</a>
<a name="ln1527"> </a>
<a name="ln1528">	fIncrement = new SpinnerButton(rect, &quot;increment&quot;, SPINNER_INCREMENT);</a>
<a name="ln1529">	AddChild(fIncrement);</a>
<a name="ln1530"> </a>
<a name="ln1531">	uint32 navigableFlags = Flags() &amp; B_NAVIGABLE;</a>
<a name="ln1532">	if (navigableFlags != 0)</a>
<a name="ln1533">		BControl::SetFlags(Flags() &amp; ~B_NAVIGABLE);</a>
<a name="ln1534">}</a>
<a name="ln1535"> </a>
<a name="ln1536"> </a>
<a name="ln1537">void</a>
<a name="ln1538">BAbstractSpinner::_LayoutTextView()</a>
<a name="ln1539">{</a>
<a name="ln1540">	BRect rect;</a>
<a name="ln1541">	if (fLayoutData-&gt;text_view_layout_item != NULL) {</a>
<a name="ln1542">		rect = fLayoutData-&gt;text_view_layout_item-&gt;FrameInParent();</a>
<a name="ln1543">	} else {</a>
<a name="ln1544">		rect = Bounds();</a>
<a name="ln1545">		rect.left = fDivider;</a>
<a name="ln1546">	}</a>
<a name="ln1547">	rect.InsetBy(kFrameMargin, kFrameMargin);</a>
<a name="ln1548">	rect.right -= rect.Height() * 2 + kFrameMargin * 2 + 1.0f;</a>
<a name="ln1549"> </a>
<a name="ln1550">	fTextView-&gt;MoveTo(rect.left, rect.top);</a>
<a name="ln1551">	fTextView-&gt;ResizeTo(rect.Width(), rect.Height());</a>
<a name="ln1552">	fTextView-&gt;SetTextRect(rect.OffsetToCopy(B_ORIGIN));</a>
<a name="ln1553"> </a>
<a name="ln1554">	rect.InsetBy(0.0f, -kFrameMargin);</a>
<a name="ln1555"> </a>
<a name="ln1556">	rect.left = rect.right + kFrameMargin * 2;</a>
<a name="ln1557">	rect.right = rect.left + rect.Height() - kFrameMargin * 2;</a>
<a name="ln1558"> </a>
<a name="ln1559">	fDecrement-&gt;ResizeTo(rect.Width(), rect.Height());</a>
<a name="ln1560">	fDecrement-&gt;MoveTo(rect.LeftTop());</a>
<a name="ln1561"> </a>
<a name="ln1562">	rect.left = rect.right + 1.0f;</a>
<a name="ln1563">	rect.right = rect.left + rect.Height() - kFrameMargin * 2;</a>
<a name="ln1564"> </a>
<a name="ln1565">	fIncrement-&gt;ResizeTo(rect.Width(), rect.Height());</a>
<a name="ln1566">	fIncrement-&gt;MoveTo(rect.LeftTop());</a>
<a name="ln1567">}</a>
<a name="ln1568"> </a>
<a name="ln1569"> </a>
<a name="ln1570">void</a>
<a name="ln1571">BAbstractSpinner::_UpdateFrame()</a>
<a name="ln1572">{</a>
<a name="ln1573">	if (fLayoutData-&gt;label_layout_item == NULL</a>
<a name="ln1574">		|| fLayoutData-&gt;text_view_layout_item == NULL) {</a>
<a name="ln1575">		return;</a>
<a name="ln1576">	}</a>
<a name="ln1577"> </a>
<a name="ln1578">	BRect labelFrame = fLayoutData-&gt;label_layout_item-&gt;Frame();</a>
<a name="ln1579">	BRect textViewFrame = fLayoutData-&gt;text_view_layout_item-&gt;Frame();</a>
<a name="ln1580"> </a>
<a name="ln1581">	if (!labelFrame.IsValid() || !textViewFrame.IsValid())</a>
<a name="ln1582">		return;</a>
<a name="ln1583"> </a>
<a name="ln1584">	// update divider</a>
<a name="ln1585">	fDivider = textViewFrame.left - labelFrame.left;</a>
<a name="ln1586"> </a>
<a name="ln1587">	BRect frame = textViewFrame | labelFrame;</a>
<a name="ln1588">	MoveTo(frame.left, frame.top);</a>
<a name="ln1589">	BSize oldSize = Bounds().Size();</a>
<a name="ln1590">	ResizeTo(frame.Width(), frame.Height());</a>
<a name="ln1591">	BSize newSize = Bounds().Size();</a>
<a name="ln1592"> </a>
<a name="ln1593">	// If the size changes, ResizeTo() will trigger a relayout, otherwise</a>
<a name="ln1594">	// we need to do that explicitly.</a>
<a name="ln1595">	if (newSize != oldSize)</a>
<a name="ln1596">		Relayout();</a>
<a name="ln1597">}</a>
<a name="ln1598"> </a>
<a name="ln1599"> </a>
<a name="ln1600">void</a>
<a name="ln1601">BAbstractSpinner::_UpdateTextViewColors(bool enable)</a>
<a name="ln1602">{</a>
<a name="ln1603">	// Mimick BTextControl's appearance.</a>
<a name="ln1604">	rgb_color textColor = ui_color(B_DOCUMENT_TEXT_COLOR);</a>
<a name="ln1605"> </a>
<a name="ln1606">	if (enable) {</a>
<a name="ln1607">		fTextView-&gt;SetViewUIColor(B_DOCUMENT_BACKGROUND_COLOR);</a>
<a name="ln1608">		fTextView-&gt;SetLowUIColor(ViewUIColor());</a>
<a name="ln1609">	} else {</a>
<a name="ln1610">		rgb_color color = ui_color(B_DOCUMENT_BACKGROUND_COLOR);</a>
<a name="ln1611">		color = disable_color(ViewColor(), color);</a>
<a name="ln1612">		textColor = disable_color(textColor, ViewColor());</a>
<a name="ln1613"> </a>
<a name="ln1614">		fTextView-&gt;SetViewColor(color);</a>
<a name="ln1615">		fTextView-&gt;SetLowColor(color);</a>
<a name="ln1616">	}</a>
<a name="ln1617"> </a>
<a name="ln1618">	BFont font;</a>
<a name="ln1619">	fTextView-&gt;GetFontAndColor(0, &amp;font);</a>
<a name="ln1620">	fTextView-&gt;SetFontAndColor(&amp;font, B_FONT_ALL, &amp;textColor);</a>
<a name="ln1621">}</a>
<a name="ln1622"> </a>
<a name="ln1623"> </a>
<a name="ln1624">void</a>
<a name="ln1625">BAbstractSpinner::_ValidateLayoutData()</a>
<a name="ln1626">{</a>
<a name="ln1627">	if (fLayoutData-&gt;valid)</a>
<a name="ln1628">		return;</a>
<a name="ln1629"> </a>
<a name="ln1630">	font_height&amp; fontHeight = fLayoutData-&gt;font_info;</a>
<a name="ln1631">	GetFontHeight(&amp;fontHeight);</a>
<a name="ln1632"> </a>
<a name="ln1633">	if (Label() != NULL) {</a>
<a name="ln1634">		fLayoutData-&gt;label_width = StringWidth(Label());</a>
<a name="ln1635">		fLayoutData-&gt;label_height = ceilf(fontHeight.ascent</a>
<a name="ln1636">			+ fontHeight.descent + fontHeight.leading);</a>
<a name="ln1637">	} else {</a>
<a name="ln1638">		fLayoutData-&gt;label_width = 0;</a>
<a name="ln1639">		fLayoutData-&gt;label_height = 0;</a>
<a name="ln1640">	}</a>
<a name="ln1641"> </a>
<a name="ln1642">	float divider = 0;</a>
<a name="ln1643">	if (fLayoutData-&gt;label_width &gt; 0) {</a>
<a name="ln1644">		divider = ceilf(fLayoutData-&gt;label_width</a>
<a name="ln1645">			+ be_control_look-&gt;DefaultLabelSpacing());</a>
<a name="ln1646">	}</a>
<a name="ln1647"> </a>
<a name="ln1648">	if ((Flags() &amp; B_SUPPORTS_LAYOUT) == 0)</a>
<a name="ln1649">		divider = std::max(divider, fDivider);</a>
<a name="ln1650"> </a>
<a name="ln1651">	float minTextWidth = fTextView-&gt;StringWidth(&quot;99999&quot;);</a>
<a name="ln1652"> </a>
<a name="ln1653">	float textViewHeight = fTextView-&gt;LineHeight(0) + kFrameMargin * 2;</a>
<a name="ln1654">	float textViewWidth = minTextWidth + textViewHeight * 2;</a>
<a name="ln1655"> </a>
<a name="ln1656">	fLayoutData-&gt;text_view_width = textViewWidth;</a>
<a name="ln1657">	fLayoutData-&gt;text_view_height = textViewHeight;</a>
<a name="ln1658"> </a>
<a name="ln1659">	BSize min(textViewWidth, textViewHeight);</a>
<a name="ln1660">	if (divider &gt; 0.0f)</a>
<a name="ln1661">		min.width += divider;</a>
<a name="ln1662"> </a>
<a name="ln1663">	if (fLayoutData-&gt;label_height &gt; min.height)</a>
<a name="ln1664">		min.height = fLayoutData-&gt;label_height;</a>
<a name="ln1665"> </a>
<a name="ln1666">	fLayoutData-&gt;min = min;</a>
<a name="ln1667">	fLayoutData-&gt;valid = true;</a>
<a name="ln1668"> </a>
<a name="ln1669">	ResetLayoutInvalidation();</a>
<a name="ln1670">}</a>
<a name="ln1671"> </a>
<a name="ln1672"> </a>
<a name="ln1673">// FBC padding</a>
<a name="ln1674"> </a>
<a name="ln1675">void BAbstractSpinner::_ReservedAbstractSpinner20() {}</a>
<a name="ln1676">void BAbstractSpinner::_ReservedAbstractSpinner19() {}</a>
<a name="ln1677">void BAbstractSpinner::_ReservedAbstractSpinner18() {}</a>
<a name="ln1678">void BAbstractSpinner::_ReservedAbstractSpinner17() {}</a>
<a name="ln1679">void BAbstractSpinner::_ReservedAbstractSpinner16() {}</a>
<a name="ln1680">void BAbstractSpinner::_ReservedAbstractSpinner15() {}</a>
<a name="ln1681">void BAbstractSpinner::_ReservedAbstractSpinner14() {}</a>
<a name="ln1682">void BAbstractSpinner::_ReservedAbstractSpinner13() {}</a>
<a name="ln1683">void BAbstractSpinner::_ReservedAbstractSpinner12() {}</a>
<a name="ln1684">void BAbstractSpinner::_ReservedAbstractSpinner11() {}</a>
<a name="ln1685">void BAbstractSpinner::_ReservedAbstractSpinner10() {}</a>
<a name="ln1686">void BAbstractSpinner::_ReservedAbstractSpinner9() {}</a>
<a name="ln1687">void BAbstractSpinner::_ReservedAbstractSpinner8() {}</a>
<a name="ln1688">void BAbstractSpinner::_ReservedAbstractSpinner7() {}</a>
<a name="ln1689">void BAbstractSpinner::_ReservedAbstractSpinner6() {}</a>
<a name="ln1690">void BAbstractSpinner::_ReservedAbstractSpinner5() {}</a>
<a name="ln1691">void BAbstractSpinner::_ReservedAbstractSpinner4() {}</a>
<a name="ln1692">void BAbstractSpinner::_ReservedAbstractSpinner3() {}</a>
<a name="ln1693">void BAbstractSpinner::_ReservedAbstractSpinner2() {}</a>
<a name="ln1694">void BAbstractSpinner::_ReservedAbstractSpinner1() {}</a>

</code></pre>
<div class="balloon" rel="266"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: font_info.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
