
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>RequestBuilder.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2012 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Pawe≈Ç Dziepak, pdziepak@quarnos.org</a>
<a name="ln7"> */</a>
<a name="ln8"> </a>
<a name="ln9"> </a>
<a name="ln10">#include &quot;RequestBuilder.h&quot;</a>
<a name="ln11"> </a>
<a name="ln12">#include &lt;errno.h&gt;</a>
<a name="ln13">#include &lt;string.h&gt;</a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;util/Random.h&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#include &quot;Cookie.h&quot;</a>
<a name="ln18">#include &quot;OpenState.h&quot;</a>
<a name="ln19">#include &quot;RPCCallback.h&quot;</a>
<a name="ln20">#include &quot;RPCCallbackServer.h&quot;</a>
<a name="ln21"> </a>
<a name="ln22"> </a>
<a name="ln23">RequestBuilder::RequestBuilder(Procedure proc)</a>
<a name="ln24">	:</a>
<a name="ln25">	fOpCount(0),</a>
<a name="ln26">	fProcedure(proc),</a>
<a name="ln27">	fRequest(NULL)</a>
<a name="ln28">{</a>
<a name="ln29">	_InitHeader();</a>
<a name="ln30">}</a>
<a name="ln31"> </a>
<a name="ln32"> </a>
<a name="ln33">RequestBuilder::~RequestBuilder()</a>
<a name="ln34">{</a>
<a name="ln35">	delete fRequest;</a>
<a name="ln36">}</a>
<a name="ln37"> </a>
<a name="ln38"> </a>
<a name="ln39">void</a>
<a name="ln40">RequestBuilder::_InitHeader()</a>
<a name="ln41">{</a>
<a name="ln42">	fRequest = RPC::Call::Create(fProcedure, RPC::Auth::CreateSys(),</a>
<a name="ln43">		RPC::Auth::CreateNone());</a>
<a name="ln44"> </a>
<a name="ln45">	if (fRequest == NULL)</a>
<a name="ln46">		return;</a>
<a name="ln47"> </a>
<a name="ln48">	if (fProcedure == ProcCompound) {</a>
<a name="ln49">		fRequest-&gt;Stream().AddOpaque(NULL, 0);</a>
<a name="ln50">		fRequest-&gt;Stream().AddUInt(0);</a>
<a name="ln51"> </a>
<a name="ln52">		fOpCountPosition = fRequest-&gt;Stream().Current();</a>
<a name="ln53">		fRequest-&gt;Stream().AddUInt(0);</a>
<a name="ln54">	}</a>
<a name="ln55">}</a>
<a name="ln56"> </a>
<a name="ln57"> </a>
<a name="ln58">status_t</a>
<a name="ln59">RequestBuilder::Access()</a>
<a name="ln60">{</a>
<a name="ln61">	if (fProcedure != ProcCompound)</a>
<a name="ln62">		return B_BAD_VALUE;</a>
<a name="ln63">	if (fRequest == NULL)</a>
<a name="ln64">		return B_NO_MEMORY;</a>
<a name="ln65"> </a>
<a name="ln66">	fRequest-&gt;Stream().AddUInt(OpAccess);</a>
<a name="ln67">	fRequest-&gt;Stream().AddUInt(ACCESS4_READ | ACCESS4_LOOKUP | ACCESS4_MODIFY</a>
<a name="ln68">		| ACCESS4_EXTEND | ACCESS4_DELETE | ACCESS4_EXECUTE);</a>
<a name="ln69">	fOpCount++;</a>
<a name="ln70"> </a>
<a name="ln71">	return B_OK;</a>
<a name="ln72">}</a>
<a name="ln73"> </a>
<a name="ln74"> </a>
<a name="ln75">status_t</a>
<a name="ln76">RequestBuilder::Close(uint32 seq, const uint32* id, uint32 stateSeq)</a>
<a name="ln77">{</a>
<a name="ln78">	if (fProcedure != ProcCompound)</a>
<a name="ln79">		return B_BAD_VALUE;</a>
<a name="ln80">	if (fRequest == NULL)</a>
<a name="ln81">		return B_NO_MEMORY;</a>
<a name="ln82"> </a>
<a name="ln83">	fRequest-&gt;Stream().AddUInt(OpClose);</a>
<a name="ln84">	fRequest-&gt;Stream().AddUInt(seq);</a>
<a name="ln85">	fRequest-&gt;Stream().AddUInt(stateSeq);</a>
<a name="ln86">	fRequest-&gt;Stream().AddUInt(id[0]);</a>
<a name="ln87">	fRequest-&gt;Stream().AddUInt(id[1]);</a>
<a name="ln88">	fRequest-&gt;Stream().AddUInt(id[2]);</a>
<a name="ln89"> </a>
<a name="ln90">	fOpCount++;</a>
<a name="ln91"> </a>
<a name="ln92">	return B_OK;</a>
<a name="ln93">}</a>
<a name="ln94"> </a>
<a name="ln95"> </a>
<a name="ln96">status_t</a>
<a name="ln97">RequestBuilder::Commit(uint64 offset, uint32 count)</a>
<a name="ln98">{</a>
<a name="ln99">	if (fProcedure != ProcCompound)</a>
<a name="ln100">		return B_BAD_VALUE;</a>
<a name="ln101">	if (fRequest == NULL)</a>
<a name="ln102">		return B_NO_MEMORY;</a>
<a name="ln103"> </a>
<a name="ln104">	fRequest-&gt;Stream().AddUInt(OpCommit);</a>
<a name="ln105">	fRequest-&gt;Stream().AddUHyper(offset);</a>
<a name="ln106">	fRequest-&gt;Stream().AddUInt(count);</a>
<a name="ln107"> </a>
<a name="ln108">	fOpCount++;</a>
<a name="ln109"> </a>
<a name="ln110">	return B_OK;</a>
<a name="ln111">}</a>
<a name="ln112"> </a>
<a name="ln113"> </a>
<a name="ln114">status_t</a>
<a name="ln115">RequestBuilder::Create(FileType type, const char* name, AttrValue* attr,</a>
<a name="ln116">	uint32 count, const char* path)</a>
<a name="ln117">{</a>
<a name="ln118">	if (fProcedure != ProcCompound)</a>
<a name="ln119">		return B_BAD_VALUE;</a>
<a name="ln120">	if (fRequest == NULL)</a>
<a name="ln121">		return B_NO_MEMORY;</a>
<a name="ln122">	if (type == NF4LNK &amp;&amp; path == NULL)</a>
<a name="ln123">		return B_BAD_VALUE;</a>
<a name="ln124">	if (name == NULL)</a>
<a name="ln125">		return B_BAD_VALUE;</a>
<a name="ln126">	if (type == NF4BLK || type == NF4CHR)</a>
<a name="ln127">		return B_BAD_VALUE;</a>
<a name="ln128"> </a>
<a name="ln129">	fRequest-&gt;Stream().AddUInt(OpCreate);</a>
<a name="ln130">	fRequest-&gt;Stream().AddUInt(type);</a>
<a name="ln131">	if (type == NF4LNK)</a>
<a name="ln132">		fRequest-&gt;Stream().AddString(path);</a>
<a name="ln133">	fRequest-&gt;Stream().AddString(name);</a>
<a name="ln134">	_EncodeAttrs(fRequest-&gt;Stream(), attr, count);</a>
<a name="ln135"> </a>
<a name="ln136">	fOpCount++;</a>
<a name="ln137"> </a>
<a name="ln138">	return B_OK;</a>
<a name="ln139">}</a>
<a name="ln140"> </a>
<a name="ln141"> </a>
<a name="ln142">status_t</a>
<a name="ln143">RequestBuilder::DelegReturn(const uint32* id, uint32 seq)</a>
<a name="ln144">{</a>
<a name="ln145">	if (fProcedure != ProcCompound)</a>
<a name="ln146">		return B_BAD_VALUE;</a>
<a name="ln147">	if (fRequest == NULL)</a>
<a name="ln148">		return B_NO_MEMORY;</a>
<a name="ln149"> </a>
<a name="ln150">	fRequest-&gt;Stream().AddUInt(OpDelegReturn);</a>
<a name="ln151"> </a>
<a name="ln152">	fRequest-&gt;Stream().AddUInt(seq);</a>
<a name="ln153">	fRequest-&gt;Stream().AddUInt(id[0]);</a>
<a name="ln154">	fRequest-&gt;Stream().AddUInt(id[1]);</a>
<a name="ln155">	fRequest-&gt;Stream().AddUInt(id[2]);</a>
<a name="ln156"> </a>
<a name="ln157">	fOpCount++;</a>
<a name="ln158"> </a>
<a name="ln159">	return B_OK;</a>
<a name="ln160">}</a>
<a name="ln161"> </a>
<a name="ln162"> </a>
<a name="ln163">status_t</a>
<a name="ln164">RequestBuilder::GetAttr(Attribute* attrs, uint32 count)</a>
<a name="ln165">{</a>
<a name="ln166">	if (fProcedure != ProcCompound)</a>
<a name="ln167">		return B_BAD_VALUE;</a>
<a name="ln168">	if (fRequest == NULL)</a>
<a name="ln169">		return B_NO_MEMORY;</a>
<a name="ln170"> </a>
<a name="ln171">	fRequest-&gt;Stream().AddUInt(OpGetAttr);</a>
<a name="ln172">	_AttrBitmap(fRequest-&gt;Stream(), attrs, count);</a>
<a name="ln173"> </a>
<a name="ln174">	fOpCount++;</a>
<a name="ln175"> </a>
<a name="ln176">	return B_OK;</a>
<a name="ln177">}</a>
<a name="ln178"> </a>
<a name="ln179"> </a>
<a name="ln180">status_t</a>
<a name="ln181">RequestBuilder::GetFH()</a>
<a name="ln182">{</a>
<a name="ln183">	if (fProcedure != ProcCompound)</a>
<a name="ln184">		return B_BAD_VALUE;</a>
<a name="ln185">	if (fRequest == NULL)</a>
<a name="ln186">		return B_NO_MEMORY;</a>
<a name="ln187"> </a>
<a name="ln188">	fRequest-&gt;Stream().AddUInt(OpGetFH);</a>
<a name="ln189">	fOpCount++;</a>
<a name="ln190"> </a>
<a name="ln191">	return B_OK;</a>
<a name="ln192">}</a>
<a name="ln193"> </a>
<a name="ln194"> </a>
<a name="ln195">void</a>
<a name="ln196">RequestBuilder::_GenerateLockOwner(XDR::WriteStream&amp; stream,</a>
<a name="ln197">	OpenState* state, LockOwner* owner)</a>
<a name="ln198">{</a>
<a name="ln199">	stream.AddUHyper(state-&gt;fClientID);</a>
<a name="ln200"> </a>
<a name="ln201">	uint64 lockOwner[2];</a>
<a name="ln202">	lockOwner[0] = owner-&gt;fOwner;</a>
<a name="ln203">	lockOwner[1] = state-&gt;fInfo.fFileId;</a>
<a name="ln204">	stream.AddOpaque(lockOwner, sizeof(lockOwner));</a>
<a name="ln205">}</a>
<a name="ln206"> </a>
<a name="ln207"> </a>
<a name="ln208">status_t</a>
<a name="ln209">RequestBuilder::Lock(OpenState* state, LockInfo* lock, uint32* sequence,</a>
<a name="ln210">	bool reclaim)</a>
<a name="ln211">{</a>
<a name="ln212">	if (fProcedure != ProcCompound)</a>
<a name="ln213">		return B_BAD_VALUE;</a>
<a name="ln214">	if (fRequest == NULL)</a>
<a name="ln215">		return B_NO_MEMORY;</a>
<a name="ln216"> </a>
<a name="ln217">	fRequest-&gt;Stream().AddUInt(OpLock);</a>
<a name="ln218"> </a>
<a name="ln219">	fRequest-&gt;Stream().AddInt(lock-&gt;fType);</a>
<a name="ln220">	fRequest-&gt;Stream().AddBoolean(reclaim);</a>
<a name="ln221"> </a>
<a name="ln222">	fRequest-&gt;Stream().AddUHyper(lock-&gt;fStart);</a>
<a name="ln223">	fRequest-&gt;Stream().AddUHyper(lock-&gt;fLength);</a>
<a name="ln224"> </a>
<a name="ln225">	if (lock-&gt;fOwner-&gt;fStateId[0] == 0 &amp;&amp; lock-&gt;fOwner-&gt;fStateId[1] == 0</a>
<a name="ln226">		&amp;&amp; lock-&gt;fOwner-&gt;fStateId[2] == 0) {</a>
<a name="ln227"> </a>
<a name="ln228">		fRequest-&gt;Stream().AddBoolean(true);			// new lock owner</a>
<a name="ln229"> </a>
<a name="ln230">		// open seq stateid</a>
<a name="ln231">		fRequest-&gt;Stream().AddUInt(*sequence);</a>
<a name="ln232">		fRequest-&gt;Stream().AddUInt(state-&gt;fStateSeq);</a>
<a name="ln233">		fRequest-&gt;Stream().AddUInt(state-&gt;fStateID[0]);</a>
<a name="ln234">		fRequest-&gt;Stream().AddUInt(state-&gt;fStateID[1]);</a>
<a name="ln235">		fRequest-&gt;Stream().AddUInt(state-&gt;fStateID[2]);</a>
<a name="ln236"> </a>
<a name="ln237">		// lock seq owner</a>
<a name="ln238">		fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fSequence++);</a>
<a name="ln239">		_GenerateLockOwner(fRequest-&gt;Stream(), state, lock-&gt;fOwner);</a>
<a name="ln240"> </a>
<a name="ln241">	} else {</a>
<a name="ln242">		fRequest-&gt;Stream().AddBoolean(false);			// old lock owner</a>
<a name="ln243">		(*sequence)--;</a>
<a name="ln244"> </a>
<a name="ln245">		// lock stateid seq</a>
<a name="ln246">		fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateSeq);</a>
<a name="ln247">		fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateId[0]);</a>
<a name="ln248">		fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateId[1]);</a>
<a name="ln249">		fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateId[2]);</a>
<a name="ln250"> </a>
<a name="ln251">		fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fSequence++);</a>
<a name="ln252">	}</a>
<a name="ln253"> </a>
<a name="ln254">	fOpCount++;</a>
<a name="ln255"> </a>
<a name="ln256">	return B_OK;</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259"> </a>
<a name="ln260">status_t</a>
<a name="ln261">RequestBuilder::LockT(LockType type, uint64 pos, uint64 len,</a>
<a name="ln262">	OpenState* state)</a>
<a name="ln263">{</a>
<a name="ln264">	if (fProcedure != ProcCompound)</a>
<a name="ln265">		return B_BAD_VALUE;</a>
<a name="ln266">	if (fRequest == NULL)</a>
<a name="ln267">		return B_NO_MEMORY;</a>
<a name="ln268"> </a>
<a name="ln269">	fRequest-&gt;Stream().AddUInt(OpLockT);</a>
<a name="ln270"> </a>
<a name="ln271">	fRequest-&gt;Stream().AddInt(type);</a>
<a name="ln272"> </a>
<a name="ln273">	fRequest-&gt;Stream().AddUHyper(pos);</a>
<a name="ln274">	fRequest-&gt;Stream().AddUHyper(len);</a>
<a name="ln275"> </a>
<a name="ln276">	fRequest-&gt;Stream().AddUHyper(state-&gt;fClientID);</a>
<a name="ln277"> </a>
<a name="ln278">	uint32 owner = find_thread(NULL);</a>
<a name="ln279">	fRequest-&gt;Stream().AddOpaque(&amp;owner, sizeof(owner));</a>
<a name="ln280"> </a>
<a name="ln281">	fOpCount++;</a>
<a name="ln282"> </a>
<a name="ln283">	return B_OK;</a>
<a name="ln284">}</a>
<a name="ln285"> </a>
<a name="ln286"> </a>
<a name="ln287">status_t</a>
<a name="ln288">RequestBuilder::LockU(LockInfo* lock)</a>
<a name="ln289">{</a>
<a name="ln290">	if (fProcedure != ProcCompound)</a>
<a name="ln291">		return B_BAD_VALUE;</a>
<a name="ln292">	if (fRequest == NULL)</a>
<a name="ln293">		return B_NO_MEMORY;</a>
<a name="ln294"> </a>
<a name="ln295">	fRequest-&gt;Stream().AddUInt(OpLockU);</a>
<a name="ln296"> </a>
<a name="ln297">	fRequest-&gt;Stream().AddInt(lock-&gt;fType);</a>
<a name="ln298"> </a>
<a name="ln299">	fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fSequence++);</a>
<a name="ln300">	fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateSeq);</a>
<a name="ln301">	fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateId[0]);</a>
<a name="ln302">	fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateId[1]);</a>
<a name="ln303">	fRequest-&gt;Stream().AddUInt(lock-&gt;fOwner-&gt;fStateId[2]);</a>
<a name="ln304"> </a>
<a name="ln305">	fRequest-&gt;Stream().AddUHyper(lock-&gt;fStart);</a>
<a name="ln306">	fRequest-&gt;Stream().AddUHyper(lock-&gt;fLength);</a>
<a name="ln307"> </a>
<a name="ln308">	fOpCount++;</a>
<a name="ln309"> </a>
<a name="ln310">	return B_OK;</a>
<a name="ln311">}</a>
<a name="ln312"> </a>
<a name="ln313"> </a>
<a name="ln314">status_t</a>
<a name="ln315">RequestBuilder::Link(const char* name)</a>
<a name="ln316">{</a>
<a name="ln317">	if (fProcedure != ProcCompound)</a>
<a name="ln318">		return B_BAD_VALUE;</a>
<a name="ln319">	if (fRequest == NULL)</a>
<a name="ln320">		return B_NO_MEMORY;</a>
<a name="ln321">	if (name == NULL)</a>
<a name="ln322">		return B_BAD_VALUE;</a>
<a name="ln323"> </a>
<a name="ln324">	fRequest-&gt;Stream().AddUInt(OpLink);</a>
<a name="ln325">	fRequest-&gt;Stream().AddString(name);</a>
<a name="ln326">	fOpCount++;</a>
<a name="ln327"> </a>
<a name="ln328">	return B_OK;</a>
<a name="ln329">}</a>
<a name="ln330"> </a>
<a name="ln331"> </a>
<a name="ln332">status_t</a>
<a name="ln333">RequestBuilder::LookUp(const char* name)</a>
<a name="ln334">{</a>
<a name="ln335">	if (fProcedure != ProcCompound)</a>
<a name="ln336">		return B_BAD_VALUE;</a>
<a name="ln337">	if (fRequest == NULL)</a>
<a name="ln338">		return B_NO_MEMORY;</a>
<a name="ln339">	if (name == NULL)</a>
<a name="ln340">		return B_BAD_VALUE;</a>
<a name="ln341"> </a>
<a name="ln342">	fRequest-&gt;Stream().AddUInt(OpLookUp);</a>
<a name="ln343">	fRequest-&gt;Stream().AddString(name, strlen(name));</a>
<a name="ln344">	fOpCount++;</a>
<a name="ln345"> </a>
<a name="ln346">	return B_OK;</a>
<a name="ln347">}</a>
<a name="ln348"> </a>
<a name="ln349"> </a>
<a name="ln350">status_t</a>
<a name="ln351">RequestBuilder::LookUpUp()</a>
<a name="ln352">{</a>
<a name="ln353">	if (fProcedure != ProcCompound)</a>
<a name="ln354">		return B_BAD_VALUE;</a>
<a name="ln355">	if (fRequest == NULL)</a>
<a name="ln356">		return B_NO_MEMORY;</a>
<a name="ln357"> </a>
<a name="ln358">	fRequest-&gt;Stream().AddUInt(OpLookUpUp);</a>
<a name="ln359">	fOpCount++;</a>
<a name="ln360"> </a>
<a name="ln361">	return B_OK;</a>
<a name="ln362">}</a>
<a name="ln363"> </a>
<a name="ln364"> </a>
<a name="ln365">status_t</a>
<a name="ln366">RequestBuilder::Nverify(AttrValue* attr, uint32 count)</a>
<a name="ln367">{</a>
<a name="ln368">	if (fProcedure != ProcCompound)</a>
<a name="ln369">		return B_BAD_VALUE;</a>
<a name="ln370">	if (fRequest == NULL)</a>
<a name="ln371">		return B_NO_MEMORY;</a>
<a name="ln372"> </a>
<a name="ln373">	fRequest-&gt;Stream().AddUInt(OpNverify);</a>
<a name="ln374">	_EncodeAttrs(fRequest-&gt;Stream(), attr, count);</a>
<a name="ln375"> </a>
<a name="ln376">	fOpCount++;</a>
<a name="ln377"> </a>
<a name="ln378">	return B_OK;</a>
<a name="ln379">}</a>
<a name="ln380"> </a>
<a name="ln381"> </a>
<a name="ln382">status_t</a>
<a name="ln383">RequestBuilder::Open(OpenClaim claim, uint32 seq, uint32 access, uint64 id,</a>
<a name="ln384">	OpenCreate oc, uint64 ownerId, const char* name, AttrValue* attr,</a>
<a name="ln385">	uint32 count, bool excl, OpenDelegation delegationType)</a>
<a name="ln386">{</a>
<a name="ln387">	if (fProcedure != ProcCompound)</a>
<a name="ln388">		return B_BAD_VALUE;</a>
<a name="ln389">	if (fRequest == NULL)</a>
<a name="ln390">		return B_NO_MEMORY;</a>
<a name="ln391"> </a>
<a name="ln392">	fRequest-&gt;Stream().AddUInt(OpOpen);</a>
<a name="ln393">	fRequest-&gt;Stream().AddUInt(seq);</a>
<a name="ln394">	fRequest-&gt;Stream().AddUInt(access);</a>
<a name="ln395">	fRequest-&gt;Stream().AddUInt(0);			// deny none</a>
<a name="ln396">	fRequest-&gt;Stream().AddUHyper(id);</a>
<a name="ln397"> </a>
<a name="ln398">	char owner[128];</a>
<a name="ln399">	int pos = 0;</a>
<a name="ln400">	*(uint64*)(owner + pos) = ownerId;</a>
<a name="ln401">	pos += sizeof(uint64);</a>
<a name="ln402"> </a>
<a name="ln403">	fRequest-&gt;Stream().AddOpaque(owner, pos);</a>
<a name="ln404"> </a>
<a name="ln405">	fRequest-&gt;Stream().AddUInt(oc);</a>
<a name="ln406">	if (oc == OPEN4_CREATE) {</a>
<a name="ln407">		fRequest-&gt;Stream().AddInt(excl ? GUARDED4 : UNCHECKED4);</a>
<a name="ln408">		_EncodeAttrs(fRequest-&gt;Stream(), attr, count);</a>
<a name="ln409">	}</a>
<a name="ln410"> </a>
<a name="ln411">	fRequest-&gt;Stream().AddUInt(claim);</a>
<a name="ln412">	switch (claim) {</a>
<a name="ln413">		case CLAIM_NULL:</a>
<a name="ln414">			fRequest-&gt;Stream().AddString(name, strlen(name));</a>
<a name="ln415">			break;</a>
<a name="ln416">		case CLAIM_PREVIOUS:</a>
<a name="ln417">			fRequest-&gt;Stream().AddUInt(delegationType);</a>
<a name="ln418">			break;</a>
<a name="ln419">		default:</a>
<a name="ln420">			return B_UNSUPPORTED;</a>
<a name="ln421">	}</a>
<a name="ln422"> </a>
<a name="ln423">	fOpCount++;</a>
<a name="ln424"> </a>
<a name="ln425">	return B_OK;</a>
<a name="ln426">}</a>
<a name="ln427"> </a>
<a name="ln428"> </a>
<a name="ln429">status_t</a>
<a name="ln430">RequestBuilder::OpenConfirm(uint32 seq, const uint32* id, uint32 stateSeq)</a>
<a name="ln431">{</a>
<a name="ln432">	if (fProcedure != ProcCompound)</a>
<a name="ln433">		return B_BAD_VALUE;</a>
<a name="ln434">	if (fRequest == NULL)</a>
<a name="ln435">		return B_NO_MEMORY;</a>
<a name="ln436"> </a>
<a name="ln437">	fRequest-&gt;Stream().AddUInt(OpOpenConfirm);</a>
<a name="ln438">	fRequest-&gt;Stream().AddUInt(stateSeq);</a>
<a name="ln439">	fRequest-&gt;Stream().AddUInt(id[0]);</a>
<a name="ln440">	fRequest-&gt;Stream().AddUInt(id[1]);</a>
<a name="ln441">	fRequest-&gt;Stream().AddUInt(id[2]);</a>
<a name="ln442">	fRequest-&gt;Stream().AddUInt(seq);</a>
<a name="ln443"> </a>
<a name="ln444">	fOpCount++;</a>
<a name="ln445"> </a>
<a name="ln446">	return B_OK;</a>
<a name="ln447">}</a>
<a name="ln448"> </a>
<a name="ln449"> </a>
<a name="ln450">status_t</a>
<a name="ln451">RequestBuilder::OpenAttrDir(bool create)</a>
<a name="ln452">{</a>
<a name="ln453">	if (fProcedure != ProcCompound)</a>
<a name="ln454">		return B_BAD_VALUE;</a>
<a name="ln455">	if (fRequest == NULL)</a>
<a name="ln456">		return B_NO_MEMORY;</a>
<a name="ln457"> </a>
<a name="ln458">	fRequest-&gt;Stream().AddUInt(OpOpenAttrDir);</a>
<a name="ln459">	fRequest-&gt;Stream().AddBoolean(create);</a>
<a name="ln460"> </a>
<a name="ln461">	fOpCount++;</a>
<a name="ln462"> </a>
<a name="ln463">	return B_OK;</a>
<a name="ln464">}</a>
<a name="ln465"> </a>
<a name="ln466"> </a>
<a name="ln467">status_t</a>
<a name="ln468">RequestBuilder::PutFH(const FileHandle&amp; fh)</a>
<a name="ln469">{</a>
<a name="ln470">	if (fProcedure != ProcCompound)</a>
<a name="ln471">		return B_BAD_VALUE;</a>
<a name="ln472">	if (fRequest == NULL)</a>
<a name="ln473">		return B_NO_MEMORY;</a>
<a name="ln474"> </a>
<a name="ln475">	fRequest-&gt;Stream().AddUInt(OpPutFH);</a>
<a name="ln476">	fRequest-&gt;Stream().AddOpaque(fh.fData, fh.fSize);</a>
<a name="ln477">	fOpCount++;</a>
<a name="ln478"> </a>
<a name="ln479">	return B_OK;</a>
<a name="ln480">}</a>
<a name="ln481"> </a>
<a name="ln482"> </a>
<a name="ln483">status_t</a>
<a name="ln484">RequestBuilder::PutRootFH()</a>
<a name="ln485">{</a>
<a name="ln486">	if (fProcedure != ProcCompound)</a>
<a name="ln487">		return B_BAD_VALUE;</a>
<a name="ln488">	if (fRequest == NULL)</a>
<a name="ln489">		return B_NO_MEMORY;</a>
<a name="ln490"> </a>
<a name="ln491">	fRequest-&gt;Stream().AddUInt(OpPutRootFH);</a>
<a name="ln492">	fOpCount++;</a>
<a name="ln493"> </a>
<a name="ln494">	return B_OK;</a>
<a name="ln495">}</a>
<a name="ln496"> </a>
<a name="ln497"> </a>
<a name="ln498">status_t</a>
<a name="ln499">RequestBuilder::Read(const uint32* id, uint32 stateSeq, uint64 pos, uint32 len)</a>
<a name="ln500">{</a>
<a name="ln501">	if (fProcedure != ProcCompound)</a>
<a name="ln502">		return B_BAD_VALUE;</a>
<a name="ln503">	if (fRequest == NULL)</a>
<a name="ln504">		return B_NO_MEMORY;</a>
<a name="ln505"> </a>
<a name="ln506">	fRequest-&gt;Stream().AddUInt(OpRead);</a>
<a name="ln507">	fRequest-&gt;Stream().AddUInt(stateSeq);</a>
<a name="ln508">	fRequest-&gt;Stream().AddUInt(id[0]);</a>
<a name="ln509">	fRequest-&gt;Stream().AddUInt(id[1]);</a>
<a name="ln510">	fRequest-&gt;Stream().AddUInt(id[2]);</a>
<a name="ln511">	fRequest-&gt;Stream().AddUHyper(pos);</a>
<a name="ln512">	fRequest-&gt;Stream().AddUInt(len);</a>
<a name="ln513"> </a>
<a name="ln514">	fOpCount++;</a>
<a name="ln515"> </a>
<a name="ln516">	return B_OK;</a>
<a name="ln517">}</a>
<a name="ln518"> </a>
<a name="ln519"> </a>
<a name="ln520">status_t</a>
<a name="ln521">RequestBuilder::ReadDir(uint64 cookie, uint64 cookieVerf, Attribute* attrs,</a>
<a name="ln522">	uint32 attrCount)</a>
<a name="ln523">{</a>
<a name="ln524">	if (fProcedure != ProcCompound)</a>
<a name="ln525">		return B_BAD_VALUE;</a>
<a name="ln526">	if (fRequest == NULL)</a>
<a name="ln527">		return B_NO_MEMORY;</a>
<a name="ln528"> </a>
<a name="ln529">	fRequest-&gt;Stream().AddUInt(OpReadDir);</a>
<a name="ln530">	fRequest-&gt;Stream().AddUHyper(cookie);</a>
<a name="ln531">	fRequest-&gt;Stream().AddUHyper(cookieVerf);</a>
<a name="ln532"> </a>
<a name="ln533">	// consider predicting this values basing on count or buffer size</a>
<a name="ln534">	fRequest-&gt;Stream().AddUInt(0x2000);</a>
<a name="ln535">	fRequest-&gt;Stream().AddUInt(0x8000);</a>
<a name="ln536">	_AttrBitmap(fRequest-&gt;Stream(), attrs, attrCount);</a>
<a name="ln537"> </a>
<a name="ln538">	fOpCount++;</a>
<a name="ln539"> </a>
<a name="ln540">	return B_OK;</a>
<a name="ln541">}</a>
<a name="ln542"> </a>
<a name="ln543"> </a>
<a name="ln544">status_t</a>
<a name="ln545">RequestBuilder::ReadLink()</a>
<a name="ln546">{</a>
<a name="ln547">	if (fProcedure != ProcCompound)</a>
<a name="ln548">		return B_BAD_VALUE;</a>
<a name="ln549">	if (fRequest == NULL)</a>
<a name="ln550">		return B_NO_MEMORY;</a>
<a name="ln551"> </a>
<a name="ln552">	fRequest-&gt;Stream().AddUInt(OpReadLink);</a>
<a name="ln553"> </a>
<a name="ln554">	fOpCount++;</a>
<a name="ln555"> </a>
<a name="ln556">	return B_OK;</a>
<a name="ln557">}</a>
<a name="ln558"> </a>
<a name="ln559"> </a>
<a name="ln560">status_t</a>
<a name="ln561">RequestBuilder::Remove(const char* file)</a>
<a name="ln562">{</a>
<a name="ln563">	if (fProcedure != ProcCompound)</a>
<a name="ln564">		return B_BAD_VALUE;</a>
<a name="ln565">	if (fRequest == NULL)</a>
<a name="ln566">		return B_NO_MEMORY;</a>
<a name="ln567"> </a>
<a name="ln568">	fRequest-&gt;Stream().AddUInt(OpRemove);</a>
<a name="ln569">	fRequest-&gt;Stream().AddString(file);</a>
<a name="ln570"> </a>
<a name="ln571">	fOpCount++;</a>
<a name="ln572"> </a>
<a name="ln573">	return B_OK;</a>
<a name="ln574">}</a>
<a name="ln575"> </a>
<a name="ln576"> </a>
<a name="ln577">status_t</a>
<a name="ln578">RequestBuilder::Rename(const char* from, const char* to)</a>
<a name="ln579">{</a>
<a name="ln580">	if (fProcedure != ProcCompound)</a>
<a name="ln581">		return B_BAD_VALUE;</a>
<a name="ln582">	if (fRequest == NULL)</a>
<a name="ln583">		return B_NO_MEMORY;</a>
<a name="ln584"> </a>
<a name="ln585">	fRequest-&gt;Stream().AddUInt(OpRename);</a>
<a name="ln586">	fRequest-&gt;Stream().AddString(from);</a>
<a name="ln587">	fRequest-&gt;Stream().AddString(to);</a>
<a name="ln588"> </a>
<a name="ln589">	fOpCount++;</a>
<a name="ln590"> </a>
<a name="ln591">	return B_OK;</a>
<a name="ln592">}</a>
<a name="ln593"> </a>
<a name="ln594"> </a>
<a name="ln595">status_t</a>
<a name="ln596">RequestBuilder::Renew(uint64 clientId)</a>
<a name="ln597">{</a>
<a name="ln598">	if (fProcedure != ProcCompound)</a>
<a name="ln599">		return B_BAD_VALUE;</a>
<a name="ln600">	if (fRequest == NULL)</a>
<a name="ln601">		return B_NO_MEMORY;</a>
<a name="ln602"> </a>
<a name="ln603">	fRequest-&gt;Stream().AddUInt(OpRenew);</a>
<a name="ln604">	fRequest-&gt;Stream().AddUHyper(clientId);</a>
<a name="ln605"> </a>
<a name="ln606">	fOpCount++;</a>
<a name="ln607"> </a>
<a name="ln608">	return B_OK;</a>
<a name="ln609">}</a>
<a name="ln610"> </a>
<a name="ln611"> </a>
<a name="ln612">status_t</a>
<a name="ln613">RequestBuilder::SaveFH()</a>
<a name="ln614">{</a>
<a name="ln615">	if (fProcedure != ProcCompound)</a>
<a name="ln616">		return B_BAD_VALUE;</a>
<a name="ln617">	if (fRequest == NULL)</a>
<a name="ln618">		return B_NO_MEMORY;</a>
<a name="ln619"> </a>
<a name="ln620">	fRequest-&gt;Stream().AddUInt(OpSaveFH);</a>
<a name="ln621">	fOpCount++;</a>
<a name="ln622"> </a>
<a name="ln623">	return B_OK;</a>
<a name="ln624">}</a>
<a name="ln625"> </a>
<a name="ln626"> </a>
<a name="ln627">status_t</a>
<a name="ln628">RequestBuilder::SetAttr(const uint32* id, uint32 stateSeq, AttrValue* attr,</a>
<a name="ln629">	uint32 count)</a>
<a name="ln630">{</a>
<a name="ln631">	if (fProcedure != ProcCompound)</a>
<a name="ln632">		return B_BAD_VALUE;</a>
<a name="ln633">	if (fRequest == NULL)</a>
<a name="ln634">		return B_NO_MEMORY;</a>
<a name="ln635"> </a>
<a name="ln636">	fRequest-&gt;Stream().AddUInt(OpSetAttr);</a>
<a name="ln637">	fRequest-&gt;Stream().AddUInt(stateSeq);</a>
<a name="ln638">	if (id != NULL) {</a>
<a name="ln639">		fRequest-&gt;Stream().AddUInt(id[0]);</a>
<a name="ln640">		fRequest-&gt;Stream().AddUInt(id[1]);</a>
<a name="ln641">		fRequest-&gt;Stream().AddUInt(id[2]);</a>
<a name="ln642">	} else {</a>
<a name="ln643">		fRequest-&gt;Stream().AddUInt(0);</a>
<a name="ln644">		fRequest-&gt;Stream().AddUInt(0);</a>
<a name="ln645">		fRequest-&gt;Stream().AddUInt(0);</a>
<a name="ln646">	}</a>
<a name="ln647">	_EncodeAttrs(fRequest-&gt;Stream(), attr, count);</a>
<a name="ln648"> </a>
<a name="ln649">	fOpCount++;</a>
<a name="ln650"> </a>
<a name="ln651">	return B_OK;</a>
<a name="ln652">}</a>
<a name="ln653"> </a>
<a name="ln654"> </a>
<a name="ln655">status_t</a>
<a name="ln656">RequestBuilder::SetClientID(RPC::Server* server)</a>
<a name="ln657">{</a>
<a name="ln658">	if (fProcedure != ProcCompound)</a>
<a name="ln659">		return B_BAD_VALUE;</a>
<a name="ln660">	if (fRequest == NULL)</a>
<a name="ln661">		return B_NO_MEMORY;</a>
<a name="ln662"> </a>
<a name="ln663">	fRequest-&gt;Stream().AddUInt(OpSetClientID);</a>
<a name="ln664">	uint64 verifier = get_random&lt;uint64&gt;();</a>
<a name="ln665">	fRequest-&gt;Stream().AddUHyper(verifier);</a>
<a name="ln666"> </a>
<a name="ln667">	status_t result = _GenerateClientId(fRequest-&gt;Stream(), server);</a>
<a name="ln668">	if (result != B_OK)</a>
<a name="ln669">		return result;</a>
<a name="ln670"> </a>
<a name="ln671">	fRequest-&gt;Stream().AddUInt(0x40000000);</a>
<a name="ln672"> </a>
<a name="ln673">	if (server-&gt;GetCallback() != NULL) {</a>
<a name="ln674">		ASSERT(server-&gt;GetCallback()-&gt;CBServer() != NULL);</a>
<a name="ln675"> </a>
<a name="ln676">		uint32 id = server-&gt;GetCallback()-&gt;ID();</a>
<a name="ln677"> </a>
<a name="ln678">		PeerAddress local = server-&gt;GetCallback()-&gt;CBServer()-&gt;LocalID();</a>
<a name="ln679">		PeerAddress servAddr = server-&gt;LocalID();</a>
<a name="ln680">		servAddr.SetPort(local.Port());</a>
<a name="ln681"> </a>
<a name="ln682">		fRequest-&gt;Stream().AddString(local.ProtocolString());</a>
<a name="ln683"> </a>
<a name="ln684">		char* uAddr = servAddr.UniversalAddress();</a>
<a name="ln685">		if (uAddr == NULL)</a>
<a name="ln686">			return B_NO_MEMORY;</a>
<a name="ln687">		fRequest-&gt;Stream().AddString(uAddr);</a>
<a name="ln688">		free(uAddr);</a>
<a name="ln689"> </a>
<a name="ln690">		fRequest-&gt;Stream().AddUInt(id);</a>
<a name="ln691">	} else {</a>
<a name="ln692">		fRequest-&gt;Stream().AddString(&quot;&quot;);</a>
<a name="ln693">		fRequest-&gt;Stream().AddString(&quot;&quot;);</a>
<a name="ln694">		fRequest-&gt;Stream().AddUInt(0);</a>
<a name="ln695">	}</a>
<a name="ln696"> </a>
<a name="ln697">	fOpCount++;</a>
<a name="ln698"> </a>
<a name="ln699">	return B_OK;</a>
<a name="ln700">}</a>
<a name="ln701"> </a>
<a name="ln702"> </a>
<a name="ln703">status_t</a>
<a name="ln704">RequestBuilder::_GenerateClientId(XDR::WriteStream&amp; stream,</a>
<a name="ln705">	const RPC::Server* server)</a>
<a name="ln706">{</a>
<a name="ln707">	char id[512] = &quot;HAIKU:kernel:&quot;;</a>
<a name="ln708">	int pos = strlen(id);</a>
<a name="ln709"> </a>
<a name="ln710">	PeerAddress local = server-&gt;LocalID();</a>
<a name="ln711"> </a>
<a name="ln712">	memcpy(id + pos, server-&gt;ID().InAddr(), server-&gt;ID().InAddrSize());</a>
<a name="ln713">	pos += sizeof(server-&gt;ID().InAddrSize());</a>
<a name="ln714"> </a>
<a name="ln715">	memcpy(id + pos, local.InAddr(), local.InAddrSize());</a>
<a name="ln716">	pos += sizeof(local.InAddrSize());</a>
<a name="ln717"> </a>
<a name="ln718">	*(uint16*)(id + pos) = server-&gt;ID().Port();</a>
<a name="ln719">	pos += sizeof(uint16);</a>
<a name="ln720"> </a>
<a name="ln721">	*(uint16*)(id + pos) = server-&gt;ID().fProtocol;</a>
<a name="ln722">	pos += sizeof(uint16);</a>
<a name="ln723">	</a>
<a name="ln724">	stream.AddOpaque(id, pos);</a>
<a name="ln725"> </a>
<a name="ln726">	return B_OK;</a>
<a name="ln727">}</a>
<a name="ln728"> </a>
<a name="ln729"> </a>
<a name="ln730">status_t</a>
<a name="ln731">RequestBuilder::SetClientIDConfirm(uint64 id, uint64 ver)</a>
<a name="ln732">{</a>
<a name="ln733">	if (fProcedure != ProcCompound)</a>
<a name="ln734">		return B_BAD_VALUE;</a>
<a name="ln735">	if (fRequest == NULL)</a>
<a name="ln736">		return B_NO_MEMORY;</a>
<a name="ln737"> </a>
<a name="ln738">	fRequest-&gt;Stream().AddUInt(OpSetClientIDConfirm);</a>
<a name="ln739">	fRequest-&gt;Stream().AddUHyper(id);</a>
<a name="ln740">	fRequest-&gt;Stream().AddUHyper(ver);</a>
<a name="ln741"> </a>
<a name="ln742">	fOpCount++;</a>
<a name="ln743"> </a>
<a name="ln744">	return B_OK;</a>
<a name="ln745">}</a>
<a name="ln746"> </a>
<a name="ln747"> </a>
<a name="ln748">status_t</a>
<a name="ln749">RequestBuilder::Verify(AttrValue* attr, uint32 count)</a>
<a name="ln750">{</a>
<a name="ln751">	if (fProcedure != ProcCompound)</a>
<a name="ln752">		return B_BAD_VALUE;</a>
<a name="ln753">	if (fRequest == NULL)</a>
<a name="ln754">		return B_NO_MEMORY;</a>
<a name="ln755"> </a>
<a name="ln756">	fRequest-&gt;Stream().AddUInt(OpVerify);</a>
<a name="ln757">	_EncodeAttrs(fRequest-&gt;Stream(), attr, count);</a>
<a name="ln758"> </a>
<a name="ln759">	fOpCount++;</a>
<a name="ln760"> </a>
<a name="ln761">	return B_OK;</a>
<a name="ln762">}</a>
<a name="ln763"> </a>
<a name="ln764"> </a>
<a name="ln765">status_t</a>
<a name="ln766">RequestBuilder::Write(const uint32* id, uint32 stateSeq, const void* buffer,</a>
<a name="ln767">	uint64 pos, uint32 len, bool stable)</a>
<a name="ln768">{</a>
<a name="ln769">	if (fProcedure != ProcCompound)</a>
<a name="ln770">		return B_BAD_VALUE;</a>
<a name="ln771">	if (fRequest == NULL)</a>
<a name="ln772">		return B_NO_MEMORY;</a>
<a name="ln773"> </a>
<a name="ln774">	fRequest-&gt;Stream().AddUInt(OpWrite);</a>
<a name="ln775">	fRequest-&gt;Stream().AddUInt(stateSeq);</a>
<a name="ln776">	fRequest-&gt;Stream().AddUInt(id[0]);</a>
<a name="ln777">	fRequest-&gt;Stream().AddUInt(id[1]);</a>
<a name="ln778">	fRequest-&gt;Stream().AddUInt(id[2]);</a>
<a name="ln779">	fRequest-&gt;Stream().AddUHyper(pos);</a>
<a name="ln780">	fRequest-&gt;Stream().AddInt(stable ? FILE_SYNC4 : UNSTABLE4);</a>
<a name="ln781">	fRequest-&gt;Stream().AddOpaque(buffer, len);</a>
<a name="ln782"> </a>
<a name="ln783">	fOpCount++;</a>
<a name="ln784"> </a>
<a name="ln785">	return B_OK;</a>
<a name="ln786">}</a>
<a name="ln787"> </a>
<a name="ln788"> </a>
<a name="ln789">status_t</a>
<a name="ln790">RequestBuilder::ReleaseLockOwner(OpenState* state, LockOwner* owner)</a>
<a name="ln791">{</a>
<a name="ln792">	if (fProcedure != ProcCompound)</a>
<a name="ln793">		return B_BAD_VALUE;</a>
<a name="ln794">	if (fRequest == NULL)</a>
<a name="ln795">		return B_NO_MEMORY;</a>
<a name="ln796"> </a>
<a name="ln797">	fRequest-&gt;Stream().AddUInt(OpReleaseLockOwner);</a>
<a name="ln798">	_GenerateLockOwner(fRequest-&gt;Stream(), state, owner);</a>
<a name="ln799"> </a>
<a name="ln800">	fOpCount++;</a>
<a name="ln801"> </a>
<a name="ln802">	return B_OK;</a>
<a name="ln803">}</a>
<a name="ln804"> </a>
<a name="ln805"> </a>
<a name="ln806">RPC::Call*</a>
<a name="ln807">RequestBuilder::Request()</a>
<a name="ln808">{</a>
<a name="ln809">	if (fProcedure == ProcCompound)</a>
<a name="ln810">		fRequest-&gt;Stream().InsertUInt(fOpCountPosition, fOpCount);</a>
<a name="ln811"> </a>
<a name="ln812">	if (fRequest == NULL || fRequest-&gt;Stream().Error() == B_OK)</a>
<a name="ln813">		return fRequest;</a>
<a name="ln814">	else</a>
<a name="ln815">		return NULL;</a>
<a name="ln816">}</a>
<a name="ln817"> </a>
<a name="ln818"> </a>
<a name="ln819">void</a>
<a name="ln820">RequestBuilder::_AttrBitmap(XDR::WriteStream&amp; stream, Attribute* attrs,</a>
<a name="ln821">	uint32 count)</a>
<a name="ln822">{</a>
<a name="ln823">	// 2 is safe in NFS4, not in NFS4.1 though</a>
<a name="ln824">	uint32 bitmap[2];</a>
<a name="ln825">	memset(bitmap, 0, sizeof(bitmap));</a>
<a name="ln826">	for (uint32 i = 0; i &lt; count; i++) {</a>
<a name="ln827">		bitmap[attrs[i] / 32] |= 1 &lt;&lt; attrs[i] % 32;</a>
<a name="ln828">	}</a>
<a name="ln829"> </a>
<a name="ln830">	uint32 bcount = bitmap[1] != 0 ? 2 : 1;</a>
<a name="ln831">	stream.AddUInt(bcount);</a>
<a name="ln832">	for (uint32 i = 0; i &lt; bcount; i++)</a>
<a name="ln833">		stream.AddUInt(bitmap[i]);</a>
<a name="ln834">}</a>
<a name="ln835"> </a>
<a name="ln836"> </a>
<a name="ln837">void</a>
<a name="ln838">RequestBuilder::_EncodeAttrs(XDR::WriteStream&amp; stream, AttrValue* attr,</a>
<a name="ln839">	uint32 count)</a>
<a name="ln840">{</a>
<a name="ln841">	if (count == 0) {</a>
<a name="ln842">		stream.AddUInt(0);</a>
<a name="ln843">		stream.AddOpaque(NULL, 0);</a>
<a name="ln844">		return;</a>
<a name="ln845">	}</a>
<a name="ln846"> </a>
<a name="ln847">	Attribute* attrs</a>
<a name="ln848">		= reinterpret_cast&lt;Attribute*&gt;(malloc(sizeof(Attribute) * count));</a>
<a name="ln849">	for (uint32 i = 0; i &lt; count; i++)</a>
<a name="ln850">		attrs[i] = static_cast&lt;Attribute&gt;(attr[i].fAttribute);</a>
<a name="ln851">	_AttrBitmap(stream, attrs, count);</a>
<a name="ln852">	free(attrs);</a>
<a name="ln853"> </a>
<a name="ln854">	uint32 i = 0;</a>
<a name="ln855">	XDR::WriteStream str;</a>
<a name="ln856">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_TYPE) {</a>
<a name="ln857">		str.AddUInt(attr[i].fData.fValue32);</a>
<a name="ln858">		i++;</a>
<a name="ln859">	}</a>
<a name="ln860"> </a>
<a name="ln861">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_SIZE) {</a>
<a name="ln862">		str.AddUHyper(attr[i].fData.fValue64);</a>
<a name="ln863">		i++;</a>
<a name="ln864">	}</a>
<a name="ln865"> </a>
<a name="ln866">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_FILEHANDLE) {</a>
<a name="ln867">		FileHandle* fh = reinterpret_cast&lt;FileHandle*&gt;(attr[i].fData.fPointer);</a>
<a name="ln868">		str.AddOpaque(fh-&gt;fData, fh-&gt;fSize);</a>
<a name="ln869">		i++;</a>
<a name="ln870">	}</a>
<a name="ln871"> </a>
<a name="ln872">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_FILEID) {</a>
<a name="ln873">		str.AddUHyper(attr[i].fData.fValue64);</a>
<a name="ln874">		i++;</a>
<a name="ln875">	}</a>
<a name="ln876"> </a>
<a name="ln877">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_MODE) {</a>
<a name="ln878">		str.AddUInt(attr[i].fData.fValue32);</a>
<a name="ln879">		i++;</a>
<a name="ln880">	}</a>
<a name="ln881"> </a>
<a name="ln882">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_OWNER) {</a>
<a name="ln883">		str.AddString(reinterpret_cast&lt;char*&gt;(attr[i].fData.fPointer));</a>
<a name="ln884">		i++;</a>
<a name="ln885">	}</a>
<a name="ln886"> </a>
<a name="ln887">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_OWNER_GROUP) {</a>
<a name="ln888">		str.AddString(reinterpret_cast&lt;char*&gt;(attr[i].fData.fPointer));</a>
<a name="ln889">		i++;</a>
<a name="ln890">	}</a>
<a name="ln891"> </a>
<a name="ln892">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_TIME_ACCESS_SET) {</a>
<a name="ln893">		str.AddInt(1);		// SET_TO_CLIENT_TIME4</a>
<a name="ln894"> </a>
<a name="ln895">		struct timespec* ts</a>
<a name="ln896">			= reinterpret_cast&lt;timespec*&gt;(attr[i].fData.fPointer);</a>
<a name="ln897">		str.AddHyper(ts-&gt;tv_sec);</a>
<a name="ln898">		str.AddUInt(ts-&gt;tv_nsec);</a>
<a name="ln899"> </a>
<a name="ln900">		i++;</a>
<a name="ln901">	}</a>
<a name="ln902"> </a>
<a name="ln903">	if (i &lt; count &amp;&amp; attr[i].fAttribute == FATTR4_TIME_MODIFY_SET) {</a>
<a name="ln904">		str.AddInt(1);		// SET_TO_CLIENT_TIME4</a>
<a name="ln905"> </a>
<a name="ln906">		struct timespec* ts</a>
<a name="ln907">			= reinterpret_cast&lt;timespec*&gt;(attr[i].fData.fPointer);</a>
<a name="ln908">		str.AddHyper(ts-&gt;tv_sec);</a>
<a name="ln909">		str.AddUInt(ts-&gt;tv_nsec);</a>
<a name="ln910"> </a>
<a name="ln911">		i++;</a>
<a name="ln912">	}</a>
<a name="ln913"> </a>
<a name="ln914">	stream.AddOpaque(str);</a>
<a name="ln915">}</a>
<a name="ln916"> </a>

</code></pre>
<div class="balloon" rel="810"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'fRequest' pointer was utilized before it was verified against nullptr. Check lines: 810, 812.</p></div>
<div class="balloon" rel="713"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that the argument of sizeof() operator is the 'server->ID().InAddrSize()' expression.</p></div>
<div class="balloon" rel="716"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that the argument of sizeof() operator is the 'local.InAddrSize()' expression.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
