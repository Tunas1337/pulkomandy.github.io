
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ScreenshotWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2010-2014, Haiku Inc. All rights reserved.</a>
<a name="ln3"> * Copyright 2010 Wim van der Meer &lt;WPJvanderMeer@gmail.com&gt;</a>
<a name="ln4"> * Copyright Karsten Heimrich, host.haiku@gmx.de.</a>
<a name="ln5"> * All rights reserved. Distributed under the terms of the MIT License.</a>
<a name="ln6"> *</a>
<a name="ln7"> * Authors:</a>
<a name="ln8"> *		Karsten Heimrich</a>
<a name="ln9"> *		Fredrik Mod√©en</a>
<a name="ln10"> *		Christophe Huriaux</a>
<a name="ln11"> *		Wim van der Meer</a>
<a name="ln12"> */</a>
<a name="ln13"> </a>
<a name="ln14"> </a>
<a name="ln15">#include &quot;ScreenshotWindow.h&quot;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;stdlib.h&gt;</a>
<a name="ln18"> </a>
<a name="ln19">#include &lt;Alert.h&gt;</a>
<a name="ln20">#include &lt;Application.h&gt;</a>
<a name="ln21">#include &lt;Bitmap.h&gt;</a>
<a name="ln22">#include &lt;Box.h&gt;</a>
<a name="ln23">#include &lt;Button.h&gt;</a>
<a name="ln24">#include &lt;Catalog.h&gt;</a>
<a name="ln25">#include &lt;CheckBox.h&gt;</a>
<a name="ln26">#include &lt;ControlLook.h&gt;</a>
<a name="ln27">#include &lt;File.h&gt;</a>
<a name="ln28">#include &lt;FilePanel.h&gt;</a>
<a name="ln29">#include &lt;FindDirectory.h&gt;</a>
<a name="ln30">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln31">#include &lt;Locale.h&gt;</a>
<a name="ln32">#include &lt;Menu.h&gt;</a>
<a name="ln33">#include &lt;MenuField.h&gt;</a>
<a name="ln34">#include &lt;MenuItem.h&gt;</a>
<a name="ln35">#include &lt;MessageFilter.h&gt;</a>
<a name="ln36">#include &lt;Path.h&gt;</a>
<a name="ln37">#include &lt;Roster.h&gt;</a>
<a name="ln38">#include &lt;SeparatorView.h&gt;</a>
<a name="ln39">#include &lt;SpaceLayoutItem.h&gt;</a>
<a name="ln40">#include &lt;String.h&gt;</a>
<a name="ln41">#include &lt;StringView.h&gt;</a>
<a name="ln42">#include &lt;TextControl.h&gt;</a>
<a name="ln43">#include &lt;TranslationUtils.h&gt;</a>
<a name="ln44">#include &lt;TranslatorRoster.h&gt;</a>
<a name="ln45"> </a>
<a name="ln46">#include &quot;Utility.h&quot;</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln50">#define B_TRANSLATION_CONTEXT &quot;ScreenshotWindow&quot;</a>
<a name="ln51"> </a>
<a name="ln52"> </a>
<a name="ln53">enum {</a>
<a name="ln54">	kActiveWindow,</a>
<a name="ln55">	kIncludeBorder,</a>
<a name="ln56">	kIncludeCursor,</a>
<a name="ln57">	kNewScreenshot,</a>
<a name="ln58">	kImageFormat,</a>
<a name="ln59">	kLocationChanged,</a>
<a name="ln60">	kChooseLocation,</a>
<a name="ln61">	kSaveScreenshot,</a>
<a name="ln62">	kSettings,</a>
<a name="ln63">	kCloseTranslatorSettings</a>
<a name="ln64">};</a>
<a name="ln65"> </a>
<a name="ln66"> </a>
<a name="ln67">// #pragma mark - QuitMessageFilter</a>
<a name="ln68"> </a>
<a name="ln69"> </a>
<a name="ln70">class QuitMessageFilter : public BMessageFilter {</a>
<a name="ln71">public:</a>
<a name="ln72">	QuitMessageFilter(BWindow* window)</a>
<a name="ln73">		:</a>
<a name="ln74">		BMessageFilter((uint32)B_QUIT_REQUESTED),</a>
<a name="ln75">		fWindow(window)</a>
<a name="ln76">	{</a>
<a name="ln77">	}</a>
<a name="ln78"> </a>
<a name="ln79">	virtual filter_result Filter(BMessage* message, BHandler** target)</a>
<a name="ln80">	{</a>
<a name="ln81">		BMessenger(fWindow).SendMessage(kCloseTranslatorSettings);</a>
<a name="ln82">		return B_SKIP_MESSAGE;</a>
<a name="ln83">	}</a>
<a name="ln84"> </a>
<a name="ln85">private:</a>
<a name="ln86">	BWindow* fWindow;</a>
<a name="ln87">};</a>
<a name="ln88"> </a>
<a name="ln89"> </a>
<a name="ln90">// #pragma mark - DirectoryRefFilter</a>
<a name="ln91"> </a>
<a name="ln92"> </a>
<a name="ln93">class DirectoryRefFilter : public BRefFilter {</a>
<a name="ln94">public:</a>
<a name="ln95">	virtual ~DirectoryRefFilter()</a>
<a name="ln96">	{</a>
<a name="ln97">	}</a>
<a name="ln98"> </a>
<a name="ln99">	virtual bool Filter(const entry_ref* ref, BNode* node,</a>
<a name="ln100">		struct stat_beos* stat, const char* filetype)</a>
<a name="ln101">	{</a>
<a name="ln102">		// ToDo: Fix this properly in Tracker</a>
<a name="ln103">		// If you create a folder, then rename it, node is NULL.</a>
<a name="ln104">		// The BeBook says: &quot;Note that the function is never sent an</a>
<a name="ln105">		// abstract entry, so the node, st, and filetype arguments will</a>
<a name="ln106">		// always be valid.&quot;</a>
<a name="ln107">		return node == NULL ? false : node-&gt;IsDirectory();</a>
<a name="ln108">	}</a>
<a name="ln109">};</a>
<a name="ln110"> </a>
<a name="ln111"> </a>
<a name="ln112">// #pragma mark - ScreenshotWindow</a>
<a name="ln113"> </a>
<a name="ln114"> </a>
<a name="ln115">ScreenshotWindow::ScreenshotWindow(const Utility&amp; utility, bool silent,</a>
<a name="ln116">	bool clipboard)</a>
<a name="ln117">	:</a>
<a name="ln118">	BWindow(BRect(0, 0, 200.0, 100.0), B_TRANSLATE_SYSTEM_NAME(&quot;Screenshot&quot;),</a>
<a name="ln119">		B_TITLED_WINDOW, B_NOT_ZOOMABLE | B_NOT_RESIZABLE | B_AVOID_FRONT</a>
<a name="ln120">			| B_QUIT_ON_WINDOW_CLOSE | B_AUTO_UPDATE_SIZE_LIMITS</a>
<a name="ln121">			| B_CLOSE_ON_ESCAPE),</a>
<a name="ln122">	fUtility(utility),</a>
<a name="ln123">	fDelayControl(NULL),</a>
<a name="ln124">	fScreenshot(NULL),</a>
<a name="ln125">	fOutputPathPanel(NULL),</a>
<a name="ln126">	fLastSelectedPath(NULL),</a>
<a name="ln127">	fSettingsWindow(NULL),</a>
<a name="ln128">	fDelay(0),</a>
<a name="ln129">	fIncludeBorder(false),</a>
<a name="ln130">	fIncludeCursor(false),</a>
<a name="ln131">	fGrabActiveWindow(false),</a>
<a name="ln132">	fOutputFilename(NULL),</a>
<a name="ln133">	fExtension(&quot;&quot;),</a>
<a name="ln134">	fImageFileType(B_PNG_FORMAT)</a>
<a name="ln135">{</a>
<a name="ln136">	// _ReadSettings() needs a valid fOutputPathMenu</a>
<a name="ln137">	fOutputPathMenu = new BMenu(B_TRANSLATE(&quot;Please select&quot;));</a>
<a name="ln138">	_ReadSettings();</a>
<a name="ln139"> </a>
<a name="ln140">	// _NewScreenshot() needs a valid fNameControl</a>
<a name="ln141">	BString name(B_TRANSLATE_NOCOLLECT(fUtility.sDefaultFileNameBase));</a>
<a name="ln142">	name &lt;&lt; 1;</a>
<a name="ln143">	name = _FindValidFileName(name.String());</a>
<a name="ln144">	fNameControl = new BTextControl(&quot;&quot;, B_TRANSLATE(&quot;Name:&quot;), name, NULL);</a>
<a name="ln145"> </a>
<a name="ln146">	// Check if fUtility contains valid data</a>
<a name="ln147">	if (fUtility.wholeScreen == NULL) {</a>
<a name="ln148">		_NewScreenshot(silent, clipboard, true);</a>
<a name="ln149">		return;</a>
<a name="ln150">	}</a>
<a name="ln151"> </a>
<a name="ln152">	fScreenshot = fUtility.MakeScreenshot(fIncludeCursor, fGrabActiveWindow,</a>
<a name="ln153">		fIncludeBorder);</a>
<a name="ln154"> </a>
<a name="ln155">	fActiveWindow = new BCheckBox(B_TRANSLATE(&quot;Capture active window&quot;),</a>
<a name="ln156">		new BMessage(kActiveWindow));</a>
<a name="ln157">	if (fGrabActiveWindow)</a>
<a name="ln158">		fActiveWindow-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln159"> </a>
<a name="ln160">	fWindowBorder = new BCheckBox(B_TRANSLATE(&quot;Include window border&quot;),</a>
<a name="ln161">		new BMessage(kIncludeBorder));</a>
<a name="ln162">	if (fIncludeBorder)</a>
<a name="ln163">		fWindowBorder-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln164">	if (!fGrabActiveWindow)</a>
<a name="ln165">		fWindowBorder-&gt;SetEnabled(false);</a>
<a name="ln166"> </a>
<a name="ln167">	fShowCursor = new BCheckBox(B_TRANSLATE(&quot;Include mouse pointer&quot;),</a>
<a name="ln168">		new BMessage(kIncludeCursor));</a>
<a name="ln169">	if (fIncludeCursor)</a>
<a name="ln170">		fShowCursor-&gt;SetValue(B_CONTROL_ON);</a>
<a name="ln171"> </a>
<a name="ln172">	BString delay;</a>
<a name="ln173">	delay &lt;&lt; fDelay / 1000000;</a>
<a name="ln174">	fDelayControl = new BTextControl(&quot;&quot;, B_TRANSLATE(&quot;Delay:&quot;), delay.String(),</a>
<a name="ln175">		NULL);</a>
<a name="ln176">	_DisallowChar(fDelayControl-&gt;TextView());</a>
<a name="ln177">	fDelayControl-&gt;TextView()-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln178">	BStringView* seconds = new BStringView(&quot;&quot;, B_TRANSLATE(&quot;seconds&quot;));</a>
<a name="ln179">	seconds-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln180"> </a>
<a name="ln181">	BMenuField* menuLocation = new BMenuField(B_TRANSLATE(&quot;Save in:&quot;),</a>
<a name="ln182">		fOutputPathMenu);</a>
<a name="ln183">	menuLocation-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln184"> </a>
<a name="ln185">	fTranslatorMenu = new BMenu(B_TRANSLATE(&quot;Please select&quot;));</a>
<a name="ln186">	_SetupTranslatorMenu();</a>
<a name="ln187">	BMenuField* menuFormat = new BMenuField(B_TRANSLATE(&quot;Save as:&quot;),</a>
<a name="ln188">		fTranslatorMenu);</a>
<a name="ln189">	menuFormat-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln190"> </a>
<a name="ln191">	BButton* showSettings =  new BButton(&quot;&quot;,</a>
<a name="ln192">		B_TRANSLATE(&quot;Settings&quot; B_UTF8_ELLIPSIS), new BMessage(kSettings));</a>
<a name="ln193">	showSettings-&gt;SetExplicitAlignment(</a>
<a name="ln194">		BAlignment(B_ALIGN_RIGHT, B_ALIGN_BOTTOM));</a>
<a name="ln195"> </a>
<a name="ln196">	BBox* divider = new BBox(B_FANCY_BORDER, NULL);</a>
<a name="ln197">	divider-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, 1));</a>
<a name="ln198"> </a>
<a name="ln199">	BButton* saveScreenshot  = new BButton(&quot;&quot;, B_TRANSLATE(&quot;Save&quot;),</a>
<a name="ln200">		new BMessage(kSaveScreenshot));</a>
<a name="ln201"> </a>
<a name="ln202">	const float kSpacing = be_control_look-&gt;DefaultItemSpacing();</a>
<a name="ln203">	const float kLabelSpacing = be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln204"> </a>
<a name="ln205">	fPreview = new BView(&quot;preview&quot;, B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE);</a>
<a name="ln206">	BBox* previewBox = new BBox(B_FANCY_BORDER, fPreview);</a>
<a name="ln207"> </a>
<a name="ln208">	BLayoutBuilder::Group&lt;&gt;(this, B_VERTICAL, 0)</a>
<a name="ln209">		.AddGroup(B_HORIZONTAL)</a>
<a name="ln210">			.SetInsets(B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING,</a>
<a name="ln211">				B_USE_WINDOW_SPACING, B_USE_DEFAULT_SPACING)</a>
<a name="ln212">			.Add(previewBox)</a>
<a name="ln213">			.AddGroup(B_VERTICAL, 0)</a>
<a name="ln214">				.Add(fActiveWindow)</a>
<a name="ln215">				.Add(fWindowBorder)</a>
<a name="ln216">				.Add(fShowCursor)</a>
<a name="ln217">				.AddStrut(kSpacing)</a>
<a name="ln218">				.AddGrid(0.0, kSpacing / 2)</a>
<a name="ln219">					.Add(fDelayControl-&gt;CreateLabelLayoutItem(), 0, 0)</a>
<a name="ln220">					.Add(fDelayControl-&gt;CreateTextViewLayoutItem(), 1, 0)</a>
<a name="ln221">					.Add(BSpaceLayoutItem::CreateHorizontalStrut(kLabelSpacing),</a>
<a name="ln222">						2, 0)</a>
<a name="ln223">					.Add(seconds, 3, 0)</a>
<a name="ln224">					.Add(fNameControl-&gt;CreateLabelLayoutItem(), 0, 1)</a>
<a name="ln225">					.Add(fNameControl-&gt;CreateTextViewLayoutItem(), 1, 1, 3, 1)</a>
<a name="ln226">					.Add(menuLocation-&gt;CreateLabelLayoutItem(), 0, 2)</a>
<a name="ln227">					.Add(menuLocation-&gt;CreateMenuBarLayoutItem(), 1, 2, 3, 1)</a>
<a name="ln228">					.Add(menuFormat-&gt;CreateLabelLayoutItem(), 0, 3)</a>
<a name="ln229">					.Add(menuFormat-&gt;CreateMenuBarLayoutItem(), 1, 3, 3, 1)</a>
<a name="ln230">				.End()</a>
<a name="ln231">				.AddStrut(kSpacing / 2)</a>
<a name="ln232">				.Add(showSettings)</a>
<a name="ln233">				.AddGlue()</a>
<a name="ln234">			.End()</a>
<a name="ln235">		.End()</a>
<a name="ln236">		.Add(new BSeparatorView(B_HORIZONTAL))</a>
<a name="ln237">		.AddGroup(B_HORIZONTAL)</a>
<a name="ln238">			.SetInsets(B_USE_WINDOW_SPACING, B_USE_DEFAULT_SPACING,</a>
<a name="ln239">				B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING)</a>
<a name="ln240">			.Add(new BButton(&quot;&quot;, B_TRANSLATE(&quot;Copy to clipboard&quot;),</a>
<a name="ln241">				new BMessage(B_COPY)))</a>
<a name="ln242">			.Add(new BButton(&quot;&quot;, B_TRANSLATE(&quot;New screenshot&quot;),</a>
<a name="ln243">				new BMessage(kNewScreenshot)))</a>
<a name="ln244">			.AddGlue()</a>
<a name="ln245">			.Add(saveScreenshot);</a>
<a name="ln246"> </a>
<a name="ln247">	saveScreenshot-&gt;MakeDefault(true);</a>
<a name="ln248"> </a>
<a name="ln249">	_UpdatePreviewPanel();</a>
<a name="ln250">	_UpdateFilenameSelection();</a>
<a name="ln251"> </a>
<a name="ln252">	CenterOnScreen();</a>
<a name="ln253">	Show();</a>
<a name="ln254">}</a>
<a name="ln255"> </a>
<a name="ln256"> </a>
<a name="ln257">ScreenshotWindow::~ScreenshotWindow()</a>
<a name="ln258">{</a>
<a name="ln259">	if (fOutputPathPanel)</a>
<a name="ln260">		delete fOutputPathPanel-&gt;RefFilter();</a>
<a name="ln261"> </a>
<a name="ln262">	delete fOutputPathPanel;</a>
<a name="ln263">	delete fScreenshot;</a>
<a name="ln264">}</a>
<a name="ln265"> </a>
<a name="ln266"> </a>
<a name="ln267">void</a>
<a name="ln268">ScreenshotWindow::MessageReceived(BMessage* message)</a>
<a name="ln269">{</a>
<a name="ln270">	switch (message-&gt;what) {</a>
<a name="ln271">		case kActiveWindow:</a>
<a name="ln272">			fGrabActiveWindow = false;</a>
<a name="ln273">			if (fActiveWindow-&gt;Value() == B_CONTROL_ON)</a>
<a name="ln274">				fGrabActiveWindow = true;</a>
<a name="ln275"> </a>
<a name="ln276">			fWindowBorder-&gt;SetEnabled(fGrabActiveWindow);</a>
<a name="ln277"> </a>
<a name="ln278">			delete fScreenshot;</a>
<a name="ln279">			fScreenshot = fUtility.MakeScreenshot(fIncludeCursor,</a>
<a name="ln280">				fGrabActiveWindow, fIncludeBorder);</a>
<a name="ln281">			_UpdatePreviewPanel();</a>
<a name="ln282">			break;</a>
<a name="ln283"> </a>
<a name="ln284">		case kIncludeBorder:</a>
<a name="ln285">			fIncludeBorder = (fWindowBorder-&gt;Value() == B_CONTROL_ON);</a>
<a name="ln286">			delete fScreenshot;</a>
<a name="ln287">			fScreenshot = fUtility.MakeScreenshot(fIncludeCursor,</a>
<a name="ln288">				fGrabActiveWindow, fIncludeBorder);</a>
<a name="ln289">			_UpdatePreviewPanel();</a>
<a name="ln290">			break;</a>
<a name="ln291"> </a>
<a name="ln292">		case kIncludeCursor:</a>
<a name="ln293">			fIncludeCursor = (fShowCursor-&gt;Value() == B_CONTROL_ON);</a>
<a name="ln294">			delete fScreenshot;</a>
<a name="ln295">			fScreenshot = fUtility.MakeScreenshot(fIncludeCursor,</a>
<a name="ln296">				fGrabActiveWindow, fIncludeBorder);</a>
<a name="ln297">			_UpdatePreviewPanel();</a>
<a name="ln298">			break;</a>
<a name="ln299"> </a>
<a name="ln300">		case kNewScreenshot:</a>
<a name="ln301">			fDelay = (atoi(fDelayControl-&gt;Text()) * 1000000) + 50000;</a>
<a name="ln302">			_NewScreenshot();</a>
<a name="ln303">			break;</a>
<a name="ln304"> </a>
<a name="ln305">		case kImageFormat:</a>
<a name="ln306">			message-&gt;FindInt32(&quot;be:type&quot;, &amp;fImageFileType);</a>
<a name="ln307">			fNameControl-&gt;SetText(_FindValidFileName(</a>
<a name="ln308">				fNameControl-&gt;Text()).String());</a>
<a name="ln309">			_UpdateFilenameSelection();</a>
<a name="ln310">			_ShowSettings(false);</a>
<a name="ln311">			break;</a>
<a name="ln312"> </a>
<a name="ln313">		case kLocationChanged:</a>
<a name="ln314">		{</a>
<a name="ln315">			void* source = NULL;</a>
<a name="ln316">			if (message-&gt;FindPointer(&quot;source&quot;, &amp;source) == B_OK)</a>
<a name="ln317">				fLastSelectedPath = static_cast&lt;BMenuItem*&gt; (source);</a>
<a name="ln318"> </a>
<a name="ln319">			fNameControl-&gt;SetText(_FindValidFileName(</a>
<a name="ln320">				fNameControl-&gt;Text()).String());</a>
<a name="ln321"> </a>
<a name="ln322">			_UpdateFilenameSelection();</a>
<a name="ln323">			break;</a>
<a name="ln324">		}</a>
<a name="ln325"> </a>
<a name="ln326">		case kChooseLocation:</a>
<a name="ln327">		{</a>
<a name="ln328">			if (!fOutputPathPanel) {</a>
<a name="ln329">				BMessenger target(this);</a>
<a name="ln330">				fOutputPathPanel = new BFilePanel(B_OPEN_PANEL, &amp;target, NULL,</a>
<a name="ln331">					B_DIRECTORY_NODE, false, NULL, new DirectoryRefFilter());</a>
<a name="ln332">				fOutputPathPanel-&gt;Window()-&gt;SetTitle(</a>
<a name="ln333">					B_TRANSLATE(&quot;Choose folder&quot;));</a>
<a name="ln334">				fOutputPathPanel-&gt;SetButtonLabel(B_DEFAULT_BUTTON,</a>
<a name="ln335">					B_TRANSLATE(&quot;Select&quot;));</a>
<a name="ln336">				fOutputPathPanel-&gt;SetButtonLabel(B_CANCEL_BUTTON,</a>
<a name="ln337">					B_TRANSLATE(&quot;Cancel&quot;));</a>
<a name="ln338">			}</a>
<a name="ln339">			fOutputPathPanel-&gt;Show();</a>
<a name="ln340">			break;</a>
<a name="ln341">		}</a>
<a name="ln342"> </a>
<a name="ln343">		case B_REFS_RECEIVED:</a>
<a name="ln344">		{</a>
<a name="ln345">			entry_ref ref;</a>
<a name="ln346">			if (message-&gt;FindRef(&quot;refs&quot;, &amp;ref) == B_OK) {</a>
<a name="ln347">				BEntry entry(&amp;ref, true);</a>
<a name="ln348">				if (entry.InitCheck() == B_OK) {</a>
<a name="ln349">					BPath path;</a>
<a name="ln350">					if (entry.GetPath(&amp;path) == B_OK) {</a>
<a name="ln351">						BString label(path.Path());</a>
<a name="ln352">						_AddItemToPathMenu(path.Path(), label, 3, true);</a>
<a name="ln353">					}</a>
<a name="ln354">				}</a>
<a name="ln355">			}</a>
<a name="ln356">			break;</a>
<a name="ln357">		}</a>
<a name="ln358"> </a>
<a name="ln359">		case B_CANCEL:</a>
<a name="ln360">			fLastSelectedPath-&gt;SetMarked(true);</a>
<a name="ln361">			break;</a>
<a name="ln362"> </a>
<a name="ln363">		case kSaveScreenshot:</a>
<a name="ln364">			if (_SaveScreenshot() == B_OK)</a>
<a name="ln365">				be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln366">			break;</a>
<a name="ln367"> </a>
<a name="ln368">		case B_COPY:</a>
<a name="ln369">			fUtility.CopyToClipboard(fScreenshot);</a>
<a name="ln370">			break;</a>
<a name="ln371"> </a>
<a name="ln372">		case kSettings:</a>
<a name="ln373">			_ShowSettings(true);</a>
<a name="ln374">			break;</a>
<a name="ln375"> </a>
<a name="ln376">		case kCloseTranslatorSettings:</a>
<a name="ln377">			fSettingsWindow-&gt;Lock();</a>
<a name="ln378">			fSettingsWindow-&gt;Quit();</a>
<a name="ln379">			fSettingsWindow = NULL;</a>
<a name="ln380">			break;</a>
<a name="ln381"> </a>
<a name="ln382">		default:</a>
<a name="ln383">			BWindow::MessageReceived(message);</a>
<a name="ln384">			break;</a>
<a name="ln385">	}</a>
<a name="ln386">}</a>
<a name="ln387"> </a>
<a name="ln388"> </a>
<a name="ln389">void</a>
<a name="ln390">ScreenshotWindow::Quit()</a>
<a name="ln391">{</a>
<a name="ln392">	if (fUtility.wholeScreen != NULL)</a>
<a name="ln393">		_WriteSettings();</a>
<a name="ln394">	BWindow::Quit();</a>
<a name="ln395">}</a>
<a name="ln396"> </a>
<a name="ln397"> </a>
<a name="ln398">void</a>
<a name="ln399">ScreenshotWindow::_NewScreenshot(bool silent, bool clipboard, bool ignoreDelay)</a>
<a name="ln400">{</a>
<a name="ln401">	BMessage message(B_ARGV_RECEIVED);</a>
<a name="ln402">	int32 argc = 1;</a>
<a name="ln403">	message.AddString(&quot;argv&quot;, &quot;screenshot&quot;);</a>
<a name="ln404"> </a>
<a name="ln405">	if (!ignoreDelay) {</a>
<a name="ln406">		argc += 2;</a>
<a name="ln407">		BString delay;</a>
<a name="ln408">		delay &lt;&lt; fDelay / 1000000;</a>
<a name="ln409">		message.AddString(&quot;argv&quot;, &quot;--delay&quot;);</a>
<a name="ln410">		message.AddString(&quot;argv&quot;, delay);</a>
<a name="ln411">	}</a>
<a name="ln412"> </a>
<a name="ln413">	if (silent || clipboard) {</a>
<a name="ln414">		if (silent) {</a>
<a name="ln415">			argc++;</a>
<a name="ln416">			message.AddString(&quot;argv&quot;, &quot;--silent&quot;);</a>
<a name="ln417">		}</a>
<a name="ln418">		if (clipboard) {</a>
<a name="ln419">			argc++;</a>
<a name="ln420">			message.AddString(&quot;argv&quot;, &quot;--clipboard&quot;);</a>
<a name="ln421">		}</a>
<a name="ln422">		if (fIncludeBorder) {</a>
<a name="ln423">			argc++;</a>
<a name="ln424">			message.AddString(&quot;argv&quot;, &quot;--border&quot;);</a>
<a name="ln425">		}</a>
<a name="ln426">		if (fIncludeCursor) {</a>
<a name="ln427">			argc++;</a>
<a name="ln428">			message.AddString(&quot;argv&quot;, &quot;--mouse-pointer&quot;);</a>
<a name="ln429">		}</a>
<a name="ln430">		if (fGrabActiveWindow) {</a>
<a name="ln431">			argc++;</a>
<a name="ln432">			message.AddString(&quot;argv&quot;, &quot;--window&quot;);</a>
<a name="ln433">		}</a>
<a name="ln434">		if (fLastSelectedPath) {</a>
<a name="ln435">			BPath path(_GetDirectory());</a>
<a name="ln436">			if (path != NULL) {</a>
<a name="ln437">				path.Append(fNameControl-&gt;Text());</a>
<a name="ln438">				argc++;</a>
<a name="ln439">				message.AddString(&quot;argv&quot;, path.Path());</a>
<a name="ln440">			}</a>
<a name="ln441">		}</a>
<a name="ln442">	}</a>
<a name="ln443">	message.AddInt32(&quot;argc&quot;, argc);</a>
<a name="ln444"> </a>
<a name="ln445">	be_roster-&gt;Launch(&quot;application/x-vnd.haiku-screenshot-cli&quot;, &amp;message);</a>
<a name="ln446">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln447">}</a>
<a name="ln448"> </a>
<a name="ln449"> </a>
<a name="ln450">void</a>
<a name="ln451">ScreenshotWindow::_UpdatePreviewPanel()</a>
<a name="ln452">{</a>
<a name="ln453">	// Set the height of fPreview to what the layout suggests</a>
<a name="ln454">	fPreview-&gt;SetExplicitMinSize(BSize());</a>
<a name="ln455">	fPreview-&gt;SetExplicitMaxSize(BSize());</a>
<a name="ln456">	Layout(false);</a>
<a name="ln457"> </a>
<a name="ln458">	float height = fPreview-&gt;Bounds().Height();</a>
<a name="ln459">	float width = (fScreenshot-&gt;Bounds().Width()</a>
<a name="ln460">		/ fScreenshot-&gt;Bounds().Height()) * height;</a>
<a name="ln461"> </a>
<a name="ln462">	// to prevent a preview way too wide</a>
<a name="ln463">	if (width &gt; 400.0f) {</a>
<a name="ln464">		width = 400.0f;</a>
<a name="ln465">		height = (fScreenshot-&gt;Bounds().Height()</a>
<a name="ln466">			/ fScreenshot-&gt;Bounds().Width()) * width;</a>
<a name="ln467">	}</a>
<a name="ln468"> </a>
<a name="ln469">	fPreview-&gt;SetExplicitMinSize(BSize(width, height));</a>
<a name="ln470">	fPreview-&gt;SetExplicitMaxSize(BSize(width, height));</a>
<a name="ln471"> </a>
<a name="ln472">	fPreview-&gt;ClearViewBitmap();</a>
<a name="ln473">	fPreview-&gt;SetViewBitmap(fScreenshot, fScreenshot-&gt;Bounds(),</a>
<a name="ln474">		fPreview-&gt;Bounds(), B_FOLLOW_ALL, B_FILTER_BITMAP_BILINEAR);</a>
<a name="ln475">}</a>
<a name="ln476"> </a>
<a name="ln477"> </a>
<a name="ln478">void</a>
<a name="ln479">ScreenshotWindow::_DisallowChar(BTextView* textView)</a>
<a name="ln480">{</a>
<a name="ln481">	for (uint32 i = 0; i &lt; '0'; ++i)</a>
<a name="ln482">		textView-&gt;DisallowChar(i);</a>
<a name="ln483"> </a>
<a name="ln484">	for (uint32 i = '9' + 1; i &lt; 255; ++i)</a>
<a name="ln485">		textView-&gt;DisallowChar(i);</a>
<a name="ln486">}</a>
<a name="ln487"> </a>
<a name="ln488"> </a>
<a name="ln489">void</a>
<a name="ln490">ScreenshotWindow::_SetupOutputPathMenu(const BMessage&amp; settings)</a>
<a name="ln491">{</a>
<a name="ln492">	fOutputPathMenu-&gt;SetLabelFromMarked(true);</a>
<a name="ln493"> </a>
<a name="ln494">	BString lastSelectedPath;</a>
<a name="ln495">	settings.FindString(&quot;lastSelectedPath&quot;, &amp;lastSelectedPath);</a>
<a name="ln496"> </a>
<a name="ln497">	BPath path;</a>
<a name="ln498">	find_directory(B_USER_DIRECTORY, &amp;path);</a>
<a name="ln499"> </a>
<a name="ln500">	BString label(B_TRANSLATE(&quot;Home folder&quot;));</a>
<a name="ln501">	_AddItemToPathMenu(path.Path(), label, 0,</a>
<a name="ln502">		path.Path() == lastSelectedPath, 'H');</a>
<a name="ln503"> </a>
<a name="ln504">	path.Append(&quot;Desktop&quot;);</a>
<a name="ln505">	label.SetTo(B_TRANSLATE(&quot;Desktop&quot;));</a>
<a name="ln506">	_AddItemToPathMenu(path.Path(), label, 0,</a>
<a name="ln507">		path.Path() == lastSelectedPath, 'D');</a>
<a name="ln508"> </a>
<a name="ln509">	find_directory(B_USER_NONPACKAGED_DATA_DIRECTORY, &amp;path);</a>
<a name="ln510">	path.Append(&quot;artwork&quot;);</a>
<a name="ln511"> </a>
<a name="ln512">	label.SetTo(B_TRANSLATE(&quot;Artwork folder&quot;));</a>
<a name="ln513">	_AddItemToPathMenu(path.Path(), label, 2,</a>
<a name="ln514">		path.Path() == lastSelectedPath, 'A');</a>
<a name="ln515"> </a>
<a name="ln516">	int32 i = 0;</a>
<a name="ln517">	BString userPath;</a>
<a name="ln518">	while (settings.FindString(&quot;path&quot;, ++i, &amp;userPath) == B_OK) {</a>
<a name="ln519">		_AddItemToPathMenu(userPath.String(), userPath, 3,</a>
<a name="ln520">			userPath == lastSelectedPath);</a>
<a name="ln521">	}</a>
<a name="ln522"> </a>
<a name="ln523">	if (!fLastSelectedPath) {</a>
<a name="ln524">		if (settings.IsEmpty() || lastSelectedPath.Length() == 0) {</a>
<a name="ln525">			fOutputPathMenu-&gt;ItemAt(1)-&gt;SetMarked(true);</a>
<a name="ln526">			fLastSelectedPath = fOutputPathMenu-&gt;ItemAt(1);</a>
<a name="ln527">		} else {</a>
<a name="ln528">			_AddItemToPathMenu(lastSelectedPath.String(), lastSelectedPath, 3,</a>
<a name="ln529">				true);</a>
<a name="ln530">		}</a>
<a name="ln531">	}</a>
<a name="ln532"> </a>
<a name="ln533">	fOutputPathMenu-&gt;AddItem(new BSeparatorItem());</a>
<a name="ln534">	fOutputPathMenu-&gt;AddItem(new BMenuItem(</a>
<a name="ln535">		B_TRANSLATE(&quot;Choose folder&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln536">		new BMessage(kChooseLocation), 'F'));</a>
<a name="ln537">}</a>
<a name="ln538"> </a>
<a name="ln539"> </a>
<a name="ln540">void</a>
<a name="ln541">ScreenshotWindow::_AddItemToPathMenu(const char* path, BString&amp; label,</a>
<a name="ln542">	int32 index, bool markItem, uint32 shortcutKey)</a>
<a name="ln543">{</a>
<a name="ln544">	// Make sure that item won't be a duplicate of an existing one</a>
<a name="ln545">	for (int32 i = fOutputPathMenu-&gt;CountItems() - 1; i &gt;= 0; --i) {</a>
<a name="ln546">		BMenuItem* menuItem = fOutputPathMenu-&gt;ItemAt(i);</a>
<a name="ln547">		BMessage* message = menuItem-&gt;Message();</a>
<a name="ln548">		const char* pathFromItem;</a>
<a name="ln549">		if (message != NULL &amp;&amp; message-&gt;what == kLocationChanged</a>
<a name="ln550">			&amp;&amp; message-&gt;FindString(&quot;path&quot;, &amp;pathFromItem) == B_OK</a>
<a name="ln551">			&amp;&amp; !strcmp(path, pathFromItem)) {</a>
<a name="ln552"> </a>
<a name="ln553">			if (markItem) {</a>
<a name="ln554">				fOutputPathMenu-&gt;ItemAt(i)-&gt;SetMarked(true);</a>
<a name="ln555">				fLastSelectedPath = fOutputPathMenu-&gt;ItemAt(i);</a>
<a name="ln556">			}</a>
<a name="ln557">			return;</a>
<a name="ln558">		}</a>
<a name="ln559">	}</a>
<a name="ln560"> </a>
<a name="ln561">	BMessage* message = new BMessage(kLocationChanged);</a>
<a name="ln562">	message-&gt;AddString(&quot;path&quot;, path);</a>
<a name="ln563"> </a>
<a name="ln564">	fOutputPathMenu-&gt;TruncateString(&amp;label, B_TRUNCATE_MIDDLE,</a>
<a name="ln565">		fOutputPathMenu-&gt;StringWidth(&quot;SomethingLongHere&quot;));</a>
<a name="ln566"> </a>
<a name="ln567">	fOutputPathMenu-&gt;AddItem(new BMenuItem(label.String(), message,</a>
<a name="ln568">		shortcutKey), index);</a>
<a name="ln569"> </a>
<a name="ln570">	if (markItem) {</a>
<a name="ln571">		fOutputPathMenu-&gt;ItemAt(index)-&gt;SetMarked(true);</a>
<a name="ln572">		fLastSelectedPath = fOutputPathMenu-&gt;ItemAt(index);</a>
<a name="ln573">	}</a>
<a name="ln574">}</a>
<a name="ln575"> </a>
<a name="ln576"> </a>
<a name="ln577">void</a>
<a name="ln578">ScreenshotWindow::_UpdateFilenameSelection()</a>
<a name="ln579">{</a>
<a name="ln580">	fNameControl-&gt;MakeFocus(true);</a>
<a name="ln581">	fNameControl-&gt;TextView()-&gt;Select(0,	fNameControl-&gt;TextView()-&gt;TextLength()</a>
<a name="ln582">		- fExtension.Length());</a>
<a name="ln583"> </a>
<a name="ln584">	fNameControl-&gt;TextView()-&gt;ScrollToSelection();</a>
<a name="ln585">}</a>
<a name="ln586"> </a>
<a name="ln587"> </a>
<a name="ln588">void</a>
<a name="ln589">ScreenshotWindow::_SetupTranslatorMenu()</a>
<a name="ln590">{</a>
<a name="ln591">	BMessage message(kImageFormat);</a>
<a name="ln592">	fTranslatorMenu = new BMenu(&quot;Please select&quot;);</a>
<a name="ln593">	BTranslationUtils::AddTranslationItems(fTranslatorMenu, B_TRANSLATOR_BITMAP,</a>
<a name="ln594">		&amp;message, NULL, NULL, NULL);</a>
<a name="ln595"> </a>
<a name="ln596">	fTranslatorMenu-&gt;SetLabelFromMarked(true);</a>
<a name="ln597"> </a>
<a name="ln598">	if (fTranslatorMenu-&gt;ItemAt(0))</a>
<a name="ln599">		fTranslatorMenu-&gt;ItemAt(0)-&gt;SetMarked(true);</a>
<a name="ln600"> </a>
<a name="ln601">	int32 imageFileType;</a>
<a name="ln602">	for (int32 i = 0; i &lt; fTranslatorMenu-&gt;CountItems(); ++i) {</a>
<a name="ln603">		BMenuItem* item = fTranslatorMenu-&gt;ItemAt(i);</a>
<a name="ln604">		if (item != NULL &amp;&amp; item-&gt;Message()) {</a>
<a name="ln605">			item-&gt;Message()-&gt;FindInt32(&quot;be:type&quot;, &amp;imageFileType);</a>
<a name="ln606">			if (fImageFileType == imageFileType) {</a>
<a name="ln607">				item-&gt;SetMarked(true);</a>
<a name="ln608">				MessageReceived(item-&gt;Message());</a>
<a name="ln609">				break;</a>
<a name="ln610">			}</a>
<a name="ln611">		}</a>
<a name="ln612">	}</a>
<a name="ln613">}</a>
<a name="ln614"> </a>
<a name="ln615"> </a>
<a name="ln616">void</a>
<a name="ln617">ScreenshotWindow::_DisplaySaveError(BString _message) {</a>
<a name="ln618">	BString alertText;</a>
<a name="ln619">	alertText.SetToFormat(B_TRANSLATE(&quot;Error saving \&quot;%s\&quot;:\n\t%s&quot;),</a>
<a name="ln620">		fNameControl-&gt;Text(), _message.String());</a>
<a name="ln621"> </a>
<a name="ln622">	BAlert* alert = new BAlert(B_TRANSLATE(&quot;Failed to save screenshot&quot;),</a>
<a name="ln623">		alertText.String(),	B_TRANSLATE(&quot;OK&quot;),</a>
<a name="ln624">		NULL, NULL, B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln625"> </a>
<a name="ln626">	alert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln627">	alert-&gt;Go();</a>
<a name="ln628">}</a>
<a name="ln629"> </a>
<a name="ln630"> </a>
<a name="ln631">status_t</a>
<a name="ln632">ScreenshotWindow::_SaveScreenshot()</a>
<a name="ln633">{</a>
<a name="ln634">	if (!fScreenshot || !fLastSelectedPath)</a>
<a name="ln635">		return B_ERROR;</a>
<a name="ln636"> </a>
<a name="ln637">	BPath path(_GetDirectory());</a>
<a name="ln638"> </a>
<a name="ln639">	if (path == NULL)</a>
<a name="ln640">		return B_ERROR;</a>
<a name="ln641"> </a>
<a name="ln642">	BEntry directoryEntry;</a>
<a name="ln643">	directoryEntry.SetTo(path.Path());</a>
<a name="ln644"> </a>
<a name="ln645">	// create folder if it doesn't exist</a>
<a name="ln646">	// necessary, for example, when the user selects the Artwork folder from</a>
<a name="ln647">	// the list of predefined folders.</a>
<a name="ln648">	if (!directoryEntry.Exists()) {</a>
<a name="ln649">		status_t directoryCreateStatus = create_directory(path.Path(), 0755);</a>
<a name="ln650">		if (directoryCreateStatus != B_OK) {</a>
<a name="ln651">			_DisplaySaveError(strerror(directoryCreateStatus));</a>
<a name="ln652"> </a>
<a name="ln653">			return directoryCreateStatus;</a>
<a name="ln654">		}</a>
<a name="ln655">	} else if (!directoryEntry.IsDirectory()) {</a>
<a name="ln656">		// the entry exists but is not a directory.</a>
<a name="ln657">		// not much we can do</a>
<a name="ln658">		_DisplaySaveError(</a>
<a name="ln659">			B_TRANSLATE(&quot;The destination path exists but is not a folder.&quot;));</a>
<a name="ln660"> </a>
<a name="ln661">		return B_NOT_A_DIRECTORY;</a>
<a name="ln662">	}</a>
<a name="ln663"> </a>
<a name="ln664">	path.Append(fNameControl-&gt;Text());</a>
<a name="ln665"> </a>
<a name="ln666">	BEntry entry;</a>
<a name="ln667">	entry.SetTo(path.Path());</a>
<a name="ln668"> </a>
<a name="ln669">	if (entry.Exists()) {</a>
<a name="ln670">		BAlert* overwriteAlert = new BAlert(</a>
<a name="ln671">			B_TRANSLATE(&quot;overwrite&quot;),</a>
<a name="ln672">			B_TRANSLATE(&quot;This file already exists.\n Are you sure you would &quot;</a>
<a name="ln673">				&quot;like to overwrite it?&quot;),</a>
<a name="ln674">			B_TRANSLATE(&quot;Cancel&quot;),</a>
<a name="ln675">			B_TRANSLATE(&quot;Overwrite&quot;),</a>
<a name="ln676">			NULL, B_WIDTH_AS_USUAL, B_EVEN_SPACING, B_WARNING_ALERT);</a>
<a name="ln677"> </a>
<a name="ln678">		overwriteAlert-&gt;SetShortcut(0, B_ESCAPE);</a>
<a name="ln679"> </a>
<a name="ln680">		if (overwriteAlert-&gt;Go() == 0)</a>
<a name="ln681">			return B_CANCELED;</a>
<a name="ln682">	}</a>
<a name="ln683"> </a>
<a name="ln684">	status_t saveStatus = fUtility.Save(fScreenshot,</a>
<a name="ln685">		path.Path(), fImageFileType);</a>
<a name="ln686"> </a>
<a name="ln687">	if (saveStatus != B_OK) {</a>
<a name="ln688">		_DisplaySaveError(strerror(saveStatus));</a>
<a name="ln689">		return saveStatus;</a>
<a name="ln690">	}</a>
<a name="ln691">	return B_OK;</a>
<a name="ln692">}</a>
<a name="ln693"> </a>
<a name="ln694"> </a>
<a name="ln695">void</a>
<a name="ln696">ScreenshotWindow::_ShowSettings(bool activate)</a>
<a name="ln697">{</a>
<a name="ln698">	if (!fSettingsWindow &amp;&amp; !activate)</a>
<a name="ln699">		return;</a>
<a name="ln700"> </a>
<a name="ln701">	// Find a translator</a>
<a name="ln702">	translator_id translator;</a>
<a name="ln703">	if (fUtility.FindTranslator(fImageFileType, translator) != B_OK)</a>
<a name="ln704">		return;</a>
<a name="ln705"> </a>
<a name="ln706">	// Create a window with a configuration view</a>
<a name="ln707">	BView* view;</a>
<a name="ln708">	BRect rect(0, 0, 239, 239);</a>
<a name="ln709"> </a>
<a name="ln710">	status_t status = BTranslatorRoster::Default()-&gt;MakeConfigurationView(</a>
<a name="ln711">		translator, NULL, &amp;view, &amp;rect);</a>
<a name="ln712">	if (status != B_OK || view == NULL) {</a>
<a name="ln713">		// TODO: proper translation, better error dialog</a>
<a name="ln714">		BAlert* alert = new BAlert(NULL, strerror(status), &quot;OK&quot;);</a>
<a name="ln715">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln716">		alert-&gt;Go();</a>
<a name="ln717">	} else if (fSettingsWindow != NULL) {</a>
<a name="ln718">		fSettingsWindow-&gt;RemoveChild(fSettingsWindow-&gt;ChildAt(0));</a>
<a name="ln719">		float width, height;</a>
<a name="ln720">		view-&gt;GetPreferredSize(&amp;width, &amp;height);</a>
<a name="ln721">		fSettingsWindow-&gt;ResizeTo(width, height);</a>
<a name="ln722">		fSettingsWindow-&gt;AddChild(view);</a>
<a name="ln723">		if (activate)</a>
<a name="ln724">			fSettingsWindow-&gt;Activate();</a>
<a name="ln725">	} else {</a>
<a name="ln726">		fSettingsWindow = new BWindow(rect,</a>
<a name="ln727">			B_TRANSLATE(&quot;Translator Settings&quot;),</a>
<a name="ln728">			B_TITLED_WINDOW_LOOK, B_NORMAL_WINDOW_FEEL,</a>
<a name="ln729">			B_NOT_ZOOMABLE | B_NOT_RESIZABLE);</a>
<a name="ln730">		fSettingsWindow-&gt;AddFilter(new QuitMessageFilter(this));</a>
<a name="ln731">		fSettingsWindow-&gt;AddChild(view);</a>
<a name="ln732">		fSettingsWindow-&gt;CenterOnScreen();</a>
<a name="ln733">		fSettingsWindow-&gt;Show();</a>
<a name="ln734">	}</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737"> </a>
<a name="ln738">BString</a>
<a name="ln739">ScreenshotWindow::_FindValidFileName(const char* name)</a>
<a name="ln740">{</a>
<a name="ln741">	BString baseName(name);</a>
<a name="ln742"> </a>
<a name="ln743">	if (!fExtension.IsEmpty())</a>
<a name="ln744">		baseName.RemoveLast(fExtension);</a>
<a name="ln745"> </a>
<a name="ln746">	if (!fLastSelectedPath)</a>
<a name="ln747">		return baseName;</a>
<a name="ln748"> </a>
<a name="ln749">	BPath orgPath(_GetDirectory());</a>
<a name="ln750">	if (orgPath == NULL)</a>
<a name="ln751">		return baseName;</a>
<a name="ln752"> </a>
<a name="ln753">	fExtension = fUtility.FileNameExtension(fImageFileType);</a>
<a name="ln754"> </a>
<a name="ln755">	BPath outputPath = orgPath;</a>
<a name="ln756">	BString fileName;</a>
<a name="ln757">	fileName &lt;&lt; baseName &lt;&lt; fExtension;</a>
<a name="ln758">	outputPath.Append(fileName);</a>
<a name="ln759"> </a>
<a name="ln760">	if (!BEntry(outputPath.Path()).Exists())</a>
<a name="ln761">		return fileName;</a>
<a name="ln762"> </a>
<a name="ln763">	if (baseName.FindFirst(B_TRANSLATE_NOCOLLECT(</a>
<a name="ln764">			fUtility.sDefaultFileNameBase)) == 0)</a>
<a name="ln765">		baseName.SetTo(fUtility.sDefaultFileNameBase);</a>
<a name="ln766"> </a>
<a name="ln767">	BEntry entry;</a>
<a name="ln768">	int32 index = 1;</a>
<a name="ln769"> </a>
<a name="ln770">	do {</a>
<a name="ln771">		fileName = &quot;&quot;;</a>
<a name="ln772">		fileName &lt;&lt; baseName &lt;&lt; index++ &lt;&lt; fExtension;</a>
<a name="ln773">		outputPath.SetTo(orgPath.Path());</a>
<a name="ln774">		outputPath.Append(fileName);</a>
<a name="ln775">		entry.SetTo(outputPath.Path());</a>
<a name="ln776">	} while (entry.Exists());</a>
<a name="ln777"> </a>
<a name="ln778">	return fileName;</a>
<a name="ln779">}</a>
<a name="ln780"> </a>
<a name="ln781"> </a>
<a name="ln782">BPath</a>
<a name="ln783">ScreenshotWindow::_GetDirectory()</a>
<a name="ln784">{</a>
<a name="ln785">	BPath path;</a>
<a name="ln786"> </a>
<a name="ln787">	BMessage* message = fLastSelectedPath-&gt;Message();</a>
<a name="ln788">	const char* stringPath;</a>
<a name="ln789">	if (message &amp;&amp; message-&gt;FindString(&quot;path&quot;, &amp;stringPath) == B_OK)</a>
<a name="ln790">		path.SetTo(stringPath);</a>
<a name="ln791"> </a>
<a name="ln792">	return path;</a>
<a name="ln793">}</a>
<a name="ln794"> </a>
<a name="ln795"> </a>
<a name="ln796">void</a>
<a name="ln797">ScreenshotWindow::_ReadSettings()</a>
<a name="ln798">{</a>
<a name="ln799">	BMessage settings;</a>
<a name="ln800"> </a>
<a name="ln801">	BPath settingsPath;</a>
<a name="ln802">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;settingsPath) != B_OK)</a>
<a name="ln803">		return;</a>
<a name="ln804"> </a>
<a name="ln805">	settingsPath.Append(&quot;Screenshot_settings&quot;);</a>
<a name="ln806"> </a>
<a name="ln807">	BFile file(settingsPath.Path(), B_READ_ONLY);</a>
<a name="ln808">	if (file.InitCheck() == B_OK)</a>
<a name="ln809">		settings.Unflatten(&amp;file);</a>
<a name="ln810"> </a>
<a name="ln811">	if (settings.FindInt32(&quot;type&quot;, &amp;fImageFileType) != B_OK)</a>
<a name="ln812">		fImageFileType = B_PNG_FORMAT;</a>
<a name="ln813">	settings.FindBool(&quot;includeBorder&quot;, &amp;fIncludeBorder);</a>
<a name="ln814">	settings.FindBool(&quot;includeCursor&quot;, &amp;fIncludeCursor);</a>
<a name="ln815">	settings.FindBool(&quot;grabActiveWindow&quot;, &amp;fGrabActiveWindow);</a>
<a name="ln816">	settings.FindInt64(&quot;delay&quot;, &amp;fDelay);</a>
<a name="ln817">	settings.FindString(&quot;outputFilename&quot;, &amp;fOutputFilename);</a>
<a name="ln818"> </a>
<a name="ln819">	_SetupOutputPathMenu(settings);</a>
<a name="ln820">}</a>
<a name="ln821"> </a>
<a name="ln822"> </a>
<a name="ln823">void</a>
<a name="ln824">ScreenshotWindow::_WriteSettings()</a>
<a name="ln825">{</a>
<a name="ln826">	if (fDelayControl)</a>
<a name="ln827">		fDelay = (atoi(fDelayControl-&gt;Text()) * 1000000) + 50000;</a>
<a name="ln828"> </a>
<a name="ln829">	BMessage settings;</a>
<a name="ln830"> </a>
<a name="ln831">	settings.AddInt32(&quot;type&quot;, fImageFileType);</a>
<a name="ln832">	settings.AddBool(&quot;includeBorder&quot;, fIncludeBorder);</a>
<a name="ln833">	settings.AddBool(&quot;includeCursor&quot;, fIncludeCursor);</a>
<a name="ln834">	settings.AddBool(&quot;grabActiveWindow&quot;, fGrabActiveWindow);</a>
<a name="ln835">	settings.AddInt64(&quot;delay&quot;, fDelay);</a>
<a name="ln836">	settings.AddString(&quot;outputFilename&quot;, fOutputFilename);</a>
<a name="ln837"> </a>
<a name="ln838">	BString path;</a>
<a name="ln839">	int32 count = fOutputPathMenu-&gt;CountItems();</a>
<a name="ln840">	if (count &gt; 5) {</a>
<a name="ln841">		for (int32 i = count - 3; i &gt; count - 8 &amp;&amp; i &gt; 2; --i) {</a>
<a name="ln842">			BMenuItem* item = fOutputPathMenu-&gt;ItemAt(i);</a>
<a name="ln843">			if (item) {</a>
<a name="ln844">				BMessage* msg = item-&gt;Message();</a>
<a name="ln845">				if (msg &amp;&amp; msg-&gt;FindString(&quot;path&quot;, &amp;path) == B_OK)</a>
<a name="ln846">					settings.AddString(&quot;path&quot;, path.String());</a>
<a name="ln847">			}</a>
<a name="ln848">		}</a>
<a name="ln849">	}</a>
<a name="ln850"> </a>
<a name="ln851">	if (fLastSelectedPath) {</a>
<a name="ln852">		BMessage* msg = fLastSelectedPath-&gt;Message();</a>
<a name="ln853">		if (msg &amp;&amp; msg-&gt;FindString(&quot;path&quot;, &amp;path) == B_OK)</a>
<a name="ln854">			settings.AddString(&quot;lastSelectedPath&quot;, path.String());</a>
<a name="ln855">	}</a>
<a name="ln856"> </a>
<a name="ln857">	BPath settingsPath;</a>
<a name="ln858">	if (find_directory(B_USER_SETTINGS_DIRECTORY, &amp;settingsPath) != B_OK)</a>
<a name="ln859">		return;</a>
<a name="ln860">	settingsPath.Append(&quot;Screenshot_settings&quot;);</a>
<a name="ln861"> </a>
<a name="ln862">	BFile file(settingsPath.Path(), B_CREATE_FILE | B_ERASE_FILE</a>
<a name="ln863">		| B_WRITE_ONLY);</a>
<a name="ln864">	if (file.InitCheck() == B_OK) {</a>
<a name="ln865">		ssize_t size;</a>
<a name="ln866">		settings.Flatten(&amp;file, &amp;size);</a>
<a name="ln867">	}</a>
<a name="ln868">}</a>

</code></pre>
<div class="balloon" rel="254"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'divider' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="681"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'overwriteAlert' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="142"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v607/" target="_blank">V607</a> Ownerless expression 'name << 1'.</p></div>
<div class="balloon" rel="628"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="254"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'menuLocation' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="254"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'menuFormat' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="717"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
