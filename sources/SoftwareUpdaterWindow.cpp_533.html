
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>SoftwareUpdaterWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2016-2019 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT license</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Alexander von Gluck IV &lt;kallisti5@unixzen.com&gt;</a>
<a name="ln7"> *		Brian Hill &lt;supernova@tycho.email&gt;</a>
<a name="ln8"> *		Jacob Secunda</a>
<a name="ln9"> */</a>
<a name="ln10"> </a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;SoftwareUpdaterWindow.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;Alert.h&gt;</a>
<a name="ln15">#include &lt;AppDefs.h&gt;</a>
<a name="ln16">#include &lt;Application.h&gt;</a>
<a name="ln17">#include &lt;Catalog.h&gt;</a>
<a name="ln18">#include &lt;ControlLook.h&gt;</a>
<a name="ln19">#include &lt;FindDirectory.h&gt;</a>
<a name="ln20">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln21">#include &lt;LayoutUtils.h&gt;</a>
<a name="ln22">#include &lt;Message.h&gt;</a>
<a name="ln23">#include &lt;Roster.h&gt;</a>
<a name="ln24">#include &lt;RosterPrivate.h&gt;</a>
<a name="ln25">#include &lt;Screen.h&gt;</a>
<a name="ln26">#include &lt;String.h&gt;</a>
<a name="ln27"> </a>
<a name="ln28">#include &quot;constants.h&quot;</a>
<a name="ln29"> </a>
<a name="ln30">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln31">#define B_TRANSLATION_CONTEXT &quot;SoftwareUpdaterWindow&quot;</a>
<a name="ln32"> </a>
<a name="ln33"> </a>
<a name="ln34">SoftwareUpdaterWindow::SoftwareUpdaterWindow()</a>
<a name="ln35">	:</a>
<a name="ln36">	BWindow(BRect(0, 0, 300, 10),</a>
<a name="ln37">		B_TRANSLATE_SYSTEM_NAME(&quot;SoftwareUpdater&quot;), B_TITLED_WINDOW,</a>
<a name="ln38">		B_AUTO_UPDATE_SIZE_LIMITS | B_NOT_ZOOMABLE | B_NOT_RESIZABLE),</a>
<a name="ln39">	fStripeView(NULL),</a>
<a name="ln40">	fHeaderView(NULL),</a>
<a name="ln41">	fDetailView(NULL),</a>
<a name="ln42">	fUpdateButton(NULL),</a>
<a name="ln43">	fCancelButton(NULL),</a>
<a name="ln44">	fStatusBar(NULL),</a>
<a name="ln45">	fCurrentState(STATE_HEAD),</a>
<a name="ln46">	fWaitingSem(-1),</a>
<a name="ln47">	fWaitingForButton(false),</a>
<a name="ln48">	fUpdateConfirmed(false),</a>
<a name="ln49">	fUserCancelRequested(false),</a>
<a name="ln50">	fWarningAlertCount(0),</a>
<a name="ln51">	fSettingsReadStatus(B_ERROR),</a>
<a name="ln52">	fSaveFrameChanges(false),</a>
<a name="ln53">	fMessageRunner(NULL),</a>
<a name="ln54">	fFrameChangeMessage(kMsgWindowFrameChanged)</a>
<a name="ln55">{</a>
<a name="ln56">	// Layout</a>
<a name="ln57">	BBitmap icon = GetIcon(32 * icon_layout_scale());</a>
<a name="ln58">	fStripeView = new BStripeView(icon);</a>
<a name="ln59"> </a>
<a name="ln60">	fUpdateButton = new BButton(B_TRANSLATE(&quot;Update now&quot;),</a>
<a name="ln61">		new BMessage(kMsgUpdateConfirmed));</a>
<a name="ln62">	fUpdateButton-&gt;MakeDefault(true);</a>
<a name="ln63">	fCancelButton = new BButton(B_TRANSLATE(&quot;Cancel&quot;),</a>
<a name="ln64">		new BMessage(kMsgCancel));</a>
<a name="ln65">	fRebootButton = new BButton(B_TRANSLATE(&quot;Reboot&quot;),</a>
<a name="ln66">		new BMessage(kMsgReboot));</a>
<a name="ln67"> </a>
<a name="ln68">	fHeaderView = new BStringView(&quot;header&quot;,</a>
<a name="ln69">		B_TRANSLATE(&quot;Checking for updates&quot;), B_WILL_DRAW);</a>
<a name="ln70">	fHeaderView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln71">	fHeaderView-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT, B_ALIGN_TOP));</a>
<a name="ln72">	fDetailView = new BStringView(&quot;detail&quot;, B_TRANSLATE(&quot;Contacting software &quot;</a>
<a name="ln73">		&quot;repositories to check for package updates.&quot;), B_WILL_DRAW);</a>
<a name="ln74">	fDetailView-&gt;SetExplicitMaxSize(BSize(B_SIZE_UNLIMITED, B_SIZE_UNSET));</a>
<a name="ln75">	fDetailView-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT, B_ALIGN_TOP));</a>
<a name="ln76">	fStatusBar = new BStatusBar(&quot;progress&quot;);</a>
<a name="ln77">	fStatusBar-&gt;SetMaxValue(100);</a>
<a name="ln78"> </a>
<a name="ln79">	fListView = new PackageListView();</a>
<a name="ln80">	fScrollView = new BScrollView(&quot;scrollview&quot;, fListView, B_WILL_DRAW,</a>
<a name="ln81">		false, true);</a>
<a name="ln82"> </a>
<a name="ln83">	fDetailsCheckbox = new BCheckBox(&quot;detailscheckbox&quot;,</a>
<a name="ln84">		B_TRANSLATE(&quot;Show more details&quot;),</a>
<a name="ln85">		new BMessage(kMsgMoreDetailsToggle));</a>
<a name="ln86"> </a>
<a name="ln87">	BFont font;</a>
<a name="ln88">	fHeaderView-&gt;GetFont(&amp;font);</a>
<a name="ln89">	font.SetFace(B_BOLD_FACE);</a>
<a name="ln90">	font.SetSize(font.Size() * 1.5);</a>
<a name="ln91">	fHeaderView-&gt;SetFont(&amp;font,</a>
<a name="ln92">		B_FONT_FAMILY_AND_STYLE | B_FONT_SIZE | B_FONT_FLAGS);</a>
<a name="ln93"> </a>
<a name="ln94">	BLayoutBuilder::Group&lt;&gt;(this, B_HORIZONTAL, B_USE_ITEM_SPACING)</a>
<a name="ln95">		.Add(fStripeView)</a>
<a name="ln96">		.AddGroup(B_VERTICAL, 0)</a>
<a name="ln97">			.SetInsets(0, B_USE_WINDOW_SPACING,</a>
<a name="ln98">				B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING)</a>
<a name="ln99">			.AddGroup(new BGroupView(B_VERTICAL, B_USE_ITEM_SPACING))</a>
<a name="ln100">				.Add(fHeaderView)</a>
<a name="ln101">				.Add(fDetailView)</a>
<a name="ln102">				.Add(fStatusBar)</a>
<a name="ln103">				.Add(fScrollView)</a>
<a name="ln104">			.End()</a>
<a name="ln105">			.AddStrut(B_USE_SMALL_SPACING)</a>
<a name="ln106">			.AddGroup(new BGroupView(B_HORIZONTAL))</a>
<a name="ln107">				.Add(fDetailsCheckbox)</a>
<a name="ln108">				.AddGlue()</a>
<a name="ln109">				.Add(fCancelButton)</a>
<a name="ln110">				.Add(fUpdateButton)</a>
<a name="ln111">				.Add(fRebootButton)</a>
<a name="ln112">			.End()</a>
<a name="ln113">		.End()</a>
<a name="ln114">	.End();</a>
<a name="ln115"> </a>
<a name="ln116">	fDetailsLayoutItem = layout_item_for(fDetailView);</a>
<a name="ln117">	fProgressLayoutItem = layout_item_for(fStatusBar);</a>
<a name="ln118">	fPackagesLayoutItem = layout_item_for(fScrollView);</a>
<a name="ln119">	fCancelButtonLayoutItem = layout_item_for(fCancelButton);</a>
<a name="ln120">	fUpdateButtonLayoutItem = layout_item_for(fUpdateButton);</a>
<a name="ln121">	fRebootButtonLayoutItem = layout_item_for(fRebootButton);</a>
<a name="ln122">	fDetailsCheckboxLayoutItem = layout_item_for(fDetailsCheckbox);</a>
<a name="ln123"> </a>
<a name="ln124">	_SetState(STATE_DISPLAY_STATUS);</a>
<a name="ln125">	CenterOnScreen();</a>
<a name="ln126">	SetFlags(Flags() ^ B_AUTO_UPDATE_SIZE_LIMITS);</a>
<a name="ln127"> </a>
<a name="ln128">	// Prevent resizing for now</a>
<a name="ln129">	fDefaultRect = Bounds();</a>
<a name="ln130">	SetSizeLimits(fDefaultRect.Width(), fDefaultRect.Width(),</a>
<a name="ln131">		fDefaultRect.Height(), fDefaultRect.Height());</a>
<a name="ln132"> </a>
<a name="ln133">	// Read settings file</a>
<a name="ln134">	status_t status = find_directory(B_USER_SETTINGS_DIRECTORY, &amp;fSettingsPath);</a>
<a name="ln135">	if (status == B_OK) {</a>
<a name="ln136">		fSettingsPath.Append(kSettingsFilename);</a>
<a name="ln137">		fSettingsReadStatus = _ReadSettings(fInitialSettings);</a>
<a name="ln138">	}</a>
<a name="ln139">	// Move to saved setting position</a>
<a name="ln140">	if (fSettingsReadStatus == B_OK) {</a>
<a name="ln141">		BRect windowFrame;</a>
<a name="ln142">		status = fInitialSettings.FindRect(kKeyWindowFrame, &amp;windowFrame);</a>
<a name="ln143">		if (status == B_OK) {</a>
<a name="ln144">			BScreen screen(this);</a>
<a name="ln145">			if (screen.Frame().Contains(windowFrame.LeftTop()))</a>
<a name="ln146">				MoveTo(windowFrame.LeftTop());</a>
<a name="ln147">		}</a>
<a name="ln148">	}</a>
<a name="ln149">	Show();</a>
<a name="ln150"> </a>
<a name="ln151">	BMessage registerMessage(kMsgRegister);</a>
<a name="ln152">	registerMessage.AddMessenger(kKeyMessenger, BMessenger(this));</a>
<a name="ln153">	be_app-&gt;PostMessage(&amp;registerMessage);</a>
<a name="ln154"> </a>
<a name="ln155">	fCancelAlertResponse.SetMessage(new BMessage(kMsgCancelResponse));</a>
<a name="ln156">	fCancelAlertResponse.SetTarget(this);</a>
<a name="ln157">	fWarningAlertDismissed.SetMessage(new BMessage(kMsgWarningDismissed));</a>
<a name="ln158">	fWarningAlertDismissed.SetTarget(this);</a>
<a name="ln159"> </a>
<a name="ln160">	// Common elements used for the zoom height and width calculations</a>
<a name="ln161">	fZoomHeightBaseline = 6</a>
<a name="ln162">		+ be_control_look-&gt;ComposeSpacing(B_USE_SMALL_SPACING)</a>
<a name="ln163">		+ 2 * be_control_look-&gt;ComposeSpacing(B_USE_WINDOW_SPACING);</a>
<a name="ln164">	fZoomWidthBaseline = fStripeView-&gt;PreferredSize().Width()</a>
<a name="ln165">		+ be_control_look-&gt;ComposeSpacing(B_USE_ITEM_SPACING)</a>
<a name="ln166">		+ fScrollView-&gt;ScrollBar(B_VERTICAL)-&gt;PreferredSize().Width()</a>
<a name="ln167">		+ be_control_look-&gt;ComposeSpacing(B_USE_WINDOW_SPACING);</a>
<a name="ln168">}</a>
<a name="ln169"> </a>
<a name="ln170"> </a>
<a name="ln171">bool</a>
<a name="ln172">SoftwareUpdaterWindow::QuitRequested()</a>
<a name="ln173">{</a>
<a name="ln174">	PostMessage(kMsgCancel);</a>
<a name="ln175">	return false;</a>
<a name="ln176">}</a>
<a name="ln177"> </a>
<a name="ln178"> </a>
<a name="ln179">void</a>
<a name="ln180">SoftwareUpdaterWindow::FrameMoved(BPoint newPosition)</a>
<a name="ln181">{</a>
<a name="ln182">	BWindow::FrameMoved(newPosition);</a>
<a name="ln183"> </a>
<a name="ln184">	// Create a message runner to consolidate all function calls from a</a>
<a name="ln185">	// move into one message post after moving has ceased for .5 seconds</a>
<a name="ln186">	if (fSaveFrameChanges) {</a>
<a name="ln187">		if (fMessageRunner == NULL) {</a>
<a name="ln188">			fMessageRunner = new BMessageRunner(this, &amp;fFrameChangeMessage,</a>
<a name="ln189">				500000, 1);</a>
<a name="ln190">		} else</a>
<a name="ln191">			fMessageRunner-&gt;SetInterval(500000);</a>
<a name="ln192">	}</a>
<a name="ln193">}</a>
<a name="ln194"> </a>
<a name="ln195"> </a>
<a name="ln196">void</a>
<a name="ln197">SoftwareUpdaterWindow::FrameResized(float newWidth, float newHeight)</a>
<a name="ln198">{</a>
<a name="ln199">	BWindow::FrameResized(newWidth, newHeight);</a>
<a name="ln200"> </a>
<a name="ln201">	// Create a message runner to consolidate all function calls from a</a>
<a name="ln202">	// resize into one message post after resizing has ceased for .5 seconds</a>
<a name="ln203">	if (fSaveFrameChanges) {</a>
<a name="ln204">		if (fMessageRunner == NULL) {</a>
<a name="ln205">			fMessageRunner = new BMessageRunner(this, &amp;fFrameChangeMessage,</a>
<a name="ln206">				500000, 1);</a>
<a name="ln207">		} else</a>
<a name="ln208">			fMessageRunner-&gt;SetInterval(500000);</a>
<a name="ln209">	}</a>
<a name="ln210">}</a>
<a name="ln211"> </a>
<a name="ln212"> </a>
<a name="ln213">void</a>
<a name="ln214">SoftwareUpdaterWindow::Zoom(BPoint origin, float width, float height)</a>
<a name="ln215">{</a>
<a name="ln216">	// Override default zoom behavior and keep window at same position instead</a>
<a name="ln217">	// of centering on screen</a>
<a name="ln218">	BWindow::Zoom(Frame().LeftTop(), width, height);</a>
<a name="ln219">}</a>
<a name="ln220"> </a>
<a name="ln221"> </a>
<a name="ln222">void</a>
<a name="ln223">SoftwareUpdaterWindow::MessageReceived(BMessage* message)</a>
<a name="ln224">{</a>
<a name="ln225">	switch (message-&gt;what) {</a>
<a name="ln226"> </a>
<a name="ln227">		case kMsgTextUpdate:</a>
<a name="ln228">		{</a>
<a name="ln229">			if (fCurrentState == STATE_DISPLAY_PROGRESS)</a>
<a name="ln230">				_SetState(STATE_DISPLAY_STATUS);</a>
<a name="ln231">			else if (fCurrentState != STATE_DISPLAY_STATUS)</a>
<a name="ln232">				break;</a>
<a name="ln233"> </a>
<a name="ln234">			BString header;</a>
<a name="ln235">			BString detail;</a>
<a name="ln236">			Lock();</a>
<a name="ln237">			status_t result = message-&gt;FindString(kKeyHeader, &amp;header);</a>
<a name="ln238">			if (result == B_OK &amp;&amp; header != fHeaderView-&gt;Text())</a>
<a name="ln239">				fHeaderView-&gt;SetText(header.String());</a>
<a name="ln240">			result = message-&gt;FindString(kKeyDetail, &amp;detail);</a>
<a name="ln241">			if (result == B_OK)</a>
<a name="ln242">				fDetailView-&gt;SetText(detail.String());</a>
<a name="ln243">			Unlock();</a>
<a name="ln244">			break;</a>
<a name="ln245">		}</a>
<a name="ln246"> </a>
<a name="ln247">		case kMsgProgressUpdate:</a>
<a name="ln248">		{</a>
<a name="ln249">			if (fCurrentState == STATE_DISPLAY_STATUS)</a>
<a name="ln250">				_SetState(STATE_DISPLAY_PROGRESS);</a>
<a name="ln251">			else if (fCurrentState != STATE_DISPLAY_PROGRESS)</a>
<a name="ln252">				break;</a>
<a name="ln253"> </a>
<a name="ln254">			BString packageName;</a>
<a name="ln255">			status_t result = message-&gt;FindString(kKeyPackageName,</a>
<a name="ln256">				&amp;packageName);</a>
<a name="ln257">			if (result != B_OK)</a>
<a name="ln258">				break;</a>
<a name="ln259">			BString packageCount;</a>
<a name="ln260">			result = message-&gt;FindString(kKeyPackageCount, &amp;packageCount);</a>
<a name="ln261">			if (result != B_OK)</a>
<a name="ln262">				break;</a>
<a name="ln263">			float percent;</a>
<a name="ln264">			result = message-&gt;FindFloat(kKeyPercentage, &amp;percent);</a>
<a name="ln265">			if (result != B_OK)</a>
<a name="ln266">				break;</a>
<a name="ln267"> </a>
<a name="ln268">			BString header;</a>
<a name="ln269">			Lock();</a>
<a name="ln270">			result = message-&gt;FindString(kKeyHeader, &amp;header);</a>
<a name="ln271">			if (result == B_OK &amp;&amp; header != fHeaderView-&gt;Text())</a>
<a name="ln272">				fHeaderView-&gt;SetText(header.String());</a>
<a name="ln273">			fStatusBar-&gt;SetTo(percent, packageName.String(),</a>
<a name="ln274">				packageCount.String());</a>
<a name="ln275">			Unlock();</a>
<a name="ln276"> </a>
<a name="ln277">			fListView-&gt;UpdatePackageProgress(packageName.String(), percent);</a>
<a name="ln278">			break;</a>
<a name="ln279">		}</a>
<a name="ln280"> </a>
<a name="ln281">		case kMsgCancel:</a>
<a name="ln282">		{</a>
<a name="ln283">			if (_GetState() == STATE_FINAL_MESSAGE) {</a>
<a name="ln284">				be_app-&gt;PostMessage(kMsgFinalQuit);</a>
<a name="ln285">				break;</a>
<a name="ln286">			}</a>
<a name="ln287">			if (!fUpdateConfirmed) {</a>
<a name="ln288">				// Downloads have not started yet, we will request to cancel</a>
<a name="ln289">				// without confirming</a>
<a name="ln290">				Lock();</a>
<a name="ln291">				fHeaderView-&gt;SetText(B_TRANSLATE(&quot;Cancelling updates&quot;));</a>
<a name="ln292">				fDetailView-&gt;SetText(</a>
<a name="ln293">					B_TRANSLATE(&quot;Attempting to cancel the updates&quot;</a>
<a name="ln294">						B_UTF8_ELLIPSIS));</a>
<a name="ln295">				Unlock();</a>
<a name="ln296">				fUserCancelRequested = true;</a>
<a name="ln297"> </a>
<a name="ln298">				if (fWaitingForButton) {</a>
<a name="ln299">					fButtonResult = message-&gt;what;</a>
<a name="ln300">					delete_sem(fWaitingSem);</a>
<a name="ln301">					fWaitingSem = -1;</a>
<a name="ln302">				}</a>
<a name="ln303">				break;</a>
<a name="ln304">			}</a>
<a name="ln305"> </a>
<a name="ln306">			// Confirm with the user to cancel</a>
<a name="ln307">			BAlert* alert = new BAlert(&quot;cancel request&quot;, B_TRANSLATE(&quot;Updates&quot;</a>
<a name="ln308">				&quot; have not been completed, are you sure you want to quit?&quot;),</a>
<a name="ln309">				B_TRANSLATE(&quot;Quit&quot;), B_TRANSLATE(&quot;Don't quit&quot;), NULL,</a>
<a name="ln310">				B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln311">			alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln312">			alert-&gt;Go(&amp;fCancelAlertResponse);</a>
<a name="ln313">			break;</a>
<a name="ln314">		}</a>
<a name="ln315"> </a>
<a name="ln316">		case kMsgShowReboot:</a>
<a name="ln317">		{</a>
<a name="ln318">			fRebootButtonLayoutItem-&gt;SetVisible(true);</a>
<a name="ln319">			fRebootButton-&gt;SetLabel(B_TRANSLATE_COMMENT(&quot;Reboot&quot;,</a>
<a name="ln320">				&quot;Button label&quot;));</a>
<a name="ln321">			fRebootButton-&gt;MakeDefault(true);</a>
<a name="ln322">			break;</a>
<a name="ln323">		}</a>
<a name="ln324"> </a>
<a name="ln325">		case kMsgReboot:</a>
<a name="ln326">		{</a>
<a name="ln327">			if (_GetState() != STATE_FINAL_MESSAGE)</a>
<a name="ln328">				break;</a>
<a name="ln329"> </a>
<a name="ln330">			BRoster roster;</a>
<a name="ln331">			BRoster::Private rosterPrivate(roster);</a>
<a name="ln332">			status_t error = rosterPrivate.ShutDown(true, true, false);</a>
<a name="ln333">			if (error != B_OK) {</a>
<a name="ln334">				BAlert* alert = new BAlert(&quot;reboot request&quot;, B_TRANSLATE(</a>
<a name="ln335">					&quot;For some reason, we could not reboot your computer.&quot;),</a>
<a name="ln336">					B_TRANSLATE(&quot;Ok&quot;), NULL, NULL,</a>
<a name="ln337">					B_WIDTH_AS_USUAL, B_STOP_ALERT);</a>
<a name="ln338">				alert-&gt;Go();</a>
<a name="ln339">			}</a>
<a name="ln340">			break;</a>
<a name="ln341">		}</a>
<a name="ln342"> </a>
<a name="ln343">		case kMsgCancelResponse:</a>
<a name="ln344">		{</a>
<a name="ln345">			// Verify whether the cancel alert was confirmed</a>
<a name="ln346">			int32 selection = -1;</a>
<a name="ln347">			message-&gt;FindInt32(&quot;which&quot;, &amp;selection);</a>
<a name="ln348">			if (selection != 0)</a>
<a name="ln349">				break;</a>
<a name="ln350"> </a>
<a name="ln351">			Lock();</a>
<a name="ln352">			fHeaderView-&gt;SetText(B_TRANSLATE(&quot;Cancelling updates&quot;));</a>
<a name="ln353">			fDetailView-&gt;SetText(</a>
<a name="ln354">				B_TRANSLATE(&quot;Attempting to cancel the updates&quot;</a>
<a name="ln355">					B_UTF8_ELLIPSIS));</a>
<a name="ln356">			Unlock();</a>
<a name="ln357">			fUserCancelRequested = true;</a>
<a name="ln358"> </a>
<a name="ln359">			if (fWaitingForButton) {</a>
<a name="ln360">				fButtonResult = message-&gt;what;</a>
<a name="ln361">				delete_sem(fWaitingSem);</a>
<a name="ln362">				fWaitingSem = -1;</a>
<a name="ln363">			}</a>
<a name="ln364">			break;</a>
<a name="ln365">		}</a>
<a name="ln366"> </a>
<a name="ln367">		case kMsgUpdateConfirmed:</a>
<a name="ln368">		{</a>
<a name="ln369">			if (fWaitingForButton) {</a>
<a name="ln370">				fButtonResult = message-&gt;what;</a>
<a name="ln371">				delete_sem(fWaitingSem);</a>
<a name="ln372">				fWaitingSem = -1;</a>
<a name="ln373">				fUpdateConfirmed = true;</a>
<a name="ln374">			}</a>
<a name="ln375">			break;</a>
<a name="ln376">		}</a>
<a name="ln377"> </a>
<a name="ln378">		case kMsgMoreDetailsToggle:</a>
<a name="ln379">			fListView-&gt;SetMoreDetails(fDetailsCheckbox-&gt;Value() != 0);</a>
<a name="ln380">			PostMessage(kMsgSetZoomLimits);</a>
<a name="ln381">			_WriteSettings();</a>
<a name="ln382">			break;</a>
<a name="ln383"> </a>
<a name="ln384">		case kMsgSetZoomLimits:</a>
<a name="ln385">		{</a>
<a name="ln386">			int32 count = fListView-&gt;CountItems();</a>
<a name="ln387">			if (count &lt; 1)</a>
<a name="ln388">				break;</a>
<a name="ln389">			// Convert last item's bottom point to its layout group coordinates</a>
<a name="ln390">			BPoint zoomPoint = fListView-&gt;ZoomPoint();</a>
<a name="ln391">			fScrollView-&gt;ConvertToParent(&amp;zoomPoint);</a>
<a name="ln392">			// Determine which BControl object height to use</a>
<a name="ln393">			float controlHeight;</a>
<a name="ln394">			if (fUpdateButtonLayoutItem-&gt;IsVisible())</a>
<a name="ln395">				fUpdateButton-&gt;GetPreferredSize(NULL, &amp;controlHeight);</a>
<a name="ln396">			else</a>
<a name="ln397">				fDetailsCheckbox-&gt;GetPreferredSize(NULL, &amp;controlHeight);</a>
<a name="ln398">			// Calculate height and width values</a>
<a name="ln399">			float zoomHeight = fZoomHeightBaseline + zoomPoint.y</a>
<a name="ln400">				+ controlHeight;</a>
<a name="ln401">			float zoomWidth = fZoomWidthBaseline + zoomPoint.x;</a>
<a name="ln402">			SetZoomLimits(zoomWidth, zoomHeight);</a>
<a name="ln403">			break;</a>
<a name="ln404">		}</a>
<a name="ln405"> </a>
<a name="ln406">		case kMsgWarningDismissed:</a>
<a name="ln407">			fWarningAlertCount--;</a>
<a name="ln408">			break;</a>
<a name="ln409"> </a>
<a name="ln410">		case kMsgWindowFrameChanged:</a>
<a name="ln411">			delete fMessageRunner;</a>
<a name="ln412">			fMessageRunner = NULL;</a>
<a name="ln413">			_WriteSettings();</a>
<a name="ln414">			break;</a>
<a name="ln415"> </a>
<a name="ln416">		case kMsgGetUpdateType:</a>
<a name="ln417">		{</a>
<a name="ln418">			BString text(</a>
<a name="ln419">				B_TRANSLATE(&quot;Please choose from these update options:\n\n&quot;</a>
<a name="ln420">				&quot;Update:\n&quot;</a>
<a name="ln421">				&quot;	Updates all installed packages.\n&quot;</a>
<a name="ln422">				&quot;Full sync:\n&quot;</a>
<a name="ln423">				&quot;	Synchronizes the installed packages with the repositories.&quot;</a>
<a name="ln424">				));</a>
<a name="ln425">			BAlert* alert = new BAlert(&quot;update_type&quot;,</a>
<a name="ln426">				text,</a>
<a name="ln427">				B_TRANSLATE_COMMENT(&quot;Cancel&quot;, &quot;Alert button label&quot;),</a>
<a name="ln428">				B_TRANSLATE_COMMENT(&quot;Full sync&quot;,&quot;Alert button label&quot;),</a>
<a name="ln429">				B_TRANSLATE_COMMENT(&quot;Update&quot;,&quot;Alert button label&quot;),</a>
<a name="ln430">				B_WIDTH_AS_USUAL, B_INFO_ALERT);</a>
<a name="ln431">			int32 result = alert-&gt;Go();</a>
<a name="ln432">			int32 action = INVALID_SELECTION;</a>
<a name="ln433">			switch(result) {</a>
<a name="ln434">				case 0:</a>
<a name="ln435">					action = CANCEL_UPDATE;</a>
<a name="ln436">					break;</a>
<a name="ln437"> </a>
<a name="ln438">				case 1:</a>
<a name="ln439">					action = FULLSYNC;</a>
<a name="ln440">					break;</a>
<a name="ln441"> </a>
<a name="ln442">				case 2:</a>
<a name="ln443">					action = UPDATE;</a>
<a name="ln444">					break;</a>
<a name="ln445">			}</a>
<a name="ln446">			BMessage reply;</a>
<a name="ln447">			reply.AddInt32(kKeyAlertResult, action);</a>
<a name="ln448">			message-&gt;SendReply(&amp;reply);</a>
<a name="ln449">			break;</a>
<a name="ln450">		}</a>
<a name="ln451"> </a>
<a name="ln452">		case kMsgNoRepositories:</a>
<a name="ln453">		{</a>
<a name="ln454">			BString text(</a>
<a name="ln455">				B_TRANSLATE_COMMENT(</a>
<a name="ln456">				&quot;No remote repositories are available. Please verify that some&quot;</a>
<a name="ln457">				&quot; repositories are enabled using the Repositories preflet or&quot;</a>
<a name="ln458">				&quot; the \'pkgman\' command.&quot;, &quot;Error message&quot;));</a>
<a name="ln459">			BAlert* alert = new BAlert(&quot;repositories&quot;, text,</a>
<a name="ln460">				B_TRANSLATE_COMMENT(&quot;Quit&quot;, &quot;Alert button label&quot;),</a>
<a name="ln461">				B_TRANSLATE_COMMENT(&quot;Open Repositories&quot;,&quot;Alert button label&quot;),</a>
<a name="ln462">				NULL, B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln463">			int32 result = alert-&gt;Go();</a>
<a name="ln464">			BMessage reply;</a>
<a name="ln465">			reply.AddInt32(kKeyAlertResult, result);</a>
<a name="ln466">			message-&gt;SendReply(&amp;reply);</a>
<a name="ln467">			break;</a>
<a name="ln468">		}</a>
<a name="ln469"> </a>
<a name="ln470">		default:</a>
<a name="ln471">			BWindow::MessageReceived(message);</a>
<a name="ln472">	}</a>
<a name="ln473">}</a>
<a name="ln474"> </a>
<a name="ln475"> </a>
<a name="ln476">bool</a>
<a name="ln477">SoftwareUpdaterWindow::ConfirmUpdates()</a>
<a name="ln478">{</a>
<a name="ln479">	Lock();</a>
<a name="ln480">	fHeaderView-&gt;SetText(B_TRANSLATE(&quot;Updates found&quot;));</a>
<a name="ln481">	fDetailView-&gt;SetText(B_TRANSLATE(&quot;The following changes will be made:&quot;));</a>
<a name="ln482">	fListView-&gt;SortItems();</a>
<a name="ln483">	Unlock();</a>
<a name="ln484"> </a>
<a name="ln485">	uint32 priorState = _GetState();</a>
<a name="ln486">	_SetState(STATE_GET_CONFIRMATION);</a>
<a name="ln487"> </a>
<a name="ln488">	_WaitForButtonClick();</a>
<a name="ln489">	_SetState(priorState);</a>
<a name="ln490">	return fButtonResult == kMsgUpdateConfirmed;</a>
<a name="ln491">}</a>
<a name="ln492"> </a>
<a name="ln493"> </a>
<a name="ln494">void</a>
<a name="ln495">SoftwareUpdaterWindow::UpdatesApplying(const char* header, const char* detail)</a>
<a name="ln496">{</a>
<a name="ln497">	Lock();</a>
<a name="ln498">	fHeaderView-&gt;SetText(header);</a>
<a name="ln499">	fDetailView-&gt;SetText(detail);</a>
<a name="ln500">	Unlock();</a>
<a name="ln501">	_SetState(STATE_APPLY_UPDATES);</a>
<a name="ln502">}</a>
<a name="ln503"> </a>
<a name="ln504"> </a>
<a name="ln505">bool</a>
<a name="ln506">SoftwareUpdaterWindow::UserCancelRequested()</a>
<a name="ln507">{</a>
<a name="ln508">	if (_GetState() &gt; STATE_GET_CONFIRMATION)</a>
<a name="ln509">		return false;</a>
<a name="ln510"> </a>
<a name="ln511">	return fUserCancelRequested;</a>
<a name="ln512">}</a>
<a name="ln513"> </a>
<a name="ln514"> </a>
<a name="ln515">void</a>
<a name="ln516">SoftwareUpdaterWindow::AddPackageInfo(uint32 install_type,</a>
<a name="ln517">	const char* package_name, const char* cur_ver, const char* new_ver,</a>
<a name="ln518">	const char* summary, const char* repository, const char* file_name)</a>
<a name="ln519">{</a>
<a name="ln520">	Lock();</a>
<a name="ln521">	fListView-&gt;AddPackage(install_type, package_name, cur_ver, new_ver,</a>
<a name="ln522">		summary, repository, file_name);</a>
<a name="ln523">	Unlock();</a>
<a name="ln524">}</a>
<a name="ln525"> </a>
<a name="ln526"> </a>
<a name="ln527">void</a>
<a name="ln528">SoftwareUpdaterWindow::ShowWarningAlert(const char* text)</a>
<a name="ln529">{</a>
<a name="ln530">	BAlert* alert = new BAlert(&quot;warning&quot;, text, B_TRANSLATE(&quot;OK&quot;), NULL, NULL,</a>
<a name="ln531">		B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln532">	alert-&gt;Go(&amp;fWarningAlertDismissed);</a>
<a name="ln533">	alert-&gt;CenterIn(Frame());</a>
<a name="ln534">	// Offset multiple alerts</a>
<a name="ln535">	alert-&gt;MoveBy(fWarningAlertCount * 15, fWarningAlertCount * 15);</a>
<a name="ln536">	fWarningAlertCount++;</a>
<a name="ln537">}</a>
<a name="ln538"> </a>
<a name="ln539"> </a>
<a name="ln540">BBitmap</a>
<a name="ln541">SoftwareUpdaterWindow::GetIcon(int32 iconSize)</a>
<a name="ln542">{</a>
<a name="ln543">	BBitmap icon(BRect(0, 0, iconSize - 1, iconSize - 1), 0, B_RGBA32);</a>
<a name="ln544">	team_info teamInfo;</a>
<a name="ln545">	get_team_info(B_CURRENT_TEAM, &amp;teamInfo);</a>
<a name="ln546">	app_info appInfo;</a>
<a name="ln547">	be_roster-&gt;GetRunningAppInfo(teamInfo.team, &amp;appInfo);</a>
<a name="ln548">	BNodeInfo::GetTrackerIcon(&amp;appInfo.ref, &amp;icon, icon_size(iconSize));</a>
<a name="ln549">	return icon;</a>
<a name="ln550">}</a>
<a name="ln551"> </a>
<a name="ln552"> </a>
<a name="ln553">void</a>
<a name="ln554">SoftwareUpdaterWindow::FinalUpdate(const char* header, const char* detail)</a>
<a name="ln555">{</a>
<a name="ln556">	if (_GetState() == STATE_FINAL_MESSAGE)</a>
<a name="ln557">		return;</a>
<a name="ln558"> </a>
<a name="ln559">	_SetState(STATE_FINAL_MESSAGE);</a>
<a name="ln560">	Lock();</a>
<a name="ln561">	fHeaderView-&gt;SetText(header);</a>
<a name="ln562">	fDetailView-&gt;SetText(detail);</a>
<a name="ln563">	Unlock();</a>
<a name="ln564">}</a>
<a name="ln565"> </a>
<a name="ln566"> </a>
<a name="ln567">BLayoutItem*</a>
<a name="ln568">SoftwareUpdaterWindow::layout_item_for(BView* view)</a>
<a name="ln569">{</a>
<a name="ln570">	BLayout* layout = view-&gt;Parent()-&gt;GetLayout();</a>
<a name="ln571">	int32 index = layout-&gt;IndexOfView(view);</a>
<a name="ln572">	return layout-&gt;ItemAt(index);</a>
<a name="ln573">}</a>
<a name="ln574"> </a>
<a name="ln575"> </a>
<a name="ln576">uint32</a>
<a name="ln577">SoftwareUpdaterWindow::_WaitForButtonClick()</a>
<a name="ln578">{</a>
<a name="ln579">	fButtonResult = 0;</a>
<a name="ln580">	fWaitingForButton = true;</a>
<a name="ln581">	fWaitingSem = create_sem(0, &quot;WaitingSem&quot;);</a>
<a name="ln582">	while (acquire_sem(fWaitingSem) == B_INTERRUPTED) {</a>
<a name="ln583">	}</a>
<a name="ln584">	fWaitingForButton = false;</a>
<a name="ln585">	return fButtonResult;</a>
<a name="ln586">}</a>
<a name="ln587"> </a>
<a name="ln588"> </a>
<a name="ln589">void</a>
<a name="ln590">SoftwareUpdaterWindow::_SetState(uint32 state)</a>
<a name="ln591">{</a>
<a name="ln592">	if (state &lt;= STATE_HEAD || state &gt;= STATE_MAX)</a>
<a name="ln593">		return;</a>
<a name="ln594"> </a>
<a name="ln595">	Lock();</a>
<a name="ln596"> </a>
<a name="ln597">	// Initial settings</a>
<a name="ln598">	if (fCurrentState == STATE_HEAD) {</a>
<a name="ln599">		fProgressLayoutItem-&gt;SetVisible(false);</a>
<a name="ln600">		fPackagesLayoutItem-&gt;SetVisible(false);</a>
<a name="ln601">		fDetailsCheckboxLayoutItem-&gt;SetVisible(false);</a>
<a name="ln602">		fCancelButtonLayoutItem-&gt;SetVisible(false);</a>
<a name="ln603">		fRebootButtonLayoutItem-&gt;SetVisible(false);</a>
<a name="ln604">	}</a>
<a name="ln605">	fCurrentState = state;</a>
<a name="ln606"> </a>
<a name="ln607">	// Update confirmation button</a>
<a name="ln608">	// Show only when asking for confirmation to update</a>
<a name="ln609">	if (fCurrentState == STATE_GET_CONFIRMATION)</a>
<a name="ln610">		fUpdateButtonLayoutItem-&gt;SetVisible(true);</a>
<a name="ln611">	else</a>
<a name="ln612">		fUpdateButtonLayoutItem-&gt;SetVisible(false);</a>
<a name="ln613"> </a>
<a name="ln614">	// View package info view and checkbox</a>
<a name="ln615">	// Show at confirmation prompt, hide at final update</a>
<a name="ln616">	if (fCurrentState == STATE_GET_CONFIRMATION) {</a>
<a name="ln617">		fPackagesLayoutItem-&gt;SetVisible(true);</a>
<a name="ln618">		fDetailsCheckboxLayoutItem-&gt;SetVisible(true);</a>
<a name="ln619">		if (fSettingsReadStatus == B_OK) {</a>
<a name="ln620">			bool showMoreDetails;</a>
<a name="ln621">			status_t result = fInitialSettings.FindBool(kKeyShowDetails,</a>
<a name="ln622">				&amp;showMoreDetails);</a>
<a name="ln623">			if (result == B_OK) {</a>
<a name="ln624">				fDetailsCheckbox-&gt;SetValue(showMoreDetails ? 1 : 0);</a>
<a name="ln625">				fListView-&gt;SetMoreDetails(showMoreDetails);</a>
<a name="ln626">			}</a>
<a name="ln627">		}</a>
<a name="ln628">	} else if (fCurrentState == STATE_FINAL_MESSAGE) {</a>
<a name="ln629">		fPackagesLayoutItem-&gt;SetVisible(false);</a>
<a name="ln630">		fDetailsCheckboxLayoutItem-&gt;SetVisible(false);</a>
<a name="ln631">	}</a>
<a name="ln632"> </a>
<a name="ln633">	// Progress bar and string view</a>
<a name="ln634">	// Hide detail text while showing status bar</a>
<a name="ln635">	if (fCurrentState == STATE_DISPLAY_PROGRESS) {</a>
<a name="ln636">		fDetailsLayoutItem-&gt;SetVisible(false);</a>
<a name="ln637">		fProgressLayoutItem-&gt;SetVisible(true);</a>
<a name="ln638">	} else {</a>
<a name="ln639">		fProgressLayoutItem-&gt;SetVisible(false);</a>
<a name="ln640">		fDetailsLayoutItem-&gt;SetVisible(true);</a>
<a name="ln641">	}</a>
<a name="ln642"> </a>
<a name="ln643">	// Resizing and zooming</a>
<a name="ln644">	if (fCurrentState == STATE_GET_CONFIRMATION) {</a>
<a name="ln645">		// Enable resizing and zooming</a>
<a name="ln646">		float defaultWidth = fDefaultRect.Width();</a>
<a name="ln647">		SetSizeLimits(defaultWidth, B_SIZE_UNLIMITED,</a>
<a name="ln648">			fDefaultRect.Height() + 4 * fListView-&gt;ItemHeight(),</a>
<a name="ln649">			B_SIZE_UNLIMITED);</a>
<a name="ln650">		SetFlags(Flags() ^ (B_NOT_RESIZABLE | B_NOT_ZOOMABLE));</a>
<a name="ln651">		PostMessage(kMsgSetZoomLimits);</a>
<a name="ln652">		// Recall saved settings</a>
<a name="ln653">		BScreen screen(this);</a>
<a name="ln654">		BRect screenFrame = screen.Frame();</a>
<a name="ln655">		bool windowResized = false;</a>
<a name="ln656">		if (fSettingsReadStatus == B_OK) {</a>
<a name="ln657">			BRect windowFrame;</a>
<a name="ln658">			status_t result = fInitialSettings.FindRect(kKeyWindowFrame,</a>
<a name="ln659">				&amp;windowFrame);</a>
<a name="ln660">			if (result == B_OK) {</a>
<a name="ln661">				if (screenFrame.Contains(windowFrame)) {</a>
<a name="ln662">					ResizeTo(windowFrame.Width(), windowFrame.Height());</a>
<a name="ln663">					windowResized = true;</a>
<a name="ln664">				}</a>
<a name="ln665">			}</a>
<a name="ln666">		}</a>
<a name="ln667">		if (!windowResized)</a>
<a name="ln668">			ResizeTo(defaultWidth, .75 * defaultWidth);</a>
<a name="ln669">		// Check that the bottom of window is on screen</a>
<a name="ln670">		float screenBottom = screenFrame.bottom;</a>
<a name="ln671">		float windowBottom = DecoratorFrame().bottom;</a>
<a name="ln672">		if (windowBottom &gt; screenBottom)</a>
<a name="ln673">			MoveBy(0, screenBottom - windowBottom);</a>
<a name="ln674">		fSaveFrameChanges = true;</a>
<a name="ln675">	} else if (fUpdateConfirmed &amp;&amp; (fCurrentState == STATE_DISPLAY_PROGRESS</a>
<a name="ln676">			|| fCurrentState == STATE_DISPLAY_STATUS)) {</a>
<a name="ln677">		PostMessage(kMsgSetZoomLimits);</a>
<a name="ln678">	} else if (fCurrentState == STATE_APPLY_UPDATES)</a>
<a name="ln679">		fSaveFrameChanges = false;</a>
<a name="ln680">	else if (fCurrentState == STATE_FINAL_MESSAGE) {</a>
<a name="ln681">		// Disable resizing and zooming</a>
<a name="ln682">		fSaveFrameChanges = false;</a>
<a name="ln683">		ResizeTo(fDefaultRect.Width(), fDefaultRect.Height());</a>
<a name="ln684">		SetFlags(Flags() | B_AUTO_UPDATE_SIZE_LIMITS | B_NOT_RESIZABLE</a>
<a name="ln685">			| B_NOT_ZOOMABLE);</a>
<a name="ln686">	}</a>
<a name="ln687"> </a>
<a name="ln688">	// Quit button</a>
<a name="ln689">	if (fCurrentState == STATE_FINAL_MESSAGE) {</a>
<a name="ln690">		fCancelButtonLayoutItem-&gt;SetVisible(true);</a>
<a name="ln691"> 		fCancelButton-&gt;SetLabel(B_TRANSLATE_COMMENT(&quot;Quit&quot;, &quot;Button label&quot;));</a>
<a name="ln692">		fCancelButton-&gt;MakeDefault(true);</a>
<a name="ln693">	}</a>
<a name="ln694"> </a>
<a name="ln695">	Unlock();</a>
<a name="ln696">}</a>
<a name="ln697"> </a>
<a name="ln698"> </a>
<a name="ln699">uint32</a>
<a name="ln700">SoftwareUpdaterWindow::_GetState()</a>
<a name="ln701">{</a>
<a name="ln702">	return fCurrentState;</a>
<a name="ln703">}</a>
<a name="ln704"> </a>
<a name="ln705"> </a>
<a name="ln706">status_t</a>
<a name="ln707">SoftwareUpdaterWindow::_WriteSettings()</a>
<a name="ln708">{</a>
<a name="ln709">	BFile file;</a>
<a name="ln710">	status_t status = file.SetTo(fSettingsPath.Path(),</a>
<a name="ln711">		B_WRITE_ONLY | B_CREATE_FILE | B_ERASE_FILE);</a>
<a name="ln712">	if (status == B_OK) {</a>
<a name="ln713">		BMessage settings;</a>
<a name="ln714">		settings.AddBool(kKeyShowDetails, fDetailsCheckbox-&gt;Value() != 0);</a>
<a name="ln715">		settings.AddRect(kKeyWindowFrame, Frame());</a>
<a name="ln716">		status = settings.Flatten(&amp;file);</a>
<a name="ln717">	}</a>
<a name="ln718">	file.Unset();</a>
<a name="ln719">	return status;</a>
<a name="ln720">}</a>
<a name="ln721"> </a>
<a name="ln722"> </a>
<a name="ln723">status_t</a>
<a name="ln724">SoftwareUpdaterWindow::_ReadSettings(BMessage&amp; settings)</a>
<a name="ln725">{</a>
<a name="ln726">	BFile file;</a>
<a name="ln727">	status_t status = file.SetTo(fSettingsPath.Path(), B_READ_ONLY);</a>
<a name="ln728">	if (status == B_OK)</a>
<a name="ln729">		status = settings.Unflatten(&amp;file);</a>
<a name="ln730">	file.Unset();</a>
<a name="ln731">	return status;</a>
<a name="ln732">}</a>
<a name="ln733"> </a>
<a name="ln734"> </a>
<a name="ln735">SuperItem::SuperItem(const char* label)</a>
<a name="ln736">	:</a>
<a name="ln737">	BListItem(),</a>
<a name="ln738">	fLabel(label),</a>
<a name="ln739">	fRegularFont(be_plain_font),</a>
<a name="ln740">	fBoldFont(be_plain_font),</a>
<a name="ln741">	fShowMoreDetails(false),</a>
<a name="ln742">	fPackageLessIcon(NULL),</a>
<a name="ln743">	fPackageMoreIcon(NULL),</a>
<a name="ln744">	fItemCount(0)</a>
<a name="ln745">{</a>
<a name="ln746">	fBoldFont.SetFace(B_BOLD_FACE);</a>
<a name="ln747">	fBoldFont.GetHeight(&amp;fBoldFontHeight);</a>
<a name="ln748">	font_height fontHeight;</a>
<a name="ln749">	fRegularFont.GetHeight(&amp;fontHeight);</a>
<a name="ln750">	fPackageItemLineHeight = fontHeight.ascent + fontHeight.descent</a>
<a name="ln751">		+ fontHeight.leading;</a>
<a name="ln752">	fPackageLessIcon = _GetPackageIcon(GetPackageItemHeight(false));</a>
<a name="ln753">	fPackageMoreIcon = _GetPackageIcon(GetPackageItemHeight(true));</a>
<a name="ln754">}</a>
<a name="ln755"> </a>
<a name="ln756"> </a>
<a name="ln757">SuperItem::~SuperItem()</a>
<a name="ln758">{</a>
<a name="ln759">	delete fPackageLessIcon;</a>
<a name="ln760">	delete fPackageMoreIcon;</a>
<a name="ln761">}</a>
<a name="ln762"> </a>
<a name="ln763"> </a>
<a name="ln764">void</a>
<a name="ln765">SuperItem::DrawItem(BView* owner, BRect item_rect, bool complete)</a>
<a name="ln766">{</a>
<a name="ln767">	owner-&gt;PushState();</a>
<a name="ln768"> </a>
<a name="ln769">	float width;</a>
<a name="ln770">	owner-&gt;GetPreferredSize(&amp;width, NULL);</a>
<a name="ln771">	BString text(fItemText);</a>
<a name="ln772">	owner-&gt;SetHighColor(ui_color(B_LIST_ITEM_TEXT_COLOR));</a>
<a name="ln773">	owner-&gt;SetFont(&amp;fBoldFont);</a>
<a name="ln774">	owner-&gt;TruncateString(&amp;text, B_TRUNCATE_END, width);</a>
<a name="ln775">	owner-&gt;DrawString(text.String(), BPoint(item_rect.left,</a>
<a name="ln776">		item_rect.bottom - fBoldFontHeight.descent));</a>
<a name="ln777"> </a>
<a name="ln778">	owner-&gt;PopState();</a>
<a name="ln779">}</a>
<a name="ln780"> </a>
<a name="ln781"> </a>
<a name="ln782">float</a>
<a name="ln783">SuperItem::GetPackageItemHeight()</a>
<a name="ln784">{</a>
<a name="ln785">	return GetPackageItemHeight(fShowMoreDetails);</a>
<a name="ln786">}</a>
<a name="ln787"> </a>
<a name="ln788"> </a>
<a name="ln789">float</a>
<a name="ln790">SuperItem::GetPackageItemHeight(bool showMoreDetails)</a>
<a name="ln791">{</a>
<a name="ln792">	int lineCount = showMoreDetails ? 3 : 2;</a>
<a name="ln793">	return lineCount * fPackageItemLineHeight;</a>
<a name="ln794">}</a>
<a name="ln795"> </a>
<a name="ln796"> </a>
<a name="ln797">BBitmap*</a>
<a name="ln798">SuperItem::GetIcon(bool showMoreDetails)</a>
<a name="ln799">{</a>
<a name="ln800">	if (showMoreDetails)</a>
<a name="ln801">		return fPackageMoreIcon;</a>
<a name="ln802">	else</a>
<a name="ln803">		return fPackageLessIcon;</a>
<a name="ln804">}</a>
<a name="ln805"> </a>
<a name="ln806"> </a>
<a name="ln807">float</a>
<a name="ln808">SuperItem::GetIconSize(bool showMoreDetails)</a>
<a name="ln809">{</a>
<a name="ln810">	if (showMoreDetails)</a>
<a name="ln811">		return fPackageMoreIcon-&gt;Bounds().Height();</a>
<a name="ln812">	else</a>
<a name="ln813">		return fPackageLessIcon-&gt;Bounds().Height();</a>
<a name="ln814">}</a>
<a name="ln815"> </a>
<a name="ln816"> </a>
<a name="ln817">void</a>
<a name="ln818">SuperItem::SetDetailLevel(bool showMoreDetails)</a>
<a name="ln819">{</a>
<a name="ln820">	fShowMoreDetails = showMoreDetails;</a>
<a name="ln821">}</a>
<a name="ln822"> </a>
<a name="ln823"> </a>
<a name="ln824">void</a>
<a name="ln825">SuperItem::SetItemCount(int32 count)</a>
<a name="ln826">{</a>
<a name="ln827">	fItemCount = count;</a>
<a name="ln828">	fItemText = fLabel;</a>
<a name="ln829">	fItemText.Append(&quot; (&quot;);</a>
<a name="ln830">	fItemText &lt;&lt; fItemCount;</a>
<a name="ln831">	fItemText.Append(&quot;)&quot;);</a>
<a name="ln832">}</a>
<a name="ln833"> </a>
<a name="ln834"> </a>
<a name="ln835">float</a>
<a name="ln836">SuperItem::ZoomWidth(BView *owner)</a>
<a name="ln837">{</a>
<a name="ln838">	owner-&gt;PushState();</a>
<a name="ln839">	owner-&gt;SetFont(&amp;fBoldFont);</a>
<a name="ln840">	float width = owner-&gt;StringWidth(fItemText.String());</a>
<a name="ln841">	owner-&gt;PopState();</a>
<a name="ln842">	return width;</a>
<a name="ln843">}</a>
<a name="ln844"> </a>
<a name="ln845"> </a>
<a name="ln846">BBitmap*</a>
<a name="ln847">SuperItem::_GetPackageIcon(float listItemHeight)</a>
<a name="ln848">{</a>
<a name="ln849">	int32 iconSize = int(listItemHeight * .8);</a>
<a name="ln850">	status_t result = B_ERROR;</a>
<a name="ln851">	BRect iconRect(0, 0, iconSize - 1, iconSize - 1);</a>
<a name="ln852">	BBitmap* packageIcon = new BBitmap(iconRect, 0, B_RGBA32);</a>
<a name="ln853">	BMimeType nodeType;</a>
<a name="ln854">	nodeType.SetTo(&quot;application/x-vnd.haiku-package&quot;);</a>
<a name="ln855">	result = nodeType.GetIcon(packageIcon, icon_size(iconSize));</a>
<a name="ln856">	// Get super type icon</a>
<a name="ln857">	if (result != B_OK) {</a>
<a name="ln858">		BMimeType superType;</a>
<a name="ln859">		if (nodeType.GetSupertype(&amp;superType) == B_OK)</a>
<a name="ln860">			result = superType.GetIcon(packageIcon, icon_size(iconSize));</a>
<a name="ln861">	}</a>
<a name="ln862">	if (result != B_OK) {</a>
<a name="ln863">		delete packageIcon;</a>
<a name="ln864">		return NULL;</a>
<a name="ln865">	}</a>
<a name="ln866">	return packageIcon;</a>
<a name="ln867">}</a>
<a name="ln868"> </a>
<a name="ln869"> </a>
<a name="ln870">PackageItem::PackageItem(const char* name, const char* simple_version,</a>
<a name="ln871">	const char* detailed_version, const char* repository, const char* summary,</a>
<a name="ln872">	const char* file_name, SuperItem* super)</a>
<a name="ln873">	:</a>
<a name="ln874">	BListItem(),</a>
<a name="ln875">	fName(name),</a>
<a name="ln876">	fSimpleVersion(simple_version),</a>
<a name="ln877">	fDetailedVersion(detailed_version),</a>
<a name="ln878">	fRepository(repository),</a>
<a name="ln879">	fSummary(summary),</a>
<a name="ln880">	fSmallFont(be_plain_font),</a>
<a name="ln881">	fSuperItem(super),</a>
<a name="ln882">	fFileName(file_name),</a>
<a name="ln883">	fDownloadProgress(0),</a>
<a name="ln884">	fDrawBarFlag(false),</a>
<a name="ln885">	fMoreDetailsWidth(0),</a>
<a name="ln886">	fLessDetailsWidth(0)</a>
<a name="ln887">{</a>
<a name="ln888">	fLabelOffset = be_control_look-&gt;DefaultLabelSpacing();</a>
<a name="ln889">	fSmallFont.SetSize(be_plain_font-&gt;Size() - 2);</a>
<a name="ln890">	fSmallFont.GetHeight(&amp;fSmallFontHeight);</a>
<a name="ln891">	fSmallTotalHeight = fSmallFontHeight.ascent + fSmallFontHeight.descent</a>
<a name="ln892">		+ fSmallFontHeight.leading;</a>
<a name="ln893">}</a>
<a name="ln894"> </a>
<a name="ln895"> </a>
<a name="ln896">void</a>
<a name="ln897">PackageItem::DrawItem(BView* owner, BRect item_rect, bool complete)</a>
<a name="ln898">{</a>
<a name="ln899">	owner-&gt;PushState();</a>
<a name="ln900"> </a>
<a name="ln901">	float width = owner-&gt;Frame().Width();</a>
<a name="ln902">	float nameWidth = width / 2.0;</a>
<a name="ln903">	float offsetWidth = 0;</a>
<a name="ln904">	bool showMoreDetails = fSuperItem-&gt;GetDetailLevel();</a>
<a name="ln905"> </a>
<a name="ln906">	BBitmap* icon = fSuperItem-&gt;GetIcon(showMoreDetails);</a>
<a name="ln907">	if (icon != NULL &amp;&amp; icon-&gt;IsValid()) {</a>
<a name="ln908">		float iconSize = icon-&gt;Bounds().Height();</a>
<a name="ln909">		float offsetMarginHeight = floor((Height() - iconSize) / 2);</a>
<a name="ln910">		owner-&gt;SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln911">		BPoint location = BPoint(item_rect.left,</a>
<a name="ln912">			item_rect.top + offsetMarginHeight);</a>
<a name="ln913">		owner-&gt;DrawBitmap(icon, location);</a>
<a name="ln914">		owner-&gt;SetDrawingMode(B_OP_COPY);</a>
<a name="ln915">		offsetWidth = iconSize + fLabelOffset;</a>
<a name="ln916"> </a>
<a name="ln917">		if (fDrawBarFlag)</a>
<a name="ln918">			_DrawBar(location, owner, icon_size(iconSize));</a>
<a name="ln919">	}</a>
<a name="ln920"> </a>
<a name="ln921">	owner-&gt;SetFont(be_plain_font);</a>
<a name="ln922">	owner-&gt;SetHighColor(ui_color(B_LIST_ITEM_TEXT_COLOR));</a>
<a name="ln923"> </a>
<a name="ln924">	// Package name</a>
<a name="ln925">	BString name(fName);</a>
<a name="ln926">	owner-&gt;TruncateString(&amp;name, B_TRUNCATE_END, nameWidth);</a>
<a name="ln927">	BPoint cursor(item_rect.left + offsetWidth,</a>
<a name="ln928">		item_rect.bottom - fSmallTotalHeight - fSmallFontHeight.descent - 2);</a>
<a name="ln929">	if (showMoreDetails)</a>
<a name="ln930">		cursor.y -= fSmallTotalHeight + 1;</a>
<a name="ln931">	owner-&gt;DrawString(name.String(), cursor);</a>
<a name="ln932">	cursor.x += owner-&gt;StringWidth(name.String()) + fLabelOffset;</a>
<a name="ln933"> </a>
<a name="ln934">	// Change font and color</a>
<a name="ln935">	owner-&gt;SetFont(&amp;fSmallFont);</a>
<a name="ln936">	owner-&gt;SetHighColor(tint_color(ui_color(B_LIST_ITEM_TEXT_COLOR), 0.7));</a>
<a name="ln937"> </a>
<a name="ln938">	// Simple version or repository</a>
<a name="ln939">	BString versionOrRepo;</a>
<a name="ln940">	if (showMoreDetails)</a>
<a name="ln941">		versionOrRepo.SetTo(fRepository);</a>
<a name="ln942">	else</a>
<a name="ln943">		versionOrRepo.SetTo(fSimpleVersion);</a>
<a name="ln944">	owner-&gt;TruncateString(&amp;versionOrRepo, B_TRUNCATE_END, width - cursor.x);</a>
<a name="ln945">	owner-&gt;DrawString(versionOrRepo.String(), cursor);</a>
<a name="ln946"> </a>
<a name="ln947">	// Summary</a>
<a name="ln948">	BString summary(fSummary);</a>
<a name="ln949">	cursor.x = item_rect.left + offsetWidth;</a>
<a name="ln950">	cursor.y += fSmallTotalHeight;</a>
<a name="ln951">	owner-&gt;TruncateString(&amp;summary, B_TRUNCATE_END, width - cursor.x);</a>
<a name="ln952">	owner-&gt;DrawString(summary.String(), cursor);</a>
<a name="ln953"> </a>
<a name="ln954">	// Detailed version</a>
<a name="ln955">	if (showMoreDetails) {</a>
<a name="ln956">		BString version(fDetailedVersion);</a>
<a name="ln957">		cursor.y += fSmallTotalHeight;</a>
<a name="ln958">		owner-&gt;TruncateString(&amp;version, B_TRUNCATE_END, width - cursor.x);</a>
<a name="ln959">		owner-&gt;DrawString(version.String(), cursor);</a>
<a name="ln960">	}</a>
<a name="ln961"> </a>
<a name="ln962">	owner-&gt;PopState();</a>
<a name="ln963">}</a>
<a name="ln964"> </a>
<a name="ln965"> </a>
<a name="ln966">// Modified slightly from Tracker's BPose::DrawBar</a>
<a name="ln967">void</a>
<a name="ln968">PackageItem::_DrawBar(BPoint where, BView* view, icon_size which)</a>
<a name="ln969">{</a>
<a name="ln970">	int32 yOffset;</a>
<a name="ln971">	int32 size = which - 1;</a>
<a name="ln972">	int32 barWidth = (int32)(7.0f / 32.0f * (float)which);</a>
<a name="ln973">	if (barWidth &lt; 4) {</a>
<a name="ln974">		barWidth = 4;</a>
<a name="ln975">		yOffset = 0;</a>
<a name="ln976">	} else</a>
<a name="ln977">		yOffset = 2;</a>
<a name="ln978">	int32 barHeight = size - 3 - 2 * yOffset;</a>
<a name="ln979"> </a>
<a name="ln980"> </a>
<a name="ln981">	// the black shadowed line</a>
<a name="ln982">	view-&gt;SetHighColor(32, 32, 32, 92);</a>
<a name="ln983">	view-&gt;MovePenTo(BPoint(where.x + size, where.y + 1 + yOffset));</a>
<a name="ln984">	view-&gt;StrokeLine(BPoint(where.x + size, where.y + size - yOffset));</a>
<a name="ln985">	view-&gt;StrokeLine(BPoint(where.x + size - barWidth + 1,</a>
<a name="ln986">		where.y + size - yOffset));</a>
<a name="ln987"> </a>
<a name="ln988">	view-&gt;SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln989"> </a>
<a name="ln990">	// the gray frame</a>
<a name="ln991">	view-&gt;SetHighColor(76, 76, 76, 192);</a>
<a name="ln992">	BRect rect(where.x + size - barWidth,where.y + yOffset,</a>
<a name="ln993">		where.x + size - 1,where.y + size - 1 - yOffset);</a>
<a name="ln994">	view-&gt;StrokeRect(rect);</a>
<a name="ln995"> </a>
<a name="ln996">	// calculate bar height</a>
<a name="ln997">	int32 barPos = barHeight - int32(barHeight * fDownloadProgress / 100.0);</a>
<a name="ln998">	if (barPos &lt; 0)</a>
<a name="ln999">		barPos = 0;</a>
<a name="ln1000">	else if (barPos &gt; barHeight)</a>
<a name="ln1001">		barPos = barHeight;</a>
<a name="ln1002"> </a>
<a name="ln1003">	// the free space bar</a>
<a name="ln1004">	view-&gt;SetHighColor(255, 255, 255, 192);</a>
<a name="ln1005"> </a>
<a name="ln1006">	rect.InsetBy(1,1);</a>
<a name="ln1007">	BRect bar(rect);</a>
<a name="ln1008">	bar.bottom = bar.top + barPos - 1;</a>
<a name="ln1009">	if (barPos &gt; 0)</a>
<a name="ln1010">		view-&gt;FillRect(bar);</a>
<a name="ln1011"> </a>
<a name="ln1012">	// the used space bar</a>
<a name="ln1013">	bar.top = bar.bottom + 1;</a>
<a name="ln1014">	bar.bottom = rect.bottom;</a>
<a name="ln1015">	view-&gt;SetHighColor(0, 203, 0, 192);</a>
<a name="ln1016">	view-&gt;FillRect(bar);</a>
<a name="ln1017">}</a>
<a name="ln1018"> </a>
<a name="ln1019"> </a>
<a name="ln1020">void</a>
<a name="ln1021">PackageItem::Update(BView *owner, const BFont *font)</a>
<a name="ln1022">{</a>
<a name="ln1023">	BListItem::Update(owner, font);</a>
<a name="ln1024">	SetHeight(fSuperItem-&gt;GetPackageItemHeight());</a>
<a name="ln1025">}</a>
<a name="ln1026"> </a>
<a name="ln1027"> </a>
<a name="ln1028">void</a>
<a name="ln1029">PackageItem::CalculateZoomWidths(BView *owner)</a>
<a name="ln1030">{</a>
<a name="ln1031">	owner-&gt;PushState();</a>
<a name="ln1032"> </a>
<a name="ln1033">	// More details</a>
<a name="ln1034">	float offsetWidth = 2 * be_control_look-&gt;DefaultItemSpacing()</a>
<a name="ln1035">		+ be_plain_font-&gt;Size()</a>
<a name="ln1036">		+ fSuperItem-&gt;GetIconSize(true) + fLabelOffset;</a>
<a name="ln1037">	// Name and repo</a>
<a name="ln1038">	owner-&gt;SetFont(be_plain_font);</a>
<a name="ln1039">	float stringWidth = owner-&gt;StringWidth(fName.String());</a>
<a name="ln1040">	owner-&gt;SetFont(&amp;fSmallFont);</a>
<a name="ln1041">	stringWidth += fLabelOffset + owner-&gt;StringWidth(fRepository.String());</a>
<a name="ln1042">	// Summary</a>
<a name="ln1043">	float summaryWidth = owner-&gt;StringWidth(fSummary.String());</a>
<a name="ln1044">	if (summaryWidth &gt; stringWidth)</a>
<a name="ln1045">		stringWidth = summaryWidth;</a>
<a name="ln1046">	// Version</a>
<a name="ln1047">	float versionWidth = owner-&gt;StringWidth(fDetailedVersion.String());</a>
<a name="ln1048">	if (versionWidth &gt; stringWidth)</a>
<a name="ln1049">		stringWidth = versionWidth;</a>
<a name="ln1050">	fMoreDetailsWidth = offsetWidth + stringWidth;</a>
<a name="ln1051"> </a>
<a name="ln1052">	// Less details</a>
<a name="ln1053">	offsetWidth = 2 * be_control_look-&gt;DefaultItemSpacing()</a>
<a name="ln1054">		+ be_plain_font-&gt;Size()</a>
<a name="ln1055">		+ fSuperItem-&gt;GetIconSize(false) + fLabelOffset;</a>
<a name="ln1056">	// Name and version</a>
<a name="ln1057">	owner-&gt;SetFont(be_plain_font);</a>
<a name="ln1058">	stringWidth = owner-&gt;StringWidth(fName.String());</a>
<a name="ln1059">	owner-&gt;SetFont(&amp;fSmallFont);</a>
<a name="ln1060">	stringWidth += fLabelOffset + owner-&gt;StringWidth(fSimpleVersion.String());</a>
<a name="ln1061">	// Summary</a>
<a name="ln1062">	if (summaryWidth &gt; stringWidth)</a>
<a name="ln1063">		stringWidth = summaryWidth;</a>
<a name="ln1064">	fLessDetailsWidth = offsetWidth + stringWidth;</a>
<a name="ln1065"> </a>
<a name="ln1066">	owner-&gt;PopState();</a>
<a name="ln1067">}</a>
<a name="ln1068"> </a>
<a name="ln1069"> </a>
<a name="ln1070">int</a>
<a name="ln1071">PackageItem::NameCompare(PackageItem* item)</a>
<a name="ln1072">{</a>
<a name="ln1073">	// sort by package name</a>
<a name="ln1074">	return fName.ICompare(item-&gt;fName);</a>
<a name="ln1075">}</a>
<a name="ln1076"> </a>
<a name="ln1077"> </a>
<a name="ln1078">void</a>
<a name="ln1079">PackageItem::SetDownloadProgress(float percent)</a>
<a name="ln1080">{</a>
<a name="ln1081">	fDownloadProgress = percent;</a>
<a name="ln1082">}</a>
<a name="ln1083"> </a>
<a name="ln1084"> </a>
<a name="ln1085">int</a>
<a name="ln1086">SortPackageItems(const BListItem* item1, const BListItem* item2)</a>
<a name="ln1087">{</a>
<a name="ln1088">	PackageItem* first = (PackageItem*)item1;</a>
<a name="ln1089">	PackageItem* second = (PackageItem*)item2;</a>
<a name="ln1090">	return first-&gt;NameCompare(second);</a>
<a name="ln1091">}</a>
<a name="ln1092"> </a>
<a name="ln1093"> </a>
<a name="ln1094">PackageListView::PackageListView()</a>
<a name="ln1095">	:</a>
<a name="ln1096">	BOutlineListView(&quot;Package list&quot;),</a>
<a name="ln1097">	fSuperUpdateItem(NULL),</a>
<a name="ln1098">	fSuperInstallItem(NULL),</a>
<a name="ln1099">	fSuperUninstallItem(NULL),</a>
<a name="ln1100">	fShowMoreDetails(false),</a>
<a name="ln1101">	fLastProgressItem(NULL),</a>
<a name="ln1102">	fLastProgressValue(-1)</a>
<a name="ln1103">{</a>
<a name="ln1104">	SetExplicitMinSize(BSize(B_SIZE_UNSET, 40));</a>
<a name="ln1105">	SetExplicitPreferredSize(BSize(B_SIZE_UNSET, 400));</a>
<a name="ln1106">}</a>
<a name="ln1107"> </a>
<a name="ln1108"> </a>
<a name="ln1109">void</a>
<a name="ln1110">PackageListView::FrameResized(float newWidth, float newHeight)</a>
<a name="ln1111">{</a>
<a name="ln1112">	BOutlineListView::FrameResized(newWidth, newHeight);</a>
<a name="ln1113">	Invalidate();</a>
<a name="ln1114">}</a>
<a name="ln1115"> </a>
<a name="ln1116"> </a>
<a name="ln1117">void</a>
<a name="ln1118">PackageListView::ExpandOrCollapse(BListItem *superItem, bool expand)</a>
<a name="ln1119">{</a>
<a name="ln1120">	BOutlineListView::ExpandOrCollapse(superItem, expand);</a>
<a name="ln1121">	Window()-&gt;PostMessage(kMsgSetZoomLimits);</a>
<a name="ln1122">}</a>
<a name="ln1123"> </a>
<a name="ln1124"> </a>
<a name="ln1125">void</a>
<a name="ln1126">PackageListView::AddPackage(uint32 install_type, const char* name,</a>
<a name="ln1127">	const char* cur_ver, const char* new_ver, const char* summary,</a>
<a name="ln1128">	const char* repository, const char* file_name)</a>
<a name="ln1129">{</a>
<a name="ln1130">	SuperItem* super;</a>
<a name="ln1131">	BString simpleVersion;</a>
<a name="ln1132">	BString detailedVersion(&quot;&quot;);</a>
<a name="ln1133">	BString repositoryText(B_TRANSLATE_COMMENT(&quot;from repository&quot;,</a>
<a name="ln1134">		&quot;List item text&quot;));</a>
<a name="ln1135">	repositoryText.Append(&quot; &quot;).Append(repository);</a>
<a name="ln1136"> </a>
<a name="ln1137">	switch (install_type) {</a>
<a name="ln1138">		case PACKAGE_UPDATE:</a>
<a name="ln1139">		{</a>
<a name="ln1140">			if (fSuperUpdateItem == NULL) {</a>
<a name="ln1141">				fSuperUpdateItem = new SuperItem(B_TRANSLATE_COMMENT(</a>
<a name="ln1142">					&quot;Packages to be updated&quot;, &quot;List super item label&quot;));</a>
<a name="ln1143">				AddItem(fSuperUpdateItem);</a>
<a name="ln1144">			}</a>
<a name="ln1145">			super = fSuperUpdateItem;</a>
<a name="ln1146"> </a>
<a name="ln1147">			simpleVersion.SetTo(new_ver);</a>
<a name="ln1148">			detailedVersion.Append(B_TRANSLATE_COMMENT(&quot;Updating version&quot;,</a>
<a name="ln1149">					&quot;List item text&quot;))</a>
<a name="ln1150">				.Append(&quot; &quot;).Append(cur_ver)</a>
<a name="ln1151">				.Append(&quot; &quot;).Append(B_TRANSLATE_COMMENT(&quot;to&quot;,</a>
<a name="ln1152">					&quot;List item text&quot;))</a>
<a name="ln1153">				.Append(&quot; &quot;).Append(new_ver);</a>
<a name="ln1154">			break;</a>
<a name="ln1155">		}</a>
<a name="ln1156"> </a>
<a name="ln1157">		case PACKAGE_INSTALL:</a>
<a name="ln1158">		{</a>
<a name="ln1159">			if (fSuperInstallItem == NULL) {</a>
<a name="ln1160">				fSuperInstallItem = new SuperItem(B_TRANSLATE_COMMENT(</a>
<a name="ln1161">					&quot;New packages to be installed&quot;, &quot;List super item label&quot;));</a>
<a name="ln1162">				AddItem(fSuperInstallItem);</a>
<a name="ln1163">			}</a>
<a name="ln1164">			super = fSuperInstallItem;</a>
<a name="ln1165"> </a>
<a name="ln1166">			simpleVersion.SetTo(new_ver);</a>
<a name="ln1167">			detailedVersion.Append(B_TRANSLATE_COMMENT(&quot;Installing version&quot;,</a>
<a name="ln1168">					&quot;List item text&quot;))</a>
<a name="ln1169">				.Append(&quot; &quot;).Append(new_ver);</a>
<a name="ln1170">			break;</a>
<a name="ln1171">		}</a>
<a name="ln1172"> </a>
<a name="ln1173">		case PACKAGE_UNINSTALL:</a>
<a name="ln1174">		{</a>
<a name="ln1175">			if (fSuperUninstallItem == NULL) {</a>
<a name="ln1176">				fSuperUninstallItem = new SuperItem(B_TRANSLATE_COMMENT(</a>
<a name="ln1177">					&quot;Packages to be uninstalled&quot;, &quot;List super item label&quot;));</a>
<a name="ln1178">				AddItem(fSuperUninstallItem);</a>
<a name="ln1179">			}</a>
<a name="ln1180">			super = fSuperUninstallItem;</a>
<a name="ln1181"> </a>
<a name="ln1182">			simpleVersion.SetTo(&quot;&quot;);</a>
<a name="ln1183">			detailedVersion.Append(B_TRANSLATE_COMMENT(&quot;Uninstalling version&quot;,</a>
<a name="ln1184">					&quot;List item text&quot;))</a>
<a name="ln1185">				.Append(&quot; &quot;).Append(cur_ver);</a>
<a name="ln1186">			break;</a>
<a name="ln1187">		}</a>
<a name="ln1188"> </a>
<a name="ln1189">		default:</a>
<a name="ln1190">			return;</a>
<a name="ln1191"> </a>
<a name="ln1192">	}</a>
<a name="ln1193">	PackageItem* item = new PackageItem(name, simpleVersion.String(),</a>
<a name="ln1194">		detailedVersion.String(), repositoryText.String(), summary, file_name,</a>
<a name="ln1195">		super);</a>
<a name="ln1196">	AddUnder(item, super);</a>
<a name="ln1197">	super-&gt;SetItemCount(CountItemsUnder(super, true));</a>
<a name="ln1198">	item-&gt;CalculateZoomWidths(this);</a>
<a name="ln1199">}</a>
<a name="ln1200"> </a>
<a name="ln1201"> </a>
<a name="ln1202">void</a>
<a name="ln1203">PackageListView::UpdatePackageProgress(const char* packageName, float percent)</a>
<a name="ln1204">{</a>
<a name="ln1205">	// Update only every 1 percent change</a>
<a name="ln1206">	int16 wholePercent = int16(percent);</a>
<a name="ln1207">	if (wholePercent == fLastProgressValue)</a>
<a name="ln1208">		return;</a>
<a name="ln1209">	fLastProgressValue = wholePercent;</a>
<a name="ln1210"> </a>
<a name="ln1211">	// A new package started downloading, find the PackageItem by name</a>
<a name="ln1212">	if (percent == 0) {</a>
<a name="ln1213">		fLastProgressItem = NULL;</a>
<a name="ln1214">		int32 count = FullListCountItems();</a>
<a name="ln1215">		for (int32 i = 0; i &lt; count; i++) {</a>
<a name="ln1216">			PackageItem* item = dynamic_cast&lt;PackageItem*&gt;(FullListItemAt(i));</a>
<a name="ln1217">			if (item != NULL &amp;&amp; strcmp(item-&gt;FileName(), packageName) == 0) {</a>
<a name="ln1218">				fLastProgressItem = item;</a>
<a name="ln1219">				fLastProgressItem-&gt;ShowProgressBar();</a>
<a name="ln1220">				break;</a>
<a name="ln1221">			}</a>
<a name="ln1222">		}</a>
<a name="ln1223">	}</a>
<a name="ln1224"> </a>
<a name="ln1225">	if (fLastProgressItem != NULL) {</a>
<a name="ln1226">		fLastProgressItem-&gt;SetDownloadProgress(percent);</a>
<a name="ln1227">		Invalidate();</a>
<a name="ln1228">	}</a>
<a name="ln1229">}</a>
<a name="ln1230"> </a>
<a name="ln1231"> </a>
<a name="ln1232">void</a>
<a name="ln1233">PackageListView::SortItems()</a>
<a name="ln1234">{</a>
<a name="ln1235">	if (fSuperUpdateItem != NULL)</a>
<a name="ln1236">		SortItemsUnder(fSuperUpdateItem, true, SortPackageItems);</a>
<a name="ln1237">	if (fSuperInstallItem != NULL)</a>
<a name="ln1238">		SortItemsUnder(fSuperInstallItem, true, SortPackageItems);</a>
<a name="ln1239">	if (fSuperUninstallItem != NULL)</a>
<a name="ln1240">		SortItemsUnder(fSuperUninstallItem, true, SortPackageItems);</a>
<a name="ln1241">}</a>
<a name="ln1242"> </a>
<a name="ln1243"> </a>
<a name="ln1244">float</a>
<a name="ln1245">PackageListView::ItemHeight()</a>
<a name="ln1246">{</a>
<a name="ln1247">	if (fSuperUpdateItem != NULL)</a>
<a name="ln1248">		return fSuperUpdateItem-&gt;GetPackageItemHeight();</a>
<a name="ln1249">	if (fSuperInstallItem != NULL)</a>
<a name="ln1250">		return fSuperInstallItem-&gt;GetPackageItemHeight();</a>
<a name="ln1251">	if (fSuperUninstallItem != NULL)</a>
<a name="ln1252">		return fSuperUninstallItem-&gt;GetPackageItemHeight();</a>
<a name="ln1253">	return 0;</a>
<a name="ln1254">}</a>
<a name="ln1255"> </a>
<a name="ln1256"> </a>
<a name="ln1257">void</a>
<a name="ln1258">PackageListView::SetMoreDetails(bool showMore)</a>
<a name="ln1259">{</a>
<a name="ln1260">	if (showMore == fShowMoreDetails)</a>
<a name="ln1261">		return;</a>
<a name="ln1262">	fShowMoreDetails = showMore;</a>
<a name="ln1263">	_SetItemHeights();</a>
<a name="ln1264">	InvalidateLayout();</a>
<a name="ln1265">	ResizeToPreferred();</a>
<a name="ln1266">}</a>
<a name="ln1267"> </a>
<a name="ln1268"> </a>
<a name="ln1269">BPoint</a>
<a name="ln1270">PackageListView::ZoomPoint()</a>
<a name="ln1271">{</a>
<a name="ln1272">	BPoint zoomPoint(0, 0);</a>
<a name="ln1273">	int32 count = CountItems();</a>
<a name="ln1274">	for (int32 i = 0; i &lt; count; i++)</a>
<a name="ln1275">	{</a>
<a name="ln1276">		BListItem* item = ItemAt(i);</a>
<a name="ln1277">		float itemWidth = 0;</a>
<a name="ln1278">		if (item-&gt;OutlineLevel() == 0) {</a>
<a name="ln1279">			SuperItem* sItem = dynamic_cast&lt;SuperItem*&gt;(item);</a>
<a name="ln1280">			itemWidth = sItem-&gt;ZoomWidth(this);</a>
<a name="ln1281">		} else {</a>
<a name="ln1282">			PackageItem* pItem = dynamic_cast&lt;PackageItem*&gt;(item);</a>
<a name="ln1283">			itemWidth = fShowMoreDetails ? pItem-&gt;MoreDetailsWidth()</a>
<a name="ln1284">				: pItem-&gt;LessDetailsWidth();</a>
<a name="ln1285">		}</a>
<a name="ln1286">		if (itemWidth &gt; zoomPoint.x)</a>
<a name="ln1287">			zoomPoint.x = itemWidth;</a>
<a name="ln1288">	}</a>
<a name="ln1289">	if (count &gt; 0)</a>
<a name="ln1290">		zoomPoint.y = ItemFrame(count - 1).bottom;</a>
<a name="ln1291"> </a>
<a name="ln1292">	return zoomPoint;</a>
<a name="ln1293">}</a>
<a name="ln1294"> </a>
<a name="ln1295"> </a>
<a name="ln1296">void</a>
<a name="ln1297">PackageListView::_SetItemHeights()</a>
<a name="ln1298">{</a>
<a name="ln1299">	int32 itemCount = 0;</a>
<a name="ln1300">	float itemHeight = 0;</a>
<a name="ln1301">	BListItem* item = NULL;</a>
<a name="ln1302">	if (fSuperUpdateItem != NULL) {</a>
<a name="ln1303">		fSuperUpdateItem-&gt;SetDetailLevel(fShowMoreDetails);</a>
<a name="ln1304">		itemHeight = fSuperUpdateItem-&gt;GetPackageItemHeight();</a>
<a name="ln1305">		itemCount = CountItemsUnder(fSuperUpdateItem, true);</a>
<a name="ln1306">		for (int32 i = 0; i &lt; itemCount; i++) {</a>
<a name="ln1307">			item = ItemUnderAt(fSuperUpdateItem, true, i);</a>
<a name="ln1308">			item-&gt;SetHeight(itemHeight);</a>
<a name="ln1309">		}</a>
<a name="ln1310">	}</a>
<a name="ln1311">	if (fSuperInstallItem != NULL) {</a>
<a name="ln1312">		fSuperInstallItem-&gt;SetDetailLevel(fShowMoreDetails);</a>
<a name="ln1313">		itemHeight = fSuperInstallItem-&gt;GetPackageItemHeight();</a>
<a name="ln1314">		itemCount = CountItemsUnder(fSuperInstallItem, true);</a>
<a name="ln1315">		for (int32 i = 0; i &lt; itemCount; i++) {</a>
<a name="ln1316">			item = ItemUnderAt(fSuperInstallItem, true, i);</a>
<a name="ln1317">			item-&gt;SetHeight(itemHeight);</a>
<a name="ln1318">		}</a>
<a name="ln1319"> </a>
<a name="ln1320">	}</a>
<a name="ln1321">	if (fSuperUninstallItem != NULL) {</a>
<a name="ln1322">		fSuperUninstallItem-&gt;SetDetailLevel(fShowMoreDetails);</a>
<a name="ln1323">		itemHeight = fSuperUninstallItem-&gt;GetPackageItemHeight();</a>
<a name="ln1324">		itemCount = CountItemsUnder(fSuperUninstallItem, true);</a>
<a name="ln1325">		for (int32 i = 0; i &lt; itemCount; i++) {</a>
<a name="ln1326">			item = ItemUnderAt(fSuperUninstallItem, true, i);</a>
<a name="ln1327">			item-&gt;SetHeight(itemHeight);</a>
<a name="ln1328">		}</a>
<a name="ln1329"> </a>
<a name="ln1330">	}</a>
<a name="ln1331">}</a>

</code></pre>
<div class="balloon" rel="339"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="537"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
