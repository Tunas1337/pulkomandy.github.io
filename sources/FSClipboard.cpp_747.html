
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>FSClipboard.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">Open Tracker License</a>
<a name="ln3"> </a>
<a name="ln4">Terms and Conditions</a>
<a name="ln5"> </a>
<a name="ln6">Copyright (c) 1991-2000, Be Incorporated. All rights reserved.</a>
<a name="ln7"> </a>
<a name="ln8">Permission is hereby granted, free of charge, to any person obtaining a copy of</a>
<a name="ln9">this software and associated documentation files (the &quot;Software&quot;), to deal in</a>
<a name="ln10">the Software without restriction, including without limitation the rights to</a>
<a name="ln11">use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</a>
<a name="ln12">of the Software, and to permit persons to whom the Software is furnished to do</a>
<a name="ln13">so, subject to the following conditions:</a>
<a name="ln14"> </a>
<a name="ln15">The above copyright notice and this permission notice applies to all licensees</a>
<a name="ln16">and shall be included in all copies or substantial portions of the Software..</a>
<a name="ln17"> </a>
<a name="ln18">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</a>
<a name="ln19">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF TITLE, MERCHANTABILITY,</a>
<a name="ln20">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL</a>
<a name="ln21">BE INCORPORATED BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN</a>
<a name="ln22">AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION</a>
<a name="ln23">WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</a>
<a name="ln24"> </a>
<a name="ln25">Except as contained in this notice, the name of Be Incorporated shall not be</a>
<a name="ln26">used in advertising or otherwise to promote the sale, use or other dealings in</a>
<a name="ln27">this Software without prior written authorization from Be Incorporated.</a>
<a name="ln28"> </a>
<a name="ln29">Tracker(TM), Be(R), BeOS(R), and BeIA(TM) are trademarks or registered trademarks</a>
<a name="ln30">of Be Incorporated in the United States and other countries. Other brand product</a>
<a name="ln31">names are registered trademarks or trademarks of their respective holders.</a>
<a name="ln32">All rights reserved.</a>
<a name="ln33">*/</a>
<a name="ln34"> </a>
<a name="ln35"> </a>
<a name="ln36">#include &quot;FSClipboard.h&quot;</a>
<a name="ln37"> </a>
<a name="ln38">#include &lt;Clipboard.h&gt;</a>
<a name="ln39">#include &lt;Alert.h&gt;</a>
<a name="ln40">#include &lt;Catalog.h&gt;</a>
<a name="ln41">#include &lt;Locale.h&gt;</a>
<a name="ln42">#include &lt;NodeMonitor.h&gt;</a>
<a name="ln43"> </a>
<a name="ln44">#include &quot;Commands.h&quot;</a>
<a name="ln45">#include &quot;FSUtils.h&quot;</a>
<a name="ln46">#include &quot;Tracker.h&quot;</a>
<a name="ln47"> </a>
<a name="ln48"> </a>
<a name="ln49">// prototypes</a>
<a name="ln50">static void MakeNodeFromName(node_ref* node, char* name);</a>
<a name="ln51">static inline void MakeRefName(char* refName, const node_ref* node);</a>
<a name="ln52">static inline void MakeModeName(char* modeName, const node_ref* node);</a>
<a name="ln53">static inline void MakeModeNameFromRefName(char* modeName, char* refName);</a>
<a name="ln54">static inline bool CompareModeAndRefName(const char* modeName,</a>
<a name="ln55">	const char* refName);</a>
<a name="ln56"> </a>
<a name="ln57">#if 0</a>
<a name="ln58">static bool</a>
<a name="ln59">FSClipboardCheckIntegrity()</a>
<a name="ln60">{</a>
<a name="ln61">	return true;</a>
<a name="ln62">}</a>
<a name="ln63">#endif</a>
<a name="ln64"> </a>
<a name="ln65">static void</a>
<a name="ln66">MakeNodeFromName(node_ref* node, char* name)</a>
<a name="ln67">{</a>
<a name="ln68">	char* nodeString = strchr(name, '_');</a>
<a name="ln69">	if (nodeString != NULL) {</a>
<a name="ln70">		node-&gt;node = strtoll(nodeString + 1, (char**)NULL, 10);</a>
<a name="ln71">		node-&gt;device = atoi(name + 1);</a>
<a name="ln72">	}</a>
<a name="ln73">}</a>
<a name="ln74"> </a>
<a name="ln75"> </a>
<a name="ln76">static inline void</a>
<a name="ln77">MakeRefName(char* refName, const node_ref* node)</a>
<a name="ln78">{</a>
<a name="ln79">	sprintf(refName, &quot;r%&quot; B_PRIdDEV &quot;_%&quot; B_PRIdINO, node-&gt;device, node-&gt;node);</a>
<a name="ln80">}</a>
<a name="ln81"> </a>
<a name="ln82"> </a>
<a name="ln83">static inline void</a>
<a name="ln84">MakeModeName(char* modeName, const node_ref* node)</a>
<a name="ln85">{</a>
<a name="ln86">	sprintf(modeName, &quot;m%&quot; B_PRIdDEV &quot;_%&quot; B_PRIdINO, node-&gt;device, node-&gt;node);</a>
<a name="ln87">}</a>
<a name="ln88"> </a>
<a name="ln89"> </a>
<a name="ln90">static inline void</a>
<a name="ln91">MakeModeName(char* name)</a>
<a name="ln92">{</a>
<a name="ln93">	name[0] = 'm';</a>
<a name="ln94">}</a>
<a name="ln95"> </a>
<a name="ln96"> </a>
<a name="ln97">static inline void</a>
<a name="ln98">MakeModeNameFromRefName(char* modeName, char* refName)</a>
<a name="ln99">{</a>
<a name="ln100">	strcpy(modeName, refName);</a>
<a name="ln101">	modeName[0] = 'm';</a>
<a name="ln102">}</a>
<a name="ln103"> </a>
<a name="ln104"> </a>
<a name="ln105">static inline bool</a>
<a name="ln106">CompareModeAndRefName(const char* modeName, const char* refName)</a>
<a name="ln107">{</a>
<a name="ln108">	return !strcmp(refName + 1, modeName + 1);</a>
<a name="ln109">}</a>
<a name="ln110"> </a>
<a name="ln111"> </a>
<a name="ln112">//	#pragma mark - FSClipBoard</a>
<a name="ln113"> </a>
<a name="ln114"> </a>
<a name="ln115">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln116">#define B_TRANSLATION_CONTEXT &quot;FSClipBoard&quot;</a>
<a name="ln117"> </a>
<a name="ln118"> </a>
<a name="ln119">bool</a>
<a name="ln120">FSClipboardHasRefs()</a>
<a name="ln121">{</a>
<a name="ln122">	bool result = false;</a>
<a name="ln123"> </a>
<a name="ln124">	if (be_clipboard-&gt;Lock()) {</a>
<a name="ln125">		BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln126">		if (clip != NULL) {</a>
<a name="ln127">#ifdef B_BEOS_VERSION_DANO</a>
<a name="ln128">			const</a>
<a name="ln129">#endif</a>
<a name="ln130">			char* refName;</a>
<a name="ln131">#ifdef B_BEOS_VERSION_DANO</a>
<a name="ln132">			const</a>
<a name="ln133">#endif</a>
<a name="ln134">			char* modeName;</a>
<a name="ln135">			uint32 type;</a>
<a name="ln136">			int32 count;</a>
<a name="ln137">			if (clip-&gt;GetInfo(B_REF_TYPE, 0, &amp;refName, &amp;type, &amp;count) == B_OK</a>
<a name="ln138">				&amp;&amp; clip-&gt;GetInfo(B_INT32_TYPE, 0, &amp;modeName, &amp;type, &amp;count)</a>
<a name="ln139">					== B_OK) {</a>
<a name="ln140">				result = CompareModeAndRefName(modeName, refName);</a>
<a name="ln141">			}</a>
<a name="ln142">		}</a>
<a name="ln143">		be_clipboard-&gt;Unlock();</a>
<a name="ln144">	}</a>
<a name="ln145">	return result;</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148"> </a>
<a name="ln149">void</a>
<a name="ln150">FSClipboardStartWatch(BMessenger target)</a>
<a name="ln151">{</a>
<a name="ln152">	TTracker* tracker = dynamic_cast&lt;TTracker*&gt;(be_app);</a>
<a name="ln153">	if (tracker != NULL &amp;&amp; tracker-&gt;ClipboardRefsWatcher() != NULL)</a>
<a name="ln154">		tracker-&gt;ClipboardRefsWatcher()-&gt;AddToNotifyList(target);</a>
<a name="ln155">	else {</a>
<a name="ln156">		// this code is used by external apps using objects using FSClipboard</a>
<a name="ln157">		// functions, i.e. applications using FilePanel</a>
<a name="ln158">		BMessenger messenger(kTrackerSignature);</a>
<a name="ln159">		if (messenger.IsValid()) {</a>
<a name="ln160">			BMessage message(kStartWatchClipboardRefs);</a>
<a name="ln161">			message.AddMessenger(&quot;target&quot;, target);</a>
<a name="ln162">			messenger.SendMessage(&amp;message);</a>
<a name="ln163">		}</a>
<a name="ln164">	}</a>
<a name="ln165">}</a>
<a name="ln166"> </a>
<a name="ln167"> </a>
<a name="ln168">void</a>
<a name="ln169">FSClipboardStopWatch(BMessenger target)</a>
<a name="ln170">{</a>
<a name="ln171">	TTracker* tracker = dynamic_cast&lt;TTracker*&gt;(be_app);</a>
<a name="ln172">	if (tracker != NULL &amp;&amp; tracker-&gt;ClipboardRefsWatcher() != NULL)</a>
<a name="ln173">		tracker-&gt;ClipboardRefsWatcher()-&gt;AddToNotifyList(target);</a>
<a name="ln174">	else {</a>
<a name="ln175">		// this code is used by external apps using objects using FSClipboard</a>
<a name="ln176">		// functions, i.e. applications using FilePanel</a>
<a name="ln177">		BMessenger messenger(kTrackerSignature);</a>
<a name="ln178">		if (messenger.IsValid()) {</a>
<a name="ln179">			BMessage message(kStopWatchClipboardRefs);</a>
<a name="ln180">			message.AddMessenger(&quot;target&quot;, target);</a>
<a name="ln181">			messenger.SendMessage(&amp;message);</a>
<a name="ln182">		}</a>
<a name="ln183">	}</a>
<a name="ln184">}</a>
<a name="ln185"> </a>
<a name="ln186"> </a>
<a name="ln187">void</a>
<a name="ln188">FSClipboardClear()</a>
<a name="ln189">{</a>
<a name="ln190">	if (!be_clipboard-&gt;Lock())</a>
<a name="ln191">		return;</a>
<a name="ln192"> </a>
<a name="ln193">	be_clipboard-&gt;Clear();</a>
<a name="ln194">	be_clipboard-&gt;Commit();</a>
<a name="ln195">	be_clipboard-&gt;Unlock();</a>
<a name="ln196">}</a>
<a name="ln197"> </a>
<a name="ln198"> </a>
<a name="ln199">/** This function adds the given poses list to the clipboard, for both copy</a>
<a name="ln200"> *	and cut. All poses in the list must have &quot;directory&quot; as parent.</a>
<a name="ln201"> *	&quot;moveMode&quot; is either kMoveSelection or kCopySelection.</a>
<a name="ln202"> *	It will check if the entries are already present, so that there can only</a>
<a name="ln203"> *	be one reference to them in the clipboard.</a>
<a name="ln204"> */</a>
<a name="ln205">uint32</a>
<a name="ln206">FSClipboardAddPoses(const node_ref* directory, PoseList* list,</a>
<a name="ln207">	uint32 moveMode, bool clearClipboard)</a>
<a name="ln208">{</a>
<a name="ln209">	uint32 refsAdded = 0;</a>
<a name="ln210">	int32 listCount = list-&gt;CountItems();</a>
<a name="ln211"> </a>
<a name="ln212">	if (listCount == 0 || !be_clipboard-&gt;Lock())</a>
<a name="ln213">		return 0;</a>
<a name="ln214"> </a>
<a name="ln215">	// update message to be send to all listeners</a>
<a name="ln216">	BMessage updateMessage(kFSClipboardChanges);</a>
<a name="ln217">	updateMessage.AddInt32(&quot;device&quot;, directory-&gt;device);</a>
<a name="ln218">	updateMessage.AddInt64(&quot;directory&quot;, directory-&gt;node);</a>
<a name="ln219">	updateMessage.AddBool(&quot;clearClipboard&quot;, clearClipboard);</a>
<a name="ln220"> </a>
<a name="ln221">	TClipboardNodeRef clipNode;</a>
<a name="ln222">	clipNode.moveMode = moveMode;</a>
<a name="ln223"> </a>
<a name="ln224">	if (clearClipboard)</a>
<a name="ln225">		be_clipboard-&gt;Clear();</a>
<a name="ln226"> </a>
<a name="ln227">	BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln228">	if (clip != NULL) {</a>
<a name="ln229">		for (int32 index = 0; index &lt; listCount; index++) {</a>
<a name="ln230">			char refName[64], modeName[64];</a>
<a name="ln231">			BPose* pose = (BPose*)list-&gt;ItemAt(index);</a>
<a name="ln232">			Model* model = pose-&gt;TargetModel();</a>
<a name="ln233">			const node_ref* node = model-&gt;NodeRef();</a>
<a name="ln234"> </a>
<a name="ln235">			BEntry entry;</a>
<a name="ln236">			model-&gt;GetEntry(&amp;entry);</a>
<a name="ln237">			if (model-&gt;IsVolume()</a>
<a name="ln238">				|| model-&gt;IsRoot()</a>
<a name="ln239">				|| model-&gt;IsTrash()</a>
<a name="ln240">				|| model-&gt;IsDesktop())</a>
<a name="ln241">				continue;</a>
<a name="ln242"> </a>
<a name="ln243">			MakeRefName(refName, node);</a>
<a name="ln244">			MakeModeNameFromRefName(modeName, refName);</a>
<a name="ln245"> </a>
<a name="ln246">			if (clearClipboard) {</a>
<a name="ln247">				if (clip-&gt;AddInt32(modeName, (int32)moveMode) == B_OK) {</a>
<a name="ln248">					if (clip-&gt;AddRef(refName, model-&gt;EntryRef()) == B_OK) {</a>
<a name="ln249">						pose-&gt;SetClipboardMode(moveMode);</a>
<a name="ln250"> </a>
<a name="ln251">						clipNode.node = *node;</a>
<a name="ln252">						updateMessage.AddData(&quot;tcnode&quot;, T_CLIPBOARD_NODE,</a>
<a name="ln253">							&amp;clipNode, sizeof(TClipboardNodeRef), true,</a>
<a name="ln254">							listCount);</a>
<a name="ln255"> </a>
<a name="ln256">						refsAdded++;</a>
<a name="ln257">					} else</a>
<a name="ln258">						clip-&gt;RemoveName(modeName);</a>
<a name="ln259">				}</a>
<a name="ln260">			} else {</a>
<a name="ln261">				if (clip-&gt;ReplaceInt32(modeName, (int32)moveMode) == B_OK) {</a>
<a name="ln262">					// replace old mode if entry already exists in clipboard</a>
<a name="ln263">					if (clip-&gt;ReplaceRef(refName, model-&gt;EntryRef()) == B_OK) {</a>
<a name="ln264">						pose-&gt;SetClipboardMode(moveMode);</a>
<a name="ln265"> </a>
<a name="ln266">						clipNode.node = *node;</a>
<a name="ln267">						updateMessage.AddData(&quot;tcnode&quot;, T_CLIPBOARD_NODE,</a>
<a name="ln268">							&amp;clipNode, sizeof(TClipboardNodeRef), true,</a>
<a name="ln269">							listCount);</a>
<a name="ln270"> </a>
<a name="ln271">						refsAdded++;</a>
<a name="ln272">					} else {</a>
<a name="ln273">						clip-&gt;RemoveName(modeName);</a>
<a name="ln274"> </a>
<a name="ln275">						clipNode.node = *node;</a>
<a name="ln276">						clipNode.moveMode = kDelete;	// note removing node</a>
<a name="ln277">						updateMessage.AddData(&quot;tcnode&quot;, T_CLIPBOARD_NODE,</a>
<a name="ln278">							&amp;clipNode, sizeof(TClipboardNodeRef), true,</a>
<a name="ln279">							listCount);</a>
<a name="ln280">						clipNode.moveMode = moveMode;</a>
<a name="ln281">							// set it back to current value</a>
<a name="ln282">					}</a>
<a name="ln283">				} else {</a>
<a name="ln284">					// add it if it doesn't exist</a>
<a name="ln285">					if (clip-&gt;AddRef(refName, model-&gt;EntryRef()) == B_OK</a>
<a name="ln286">						&amp;&amp; clip-&gt;AddInt32(modeName, (int32)moveMode) == B_OK) {</a>
<a name="ln287">						pose-&gt;SetClipboardMode(moveMode);</a>
<a name="ln288"> </a>
<a name="ln289">						clipNode.node = *node;</a>
<a name="ln290">						updateMessage.AddData(&quot;tcnode&quot;, T_CLIPBOARD_NODE,</a>
<a name="ln291">							&amp;clipNode, sizeof(TClipboardNodeRef), true,</a>
<a name="ln292">							listCount);</a>
<a name="ln293"> </a>
<a name="ln294">						refsAdded++;</a>
<a name="ln295">					} else {</a>
<a name="ln296">						clip-&gt;RemoveName(modeName);</a>
<a name="ln297">						clip-&gt;RemoveName(refName);</a>
<a name="ln298">						// here notifying delete isn't needed as node didn't</a>
<a name="ln299">						// exist in clipboard</a>
<a name="ln300">					}</a>
<a name="ln301">				}</a>
<a name="ln302">			}</a>
<a name="ln303">		}</a>
<a name="ln304">		be_clipboard-&gt;Commit();</a>
<a name="ln305">	}</a>
<a name="ln306">	be_clipboard-&gt;Unlock();</a>
<a name="ln307"> </a>
<a name="ln308">	BMessenger(kTrackerSignature).SendMessage(&amp;updateMessage);</a>
<a name="ln309">		// Tracker will notify all listeners</a>
<a name="ln310"> </a>
<a name="ln311">	return refsAdded;</a>
<a name="ln312">}</a>
<a name="ln313"> </a>
<a name="ln314"> </a>
<a name="ln315">uint32</a>
<a name="ln316">FSClipboardRemovePoses(const node_ref* directory, PoseList* list)</a>
<a name="ln317">{</a>
<a name="ln318">	if (!be_clipboard-&gt;Lock())</a>
<a name="ln319">		return 0;</a>
<a name="ln320"> </a>
<a name="ln321">	// update message to be send to all listeners</a>
<a name="ln322">	BMessage updateMessage(kFSClipboardChanges);</a>
<a name="ln323">	updateMessage.AddInt32(&quot;device&quot;, directory-&gt;device);</a>
<a name="ln324">	updateMessage.AddInt64(&quot;directory&quot;, directory-&gt;node);</a>
<a name="ln325">	updateMessage.AddBool(&quot;clearClipboard&quot;, false);</a>
<a name="ln326"> </a>
<a name="ln327">	TClipboardNodeRef clipNode;</a>
<a name="ln328">	clipNode.moveMode = kDelete;</a>
<a name="ln329"> </a>
<a name="ln330">	uint32 refsRemoved = 0;</a>
<a name="ln331"> </a>
<a name="ln332">	BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln333">	if (clip != NULL) {</a>
<a name="ln334">		int32 listCount = list-&gt;CountItems();</a>
<a name="ln335"> </a>
<a name="ln336">		for (int32 index = 0; index &lt; listCount; index++) {</a>
<a name="ln337">			char refName[64], modeName[64];</a>
<a name="ln338">			BPose* pose = (BPose*)list-&gt;ItemAt(index);</a>
<a name="ln339"> </a>
<a name="ln340">			clipNode.node = *pose-&gt;TargetModel()-&gt;NodeRef();</a>
<a name="ln341">			MakeRefName(refName, &amp;clipNode.node);</a>
<a name="ln342">			MakeModeName(modeName);</a>
<a name="ln343"> </a>
<a name="ln344">			if (clip-&gt;RemoveName(refName) == B_OK</a>
<a name="ln345">				&amp;&amp; clip-&gt;RemoveName(modeName)) {</a>
<a name="ln346">				updateMessage.AddData(&quot;tcnode&quot;, T_CLIPBOARD_NODE, &amp;clipNode,</a>
<a name="ln347">					sizeof(TClipboardNodeRef), true, listCount);</a>
<a name="ln348">				refsRemoved++;</a>
<a name="ln349">			}</a>
<a name="ln350">		}</a>
<a name="ln351">		be_clipboard-&gt;Commit();</a>
<a name="ln352">	}</a>
<a name="ln353">	be_clipboard-&gt;Unlock();</a>
<a name="ln354"> </a>
<a name="ln355">	BMessenger(kTrackerSignature).SendMessage(&amp;updateMessage);</a>
<a name="ln356">		// Tracker will notify all listeners</a>
<a name="ln357"> </a>
<a name="ln358">	return refsRemoved;</a>
<a name="ln359">}</a>
<a name="ln360"> </a>
<a name="ln361"> </a>
<a name="ln362">/** Pastes entries from the clipboard to the target model's directory.</a>
<a name="ln363"> *	Updates moveModes and notifies listeners if necessary.</a>
<a name="ln364"> */</a>
<a name="ln365">bool</a>
<a name="ln366">FSClipboardPaste(Model* model, uint32 linksMode)</a>
<a name="ln367">{</a>
<a name="ln368">	if (!FSClipboardHasRefs())</a>
<a name="ln369">		return false;</a>
<a name="ln370"> </a>
<a name="ln371">	BMessenger tracker(kTrackerSignature);</a>
<a name="ln372"> </a>
<a name="ln373">	node_ref* destNodeRef = (node_ref*)model-&gt;NodeRef();</a>
<a name="ln374"> </a>
<a name="ln375">	// these will be passed to the asynchronous copy/move process</a>
<a name="ln376">	BObjectList&lt;entry_ref&gt;* moveList = new BObjectList&lt;entry_ref&gt;(0, true);</a>
<a name="ln377">	BObjectList&lt;entry_ref&gt;* copyList = new BObjectList&lt;entry_ref&gt;(0, true);</a>
<a name="ln378"> </a>
<a name="ln379">	if ((be_clipboard-&gt;Lock())) {</a>
<a name="ln380">		BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln381">		if (clip != NULL) {</a>
<a name="ln382">			char modeName[64];</a>
<a name="ln383">			uint32 moveMode = 0;</a>
<a name="ln384"> </a>
<a name="ln385">			BMessage* updateMessage = NULL;</a>
<a name="ln386">			node_ref updateNodeRef;</a>
<a name="ln387">			updateNodeRef.device = -1;</a>
<a name="ln388"> </a>
<a name="ln389">			char* refName;</a>
<a name="ln390">			type_code type;</a>
<a name="ln391">			int32 count;</a>
<a name="ln392">			for (int32 index = 0; clip-&gt;GetInfo(B_REF_TYPE, index,</a>
<a name="ln393">#ifdef B_BEOS_VERSION_DANO</a>
<a name="ln394">				(const char**)</a>
<a name="ln395">#endif</a>
<a name="ln396">				&amp;refName, &amp;type, &amp;count) == B_OK; index++) {</a>
<a name="ln397">				entry_ref ref;</a>
<a name="ln398">				if (clip-&gt;FindRef(refName, &amp;ref) != B_OK)</a>
<a name="ln399">					continue;</a>
<a name="ln400"> </a>
<a name="ln401">				// If the entry_ref's directory has changed, send previous notification</a>
<a name="ln402">				// (if any), and start new one for the new directory</a>
<a name="ln403">				if (updateNodeRef.device != ref.device</a>
<a name="ln404">					|| updateNodeRef.node != ref.directory) {</a>
<a name="ln405">					if (updateMessage != NULL) {</a>
<a name="ln406">						tracker.SendMessage(updateMessage);</a>
<a name="ln407">						delete updateMessage;</a>
<a name="ln408">					}</a>
<a name="ln409"> </a>
<a name="ln410">					updateNodeRef.device = ref.device;</a>
<a name="ln411">					updateNodeRef.node = ref.directory;</a>
<a name="ln412"> </a>
<a name="ln413">					updateMessage = new BMessage(kFSClipboardChanges);</a>
<a name="ln414">					updateMessage-&gt;AddInt32(&quot;device&quot;, updateNodeRef.device);</a>
<a name="ln415">					updateMessage-&gt;AddInt64(&quot;directory&quot;, updateNodeRef.node);</a>
<a name="ln416">				}</a>
<a name="ln417"> </a>
<a name="ln418">				// we need this data later on</a>
<a name="ln419">				MakeModeNameFromRefName(modeName, refName);</a>
<a name="ln420">				if (!linksMode &amp;&amp; clip-&gt;FindInt32(modeName, (int32*)&amp;moveMode)</a>
<a name="ln421">					!= B_OK) {</a>
<a name="ln422">					continue;</a>
<a name="ln423">				}</a>
<a name="ln424"> </a>
<a name="ln425">				BEntry entry(&amp;ref);</a>
<a name="ln426"> </a>
<a name="ln427">				uint32 newMoveMode = 0;</a>
<a name="ln428">				bool sameDirectory = destNodeRef-&gt;device == ref.device</a>
<a name="ln429">					&amp;&amp; destNodeRef-&gt;node == ref.directory;</a>
<a name="ln430"> </a>
<a name="ln431">				if (!entry.Exists()) {</a>
<a name="ln432">					// The entry doesn't exist anymore, so we'll remove</a>
<a name="ln433">					// that entry from the clipboard as well</a>
<a name="ln434">					clip-&gt;RemoveName(refName);</a>
<a name="ln435">					clip-&gt;RemoveName(modeName);</a>
<a name="ln436"> </a>
<a name="ln437">					newMoveMode = kDelete;</a>
<a name="ln438">				} else {</a>
<a name="ln439">					// the entry does exist, so lets see what we will</a>
<a name="ln440">					// do with it</a>
<a name="ln441">					if (!sameDirectory) {</a>
<a name="ln442">						if (linksMode || moveMode == kMoveSelectionTo) {</a>
<a name="ln443">							// the linksMode uses the moveList as well</a>
<a name="ln444">							moveList-&gt;AddItem(new entry_ref(ref));</a>
<a name="ln445">						} else if (moveMode == kCopySelectionTo)</a>
<a name="ln446">							copyList-&gt;AddItem(new entry_ref(ref));</a>
<a name="ln447">					}</a>
<a name="ln448"> </a>
<a name="ln449">					// if the entry should have been removed from its</a>
<a name="ln450">					// directory, we want to copy that entry next time, no</a>
<a name="ln451">					// matter if the items don't have to be moved at all</a>
<a name="ln452">					// (source == target)</a>
<a name="ln453">					if (moveMode == kMoveSelectionTo)</a>
<a name="ln454">						newMoveMode = kCopySelectionTo;</a>
<a name="ln455">				}</a>
<a name="ln456"> </a>
<a name="ln457">				// add the change to the update message (if necessary)</a>
<a name="ln458">				if (newMoveMode) {</a>
<a name="ln459">					clip-&gt;ReplaceInt32(modeName, kCopySelectionTo);</a>
<a name="ln460"> </a>
<a name="ln461">					TClipboardNodeRef clipNode;</a>
<a name="ln462">					MakeNodeFromName(&amp;clipNode.node, modeName);</a>
<a name="ln463">					clipNode.moveMode = kDelete;</a>
<a name="ln464">					updateMessage-&gt;AddData(&quot;tcnode&quot;, T_CLIPBOARD_NODE,</a>
<a name="ln465">						&amp;clipNode, sizeof(TClipboardNodeRef), true);</a>
<a name="ln466">				}</a>
<a name="ln467">			}</a>
<a name="ln468">			be_clipboard-&gt;Commit();</a>
<a name="ln469"> </a>
<a name="ln470">			// send notification for the last directory</a>
<a name="ln471">			if (updateMessage != NULL) {</a>
<a name="ln472">				tracker.SendMessage(updateMessage);</a>
<a name="ln473">				delete updateMessage;</a>
<a name="ln474">			}</a>
<a name="ln475">		}</a>
<a name="ln476">		be_clipboard-&gt;Unlock();</a>
<a name="ln477">	}</a>
<a name="ln478"> </a>
<a name="ln479">	bool okToMove = true;</a>
<a name="ln480"> </a>
<a name="ln481">	// can't copy/paste to root('/') directory</a>
<a name="ln482">	if (model-&gt;IsRoot()) {</a>
<a name="ln483">		BAlert* alert = new BAlert(&quot;&quot;,</a>
<a name="ln484">			B_TRANSLATE(&quot;You must drop items on one of the disk icons &quot;</a>
<a name="ln485">			&quot;in the \&quot;Disks\&quot; window.&quot;), B_TRANSLATE(&quot;Cancel&quot;), NULL, NULL,</a>
<a name="ln486">			B_WIDTH_AS_USUAL, B_WARNING_ALERT);</a>
<a name="ln487">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln488">		alert-&gt;Go();</a>
<a name="ln489">		okToMove = false;</a>
<a name="ln490">	}</a>
<a name="ln491"> </a>
<a name="ln492">	BEntry entry;</a>
<a name="ln493">	model-&gt;GetEntry(&amp;entry);</a>
<a name="ln494"> </a>
<a name="ln495">	// can't copy items into the trash</a>
<a name="ln496">	if (copyList-&gt;CountItems() &gt; 0 &amp;&amp; model-&gt;IsTrash()) {</a>
<a name="ln497">		BAlert* alert = new BAlert(&quot;&quot;,</a>
<a name="ln498">			B_TRANSLATE(&quot;Sorry, you can't copy items to the Trash.&quot;),</a>
<a name="ln499">			B_TRANSLATE(&quot;Cancel&quot;), NULL, NULL, B_WIDTH_AS_USUAL,</a>
<a name="ln500">			B_WARNING_ALERT);</a>
<a name="ln501">		alert-&gt;SetFlags(alert-&gt;Flags() | B_CLOSE_ON_ESCAPE);</a>
<a name="ln502">		alert-&gt;Go();</a>
<a name="ln503">		okToMove = false;</a>
<a name="ln504">	}</a>
<a name="ln505"> </a>
<a name="ln506">	if (!okToMove) {</a>
<a name="ln507">		// there was some problem with our target, so we bail out here</a>
<a name="ln508">		delete moveList;</a>
<a name="ln509">		delete copyList;</a>
<a name="ln510">		return false;</a>
<a name="ln511">	}</a>
<a name="ln512"> </a>
<a name="ln513">	// asynchronous calls take over ownership of the objects passed to it</a>
<a name="ln514">	if (moveList-&gt;CountItems() &gt; 0) {</a>
<a name="ln515">		FSMoveToFolder(moveList, new BEntry(entry),</a>
<a name="ln516">			linksMode ? linksMode : kMoveSelectionTo);</a>
<a name="ln517">	} else</a>
<a name="ln518">		delete moveList;</a>
<a name="ln519"> </a>
<a name="ln520">	if (copyList-&gt;CountItems() &gt; 0)</a>
<a name="ln521">		FSMoveToFolder(copyList, new BEntry(entry), kCopySelectionTo);</a>
<a name="ln522">	else</a>
<a name="ln523">		delete copyList;</a>
<a name="ln524"> </a>
<a name="ln525">	return true;</a>
<a name="ln526">}</a>
<a name="ln527"> </a>
<a name="ln528"> </a>
<a name="ln529">// Seek node in clipboard, if found return it's moveMode</a>
<a name="ln530">// else return 0</a>
<a name="ln531">uint32</a>
<a name="ln532">FSClipboardFindNodeMode(Model* model, bool autoLock, bool updateRefIfNeeded)</a>
<a name="ln533">{</a>
<a name="ln534">	int32 moveMode = 0;</a>
<a name="ln535">	if (autoLock) {</a>
<a name="ln536">		if (!be_clipboard-&gt;Lock())</a>
<a name="ln537">			return 0;</a>
<a name="ln538">	}</a>
<a name="ln539">	bool remove = false;</a>
<a name="ln540">	bool change = false;</a>
<a name="ln541"> </a>
<a name="ln542">	BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln543">	if (clip != NULL) {</a>
<a name="ln544">		const node_ref* node = model-&gt;NodeRef();</a>
<a name="ln545">		char modeName[64];</a>
<a name="ln546">		MakeModeName(modeName, node);</a>
<a name="ln547">		if ((clip-&gt;FindInt32(modeName, &amp;moveMode) == B_OK)) {</a>
<a name="ln548">			const entry_ref* ref = model-&gt;EntryRef();</a>
<a name="ln549">			entry_ref clipref;</a>
<a name="ln550">			char refName[64];</a>
<a name="ln551">			MakeRefName(refName, node);</a>
<a name="ln552">			if ((clip-&gt;FindRef(refName, &amp;clipref) == B_OK)) {</a>
<a name="ln553">				if (clipref != *ref) {</a>
<a name="ln554">					if (updateRefIfNeeded) {</a>
<a name="ln555">						clip-&gt;ReplaceRef(refName, ref);</a>
<a name="ln556">						change = true;</a>
<a name="ln557">					} else {</a>
<a name="ln558">						clip-&gt;RemoveName(refName);</a>
<a name="ln559">						clip-&gt;RemoveName(modeName);</a>
<a name="ln560">						change = true;</a>
<a name="ln561">						remove = true;</a>
<a name="ln562">						moveMode = 0;</a>
<a name="ln563">					}</a>
<a name="ln564">				}</a>
<a name="ln565">			} else {</a>
<a name="ln566">				clip-&gt;RemoveName(modeName);</a>
<a name="ln567">				change = true;</a>
<a name="ln568">				remove = true;</a>
<a name="ln569">				moveMode = 0;</a>
<a name="ln570">			}</a>
<a name="ln571">		}</a>
<a name="ln572">	}</a>
<a name="ln573">	if (change)</a>
<a name="ln574">		be_clipboard-&gt;Commit();</a>
<a name="ln575"> </a>
<a name="ln576">	if (autoLock)</a>
<a name="ln577">		be_clipboard-&gt;Unlock();</a>
<a name="ln578"> </a>
<a name="ln579">	if (remove)</a>
<a name="ln580">		FSClipboardRemove(model);</a>
<a name="ln581"> </a>
<a name="ln582">	return (uint32)moveMode;</a>
<a name="ln583">}</a>
<a name="ln584"> </a>
<a name="ln585"> </a>
<a name="ln586">void</a>
<a name="ln587">FSClipboardRemove(Model* model)</a>
<a name="ln588">{</a>
<a name="ln589">	BMessenger messenger(kTrackerSignature);</a>
<a name="ln590">	if (messenger.IsValid()) {</a>
<a name="ln591">		BMessage* report = new BMessage(kFSClipboardChanges);</a>
<a name="ln592">		TClipboardNodeRef tcnode;</a>
<a name="ln593">		tcnode.node = *model-&gt;NodeRef();</a>
<a name="ln594">		tcnode.moveMode = kDelete;</a>
<a name="ln595">		const entry_ref* ref = model-&gt;EntryRef();</a>
<a name="ln596">		report-&gt;AddInt32(&quot;device&quot;, ref-&gt;device);</a>
<a name="ln597">		report-&gt;AddInt64(&quot;directory&quot;, ref-&gt;directory);</a>
<a name="ln598">		report-&gt;AddBool(&quot;clearClipboard&quot;, false);</a>
<a name="ln599">		report-&gt;AddData(&quot;tcnode&quot;, T_CLIPBOARD_NODE, &amp;tcnode, sizeof(tcnode),</a>
<a name="ln600">			true);</a>
<a name="ln601">		messenger.SendMessage(report);</a>
<a name="ln602">		delete report;</a>
<a name="ln603">	}</a>
<a name="ln604">}</a>
<a name="ln605"> </a>
<a name="ln606"> </a>
<a name="ln607">//	#pragma mark -</a>
<a name="ln608"> </a>
<a name="ln609"> </a>
<a name="ln610">BClipboardRefsWatcher::BClipboardRefsWatcher()</a>
<a name="ln611">	:	BLooper(&quot;ClipboardRefsWatcher&quot;, B_LOW_PRIORITY, 4096),</a>
<a name="ln612">	fNotifyList(10, false)</a>
<a name="ln613">{</a>
<a name="ln614">	watch_node(NULL, B_WATCH_MOUNT, this);</a>
<a name="ln615">	fRefsInClipboard = FSClipboardHasRefs();</a>
<a name="ln616">	be_clipboard-&gt;StartWatching(this);</a>
<a name="ln617">}</a>
<a name="ln618"> </a>
<a name="ln619"> </a>
<a name="ln620">BClipboardRefsWatcher::~BClipboardRefsWatcher()</a>
<a name="ln621">{</a>
<a name="ln622">	stop_watching(this);</a>
<a name="ln623">	be_clipboard-&gt;StopWatching(this);</a>
<a name="ln624">}</a>
<a name="ln625"> </a>
<a name="ln626"> </a>
<a name="ln627">void</a>
<a name="ln628">BClipboardRefsWatcher::AddToNotifyList(BMessenger target)</a>
<a name="ln629">{</a>
<a name="ln630">	if (Lock()) {</a>
<a name="ln631">		// add the messenger if it's not already in the list</a>
<a name="ln632">		// ToDo: why do we have to care about that?</a>
<a name="ln633">		BMessenger* messenger;</a>
<a name="ln634">		bool found = false;</a>
<a name="ln635"> </a>
<a name="ln636">		for (int32 index = 0; (messenger = fNotifyList.ItemAt(index)) != NULL;</a>
<a name="ln637">				index++) {</a>
<a name="ln638">			if (*messenger == target) {</a>
<a name="ln639">				found = true;</a>
<a name="ln640">				break;</a>
<a name="ln641">			}</a>
<a name="ln642">		}</a>
<a name="ln643">		if (!found)</a>
<a name="ln644">			fNotifyList.AddItem(new BMessenger(target));</a>
<a name="ln645"> </a>
<a name="ln646">		Unlock();</a>
<a name="ln647">	}</a>
<a name="ln648">}</a>
<a name="ln649"> </a>
<a name="ln650"> </a>
<a name="ln651">void</a>
<a name="ln652">BClipboardRefsWatcher::RemoveFromNotifyList(BMessenger target)</a>
<a name="ln653">{</a>
<a name="ln654">	if (Lock()) {</a>
<a name="ln655">		BMessenger* messenger;</a>
<a name="ln656"> </a>
<a name="ln657">		for (int32 index = 0; (messenger = fNotifyList.ItemAt(index)) != NULL;</a>
<a name="ln658">				index++) {</a>
<a name="ln659">			if (*messenger == target) {</a>
<a name="ln660">				delete fNotifyList.RemoveItemAt(index);</a>
<a name="ln661">				break;</a>
<a name="ln662">			}</a>
<a name="ln663">		}</a>
<a name="ln664">		Unlock();</a>
<a name="ln665">	}</a>
<a name="ln666">}</a>
<a name="ln667"> </a>
<a name="ln668"> </a>
<a name="ln669">void</a>
<a name="ln670">BClipboardRefsWatcher::AddNode(const node_ref* node)</a>
<a name="ln671">{</a>
<a name="ln672">	TTracker::WatchNode(node, B_WATCH_NAME, this);</a>
<a name="ln673">	fRefsInClipboard = true;</a>
<a name="ln674">}</a>
<a name="ln675"> </a>
<a name="ln676"> </a>
<a name="ln677">void</a>
<a name="ln678">BClipboardRefsWatcher::RemoveNode(node_ref* node, bool removeFromClipboard)</a>
<a name="ln679">{</a>
<a name="ln680">	watch_node(node, B_STOP_WATCHING, this);</a>
<a name="ln681"> </a>
<a name="ln682">	if (!removeFromClipboard)</a>
<a name="ln683">		return;</a>
<a name="ln684"> </a>
<a name="ln685">	if (be_clipboard-&gt;Lock()) {</a>
<a name="ln686">		BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln687">		if (clip != NULL) {</a>
<a name="ln688">			char name[64];</a>
<a name="ln689">			MakeRefName(name, node);</a>
<a name="ln690">			clip-&gt;RemoveName(name);</a>
<a name="ln691">			MakeModeName(name);</a>
<a name="ln692">			clip-&gt;RemoveName(name);</a>
<a name="ln693"> </a>
<a name="ln694">			be_clipboard-&gt;Commit();</a>
<a name="ln695">		}</a>
<a name="ln696">		be_clipboard-&gt;Unlock();</a>
<a name="ln697">	}</a>
<a name="ln698">}</a>
<a name="ln699"> </a>
<a name="ln700"> </a>
<a name="ln701">void</a>
<a name="ln702">BClipboardRefsWatcher::RemoveNodesByDevice(dev_t device)</a>
<a name="ln703">{</a>
<a name="ln704">	if (!be_clipboard-&gt;Lock())</a>
<a name="ln705">		return;</a>
<a name="ln706"> </a>
<a name="ln707">	BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln708">	if (clip != NULL) {</a>
<a name="ln709">		char deviceName[6];</a>
<a name="ln710">		sprintf(deviceName, &quot;r%&quot; B_PRIdDEV &quot;_&quot;, device);</a>
<a name="ln711"> </a>
<a name="ln712">		int32 index = 0;</a>
<a name="ln713">		char* refName;</a>
<a name="ln714">		type_code type;</a>
<a name="ln715">		int32 count;</a>
<a name="ln716">		while (clip-&gt;GetInfo(B_REF_TYPE, index,</a>
<a name="ln717">#ifdef B_BEOS_VERSION_DANO</a>
<a name="ln718">			(const char**)</a>
<a name="ln719">#endif</a>
<a name="ln720">			&amp;refName, &amp;type, &amp;count) == B_OK) {</a>
<a name="ln721">			if (!strncmp(deviceName, refName, strlen(deviceName))) {</a>
<a name="ln722">				clip-&gt;RemoveName(refName);</a>
<a name="ln723">				MakeModeName(refName);</a>
<a name="ln724">				clip-&gt;RemoveName(refName);</a>
<a name="ln725"> </a>
<a name="ln726">				node_ref node;</a>
<a name="ln727">				MakeNodeFromName(&amp;node, refName);</a>
<a name="ln728">				watch_node(&amp;node, B_STOP_WATCHING, this);</a>
<a name="ln729">			}</a>
<a name="ln730">			index++;</a>
<a name="ln731">		}</a>
<a name="ln732">		be_clipboard-&gt;Commit();</a>
<a name="ln733">	}</a>
<a name="ln734">	be_clipboard-&gt;Unlock();</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737"> </a>
<a name="ln738">void</a>
<a name="ln739">BClipboardRefsWatcher::UpdateNode(node_ref* node, entry_ref* ref)</a>
<a name="ln740">{</a>
<a name="ln741">	if (!be_clipboard-&gt;Lock())</a>
<a name="ln742">		return;</a>
<a name="ln743"> </a>
<a name="ln744">	BMessage* clip = be_clipboard-&gt;Data();</a>
<a name="ln745">	if (clip != NULL) {</a>
<a name="ln746">		char name[64];</a>
<a name="ln747">		MakeRefName(name, node);</a>
<a name="ln748">		if ((clip-&gt;ReplaceRef(name, ref)) != B_OK) {</a>
<a name="ln749">			clip-&gt;RemoveName(name);</a>
<a name="ln750">			MakeModeName(name);</a>
<a name="ln751">			clip-&gt;RemoveName(name);</a>
<a name="ln752"> </a>
<a name="ln753">			RemoveNode(node);</a>
<a name="ln754">		}</a>
<a name="ln755">		be_clipboard-&gt;Commit();</a>
<a name="ln756">	}</a>
<a name="ln757">	be_clipboard-&gt;Unlock();</a>
<a name="ln758">}</a>
<a name="ln759"> </a>
<a name="ln760"> </a>
<a name="ln761">void</a>
<a name="ln762">BClipboardRefsWatcher::Clear()</a>
<a name="ln763">{</a>
<a name="ln764">	stop_watching(this);</a>
<a name="ln765">	watch_node(NULL, B_WATCH_MOUNT, this);</a>
<a name="ln766"> </a>
<a name="ln767">	BMessage message(kFSClipboardChanges);</a>
<a name="ln768">	message.AddBool(&quot;clearClipboard&quot;, true);</a>
<a name="ln769">	if (Lock()) {</a>
<a name="ln770">		int32 items = fNotifyList.CountItems();</a>
<a name="ln771">		for (int32 i = 0;i &lt; items;i++) {</a>
<a name="ln772">			fNotifyList.ItemAt(i)-&gt;SendMessage(&amp;message);</a>
<a name="ln773">		}</a>
<a name="ln774">		Unlock();</a>
<a name="ln775">	}</a>
<a name="ln776">}</a>
<a name="ln777"> </a>
<a name="ln778"> </a>
<a name="ln779">//void</a>
<a name="ln780">//BClipboardRefsWatcher::UpdatePoseViews(bool clearClipboard,</a>
<a name="ln781">//	const node_ref* node)</a>
<a name="ln782">//{</a>
<a name="ln783">//	BMessage message(kFSClipboardChanges);</a>
<a name="ln784">//	message.AddInt32(&quot;device&quot;, node-&gt;device);</a>
<a name="ln785">//	message.AddInt64(&quot;directory&quot;, node-&gt;node);</a>
<a name="ln786">//	message.AddBool(&quot;clearClipboard&quot;, clearClipboard);</a>
<a name="ln787">//</a>
<a name="ln788">//	if (Lock()) {</a>
<a name="ln789">//		int32 items = fNotifyList.CountItems();</a>
<a name="ln790">//		for (int32 i = 0;i &lt; items;i++) {</a>
<a name="ln791">//			fNotifyList.ItemAt(i)-&gt;SendMessage(&amp;message);</a>
<a name="ln792">//		}</a>
<a name="ln793">//		Unlock();</a>
<a name="ln794">//	}</a>
<a name="ln795">//}</a>
<a name="ln796"> </a>
<a name="ln797"> </a>
<a name="ln798">void</a>
<a name="ln799">BClipboardRefsWatcher::UpdatePoseViews(BMessage* reportMessage)</a>
<a name="ln800">{</a>
<a name="ln801">	if (Lock()) {</a>
<a name="ln802">		// check if it was cleared, if so clear watching</a>
<a name="ln803">		bool clearClipboard = false;</a>
<a name="ln804">		if (reportMessage-&gt;FindBool(&quot;clearClipboard&quot;, &amp;clearClipboard) == B_OK</a>
<a name="ln805">			&amp;&amp; clearClipboard) {</a>
<a name="ln806">			stop_watching(this);</a>
<a name="ln807">			watch_node(NULL, B_WATCH_MOUNT, this);</a>
<a name="ln808">		}</a>
<a name="ln809"> </a>
<a name="ln810">		// loop through reported node_ref's movemodes:</a>
<a name="ln811">		// move or copy: start watching node_ref</a>
<a name="ln812">		// remove: stop watching node_ref</a>
<a name="ln813">		int32 index = 0;</a>
<a name="ln814">		TClipboardNodeRef* tcnode = NULL;</a>
<a name="ln815">		ssize_t size;</a>
<a name="ln816">		while (reportMessage-&gt;FindData(&quot;tcnode&quot;, T_CLIPBOARD_NODE, index,</a>
<a name="ln817">				(const void**)&amp;tcnode, &amp;size) == B_OK) {</a>
<a name="ln818">			if (tcnode-&gt;moveMode == kDelete) {</a>
<a name="ln819">				watch_node(&amp;tcnode-&gt;node, B_STOP_WATCHING, this);</a>
<a name="ln820">			} else {</a>
<a name="ln821">				watch_node(&amp;tcnode-&gt;node, B_STOP_WATCHING, this);</a>
<a name="ln822">				TTracker::WatchNode(&amp;tcnode-&gt;node, B_WATCH_NAME, this);</a>
<a name="ln823">				fRefsInClipboard = true;</a>
<a name="ln824">			}</a>
<a name="ln825">			index++;</a>
<a name="ln826">		}</a>
<a name="ln827"> </a>
<a name="ln828">		// send report</a>
<a name="ln829">		int32 items = fNotifyList.CountItems();</a>
<a name="ln830">		for (int32 i = 0;i &lt; items;i++) {</a>
<a name="ln831">			fNotifyList.ItemAt(i)-&gt;SendMessage(reportMessage);</a>
<a name="ln832">		}</a>
<a name="ln833">		Unlock();</a>
<a name="ln834">	}</a>
<a name="ln835">}</a>
<a name="ln836"> </a>
<a name="ln837"> </a>
<a name="ln838">void</a>
<a name="ln839">BClipboardRefsWatcher::MessageReceived(BMessage* message)</a>
<a name="ln840">{</a>
<a name="ln841">	if (message-&gt;what == B_CLIPBOARD_CHANGED &amp;&amp; fRefsInClipboard) {</a>
<a name="ln842">		if (!(fRefsInClipboard = FSClipboardHasRefs()))</a>
<a name="ln843">			Clear();</a>
<a name="ln844">		return;</a>
<a name="ln845">	} else if (message-&gt;what != B_NODE_MONITOR) {</a>
<a name="ln846">		_inherited::MessageReceived(message);</a>
<a name="ln847">		return;</a>
<a name="ln848">	}</a>
<a name="ln849"> </a>
<a name="ln850">	switch (message-&gt;FindInt32(&quot;opcode&quot;)) {</a>
<a name="ln851">		case B_ENTRY_MOVED:</a>
<a name="ln852">		{</a>
<a name="ln853">			ino_t toDir;</a>
<a name="ln854">			ino_t fromDir;</a>
<a name="ln855">			node_ref node;</a>
<a name="ln856">			const char* name = NULL;</a>
<a name="ln857">			message-&gt;FindInt64(&quot;from directory&quot;, &amp;fromDir);</a>
<a name="ln858">			message-&gt;FindInt64(&quot;to directory&quot;, &amp;toDir);</a>
<a name="ln859">			message-&gt;FindInt64(&quot;node&quot;, &amp;node.node);</a>
<a name="ln860">			message-&gt;FindInt32(&quot;device&quot;, &amp;node.device);</a>
<a name="ln861">			message-&gt;FindString(&quot;name&quot;, &amp;name);</a>
<a name="ln862">			entry_ref ref(node.device, toDir, name);</a>
<a name="ln863">			UpdateNode(&amp;node, &amp;ref);</a>
<a name="ln864">			break;</a>
<a name="ln865">		}</a>
<a name="ln866"> </a>
<a name="ln867">		case B_DEVICE_UNMOUNTED:</a>
<a name="ln868">		{</a>
<a name="ln869">			dev_t device;</a>
<a name="ln870">			message-&gt;FindInt32(&quot;device&quot;, &amp;device);</a>
<a name="ln871">			RemoveNodesByDevice(device);</a>
<a name="ln872">			break;</a>
<a name="ln873">		}</a>
<a name="ln874"> </a>
<a name="ln875">		case B_ENTRY_REMOVED:</a>
<a name="ln876">		{</a>
<a name="ln877">			node_ref node;</a>
<a name="ln878">			message-&gt;FindInt64(&quot;node&quot;, &amp;node.node);</a>
<a name="ln879">			message-&gt;FindInt32(&quot;device&quot;, &amp;node.device);</a>
<a name="ln880">			RemoveNode(&amp;node, true);</a>
<a name="ln881">			break;</a>
<a name="ln882">		}</a>
<a name="ln883">	}</a>
<a name="ln884">}</a>

</code></pre>
<div class="balloon" rel="490"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="504"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'alert' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
