
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ScreenSaverWindow.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2003-2016 Haiku, Inc. All rights reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Axel Dörfler, axeld@pinc-software.de</a>
<a name="ln7"> *		Jérôme Duval, jerome.duval@free.fr</a>
<a name="ln8"> *		Filip Maryjański, widelec@morphos.pl</a>
<a name="ln9"> *		Puck Meerburg, puck@puckipedia.nl</a>
<a name="ln10"> *		Michael Phipps</a>
<a name="ln11"> *		John Scipione, jscipione@gmail.com</a>
<a name="ln12"> */</a>
<a name="ln13"> </a>
<a name="ln14"> </a>
<a name="ln15">#include &quot;ScreenSaverWindow.h&quot;</a>
<a name="ln16"> </a>
<a name="ln17">#include &lt;stdio.h&gt;</a>
<a name="ln18">#include &lt;strings.h&gt;</a>
<a name="ln19"> </a>
<a name="ln20">#include &lt;Alignment.h&gt;</a>
<a name="ln21">#include &lt;Application.h&gt;</a>
<a name="ln22">#include &lt;Box.h&gt;</a>
<a name="ln23">#include &lt;Button.h&gt;</a>
<a name="ln24">#include &lt;Catalog.h&gt;</a>
<a name="ln25">#include &lt;CheckBox.h&gt;</a>
<a name="ln26">#include &lt;ControlLook.h&gt;</a>
<a name="ln27">#include &lt;DefaultSettingsView.h&gt;</a>
<a name="ln28">#include &lt;Directory.h&gt;</a>
<a name="ln29">#include &lt;DurationFormat.h&gt;</a>
<a name="ln30">#include &lt;Entry.h&gt;</a>
<a name="ln31">#include &lt;File.h&gt;</a>
<a name="ln32">#include &lt;FindDirectory.h&gt;</a>
<a name="ln33">#include &lt;Font.h&gt;</a>
<a name="ln34">#include &lt;GroupLayout.h&gt;</a>
<a name="ln35">#include &lt;LayoutBuilder.h&gt;</a>
<a name="ln36">#include &lt;ListItem.h&gt;</a>
<a name="ln37">#include &lt;ListView.h&gt;</a>
<a name="ln38">#include &lt;NodeMonitor.h&gt;</a>
<a name="ln39">#include &lt;Path.h&gt;</a>
<a name="ln40">#include &lt;Rect.h&gt;</a>
<a name="ln41">#include &lt;Roster.h&gt;</a>
<a name="ln42">#include &lt;Screen.h&gt;</a>
<a name="ln43">#include &lt;ScreenSaver.h&gt;</a>
<a name="ln44">#include &lt;ScreenSaverRunner.h&gt;</a>
<a name="ln45">#include &lt;ScrollView.h&gt;</a>
<a name="ln46">#include &lt;Size.h&gt;</a>
<a name="ln47">#include &lt;Slider.h&gt;</a>
<a name="ln48">#include &lt;StringView.h&gt;</a>
<a name="ln49">#include &lt;TabView.h&gt;</a>
<a name="ln50">#include &lt;TextView.h&gt;</a>
<a name="ln51"> </a>
<a name="ln52">#include &lt;algorithm&gt;</a>
<a name="ln53">	// for std::max and std::min</a>
<a name="ln54"> </a>
<a name="ln55">#include &quot;PreviewView.h&quot;</a>
<a name="ln56">#include &quot;ScreenCornerSelector.h&quot;</a>
<a name="ln57">#include &quot;ScreenSaverItem.h&quot;</a>
<a name="ln58">#include &quot;ScreenSaverShared.h&quot;</a>
<a name="ln59"> </a>
<a name="ln60">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln61">#define B_TRANSLATION_CONTEXT &quot;ScreenSaver&quot;</a>
<a name="ln62"> </a>
<a name="ln63"> </a>
<a name="ln64">const uint32 kPreviewMonitorGap = 16;</a>
<a name="ln65">const uint32 kMinSettingsWidth = 230;</a>
<a name="ln66">const uint32 kMinSettingsHeight = 120;</a>
<a name="ln67"> </a>
<a name="ln68">const int32 kMsgSaverSelected = 'SSEL';</a>
<a name="ln69">const int32 kMsgPasswordCheckBox = 'PWCB';</a>
<a name="ln70">const int32 kMsgRunSliderChanged = 'RSch';</a>
<a name="ln71">const int32 kMsgRunSliderUpdate = 'RSup';</a>
<a name="ln72">const int32 kMsgPasswordSliderChanged = 'PWch';</a>
<a name="ln73">const int32 kMsgPasswordSliderUpdate = 'PWup';</a>
<a name="ln74">const int32 kMsgChangePassword = 'PWBT';</a>
<a name="ln75">const int32 kMsgEnableScreenSaverBox = 'ESCH';</a>
<a name="ln76"> </a>
<a name="ln77">const int32 kMsgTurnOffCheckBox = 'TUOF';</a>
<a name="ln78">const int32 kMsgTurnOffSliderChanged = 'TUch';</a>
<a name="ln79">const int32 kMsgTurnOffSliderUpdate = 'TUup';</a>
<a name="ln80"> </a>
<a name="ln81">const int32 kMsgFadeCornerChanged = 'fdcc';</a>
<a name="ln82">const int32 kMsgNeverFadeCornerChanged = 'nfcc';</a>
<a name="ln83"> </a>
<a name="ln84">const float kWindowWidth = 446.0f;</a>
<a name="ln85">const float kWindowHeight = 325.0f;</a>
<a name="ln86">const float kDefaultItemSpacingAt12pt = 12.0f * 0.85;</a>
<a name="ln87"> </a>
<a name="ln88"> </a>
<a name="ln89">class TimeSlider : public BSlider {</a>
<a name="ln90">public:</a>
<a name="ln91">								TimeSlider(const char* name,</a>
<a name="ln92">									uint32 changedMessage,</a>
<a name="ln93">									uint32 updateMessage);</a>
<a name="ln94">	virtual						~TimeSlider();</a>
<a name="ln95"> </a>
<a name="ln96">	virtual	void				SetValue(int32 value);</a>
<a name="ln97"> </a>
<a name="ln98">			void				SetTime(bigtime_t useconds);</a>
<a name="ln99">			bigtime_t			Time() const;</a>
<a name="ln100"> </a>
<a name="ln101">private:</a>
<a name="ln102">			void				_TimeToString(bigtime_t useconds,</a>
<a name="ln103">									BString&amp; string);</a>
<a name="ln104">};</a>
<a name="ln105"> </a>
<a name="ln106"> </a>
<a name="ln107">class TabView : public BTabView {</a>
<a name="ln108">public:</a>
<a name="ln109">								TabView();</a>
<a name="ln110"> </a>
<a name="ln111">	virtual	void				MouseDown(BPoint where);</a>
<a name="ln112">};</a>
<a name="ln113"> </a>
<a name="ln114"> </a>
<a name="ln115">class FadeView : public BView {</a>
<a name="ln116">public:</a>
<a name="ln117">								FadeView(const char* name,</a>
<a name="ln118">									ScreenSaverSettings&amp; settings);</a>
<a name="ln119"> </a>
<a name="ln120">	virtual	void				AttachedToWindow();</a>
<a name="ln121">	virtual	void				MessageReceived(BMessage* message);</a>
<a name="ln122"> </a>
<a name="ln123">			void				UpdateTurnOffScreen();</a>
<a name="ln124">			void				UpdateStatus();</a>
<a name="ln125"> </a>
<a name="ln126">private:</a>
<a name="ln127">			void				_UpdateColors();</a>
<a name="ln128">			ScreenSaverSettings&amp;	fSettings;</a>
<a name="ln129">			uint32				fTurnOffScreenFlags;</a>
<a name="ln130"> </a>
<a name="ln131">			BCheckBox*			fEnableCheckBox;</a>
<a name="ln132">			TimeSlider*			fRunSlider;</a>
<a name="ln133"> </a>
<a name="ln134">			BTextView*			fTurnOffNotSupported;</a>
<a name="ln135">			BCheckBox*			fTurnOffCheckBox;</a>
<a name="ln136">			TimeSlider*			fTurnOffSlider;</a>
<a name="ln137"> </a>
<a name="ln138">			BTextView*			fFadeNeverText;</a>
<a name="ln139">			BTextView*			fFadeNowText;</a>
<a name="ln140"> </a>
<a name="ln141">			BCheckBox*			fPasswordCheckBox;</a>
<a name="ln142">			TimeSlider*			fPasswordSlider;</a>
<a name="ln143">			BButton*			fPasswordButton;</a>
<a name="ln144"> </a>
<a name="ln145">			ScreenCornerSelector*	fFadeNow;</a>
<a name="ln146">			ScreenCornerSelector*	fFadeNever;</a>
<a name="ln147">};</a>
<a name="ln148"> </a>
<a name="ln149"> </a>
<a name="ln150">class ModulesView : public BView {</a>
<a name="ln151">public:</a>
<a name="ln152">								ModulesView(const char* name,</a>
<a name="ln153">									ScreenSaverSettings&amp; settings);</a>
<a name="ln154">	virtual						~ModulesView();</a>
<a name="ln155"> </a>
<a name="ln156">	virtual	void				DetachedFromWindow();</a>
<a name="ln157">	virtual	void				AttachedToWindow();</a>
<a name="ln158">	virtual	void				AllAttached();</a>
<a name="ln159">	virtual	void				MessageReceived(BMessage* message);</a>
<a name="ln160"> </a>
<a name="ln161">			void				EmptyScreenSaverList();</a>
<a name="ln162">			void				PopulateScreenSaverList();</a>
<a name="ln163"> </a>
<a name="ln164">			void				SaveState();</a>
<a name="ln165"> </a>
<a name="ln166">			BScreenSaver*		ScreenSaver();</a>
<a name="ln167"> </a>
<a name="ln168">private:</a>
<a name="ln169">	friend class TabView;</a>
<a name="ln170"> </a>
<a name="ln171">	static	int					_CompareScreenSaverItems(const void* left,</a>
<a name="ln172">									const void* right);</a>
<a name="ln173"> </a>
<a name="ln174">			void				_CloseSaver();</a>
<a name="ln175">			void				_OpenSaver();</a>
<a name="ln176">			void				_AddNewScreenSaverToList(const char* name,</a>
<a name="ln177">								BPath* path);</a>
<a name="ln178">			void				_RemoveScreenSaverFromList(const char* name);</a>
<a name="ln179"> </a>
<a name="ln180">private:</a>
<a name="ln181">		ScreenSaverSettings&amp;	fSettings;</a>
<a name="ln182"> </a>
<a name="ln183">			BListView*			fScreenSaversListView;</a>
<a name="ln184">			BButton*			fTestButton;</a>
<a name="ln185"> </a>
<a name="ln186">			ScreenSaverRunner*	fSaverRunner;</a>
<a name="ln187">			BString				fCurrentName;</a>
<a name="ln188"> </a>
<a name="ln189">			BBox*				fSettingsBox;</a>
<a name="ln190">			BView*				fSettingsView;</a>
<a name="ln191"> </a>
<a name="ln192">			PreviewView*		fPreviewView;</a>
<a name="ln193"> </a>
<a name="ln194">			team_id				fScreenSaverTestTeam;</a>
<a name="ln195">};</a>
<a name="ln196"> </a>
<a name="ln197"> </a>
<a name="ln198">//	#pragma mark - TimeSlider</a>
<a name="ln199"> </a>
<a name="ln200"> </a>
<a name="ln201">static const int32 kTimeInUnits[] = {</a>
<a name="ln202">	30,    60,   90,</a>
<a name="ln203">	120,   150,  180,</a>
<a name="ln204">	240,   300,  360,</a>
<a name="ln205">	420,   480,  540,</a>
<a name="ln206">	600,   900,  1200,</a>
<a name="ln207">	1500,  1800, 2400,</a>
<a name="ln208">	3000,  3600, 5400,</a>
<a name="ln209">	7200,  9000, 10800,</a>
<a name="ln210">	14400, 18000</a>
<a name="ln211">};</a>
<a name="ln212"> </a>
<a name="ln213">static const int32 kTimeUnitCount</a>
<a name="ln214">	= sizeof(kTimeInUnits) / sizeof(kTimeInUnits[0]);</a>
<a name="ln215"> </a>
<a name="ln216"> </a>
<a name="ln217">TimeSlider::TimeSlider(const char* name, uint32 changedMessage,</a>
<a name="ln218">	uint32 updateMessage)</a>
<a name="ln219">	:</a>
<a name="ln220">	BSlider(name, B_TRANSLATE(&quot;30 seconds&quot;), new BMessage(changedMessage),</a>
<a name="ln221">		0, kTimeUnitCount - 1, B_HORIZONTAL, B_TRIANGLE_THUMB)</a>
<a name="ln222">{</a>
<a name="ln223">	SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln224">	SetModificationMessage(new BMessage(updateMessage));</a>
<a name="ln225">	SetBarThickness(10);</a>
<a name="ln226">}</a>
<a name="ln227"> </a>
<a name="ln228"> </a>
<a name="ln229">TimeSlider::~TimeSlider()</a>
<a name="ln230">{</a>
<a name="ln231">}</a>
<a name="ln232"> </a>
<a name="ln233"> </a>
<a name="ln234">void</a>
<a name="ln235">TimeSlider::SetValue(int32 value)</a>
<a name="ln236">{</a>
<a name="ln237">	int32 oldValue = Value();</a>
<a name="ln238">	BSlider::SetValue(value);</a>
<a name="ln239"> </a>
<a name="ln240">	if (oldValue != Value()) {</a>
<a name="ln241">		BString label;</a>
<a name="ln242">		_TimeToString(kTimeInUnits[Value()] * 1000000LL, label);</a>
<a name="ln243">		SetLabel(label.String());</a>
<a name="ln244">	}</a>
<a name="ln245">}</a>
<a name="ln246"> </a>
<a name="ln247"> </a>
<a name="ln248">void</a>
<a name="ln249">TimeSlider::SetTime(bigtime_t useconds)</a>
<a name="ln250">{</a>
<a name="ln251">	for (int t = 0; t &lt; kTimeUnitCount; t++) {</a>
<a name="ln252">		if (kTimeInUnits[t] * 1000000LL == useconds) {</a>
<a name="ln253">			SetValue(t);</a>
<a name="ln254">			break;</a>
<a name="ln255">		}</a>
<a name="ln256">	}</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259"> </a>
<a name="ln260">bigtime_t</a>
<a name="ln261">TimeSlider::Time() const</a>
<a name="ln262">{</a>
<a name="ln263">	return 1000000LL * kTimeInUnits[Value()];</a>
<a name="ln264">}</a>
<a name="ln265"> </a>
<a name="ln266"> </a>
<a name="ln267">void</a>
<a name="ln268">TimeSlider::_TimeToString(bigtime_t useconds, BString&amp; string)</a>
<a name="ln269">{</a>
<a name="ln270">	BDurationFormat formatter;</a>
<a name="ln271">	formatter.Format(string, 0, useconds);</a>
<a name="ln272">}</a>
<a name="ln273"> </a>
<a name="ln274"> </a>
<a name="ln275">//	#pragma mark - FadeView</a>
<a name="ln276"> </a>
<a name="ln277"> </a>
<a name="ln278">FadeView::FadeView(const char* name, ScreenSaverSettings&amp; settings)</a>
<a name="ln279">	:</a>
<a name="ln280">	BView(name, B_WILL_DRAW),</a>
<a name="ln281">	fSettings(settings)</a>
<a name="ln282">{</a>
<a name="ln283">	SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln284"> </a>
<a name="ln285">	font_height fontHeight;</a>
<a name="ln286">	be_plain_font-&gt;GetHeight(&amp;fontHeight);</a>
<a name="ln287">	float textHeight = ceilf(fontHeight.ascent + fontHeight.descent);</a>
<a name="ln288"> </a>
<a name="ln289">	fEnableCheckBox = new BCheckBox(&quot;EnableCheckBox&quot;,</a>
<a name="ln290">		B_TRANSLATE(&quot;Enable screensaver&quot;),</a>
<a name="ln291">		new BMessage(kMsgEnableScreenSaverBox));</a>
<a name="ln292"> </a>
<a name="ln293">	BBox* box = new BBox(&quot;EnableScreenSaverBox&quot;);</a>
<a name="ln294">	box-&gt;SetLabel(fEnableCheckBox);</a>
<a name="ln295"> </a>
<a name="ln296">	// Start Screensaver</a>
<a name="ln297">	BStringView* startScreenSaver = new BStringView(&quot;startScreenSaver&quot;,</a>
<a name="ln298">		B_TRANSLATE(&quot;Start screensaver&quot;));</a>
<a name="ln299">	startScreenSaver-&gt;SetAlignment(B_ALIGN_RIGHT);</a>
<a name="ln300"> </a>
<a name="ln301">	fRunSlider = new TimeSlider(&quot;RunSlider&quot;, kMsgRunSliderChanged,</a>
<a name="ln302">		kMsgRunSliderUpdate);</a>
<a name="ln303"> </a>
<a name="ln304">	// Turn Off</a>
<a name="ln305">	rgb_color textColor = disable_color(ui_color(B_PANEL_TEXT_COLOR),</a>
<a name="ln306">		ViewColor());</a>
<a name="ln307"> </a>
<a name="ln308">	fTurnOffNotSupported = new BTextView(&quot;not_supported&quot;, be_plain_font,</a>
<a name="ln309">		&amp;textColor, B_WILL_DRAW);</a>
<a name="ln310">	fTurnOffNotSupported-&gt;SetExplicitMinSize(BSize(B_SIZE_UNSET,</a>
<a name="ln311">		3 + textHeight * 3));</a>
<a name="ln312">	fTurnOffNotSupported-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln313">	fTurnOffNotSupported-&gt;MakeEditable(false);</a>
<a name="ln314">	fTurnOffNotSupported-&gt;MakeSelectable(false);</a>
<a name="ln315">	fTurnOffNotSupported-&gt;SetText(</a>
<a name="ln316">		B_TRANSLATE(&quot;Display Power Management Signaling not available&quot;));</a>
<a name="ln317"> </a>
<a name="ln318">	fTurnOffCheckBox = new BCheckBox(&quot;TurnOffScreenCheckBox&quot;,</a>
<a name="ln319">		B_TRANSLATE(&quot;Turn off screen&quot;), new BMessage(kMsgTurnOffCheckBox));</a>
<a name="ln320">	fTurnOffCheckBox-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln321">		B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln322"> </a>
<a name="ln323">	fTurnOffSlider = new TimeSlider(&quot;TurnOffSlider&quot;, kMsgTurnOffSliderChanged,</a>
<a name="ln324">		kMsgTurnOffSliderUpdate);</a>
<a name="ln325"> </a>
<a name="ln326">	// Password</a>
<a name="ln327">	fPasswordCheckBox = new BCheckBox(&quot;PasswordCheckbox&quot;,</a>
<a name="ln328">		B_TRANSLATE(&quot;Password lock&quot;), new BMessage(kMsgPasswordCheckBox));</a>
<a name="ln329">	fPasswordCheckBox-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_LEFT,</a>
<a name="ln330">		B_ALIGN_VERTICAL_CENTER));</a>
<a name="ln331"> </a>
<a name="ln332">	fPasswordSlider = new TimeSlider(&quot;PasswordSlider&quot;,</a>
<a name="ln333">		kMsgPasswordSliderChanged, kMsgPasswordSliderUpdate);</a>
<a name="ln334"> </a>
<a name="ln335">	fPasswordButton = new BButton(&quot;PasswordButton&quot;,</a>
<a name="ln336">		B_TRANSLATE(&quot;Password&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln337">		new BMessage(kMsgChangePassword));</a>
<a name="ln338"> </a>
<a name="ln339">	// Bottom</a>
<a name="ln340">	float monitorHeight = 10 + textHeight * 3;</a>
<a name="ln341">	float aspectRatio = 4.0f / 3.0f;</a>
<a name="ln342">	float monitorWidth = monitorHeight * aspectRatio;</a>
<a name="ln343">	BRect monitorRect = BRect(0, 0, monitorWidth, monitorHeight);</a>
<a name="ln344"> </a>
<a name="ln345">	fFadeNow = new ScreenCornerSelector(monitorRect, &quot;FadeNow&quot;,</a>
<a name="ln346">		new BMessage(kMsgFadeCornerChanged), B_FOLLOW_NONE);</a>
<a name="ln347">	fFadeNowText = new BTextView(&quot;FadeNowText&quot;, B_WILL_DRAW);</a>
<a name="ln348">	fFadeNowText-&gt;SetExplicitMinSize(BSize(B_SIZE_UNSET,</a>
<a name="ln349">		4 + textHeight * 4));</a>
<a name="ln350">	fFadeNowText-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln351">	fFadeNowText-&gt;MakeEditable(false);</a>
<a name="ln352">	fFadeNowText-&gt;MakeSelectable(false);</a>
<a name="ln353">	fFadeNowText-&gt;SetText(B_TRANSLATE(&quot;Fade now when mouse is here&quot;));</a>
<a name="ln354"> </a>
<a name="ln355">	fFadeNever = new ScreenCornerSelector(monitorRect, &quot;FadeNever&quot;,</a>
<a name="ln356">		new BMessage(kMsgNeverFadeCornerChanged), B_FOLLOW_NONE);</a>
<a name="ln357">	fFadeNeverText = new BTextView(&quot;FadeNeverText&quot;, B_WILL_DRAW);</a>
<a name="ln358">	fFadeNeverText-&gt;SetExplicitMinSize(BSize(B_SIZE_UNSET,</a>
<a name="ln359">		4 + textHeight * 4));</a>
<a name="ln360">	fFadeNeverText-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln361">	fFadeNeverText-&gt;MakeEditable(false);</a>
<a name="ln362">	fFadeNeverText-&gt;MakeSelectable(false);</a>
<a name="ln363">	fFadeNeverText-&gt;SetText(B_TRANSLATE(&quot;Don't fade when mouse is here&quot;));</a>
<a name="ln364"> </a>
<a name="ln365">	box-&gt;AddChild(BLayoutBuilder::Group&lt;&gt;(B_VERTICAL, 0)</a>
<a name="ln366">		.SetInsets(B_USE_DEFAULT_SPACING, 0, B_USE_DEFAULT_SPACING,</a>
<a name="ln367">			B_USE_DEFAULT_SPACING)</a>
<a name="ln368">		.AddGrid(B_USE_DEFAULT_SPACING, B_USE_SMALL_SPACING)</a>
<a name="ln369">			.Add(startScreenSaver, 0, 0)</a>
<a name="ln370">			.Add(fRunSlider, 1, 0)</a>
<a name="ln371">			.Add(fTurnOffCheckBox, 0, 1)</a>
<a name="ln372">			.Add(BLayoutBuilder::Group&lt;&gt;(B_VERTICAL)</a>
<a name="ln373">				.Add(fTurnOffNotSupported)</a>
<a name="ln374">				.Add(fTurnOffSlider)</a>
<a name="ln375">				.View(), 1, 1)</a>
<a name="ln376">			.Add(fPasswordCheckBox, 0, 2)</a>
<a name="ln377">			.Add(fPasswordSlider, 1, 2)</a>
<a name="ln378">			.End()</a>
<a name="ln379">		.AddGroup(B_HORIZONTAL)</a>
<a name="ln380">			.AddGlue()</a>
<a name="ln381">			.Add(fPasswordButton)</a>
<a name="ln382">			.End()</a>
<a name="ln383">		.AddGlue()</a>
<a name="ln384">		.AddGroup(B_HORIZONTAL)</a>
<a name="ln385">			.Add(fFadeNow)</a>
<a name="ln386">			.AddGroup(B_VERTICAL, 0)</a>
<a name="ln387">				.Add(fFadeNowText)</a>
<a name="ln388">				.AddGlue()</a>
<a name="ln389">				.End()</a>
<a name="ln390">			.Add(fFadeNever)</a>
<a name="ln391">			.AddGroup(B_VERTICAL, 0)</a>
<a name="ln392">				.Add(fFadeNeverText)</a>
<a name="ln393">				.AddGlue()</a>
<a name="ln394">				.End()</a>
<a name="ln395">			.End()</a>
<a name="ln396">		.AddGlue()</a>
<a name="ln397">		.View());</a>
<a name="ln398"> </a>
<a name="ln399">	BLayoutBuilder::Group&lt;&gt;(this, B_HORIZONTAL)</a>
<a name="ln400">		.SetInsets(B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING,</a>
<a name="ln401">			B_USE_WINDOW_SPACING, 0)</a>
<a name="ln402">		.Add(box)</a>
<a name="ln403">		.End();</a>
<a name="ln404"> </a>
<a name="ln405">}</a>
<a name="ln406"> </a>
<a name="ln407"> </a>
<a name="ln408">void</a>
<a name="ln409">FadeView::AttachedToWindow()</a>
<a name="ln410">{</a>
<a name="ln411">	fEnableCheckBox-&gt;SetTarget(this);</a>
<a name="ln412">	fRunSlider-&gt;SetTarget(this);</a>
<a name="ln413">	fTurnOffCheckBox-&gt;SetTarget(this);</a>
<a name="ln414">	fTurnOffSlider-&gt;SetTarget(this);</a>
<a name="ln415">	fFadeNow-&gt;SetTarget(this);</a>
<a name="ln416">	fFadeNever-&gt;SetTarget(this);</a>
<a name="ln417">	fPasswordCheckBox-&gt;SetTarget(this);</a>
<a name="ln418">	fPasswordSlider-&gt;SetTarget(this);</a>
<a name="ln419"> </a>
<a name="ln420">	fEnableCheckBox-&gt;SetValue(</a>
<a name="ln421">		fSettings.TimeFlags() &amp; ENABLE_SAVER ? B_CONTROL_ON : B_CONTROL_OFF);</a>
<a name="ln422">	fRunSlider-&gt;SetTime(fSettings.BlankTime());</a>
<a name="ln423">	fTurnOffSlider-&gt;SetTime(fSettings.OffTime() + fSettings.BlankTime());</a>
<a name="ln424">	fFadeNow-&gt;SetCorner(fSettings.BlankCorner());</a>
<a name="ln425">	fFadeNever-&gt;SetCorner(fSettings.NeverBlankCorner());</a>
<a name="ln426">	fPasswordCheckBox-&gt;SetValue(fSettings.LockEnable());</a>
<a name="ln427">	fPasswordSlider-&gt;SetTime(fSettings.PasswordTime());</a>
<a name="ln428"> </a>
<a name="ln429">	_UpdateColors();</a>
<a name="ln430">	UpdateTurnOffScreen();</a>
<a name="ln431">	UpdateStatus();</a>
<a name="ln432">}</a>
<a name="ln433"> </a>
<a name="ln434"> </a>
<a name="ln435">void</a>
<a name="ln436">FadeView::MessageReceived(BMessage *message)</a>
<a name="ln437">{</a>
<a name="ln438">	switch (message-&gt;what) {</a>
<a name="ln439">		case B_COLORS_UPDATED:</a>
<a name="ln440">			_UpdateColors();</a>
<a name="ln441">			break;</a>
<a name="ln442">		case kMsgRunSliderChanged:</a>
<a name="ln443">		case kMsgRunSliderUpdate:</a>
<a name="ln444">			if (fRunSlider-&gt;Value() &gt; fTurnOffSlider-&gt;Value())</a>
<a name="ln445">				fTurnOffSlider-&gt;SetValue(fRunSlider-&gt;Value());</a>
<a name="ln446"> </a>
<a name="ln447">			if (fRunSlider-&gt;Value() &gt; fPasswordSlider-&gt;Value())</a>
<a name="ln448">				fPasswordSlider-&gt;SetValue(fRunSlider-&gt;Value());</a>
<a name="ln449">			break;</a>
<a name="ln450"> </a>
<a name="ln451">		case kMsgTurnOffSliderChanged:</a>
<a name="ln452">		case kMsgTurnOffSliderUpdate:</a>
<a name="ln453">			if (fRunSlider-&gt;Value() &gt; fTurnOffSlider-&gt;Value())</a>
<a name="ln454">				fRunSlider-&gt;SetValue(fTurnOffSlider-&gt;Value());</a>
<a name="ln455">			break;</a>
<a name="ln456"> </a>
<a name="ln457">		case kMsgPasswordSliderChanged:</a>
<a name="ln458">		case kMsgPasswordSliderUpdate:</a>
<a name="ln459">			if (fPasswordSlider-&gt;Value() &lt; fRunSlider-&gt;Value())</a>
<a name="ln460">				fRunSlider-&gt;SetValue(fPasswordSlider-&gt;Value());</a>
<a name="ln461">			break;</a>
<a name="ln462"> </a>
<a name="ln463">		case kMsgTurnOffCheckBox:</a>
<a name="ln464">			fTurnOffSlider-&gt;SetEnabled(</a>
<a name="ln465">				fTurnOffCheckBox-&gt;Value() == B_CONTROL_ON);</a>
<a name="ln466">			break;</a>
<a name="ln467">	}</a>
<a name="ln468"> </a>
<a name="ln469">	switch (message-&gt;what) {</a>
<a name="ln470">		case kMsgRunSliderChanged:</a>
<a name="ln471">		case kMsgTurnOffSliderChanged:</a>
<a name="ln472">		case kMsgPasswordSliderChanged:</a>
<a name="ln473">		case kMsgPasswordCheckBox:</a>
<a name="ln474">		case kMsgEnableScreenSaverBox:</a>
<a name="ln475">		case kMsgFadeCornerChanged:</a>
<a name="ln476">		case kMsgNeverFadeCornerChanged:</a>
<a name="ln477">			UpdateStatus();</a>
<a name="ln478">			fSettings.Save();</a>
<a name="ln479">			break;</a>
<a name="ln480"> </a>
<a name="ln481">		default:</a>
<a name="ln482">			BView::MessageReceived(message);</a>
<a name="ln483">	}</a>
<a name="ln484">}</a>
<a name="ln485"> </a>
<a name="ln486"> </a>
<a name="ln487">void</a>
<a name="ln488">FadeView::UpdateTurnOffScreen()</a>
<a name="ln489">{</a>
<a name="ln490">	bool enabled = (fSettings.TimeFlags() &amp; ENABLE_DPMS_MASK) != 0;</a>
<a name="ln491"> </a>
<a name="ln492">	BScreen screen(Window());</a>
<a name="ln493">	uint32 dpmsCapabilities = screen.DPMSCapabilites();</a>
<a name="ln494"> </a>
<a name="ln495">	fTurnOffScreenFlags = 0;</a>
<a name="ln496">	if (dpmsCapabilities &amp; B_DPMS_OFF)</a>
<a name="ln497">		fTurnOffScreenFlags |= ENABLE_DPMS_OFF;</a>
<a name="ln498">	if (dpmsCapabilities &amp; B_DPMS_STAND_BY)</a>
<a name="ln499">		fTurnOffScreenFlags |= ENABLE_DPMS_STAND_BY;</a>
<a name="ln500">	if (dpmsCapabilities &amp; B_DPMS_SUSPEND)</a>
<a name="ln501">		fTurnOffScreenFlags |= ENABLE_DPMS_SUSPEND;</a>
<a name="ln502"> </a>
<a name="ln503">	fTurnOffCheckBox-&gt;SetValue(enabled &amp;&amp; fTurnOffScreenFlags != 0</a>
<a name="ln504">		? B_CONTROL_ON : B_CONTROL_OFF);</a>
<a name="ln505"> </a>
<a name="ln506">	enabled = fEnableCheckBox-&gt;Value() == B_CONTROL_ON;</a>
<a name="ln507">	fTurnOffCheckBox-&gt;SetEnabled(enabled &amp;&amp; fTurnOffScreenFlags != 0);</a>
<a name="ln508">	if (fTurnOffScreenFlags != 0) {</a>
<a name="ln509">		fTurnOffNotSupported-&gt;Hide();</a>
<a name="ln510">		fTurnOffSlider-&gt;Show();</a>
<a name="ln511">	} else {</a>
<a name="ln512">		fTurnOffSlider-&gt;Hide();</a>
<a name="ln513">		fTurnOffNotSupported-&gt;Show();</a>
<a name="ln514">	}</a>
<a name="ln515">}</a>
<a name="ln516"> </a>
<a name="ln517"> </a>
<a name="ln518">void</a>
<a name="ln519">FadeView::UpdateStatus()</a>
<a name="ln520">{</a>
<a name="ln521">	Window()-&gt;DisableUpdates();</a>
<a name="ln522"> </a>
<a name="ln523">	bool enabled = fEnableCheckBox-&gt;Value() == B_CONTROL_ON;</a>
<a name="ln524">	fPasswordCheckBox-&gt;SetEnabled(enabled);</a>
<a name="ln525">	fTurnOffCheckBox-&gt;SetEnabled(enabled &amp;&amp; fTurnOffScreenFlags != 0);</a>
<a name="ln526">	fRunSlider-&gt;SetEnabled(enabled);</a>
<a name="ln527">	fTurnOffSlider-&gt;SetEnabled(enabled &amp;&amp; fTurnOffCheckBox-&gt;Value());</a>
<a name="ln528">	fPasswordSlider-&gt;SetEnabled(enabled &amp;&amp; fPasswordCheckBox-&gt;Value());</a>
<a name="ln529">	fPasswordButton-&gt;SetEnabled(enabled &amp;&amp; fPasswordCheckBox-&gt;Value());</a>
<a name="ln530"> </a>
<a name="ln531">	Window()-&gt;EnableUpdates();</a>
<a name="ln532"> </a>
<a name="ln533">	// Update the saved preferences</a>
<a name="ln534">	fSettings.SetWindowFrame(Frame());</a>
<a name="ln535">	fSettings.SetTimeFlags((enabled ? ENABLE_SAVER : 0)</a>
<a name="ln536">		| (fTurnOffCheckBox-&gt;Value() ? fTurnOffScreenFlags : 0));</a>
<a name="ln537">	fSettings.SetBlankTime(fRunSlider-&gt;Time());</a>
<a name="ln538">	bigtime_t offTime = fTurnOffSlider-&gt;Time() - fSettings.BlankTime();</a>
<a name="ln539">	fSettings.SetOffTime(offTime);</a>
<a name="ln540">	fSettings.SetSuspendTime(offTime);</a>
<a name="ln541">	fSettings.SetStandByTime(offTime);</a>
<a name="ln542">	fSettings.SetBlankCorner(fFadeNow-&gt;Corner());</a>
<a name="ln543">	fSettings.SetNeverBlankCorner(fFadeNever-&gt;Corner());</a>
<a name="ln544">	fSettings.SetLockEnable(fPasswordCheckBox-&gt;Value());</a>
<a name="ln545">	fSettings.SetPasswordTime(fPasswordSlider-&gt;Time());</a>
<a name="ln546"> </a>
<a name="ln547">	// TODO - Tell the password window to update its stuff</a>
<a name="ln548">}</a>
<a name="ln549"> </a>
<a name="ln550"> </a>
<a name="ln551">void</a>
<a name="ln552">FadeView::_UpdateColors()</a>
<a name="ln553">{</a>
<a name="ln554">	rgb_color color = ui_color(B_PANEL_TEXT_COLOR);</a>
<a name="ln555">	fFadeNeverText-&gt;SetFontAndColor(be_plain_font, 0, &amp;color);</a>
<a name="ln556">	fFadeNowText-&gt;SetFontAndColor(be_plain_font, 0, &amp;color);</a>
<a name="ln557">}</a>
<a name="ln558"> </a>
<a name="ln559"> </a>
<a name="ln560">//	#pragma mark - ModulesView</a>
<a name="ln561"> </a>
<a name="ln562"> </a>
<a name="ln563">ModulesView::ModulesView(const char* name, ScreenSaverSettings&amp; settings)</a>
<a name="ln564">	:</a>
<a name="ln565">	BView(name, B_WILL_DRAW),</a>
<a name="ln566">	fSettings(settings),</a>
<a name="ln567">	fScreenSaversListView(new BListView(&quot;SaversListView&quot;)),</a>
<a name="ln568">	fTestButton(new BButton(&quot;TestButton&quot;, B_TRANSLATE(&quot;Test&quot;),</a>
<a name="ln569">		new BMessage(kMsgTestSaver))),</a>
<a name="ln570">	fSaverRunner(NULL),</a>
<a name="ln571">	fSettingsBox(new BBox(&quot;SettingsBox&quot;)),</a>
<a name="ln572">	fSettingsView(NULL),</a>
<a name="ln573">	fPreviewView(new PreviewView(&quot;preview&quot;)),</a>
<a name="ln574">	fScreenSaverTestTeam(-1)</a>
<a name="ln575">{</a>
<a name="ln576">	SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln577"> </a>
<a name="ln578">	fScreenSaversListView-&gt;SetSelectionMessage(</a>
<a name="ln579">		new BMessage(kMsgSaverSelected));</a>
<a name="ln580">	BScrollView* saversListScrollView = new BScrollView(&quot;scroll_list&quot;,</a>
<a name="ln581">		fScreenSaversListView, 0, false, true);</a>
<a name="ln582"> </a>
<a name="ln583">	fSettingsBox-&gt;SetLabel(B_TRANSLATE(&quot;Screensaver settings&quot;));</a>
<a name="ln584">	fSettingsBox-&gt;SetExplicitMinSize(BSize(</a>
<a name="ln585">		floorf(be_control_look-&gt;DefaultItemSpacing()</a>
<a name="ln586">			* ((kWindowWidth - 157.0f) / kDefaultItemSpacingAt12pt)),</a>
<a name="ln587">		B_SIZE_UNSET));</a>
<a name="ln588"> </a>
<a name="ln589">	BLayoutBuilder::Group&lt;&gt;(this, B_HORIZONTAL)</a>
<a name="ln590">		.SetInsets(B_USE_WINDOW_SPACING, B_USE_WINDOW_SPACING,</a>
<a name="ln591">			B_USE_WINDOW_SPACING, 0)</a>
<a name="ln592">		.AddGroup(B_VERTICAL)</a>
<a name="ln593">			.Add(fPreviewView)</a>
<a name="ln594">			.Add(saversListScrollView)</a>
<a name="ln595">			.AddGroup(B_HORIZONTAL)</a>
<a name="ln596">				.Add(fTestButton)</a>
<a name="ln597">				.AddGlue()</a>
<a name="ln598">				.End()</a>
<a name="ln599">			.End()</a>
<a name="ln600">		.Add(fSettingsBox)</a>
<a name="ln601">		.End();</a>
<a name="ln602">}</a>
<a name="ln603"> </a>
<a name="ln604"> </a>
<a name="ln605">ModulesView::~ModulesView()</a>
<a name="ln606">{</a>
<a name="ln607">	stop_watching(this);</a>
<a name="ln608"> </a>
<a name="ln609">	delete fTestButton;</a>
<a name="ln610">	delete fSettingsBox;</a>
<a name="ln611">	delete fPreviewView;</a>
<a name="ln612">}</a>
<a name="ln613"> </a>
<a name="ln614"> </a>
<a name="ln615">void</a>
<a name="ln616">ModulesView::DetachedFromWindow()</a>
<a name="ln617">{</a>
<a name="ln618">	SaveState();</a>
<a name="ln619">	EmptyScreenSaverList();</a>
<a name="ln620"> </a>
<a name="ln621">	_CloseSaver();</a>
<a name="ln622">}</a>
<a name="ln623"> </a>
<a name="ln624"> </a>
<a name="ln625">void</a>
<a name="ln626">ModulesView::AttachedToWindow()</a>
<a name="ln627">{</a>
<a name="ln628">	fScreenSaversListView-&gt;SetTarget(this);</a>
<a name="ln629">	fTestButton-&gt;SetTarget(this);</a>
<a name="ln630">}</a>
<a name="ln631"> </a>
<a name="ln632"> </a>
<a name="ln633">void</a>
<a name="ln634">ModulesView::AllAttached()</a>
<a name="ln635">{</a>
<a name="ln636">	PopulateScreenSaverList();</a>
<a name="ln637">	fScreenSaversListView-&gt;Invoke();</a>
<a name="ln638">}</a>
<a name="ln639"> </a>
<a name="ln640"> </a>
<a name="ln641">void</a>
<a name="ln642">ModulesView::MessageReceived(BMessage* message)</a>
<a name="ln643">{</a>
<a name="ln644">	switch (message-&gt;what) {</a>
<a name="ln645">		case kMsgSaverSelected:</a>
<a name="ln646">		{</a>
<a name="ln647">			int32 selection = fScreenSaversListView-&gt;CurrentSelection();</a>
<a name="ln648">			if (selection &lt; 0)</a>
<a name="ln649">				break;</a>
<a name="ln650"> </a>
<a name="ln651">			ScreenSaverItem* item</a>
<a name="ln652">				= (ScreenSaverItem*)fScreenSaversListView-&gt;ItemAt(selection);</a>
<a name="ln653">			if (item == NULL)</a>
<a name="ln654">				break;</a>
<a name="ln655"> </a>
<a name="ln656">			if (strcmp(item-&gt;Text(), B_TRANSLATE(&quot;Blackness&quot;)) == 0)</a>
<a name="ln657">				fSettings.SetModuleName(&quot;&quot;);</a>
<a name="ln658">			else</a>
<a name="ln659">				fSettings.SetModuleName(item-&gt;Text());</a>
<a name="ln660"> </a>
<a name="ln661">			SaveState();</a>
<a name="ln662">			_CloseSaver();</a>
<a name="ln663">			_OpenSaver();</a>
<a name="ln664">			fSettings.Save();</a>
<a name="ln665">			break;</a>
<a name="ln666">		}</a>
<a name="ln667"> </a>
<a name="ln668">		case kMsgTestSaver:</a>
<a name="ln669">		{</a>
<a name="ln670">			SaveState();</a>
<a name="ln671">			fSettings.Save();</a>
<a name="ln672"> </a>
<a name="ln673">			_CloseSaver();</a>
<a name="ln674"> </a>
<a name="ln675">			be_roster-&gt;StartWatching(BMessenger(this, Looper()),</a>
<a name="ln676">				B_REQUEST_QUIT);</a>
<a name="ln677">			BMessage message(kMsgTestSaver);</a>
<a name="ln678">			if (be_roster-&gt;Launch(SCREEN_BLANKER_SIG, &amp;message,</a>
<a name="ln679">					&amp;fScreenSaverTestTeam) == B_OK) {</a>
<a name="ln680">				break;</a>
<a name="ln681">			}</a>
<a name="ln682"> </a>
<a name="ln683">			// Try really hard to launch it. It's very likely that this fails</a>
<a name="ln684">			// when we run from the CD, and there is only an incomplete mime</a>
<a name="ln685">			// database for example...</a>
<a name="ln686">			BPath path;</a>
<a name="ln687">			if (find_directory(B_SYSTEM_BIN_DIRECTORY, &amp;path) != B_OK</a>
<a name="ln688">				|| path.Append(&quot;screen_blanker&quot;) != B_OK) {</a>
<a name="ln689">				path.SetTo(&quot;/bin/screen_blanker&quot;);</a>
<a name="ln690">			}</a>
<a name="ln691"> </a>
<a name="ln692">			BEntry entry(path.Path());</a>
<a name="ln693">			entry_ref ref;</a>
<a name="ln694">			if (entry.GetRef(&amp;ref) == B_OK) {</a>
<a name="ln695">				be_roster-&gt;Launch(&amp;ref, &amp;message,</a>
<a name="ln696">					&amp;fScreenSaverTestTeam);</a>
<a name="ln697">			}</a>
<a name="ln698">			break;</a>
<a name="ln699">		}</a>
<a name="ln700"> </a>
<a name="ln701">		case B_NODE_MONITOR:</a>
<a name="ln702">		{</a>
<a name="ln703">			switch (message-&gt;GetInt32(&quot;opcode&quot;, 0)) {</a>
<a name="ln704">				case B_ENTRY_CREATED:</a>
<a name="ln705">				{</a>
<a name="ln706">					const char* name;</a>
<a name="ln707">					node_ref nodeRef;</a>
<a name="ln708"> </a>
<a name="ln709">					message-&gt;FindString(&quot;name&quot;, &amp;name);</a>
<a name="ln710">					message-&gt;FindInt32(&quot;device&quot;, &amp;nodeRef.device);</a>
<a name="ln711">					message-&gt;FindInt64(&quot;directory&quot;, &amp;nodeRef.node);</a>
<a name="ln712"> </a>
<a name="ln713">					BDirectory dir(&amp;nodeRef);</a>
<a name="ln714"> </a>
<a name="ln715">					if (dir.InitCheck() == B_OK) {</a>
<a name="ln716">						BPath path(&amp;dir);</a>
<a name="ln717">						_AddNewScreenSaverToList(name, &amp;path);</a>
<a name="ln718">					}</a>
<a name="ln719">					break;</a>
<a name="ln720">				}</a>
<a name="ln721"> </a>
<a name="ln722"> </a>
<a name="ln723">				case B_ENTRY_MOVED:</a>
<a name="ln724">				case B_ENTRY_REMOVED:</a>
<a name="ln725">				{</a>
<a name="ln726">					const char* name;</a>
<a name="ln727"> </a>
<a name="ln728">					message-&gt;FindString(&quot;name&quot;, &amp;name);</a>
<a name="ln729">					_RemoveScreenSaverFromList(name);</a>
<a name="ln730"> </a>
<a name="ln731">					break;</a>
<a name="ln732">				}</a>
<a name="ln733"> </a>
<a name="ln734">				default:</a>
<a name="ln735">					// ignore any other operations</a>
<a name="ln736">					break;</a>
<a name="ln737">			}</a>
<a name="ln738">			break;</a>
<a name="ln739">		}</a>
<a name="ln740"> </a>
<a name="ln741">		case B_SOME_APP_QUIT:</a>
<a name="ln742">		{</a>
<a name="ln743">			team_id team;</a>
<a name="ln744">			if (message-&gt;FindInt32(&quot;be:team&quot;, &amp;team) == B_OK</a>
<a name="ln745">				&amp;&amp; team == fScreenSaverTestTeam) {</a>
<a name="ln746">				be_roster-&gt;StopWatching(this);</a>
<a name="ln747">				_OpenSaver();</a>
<a name="ln748">			}</a>
<a name="ln749">			break;</a>
<a name="ln750">		}</a>
<a name="ln751"> </a>
<a name="ln752">		default:</a>
<a name="ln753">			BView::MessageReceived(message);</a>
<a name="ln754">	}</a>
<a name="ln755">}</a>
<a name="ln756"> </a>
<a name="ln757"> </a>
<a name="ln758">void</a>
<a name="ln759">ModulesView::SaveState()</a>
<a name="ln760">{</a>
<a name="ln761">	BScreenSaver* saver = ScreenSaver();</a>
<a name="ln762">	if (saver == NULL)</a>
<a name="ln763">		return;</a>
<a name="ln764"> </a>
<a name="ln765">	BMessage state;</a>
<a name="ln766">	if (saver-&gt;SaveState(&amp;state) == B_OK)</a>
<a name="ln767">		fSettings.SetModuleState(fCurrentName.String(), &amp;state);</a>
<a name="ln768">}</a>
<a name="ln769"> </a>
<a name="ln770"> </a>
<a name="ln771">void</a>
<a name="ln772">ModulesView::EmptyScreenSaverList()</a>
<a name="ln773">{</a>
<a name="ln774">	fScreenSaversListView-&gt;DeselectAll();</a>
<a name="ln775">	while (BListItem* item = fScreenSaversListView-&gt;RemoveItem((int32)0))</a>
<a name="ln776">		delete item;</a>
<a name="ln777">}</a>
<a name="ln778"> </a>
<a name="ln779"> </a>
<a name="ln780">void</a>
<a name="ln781">ModulesView::PopulateScreenSaverList()</a>
<a name="ln782">{</a>
<a name="ln783">	// Blackness is a built-in screen saver</a>
<a name="ln784">	ScreenSaverItem* defaultItem</a>
<a name="ln785">		= new ScreenSaverItem(B_TRANSLATE(&quot;Blackness&quot;), &quot;&quot;);</a>
<a name="ln786">	fScreenSaversListView-&gt;AddItem(defaultItem);</a>
<a name="ln787"> </a>
<a name="ln788">	// Iterate over add-on directories, and add their files to the list view</a>
<a name="ln789"> </a>
<a name="ln790">	directory_which which[] = {</a>
<a name="ln791">		B_USER_NONPACKAGED_ADDONS_DIRECTORY,</a>
<a name="ln792">		B_USER_ADDONS_DIRECTORY,</a>
<a name="ln793">		B_SYSTEM_NONPACKAGED_ADDONS_DIRECTORY,</a>
<a name="ln794">		B_SYSTEM_ADDONS_DIRECTORY,</a>
<a name="ln795">	};</a>
<a name="ln796">	ScreenSaverItem* selectedItem = NULL;</a>
<a name="ln797"> </a>
<a name="ln798">	for (uint32 i = 0; i &lt; sizeof(which) / sizeof(which[0]); i++) {</a>
<a name="ln799">		BPath basePath;</a>
<a name="ln800">		if (find_directory(which[i], &amp;basePath) != B_OK)</a>
<a name="ln801">			continue;</a>
<a name="ln802">		else if (basePath.Append(&quot;Screen Savers&quot;, true) != B_OK)</a>
<a name="ln803">			continue;</a>
<a name="ln804"> </a>
<a name="ln805">		BDirectory dir(basePath.Path());</a>
<a name="ln806">		BEntry entry;</a>
<a name="ln807">		node_ref nodeRef;</a>
<a name="ln808"> </a>
<a name="ln809">		dir.GetNodeRef(&amp;nodeRef);</a>
<a name="ln810">		watch_node(&amp;nodeRef, B_WATCH_DIRECTORY, this);</a>
<a name="ln811"> </a>
<a name="ln812">		while (dir.GetNextEntry(&amp;entry, true) == B_OK) {</a>
<a name="ln813">			char name[B_FILE_NAME_LENGTH];</a>
<a name="ln814">			if (entry.GetName(name) != B_OK)</a>
<a name="ln815">				continue;</a>
<a name="ln816"> </a>
<a name="ln817">			BPath path(basePath);</a>
<a name="ln818">			if (path.Append(name) != B_OK)</a>
<a name="ln819">				continue;</a>
<a name="ln820"> </a>
<a name="ln821">			ScreenSaverItem* item = new ScreenSaverItem(name, path.Path());</a>
<a name="ln822">			fScreenSaversListView-&gt;AddItem(item);</a>
<a name="ln823"> </a>
<a name="ln824">			if (selectedItem != NULL)</a>
<a name="ln825">				continue;</a>
<a name="ln826"> </a>
<a name="ln827">			if (strcmp(fSettings.ModuleName(), item-&gt;Text()) == 0)</a>
<a name="ln828">				selectedItem = item;</a>
<a name="ln829">		}</a>
<a name="ln830">	}</a>
<a name="ln831"> </a>
<a name="ln832">	fScreenSaversListView-&gt;SortItems(_CompareScreenSaverItems);</a>
<a name="ln833">	if (selectedItem == NULL)</a>
<a name="ln834">		selectedItem = defaultItem;</a>
<a name="ln835"> </a>
<a name="ln836">	fScreenSaversListView-&gt;Select(fScreenSaversListView-&gt;IndexOf(selectedItem));</a>
<a name="ln837">	fScreenSaversListView-&gt;ScrollToSelection();</a>
<a name="ln838">}</a>
<a name="ln839"> </a>
<a name="ln840"> </a>
<a name="ln841">//! Sorting function for ScreenSaverItems</a>
<a name="ln842">int</a>
<a name="ln843">ModulesView::_CompareScreenSaverItems(const void* left, const void* right)</a>
<a name="ln844">{</a>
<a name="ln845">	ScreenSaverItem* leftItem  = *(ScreenSaverItem **)left;</a>
<a name="ln846">	ScreenSaverItem* rightItem = *(ScreenSaverItem **)right;</a>
<a name="ln847"> </a>
<a name="ln848">	return strcasecmp(leftItem-&gt;Text(), rightItem-&gt;Text());</a>
<a name="ln849">}</a>
<a name="ln850"> </a>
<a name="ln851"> </a>
<a name="ln852">BScreenSaver*</a>
<a name="ln853">ModulesView::ScreenSaver()</a>
<a name="ln854">{</a>
<a name="ln855">	if (fSaverRunner != NULL)</a>
<a name="ln856">		return fSaverRunner-&gt;ScreenSaver();</a>
<a name="ln857"> </a>
<a name="ln858">	return NULL;</a>
<a name="ln859">}</a>
<a name="ln860"> </a>
<a name="ln861"> </a>
<a name="ln862">void</a>
<a name="ln863">ModulesView::_CloseSaver()</a>
<a name="ln864">{</a>
<a name="ln865">	// remove old screen saver preview &amp; config</a>
<a name="ln866"> </a>
<a name="ln867">	BScreenSaver* saver = ScreenSaver();</a>
<a name="ln868">	BView* view = fPreviewView-&gt;RemovePreview();</a>
<a name="ln869">	if (fSettingsView != NULL)</a>
<a name="ln870">		fSettingsBox-&gt;RemoveChild(fSettingsView);</a>
<a name="ln871"> </a>
<a name="ln872">	if (fSaverRunner != NULL)</a>
<a name="ln873">		fSaverRunner-&gt;Quit();</a>
<a name="ln874"> </a>
<a name="ln875">	if (saver != NULL)</a>
<a name="ln876">		saver-&gt;StopConfig();</a>
<a name="ln877"> </a>
<a name="ln878">	delete view;</a>
<a name="ln879">	delete fSettingsView;</a>
<a name="ln880">	delete fSaverRunner;</a>
<a name="ln881">		// the saver runner also unloads the add-on, so it must</a>
<a name="ln882">		// be deleted last</a>
<a name="ln883"> </a>
<a name="ln884">	fSettingsView = NULL;</a>
<a name="ln885">	fSaverRunner = NULL;</a>
<a name="ln886">}</a>
<a name="ln887"> </a>
<a name="ln888"> </a>
<a name="ln889">void</a>
<a name="ln890">ModulesView::_OpenSaver()</a>
<a name="ln891">{</a>
<a name="ln892">	// create new screen saver preview &amp; config</a>
<a name="ln893"> </a>
<a name="ln894">	BView* view = fPreviewView-&gt;AddPreview();</a>
<a name="ln895">	fCurrentName = fSettings.ModuleName();</a>
<a name="ln896">	fSaverRunner = new ScreenSaverRunner(view-&gt;Window(), view, fSettings);</a>
<a name="ln897"> </a>
<a name="ln898">#ifdef __HAIKU__</a>
<a name="ln899">	BRect rect = fSettingsBox-&gt;InnerFrame().InsetByCopy(4, 4);</a>
<a name="ln900">#else</a>
<a name="ln901">	BRect rect = fSettingsBox-&gt;Bounds().InsetByCopy(4, 4);</a>
<a name="ln902">	rect.top += 14;</a>
<a name="ln903">#endif</a>
<a name="ln904">	fSettingsView = new BView(rect, &quot;SettingsView&quot;, B_FOLLOW_ALL, B_WILL_DRAW);</a>
<a name="ln905"> </a>
<a name="ln906">	fSettingsView-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln907">	fSettingsBox-&gt;AddChild(fSettingsView);</a>
<a name="ln908"> </a>
<a name="ln909">	BScreenSaver* saver = ScreenSaver();</a>
<a name="ln910">	if (saver != NULL &amp;&amp; fSettingsView != NULL) {</a>
<a name="ln911">		saver-&gt;StartConfig(fSettingsView);</a>
<a name="ln912">		if (saver-&gt;StartSaver(view, true) == B_OK) {</a>
<a name="ln913">			fPreviewView-&gt;HideNoPreview();</a>
<a name="ln914">			fSaverRunner-&gt;Run();</a>
<a name="ln915">		} else</a>
<a name="ln916">			fPreviewView-&gt;ShowNoPreview();</a>
<a name="ln917">	} else {</a>
<a name="ln918">		// Failed to load OR this is the &quot;Blackness&quot; screensaver. Show a black</a>
<a name="ln919">		// preview (this is what will happen in both cases when screen_blanker</a>
<a name="ln920">		// runs).</a>
<a name="ln921">		fPreviewView-&gt;HideNoPreview();</a>
<a name="ln922">	}</a>
<a name="ln923"> </a>
<a name="ln924">	if (fSettingsView-&gt;ChildAt(0) == NULL) {</a>
<a name="ln925">		// There are no settings at all, we add the module name here to</a>
<a name="ln926">		// let it look a bit better at least.</a>
<a name="ln927">		BPrivate::BuildDefaultSettingsView(fSettingsView,</a>
<a name="ln928">			fSettings.ModuleName()[0] ? fSettings.ModuleName()</a>
<a name="ln929">				: B_TRANSLATE(&quot;Blackness&quot;),</a>
<a name="ln930">				saver != NULL || !fSettings.ModuleName()[0]</a>
<a name="ln931">					? B_TRANSLATE(&quot;No options available&quot;)</a>
<a name="ln932">					: B_TRANSLATE(&quot;Could not load screen saver&quot;));</a>
<a name="ln933">	}</a>
<a name="ln934">}</a>
<a name="ln935"> </a>
<a name="ln936"> </a>
<a name="ln937">void</a>
<a name="ln938">ModulesView::_AddNewScreenSaverToList(const char* name, BPath* path)</a>
<a name="ln939">{</a>
<a name="ln940">	int32 oldSelected = fScreenSaversListView-&gt;CurrentSelection();</a>
<a name="ln941">	ScreenSaverItem* selectedItem = (ScreenSaverItem*)fScreenSaversListView-&gt;ItemAt(</a>
<a name="ln942">		oldSelected);</a>
<a name="ln943"> </a>
<a name="ln944">	path-&gt;Append(name);</a>
<a name="ln945">	fScreenSaversListView-&gt;AddItem(new ScreenSaverItem(name, path-&gt;Path()));</a>
<a name="ln946">	fScreenSaversListView-&gt;SortItems(_CompareScreenSaverItems);</a>
<a name="ln947"> </a>
<a name="ln948">	if (selectedItem != NULL) {</a>
<a name="ln949">		fScreenSaversListView-&gt;Select(fScreenSaversListView-&gt;IndexOf(</a>
<a name="ln950">			selectedItem));</a>
<a name="ln951">		fScreenSaversListView-&gt;ScrollToSelection();</a>
<a name="ln952">	}</a>
<a name="ln953">}</a>
<a name="ln954"> </a>
<a name="ln955"> </a>
<a name="ln956">void</a>
<a name="ln957">ModulesView::_RemoveScreenSaverFromList(const char* name)</a>
<a name="ln958">{</a>
<a name="ln959">	int32 oldSelected = fScreenSaversListView-&gt;CurrentSelection();</a>
<a name="ln960">	ScreenSaverItem* selectedItem = (ScreenSaverItem*)fScreenSaversListView-&gt;ItemAt(</a>
<a name="ln961">		oldSelected);</a>
<a name="ln962"> </a>
<a name="ln963">	if (strcasecmp(selectedItem-&gt;Text(), name) == 0) {</a>
<a name="ln964">		fScreenSaversListView-&gt;RemoveItem(selectedItem);</a>
<a name="ln965">		fScreenSaversListView-&gt;SortItems(_CompareScreenSaverItems);</a>
<a name="ln966">		fScreenSaversListView-&gt;Select(0);</a>
<a name="ln967">		fScreenSaversListView-&gt;ScrollToSelection();</a>
<a name="ln968">		return;</a>
<a name="ln969">	}</a>
<a name="ln970"> </a>
<a name="ln971">	for (int i = 0, max = fScreenSaversListView-&gt;CountItems(); i &lt; max; i++) {</a>
<a name="ln972">		ScreenSaverItem* item = (ScreenSaverItem*)fScreenSaversListView-&gt;ItemAt(</a>
<a name="ln973">			i);</a>
<a name="ln974"> </a>
<a name="ln975">		if (strcasecmp(item-&gt;Text(), name) == 0) {</a>
<a name="ln976">			fScreenSaversListView-&gt;RemoveItem(item);</a>
<a name="ln977">			delete item;</a>
<a name="ln978">			break;</a>
<a name="ln979">		}</a>
<a name="ln980">	}</a>
<a name="ln981"> </a>
<a name="ln982">	fScreenSaversListView-&gt;SortItems(_CompareScreenSaverItems);</a>
<a name="ln983"> </a>
<a name="ln984">	oldSelected = fScreenSaversListView-&gt;IndexOf(selectedItem);</a>
<a name="ln985">	fScreenSaversListView-&gt;Select(oldSelected);</a>
<a name="ln986">	fScreenSaversListView-&gt;ScrollToSelection();</a>
<a name="ln987">}</a>
<a name="ln988"> </a>
<a name="ln989"> </a>
<a name="ln990">//	#pragma mark - TabView</a>
<a name="ln991"> </a>
<a name="ln992"> </a>
<a name="ln993">TabView::TabView()</a>
<a name="ln994">	:</a>
<a name="ln995">	BTabView(&quot;tab_view&quot;, B_WIDTH_FROM_LABEL)</a>
<a name="ln996">{</a>
<a name="ln997">}</a>
<a name="ln998"> </a>
<a name="ln999"> </a>
<a name="ln1000">void</a>
<a name="ln1001">TabView::MouseDown(BPoint where)</a>
<a name="ln1002">{</a>
<a name="ln1003">	BTab* fadeTab = TabAt(0);</a>
<a name="ln1004">	BRect fadeTabFrame(TabFrame(0));</a>
<a name="ln1005">	BTab* modulesTab = TabAt(1);</a>
<a name="ln1006">	BRect modulesTabFrame(TabFrame(1));</a>
<a name="ln1007">	ModulesView* modulesView = dynamic_cast&lt;ModulesView*&gt;(modulesTab-&gt;View());</a>
<a name="ln1008"> </a>
<a name="ln1009">	if (fadeTab != NULL &amp;&amp; Selection() != 0 &amp;&amp; fadeTabFrame.Contains(where)</a>
<a name="ln1010">		&amp;&amp; modulesView != NULL) {</a>
<a name="ln1011">		// clicked on the fade tab</a>
<a name="ln1012">		modulesView-&gt;SaveState();</a>
<a name="ln1013">		modulesView-&gt;_CloseSaver();</a>
<a name="ln1014">	} else if (modulesTab != NULL &amp;&amp; Selection() != 1</a>
<a name="ln1015">		&amp;&amp; modulesTabFrame.Contains(where) &amp;&amp; modulesView != NULL) {</a>
<a name="ln1016">		// clicked on the modules tab</a>
<a name="ln1017">		BMessage message(kMsgSaverSelected);</a>
<a name="ln1018">		modulesView-&gt;MessageReceived(&amp;message);</a>
<a name="ln1019">	}</a>
<a name="ln1020"> </a>
<a name="ln1021">	BTabView::MouseDown(where);</a>
<a name="ln1022">}</a>
<a name="ln1023"> </a>
<a name="ln1024"> </a>
<a name="ln1025">//	#pragma mark - ScreenSaverWindow</a>
<a name="ln1026"> </a>
<a name="ln1027"> </a>
<a name="ln1028">ScreenSaverWindow::ScreenSaverWindow()</a>
<a name="ln1029">	:</a>
<a name="ln1030">	BWindow(BRect(50.0f, 50.0f, 50.0f + kWindowWidth, 50.0f + kWindowHeight),</a>
<a name="ln1031">		B_TRANSLATE_SYSTEM_NAME(&quot;ScreenSaver&quot;), B_TITLED_WINDOW,</a>
<a name="ln1032">		B_ASYNCHRONOUS_CONTROLS | B_AUTO_UPDATE_SIZE_LIMITS)</a>
<a name="ln1033">{</a>
<a name="ln1034">	fSettings.Load();</a>
<a name="ln1035"> </a>
<a name="ln1036">	fMinWidth = floorf(be_control_look-&gt;DefaultItemSpacing()</a>
<a name="ln1037">		* (kWindowWidth / kDefaultItemSpacingAt12pt));</a>
<a name="ln1038"> </a>
<a name="ln1039">	font_height fontHeight;</a>
<a name="ln1040">	be_plain_font-&gt;GetHeight(&amp;fontHeight);</a>
<a name="ln1041">	float textHeight = ceilf(fontHeight.ascent + fontHeight.descent);</a>
<a name="ln1042"> </a>
<a name="ln1043">	fMinHeight = ceilf(std::max(kWindowHeight, textHeight * 28));</a>
<a name="ln1044"> </a>
<a name="ln1045">	// Create the password editing window</a>
<a name="ln1046">	fPasswordWindow = new PasswordWindow(fSettings);</a>
<a name="ln1047">	fPasswordWindow-&gt;Run();</a>
<a name="ln1048"> </a>
<a name="ln1049">	// Create the tab view</a>
<a name="ln1050">	fTabView = new TabView();</a>
<a name="ln1051">	fTabView-&gt;SetBorder(B_NO_BORDER);</a>
<a name="ln1052"> </a>
<a name="ln1053">	// Create the controls inside the tabs</a>
<a name="ln1054">	fFadeView = new FadeView(B_TRANSLATE(&quot;General&quot;), fSettings);</a>
<a name="ln1055">	fModulesView = new ModulesView(B_TRANSLATE(&quot;Screensavers&quot;), fSettings);</a>
<a name="ln1056"> </a>
<a name="ln1057">	fTabView-&gt;AddTab(fFadeView);</a>
<a name="ln1058">	fTabView-&gt;AddTab(fModulesView);</a>
<a name="ln1059"> </a>
<a name="ln1060">	// Create the topmost background view</a>
<a name="ln1061">	BView* topView = new BView(&quot;topView&quot;, B_WILL_DRAW);</a>
<a name="ln1062">	topView-&gt;SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln1063">	topView-&gt;SetExplicitAlignment(BAlignment(B_ALIGN_USE_FULL_WIDTH,</a>
<a name="ln1064">		B_ALIGN_USE_FULL_HEIGHT));</a>
<a name="ln1065">	topView-&gt;SetExplicitMinSize(BSize(fMinWidth, fMinHeight));</a>
<a name="ln1066">	BLayoutBuilder::Group&lt;&gt;(topView, B_VERTICAL)</a>
<a name="ln1067">		.SetInsets(0, B_USE_DEFAULT_SPACING, 0, B_USE_WINDOW_SPACING)</a>
<a name="ln1068">		.Add(fTabView)</a>
<a name="ln1069">		.End();</a>
<a name="ln1070"> </a>
<a name="ln1071">	SetLayout(new BGroupLayout(B_VERTICAL));</a>
<a name="ln1072">	GetLayout()-&gt;AddView(topView);</a>
<a name="ln1073"> </a>
<a name="ln1074">	fTabView-&gt;Select(fSettings.WindowTab());</a>
<a name="ln1075"> </a>
<a name="ln1076">	if (fSettings.WindowFrame().left &gt; 0 &amp;&amp; fSettings.WindowFrame().top &gt; 0)</a>
<a name="ln1077">		MoveTo(fSettings.WindowFrame().left, fSettings.WindowFrame().top);</a>
<a name="ln1078"> </a>
<a name="ln1079">	if (fSettings.WindowFrame().Width() &gt; 0</a>
<a name="ln1080">		&amp;&amp; fSettings.WindowFrame().Height() &gt; 0) {</a>
<a name="ln1081">		ResizeTo(fSettings.WindowFrame().Width(),</a>
<a name="ln1082">			fSettings.WindowFrame().Height());</a>
<a name="ln1083">	}</a>
<a name="ln1084"> </a>
<a name="ln1085">	CenterOnScreen();</a>
<a name="ln1086">}</a>
<a name="ln1087"> </a>
<a name="ln1088"> </a>
<a name="ln1089">ScreenSaverWindow::~ScreenSaverWindow()</a>
<a name="ln1090">{</a>
<a name="ln1091">	Hide();</a>
<a name="ln1092">	fFadeView-&gt;UpdateStatus();</a>
<a name="ln1093">	fSettings.SetWindowTab(fTabView-&gt;Selection());</a>
<a name="ln1094"> </a>
<a name="ln1095">	delete fTabView-&gt;RemoveTab(1);</a>
<a name="ln1096">		// We delete this here in order to make sure the module view saves its</a>
<a name="ln1097">		// state while the window is still intact.</a>
<a name="ln1098"> </a>
<a name="ln1099">	fSettings.Save();</a>
<a name="ln1100">}</a>
<a name="ln1101"> </a>
<a name="ln1102"> </a>
<a name="ln1103">void</a>
<a name="ln1104">ScreenSaverWindow::MessageReceived(BMessage* message)</a>
<a name="ln1105">{</a>
<a name="ln1106">	switch (message-&gt;what) {</a>
<a name="ln1107">		case kMsgChangePassword:</a>
<a name="ln1108">			fPasswordWindow-&gt;CenterIn(Frame());</a>
<a name="ln1109">			fPasswordWindow-&gt;Show();</a>
<a name="ln1110">			break;</a>
<a name="ln1111"> </a>
<a name="ln1112">		case kMsgUpdateList:</a>
<a name="ln1113">			fModulesView-&gt;EmptyScreenSaverList();</a>
<a name="ln1114">			fModulesView-&gt;PopulateScreenSaverList();</a>
<a name="ln1115">			break;</a>
<a name="ln1116"> </a>
<a name="ln1117">		default:</a>
<a name="ln1118">			BWindow::MessageReceived(message);</a>
<a name="ln1119">	}</a>
<a name="ln1120">}</a>
<a name="ln1121"> </a>
<a name="ln1122"> </a>
<a name="ln1123">void</a>
<a name="ln1124">ScreenSaverWindow::ScreenChanged(BRect frame, color_space colorSpace)</a>
<a name="ln1125">{</a>
<a name="ln1126">	fFadeView-&gt;UpdateTurnOffScreen();</a>
<a name="ln1127">}</a>
<a name="ln1128"> </a>
<a name="ln1129"> </a>
<a name="ln1130">bool</a>
<a name="ln1131">ScreenSaverWindow::QuitRequested()</a>
<a name="ln1132">{</a>
<a name="ln1133">	be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln1134">	return true;</a>
<a name="ln1135">}</a>

</code></pre>
<div class="balloon" rel="1007"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'modulesTab' pointer was utilized before it was verified against nullptr. Check lines: 1007, 1014.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
