
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>PowerStatusView.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright 2006-2018, Haiku, Inc. All Rights Reserved.</a>
<a name="ln3"> * Distributed under the terms of the MIT License.</a>
<a name="ln4"> *</a>
<a name="ln5"> * Authors:</a>
<a name="ln6"> *		Axel DÃ¶rfler, axeld@pinc-software.de</a>
<a name="ln7"> *		Clemens Zeidler, haiku@Clemens-Zeidler.de</a>
<a name="ln8"> *		Alexander von Gluck, kallisti5@unixzen.com</a>
<a name="ln9"> *		Kacper Kasper, kacperkasper@gmail.com</a>
<a name="ln10"> */</a>
<a name="ln11"> </a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;PowerStatusView.h&quot;</a>
<a name="ln14"> </a>
<a name="ln15">#include &lt;algorithm&gt;</a>
<a name="ln16">#include &lt;stdio.h&gt;</a>
<a name="ln17">#include &lt;stdlib.h&gt;</a>
<a name="ln18">#include &lt;string.h&gt;</a>
<a name="ln19">#include &lt;unistd.h&gt;</a>
<a name="ln20"> </a>
<a name="ln21">#include &lt;AboutWindow.h&gt;</a>
<a name="ln22">#include &lt;Application.h&gt;</a>
<a name="ln23">#include &lt;Bitmap.h&gt;</a>
<a name="ln24">#include &lt;Catalog.h&gt;</a>
<a name="ln25">#include &lt;ControlLook.h&gt;</a>
<a name="ln26">#include &lt;DataIO.h&gt;</a>
<a name="ln27">#include &lt;Deskbar.h&gt;</a>
<a name="ln28">#include &lt;Dragger.h&gt;</a>
<a name="ln29">#include &lt;Drivers.h&gt;</a>
<a name="ln30">#include &lt;File.h&gt;</a>
<a name="ln31">#include &lt;FindDirectory.h&gt;</a>
<a name="ln32">#include &lt;MenuItem.h&gt;</a>
<a name="ln33">#include &lt;MessageRunner.h&gt;</a>
<a name="ln34">#include &lt;Notification.h&gt;</a>
<a name="ln35">#include &lt;Path.h&gt;</a>
<a name="ln36">#include &lt;PopUpMenu.h&gt;</a>
<a name="ln37">#include &lt;Resources.h&gt;</a>
<a name="ln38">#include &lt;Roster.h&gt;</a>
<a name="ln39">#include &lt;TextView.h&gt;</a>
<a name="ln40">#include &lt;TranslationUtils.h&gt;</a>
<a name="ln41"> </a>
<a name="ln42">#include &quot;ACPIDriverInterface.h&quot;</a>
<a name="ln43">#include &quot;APMDriverInterface.h&quot;</a>
<a name="ln44">#include &quot;ExtendedInfoWindow.h&quot;</a>
<a name="ln45">#include &quot;PowerStatus.h&quot;</a>
<a name="ln46"> </a>
<a name="ln47"> </a>
<a name="ln48">#undef B_TRANSLATION_CONTEXT</a>
<a name="ln49">#define B_TRANSLATION_CONTEXT &quot;PowerStatus&quot;</a>
<a name="ln50"> </a>
<a name="ln51"> </a>
<a name="ln52">extern &quot;C&quot; _EXPORT BView *instantiate_deskbar_item(float maxWidth,</a>
<a name="ln53">	float maxHeight);</a>
<a name="ln54">extern const char* kDeskbarItemName;</a>
<a name="ln55"> </a>
<a name="ln56">const uint32 kMsgToggleLabel = 'tglb';</a>
<a name="ln57">const uint32 kMsgToggleTime = 'tgtm';</a>
<a name="ln58">const uint32 kMsgToggleStatusIcon = 'tgsi';</a>
<a name="ln59">const uint32 kMsgToggleExtInfo = 'texi';</a>
<a name="ln60"> </a>
<a name="ln61">const uint32 kMinIconWidth = 16;</a>
<a name="ln62">const uint32 kMinIconHeight = 16;</a>
<a name="ln63"> </a>
<a name="ln64">const int32 kLowBatteryPercentage = 15;</a>
<a name="ln65">const int32 kNoteBatteryPercentage = 30;</a>
<a name="ln66"> </a>
<a name="ln67"> </a>
<a name="ln68">PowerStatusView::PowerStatusView(PowerStatusDriverInterface* interface,</a>
<a name="ln69">	BRect frame, int32 resizingMode,  int batteryID, bool inDeskbar)</a>
<a name="ln70">	:</a>
<a name="ln71">	BView(frame, kDeskbarItemName, resizingMode,</a>
<a name="ln72">		B_WILL_DRAW | B_FULL_UPDATE_ON_RESIZE),</a>
<a name="ln73">	fDriverInterface(interface),</a>
<a name="ln74">	fBatteryID(batteryID),</a>
<a name="ln75">	fInDeskbar(inDeskbar)</a>
<a name="ln76">{</a>
<a name="ln77">	_Init();</a>
<a name="ln78">}</a>
<a name="ln79"> </a>
<a name="ln80"> </a>
<a name="ln81">PowerStatusView::PowerStatusView(BMessage* archive)</a>
<a name="ln82">	:</a>
<a name="ln83">	BView(archive),</a>
<a name="ln84">	fInDeskbar(false)</a>
<a name="ln85">{</a>
<a name="ln86">	app_info info;</a>
<a name="ln87">	if (be_app-&gt;GetAppInfo(&amp;info) == B_OK</a>
<a name="ln88">		&amp;&amp; !strcasecmp(info.signature, kDeskbarSignature))</a>
<a name="ln89">		fInDeskbar = true;</a>
<a name="ln90">	_Init();</a>
<a name="ln91">	FromMessage(archive);</a>
<a name="ln92">}</a>
<a name="ln93"> </a>
<a name="ln94"> </a>
<a name="ln95">PowerStatusView::~PowerStatusView()</a>
<a name="ln96">{</a>
<a name="ln97">}</a>
<a name="ln98"> </a>
<a name="ln99"> </a>
<a name="ln100">status_t</a>
<a name="ln101">PowerStatusView::Archive(BMessage* archive, bool deep) const</a>
<a name="ln102">{</a>
<a name="ln103">	status_t status = BView::Archive(archive, deep);</a>
<a name="ln104">	if (status == B_OK)</a>
<a name="ln105">		status = ToMessage(archive);</a>
<a name="ln106"> </a>
<a name="ln107">	return status;</a>
<a name="ln108">}</a>
<a name="ln109"> </a>
<a name="ln110"> </a>
<a name="ln111">void</a>
<a name="ln112">PowerStatusView::_Init()</a>
<a name="ln113">{</a>
<a name="ln114">	fShowLabel = true;</a>
<a name="ln115">	fShowTime = false;</a>
<a name="ln116">	fShowStatusIcon = true;</a>
<a name="ln117"> </a>
<a name="ln118">	fPercent = 100;</a>
<a name="ln119">	fOnline = true;</a>
<a name="ln120">	fTimeLeft = 0;</a>
<a name="ln121">}</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">void</a>
<a name="ln125">PowerStatusView::AttachedToWindow()</a>
<a name="ln126">{</a>
<a name="ln127">	BView::AttachedToWindow();</a>
<a name="ln128">	if (Parent() != NULL) {</a>
<a name="ln129">		if ((Parent()-&gt;Flags() &amp; B_DRAW_ON_CHILDREN) != 0)</a>
<a name="ln130">			SetViewColor(B_TRANSPARENT_COLOR);</a>
<a name="ln131">		else</a>
<a name="ln132">			AdoptParentColors();</a>
<a name="ln133">	} else</a>
<a name="ln134">		SetViewUIColor(B_PANEL_BACKGROUND_COLOR);</a>
<a name="ln135"> </a>
<a name="ln136">	if (ViewUIColor() != B_NO_COLOR)</a>
<a name="ln137">		SetLowUIColor(ViewUIColor());</a>
<a name="ln138">	else</a>
<a name="ln139">		SetLowColor(ViewColor());</a>
<a name="ln140"> </a>
<a name="ln141">	Update();</a>
<a name="ln142">}</a>
<a name="ln143"> </a>
<a name="ln144"> </a>
<a name="ln145">void</a>
<a name="ln146">PowerStatusView::DetachedFromWindow()</a>
<a name="ln147">{</a>
<a name="ln148">}</a>
<a name="ln149"> </a>
<a name="ln150"> </a>
<a name="ln151">void</a>
<a name="ln152">PowerStatusView::MessageReceived(BMessage *message)</a>
<a name="ln153">{</a>
<a name="ln154">	switch (message-&gt;what) {</a>
<a name="ln155">		case kMsgUpdate:</a>
<a name="ln156">			Update();</a>
<a name="ln157">			break;</a>
<a name="ln158"> </a>
<a name="ln159">		default:</a>
<a name="ln160">			BView::MessageReceived(message);</a>
<a name="ln161">	}</a>
<a name="ln162">}</a>
<a name="ln163"> </a>
<a name="ln164"> </a>
<a name="ln165">void</a>
<a name="ln166">PowerStatusView::_DrawBattery(BView* view, BRect rect)</a>
<a name="ln167">{</a>
<a name="ln168">	BRect lightningRect = rect;</a>
<a name="ln169">	float quarter = floorf((rect.Height() + 1) / 4);</a>
<a name="ln170">	rect.top += quarter;</a>
<a name="ln171">	rect.bottom -= quarter;</a>
<a name="ln172"> </a>
<a name="ln173">	rect.InsetBy(2, 0);</a>
<a name="ln174"> </a>
<a name="ln175">	float left = rect.left;</a>
<a name="ln176">	rect.left += rect.Width() / 11;</a>
<a name="ln177">	lightningRect.left = rect.left;</a>
<a name="ln178">	lightningRect.InsetBy(0.0f, 5.0f * rect.Height() / 16);</a>
<a name="ln179"> </a>
<a name="ln180">	if (view-&gt;LowColor().Brightness() &gt; 100)</a>
<a name="ln181">		view-&gt;SetHighColor(0, 0, 0);</a>
<a name="ln182">	else</a>
<a name="ln183">		view-&gt;SetHighColor(128, 128, 128);</a>
<a name="ln184"> </a>
<a name="ln185">	float gap = 1;</a>
<a name="ln186">	if (rect.Height() &gt; 8) {</a>
<a name="ln187">		gap = ceilf((rect.left - left) / 2);</a>
<a name="ln188"> </a>
<a name="ln189">		// left</a>
<a name="ln190">		view-&gt;FillRect(BRect(rect.left, rect.top, rect.left + gap - 1, rect.bottom));</a>
<a name="ln191">		// right</a>
<a name="ln192">		view-&gt;FillRect(BRect(rect.right - gap + 1, rect.top, rect.right,</a>
<a name="ln193">			rect.bottom));</a>
<a name="ln194">		// top</a>
<a name="ln195">		view-&gt;FillRect(BRect(rect.left + gap, rect.top, rect.right - gap,</a>
<a name="ln196">			rect.top + gap - 1));</a>
<a name="ln197">		// bottom</a>
<a name="ln198">		view-&gt;FillRect(BRect(rect.left + gap, rect.bottom + 1 - gap,</a>
<a name="ln199">			rect.right - gap, rect.bottom));</a>
<a name="ln200">	} else</a>
<a name="ln201">		view-&gt;StrokeRect(rect);</a>
<a name="ln202"> </a>
<a name="ln203">	view-&gt;FillRect(BRect(left, floorf(rect.top + rect.Height() / 4) + 1,</a>
<a name="ln204">		rect.left - 1, floorf(rect.bottom - rect.Height() / 4)));</a>
<a name="ln205"> </a>
<a name="ln206">	int32 percent = fPercent;</a>
<a name="ln207">	if (percent &gt; 100)</a>
<a name="ln208">		percent = 100;</a>
<a name="ln209">	else if (percent &lt; 0 || !fHasBattery)</a>
<a name="ln210">		percent = 0;</a>
<a name="ln211"> </a>
<a name="ln212">	if (percent &gt; 0) {</a>
<a name="ln213">		rect.InsetBy(gap, gap);</a>
<a name="ln214">		rgb_color base = (rgb_color){84, 84, 84, 255};</a>
<a name="ln215">		if (view-&gt;LowColor().Brightness() &lt; 128)</a>
<a name="ln216">			base = (rgb_color){172, 172, 172, 255};</a>
<a name="ln217"> </a>
<a name="ln218">		if (be_control_look != NULL) {</a>
<a name="ln219">			BRect empty = rect;</a>
<a name="ln220">			if (fHasBattery &amp;&amp; percent &gt; 0)</a>
<a name="ln221">				empty.left += empty.Width() * percent / 100.0;</a>
<a name="ln222"> </a>
<a name="ln223">			be_control_look-&gt;DrawButtonBackground(view, empty, empty, base,</a>
<a name="ln224">				fHasBattery</a>
<a name="ln225">					? BControlLook::B_ACTIVATED : BControlLook::B_DISABLED,</a>
<a name="ln226">				fHasBattery &amp;&amp; percent &gt; 0</a>
<a name="ln227">					? (BControlLook::B_ALL_BORDERS</a>
<a name="ln228">						&amp; ~BControlLook::B_LEFT_BORDER)</a>
<a name="ln229">					: BControlLook::B_ALL_BORDERS);</a>
<a name="ln230">		}</a>
<a name="ln231"> </a>
<a name="ln232">		if (fHasBattery) {</a>
<a name="ln233">			if (percent &lt;= kLowBatteryPercentage)</a>
<a name="ln234">				base.set_to(180, 0, 0);</a>
<a name="ln235">			else if (percent &lt;= kNoteBatteryPercentage)</a>
<a name="ln236">				base.set_to(200, 140, 0);</a>
<a name="ln237">			else</a>
<a name="ln238">				base.set_to(20, 180, 0);</a>
<a name="ln239"> </a>
<a name="ln240">			rect.right = rect.left + rect.Width() * percent / 100.0;</a>
<a name="ln241"> </a>
<a name="ln242">			if (be_control_look != NULL) {</a>
<a name="ln243">				be_control_look-&gt;DrawButtonBackground(view, rect, rect, base,</a>
<a name="ln244">					fHasBattery ? 0 : BControlLook::B_DISABLED);</a>
<a name="ln245">			} else</a>
<a name="ln246">				view-&gt;FillRect(rect);</a>
<a name="ln247">		}</a>
<a name="ln248">	}</a>
<a name="ln249"> </a>
<a name="ln250">	if (fOnline) {</a>
<a name="ln251">		// When charging, draw a lightning symbol over the battery.</a>
<a name="ln252">		view-&gt;SetHighColor(255, 255, 0, 180);</a>
<a name="ln253">		view-&gt;SetDrawingMode(B_OP_ALPHA);</a>
<a name="ln254"> </a>
<a name="ln255">		static const BPoint points[] = {</a>
<a name="ln256">			BPoint(3, 14),</a>
<a name="ln257">			BPoint(10, 6),</a>
<a name="ln258">			BPoint(10, 8),</a>
<a name="ln259">			BPoint(17, 3),</a>
<a name="ln260">			BPoint(9, 12),</a>
<a name="ln261">			BPoint(9, 10)</a>
<a name="ln262">		};</a>
<a name="ln263">		view-&gt;FillPolygon(points, 6, lightningRect);</a>
<a name="ln264"> </a>
<a name="ln265">		view-&gt;SetDrawingMode(B_OP_OVER);</a>
<a name="ln266">	}</a>
<a name="ln267"> </a>
<a name="ln268">	view-&gt;SetHighColor(0, 0, 0);</a>
<a name="ln269">}</a>
<a name="ln270"> </a>
<a name="ln271"> </a>
<a name="ln272">void</a>
<a name="ln273">PowerStatusView::Draw(BRect updateRect)</a>
<a name="ln274">{</a>
<a name="ln275">	DrawTo(this, Bounds());</a>
<a name="ln276">}</a>
<a name="ln277"> </a>
<a name="ln278">void</a>
<a name="ln279">PowerStatusView::DrawTo(BView* view, BRect rect)</a>
<a name="ln280">{</a>
<a name="ln281">	bool inside = rect.Width() &gt;= 40.0f &amp;&amp; rect.Height() &gt;= 40.0f;</a>
<a name="ln282"> </a>
<a name="ln283">	font_height fontHeight;</a>
<a name="ln284">	view-&gt;GetFontHeight(&amp;fontHeight);</a>
<a name="ln285">	float baseLine = ceilf(fontHeight.ascent);</a>
<a name="ln286"> </a>
<a name="ln287">	char text[64];</a>
<a name="ln288">	_SetLabel(text, sizeof(text));</a>
<a name="ln289"> </a>
<a name="ln290">	float textHeight = ceilf(fontHeight.descent + fontHeight.ascent);</a>
<a name="ln291">	float textWidth = view-&gt;StringWidth(text);</a>
<a name="ln292">	bool showLabel = fShowLabel &amp;&amp; text[0];</a>
<a name="ln293"> </a>
<a name="ln294">	BRect iconRect;</a>
<a name="ln295"> </a>
<a name="ln296">	if (fShowStatusIcon) {</a>
<a name="ln297">		iconRect = rect;</a>
<a name="ln298">		if (showLabel) {</a>
<a name="ln299">			if (inside == false)</a>
<a name="ln300">				iconRect.right -= textWidth + 2;</a>
<a name="ln301">		}</a>
<a name="ln302"> </a>
<a name="ln303">		if (iconRect.Width() + 1 &gt;= kMinIconWidth</a>
<a name="ln304">			&amp;&amp; iconRect.Height() + 1 &gt;= kMinIconHeight) {</a>
<a name="ln305">			_DrawBattery(view, iconRect);</a>
<a name="ln306">		} else {</a>
<a name="ln307">			// there is not enough space for the icon</a>
<a name="ln308">			iconRect.Set(0, 0, -1, -1);</a>
<a name="ln309">		}</a>
<a name="ln310">	}</a>
<a name="ln311"> </a>
<a name="ln312">	if (showLabel) {</a>
<a name="ln313">		BPoint point(0, baseLine + rect.top);</a>
<a name="ln314"> </a>
<a name="ln315">		if (iconRect.IsValid()) {</a>
<a name="ln316">			if (inside == true) {</a>
<a name="ln317">				point.x = rect.left + (iconRect.Width() - textWidth) / 2 +</a>
<a name="ln318">					iconRect.Width() / 20;</a>
<a name="ln319">				point.y += (iconRect.Height() - textHeight) / 2;</a>
<a name="ln320">			} else {</a>
<a name="ln321">				point.x = rect.left + iconRect.Width() + 2;</a>
<a name="ln322">				point.y += (iconRect.Height() - textHeight) / 2;</a>
<a name="ln323">			}</a>
<a name="ln324">		} else {</a>
<a name="ln325">			point.x = rect.left + (Bounds().Width() - textWidth) / 2;</a>
<a name="ln326">			point.y += (Bounds().Height() - textHeight) / 2;</a>
<a name="ln327">		}</a>
<a name="ln328"> </a>
<a name="ln329">		view-&gt;SetDrawingMode(B_OP_OVER);</a>
<a name="ln330">		if (fInDeskbar == false || inside == true) {</a>
<a name="ln331">			view-&gt;SetHighUIColor(B_CONTROL_BACKGROUND_COLOR);</a>
<a name="ln332">			view-&gt;DrawString(text, BPoint(point.x + 1, point.y + 1));</a>
<a name="ln333">		}</a>
<a name="ln334">		view-&gt;SetHighUIColor(B_CONTROL_TEXT_COLOR);</a>
<a name="ln335"> </a>
<a name="ln336">		view-&gt;DrawString(text, point);</a>
<a name="ln337">	}</a>
<a name="ln338">}</a>
<a name="ln339"> </a>
<a name="ln340"> </a>
<a name="ln341">void</a>
<a name="ln342">PowerStatusView::_SetLabel(char* buffer, size_t bufferLength)</a>
<a name="ln343">{</a>
<a name="ln344">	if (bufferLength &lt; 1)</a>
<a name="ln345">		return;</a>
<a name="ln346"> </a>
<a name="ln347">	buffer[0] = '\0';</a>
<a name="ln348"> </a>
<a name="ln349">	if (!fShowLabel)</a>
<a name="ln350">		return;</a>
<a name="ln351"> </a>
<a name="ln352">	const char* open = &quot;&quot;;</a>
<a name="ln353">	const char* close = &quot;&quot;;</a>
<a name="ln354">	if (fOnline) {</a>
<a name="ln355">		open = &quot;(&quot;;</a>
<a name="ln356">		close = &quot;)&quot;;</a>
<a name="ln357">	}</a>
<a name="ln358"> </a>
<a name="ln359">	if (!fShowTime &amp;&amp; fPercent &gt;= 0) {</a>
<a name="ln360">		snprintf(buffer, bufferLength, &quot;%s%&quot; B_PRId32 &quot;%%%s&quot;, open, fPercent,</a>
<a name="ln361">			close);</a>
<a name="ln362">	} else if (fShowTime &amp;&amp; fTimeLeft &gt;= 0) {</a>
<a name="ln363">		snprintf(buffer, bufferLength, &quot;%s%&quot; B_PRIdTIME &quot;:%02&quot; B_PRIdTIME &quot;%s&quot;,</a>
<a name="ln364">			open, fTimeLeft / 3600, (fTimeLeft / 60) % 60, close);</a>
<a name="ln365">	}</a>
<a name="ln366">}</a>
<a name="ln367"> </a>
<a name="ln368"> </a>
<a name="ln369"> </a>
<a name="ln370">void</a>
<a name="ln371">PowerStatusView::Update(bool force)</a>
<a name="ln372">{</a>
<a name="ln373">	int32 previousPercent = fPercent;</a>
<a name="ln374">	time_t previousTimeLeft = fTimeLeft;</a>
<a name="ln375">	bool wasOnline = fOnline;</a>
<a name="ln376">	bool hadBattery = fHasBattery;</a>
<a name="ln377">	_GetBatteryInfo(fBatteryID, &amp;fBatteryInfo);</a>
<a name="ln378">	fHasBattery = fBatteryInfo.full_capacity &gt; 0;</a>
<a name="ln379"> </a>
<a name="ln380">	if (fBatteryInfo.full_capacity &gt; 0 &amp;&amp; fHasBattery) {</a>
<a name="ln381">		fPercent = (100 * fBatteryInfo.capacity) / fBatteryInfo.full_capacity;</a>
<a name="ln382">		fOnline = (fBatteryInfo.state &amp; BATTERY_DISCHARGING) == 0;</a>
<a name="ln383">		fTimeLeft = fBatteryInfo.time_left;</a>
<a name="ln384">	} else {</a>
<a name="ln385">		fPercent = 0;</a>
<a name="ln386">		fOnline = false;</a>
<a name="ln387">		fTimeLeft = -1;</a>
<a name="ln388">	}</a>
<a name="ln389"> </a>
<a name="ln390">	if (fHasBattery &amp;&amp; (fPercent &lt;= 0 || fPercent &gt; 100)) {</a>
<a name="ln391">		// Just ignore this probe -- it obviously returned invalid values</a>
<a name="ln392">		fPercent = previousPercent;</a>
<a name="ln393">		fTimeLeft = previousTimeLeft;</a>
<a name="ln394">		fOnline = wasOnline;</a>
<a name="ln395">		fHasBattery = hadBattery;</a>
<a name="ln396">		return;</a>
<a name="ln397">	}</a>
<a name="ln398"> </a>
<a name="ln399">	if (fInDeskbar) {</a>
<a name="ln400">		// make sure the tray icon is (just) large enough</a>
<a name="ln401">		float width = fShowStatusIcon ? Bounds().Height() : 0;</a>
<a name="ln402"> </a>
<a name="ln403">		if (fShowLabel) {</a>
<a name="ln404">			char text[64];</a>
<a name="ln405">			_SetLabel(text, sizeof(text));</a>
<a name="ln406"> </a>
<a name="ln407">			if (text[0])</a>
<a name="ln408">				width += ceilf(StringWidth(text)) + 2;</a>
<a name="ln409">		} else {</a>
<a name="ln410">			char text[256];</a>
<a name="ln411">			const char* open = &quot;&quot;;</a>
<a name="ln412">			const char* close = &quot;&quot;;</a>
<a name="ln413">			if (fOnline) {</a>
<a name="ln414">				open = &quot;(&quot;;</a>
<a name="ln415">				close = &quot;)&quot;;</a>
<a name="ln416">			}</a>
<a name="ln417">			if (fHasBattery) {</a>
<a name="ln418">				size_t length = snprintf(text, sizeof(text), &quot;%s%&quot; B_PRId32</a>
<a name="ln419">					&quot;%%%s&quot;, open, fPercent, close);</a>
<a name="ln420">				if (fTimeLeft &gt;= 0) {</a>
<a name="ln421">					length += snprintf(text + length, sizeof(text) - length,</a>
<a name="ln422">						&quot;\n%&quot; B_PRIdTIME &quot;:%02&quot; B_PRIdTIME, fTimeLeft / 3600,</a>
<a name="ln423">						(fTimeLeft / 60) % 60);</a>
<a name="ln424">				}</a>
<a name="ln425"> </a>
<a name="ln426">				const char* state = NULL;</a>
<a name="ln427">				if ((fBatteryInfo.state &amp; BATTERY_CHARGING) != 0)</a>
<a name="ln428">					state = B_TRANSLATE(&quot;charging&quot;);</a>
<a name="ln429">				else if ((fBatteryInfo.state &amp; BATTERY_DISCHARGING) != 0)</a>
<a name="ln430">					state = B_TRANSLATE(&quot;discharging&quot;);</a>
<a name="ln431"> </a>
<a name="ln432">				if (state != NULL) {</a>
<a name="ln433">					snprintf(text + length, sizeof(text) - length, &quot;\n%s&quot;,</a>
<a name="ln434">						state);</a>
<a name="ln435">				}</a>
<a name="ln436">			} else</a>
<a name="ln437">				strcpy(text, B_TRANSLATE(&quot;no battery&quot;));</a>
<a name="ln438">			SetToolTip(text);</a>
<a name="ln439">		}</a>
<a name="ln440">		if (width &lt; 8) {</a>
<a name="ln441">			// make sure we're not going away completely</a>
<a name="ln442">			width = 8;</a>
<a name="ln443">		}</a>
<a name="ln444"> </a>
<a name="ln445">		if (width != Bounds().Width()) {</a>
<a name="ln446">			ResizeTo(width, Bounds().Height());</a>
<a name="ln447"> </a>
<a name="ln448">			// inform Deskbar that it needs to realign its replicants</a>
<a name="ln449">			BWindow* window = Window();</a>
<a name="ln450">			if (window != NULL) {</a>
<a name="ln451">				BView* view = window-&gt;FindView(&quot;Status&quot;);</a>
<a name="ln452">				if (view != NULL) {</a>
<a name="ln453">					BMessenger target((BHandler*)view);</a>
<a name="ln454">					BMessage realignReplicants('Algn');</a>
<a name="ln455">					target.SendMessage(&amp;realignReplicants);</a>
<a name="ln456">				}</a>
<a name="ln457">			}</a>
<a name="ln458">		}</a>
<a name="ln459">	}</a>
<a name="ln460"> </a>
<a name="ln461">	if (force || wasOnline != fOnline</a>
<a name="ln462">		|| (fShowTime &amp;&amp; fTimeLeft != previousTimeLeft)</a>
<a name="ln463">		|| (!fShowTime &amp;&amp; fPercent != previousPercent)) {</a>
<a name="ln464">		Invalidate();</a>
<a name="ln465">	}</a>
<a name="ln466"> </a>
<a name="ln467">	if (!fOnline &amp;&amp; fHasBattery &amp;&amp; previousPercent &gt; kLowBatteryPercentage</a>
<a name="ln468">			&amp;&amp; fPercent &lt;= kLowBatteryPercentage) {</a>
<a name="ln469">		_NotifyLowBattery();</a>
<a name="ln470">	}</a>
<a name="ln471">}</a>
<a name="ln472"> </a>
<a name="ln473"> </a>
<a name="ln474">void</a>
<a name="ln475">PowerStatusView::FromMessage(const BMessage* archive)</a>
<a name="ln476">{</a>
<a name="ln477">	bool value;</a>
<a name="ln478">	if (archive-&gt;FindBool(&quot;show label&quot;, &amp;value) == B_OK)</a>
<a name="ln479">		fShowLabel = value;</a>
<a name="ln480">	if (archive-&gt;FindBool(&quot;show icon&quot;, &amp;value) == B_OK)</a>
<a name="ln481">		fShowStatusIcon = value;</a>
<a name="ln482">	if (archive-&gt;FindBool(&quot;show time&quot;, &amp;value) == B_OK)</a>
<a name="ln483">		fShowTime = value;</a>
<a name="ln484"> </a>
<a name="ln485">	//Incase we have a bad saving and none are showed..</a>
<a name="ln486">	if (!fShowLabel &amp;&amp; !fShowStatusIcon)</a>
<a name="ln487">		fShowLabel = true;</a>
<a name="ln488"> </a>
<a name="ln489">	int32 intValue;</a>
<a name="ln490">	if (archive-&gt;FindInt32(&quot;battery id&quot;, &amp;intValue) == B_OK)</a>
<a name="ln491">		fBatteryID = intValue;</a>
<a name="ln492">}</a>
<a name="ln493"> </a>
<a name="ln494"> </a>
<a name="ln495">status_t</a>
<a name="ln496">PowerStatusView::ToMessage(BMessage* archive) const</a>
<a name="ln497">{</a>
<a name="ln498">	status_t status = archive-&gt;AddBool(&quot;show label&quot;, fShowLabel);</a>
<a name="ln499">	if (status == B_OK)</a>
<a name="ln500">		status = archive-&gt;AddBool(&quot;show icon&quot;, fShowStatusIcon);</a>
<a name="ln501">	if (status == B_OK)</a>
<a name="ln502">		status = archive-&gt;AddBool(&quot;show time&quot;, fShowTime);</a>
<a name="ln503">	if (status == B_OK)</a>
<a name="ln504">		status = archive-&gt;AddInt32(&quot;battery id&quot;, fBatteryID);</a>
<a name="ln505"> </a>
<a name="ln506">	return status;</a>
<a name="ln507">}</a>
<a name="ln508"> </a>
<a name="ln509"> </a>
<a name="ln510">void</a>
<a name="ln511">PowerStatusView::_GetBatteryInfo(int batteryID, battery_info* batteryInfo)</a>
<a name="ln512">{</a>
<a name="ln513">	if (batteryID &gt;= 0) {</a>
<a name="ln514">		fDriverInterface-&gt;GetBatteryInfo(batteryID, batteryInfo);</a>
<a name="ln515">	} else {</a>
<a name="ln516">		bool first = true;</a>
<a name="ln517">		memset(batteryInfo, 0, sizeof(battery_info));</a>
<a name="ln518"> </a>
<a name="ln519">		for (int i = 0; i &lt; fDriverInterface-&gt;GetBatteryCount(); i++) {</a>
<a name="ln520">			battery_info info;</a>
<a name="ln521">			fDriverInterface-&gt;GetBatteryInfo(i, &amp;info);</a>
<a name="ln522"> </a>
<a name="ln523">			if (info.full_capacity &lt;= 0)</a>
<a name="ln524">				continue;</a>
<a name="ln525"> </a>
<a name="ln526">			if (first) {</a>
<a name="ln527">				*batteryInfo = info;</a>
<a name="ln528">				first = false;</a>
<a name="ln529">			} else {</a>
<a name="ln530">				batteryInfo-&gt;state |= info.state;</a>
<a name="ln531">				batteryInfo-&gt;capacity += info.capacity;</a>
<a name="ln532">				batteryInfo-&gt;full_capacity += info.full_capacity;</a>
<a name="ln533">				batteryInfo-&gt;time_left += info.time_left;</a>
<a name="ln534">			}</a>
<a name="ln535">		}</a>
<a name="ln536">	}</a>
<a name="ln537">}</a>
<a name="ln538"> </a>
<a name="ln539"> </a>
<a name="ln540">void</a>
<a name="ln541">PowerStatusView::_NotifyLowBattery()</a>
<a name="ln542">{</a>
<a name="ln543">	BBitmap* bitmap = NULL;</a>
<a name="ln544">	BResources resources;</a>
<a name="ln545">	resources.SetToImage((void*)&amp;instantiate_deskbar_item);</a>
<a name="ln546"> </a>
<a name="ln547">	if (resources.InitCheck() == B_OK) {</a>
<a name="ln548">		size_t resourceSize = 0;</a>
<a name="ln549">		const void* resourceData = resources.LoadResource(</a>
<a name="ln550">			B_VECTOR_ICON_TYPE, fHasBattery</a>
<a name="ln551">				? &quot;battery_low&quot; : &quot;battery_critical&quot;, &amp;resourceSize);</a>
<a name="ln552">		if (resourceData != NULL) {</a>
<a name="ln553">			BMemoryIO memoryIO(resourceData, resourceSize);</a>
<a name="ln554">			bitmap = BTranslationUtils::GetBitmap(&amp;memoryIO);</a>
<a name="ln555">		}</a>
<a name="ln556">	}</a>
<a name="ln557"> </a>
<a name="ln558">	BNotification notification(</a>
<a name="ln559">		fHasBattery ? B_INFORMATION_NOTIFICATION : B_ERROR_NOTIFICATION);</a>
<a name="ln560"> </a>
<a name="ln561">	if (fHasBattery) {</a>
<a name="ln562">		notification.SetTitle(B_TRANSLATE(&quot;Battery low&quot;));</a>
<a name="ln563">		notification.SetContent(B_TRANSLATE(</a>
<a name="ln564">			&quot;The battery level is getting low, please plug in the device.&quot;));</a>
<a name="ln565">	} else {</a>
<a name="ln566">		notification.SetTitle(B_TRANSLATE(&quot;Battery critical&quot;));</a>
<a name="ln567">		notification.SetContent(B_TRANSLATE(</a>
<a name="ln568">			&quot;The battery level is critical, please plug in the device &quot;</a>
<a name="ln569">			&quot;immediately.&quot;));</a>
<a name="ln570">	}</a>
<a name="ln571"> </a>
<a name="ln572">	notification.SetIcon(bitmap);</a>
<a name="ln573">	notification.Send();</a>
<a name="ln574">	delete bitmap;</a>
<a name="ln575">}</a>
<a name="ln576"> </a>
<a name="ln577"> </a>
<a name="ln578">// #pragma mark - Replicant view</a>
<a name="ln579"> </a>
<a name="ln580"> </a>
<a name="ln581">PowerStatusReplicant::PowerStatusReplicant(BRect frame, int32 resizingMode,</a>
<a name="ln582">	bool inDeskbar)</a>
<a name="ln583">	:</a>
<a name="ln584">	PowerStatusView(NULL, frame, resizingMode, -1, inDeskbar),</a>
<a name="ln585">	fReplicated(false)</a>
<a name="ln586">{</a>
<a name="ln587">	_Init();</a>
<a name="ln588">	_LoadSettings();</a>
<a name="ln589"> </a>
<a name="ln590">	if (!inDeskbar) {</a>
<a name="ln591">		// we were obviously added to a standard window - let's add a dragger</a>
<a name="ln592">		frame.OffsetTo(B_ORIGIN);</a>
<a name="ln593">		frame.top = frame.bottom - 7;</a>
<a name="ln594">		frame.left = frame.right - 7;</a>
<a name="ln595">		BDragger* dragger = new BDragger(frame, this,</a>
<a name="ln596">			B_FOLLOW_RIGHT | B_FOLLOW_BOTTOM);</a>
<a name="ln597">		AddChild(dragger);</a>
<a name="ln598">	} else</a>
<a name="ln599">		Update();</a>
<a name="ln600">}</a>
<a name="ln601"> </a>
<a name="ln602"> </a>
<a name="ln603">PowerStatusReplicant::PowerStatusReplicant(BMessage* archive)</a>
<a name="ln604">	:</a>
<a name="ln605">	PowerStatusView(archive),</a>
<a name="ln606">	fReplicated(true)</a>
<a name="ln607">{</a>
<a name="ln608">	_Init();</a>
<a name="ln609">	_LoadSettings();</a>
<a name="ln610">}</a>
<a name="ln611"> </a>
<a name="ln612"> </a>
<a name="ln613">PowerStatusReplicant::~PowerStatusReplicant()</a>
<a name="ln614">{</a>
<a name="ln615">	if (fMessengerExist)</a>
<a name="ln616">		delete fExtWindowMessenger;</a>
<a name="ln617"> </a>
<a name="ln618">	if (fExtendedWindow != NULL &amp;&amp; fExtendedWindow-&gt;Lock()) {</a>
<a name="ln619">			fExtendedWindow-&gt;Quit();</a>
<a name="ln620">			fExtendedWindow = NULL;</a>
<a name="ln621">	}</a>
<a name="ln622"> </a>
<a name="ln623">	fDriverInterface-&gt;StopWatching(this);</a>
<a name="ln624">	fDriverInterface-&gt;Disconnect();</a>
<a name="ln625">	fDriverInterface-&gt;ReleaseReference();</a>
<a name="ln626"> </a>
<a name="ln627">	_SaveSettings();</a>
<a name="ln628">}</a>
<a name="ln629"> </a>
<a name="ln630"> </a>
<a name="ln631">PowerStatusReplicant*</a>
<a name="ln632">PowerStatusReplicant::Instantiate(BMessage* archive)</a>
<a name="ln633">{</a>
<a name="ln634">	if (!validate_instantiation(archive, &quot;PowerStatusReplicant&quot;))</a>
<a name="ln635">		return NULL;</a>
<a name="ln636"> </a>
<a name="ln637">	return new PowerStatusReplicant(archive);</a>
<a name="ln638">}</a>
<a name="ln639"> </a>
<a name="ln640"> </a>
<a name="ln641">status_t</a>
<a name="ln642">PowerStatusReplicant::Archive(BMessage* archive, bool deep) const</a>
<a name="ln643">{</a>
<a name="ln644">	status_t status = PowerStatusView::Archive(archive, deep);</a>
<a name="ln645">	if (status == B_OK)</a>
<a name="ln646">		status = archive-&gt;AddString(&quot;add_on&quot;, kSignature);</a>
<a name="ln647">	if (status == B_OK)</a>
<a name="ln648">		status = archive-&gt;AddString(&quot;class&quot;, &quot;PowerStatusReplicant&quot;);</a>
<a name="ln649"> </a>
<a name="ln650">	return status;</a>
<a name="ln651">}</a>
<a name="ln652"> </a>
<a name="ln653"> </a>
<a name="ln654">void</a>
<a name="ln655">PowerStatusReplicant::MessageReceived(BMessage *message)</a>
<a name="ln656">{</a>
<a name="ln657">	switch (message-&gt;what) {</a>
<a name="ln658">		case kMsgToggleLabel:</a>
<a name="ln659">			if (fShowStatusIcon)</a>
<a name="ln660">				fShowLabel = !fShowLabel;</a>
<a name="ln661">			else</a>
<a name="ln662">				fShowLabel = true;</a>
<a name="ln663"> </a>
<a name="ln664">			Update(true);</a>
<a name="ln665">			break;</a>
<a name="ln666"> </a>
<a name="ln667">		case kMsgToggleTime:</a>
<a name="ln668">			fShowTime = !fShowTime;</a>
<a name="ln669">			Update(true);</a>
<a name="ln670">			break;</a>
<a name="ln671"> </a>
<a name="ln672">		case kMsgToggleStatusIcon:</a>
<a name="ln673">			if (fShowLabel)</a>
<a name="ln674">				fShowStatusIcon = !fShowStatusIcon;</a>
<a name="ln675">			else</a>
<a name="ln676">				fShowStatusIcon = true;</a>
<a name="ln677"> </a>
<a name="ln678">			Update(true);</a>
<a name="ln679">			break;</a>
<a name="ln680"> </a>
<a name="ln681">		case kMsgToggleExtInfo:</a>
<a name="ln682">			_OpenExtendedWindow();</a>
<a name="ln683">			break;</a>
<a name="ln684"> </a>
<a name="ln685">		case B_ABOUT_REQUESTED:</a>
<a name="ln686">			_AboutRequested();</a>
<a name="ln687">			break;</a>
<a name="ln688"> </a>
<a name="ln689">		case B_QUIT_REQUESTED:</a>
<a name="ln690">			_Quit();</a>
<a name="ln691">			break;</a>
<a name="ln692"> </a>
<a name="ln693">		default:</a>
<a name="ln694">			PowerStatusView::MessageReceived(message);</a>
<a name="ln695">	}</a>
<a name="ln696">}</a>
<a name="ln697"> </a>
<a name="ln698"> </a>
<a name="ln699">void</a>
<a name="ln700">PowerStatusReplicant::MouseDown(BPoint point)</a>
<a name="ln701">{</a>
<a name="ln702">	BMessage* msg = Window()-&gt;CurrentMessage();</a>
<a name="ln703">	int32 buttons = msg-&gt;GetInt32(&quot;buttons&quot;, 0);</a>
<a name="ln704">	if ((buttons &amp; B_TERTIARY_MOUSE_BUTTON) != 0) {</a>
<a name="ln705">		BMessenger messenger(this);</a>
<a name="ln706">		messenger.SendMessage(kMsgToggleExtInfo);</a>
<a name="ln707">	} else {</a>
<a name="ln708">		BPopUpMenu* menu = new BPopUpMenu(B_EMPTY_STRING, false, false);</a>
<a name="ln709">		menu-&gt;SetFont(be_plain_font);</a>
<a name="ln710"> </a>
<a name="ln711">		BMenuItem* item;</a>
<a name="ln712">		menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Show text label&quot;),</a>
<a name="ln713">			new BMessage(kMsgToggleLabel)));</a>
<a name="ln714">		if (fShowLabel)</a>
<a name="ln715">			item-&gt;SetMarked(true);</a>
<a name="ln716">		menu-&gt;AddItem(item = new BMenuItem(B_TRANSLATE(&quot;Show status icon&quot;),</a>
<a name="ln717">			new BMessage(kMsgToggleStatusIcon)));</a>
<a name="ln718">		if (fShowStatusIcon)</a>
<a name="ln719">			item-&gt;SetMarked(true);</a>
<a name="ln720">		menu-&gt;AddItem(new BMenuItem(!fShowTime ? B_TRANSLATE(&quot;Show time&quot;) :</a>
<a name="ln721">			B_TRANSLATE(&quot;Show percent&quot;), new BMessage(kMsgToggleTime)));</a>
<a name="ln722"> </a>
<a name="ln723">		menu-&gt;AddSeparatorItem();</a>
<a name="ln724">		menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Battery info&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln725">			new BMessage(kMsgToggleExtInfo)));</a>
<a name="ln726"> </a>
<a name="ln727">		menu-&gt;AddSeparatorItem();</a>
<a name="ln728">		menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;About&quot; B_UTF8_ELLIPSIS),</a>
<a name="ln729">			new BMessage(B_ABOUT_REQUESTED)));</a>
<a name="ln730">		menu-&gt;AddItem(new BMenuItem(B_TRANSLATE(&quot;Quit&quot;),</a>
<a name="ln731">			new BMessage(B_QUIT_REQUESTED)));</a>
<a name="ln732">		menu-&gt;SetTargetForItems(this);</a>
<a name="ln733"> </a>
<a name="ln734">		ConvertToScreen(&amp;point);</a>
<a name="ln735">		menu-&gt;Go(point, true, false, true);</a>
<a name="ln736">	}</a>
<a name="ln737">}</a>
<a name="ln738"> </a>
<a name="ln739"> </a>
<a name="ln740">void</a>
<a name="ln741">PowerStatusReplicant::_AboutRequested()</a>
<a name="ln742">{</a>
<a name="ln743">	BAboutWindow* window = new BAboutWindow(</a>
<a name="ln744">		B_TRANSLATE_SYSTEM_NAME(&quot;PowerStatus&quot;), kSignature);</a>
<a name="ln745"> </a>
<a name="ln746">	const char* authors[] = {</a>
<a name="ln747">		&quot;Axel DÃ¶rfler&quot;,</a>
<a name="ln748">		&quot;Alexander von Gluck&quot;,</a>
<a name="ln749">		&quot;Clemens Zeidler&quot;,</a>
<a name="ln750">		NULL</a>
<a name="ln751">	};</a>
<a name="ln752"> </a>
<a name="ln753">	window-&gt;AddCopyright(2006, &quot;Haiku, Inc.&quot;);</a>
<a name="ln754">	window-&gt;AddAuthors(authors);</a>
<a name="ln755"> </a>
<a name="ln756">	window-&gt;Show();</a>
<a name="ln757">}</a>
<a name="ln758"> </a>
<a name="ln759"> </a>
<a name="ln760">void</a>
<a name="ln761">PowerStatusReplicant::_Init()</a>
<a name="ln762">{</a>
<a name="ln763">	fDriverInterface = new ACPIDriverInterface;</a>
<a name="ln764">	if (fDriverInterface-&gt;Connect() != B_OK) {</a>
<a name="ln765">		delete fDriverInterface;</a>
<a name="ln766">		fDriverInterface = new APMDriverInterface;</a>
<a name="ln767">		if (fDriverInterface-&gt;Connect() != B_OK) {</a>
<a name="ln768">			fprintf(stderr, &quot;No power interface found.\n&quot;);</a>
<a name="ln769">			_Quit();</a>
<a name="ln770">		}</a>
<a name="ln771">	}</a>
<a name="ln772"> </a>
<a name="ln773">	fExtendedWindow = NULL;</a>
<a name="ln774">	fMessengerExist = false;</a>
<a name="ln775">	fExtWindowMessenger = NULL;</a>
<a name="ln776"> </a>
<a name="ln777">	fDriverInterface-&gt;StartWatching(this);</a>
<a name="ln778">}</a>
<a name="ln779"> </a>
<a name="ln780"> </a>
<a name="ln781">void</a>
<a name="ln782">PowerStatusReplicant::_Quit()</a>
<a name="ln783">{</a>
<a name="ln784">	if (fInDeskbar) {</a>
<a name="ln785">		BDeskbar deskbar;</a>
<a name="ln786">		deskbar.RemoveItem(kDeskbarItemName);</a>
<a name="ln787">	} else if (fReplicated) {</a>
<a name="ln788">		BDragger *dragger = dynamic_cast&lt;BDragger*&gt;(ChildAt(0));</a>
<a name="ln789">		if (dragger != NULL) {</a>
<a name="ln790">			BMessenger messenger(dragger);</a>
<a name="ln791">			messenger.SendMessage(new BMessage(B_TRASH_TARGET));</a>
<a name="ln792">		}</a>
<a name="ln793">	} else</a>
<a name="ln794">		be_app-&gt;PostMessage(B_QUIT_REQUESTED);</a>
<a name="ln795">}</a>
<a name="ln796"> </a>
<a name="ln797"> </a>
<a name="ln798">status_t</a>
<a name="ln799">PowerStatusReplicant::_GetSettings(BFile&amp; file, int mode)</a>
<a name="ln800">{</a>
<a name="ln801">	BPath path;</a>
<a name="ln802">	status_t status = find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path,</a>
<a name="ln803">		(mode &amp; O_ACCMODE) != O_RDONLY);</a>
<a name="ln804">	if (status != B_OK)</a>
<a name="ln805">		return status;</a>
<a name="ln806"> </a>
<a name="ln807">	path.Append(&quot;PowerStatus settings&quot;);</a>
<a name="ln808"> </a>
<a name="ln809">	return file.SetTo(path.Path(), mode);</a>
<a name="ln810">}</a>
<a name="ln811"> </a>
<a name="ln812"> </a>
<a name="ln813">void</a>
<a name="ln814">PowerStatusReplicant::_LoadSettings()</a>
<a name="ln815">{</a>
<a name="ln816">	fShowLabel = false;</a>
<a name="ln817"> </a>
<a name="ln818">	BFile file;</a>
<a name="ln819">	if (_GetSettings(file, B_READ_ONLY) != B_OK)</a>
<a name="ln820">		return;</a>
<a name="ln821"> </a>
<a name="ln822">	BMessage settings;</a>
<a name="ln823">	if (settings.Unflatten(&amp;file) &lt; B_OK)</a>
<a name="ln824">		return;</a>
<a name="ln825"> </a>
<a name="ln826">	FromMessage(&amp;settings);</a>
<a name="ln827">}</a>
<a name="ln828"> </a>
<a name="ln829"> </a>
<a name="ln830">void</a>
<a name="ln831">PowerStatusReplicant::_SaveSettings()</a>
<a name="ln832">{</a>
<a name="ln833">	BFile file;</a>
<a name="ln834">	if (_GetSettings(file, B_WRITE_ONLY | B_CREATE_FILE | B_ERASE_FILE) != B_OK)</a>
<a name="ln835">		return;</a>
<a name="ln836"> </a>
<a name="ln837">	BMessage settings('pwst');</a>
<a name="ln838">	ToMessage(&amp;settings);</a>
<a name="ln839"> </a>
<a name="ln840">	ssize_t size = 0;</a>
<a name="ln841">	settings.Flatten(&amp;file, &amp;size);</a>
<a name="ln842">}</a>
<a name="ln843"> </a>
<a name="ln844"> </a>
<a name="ln845">void</a>
<a name="ln846">PowerStatusReplicant::_OpenExtendedWindow()</a>
<a name="ln847">{</a>
<a name="ln848">	if (!fExtendedWindow) {</a>
<a name="ln849">		fExtendedWindow = new ExtendedInfoWindow(fDriverInterface);</a>
<a name="ln850">		fExtWindowMessenger = new BMessenger(NULL, fExtendedWindow);</a>
<a name="ln851">		fExtendedWindow-&gt;Show();</a>
<a name="ln852">		return;</a>
<a name="ln853">	}</a>
<a name="ln854"> </a>
<a name="ln855">	BMessage msg(B_SET_PROPERTY);</a>
<a name="ln856">	msg.AddSpecifier(&quot;Hidden&quot;, int32(0));</a>
<a name="ln857">	if (fExtWindowMessenger-&gt;SendMessage(&amp;msg) == B_BAD_PORT_ID) {</a>
<a name="ln858">		fExtendedWindow = new ExtendedInfoWindow(fDriverInterface);</a>
<a name="ln859">		if (fMessengerExist)</a>
<a name="ln860">			delete fExtWindowMessenger;</a>
<a name="ln861">		fExtWindowMessenger = new BMessenger(NULL, fExtendedWindow);</a>
<a name="ln862">		fMessengerExist = true;</a>
<a name="ln863">		fExtendedWindow-&gt;Show();</a>
<a name="ln864">	} else</a>
<a name="ln865">		fExtendedWindow-&gt;Activate();</a>
<a name="ln866"> </a>
<a name="ln867">}</a>
<a name="ln868"> </a>
<a name="ln869"> </a>
<a name="ln870">//	#pragma mark -</a>
<a name="ln871"> </a>
<a name="ln872"> </a>
<a name="ln873">extern &quot;C&quot; _EXPORT BView*</a>
<a name="ln874">instantiate_deskbar_item(float maxWidth, float maxHeight)</a>
<a name="ln875">{</a>
<a name="ln876">	return new PowerStatusReplicant(BRect(0, 0, maxHeight - 1, maxHeight - 1),</a>
<a name="ln877">		B_FOLLOW_NONE, true);</a>
<a name="ln878">}</a>

</code></pre>
<div class="balloon" rel="736"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'menu' pointer was exited without releasing the memory. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
